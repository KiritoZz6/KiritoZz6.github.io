<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SakuraServer项目 | 🌸樱花酒吧🍻</title><meta name="keywords" content="面试,WebServer,项目"><meta name="author" content="Sakura."><meta name="copyright" content="Sakura."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Sakura WebServer有个网站知识点挺多的：https:&#x2F;&#x2F;balloonwj.github.io&#x2F;cpp-guide-web&#x2F; 别人的项目找到一个别人自己开发的框架，用的人还少，但是很复杂秋招看肯定来不及了↓ https:&#x2F;&#x2F;github.com&#x2F;tomatowithpotato&#x2F;HAHA-WebServer 所以又有个稍微简单点的，和我的差不多，而且还有upload功能 https:">
<meta property="og:type" content="article">
<meta property="og:title" content="SakuraServer项目">
<meta property="og:url" content="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/SakuraServer%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="🌸樱花酒吧🍻">
<meta property="og:description" content="Sakura WebServer有个网站知识点挺多的：https:&#x2F;&#x2F;balloonwj.github.io&#x2F;cpp-guide-web&#x2F; 别人的项目找到一个别人自己开发的框架，用的人还少，但是很复杂秋招看肯定来不及了↓ https:&#x2F;&#x2F;github.com&#x2F;tomatowithpotato&#x2F;HAHA-WebServer 所以又有个稍微简单点的，和我的差不多，而且还有upload功能 https:">
<meta property="og:locale">
<meta property="og:image" content="https://p6-tt.byteimg.com/origin/pgc-image/85a708e60c5d4418b51f9c64f6bf058a.jpg">
<meta property="article:published_time" content="2022-09-07T14:09:31.000Z">
<meta property="article:modified_time" content="2022-09-07T14:15:36.537Z">
<meta property="article:author" content="Sakura.">
<meta property="article:tag" content="面试">
<meta property="article:tag" content="WebServer">
<meta property="article:tag" content="项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p6-tt.byteimg.com/origin/pgc-image/85a708e60c5d4418b51f9c64f6bf058a.jpg"><link rel="shortcut icon" href="/img/0.png"><link rel="canonical" href="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/SakuraServer%E9%A1%B9%E7%9B%AE/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SakuraServer项目',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-07 22:15:36'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="https://sakura-pub.ltd/css/Sakura.css"><link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="🌸樱花酒吧🍻" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://i.loli.net/2021/11/01/ilJyOSYrF7m4M3X.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">47</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">8</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 目录</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类目录</span></a></li><li><a class="site-page child" href="/LeetCode/LeetCode%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%9C%9F/"><i class="fa-fw fas-archive"></i><span> LeetCode刷题笔记</span></a></li><li><a class="site-page child" href="/categories/%E8%AE%B0%E4%BA%8B/"><span> 记事</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/%E8%AE%B0%E4%BA%8B/%E5%85%B3%E4%BA%8E%E6%88%91/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://p6-tt.byteimg.com/origin/pgc-image/85a708e60c5d4418b51f9c64f6bf058a.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">🌸樱花酒吧🍻</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 目录</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类目录</span></a></li><li><a class="site-page child" href="/LeetCode/LeetCode%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%9C%9F/"><i class="fa-fw fas-archive"></i><span> LeetCode刷题笔记</span></a></li><li><a class="site-page child" href="/categories/%E8%AE%B0%E4%BA%8B/"><span> 记事</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/%E8%AE%B0%E4%BA%8B/%E5%85%B3%E4%BA%8E%E6%88%91/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SakuraServer项目</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-09-07T14:09:31.000Z" title="Created 2022-09-07 22:09:31">2022-09-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-09-07T14:15:36.537Z" title="Updated 2022-09-07 22:15:36">2022-09-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%A2%E8%AF%95/%E9%A1%B9%E7%9B%AE/">项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="SakuraServer项目"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/%E9%9D%A2%E8%AF%95/SakuraServer%E9%A1%B9%E7%9B%AE/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/%E9%9D%A2%E8%AF%95/SakuraServer%E9%A1%B9%E7%9B%AE/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Sakura-WebServer"><a href="#Sakura-WebServer" class="headerlink" title="Sakura WebServer"></a>Sakura WebServer</h1><p>有个网站知识点挺多的：<a target="_blank" rel="noopener" href="https://balloonwj.github.io/cpp-guide-web/">https://balloonwj.github.io/cpp-guide-web/</a></p>
<h2 id="别人的项目"><a href="#别人的项目" class="headerlink" title="别人的项目"></a>别人的项目</h2><p>找到一个别人自己开发的框架，用的人还少，但是很复杂秋招看肯定来不及了↓</p>
<p><a target="_blank" rel="noopener" href="https://github.com/tomatowithpotato/HAHA-WebServer">https://github.com/tomatowithpotato/HAHA-WebServer</a></p>
<p>所以又有个稍微简单点的，和我的差不多，而且还有upload功能</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Sakura1221/SimpleWebServer/tree/upload">https://github.com/Sakura1221/SimpleWebServer/tree/upload</a></p>
<h2 id="网上找到别人提前批给问到的问题"><a href="#网上找到别人提前批给问到的问题" class="headerlink" title="网上找到别人提前批给问到的问题"></a>网上找到别人提前批给问到的问题</h2><p><img src="E:\Snipaste截图保存\Snipaste_2022-08-10_14-46-37.png" alt="Snipaste_2022-08-10_14-46-37"></p>
<h2 id="牛客有人京东面经也问到了WebServer"><a href="#牛客有人京东面经也问到了WebServer" class="headerlink" title="牛客有人京东面经也问到了WebServer"></a>牛客有人京东面经也问到了WebServer</h2><p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/discuss/723200?type=all&amp;order=time&amp;pos=&amp;page=1&amp;ncTraceId=&amp;channel=-1&amp;source_id=search_all_nctrack">https://www.nowcoder.com/discuss/723200?type=all&amp;order=time&amp;pos=&amp;page=1&amp;ncTraceId=&amp;channel=-1&amp;source_id=search_all_nctrack</a></p>
<p>这里就来分析下GitHub上找到的更好的WebServer，它支持日志异步队列，线程池，连接与监听socket都可以选择LT和ET，数据库连接池等组件，功能上支持web文件上传下载、账号登录注册等。</p>
<p>另外也支持keep-alive检测以及定时器断开连接处理，效果见下面的图</p>
<p><img src="D:\编程\面试项目相关\备忘录图片\Snipaste_2022-08-13_10-19-37.png" alt="Snipaste_2022-08-13_10-19-37"></p>
<p><img src="D:\编程\面试项目相关\备忘录图片\Snipaste_2022-08-13_10-31-15.png" alt="Snipaste_2022-08-13_10-31-15"></p>
<h2 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h2><p>定时器节点是自定义的结构体</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//定时器结点</span>
<span class="token keyword">struct</span> <span class="token class-name">TimerNode</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span> <span class="token comment">//连接套接字描述符</span>
    TimeStamp expires<span class="token punctuation">;</span> <span class="token comment">//到期时间</span>
    TimeoutCallBack cb<span class="token punctuation">;</span> <span class="token comment">//回调函数</span>
    <span class="token comment">//重载&lt;，到期时间近的排在前面</span>
    <span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">const</span> TimerNode<span class="token operator">&amp;</span> t<span class="token punctuation">)</span> 
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> expires <span class="token operator">&lt;</span> t<span class="token punctuation">.</span>expires<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>定时器容器是用vector模拟出来的小根堆，顶上元素是最小值，它内部提供的操作定时器节点位置函数有</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/**
如果用0号作为根结点，那么结点x的左结点是 2x+1，右结点是2x+2
那么结点x的父结点就是 (x-1)/2

swap操作：交换两个结点，同时更新哈希表内每个定时器的下标
down操作：比左或右结点大，与左右结点的最小值交换
up操作：比父结点小，与父结点交换

我们的需求有以下几个：
增加定时器：查哈希表，如果是新定时器，插在最后，再up，如果不是新定时器，就需要调整定时器
调整定时器：更新定时后，再执行down和up（实际上只会执行一个）
删除定时器：与最后一个元素交换，删除末尾元素，然后再down和up（删除任意位置结点，同样也只会执行一个）
*/</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>定时器容器中会监听容器中是否有定时器到时，到时则触发epoll_wait并且不阻塞立即返回（因为知道有事件要处理），否则如果没有到时则等待时长是下一次超时时间，如果队列为空的话则一直阻塞epoll_wait()</p>
<p>初始化服务器时默认传的是60秒进行一次定时器事件，而该定时器事件是为了防止一个连接一直连太久但是又不发生事件处理这种情况，有了定时器后就可以限制一个连接最多占用服务器60秒而不请求事件，过了60秒就会将其断开连接（关闭fd、断开文件映射mmap）</p>
<h3 id="问题：为什么要用数组模拟堆呢？"><a href="#问题：为什么要用数组模拟堆呢？" class="headerlink" title="问题：为什么要用数组模拟堆呢？"></a>问题：为什么要用数组模拟堆呢？</h3><h2 id="自定义缓冲区Buffer"><a href="#自定义缓冲区Buffer" class="headerlink" title="自定义缓冲区Buffer"></a>自定义缓冲区Buffer</h2><p>是一个底层为vector&lt;char*&gt;的类，在读数据时候，用到了IO向量iovec iov[2];，其中iov[0]是Buffer类里面的vector，默认大小是1024字节的，一旦读一次数据超过了1024则会用到iov[1]的char newbuffer[65536];它是在处理读操作函数中定义的临时变量，在读完后则会将这个newbuffer内容添加到vector当中</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">ssize_t <span class="token class-name">Buffer</span><span class="token operator">::</span><span class="token function">readfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> saveErrno<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> newbuffer<span class="token punctuation">[</span><span class="token number">65536</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">iovec</span> iov<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> size_t writable <span class="token operator">=</span> <span class="token function">writableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    iov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> <span class="token function">beginPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> writePos<span class="token punctuation">;</span>
    iov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> writable<span class="token punctuation">;</span>
    iov<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> newbuffer<span class="token punctuation">;</span>
    iov<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>newbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> ssize_t len <span class="token operator">=</span> <span class="token function">readv</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> iov<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token operator">*</span>saveErrno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">></span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> writable<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        writePos <span class="token operator">+=</span> len<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//buffer is full, append newbuffer</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
        writePos <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">append</span><span class="token punctuation">(</span>newbuffer<span class="token punctuation">,</span> len <span class="token operator">-</span> writable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> len<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当然，在读时候是个循环，还会判断是否为LT模式，如果是则会一直进入读函数操作，直到读不出数据<code>len&lt;=0</code>为止</p>
<h1 id="当判断fd读事件之后的流程"><a href="#当判断fd读事件之后的流程" class="headerlink" title="当判断fd读事件之后的流程"></a>当判断fd读事件之后的流程</h1><p>epoll_wait判断到有读事件，主线程会直接将该连接对象丢到线程池让线程池线程处理</p>
<p>进入线程池后，会先进行读操作，将数据读入自定义的Buffer类对象中，这个对象也是在连接对象中有定义的，有分为读缓冲区<code>readBuffer</code>和写缓冲区<code>writeBuffer</code>，这里的读是读到读缓冲区当中</p>
<p>不管是LT读还是ET读，运行完读函数之后又会进入到一个处理函数<code>process()</code>中进行解析并判断请求报文是否完整，不完整返回false并注册EPOLLIN事件让线程继续读，如果报文完整则在写缓存写入响应报文</p>
<p>解析报文时会分部分读取，请求行再到请求头部最后是请求体，请求行和请求头部会逐行分析，以回车符换行符<code>\r\n</code>作为一行结束的条件，逐行解析用到的函数为<code>std::search()</code><strong>这个可以研究一下</strong></p>
<p>得到<strong>请求行</strong>会通过正则表达式分析出method、path、version，即请求方法、请求资源、HTTP版本号</p>
<p>解析<strong>请求头部</strong>则是分析如<code>Connection</code>、<code>keep-alive</code>、<code>Content-Length</code>，其中Content-Length可以得知body的长度，另外这里解析头部有个代码不知道什么意思</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">smatch subMatch<span class="token punctuation">;</span>
<span class="token comment">//...</span>
header<span class="token punctuation">[</span>subMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> subMatch<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//?</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>到了<strong>请求体</strong>，只会进行POST请求的判断，如果<code>Content-Type</code>是<code>application/x-www-form-urlencoded</code>则会进行解析数据，<strong>这里不懂也可以研究</strong>，涉及转码问题，然后进行登录注册这些操作；如果是<code>multipart/form-data</code>则为上传文件</p>
<p>到此解析请求报文结束</p>
<p>然后如果请求报文完整则进行响应报文的写操作为发送响应报文做准备（其实就算不完整也会写响应报文，只是会再次接受数据再分析响应报文）</p>
<p>在写之前会判断浏览器请求的文件是否存在、路径是否正确，这里是通过<code>stat()</code>获取文件文件属性，然后通过两个宏<code>S_ISDIR()</code>，<code>S_IROTH()</code>来判断状态码，错误的话分为404和403（S_IROTH判断文件是否有“其他读”权限，如果浏览器无权限读则返回403）</p>
<p>搞完上面的东西后，就是按步骤添加状态行、响应头部、响应正文，添加响应正文时会将请求的文件用<code>mmap()</code>映射到内存，提高读写速度，并且附加属性使其映射区可读以及写入时可复制</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//将文件映射到内存提高文件的访问速度</span>
<span class="token comment">//PROT_READ：映射区可读</span>
<span class="token comment">//MAP_PRIVATE：写入时复制</span>
<span class="token keyword">int</span><span class="token operator">*</span> mmRet <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> mmFileStat<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_PRIVATE<span class="token punctuation">,</span> srcfd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<p>添加完响应正文内容并且请求报文是完整的则进行发送操作，使用一次<code>writev()</code>发送iov[2]向量（这个写io向量和读的不同，他是在连接类对象中的）后，会进行判断是否发送完毕，如果没有发送完进入第二个判断：响应头部是否发送完毕，接着再继续接下来的内容发送。以上的writev和两重判断都是在一个do…while()循环里面进行的</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/* 写方法,响应头和响应体分开传输 */</span>
ssize_t <span class="token class-name">HttpConnect</span><span class="token operator">::</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> saveErrno<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//最后一次写入的长度</span>
    ssize_t len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span>
    <span class="token punctuation">&#123;</span>
        len <span class="token operator">=</span> <span class="token function">writev</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> iov<span class="token punctuation">,</span> iovCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token operator">*</span>saveErrno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//缓存为空，传输完成</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">+</span> iov<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token comment">//响应头已经传输完成</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>len <span class="token operator">></span> iov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">//更新响应体传输起点和长度</span>
            iov<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>iov<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">+</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> iov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            iov<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">-=</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> iov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//响应头不再需要传输</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>iov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token comment">//响应头保存在写缓存中，全部回收即可</span>
                iov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                writeBuffer<span class="token punctuation">.</span><span class="token function">retrieveAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//响应头还没传输完成</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">//更新响应头传输起点和长度</span>
            iov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>iov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">+</span> len<span class="token punctuation">;</span>
            iov<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">-=</span> len<span class="token punctuation">;</span>
            writeBuffer<span class="token punctuation">.</span><span class="token function">retrieve</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>isET <span class="token operator">||</span> <span class="token function">toWriteBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">10240</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//一次最多传输10MB数据</span>
    <span class="token keyword">return</span> len<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>至此，一次完整的浏览器请求事件完成</p>
<h1 id="如果在读数据读到一半发现读的不是HTTP怎么办"><a href="#如果在读数据读到一半发现读的不是HTTP怎么办" class="headerlink" title="如果在读数据读到一半发现读的不是HTTP怎么办"></a>如果在读数据读到一半发现读的不是HTTP怎么办</h1><p>可以参考这篇文章：<a target="_blank" rel="noopener" href="https://www.yht7.com/news/186483">https://www.yht7.com/news/186483</a></p>
<p>HTTP是有协议的，一开始读取请求行的时候就可以通过格式判断，请求行中最后面有HTTP的版本号，如果我们在请求行中检测到格式不是HTTP协议的则可以立马返回BAD_REQUEST，表示格式错误</p>
<p>如果是读到半路发现HTTP格式不规范（比如多了个空格导致解析时切分不合理）的话，也应该返回400（格式错误的请求语法，太大的大小，无效的请求消息或欺骗性路由请求），出现这种不规范原因可能是前端提交的数据字段名称或类型与后台的实体类不一致，导致无法封装</p>
<p>我在代码中也有一个地方处理了类似的问题，因为项目中除了消息体之外，请求行和请求头都是逐行来读取然后解析的，如果解析到格式错误（正则表达式匹配不到）则会返回BAD_REQUEST状态然后由IO线程注册写任务，让写工作线程写400错误响应报文</p>
<p>下面是一个正常的HTTP的GET请求格式</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">GET https://www.baidu.com/content-search.xml HTTP/1.1
Host: www.baidu.com
Connection: keep-alive
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: no-cors
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie:xxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="如果一次HTTP解析器从Socket中读到的数据可能并不是直接对应一个HTTP-Message怎么办（所谓的“粘包”←当然这说法是错误的）"><a href="#如果一次HTTP解析器从Socket中读到的数据可能并不是直接对应一个HTTP-Message怎么办（所谓的“粘包”←当然这说法是错误的）" class="headerlink" title="如果一次HTTP解析器从Socket中读到的数据可能并不是直接对应一个HTTP Message怎么办（所谓的“粘包”←当然这说法是错误的）"></a>如果一次HTTP解析器从Socket中读到的数据可能并不是直接对应一个HTTP Message怎么办（所谓的“粘包”←当然这说法是错误的）</h1><p>题目大概意思就是说：一个缓冲区里的两个HTTP报文</p>
<p>知乎有个回答非常好：<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/24598268/answer/2293520538">https://www.zhihu.com/question/24598268/answer/2293520538</a></p>
<p>首先HTTP协议是应用层的，而TCP是传输层的。TCP是面向流传输的，没有包的概念，要在这个基础上实现HTTP传输协议则需要一个缓冲区和定时器。那么当数据从socket读出来时候，所有数据放在缓冲区，这时候就要开始应用层分包了，这个问题通过HTTP协议规定好的规则来进行数据划分，比如HTTP协议的Headers以“\r\n”作为字段的分隔符；当然也可以是在每条消息的头部加一个文件长度字段进行划分</p>
<p>总之我们要明白，HTTP协议是不存在所谓“粘包”问题，因为它已经定义好了怎么划分每个已经到达缓冲区的数据包</p>
<h1 id="项目有哪些组件"><a href="#项目有哪些组件" class="headerlink" title="项目有哪些组件"></a>项目有哪些组件</h1><p>总的来说：同步模块（互斥锁、信号量、条件变量）、封装的epoll模块、线程池、连接池、可自动扩容的buff类、定时器以及HTTP的连接、请求与响应模块</p>
<h2 id="互斥锁"><a href="#互斥锁" class="headerlink" title="互斥锁"></a>互斥锁</h2><h2 id="这里有个经典的问题：为什么不用读写锁而用互斥锁？"><a href="#这里有个经典的问题：为什么不用读写锁而用互斥锁？" class="headerlink" title="这里有个经典的问题：为什么不用读写锁而用互斥锁？"></a>这里有个经典的问题：为什么不用读写锁而用互斥锁？</h2><p>首先，我们可能会误认为读写锁肯定会比互斥锁效率高，其实并没有多高效，读锁还要维护一个reader的数目，如果临界区很小，锁竞争不激烈的话，往往互斥锁会更高效一些；</p>
<p>其次如果我们用了读写锁，还要维护读与写之间的关系，比如在一个函数中是用的读锁来保护的，但是可能在维护阶段我们会对它进行修改数据，这时候和无保护结果是一致的；</p>
<p>还有一种情况就是，如果一直有读线程获取读锁，这样会导致写线程无法获取写锁，导致写线程饿死</p>
<h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><p>线程池是在服务器启动时创建的，在Reactor模式中，IO线程作为一个主线程，线程池中的线程是负责业务处理的工作线程，工作线程内部是一个循环，当没有事件需要处理时会因为条件变量阻塞而进行等待。当epoll_wait监听到事件时会将该事件的连接对象<code>httpconnect</code>放入线程池<code>que</code>队列当中，然后唤醒条件变量，让工作线程处理事件</p>
<h2 id="Http连接对象"><a href="#Http连接对象" class="headerlink" title="Http连接对象"></a>Http连接对象</h2><p>我在项目中建立了一个类<code>httpconnect</code>来存储连接对象的信息，比如它们的文件描述符、socketaddr信息、有两个可自动扩容Buffer对象（这两个buffer是缓冲区，用来存储从连接对象的文件描述符中readv读到的数据以及即将要write写入的数据）、另外还有两个<code>httprequest</code>请求类对象和<code>httpresponse</code>响应类对象（这两个类对象是用来分步骤解析http报文和制作响应报文的）</p>
<p>在解析http报文的时候用的是有限状态机机制，根据当前所解析到的状态来寻找下一步怎么做，比如说刚开始的时候状态是REQUEST_LINE，代表着要进行请求行的解析，如果解析完没有出现格式错误等问题的话会将状态更新成HEADERS，代表下一步进行解析请求头部</p>
<p>而制作响应报文方法我进行了优化，使用一个哈希表来存放不同的生成报文函数的回调函数，在制作响应报文时根据http请求方法来调用不同的生成函数，这种设计是考虑到为以后添加新的解析请求而做的，因为目前服务器只支持解析GET、POST、HEAD三个类型的请求</p>
<h2 id="可自动扩容Buffer"><a href="#可自动扩容Buffer" class="headerlink" title="可自动扩容Buffer"></a>可自动扩容Buffer</h2><p>每个连接对象都有两个Buffer，一个读buffer和一个写buffer</p>
<p>该buffer是参考muduo网络库那本书的思想设计的，底层是用了<code>vector&lt;char&gt;</code>数组，初始化的时候可以自定义数组的大小，其中会额外预留一个8字节的空间放在缓冲区最前面，这个预留空间可以用来在收到数据时计算数据包的大小并且存放在这个8字节的空间里，当然，这个空间是可以修改的</p>
<p>然后这个buffer封装了读fd和写fd的两个方法，可以自动化帮我们完成从文件描述符中的读写操作。在读的时候，会额外在栈中，也就是局部变量声明一个newbuffer，这个newbuffer是后备缓冲区，如果这次读操作超过了我们本身的缓冲区大小，就会把剩下的数据读到newbuffer里面，这里用到的是io向量读。当读取完毕后，会将newbuffer读到的数据增添在原本的buffer里面（这时候就会将buffer扩容）。</p>
<p><strong>？如果读完newbuffer也不够怎么办呢？</strong></p>
<p>如果这次数据读满了这个newbuffer也没读完则会等下一次epoll事件上报，继续读取数据不会丢失</p>
<p>写的话就很简单了，直接把buffer里面的数据往fd里调用write函数就是了</p>
<h1 id="下载上传功能是怎么实现的？"><a href="#下载上传功能是怎么实现的？" class="headerlink" title="下载上传功能是怎么实现的？"></a>下载上传功能是怎么实现的？</h1><p>下载功能的话，项目中有一个json列表，用来记录用户上传过的文件，下载页面则是根据这个json列表来展示出可下载文件列表</p>
<p>上传功能的话，是在解析http报文时在请求头检测到<code>Content-Type</code>为指定类型（<code>multipart/form-data</code>）时调用上传文件的对应方法，该方法首先是从报文中获取文件的相关信息（比如文件的大小），这些信息已经是在报文中的了，之后再从POST请求报文所附带的内容拷贝到服务器当中，这样就完成了上传功能</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/53b5bd0f1d44">Post请求的两种编码格式：application/x-www-form-urlencoded和multipart/form-data</a></p>
<h1 id="HTTP协议再熟悉"><a href="#HTTP协议再熟悉" class="headerlink" title="HTTP协议再熟悉"></a>HTTP协议再熟悉</h1><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/facefd3969d4">概括HTTP知识点挺全的文章</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Sakura.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/SakuraServer%E9%A1%B9%E7%9B%AE/">http://sakura-pub.top/%E9%9D%A2%E8%AF%95/SakuraServer%E9%A1%B9%E7%9B%AE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%9D%A2%E8%AF%95/">面试</a><a class="post-meta__tags" href="/tags/WebServer/">WebServer</a><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a></div><div class="post_share"><div class="social-share" data-image="https://p6-tt.byteimg.com/origin/pgc-image/85a708e60c5d4418b51f9c64f6bf058a.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/%E9%9D%A2%E8%AF%95/C++-%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E7%BB%86%E8%8A%82%E9%97%AE%E9%A2%98%E7%AF%87%EF%BC%89/"><img class="next-cover" src="https://p.qlogo.cn/hy_personal/3e28f14aa0516842cca4bda79cde803eb27dc704e582549a4cc8c5dea1360098/0.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">C++集群聊天服务器（细节问题篇）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/面试/WebServer项目解析/" title="WebServer项目解析"><img class="cover" src="https://pic.rmb.bdstatic.com/bjh/39c69a365c6f2c263d521ff2b80a1efd.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-15</div><div class="title">WebServer项目解析</div></div></a></div><div><a href="/面试/C++集群聊天服务器（正式内容篇）/" title="C++集群聊天服务器（正式内容篇）"><img class="cover" src="https://pic.rmb.bdstatic.com/bjh/5c2c84703a1bba59b28ba5819bf00b1e.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-17</div><div class="title">C++集群聊天服务器（正式内容篇）</div></div></a></div><div><a href="/面试/进程间通信/" title="进程间通信"><img class="cover" src="https://pic.rmb.bdstatic.com/bjh/ffd91bf2df53f05f2a1335acb23ae44f.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-14</div><div class="title">进程间通信</div></div></a></div><div><a href="/面试/暑假冲刺秋招项目-C++集群聊天服务器（预备知识篇）/" title="暑假冲刺秋招项目--C++集群聊天服务器（预备知识篇）"><img class="cover" src="https://pic.rmb.bdstatic.com/bjh/d488e66d13da478d5eab285e068bdcd3.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-16</div><div class="title">暑假冲刺秋招项目--C++集群聊天服务器（预备知识篇）</div></div></a></div><div><a href="/面试/C++-集群聊天服务器（优化篇）/" title="C++集群聊天服务器（优化篇）"><img class="cover" src="https://pic.rmb.bdstatic.com/bjh/f4a9fb349489af60d0af1b1ccfca71fe.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-24</div><div class="title">C++集群聊天服务器（优化篇）</div></div></a></div><div><a href="/面试/C++-集群聊天服务器（细节问题篇）/" title="C++集群聊天服务器（细节问题篇）"><img class="cover" src="https://p.qlogo.cn/hy_personal/3e28f14aa0516842cca4bda79cde803eb27dc704e582549a4cc8c5dea1360098/0.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-02</div><div class="title">C++集群聊天服务器（细节问题篇）</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://i.loli.net/2021/11/01/ilJyOSYrF7m4M3X.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Sakura.</div><div class="author-info__description">升起的烟花,从下面看?还是从侧面看?</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">47</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">8</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">7</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/KiritoZz6"><i class="fab fa-github"></i><span>关注我</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/KiritoZz6" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/sakura_zz@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">欢迎来到我的个人博客！如果对文章有问题或者发现错误可以发邮件给我，Email：sakura_zz@163.com</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Sakura-WebServer"><span class="toc-number">1.</span> <span class="toc-text">Sakura WebServer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%AB%E4%BA%BA%E7%9A%84%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.1.</span> <span class="toc-text">别人的项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E4%B8%8A%E6%89%BE%E5%88%B0%E5%88%AB%E4%BA%BA%E6%8F%90%E5%89%8D%E6%89%B9%E7%BB%99%E9%97%AE%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.</span> <span class="toc-text">网上找到别人提前批给问到的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%9B%E5%AE%A2%E6%9C%89%E4%BA%BA%E4%BA%AC%E4%B8%9C%E9%9D%A2%E7%BB%8F%E4%B9%9F%E9%97%AE%E5%88%B0%E4%BA%86WebServer"><span class="toc-number">1.3.</span> <span class="toc-text">牛客有人京东面经也问到了WebServer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-number">1.4.</span> <span class="toc-text">定时器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8%E6%95%B0%E7%BB%84%E6%A8%A1%E6%8B%9F%E5%A0%86%E5%91%A2%EF%BC%9F"><span class="toc-number">1.4.1.</span> <span class="toc-text">问题：为什么要用数组模拟堆呢？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BC%93%E5%86%B2%E5%8C%BABuffer"><span class="toc-number">1.5.</span> <span class="toc-text">自定义缓冲区Buffer</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BD%93%E5%88%A4%E6%96%ADfd%E8%AF%BB%E4%BA%8B%E4%BB%B6%E4%B9%8B%E5%90%8E%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">当判断fd读事件之后的流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E5%9C%A8%E8%AF%BB%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%88%B0%E4%B8%80%E5%8D%8A%E5%8F%91%E7%8E%B0%E8%AF%BB%E7%9A%84%E4%B8%8D%E6%98%AFHTTP%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-number">3.</span> <span class="toc-text">如果在读数据读到一半发现读的不是HTTP怎么办</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E4%B8%80%E6%AC%A1HTTP%E8%A7%A3%E6%9E%90%E5%99%A8%E4%BB%8ESocket%E4%B8%AD%E8%AF%BB%E5%88%B0%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%83%BD%E5%B9%B6%E4%B8%8D%E6%98%AF%E7%9B%B4%E6%8E%A5%E5%AF%B9%E5%BA%94%E4%B8%80%E4%B8%AAHTTP-Message%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%88%E6%89%80%E8%B0%93%E7%9A%84%E2%80%9C%E7%B2%98%E5%8C%85%E2%80%9D%E2%86%90%E5%BD%93%E7%84%B6%E8%BF%99%E8%AF%B4%E6%B3%95%E6%98%AF%E9%94%99%E8%AF%AF%E7%9A%84%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">如果一次HTTP解析器从Socket中读到的数据可能并不是直接对应一个HTTP Message怎么办（所谓的“粘包”←当然这说法是错误的）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%9C%89%E5%93%AA%E4%BA%9B%E7%BB%84%E4%BB%B6"><span class="toc-number">5.</span> <span class="toc-text">项目有哪些组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%94%81"><span class="toc-number">5.1.</span> <span class="toc-text">互斥锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%99%E9%87%8C%E6%9C%89%E4%B8%AA%E7%BB%8F%E5%85%B8%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E7%94%A8%E8%AF%BB%E5%86%99%E9%94%81%E8%80%8C%E7%94%A8%E4%BA%92%E6%96%A5%E9%94%81%EF%BC%9F"><span class="toc-number">5.2.</span> <span class="toc-text">这里有个经典的问题：为什么不用读写锁而用互斥锁？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">5.3.</span> <span class="toc-text">线程池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Http%E8%BF%9E%E6%8E%A5%E5%AF%B9%E8%B1%A1"><span class="toc-number">5.4.</span> <span class="toc-text">Http连接对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E8%87%AA%E5%8A%A8%E6%89%A9%E5%AE%B9Buffer"><span class="toc-number">5.5.</span> <span class="toc-text">可自动扩容Buffer</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F"><span class="toc-number">6.</span> <span class="toc-text">下载上传功能是怎么实现的？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTP%E5%8D%8F%E8%AE%AE%E5%86%8D%E7%86%9F%E6%82%89"><span class="toc-number">7.</span> <span class="toc-text">HTTP协议再熟悉</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/%E9%9D%A2%E8%AF%95/SakuraServer%E9%A1%B9%E7%9B%AE/" title="SakuraServer项目"><img src="https://p6-tt.byteimg.com/origin/pgc-image/85a708e60c5d4418b51f9c64f6bf058a.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SakuraServer项目"/></a><div class="content"><a class="title" href="/%E9%9D%A2%E8%AF%95/SakuraServer%E9%A1%B9%E7%9B%AE/" title="SakuraServer项目">SakuraServer项目</a><time datetime="2022-09-07T14:09:31.000Z" title="Created 2022-09-07 22:09:31">2022-09-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E9%9D%A2%E8%AF%95/C++-%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E7%BB%86%E8%8A%82%E9%97%AE%E9%A2%98%E7%AF%87%EF%BC%89/" title="C++集群聊天服务器（细节问题篇）"><img src="https://p.qlogo.cn/hy_personal/3e28f14aa0516842cca4bda79cde803eb27dc704e582549a4cc8c5dea1360098/0.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++集群聊天服务器（细节问题篇）"/></a><div class="content"><a class="title" href="/%E9%9D%A2%E8%AF%95/C++-%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E7%BB%86%E8%8A%82%E9%97%AE%E9%A2%98%E7%AF%87%EF%BC%89/" title="C++集群聊天服务器（细节问题篇）">C++集群聊天服务器（细节问题篇）</a><time datetime="2022-09-02T02:41:04.000Z" title="Created 2022-09-02 10:41:04">2022-09-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E9%9D%A2%E8%AF%95/C++-%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E4%BC%98%E5%8C%96%E7%AF%87%EF%BC%89/" title="C++集群聊天服务器（优化篇）"><img src="https://pic.rmb.bdstatic.com/bjh/f4a9fb349489af60d0af1b1ccfca71fe.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++集群聊天服务器（优化篇）"/></a><div class="content"><a class="title" href="/%E9%9D%A2%E8%AF%95/C++-%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E4%BC%98%E5%8C%96%E7%AF%87%EF%BC%89/" title="C++集群聊天服务器（优化篇）">C++集群聊天服务器（优化篇）</a><time datetime="2022-07-24T15:10:26.000Z" title="Created 2022-07-24 23:10:26">2022-07-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E9%9D%A2%E8%AF%95/C++%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E6%AD%A3%E5%BC%8F%E5%86%85%E5%AE%B9%E7%AF%87%EF%BC%89/" title="C++集群聊天服务器（正式内容篇）"><img src="https://pic.rmb.bdstatic.com/bjh/5c2c84703a1bba59b28ba5819bf00b1e.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++集群聊天服务器（正式内容篇）"/></a><div class="content"><a class="title" href="/%E9%9D%A2%E8%AF%95/C++%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E6%AD%A3%E5%BC%8F%E5%86%85%E5%AE%B9%E7%AF%87%EF%BC%89/" title="C++集群聊天服务器（正式内容篇）">C++集群聊天服务器（正式内容篇）</a><time datetime="2022-07-17T03:56:18.000Z" title="Created 2022-07-17 11:56:18">2022-07-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E9%9D%A2%E8%AF%95/%E6%9A%91%E5%81%87%E5%86%B2%E5%88%BA%E7%A7%8B%E6%8B%9B%E9%A1%B9%E7%9B%AE-C++%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86%E7%AF%87%EF%BC%89/" title="暑假冲刺秋招项目--C++集群聊天服务器（预备知识篇）"><img src="https://pic.rmb.bdstatic.com/bjh/d488e66d13da478d5eab285e068bdcd3.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="暑假冲刺秋招项目--C++集群聊天服务器（预备知识篇）"/></a><div class="content"><a class="title" href="/%E9%9D%A2%E8%AF%95/%E6%9A%91%E5%81%87%E5%86%B2%E5%88%BA%E7%A7%8B%E6%8B%9B%E9%A1%B9%E7%9B%AE-C++%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86%E7%AF%87%EF%BC%89/" title="暑假冲刺秋招项目--C++集群聊天服务器（预备知识篇）">暑假冲刺秋招项目--C++集群聊天服务器（预备知识篇）</a><time datetime="2022-07-16T06:38:33.000Z" title="Created 2022-07-16 14:38:33">2022-07-16</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Sakura.</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'uoCtAtvANzWpqnPNGCNRPK7g-gzGzoHsz',
      appKey: 'NIjj8lYmojE9cbwXtTlGUh6F',
      placeholder: '记得留下你的昵称和邮箱....可以快速收到回复',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer src="/live2d-widget/autoload.js"></script><script src="/cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>