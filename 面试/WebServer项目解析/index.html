<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>WebServer项目解析 | 🌸樱花酒吧🍻</title><meta name="keywords" content="面试,WebServer,项目"><meta name="author" content="Sakura."><meta name="copyright" content="Sakura."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="这篇文章是用来记录并复习之前写过的一个TinyWebServer项目，希望可以梳理一下思路，更进一步吸收里面的知识点，前面几个部分是网上找的知识点总结，后面也有自己对项目的分析 WebServer总体概述 epoll 的 ET和LT模式 MySQL数据库 数据库连接池 线程池 日志系统 定时器 Reactor模式（设计模式：反应堆模式） HTTP 大端序和小端序的互转 读写缓冲区  WebServ">
<meta property="og:type" content="article">
<meta property="og:title" content="WebServer项目解析">
<meta property="og:url" content="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name" content="🌸樱花酒吧🍻">
<meta property="og:description" content="这篇文章是用来记录并复习之前写过的一个TinyWebServer项目，希望可以梳理一下思路，更进一步吸收里面的知识点，前面几个部分是网上找的知识点总结，后面也有自己对项目的分析 WebServer总体概述 epoll 的 ET和LT模式 MySQL数据库 数据库连接池 线程池 日志系统 定时器 Reactor模式（设计模式：反应堆模式） HTTP 大端序和小端序的互转 读写缓冲区  WebServ">
<meta property="og:locale">
<meta property="og:image" content="https://pic.rmb.bdstatic.com/bjh/39c69a365c6f2c263d521ff2b80a1efd.png">
<meta property="article:published_time" content="2022-06-15T05:43:43.000Z">
<meta property="article:modified_time" content="2022-07-13T16:16:36.237Z">
<meta property="article:author" content="Sakura.">
<meta property="article:tag" content="面试">
<meta property="article:tag" content="WebServer">
<meta property="article:tag" content="项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.rmb.bdstatic.com/bjh/39c69a365c6f2c263d521ff2b80a1efd.png"><link rel="shortcut icon" href="/img/0.png"><link rel="canonical" href="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'WebServer项目解析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-07-14 00:16:36'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="https://sakura-pub.ltd/css/Sakura.css"><link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="🌸樱花酒吧🍻" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://i.loli.net/2021/11/01/ilJyOSYrF7m4M3X.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">47</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">8</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 目录</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类目录</span></a></li><li><a class="site-page child" href="/LeetCode/LeetCode%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%9C%9F/"><i class="fa-fw fas-archive"></i><span> LeetCode刷题笔记</span></a></li><li><a class="site-page child" href="/categories/%E8%AE%B0%E4%BA%8B/"><span> 记事</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/%E8%AE%B0%E4%BA%8B/%E5%85%B3%E4%BA%8E%E6%88%91/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pic.rmb.bdstatic.com/bjh/39c69a365c6f2c263d521ff2b80a1efd.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">🌸樱花酒吧🍻</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 目录</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类目录</span></a></li><li><a class="site-page child" href="/LeetCode/LeetCode%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%9C%9F/"><i class="fa-fw fas-archive"></i><span> LeetCode刷题笔记</span></a></li><li><a class="site-page child" href="/categories/%E8%AE%B0%E4%BA%8B/"><span> 记事</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/%E8%AE%B0%E4%BA%8B/%E5%85%B3%E4%BA%8E%E6%88%91/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">WebServer项目解析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-06-15T05:43:43.000Z" title="Created 2022-06-15 13:43:43">2022-06-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-07-13T16:16:36.237Z" title="Updated 2022-07-14 00:16:36">2022-07-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%A2%E8%AF%95/%E9%A1%B9%E7%9B%AE/">项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="WebServer项目解析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>这篇文章是用来记录并复习之前写过的一个TinyWebServer项目，希望可以梳理一下思路，更进一步吸收里面的知识点，前面几个部分是网上找的知识点总结，后面也有自己对项目的分析</p>
<h1 id="WebServer总体概述"><a href="#WebServer总体概述" class="headerlink" title="WebServer总体概述"></a>WebServer总体概述</h1><ul>
<li>epoll 的 <code>ET</code>和<code>LT</code>模式</li>
<li>MySQL数据库</li>
<li>数据库连接池</li>
<li>线程池</li>
<li>日志系统</li>
<li>定时器</li>
<li>Reactor模式（设计模式：反应堆模式）</li>
<li>HTTP</li>
<li>大端序和小端序的互转</li>
<li>读写缓冲区</li>
</ul>
<h1 id="WebServer大概的工作流程"><a href="#WebServer大概的工作流程" class="headerlink" title="WebServer大概的工作流程"></a>WebServer大概的工作流程</h1><p>这里有张图可以概括整个Server的工作流程</p>
<p><img src="https://pic.rmb.bdstatic.com/bjh/0af1379f52f5a695800cfb33599035fa.jpeg" alt="v2-c16b9b3c7c2e279227204a88fc95d1bb_r.jpg"></p>
<p>分点来说如下：</p>
<ol>
<li>主线程监听连接</li>
<li>主线程让一个epoll监听活跃的文件描述符</li>
<li>处理完连接进来的文件描述符之后开工作线程</li>
<li>工作线程处理任务（读和写任务是分开的，不一定是同一个线程共同操作）</li>
<li>http_conn是一个负责HTTP请求的响应和处理的类，一个用户一个实例；同时在解析请求报文时有主从状态机，从状态机是负责读取报文的一行，主状态机是负责对该行数据进行解析</li>
</ol>
<h1 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h1><p>对于服务器的效率，这里有几个方面可以来优化</p>
<h2 id="半同步半反应堆（半同步半异步）"><a href="#半同步半反应堆（半同步半异步）" class="headerlink" title="半同步半反应堆（半同步半异步）"></a>半同步半反应堆（半同步半异步）</h2><ul>
<li>半同步半反应堆是其中一种高效的并发模式实现方式，另一种并发模式为领导者/追随者模式</li>
<li>并发模式指的是I/O处理单元和多个逻辑单元之间协调完成任务的方法</li>
<li>半同步/半反应堆的内容：<ul>
<li>异步线程只有一个，由主线程充当。负责监听所有socket上的事件。如果有新连接请求，主线程接受得到新的连接socket，往epoll内核事件表中注册socket上的读写事件。如果连接上有读写事件，主线程将该连接socket插入请求队列。所有工作线程（同步线程）睡眠在请求队列上，当有任务到来，通过竞争的方式获得任务管理权。</li>
<li>上面的方式采用的事件处理模式为<strong>Reactor模式</strong>。要求工作线程自己从socket上读取客户请求和往socket上写入服务器应答。</li>
<li>也可以采用模拟的<strong>Proactor事件</strong>处理模式。要求主线程完成数据的读写，主线程将应用程序数据、任务类型等信息封装成一个任务对象，然后插入请求队列；工作线程从请求队列中取得任务对象后，直接处理即可，不需要读写操作。</li>
</ul>
</li>
<li>半同步/半反应堆的缺点：<ul>
<li>主线程和工作线程共享请求队列。主线程添加任务、工作线程取出任务，都需要对请求队列进行加锁保护，从而耗费cpu时间。</li>
<li>每个工作线程同一个时间只能处理一个客户请求</li>
</ul>
</li>
</ul>
<h2 id="多进程模型"><a href="#多进程模型" class="headerlink" title="多进程模型"></a>多进程模型</h2><ul>
<li>为每个客户端分配一个进程来处理请求。</li>
<li>服务器的主进程负责监听客户的连接，一旦与客户端连接完成，accept() 函数就会返回一个「已连接 Socket」，这时就通过 <code>fork()</code> 函数创建一个子进程，实际上就把父进程所有相关的东西都<strong>复制</strong>一份，包括文件描述符、内存地址空间、程序计数器、执行的代码等。<ul>
<li>根据返回值来区分是父进程还是子进程，如果返回值是 0，则是子进程；如果返回值是其他的整数，就是父进程。    <ul>
<li>因为子进程会<strong>复制父进程的文件描述符</strong>，于是就可以直接使用「已连接 Socket 」和客户端通信了。 </li>
<li>子进程不需要关心「监听 Socket」，只需要关心「已连接 Socket」；父进程则相反，将客户服务交给子进程来处理，因此父进程不需要关心「已连接 Socket」，只需要关心「监听 Socket」。 </li>
</ul>
</li>
</ul>
</li>
<li>可能出现的问题：<ul>
<li>当「子进程」退出时，实际上内核里还会保留该进程的一些信息，也是会占用内存的，如果不做好“回收”工作，就会变成僵尸进程，随着僵尸进程越多，会慢慢耗尽我们的系统资源。    <ul>
<li>父进程要“善后”好自己的孩子，怎么善后呢？那么有两种方式可以在子进程退出后回收资源，分别是调用 <code>wait()</code> 和 <code>waitpid()</code> 函数。 </li>
<li>进程的上下文切换不仅包含了虚拟内存、栈、全局变量等用户空间的资源，还包括了内核堆栈、寄存器等内核空间的资源。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="多线程模型"><a href="#多线程模型" class="headerlink" title="多线程模型"></a>多线程模型</h2><ul>
<li>线程是运行在进程中的一个“逻辑流”，单进程中可以运行多个线程，同进程里的线程可以共享进程的部分资源的，比如<strong>文件描述符列表、进程空间、代码、全局数据、堆、共享库等，这些共享资源</strong>在上下文切换时是不需要切换，而只需要切换线程的<strong>私有数据、寄存器等不共享的数据</strong>，因此同一个进程下的线程上下文切换的开销要比进程小得多。 </li>
<li>当服务器与客户端 TCP 完成连接后，通过 <code>pthread_create()</code> 函数创建线程，然后将「已连接 Socket」的文件描述符传递给线程函数，接着在线程里和客户端进行通信，从而达到并发处理的目的。 </li>
<li>注意事项 ： <ul>
<li>父进程accept后会把socket放入一个队列。然后线程从这个队列中取socket做操作 </li>
<li>这个队列是全局的，每个线程都会操作，为了避免多线程竞争，线程在操作这个队列前要加锁。</li>
</ul>
</li>
</ul>
<h2 id="Proactor模式和Reactor模式"><a href="#Proactor模式和Reactor模式" class="headerlink" title="Proactor模式和Reactor模式"></a>Proactor模式和Reactor模式</h2><p>服务器程序通常需要处理三类事件：I/O事件，信号及定时事件。有两种事件处理模式即<strong>Proactor模式</strong>和<strong>Reactor模式</strong>：</p>
<ul>
<li>Reactor模式：要求主线程（I/O处理单元）只负责监听文件描述符上是否有事件发生（可读、可写），若有，则立即通知工作线程（逻辑单元），将socket可读可写事件放入请求队列，交给工作线程处理。</li>
<li>Proactor模式：将所有的I/O操作都交给主线程和内核来处理（进行读、写），工作线程仅负责处理逻辑，如主线程读完成后<code>users[sockfd].read()</code>，选择一个工作线程来处理客户请求<code>pool-&gt;append(users + sockfd)</code>。</li>
</ul>
<p>有关更详细的介绍，可以点<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/26943938">这里</a></p>
<p>下面为项目中运用了两个模式的代码：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">deal_with_thread</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    util_timer<span class="token operator">*</span> timer<span class="token operator">=</span>users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>

    <span class="token comment">//reactor模式</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_actormodel<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
            <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//若监测到读事件，将该事件放入请求队列</span>
        m_pool<span class="token operator">-></span><span class="token function">append</span><span class="token punctuation">(</span>users<span class="token operator">+</span>sockfd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token comment">//while</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//proactor</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"deal with the client(%s)"</span><span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//若监测到读事件，将该事件放入请求队列</span>
            m_pool<span class="token operator">-></span><span class="token function">append_p</span><span class="token punctuation">(</span>users<span class="token operator">+</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
                <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
            <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="大端序小端序"><a href="#大端序小端序" class="headerlink" title="大端序小端序"></a>大端序小端序</h1><p><strong>网络序是大端字节序</strong></p>
<p><strong>大端字节序</strong>是看着一样的，数据低位存在内存大位(高位)</p>
<p>小端字节序看着是反过来的，数据低位存在内存小位(低位)</p>
<p>字节序的单位应该是字节，所以string(char为组织结构)是没有大小端之分的。</p>
<p>但是看int和short是能看出来是大端字节序还是小端字节序，借助union。</p>
<p>有现成的转换函数。BSD Socket提供了封装好的转换接口，方便程序员使用。包括从主机字节序到网络字节序的转换函数： htons、htonl；从网络字节序到主机字节序的转换函数：ntohs、ntohl。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/**
* h   - host 主机，主机字节序
* to  - 转换成什么
* n   - network  网络字节序
* s   - short  unsigned short 
* l   - long  unsigned int
**/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="HTTP相关"><a href="#HTTP相关" class="headerlink" title="HTTP相关"></a>HTTP相关</h1><h2 id="一次HTTP请求响应的流程"><a href="#一次HTTP请求响应的流程" class="headerlink" title="一次HTTP请求响应的流程"></a>一次HTTP请求响应的流程</h2><ul>
<li>域名解析 </li>
<li>发起TCP的3次握手 </li>
<li>建立TCP连接后发起http请求 </li>
<li>服务器响应http请求，浏览器得到html代码 </li>
<li>浏览器解析html代码，并请求html代码中的资源（如js、css、图片等） </li>
<li>浏览器对页面进行渲染呈现给用户 </li>
</ul>
<h2 id="HTTP方法"><a href="#HTTP方法" class="headerlink" title="HTTP方法"></a>HTTP方法</h2><ul>
<li>GET：用于请求访问已经被URI（统一资源标识符）识别的资源，可以通过URL传参给服务器 </li>
<li>POST：用于传输信息给服务器，主要功能与GET方法类似，但一般推荐使用POST方式。 </li>
<li>PUT：传输文件，报文主体中包含文件内容，保存到对应URI位置。 </li>
<li>HEAD：获得豹纹不，与GET类似，只是不返回报文主体，一般用于验证URI是否有效。 </li>
<li>DELETE：删除文件，与PUT相反，删除对应URI位置文件。 </li>
<li>OPTIONS：查询相应URI支持的HTTP方法。 </li>
</ul>
<h2 id="GET、POST区别"><a href="#GET、POST区别" class="headerlink" title="GET、POST区别"></a>GET、POST区别</h2><ul>
<li><p>get重点在从服务器上获取资源；</p>
</li>
<li><p>post重点在向服务器发送数据；</p>
</li>
<li><p>get传输数据是通过URL请求，以field（字段）= value的形式，置于URL后，并用”?”连接，多个请求数据间用”&amp;”连接，如<code>http://127.0.0.1/Test/login.action?name=admin&amp;password=admin</code>，这个过程用户是可见的； </p>
</li>
<li><p>post传输数据通过Http的post机制，将字段与对应值封存在请求实体中发送给服务器，这个过程对用户是不可见的； </p>
</li>
<li><p>Get传输的数据量小，因为受URL长度限制，但效率较高； </p>
</li>
<li><p>Post可以传输大量数据，所以上传文件时只能用Post方式； </p>
</li>
<li><p>get是不安全的，因为URL是可见的，可能会泄露私密信息，如密码等； </p>
</li>
<li><p>post较get安全性较高； </p>
</li>
<li><p>get方式只能支持ASCII字符，向服务器传的中文字符可能会乱码。 </p>
</li>
<li><p>post支持标准字符集，可以正确传递中文字符。 </p>
</li>
</ul>
<h2 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h2><ul>
<li><p>1xx：指示信息–表示请求已接收，继续处理 </p>
</li>
<li><p>2xx：成功–表示请求已被成功接收、理解、接受   </p>
<ul>
<li><strong>200</strong>：请求被正常处理 </li>
<li>204：请求被受理但没有资源可以返回 </li>
<li>206：客户端只是请求资源的一部分，服务器只对请求的部分资源执行GET方法，相应报文中通过Content-Range指定范围的资源。 </li>
</ul>
</li>
<li><p>3xx：重定向–要完成请求必须进行更进一步的操作   </p>
<ul>
<li><strong>301</strong>：永久性重定向 </li>
<li><strong>302</strong>：临时重定向 </li>
<li>303：与302状态码有相似功能，只是它希望客户端在请求一个URI的时候，能通过GET方法重定向到另一个URI上 </li>
<li>304：发送附带条件的请求时，条件不满足时返回，与重定向无关 </li>
<li>307：临时重定向，与302类似，只是强制要求使用POST方法 </li>
</ul>
</li>
<li><p>4xx：客户端错误–请求有语法错误或请求无法实现   </p>
<ul>
<li><strong>400：</strong>请求报文语法有误，服务器无法识别 </li>
<li>401：请求需要认证 </li>
<li><strong>403</strong>：请求的对应资源禁止被访问 </li>
<li><strong>404</strong>：服务器无法找到对应资源 </li>
</ul>
</li>
<li><p>5xx：服务器端错误–服务器未能实现合法的请求  </p>
<ul>
<li><strong>500：</strong>服务器内部错误 </li>
<li><strong>503：</strong>服务器正忙 </li>
</ul>
</li>
</ul>
<h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><h3 id="HTTP-与-HTTPS-有哪些区别？"><a href="#HTTP-与-HTTPS-有哪些区别？" class="headerlink" title="HTTP 与 HTTPS 有哪些区别？"></a>HTTP 与 HTTPS 有哪些区别？</h3><ol>
<li>HTTP 是超⽂本传输协议，信息是明⽂传输，存在安全⻛险的问题。HTTPS 则解决 HTTP 不安全的缺陷，在 TCP 和 HTTP ⽹络层之间加⼊了 SSL/TLS 安全协议，使得报⽂能够加密传输。 </li>
<li>HTTP 连接建⽴相对简单， TCP 三次握⼿之后便可进⾏ HTTP 的报⽂传输。⽽ HTTPS 在 TCP 三次握⼿之后，还需进⾏ SSL/TLS 的握⼿过程，才可进⼊加密报⽂传输。 </li>
<li>HTTP 的端⼝号是 80，HTTPS 的端⼝号是 443。 </li>
<li>HTTPS 协议需要向 CA（证书权威机构）申请数字证书，来保证服务器的身份是可信的。 </li>
</ol>
<h3 id="HTTPS-采⽤的是对称加密和⾮对称加密结合的「混合加密」⽅式："><a href="#HTTPS-采⽤的是对称加密和⾮对称加密结合的「混合加密」⽅式：" class="headerlink" title="HTTPS 采⽤的是对称加密和⾮对称加密结合的「混合加密」⽅式："></a>HTTPS 采⽤的是对称加密和⾮对称加密结合的「混合加密」⽅式：</h3><ul>
<li>在通信建⽴前采⽤⾮对称加密的⽅式交换「会话秘钥」，后续就不再使⽤⾮对称加密。 </li>
<li>在通信过程中全部使⽤对称加密的「会话秘钥」的⽅式加密明⽂数据。 </li>
</ul>
<p>采⽤「混合加密」的⽅式的原因：</p>
<ul>
<li>对称加密只使⽤⼀个密钥，运算速度快，密钥必须保密，⽆法做到安全的密钥交换。 </li>
<li>⾮对称加密使⽤两个密钥：公钥和私钥，公钥可以任意分发⽽私钥保密，解决了密钥交换问题但速度慢。 </li>
</ul>
<h3 id="介绍一下HTTP-1-HTTP-2-HTTP-3的发展吧"><a href="#介绍一下HTTP-1-HTTP-2-HTTP-3的发展吧" class="headerlink" title="介绍一下HTTP/1 HTTP/2 HTTP/3的发展吧"></a>介绍一下HTTP/1 HTTP/2 HTTP/3的发展吧</h3><ul>
<li><p>技术的发展都是为了解决某些问题 </p>
</li>
<li><p>HTTP/1的问题是<strong>短链接每次都需要三握四挥</strong>、<strong>不安全</strong>（HTTPs）、无状态（Cookie）、<strong>服务端不能主动发送</strong>。(核心，1.0短连接 1.1可以长连接 不安全) </p>
</li>
<li><p>HTTP/2默认了长连接（Keep-Alive）、<strong>引入TLS/SSL</strong>、Cookie、服务端主动发送、头部压缩、多路复用。但是还有<strong>队头阻塞</strong>的问题（因为虽然进行了长连接，但是还有一种情况会出现队头阻塞，那就是 丢失重传）。(核心 队头阻塞 ssl cookie) </p>
</li>
<li><p>HTTP/3使用<strong>UDP解决了丢失重传导致的队头阻塞</strong>，并且使用了TLS/SSL1.3减少了建立HTTPs连接的时间到1.5-2个RTT（往返时间），还引入了二进制编码，其他细节忘记了。 </p>
</li>
<li><p>提前将资源推送到浏览器 </p>
</li>
<li><p>推送可以基于已发送的请求，例如客户端请求 <code>html</code>，服务端可以主动推送 <code>js</code>、<code>css</code> 文件</p>
</li>
</ul>
<h1 id="自己对项目的解析"><a href="#自己对项目的解析" class="headerlink" title="自己对项目的解析"></a>自己对项目的解析</h1><p>这里是自己再次对项目的解析，也当做一个复习作用。按照模块来解析</p>
<h2 id="main-cpp"><a href="#main-cpp" class="headerlink" title="main.cpp"></a>main.cpp</h2><p>在主函数中，先是解析启动服务器时附加的参数，并将参数行解析，接着在创建服务器对象以及服务器初始化，启动各个模块</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"config.h"</span></span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">"runed."</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
    <span class="token comment">//Log::get_instance()->write_log(1,"%s","server is running");</span>
    <span class="token comment">//需要修改的数据库信息,登录名,密码,库名</span>
    string user <span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">;</span>
    string passwd <span class="token operator">=</span> <span class="token string">"61053208"</span><span class="token punctuation">;</span>
    string databasename <span class="token operator">=</span> <span class="token string">"yourdb"</span><span class="token punctuation">;</span>

    <span class="token comment">//命令行解析</span>
    Config config<span class="token punctuation">;</span>
    config<span class="token punctuation">.</span><span class="token function">parse_arg</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    WebServer server<span class="token punctuation">;</span>

    <span class="token comment">//初始化</span>
    server<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>PORT<span class="token punctuation">,</span> user<span class="token punctuation">,</span> passwd<span class="token punctuation">,</span> databasename<span class="token punctuation">,</span> config<span class="token punctuation">.</span>LOGWrite<span class="token punctuation">,</span> 
                config<span class="token punctuation">.</span>OPT_LINGER<span class="token punctuation">,</span> config<span class="token punctuation">.</span>TRIGMode<span class="token punctuation">,</span>  config<span class="token punctuation">.</span>sql_num<span class="token punctuation">,</span>  config<span class="token punctuation">.</span>thread_num<span class="token punctuation">,</span> 
                config<span class="token punctuation">.</span>close_log<span class="token punctuation">,</span> config<span class="token punctuation">.</span>actor_model<span class="token punctuation">)</span><span class="token punctuation">;</span>
cout<span class="token operator">&lt;&lt;</span><span class="token string">"init\n"</span><span class="token punctuation">;</span>

    <span class="token comment">//日志</span>
    server<span class="token punctuation">.</span><span class="token function">log_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cout<span class="token operator">&lt;&lt;</span><span class="token string">"log_write\n"</span><span class="token punctuation">;</span>
    <span class="token comment">//数据库</span>
    server<span class="token punctuation">.</span><span class="token function">sql_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cout<span class="token operator">&lt;&lt;</span><span class="token string">"sql_pool\n"</span><span class="token punctuation">;</span>
    <span class="token comment">//线程池</span>
    server<span class="token punctuation">.</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cout<span class="token operator">&lt;&lt;</span><span class="token string">"thread_pool\n"</span><span class="token punctuation">;</span>
    <span class="token comment">//触发模式</span>
    server<span class="token punctuation">.</span><span class="token function">trig_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cout<span class="token operator">&lt;&lt;</span><span class="token string">"trig_mode\n"</span><span class="token punctuation">;</span>
    <span class="token comment">//监听</span>
    server<span class="token punctuation">.</span><span class="token function">eventListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cout<span class="token operator">&lt;&lt;</span><span class="token string">"eventlisten\n"</span><span class="token punctuation">;</span>
    <span class="token comment">//运行</span>
    server<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>    
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="WebServer类"><a href="#WebServer类" class="headerlink" title="WebServer类"></a>WebServer类</h2><p>一个webserver对象包含着</p>
<ol>
<li>数据库连接池指针、数据库名称、登录数据库的账号密码等信息，数据库连接数量</li>
<li>线程池指针<code>threadpool&lt;http_conn&gt;* m_pool</code>，线程数量</li>
<li><code>epoll_event</code>数组，数组大小为<code>MAX_EVENT_NUMBER</code>、套接字fd<code>m_listenfd</code>以及一些模式设置的参数</li>
<li>定时器相关的<code>client_data*</code>指针，这是连接资源的结构体，定时器在这个结构体里面；还有一个应该是操作类<code>Utils</code></li>
<li>基础数据中则包含<code>http_conn* users</code>连接数组、管道、epollfd、端口号、root文件目录地址、日志开关、actor模式记录等数据</li>
</ol>
<p>工作流程：</p>
<ol>
<li>初始化</li>
<li>开启日志</li>
<li>开启数据库连接池</li>
<li>开启线程池</li>
<li>设置触发模式</li>
<li>传统网络编程步骤创建监听epoll：eventListen()，其中包含了设置信号步骤</li>
<li>主循环，每次循环判断是新用户加入事件、客户端断开连接事件、定时器事件、客户请求报文事件以及发送报文事件中的哪一个</li>
</ol>
<h3 id="WebServer-h"><a href="#WebServer-h" class="headerlink" title="WebServer.h"></a>WebServer.h</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">WebServer</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">WebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">WebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//服务器初始化函数</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span>string user<span class="token punctuation">,</span>string passWord<span class="token punctuation">,</span>string databaseName<span class="token punctuation">,</span>
            <span class="token keyword">int</span> log_write<span class="token punctuation">,</span><span class="token keyword">int</span> opt_linger<span class="token punctuation">,</span><span class="token keyword">int</span> trigmode<span class="token punctuation">,</span><span class="token keyword">int</span> sql_num<span class="token punctuation">,</span>
            <span class="token keyword">int</span> thread_num<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">,</span><span class="token keyword">int</span> actor_model<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">sql_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">log_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">trig_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">eventListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调整定时器</span>
    <span class="token keyword">void</span> <span class="token function">deal_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">,</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理定时器</span>
    <span class="token keyword">bool</span> <span class="token function">deal_clinet_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理客户端数据</span>
    <span class="token keyword">bool</span> <span class="token function">deal_with_signal</span><span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token operator">&amp;</span> timeout<span class="token punctuation">,</span><span class="token keyword">bool</span><span class="token operator">&amp;</span> stop_server<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理信号</span>
    <span class="token keyword">void</span> <span class="token function">deal_with_thread</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理线程</span>
    <span class="token keyword">void</span> <span class="token function">deal_with_write</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">//基础数据</span>

    <span class="token keyword">int</span> m_port<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> m_root<span class="token punctuation">;</span><span class="token comment">//记录root文件目录</span>
    <span class="token keyword">int</span> m_log_write<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_close_log<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_actormodel<span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> m_pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_epollfd<span class="token punctuation">;</span>
    http_conn<span class="token operator">*</span> users<span class="token punctuation">;</span>


    <span class="token comment">//数据库相关</span>

    connection_pool<span class="token operator">*</span> m_connPool<span class="token punctuation">;</span><span class="token comment">//数据库连接池</span>
    string m_user<span class="token punctuation">;</span><span class="token comment">//登录数据库账号</span>
    string m_passWord<span class="token punctuation">;</span><span class="token comment">//登录数据库密码</span>
    string m_databaseName<span class="token punctuation">;</span><span class="token comment">//数据库名称</span>
    <span class="token keyword">int</span> m_sql_num<span class="token punctuation">;</span>

    <span class="token comment">//线程池相关</span>

    threadpool<span class="token operator">&lt;</span>http_conn<span class="token operator">></span><span class="token operator">*</span> m_pool<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_thread_num<span class="token punctuation">;</span>

    <span class="token comment">//epoll_event相关</span>

    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> m_listenfd<span class="token punctuation">;</span><span class="token comment">//套接字fd</span>
    <span class="token keyword">int</span> m_OPT_LINGER<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_TRIGMode<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_LISTENTrigmode<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_CONNTrigmode<span class="token punctuation">;</span>

    <span class="token comment">//定时器相关</span>

    client_data<span class="token operator">*</span> users_timer<span class="token punctuation">;</span>
    Utils utils<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">//class WebServer</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="WebServer-cpp"><a href="#WebServer-cpp" class="headerlink" title="WebServer.cpp"></a>WebServer.cpp</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"webserver.h"</span></span>


<span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">WebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//http_conn类对象</span>
    users<span class="token operator">=</span><span class="token keyword">new</span> http_conn<span class="token punctuation">[</span>MAX_FD<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">//root文件夹路径</span>
    <span class="token keyword">char</span> server_path<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//* getcwd() -> 获取当前工作目录</span>
    <span class="token function">getcwd</span><span class="token punctuation">(</span>server_path<span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> root<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"/root"</span><span class="token punctuation">;</span>
    m_root<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>server_path<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">strlen</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//记录root文件夹路径到m_root</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_root<span class="token punctuation">,</span>server_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcat</span><span class="token punctuation">(</span>m_root<span class="token punctuation">,</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//定时器</span>
    users_timer<span class="token operator">=</span><span class="token keyword">new</span> client_data<span class="token punctuation">[</span>MAX_FD<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>


<span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">WebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> users<span class="token punctuation">;</span>
    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> users_timer<span class="token punctuation">;</span>
    <span class="token keyword">delete</span> m_pool<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span>string user<span class="token punctuation">,</span>string passWord<span class="token punctuation">,</span>string databaseName<span class="token punctuation">,</span>
            <span class="token keyword">int</span> log_write<span class="token punctuation">,</span><span class="token keyword">int</span> opt_linger<span class="token punctuation">,</span><span class="token keyword">int</span> trigmode<span class="token punctuation">,</span><span class="token keyword">int</span> sql_num<span class="token punctuation">,</span>
            <span class="token keyword">int</span> thread_num<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">,</span><span class="token keyword">int</span> actor_model<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
    m_port<span class="token operator">=</span>port<span class="token punctuation">;</span>
    m_user<span class="token operator">=</span>user<span class="token punctuation">;</span>
    m_passWord<span class="token operator">=</span>passWord<span class="token punctuation">;</span>
    m_databaseName<span class="token operator">=</span>databaseName<span class="token punctuation">;</span>
    m_log_write<span class="token operator">=</span>log_write<span class="token punctuation">;</span>
    m_OPT_LINGER<span class="token operator">=</span>opt_linger<span class="token punctuation">;</span>
    m_TRIGMode<span class="token operator">=</span>trigmode<span class="token punctuation">;</span>
    m_sql_num<span class="token operator">=</span>sql_num<span class="token punctuation">;</span>
    m_thread_num<span class="token operator">=</span>thread_num<span class="token punctuation">;</span>
    m_close_log<span class="token operator">=</span>close_log<span class="token punctuation">;</span>


<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">trig_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//LT+LT</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_TRIGMode<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        m_LISTENTrigmode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        m_CONNTrigmode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//LT+ET</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>m_TRIGMode<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        m_LISTENTrigmode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        m_CONNTrigmode<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//ET+LT</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>m_TRIGMode<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        m_LISTENTrigmode<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        m_CONNTrigmode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//ET+ET</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>m_TRIGMode<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        m_LISTENTrigmode<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        m_CONNTrigmode<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">log_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_close_log<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//日志开启</span>
        <span class="token comment">//初始化日志</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>m_log_write<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token string">"./ServerLog"</span><span class="token punctuation">,</span>m_close_log<span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">,</span><span class="token number">800000</span><span class="token punctuation">,</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token string">"./ServerLog"</span><span class="token punctuation">,</span>m_close_log<span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">,</span><span class="token number">800000</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">sql_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//初始化数据库连接池</span>
    m_connPool<span class="token operator">=</span>connection_pool<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_connPool<span class="token operator">-></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span>m_user<span class="token punctuation">,</span>m_passWord<span class="token punctuation">,</span>m_databaseName<span class="token punctuation">,</span><span class="token number">3306</span><span class="token punctuation">,</span>m_sql_num<span class="token punctuation">,</span>m_close_log<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    
    <span class="token comment">//初始化数据库读取表，即将数据库中原有的账号密码导入到服务器内存的map中</span>
    users<span class="token operator">-></span><span class="token function">initMysql_result</span><span class="token punctuation">(</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//线程池</span>
    m_pool<span class="token operator">=</span><span class="token keyword">new</span> threadpool<span class="token operator">&lt;</span>http_conn<span class="token operator">></span><span class="token punctuation">(</span>m_actormodel<span class="token punctuation">,</span>m_connPool<span class="token punctuation">,</span>m_thread_num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//?监听事件这个函数里面实现需要结合其它代码来研究</span>
<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">eventListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//网络编程基础步骤</span>
    m_listenfd<span class="token operator">=</span><span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>m_listenfd<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//优雅关闭连接</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_OPT_LINGER<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">struct</span> <span class="token class-name">linger</span> tmp<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token function">setsockopt</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_LINGER<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>m_OPT_LINGER<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">struct</span> <span class="token class-name">linger</span> tmp<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token function">setsockopt</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_LINGER<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family<span class="token operator">=</span>AF_INET<span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token operator">=</span><span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port<span class="token operator">=</span><span class="token function">htons</span><span class="token punctuation">(</span>m_port<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token operator">&amp;</span>flag<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret<span class="token operator">=</span><span class="token function">bind</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//绑定ip地址和端口</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret<span class="token operator">=</span><span class="token function">listen</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//允许最多五个客户端与服务器同时保存连接</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    utils<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//用于存储epoll事件表中就绪事件的event数组</span>
    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//创建epoll</span>
    m_epollfd<span class="token operator">=</span><span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>m_epollfd<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//往epoll内核事件中注册监听socket事件，当listen到新的客户连接时，listenfd变为就绪状态</span>
    utils<span class="token punctuation">.</span><span class="token function">addfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_listenfd<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span>m_LISTENTrigmode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//添加epoll监听事件</span>
    http_conn<span class="token operator">::</span>m_epollfd<span class="token operator">=</span>m_epollfd<span class="token punctuation">;</span>
    
    <span class="token comment">//*socketpair() -> 用于创建一对无名的、相互连接的套接字，可以实现进程间的双向通信，也可以用于网络通信</span>
    ret<span class="token operator">=</span><span class="token function">socketpair</span><span class="token punctuation">(</span>PF_UNIX<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>m_pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    utils<span class="token punctuation">.</span><span class="token function">setnonblocking</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置非阻塞</span>
    utils<span class="token punctuation">.</span><span class="token function">addfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    utils<span class="token punctuation">.</span><span class="token function">addsig</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    utils<span class="token punctuation">.</span><span class="token function">addsig</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span>utils<span class="token punctuation">.</span>sig_handler<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    utils<span class="token punctuation">.</span><span class="token function">addsig</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>utils<span class="token punctuation">.</span>sig_handler<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//工具类，信号和描述符的基础操作</span>
    Utils<span class="token operator">::</span>u_pipefd<span class="token operator">=</span>m_pipefd<span class="token punctuation">;</span>
    Utils<span class="token operator">::</span>u_epollfd<span class="token operator">=</span>m_epollfd<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//创建定时器</span>
<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span>client_address<span class="token punctuation">,</span>m_root<span class="token punctuation">,</span>m_CONNTrigmode<span class="token punctuation">,</span>m_close_log<span class="token punctuation">,</span>m_user<span class="token punctuation">,</span>m_passWord<span class="token punctuation">,</span>m_databaseName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//初始化client_data数据</span>
    <span class="token comment">//创建定时器，设置回调函数和超时时间，绑定用户数据，将定时器添加到链表当中</span>
    users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>addreess<span class="token operator">=</span>client_address<span class="token punctuation">;</span>
    users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>sockfd<span class="token operator">=</span>connfd<span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span> timer<span class="token operator">=</span><span class="token keyword">new</span> util_timer<span class="token punctuation">;</span>
    timer<span class="token operator">-></span>user_data<span class="token operator">=</span><span class="token operator">&amp;</span>users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">;</span>
    timer<span class="token operator">-></span>cb_func<span class="token operator">=</span>cb_func<span class="token punctuation">;</span>
    time_t cur<span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timer<span class="token operator">-></span>expire<span class="token operator">=</span>cur<span class="token operator">+</span><span class="token number">3</span><span class="token operator">*</span>TIMESLOT<span class="token punctuation">;</span>
    users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token operator">=</span>timer<span class="token punctuation">;</span>
    utils<span class="token punctuation">.</span>m_timer_lst<span class="token punctuation">.</span><span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//若有数据传输，则将定时器往后延迟3个单位</span>
<span class="token comment">//并对新的定时器在链表上的位置进行调整</span>
<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    time_t cur<span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timer<span class="token operator">-></span>expire<span class="token operator">=</span>cur<span class="token operator">+</span><span class="token number">3</span><span class="token operator">*</span>TIMESLOT<span class="token punctuation">;</span>
    utils<span class="token punctuation">.</span>m_timer_lst<span class="token punctuation">.</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"adjust timer once"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//删除定时器以及在epoll中移除sockfd</span>
<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">deal_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">,</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    timer<span class="token operator">-></span><span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        utils<span class="token punctuation">.</span>m_timer_lst<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"close fd %d"</span><span class="token punctuation">,</span>users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//有新连接进来</span>
<span class="token keyword">bool</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">deal_clinet_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">;</span>
    socklen_t client_addrlength<span class="token operator">=</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_LISTENTrigmode<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//LT</span>
        <span class="token comment">//* accept() -> 返回值是一个新的套接字描述符，它代表的是和客户端的新的连接，</span>
        <span class="token comment">//*             可以把它理解成是一个客户端的socket,这个socket包含的是客户端的ip和port信息 </span>
        <span class="token comment">//*             并且用client_address来接收客户端实际的地址</span>
        <span class="token keyword">int</span> connfd<span class="token operator">=</span><span class="token function">accept</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span><span class="token operator">&amp;</span>client_addrlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>connfd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s:errno is:%s"</span><span class="token punctuation">,</span><span class="token string">"accept error"</span><span class="token punctuation">,</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//如果到达最大可允许的fd数</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>http_conn<span class="token operator">::</span>m_user_count<span class="token operator">>=</span>MAX_FD<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            utils<span class="token punctuation">.</span><span class="token function">show_error</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span><span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//创建定时器</span>
        <span class="token function">timer</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token comment">//ET</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> connfd<span class="token operator">=</span><span class="token function">accept</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span><span class="token operator">&amp;</span>client_addrlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>connfd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s:errno is:%d"</span><span class="token punctuation">,</span><span class="token string">"accept error"</span><span class="token punctuation">,</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>http_conn<span class="token operator">::</span>m_user_count<span class="token operator">>=</span>MAX_FD<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                utils<span class="token punctuation">.</span><span class="token function">show_error</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span><span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">timer</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">bool</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">deal_with_signal</span><span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token operator">&amp;</span> timeout<span class="token punctuation">,</span><span class="token keyword">bool</span><span class="token operator">&amp;</span> stop_server<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> sig<span class="token punctuation">;</span>
    <span class="token keyword">char</span> signals<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    ret<span class="token operator">=</span><span class="token function">recv</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>signals<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>signals<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从pipefd读取数据，返回ret为读到数据长度</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>ret<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">switch</span><span class="token punctuation">(</span>signals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            
            <span class="token keyword">case</span> SIGALRM<span class="token operator">:</span>
                timeout<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> SIGTERM<span class="token operator">:</span>
                stop_server<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token comment">//switch</span>
        <span class="token punctuation">&#125;</span><span class="token comment">//for</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">deal_with_thread</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    util_timer<span class="token operator">*</span> timer<span class="token operator">=</span>users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>

    <span class="token comment">//reactor模式</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_actormodel<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
            <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//若监测到读事件，将该事件放入请求队列</span>
        m_pool<span class="token operator">-></span><span class="token function">append</span><span class="token punctuation">(</span>users<span class="token operator">+</span>sockfd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token comment">//while</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//proactor</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"deal with the client(%s)"</span><span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//若监测到读事件，将该事件放入请求队列</span>
            m_pool<span class="token operator">-></span><span class="token function">append_p</span><span class="token punctuation">(</span>users<span class="token operator">+</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
                <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
            <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">deal_with_write</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>
    <span class="token comment">//reactor</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> m_actormodel<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        m_pool<span class="token operator">-></span><span class="token function">append</span><span class="token punctuation">(</span>users <span class="token operator">+</span> sockfd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">//proactor</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"send data to the client(%s)"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">bool</span> timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> stop_server <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_server<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"epoll failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>

            <span class="token comment">//处理新到的客户连接</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> m_listenfd<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token function">deal_clinet_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> flag<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> <span class="token punctuation">(</span>EPOLLRDHUP <span class="token operator">|</span> EPOLLHUP <span class="token operator">|</span> EPOLLERR<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token comment">//服务器端关闭连接，移除对应的定时器</span>
                util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>
                <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//处理信号</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">==</span> m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token function">deal_with_signal</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> stop_server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> flag<span class="token punctuation">)</span>
                    <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"dealclientdata failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//处理客户连接上接收到的数据</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token function">deal_with_thread</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token function">deal_with_write</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            utils<span class="token punctuation">.</span><span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"timer tick"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h2 id="日志类"><a href="#日志类" class="headerlink" title="日志类"></a>日志类</h2><p>日志里面依赖一个容器，这个容器是循环数组实现的阻塞队列，最后在输出时则会判断是否异步操作（通过变量<code>m_is_async</code>来记录），如果是异步操作，则将日志体打入阻塞队列中，由一个线程异步输出日志；若不是异步则直接输出<code>fputs()</code>，阻塞队列采用FIFO原则；有条件变量，有锁用到</p>
<ol>
<li>如果设置了<code>max_queue_size</code>，即<code>max_queue_size&gt;0</code>则为异步，循环数组作为缓冲区队列，通过<code>push</code>存放日志消息体（实际类型为<code>string</code>）</li>
<li>阻塞队列的<code>pop</code>是出队，并返回最前面的消息体，若队列为空，则条件变量会进行阻塞等待唤醒</li>
<li>有个专门的异步写日志方法==&gt;<code>void* async_write_log()</code>；这个方法实现在 log.h 头文件中，它不断循环并pop出阻塞队列，提取一个string类型的消息体并打印输出，直到阻塞队列为空</li>
</ol>
<p>代码如下：</p>
<h3 id="log-h"><a href="#log-h" class="headerlink" title="log.h"></a>log.h</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/**
 * log.h头文件
 *
 * !同步/异步日志系统头文件
===============

同步/异步日志系统主要涉及了两个模块，一个是日志模块，一个是阻塞队列模块,
其中加入阻塞队列模块主要是解决异步写入日志做准备.
阻塞队列见：block_queue.h

> * 自定义阻塞队列
> * 单例模式创建日志
> * 同步日志
> * 异步日志
> * 实现按天、超行分类
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LOG_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOG_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../log/block_queue.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">Log</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">/**获取单例
     * 
     * 由于C++11及以后的版本中要求编译器保证内部静态变量的线程安全性
     * 故这里使用的局部变量懒汉模式是线程安全的，并且不用加锁
     */</span>
    <span class="token keyword">static</span> Log<span class="token operator">*</span> <span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">static</span> Log instance<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>instance<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//异步写日志公有方法，调用私有方法async_write_log</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">flush_log_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">async_write_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//可选择的参数有日志文件、日志缓冲区大小、最大行数以及日志最长日志条队列</span>
    <span class="token keyword">bool</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file_name<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">,</span> <span class="token keyword">int</span> log_buf_size <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">,</span> <span class="token keyword">int</span> split_lines <span class="token operator">=</span> <span class="token number">5000000</span><span class="token punctuation">,</span> <span class="token keyword">int</span> max_queue_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//将输出内容按照标准格式整理</span>
    <span class="token keyword">void</span> <span class="token function">write_log</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//强制刷新缓冲区</span>
    <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//异步写日志方法</span>
    <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">async_write_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        std<span class="token operator">::</span>string single_log<span class="token punctuation">;</span>
        <span class="token comment">//从阻塞队列中取出一个日志string，写入文件</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>m_log_queue<span class="token operator">-></span><span class="token function">pop</span><span class="token punctuation">(</span>single_log<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fputs</span><span class="token punctuation">(</span>single_log<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">char</span> dir_name<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//路径名</span>
    <span class="token keyword">char</span> log_name<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//log文件名</span>
    <span class="token keyword">int</span> m_split_lines<span class="token punctuation">;</span><span class="token comment">//日志最大行数</span>
    <span class="token keyword">int</span> m_log_buf_size<span class="token punctuation">;</span><span class="token comment">//日志缓冲区大小</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> m_count<span class="token punctuation">;</span><span class="token comment">//日志行数记录</span>
    <span class="token keyword">int</span> m_today<span class="token punctuation">;</span><span class="token comment">//由于日志是按天分类的，这个就记录当前时间是哪一天</span>
    FILE <span class="token operator">*</span>m_fp<span class="token punctuation">;</span><span class="token comment">//打开log文件的文件指针</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>m_buf<span class="token punctuation">;</span><span class="token comment">//当前指向log内容的字符指针，即要输出的内容</span>
    block_queue<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">></span> <span class="token operator">*</span>m_log_queue<span class="token punctuation">;</span><span class="token comment">//阻塞队列</span>
    <span class="token keyword">bool</span> m_is_async<span class="token punctuation">;</span><span class="token comment">//记录是否同步标志</span>
    locker m_mutex<span class="token punctuation">;</span><span class="token comment">//同步类</span>
    <span class="token keyword">int</span> m_close_log<span class="token punctuation">;</span> <span class="token comment">//是否关闭日志</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 

<span class="token comment">//调试信息相关</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_DEBUG</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_INFO</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_WARN</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_ERROR</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//LOG_H</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="log-cpp"><a href="#log-cpp" class="headerlink" title="log.cpp"></a>log.cpp</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//log.cpp</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ctime></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdarg></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../log/log.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>

<span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_is_async<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">Log</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_fp<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//异步需要设置阻塞队列的长度，同步不需要</span>
<span class="token keyword">bool</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file_name<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">,</span> <span class="token keyword">int</span> log_buf_size <span class="token punctuation">,</span> <span class="token keyword">int</span> split_lines <span class="token punctuation">,</span> <span class="token keyword">int</span> max_queue_size <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//如果设置了max_queue_size，则设为异步</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>max_queue_size<span class="token operator">>=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//设置写入方式flag</span>
        m_is_async<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token comment">//创建并设置阻塞队列</span>
        m_log_queue <span class="token operator">=</span> <span class="token keyword">new</span> block_queue<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">></span><span class="token punctuation">(</span>max_queue_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        pthread_t tid<span class="token punctuation">;</span>

        <span class="token comment">//flush_log_thread为回调函数，表示创建线程异步写日志</span>
        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>flush_log_thread<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//输出内容长度</span>
    m_close_log<span class="token operator">=</span>close_log<span class="token punctuation">;</span>
    m_log_buf_size<span class="token operator">=</span>log_buf_size<span class="token punctuation">;</span>
    m_buf<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>m_log_buf_size<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>m_buf<span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">,</span>m_log_buf_size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化缓冲区</span>
    m_split_lines<span class="token operator">=</span>split_lines<span class="token punctuation">;</span><span class="token comment">//日志的最大行数</span>

    <span class="token comment">//初始化时间相关变量</span>
    time_t t<span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span><span class="token operator">*</span> sys_tm<span class="token operator">=</span><span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span> my_tm<span class="token operator">=</span><span class="token operator">*</span>sys_tm<span class="token punctuation">;</span>

    <span class="token comment">//从后往前找第一个‘/‘的位置</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> p<span class="token operator">=</span><span class="token function">strrchr</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//该函数返回 str 中最后一次出现字符 c 的位置。如果未找到该值，则函数返回一个空指针。</span>
    <span class="token keyword">char</span> log_full_name<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    
    <span class="token comment">//相当于自定义日志名</span>
    <span class="token comment">//若输入的文件名没有‘/’，则直接将事件+文件名作为日志名</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//* %02d中的0为填空元素，即如果不满2个字符则用'0'填上剩余的</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>log_full_name<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token string">"%d_%02d_%02d_%s"</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//? 将‘/’的位置向后移动一个位置，然后复制到logname中</span>
        <span class="token comment">//? p-file_name+1时文件所在路径文件夹的长度</span>
        <span class="token comment">//* dir_name相当于‘./’</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>log_name<span class="token punctuation">,</span> p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>dir_name<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> p <span class="token operator">-</span> file_name <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">snprintf</span><span class="token punctuation">(</span>log_full_name<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token string">"%s%d_%02d_%02d_%s"</span><span class="token punctuation">,</span> dir_name<span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">,</span> log_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    

    <span class="token keyword">this</span><span class="token operator">-></span>m_today<span class="token operator">=</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">;</span>

    <span class="token comment">//*打开文件，以附加的方式打开只写文件。若文件不存在，则会创建该文件；如果文件存在，则写入的数据会被加到文件尾后，即文件原先的内容会被保留（EOF 符保留）</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span>log_full_name<span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * 写入日志函数：
 * 日志写入前会判断当前day是否为创建日志的时间，行数是否超过最大行限制
 *      *若为创建日志时间，写入日志，否则按当前时间创建新log，更新创建时间和行数
 *      *若行数超过最大行限制，在当前日志的末尾加count/max_lines为后缀创建新的log
 */</span>
<span class="token keyword">void</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> now<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取当天是几号 </span>
    time_t t<span class="token operator">=</span>now<span class="token punctuation">.</span>tv_sec<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span><span class="token operator">*</span> sys_tm<span class="token operator">=</span><span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span> my_tm<span class="token operator">=</span><span class="token operator">*</span>sys_tm<span class="token punctuation">;</span>
    <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    

    <span class="token comment">/**
     * 日志分级处理：
     *      *Debug，调试代码时输出
     *      *Warn，调试时发出警告
     *      *Info，报告系统当前的状态，当前执行的流程或接受到的信息等
     *      *Error和Fatal，输出系统的错误信息
     */</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[debug]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[info]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[warn]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[error]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[info]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">//写一个log，对m_count++，m_split_lines最大行数</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//更新现有行数</span>
    
    <span class="token comment">//日志不是今天或写入的行数时最大行的倍数</span>
    <span class="token comment">//m_split_lines 是最大行数</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_today<span class="token operator">!=</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token operator">||</span><span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">%</span><span class="token keyword">this</span><span class="token operator">-></span>m_split_lines<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span> new_log<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> tail<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        
        <span class="token comment">//格式化日志名中的部分</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>tail<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"%d_%02d_%02d_"</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_year<span class="token operator">+</span><span class="token number">1900</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_mon<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果时间不是今天，则创建当天的日志，并更新m_today和m_count</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>m_today<span class="token operator">!=</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token function">snprintf</span><span class="token punctuation">(</span>new_log<span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token string">"%s%s%s"</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>dir_name<span class="token punctuation">,</span>tail<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>log_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>m_today<span class="token operator">=</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//超过了最大行，在之前的日志名基础上加上后缀count/max_lines</span>
            <span class="token function">snprintf</span><span class="token punctuation">(</span>new_log<span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token string">"%s%s%s.%lld"</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>dir_name<span class="token punctuation">,</span>tail<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>log_name<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">/</span><span class="token keyword">this</span><span class="token operator">-></span>m_split_lines<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span>new_log<span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token comment">//end if</span>
    
    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//VA_LIST 是在C语言中解决变参问题的一组宏，所在头文件：#include &lt;stdarg.h>，用于获取不确定个数的参数。</span>
    va_list valst<span class="token punctuation">;</span>
    <span class="token comment">//将传入的format参数赋值给alst，便于格式化输出</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>valst<span class="token punctuation">,</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    std<span class="token operator">::</span>string log_str<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//写入内容格式：时间+内容</span>
    <span class="token comment">//时间格式化，snprintf()成功返回写字符的总数，其中不包括结尾的null字符</span>
    <span class="token keyword">int</span> n<span class="token operator">=</span><span class="token function">snprintf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token string">"%d-%02d-%02d %02d:%02d:%02d.%06ld %s "</span><span class="token punctuation">,</span>
                    my_tm<span class="token punctuation">.</span>tm_year<span class="token operator">+</span><span class="token number">1900</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_mon<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">,</span>
                    my_tm<span class="token punctuation">.</span>tm_hour<span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_min<span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_sec<span class="token punctuation">,</span>now<span class="token punctuation">.</span>tv_usec<span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//内容格式化，用于字符串打印数据、数据格式用户自定义，返回写入到字符数组中的字符个数（不包含终止符）</span>
    <span class="token keyword">int</span> m<span class="token operator">=</span><span class="token function">vsnprintf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token operator">+</span>n<span class="token punctuation">,</span>m_log_buf_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>format<span class="token punctuation">,</span>valst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token punctuation">[</span>n<span class="token operator">+</span>m<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\n'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token punctuation">[</span>n<span class="token operator">+</span>m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>

    log_str<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//* 同步异步检测</span>
    <span class="token comment">//如果m_is_async为true表示为异步，否则默认为同步</span>
    <span class="token comment">//若为异步，则将日志信息加入到阻塞队列，同步则加锁向文件中写</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_is_async <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-></span>m_log_queue<span class="token operator">-></span><span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//异步且队列不为空</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_log_queue<span class="token operator">-></span><span class="token function">push</span><span class="token punctuation">(</span>log_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fputs</span><span class="token punctuation">(</span>log_str<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">va_end</span><span class="token punctuation">(</span>valst<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="block-queue-h"><a href="#block-queue-h" class="headerlink" title="block_queue.h"></a>block_queue.h</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*************************************************************
*循环数组实现的阻塞队列，m_back = (m_back + 1) % m_max_size;  
*线程安全，每个操作前都要先加互斥锁，操作完后，再解锁
**************************************************************/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">BLOCK_QUEUE_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BLOCK_QUEUE_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../lock/locker.h"</span></span>

<span class="token comment">/**用循环数组实现的阻塞队列封装类 */</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">block_queue</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">block_queue</span><span class="token punctuation">(</span><span class="token keyword">int</span> max_size<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>max_size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//处理异常值</span>
			<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"阻塞队列初始大小参数小于等于0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		m_array <span class="token operator">=</span> <span class="token keyword">new</span> T<span class="token punctuation">[</span>max_size<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//动态分配数组</span>

		<span class="token comment">//私有属性初始化</span>
		m_max_size <span class="token operator">=</span> max_size<span class="token punctuation">;</span>
		m_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		m_front <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		m_back <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//?清除队内元素</span>
	<span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上锁</span>

		m_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		m_front <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		m_back <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解锁</span>
	<span class="token punctuation">&#125;</span>

	<span class="token operator">~</span><span class="token function">block_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//销毁数组</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>m_array<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
			<span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m_array<span class="token punctuation">;</span>

		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//判断队列是否满了</span>
	<span class="token keyword">bool</span> <span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">>=</span><span class="token keyword">this</span><span class="token operator">-></span>m_max_size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//判断队列是否为空</span>
	<span class="token keyword">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/**获取队列内的队首元素：
	 * 接受一个引用参数value
	 * 如果获取队首元素成功，则返回true，并且value会被修改为队首元素
	 * 否则返回false
	 */</span>
	<span class="token keyword">bool</span> <span class="token function">front</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//队列为空，false</span>
			m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		value <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_front<span class="token punctuation">]</span><span class="token punctuation">;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/**获取队列内的队尾元素：
	 * 接受一个引用参数value
	 * 如果获取队尾元素成功，则返回true，并且value会被修改为队尾元素
	 * 否则返回false
	 */</span>
	<span class="token keyword">bool</span> <span class="token function">back</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		value <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_back<span class="token punctuation">]</span><span class="token punctuation">;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//返回队列现有元素个数</span>
	<span class="token keyword">int</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		temp <span class="token operator">=</span> m_size<span class="token punctuation">;</span>

		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> temp<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">int</span> <span class="token function">max_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		temp <span class="token operator">=</span> m_max_size<span class="token punctuation">;</span>

		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> temp<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/**往队列添加元素，需要将所有使用队列的线程先唤醒
	 * 当有元素push进队列时，相当于生产者生产了一个元素
	 * 若当前没有线程等待条件变量，则唤醒无意义
	 */</span>
	<span class="token keyword">bool</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">const</span> T<span class="token operator">&amp;</span> item<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//?作用还是有些不懂</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">>=</span>m_max_size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			m_cond<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		m_back <span class="token operator">=</span> <span class="token punctuation">(</span>m_back <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> m_max_size<span class="token punctuation">;</span><span class="token comment">//队尾元素往后移动</span>
		m_array<span class="token punctuation">[</span>m_back<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>

		m_size<span class="token operator">++</span><span class="token punctuation">;</span>

		m_cond<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//pop时，如果当前队列没有元素，则进入等待条件变量</span>
    <span class="token comment">//同时遵循队列的FIFO原则，出来的是队头元素，并会把该元素赋值给引用参数item</span>
	<span class="token keyword">bool</span> <span class="token function">pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> item<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>m_size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//队列元素为空</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_cond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>m_mutex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
				m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>

		m_front <span class="token operator">=</span> <span class="token punctuation">(</span>m_front <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> m_max_size<span class="token punctuation">;</span>
		item <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_front<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token operator">--</span>m_size<span class="token punctuation">;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//重载pop，增加了超时处理</span>
	<span class="token comment">//第二个参数输入最长等待毫秒</span>
	<span class="token keyword">bool</span> <span class="token function">pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> item<span class="token punctuation">,</span><span class="token keyword">int</span> ms_timeout<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">struct</span> <span class="token class-name">timespec</span> t <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">timeval</span> now <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			t<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> now<span class="token punctuation">.</span>tv_sec <span class="token operator">+</span> ms_timeout <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span><span class="token comment">//秒</span>
			t<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> <span class="token punctuation">(</span>ms_timeout <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span><span class="token comment">//微秒</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_cond<span class="token punctuation">.</span><span class="token function">timewait</span><span class="token punctuation">(</span>m_mutex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
				m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		m_front <span class="token operator">=</span> <span class="token punctuation">(</span>m_front <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> m_max_size<span class="token punctuation">;</span>
		item <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_front<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token operator">--</span>m_size<span class="token punctuation">;</span>
		
		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	locker m_mutex<span class="token punctuation">;</span><span class="token comment">//互斥锁</span>
	cond m_cond<span class="token punctuation">;</span><span class="token comment">//条件变量</span>

	T <span class="token operator">*</span>m_array<span class="token punctuation">;</span><span class="token comment">//队列</span>
	<span class="token keyword">int</span> m_size<span class="token punctuation">;</span><span class="token comment">//当前队列元素个数</span>
	<span class="token keyword">int</span> m_max_size<span class="token punctuation">;</span><span class="token comment">//队列最大容量</span>
	<span class="token keyword">int</span> m_front<span class="token punctuation">;</span><span class="token comment">//队头元素</span>
	<span class="token keyword">int</span> m_back<span class="token punctuation">;</span><span class="token comment">//队尾元素</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//BLOCK_QUEUE_H</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h2 id="数据库连接池"><a href="#数据库连接池" class="headerlink" title="数据库连接池"></a>数据库连接池</h2><p>数据库连接池采用了单例模式，整个连接池也是遵循FIFO原则</p>
<ol>
<li>数据库连接池可以在程序初始化的时候，集中创建多个数据库连接<code>MYSQL*</code>，并放入连接池当中集中管理</li>
<li>数据库连接池的操作优化了一般访问数据库的操作（频繁创建连接==&gt;操作数据库==&gt;断开连接）</li>
<li>连接池的容器类为：标准库中的链表<code>list</code>，其声明为<code>list&lt;MYSQL*&gt; connList;</code></li>
<li>有个信号量<code>sem reserve</code>在连接池初始化完毕时会将自身的值设置为最大连接数：this-&gt;reserve=sem(this-&gt;m_FreeConn);</li>
<li>初始化时，会创建自定义数目的<strong>MYSQL*</strong>在链表中，并逐个MYSQL*进行初始化连接，即：<code>con=mysql_init(con);</code>和<code>con=mysql_real_connect(con,url.c_str(),User.c_str(),PassWord.c_str(),DatabaseName.c_str(),Port,NULL,0);</code></li>
<li>取出连接操作<code>MYSQL* GetConnection(); //获取数据库连接</code>：实际是对链表进行<code>pop_front()</code>，同时该函数会返回一个MYSQL*；若连接池无空闲连接，则会因为信号量代码reserve.wait()而等待阻塞，等待有空闲连接时再唤醒</li>
<li>释放之前取出的连接<code>bool ReleaseConnection(MYSQL* con); //释放连接</code>：会要求<strong>把前面获取连接得到的MYSQ*作为参数传入</strong>该函数中，并进行再次push添加到链表尾部（连接重复利用）</li>
<li>亮点之一：运用了RAII类机制，在构造RAII类对象时会自动获取数据库连接，在析构RAII类对象时会自动将连接归还，代码如下👇</li>
</ol>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">connectionRAII<span class="token operator">::</span><span class="token function">connectionRAII</span><span class="token punctuation">(</span>MYSQL<span class="token operator">*</span><span class="token operator">*</span> SQL<span class="token punctuation">,</span>connection_pool<span class="token operator">*</span> connPool<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>SQL<span class="token operator">=</span>connPool<span class="token operator">-></span><span class="token function">GetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token operator">-></span>conRAII<span class="token operator">=</span><span class="token operator">*</span>SQL<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>poolRAII<span class="token operator">=</span>connPool<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">connectionRAII</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">connectionRAII</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>poolRAII<span class="token operator">-></span><span class="token function">ReleaseConnection</span><span class="token punctuation">(</span>conRAII<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>详细代码如下：</p>
<h3 id="sql-connection-pool-h"><a href="#sql-connection-pool-h" class="headerlink" title="sql_connection_pool.h"></a>sql_connection_pool.h</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_CONNECTION_POOL_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_CONNECTION_POOL_</span></span>

<span class="token comment">//*该头文件是数据库连接池的头文件</span>
<span class="token comment">//!头文件完成但还未检查</span>

<span class="token comment">//?👇数据库连接池是什么？👇</span>
<span class="token comment">//?数据库连接池可以在程序初始化的时候，集中创建多个数据库连接，并把他们集中管理，供程序使用</span>
<span class="token comment">//?优化了一般访问数据库的（频繁创建连接--操作数据库--断开连接）模式</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mysql/mysql.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;error.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../lock/locker.h"</span> <span class="token comment">//互斥锁</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../log/log.h"</span> <span class="token comment">//日志</span></span>

<span class="token keyword">using</span> std<span class="token operator">::</span>string<span class="token punctuation">;</span>

<span class="token comment">//数据库连接池</span>
<span class="token keyword">class</span> <span class="token class-name">connection_pool</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>string url<span class="token punctuation">,</span>string User<span class="token punctuation">,</span>string PassWord<span class="token punctuation">,</span>string DataBaseName<span class="token punctuation">,</span><span class="token keyword">int</span> Port<span class="token punctuation">,</span><span class="token keyword">int</span> MaxConn<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">)</span><span class="token punctuation">;</span>
    MYSQL<span class="token operator">*</span> <span class="token function">GetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取数据库连接</span>
    <span class="token keyword">bool</span> <span class="token function">ReleaseConnection</span><span class="token punctuation">(</span>MYSQL<span class="token operator">*</span> con<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//释放连接</span>
    <span class="token keyword">int</span> <span class="token function">GetFreeConn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取连接</span>
    <span class="token keyword">void</span> <span class="token function">DestroyPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//销毁所有连接</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">//单例模式</span>
    <span class="token keyword">static</span> connection_pool<span class="token operator">*</span> <span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> m_MaxConn<span class="token punctuation">;</span> <span class="token comment">//最大连接数</span>
    <span class="token keyword">int</span> m_CurConn<span class="token punctuation">;</span> <span class="token comment">//当前已使用的连接数</span>
    <span class="token keyword">int</span> m_FreeConn<span class="token punctuation">;</span> <span class="token comment">//当前空闲的连接数</span>
    locker lock<span class="token punctuation">;</span>
    std<span class="token operator">::</span>list<span class="token operator">&lt;</span>MYSQL<span class="token operator">*</span><span class="token operator">></span> connList<span class="token punctuation">;</span>
    sem reserve<span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    string m_url<span class="token punctuation">;</span> <span class="token comment">//主机地址</span>
    string m_Port<span class="token punctuation">;</span> <span class="token comment">//数据库端口号</span>
    string m_User<span class="token punctuation">;</span> <span class="token comment">//登录数据库的用户名</span>
    string m_PassWord<span class="token punctuation">;</span> <span class="token comment">//登录数据库的密码</span>
    string m_DatabaseName<span class="token punctuation">;</span> <span class="token comment">//使用的数据库名</span>
    <span class="token keyword">int</span> m_close_log<span class="token punctuation">;</span> <span class="token comment">//日志开关</span>
    
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">//class connection_pool</span>

<span class="token comment">//*RAII机制类</span>
<span class="token keyword">class</span> <span class="token class-name">connectionRAII</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">connectionRAII</span><span class="token punctuation">(</span>MYSQL<span class="token operator">*</span><span class="token operator">*</span> con<span class="token punctuation">,</span>connection_pool<span class="token operator">*</span> connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">connectionRAII</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    MYSQL<span class="token operator">*</span> conRAII<span class="token punctuation">;</span>
    connection_pool<span class="token operator">*</span> poolRAII<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//_CONNECTION_POOL_</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="sql-connection-pool-cpp"><a href="#sql-connection-pool-cpp" class="headerlink" title="sql_connection_pool.cpp"></a>sql_connection_pool.cpp</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mysql/mysql.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../CGImysql/sql_connection_pool.h"</span></span>

<span class="token keyword">using</span> std<span class="token operator">::</span>string<span class="token punctuation">;</span>


connection_pool<span class="token operator">::</span><span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_CurConn<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">connection_pool</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">DestroyPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

connection_pool<span class="token operator">*</span> connection_pool<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//* 单例模式</span>
    <span class="token keyword">static</span> connection_pool connPool<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>connPool<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//构造初始化</span>
<span class="token keyword">void</span> connection_pool<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>string url<span class="token punctuation">,</span>string User<span class="token punctuation">,</span>string PassWord<span class="token punctuation">,</span>string DatabaseName<span class="token punctuation">,</span><span class="token keyword">int</span> Port<span class="token punctuation">,</span><span class="token keyword">int</span> MaxConn<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//初始化信息</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_url<span class="token operator">=</span>url<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_Port<span class="token operator">=</span>Port<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_User<span class="token operator">=</span>User<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_PassWord<span class="token operator">=</span>PassWord<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_DatabaseName<span class="token operator">=</span>DatabaseName<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_close_log<span class="token operator">=</span>close_log<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_MaxConn<span class="token operator">=</span>MaxConn<span class="token punctuation">;</span>

    
    <span class="token comment">//创建m_MaxConn条数据库连接</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>m_MaxConn<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        
        MYSQL<span class="token operator">*</span> con<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        con<span class="token operator">=</span><span class="token function">mysql_init</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span>con<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            std<span class="token operator">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"Error:"</span><span class="token operator">&lt;&lt;</span><span class="token function">mysql_error</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">'\n'</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        con<span class="token operator">=</span><span class="token function">mysql_real_connect</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span>url<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>User<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>PassWord<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>DatabaseName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>con<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            std<span class="token operator">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"Error:"</span><span class="token operator">&lt;&lt;</span><span class="token function">mysql_error</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">'\n'</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//更新连接池和空闲连接数</span>
        <span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">;</span>
        
    <span class="token punctuation">&#125;</span>

    
    <span class="token comment">//将信号量初始化为最大连接次数</span>
    <span class="token keyword">this</span><span class="token operator">-></span>reserve<span class="token operator">=</span><span class="token function">sem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token operator">-></span>m_MaxConn<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//获取空闲连接的数据库</span>
<span class="token comment">//* 当有请求时，从数据库连接池中返回一个可用的连接，更新和使用空闲连接数</span>
MYSQL<span class="token operator">*</span> connection_pool<span class="token operator">::</span><span class="token function">GetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    MYSQL<span class="token operator">*</span> con<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    

    <span class="token comment">//取出连接，信号量原子减1，为0则等待</span>
    reserve<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token operator">-></span>lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 上锁</span>
    con<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token operator">--</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">;</span>
    <span class="token operator">++</span><span class="token keyword">this</span><span class="token operator">-></span>m_CurConn<span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token operator">-></span>lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 开锁</span>
    <span class="token keyword">return</span> con<span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>

<span class="token comment">//释放当前使用的连接</span>
<span class="token keyword">bool</span> connection_pool<span class="token operator">::</span><span class="token function">ReleaseConnection</span><span class="token punctuation">(</span>MYSQL<span class="token operator">*</span> con<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>con<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">++</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">;</span>
    <span class="token operator">--</span><span class="token keyword">this</span><span class="token operator">-></span>m_CurConn<span class="token punctuation">;</span>

    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//释放连接原子加1</span>
    reserve<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//销毁数据库连接池</span>
<span class="token keyword">void</span> connection_pool<span class="token operator">::</span><span class="token function">DestroyPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//通过迭代器遍历，关闭数据库连接</span>
        std<span class="token operator">::</span>list<span class="token operator">&lt;</span>MYSQL<span class="token operator">*</span><span class="token operator">></span><span class="token operator">::</span>iterator it<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>it<span class="token operator">=</span>connList<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token operator">!=</span>connList<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>it<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            MYSQL<span class="token operator">*</span> con<span class="token operator">=</span><span class="token operator">*</span>it<span class="token punctuation">;</span>
            <span class="token function">mysql_close</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_CurConn<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>


        <span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
connectionRAII::connectionRAII(MYSQL** SQL,connection_pool* connPool)&#123;
    *SQL=connPool->GetConnection();
    
    this->conRAII=*SQL;
    this->poolRAII=connPool;
&#125;

connectionRAII::~connectionRAII()&#123;
    this->poolRAII->ReleaseConnection(conRAII);
&#125;
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><p>❗❗❗线程池中有存放线程的数组，数组中的线程是用来处理请求队列中的请求任务❗❗❗</p>
<ol>
<li><p>成员变量包含了：数据库连接池指针<code>connection_pool* m_connPool;</code>、描述线程池的数组<code>pthread_t* m_threads</code>、请求队列<code>std::list&lt;T*&gt; m_workqueue;（存放http_conn*）</code></p>
</li>
<li><p>初始化时，线程指针会构建数组==&gt;<code>m_threads=new pthread_t[m_thread_number];</code>，再进入for循环中逐个对数组成员用<code>pthread_create(pthread_t *tidp,const pthread_attr_t *attr,void *(*start_rtn)(void*),void *arg);</code>初始化，每个线程的运行函数都是<code>worker()</code>函数，传入参数<code>arg</code>为该线程池类对象指针<strong>this</strong></p>
</li>
<li><p>每个<code>pthread_create()</code>完毕后，又会将这个线程进行分离，即<code>pthread_detach()</code>，使得不用单独对工作线程进行回收</p>
</li>
<li><p>worker()函数内部则是将传入参数<code>void* arg</code>进行类型转换回<code>threadpool*</code>（线程池指针），接着调用指针的<code>run()</code>函数，所以<code>threadpool::run()</code>才是真正的<strong>执行任务函数</strong>👇</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//线程处理函数</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token comment">//将参数强制转换为线程池类，调用函数方法</span>
    threadpool<span class="token operator">*</span> pool<span class="token operator">=</span><span class="token punctuation">(</span>threadpool<span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
    pool<span class="token operator">-></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pool<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>run函数会判断<strong>actor模式</strong>，判断<strong>m_state</strong>以及判断**read_once()**，这几个都是在http_conn类里面，那么就可以推断出线程池的链表存放的数据是http_conn连接对象</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//run()</span>
<span class="token comment">//run执行任务</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">void</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-></span>m_stop<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//信号量等待</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_queuestat<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//被唤醒后先加上互斥锁</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_workqueue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//从请求队列中取出第一个任务</span>
        <span class="token comment">//将任务i从请求队列中删除</span>
        T<span class="token operator">*</span> request<span class="token operator">=</span>m_workqueue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_workqueue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>m_actor_model<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//判断actor模式，</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span>m_state<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//0为读，1为写</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                    connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token operator">-></span>mysql<span class="token punctuation">,</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    request<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                    request<span class="token operator">-></span>timer_flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                    request<span class="token operator">-></span>timer_flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token comment">//m_actor_model!=1</span>
            connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token operator">-></span>mysql<span class="token punctuation">,</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token comment">//actor_model</span>

    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<p>详细代码如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">THREADPOOL_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THREADPOOL_H</span></span>

<span class="token comment">//!该类是线程池类</span>
<span class="token comment">/**
 * !模板类的成员函数实现应该放在头文件中
 * !因为模板类本质上不是类，只有实例化之后才会编译生成.o文件
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;exception></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../lock/locker.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../CGImysql/sql_connection_pool.h"</span></span>

<span class="token comment">//!该线程池头文件已完成，但还没有检查</span>

<span class="token comment">//*线程池类</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">threadpool</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">/**
     * connPool是数据库连接池指针
     * max_requests是请求队列中最多允许的、等待处理的请求数量
     * thread_number是线程池中线程的数量
     */</span>
    <span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token keyword">int</span> actor_model<span class="token punctuation">,</span>connection_pool<span class="token operator">*</span> connPool<span class="token punctuation">,</span><span class="token keyword">int</span> thread_number<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token keyword">int</span> max_request<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//向请求队列中插入任务请求</span>
    <span class="token keyword">bool</span> <span class="token function">append_p</span><span class="token punctuation">(</span>T<span class="token operator">*</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">append</span><span class="token punctuation">(</span>T<span class="token operator">*</span> request<span class="token punctuation">,</span><span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">//工作线程运行函数</span>
    <span class="token comment">//它不断从工作队列中取出任务并执行</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token keyword">private</span><span class="token operator">:</span>

    <span class="token comment">//模型切换</span>
    <span class="token keyword">int</span> m_actor_model<span class="token punctuation">;</span>

    <span class="token comment">//线程池中的线程数</span>
    <span class="token keyword">int</span> m_thread_number<span class="token punctuation">;</span>

    <span class="token comment">//请求队列中允许的最大请求数</span>
    <span class="token keyword">int</span> m_max_requests<span class="token punctuation">;</span>

    <span class="token comment">//描述线程池的数组，大小为 m_thread_number</span>
    pthread_t<span class="token operator">*</span> m_threads<span class="token punctuation">;</span>

    <span class="token comment">//请求队列</span>
    std<span class="token operator">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">></span> m_workqueue<span class="token punctuation">;</span>

    <span class="token comment">//保护请求队列的互斥锁</span>
    locker m_queuelocker<span class="token punctuation">;</span>

    <span class="token comment">//是否有任务需要处理</span>
    sem m_queuestat<span class="token punctuation">;</span>

    <span class="token comment">//是否结束线程</span>
    <span class="token keyword">bool</span> m_stop<span class="token punctuation">;</span>

    <span class="token comment">//数据库连接池</span>
    connection_pool<span class="token operator">*</span> m_connPool<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token keyword">int</span> actor_model<span class="token punctuation">,</span>connection_pool<span class="token operator">*</span> connPool<span class="token punctuation">,</span><span class="token keyword">int</span> thread_number<span class="token punctuation">,</span><span class="token keyword">int</span> max_request<span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token function">m_thread_number</span><span class="token punctuation">(</span>thread_number<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_max_requests</span><span class="token punctuation">(</span>max_request<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_stop</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_connPool</span><span class="token punctuation">(</span>connPool<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_actor_model</span><span class="token punctuation">(</span>actor_model<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
    <span class="token comment">//传入参数异常处理</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>thread_number<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token operator">||</span>max_request<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//线程id初始化</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_threads<span class="token operator">=</span><span class="token keyword">new</span> pthread_t<span class="token punctuation">[</span>m_thread_number<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_threads<span class="token punctuation">)</span>

        <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>thread_number<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//循环创建线程，并将工作线程按照要求进行</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span>m_threads<span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>worker<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m_threads<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//将线程进行分离后，不用单独对工作线程进行回收</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">pthread_detach</span><span class="token punctuation">(</span>m_threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m_threads<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
threadpool<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">this</span><span class="token operator">-></span>m_threads<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//向请求队列中添加任务</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">bool</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">append_p</span><span class="token punctuation">(</span>T<span class="token operator">*</span> request<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//根据硬件，预先设置请求队列的最大值</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_workqueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span>m_max_requests<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//添加任务</span>
    m_workqueue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//信号量提醒有任务要处理</span>
    m_queuestat<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">bool</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">append</span><span class="token punctuation">(</span>T <span class="token operator">*</span>request<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_workqueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> m_max_requests<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    request<span class="token operator">-></span>m_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    m_workqueue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_queuestat<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//线程处理函数</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token comment">//将参数强制转换为线程池类，调用函数方法</span>
    threadpool<span class="token operator">*</span> pool<span class="token operator">=</span><span class="token punctuation">(</span>threadpool<span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
    pool<span class="token operator">-></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pool<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//run执行任务</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">void</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-></span>m_stop<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//信号量等待</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_queuestat<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//被唤醒后先加上互斥锁</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_workqueue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//从请求队列中取出第一个任务</span>
        <span class="token comment">//将任务i从请求队列中删除</span>
        T<span class="token operator">*</span> request<span class="token operator">=</span>m_workqueue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_workqueue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>m_actor_model<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span>m_state<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//读为0，写为1</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                    connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token operator">-></span>mysql<span class="token punctuation">,</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    request<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                    request<span class="token operator">-></span>timer_flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                    request<span class="token operator">-></span>timer_flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token comment">//m_actor_model!=1</span>
            connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token operator">-></span>mysql<span class="token punctuation">,</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token comment">//actor_model</span>


        <span class="token comment">/* 
        *上面是使用了RAII机制来实现下面代码，作用效果是一样的
        
        //从连接池中取出一个数据库连接
        request->mysql=m_connPool->GetConnection();

        //process(模板类中的方法，这里是http类)进行处理
        request->process();

        //将数据库连接放回连接池
        m_connPool->ReleaseConnection(request->mysql); 
        */</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//THREADPOOL_H</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h2><p>定时器<code>lst_timer.h</code>头文件中包含了四个东西，分别是：连接资源<code> struct client_data</code>、定时器容器类<code>sort_timer_lst</code>、定时器类<code>util_timer</code>以及工具类<code>Utils</code></p>
<p>定时器的调用代码在WebServer类的一些方法中，具体工作流程在网上看到了解释:point_down:</p>
<blockquote>
<p>（1） 首先使用socketpair创建管道–&gt;m_pipefd[2]<br>（2） 设置写端为非阻塞，是为了减少信号处理的时间，即使定时事件失效也没关系，并不严格。<br>（3） 设置读端为ET非阻塞，向epoll树上挂读管道事件。<br>（4） 执行信号函数addsig，把信号添加到信号集当中，并把信号默认处理方式改成sig_handler函数(函数内容是向管道写入信号值)<br>（5） 设置bool值timeout和stop_server，后面需要使用他们判断是否执行信号对应的处理逻辑。<br>（6） 开始alarm函数，设定时间。<br>（7） 监听文件描述符epoll_wait。<br>（8） 监听到以后读出信号。<br>（9） 执行处理逻辑，如果信号是SIGALRM，timeout=true;如果是SIGTERM（ctrl+c）stop_server=true;<br>（10） 在server.eventloop()（就是epoll树上监听到事件后的处理函数）中如果timeout==true,执行time_handler函数。<br>（11） time_handler函数(Util类中的)，首先执行tick()函数（定时器链表类中的），然后再次执行alarm()，相当于再次开始定时，一个alarm函数只能触发一次信号;<br>（12） tick()函数首先遍历定时器链表，找到到期的定时器（判断现在时间是否&gt;expire，expire是定时器节点类中设定的超时时间），就是每过一段时间检查是否超时。即利用alarm函数周期性地触发SIGALRM信号,该信号的信号处理函数利用管道通知主循环执行定时器链表上的定时任务.<br>（13） 如果超时了就执行cb_func函数，删除epoll树上对应的通信fd，关闭通信fd,http_conn连接数-1；<br>（14） 项目中TIMESLOT值为5，expire初始值设置为 现有时间+3*TIMESLOT，每有读写事件发生，该通信fd对应的expire就加3个TIMESLOT，同时调整定时器链表类中该节点的位置，通过util类对象使用adjust_timer函数。</p>
</blockquote>
<p>管道就是WebServer里面的m_pipefd[2]，写端就是m_pipefd[1]，读端为m_pipefd[0]</p>
<p>其实就是在webserver的循环中，如果收到了来自m_pipefd[0]的文件描述符活跃信息，就是代表收到了信号，此时就要去处理该信号，是连接资源超时了还是收到了服务器的关闭指令，再分别进行操作</p>
<p>这里如果收到资源超时信号，其实还是要循环定时器链表，找到超时的连接删掉，有点消耗性能</p>
<h3 id="连接资源—结构体client-date"><a href="#连接资源—结构体client-date" class="headerlink" title="连接资源—结构体client_date"></a>连接资源—结构体client_date</h3><p>连接资源包含了客户端socket地址、socket描述符然后附带一个定时器对象</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//连接资源</span>
<span class="token keyword">struct</span> <span class="token class-name">client_data</span><span class="token punctuation">&#123;</span>
    
    <span class="token comment">//客户端socket地址</span>
    sockaddr_in addreess<span class="token punctuation">;</span>

    <span class="token comment">//socket文件描述符</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>

    <span class="token comment">//定时器</span>
    util_timer<span class="token operator">*</span> timer<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="定时器类—util-timer"><a href="#定时器类—util-timer" class="headerlink" title="定时器类—util_timer"></a>定时器类—util_timer</h3><p>虽然用的是类，但其实更像一个结构体，一个定时器包含了连接资源指针<code>client_data*</code>、前一个定时器<code>util_timer* prev</code>、后一个定时器<code>util_timer* next</code>、超时时间<code>time_t expire</code>和一个回调函数<code>void (*cb_func)(client_data*);</code></p>
<p>回调函数主要作用就是将已经到达超时时间的连接资源断开连接，并从epoll中删除，回调函数的代码如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">cb_func</span><span class="token punctuation">(</span>client_data<span class="token operator">*</span> user_data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>Utils<span class="token operator">::</span>u_epollfd<span class="token punctuation">,</span>EPOLL_CTL_DEL<span class="token punctuation">,</span>
              user_data<span class="token operator">-></span>sockfd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从epfd引用的epoll实例中删除（注销）目标文件描述符fd</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>user_data<span class="token operator">-></span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    http_conn<span class="token operator">::</span>m_user_count<span class="token operator">--</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="定时器容器类—sort-timer-lst"><a href="#定时器容器类—sort-timer-lst" class="headerlink" title="定时器容器类—sort_timer_lst"></a>定时器容器类—sort_timer_lst</h3><p>其实说是定时器容器类，但本质上定时器类本身就包含了指向上个元素和下个元素的指针，因此定时器容器类只是提供了方法来方便构建删除定时器等维护操作</p>
<p>除了添加、删除、调整定时器的操作以外，还有一个定时任务处理函数<code>tick()</code>，这个函数作用是遍历定时器链表，找到超时的定时器，调用回调函数从内核事件表删除事件，关闭文件描述符，释放连接资源</p>
<p>随后再将该定时器从链表容器中删除，重置头结点，而tick是由Utils::timer_handler()来调用的</p>
<p>代码如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">
<span class="token comment">//析构函数</span>
<span class="token class-name">sort_timer_lst</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    util_timer<span class="token operator">*</span> tmp<span class="token operator">=</span>head<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        head<span class="token operator">=</span>tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>
        <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>
        tmp<span class="token operator">=</span>head<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//添加定时器，内部调用私有成员函数add_timer</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token operator">::</span><span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>head<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        head<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span>tail<span class="token operator">=</span>timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//如果新的定时器超时间小于当前头部结点</span>
    <span class="token comment">//直接将当前定时器节点作为头部结点</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">-></span>expire<span class="token operator">&lt;</span>head<span class="token operator">-></span>expire<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        timer<span class="token operator">-></span>next<span class="token operator">=</span>head<span class="token punctuation">;</span>
        head<span class="token operator">-></span>prev<span class="token operator">=</span>timer<span class="token punctuation">;</span>
        head<span class="token operator">=</span>timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//否则调用私有成员函数，调整内部结点</span>
    <span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//私有成员函数的add_timer，用于一般情况添加调整结点</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token operator">::</span><span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">,</span>util_timer<span class="token operator">*</span> lst_head<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    util_timer<span class="token operator">*</span> prev<span class="token operator">=</span>lst_head<span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span> tmp<span class="token operator">=</span>prev<span class="token operator">-></span>next<span class="token punctuation">;</span>

    <span class="token comment">//遍历当前结点之后的链表，按照超时间找到目标定时器对应的位置，常规双向链表的插入</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>tmp<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">-></span>expire<span class="token operator">&lt;</span>tmp<span class="token operator">-></span>expire<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            prev<span class="token operator">-></span>next<span class="token operator">=</span>timer<span class="token punctuation">;</span>
            timer<span class="token operator">-></span>next<span class="token operator">=</span>tmp<span class="token punctuation">;</span>
            tmp<span class="token operator">-></span>prev<span class="token operator">=</span>timer<span class="token punctuation">;</span>
            timer<span class="token operator">-></span>prev<span class="token operator">=</span>prev<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        prev<span class="token operator">=</span>tmp<span class="token punctuation">;</span>
        tmp<span class="token operator">=</span>tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//遍历完发现，目标定时器需要放到结尾结点处</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>tmp<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        prev<span class="token operator">-></span>next<span class="token operator">=</span>timer<span class="token punctuation">;</span>
        timer<span class="token operator">-></span>prev<span class="token operator">=</span>prev<span class="token punctuation">;</span>
        timer<span class="token operator">-></span>next<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-></span>tail<span class="token operator">=</span>timer<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> sort_timer_lst<span class="token operator">::</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    util_timer<span class="token operator">*</span> tmp<span class="token operator">=</span>timer<span class="token operator">-></span>next<span class="token punctuation">;</span>

    <span class="token comment">//被调整的定时器在链表尾部</span>
    <span class="token comment">//定时器超时值仍然小于下一个定时器的超时值，不用作出调整</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>tmp<span class="token operator">||</span>timer<span class="token operator">-></span>expire<span class="token operator">&lt;</span>tmp<span class="token operator">-></span>expire<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    
    <span class="token comment">//被调整定时器时链表头部节点，将定时器取出，重新插入</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">==</span><span class="token keyword">this</span><span class="token operator">-></span>head<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        head<span class="token operator">=</span>head<span class="token operator">-></span>next<span class="token punctuation">;</span>
        head<span class="token operator">-></span>prev<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        timer<span class="token operator">-></span>next<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//被调整的定时器在内部，将定时器取出，重新插入</span>
        timer<span class="token operator">-></span>prev<span class="token operator">-></span>next<span class="token operator">=</span>timer<span class="token operator">-></span>next<span class="token punctuation">;</span>
        timer<span class="token operator">-></span>next<span class="token operator">-></span>prev<span class="token operator">=</span>timer<span class="token operator">-></span>prev<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>timer<span class="token operator">-></span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>


<span class="token comment">//删除定时器</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token operator">::</span><span class="token function">del_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    
    <span class="token comment">//链表中只有一个定时器，删除的刚好是这个</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">==</span><span class="token keyword">this</span><span class="token operator">-></span>head<span class="token operator">&amp;&amp;</span>timer<span class="token operator">==</span><span class="token keyword">this</span><span class="token operator">-></span>tail<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>
        head<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        tail<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//被删除的定时器为结点</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">==</span><span class="token keyword">this</span><span class="token operator">-></span>head<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        head<span class="token operator">=</span>head<span class="token operator">-></span>next<span class="token punctuation">;</span>
        head<span class="token operator">-></span>prev<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//被删除的定时器为尾结点</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">==</span><span class="token keyword">this</span><span class="token operator">-></span>tail<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        tail<span class="token operator">=</span>tail<span class="token operator">-></span>prev<span class="token punctuation">;</span>
        tail<span class="token operator">-></span>next<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//被删除的链表内部，常规链表删除结点</span>
    timer<span class="token operator">-></span>prev<span class="token operator">-></span>next<span class="token operator">=</span>timer<span class="token operator">-></span>next<span class="token punctuation">;</span>
    timer<span class="token operator">-></span>next<span class="token operator">-></span>prev<span class="token operator">=</span>timer<span class="token operator">-></span>prev<span class="token punctuation">;</span>
    <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token comment">//定时任务处理函数</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token operator">::</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>head<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    
    <span class="token comment">//获取当前时间</span>
    time_t cur<span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span> tmp<span class="token operator">=</span>head<span class="token punctuation">;</span>

    <span class="token comment">//遍历定时器链表</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>tmp<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//链表容器为升序排列</span>
        <span class="token comment">//当前时间小于定时器的超时时间，后面定时器也没有到期</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cur<span class="token operator">&lt;</span>tmp<span class="token operator">-></span>expire<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        
        <span class="token comment">//当前定时器到期，则调用回调函数，执行定时事件</span>
        <span class="token comment">//*回调函数传入的参数类型为 (client_data*)</span>
        <span class="token function">cb_func</span><span class="token punctuation">(</span>tmp<span class="token operator">-></span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//将处理后的定时器从链表容器中删除，并重置头结点</span>
        <span class="token keyword">this</span><span class="token operator">-></span>head<span class="token operator">=</span>tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>head<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
            head<span class="token operator">-></span>prev<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>
        tmp<span class="token operator">=</span>head<span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span><span class="token comment">// end while</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="工具类Utils"><a href="#工具类Utils" class="headerlink" title="工具类Utils"></a>工具类Utils</h3><p>Utils是给外部使用的功能的类（具体也是在WebServer类中调用，利用管道通知主循环执行定时器链表上的定时任务），这个类可以用来对定时器进行设置</p>
<p>逻辑顺序，设置信号后，触发时调用信号处理函数，信号处理函数通过管道将sig发送到主循环<br>主循环通过管道接收sig，得知有定时器超时，再调用定时器处理任务函数timer_handler()处理，并且再此设定ALARM信号触发，形成循环</p>
<p>详细代码如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">

<span class="token keyword">int</span><span class="token operator">*</span> Utils<span class="token operator">::</span>u_pipefd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> Utils<span class="token operator">::</span>u_epollfd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>


<span class="token comment">//定时处理任务，重新定时以不断触发SIGALRM</span>
<span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token operator">::</span><span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_timer_lst<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alarm</span><span class="token punctuation">(</span>m_TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//m_TIMESLOT初始化</span>
<span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeslot<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_TIMESLOT<span class="token operator">=</span>timeslot<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * EPOLLIN - 当关联的文件可以执行 read ()操作时。
 * EPOLLOUT - 当关联的文件可以执行 write ()操作时。
 *? EPOLLRDHUP - 代表对端断开连接 ?不懂的事件
 * EPOLLET - 设置指定的文件描述符模式为边缘触发，默认的模式是水平触发。
 */</span>

<span class="token comment">//将内核事件表注册读事件，ET模式，选择开启EPOLLONESHOT，开启后同一时间只会有一个线程处理同一个socket</span>
<span class="token comment">//LT（level trigger水平模式）  ET（edge trigger边缘模式）</span>
<span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token operator">::</span><span class="token function">addfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span><span class="token keyword">bool</span> one_shot<span class="token punctuation">,</span><span class="token keyword">int</span> TRIGMode<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    epoll_event event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token operator">=</span>fd<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>TRIGMode<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
        event<span class="token punctuation">.</span>events<span class="token operator">=</span>EPOLLIN<span class="token operator">|</span>EPOLLET<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        event<span class="token punctuation">.</span>events<span class="token operator">=</span>EPOLLIN<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>one_shot<span class="token punctuation">)</span>
        event<span class="token punctuation">.</span>events<span class="token operator">|=</span>EPOLLONESHOT<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span>EPOLL_CTL_ADD<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">setnonblocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//对文件描述符设置非阻塞，返回fd原来的设置</span>
<span class="token keyword">int</span> <span class="token class-name">Utils</span><span class="token operator">::</span><span class="token function">setnonblocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> old_option<span class="token operator">=</span><span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取fd原来的设置</span>
    <span class="token keyword">int</span> new_option<span class="token operator">=</span>old_option<span class="token operator">|</span>O_NONBLOCK<span class="token punctuation">;</span><span class="token comment">//添加非阻塞设置</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>F_SETFL<span class="token punctuation">,</span>new_option<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//为fd应用新设置</span>
    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//信号处理函数</span>
<span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token operator">::</span><span class="token function">sig_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//为保证函数的可重入性，保留原来的errno</span>
    <span class="token comment">//可重入性表示中断后再次进入该函数，环境变量与之前相同，不会丢失数据</span>
    <span class="token keyword">int</span> save_errno<span class="token operator">=</span>errno<span class="token punctuation">;</span>
    <span class="token keyword">int</span> msg<span class="token operator">=</span>sig<span class="token punctuation">;</span>

    <span class="token comment">//将信号从管道写端写入，传输字符类型，而非整型</span>
    <span class="token function">send</span><span class="token punctuation">(</span>u_pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errno<span class="token operator">=</span>save_errno<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//设置信号函数</span>
<span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token operator">::</span><span class="token function">addsig</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">bool</span> restart<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//创建sigaction结构体变量</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sa<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化</span>

    <span class="token comment">//信号处理函数中仅仅发送信号值，不做对应逻辑处理</span>
    sa<span class="token punctuation">.</span>sa_handler<span class="token operator">=</span>handler<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>restart<span class="token punctuation">)</span>
        sa<span class="token punctuation">.</span>sa_flags<span class="token operator">|=</span>SA_RESTART<span class="token punctuation">;</span>

    <span class="token comment">//将所有信号添加到信号集中</span>
    <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//执行sigaction函数</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token operator">::</span><span class="token function">show_error</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> info<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">send</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span>info<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>







<h2 id="http-conn类"><a href="#http-conn类" class="headerlink" title="http_conn类"></a>http_conn类</h2><p>http_conn类主要功能就是处理报文的读取和发送，同时这里还涉及到了主从状态机，从状态机负责读取报文的一行，主状态机负责对该行数据进行解析（主状态机内部调用了从状态机），由于这个类比较大，这里分类来记录</p>
<p>http_conn的调用是在WebServer类中的，在WebServer类有个成员变量http_conn* 指针，代表http_conn数组。在WebServer类构造函数中，这个指针会进行new：<code>users=new http_conn[MAX_FD];//http_conn类对象，MAX_FD=65536</code>，</p>
<p>问题：这里有两个成员变量不知道是什么<code>int timer_flag;</code>和<code>int improv;</code>。还有两个结构体也不知道是啥<code>struct stat m_file_stat;</code>和<code>struct iovec m_iv[2];//io向量机制iovec</code></p>
<p>1、在http_conn.h头文件中，成员变量有两个缓冲区，分别是读缓冲区<code>char m_read_buf[READ_BUFFER_SIZE];</code>，他是用来存储读取的请求报文的数据；另外一个是写缓冲区<code>char m_write_buf[WRITE_BUFFER_SIZE];</code>他是用来存储即将要发出的响应报文的数据</p>
<h3 id="四个不属于类成员函数"><a href="#四个不属于类成员函数" class="headerlink" title="四个不属于类成员函数"></a>四个不属于类成员函数</h3><p>2、在http_conn.cpp代码文件中有四个不是属于类成员的函数，这四个函数是对epoll相关设置的封装，作为功能性函数代码如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//将文件描述符设置为非阻塞</span>
<span class="token keyword">int</span> <span class="token function">set_no_blocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> old_option<span class="token operator">=</span><span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> new_option<span class="token operator">=</span>old_option<span class="token operator">|</span>O_NONBLOCK<span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>F_SETFL<span class="token punctuation">,</span>new_option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//将内核事件注册读事件，ET模式，选择开启EPOLLONESHOT</span>
<span class="token keyword">void</span> <span class="token function">add_fd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span><span class="token keyword">bool</span> one_shot<span class="token punctuation">,</span><span class="token keyword">int</span> TRIGMode<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    epoll_event event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token operator">=</span>fd<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>TRIGMode<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
        event<span class="token punctuation">.</span>events<span class="token operator">=</span>EPOLLIN<span class="token operator">|</span>EPOLLET<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        event<span class="token punctuation">.</span>events<span class="token operator">=</span>EPOLLIN<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>one_shot<span class="token punctuation">)</span>
        event<span class="token punctuation">.</span>events<span class="token operator">|=</span>EPOLLONESHOT<span class="token punctuation">;</span>
    
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span>EPOLL_CTL_ADD<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_no_blocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将fd设置为非阻塞模式</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//从内核事件表中删除描述符，例如：取消对某个客户端的监听</span>
<span class="token keyword">void</span> <span class="token function">remove_fd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span>EPOLL_CTL_DEL<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//将事件重置为EPOLLONESHOT</span>
<span class="token keyword">void</span> <span class="token function">modfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span><span class="token keyword">int</span> ev<span class="token punctuation">,</span><span class="token keyword">int</span> TRIGMode<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    epoll_event event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token operator">=</span>fd<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>TRIGMode<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
        event<span class="token punctuation">.</span>events<span class="token operator">=</span>ev<span class="token operator">|</span>EPOLLET<span class="token operator">|</span>EPOLLONESHOT<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        event<span class="token punctuation">.</span>events<span class="token operator">=</span>ev<span class="token operator">|</span>EPOLLONESHOT<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">;</span>

    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span>EPOLL_CTL_MOD<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="两个初始化init"><a href="#两个初始化init" class="headerlink" title="两个初始化init()"></a>两个初始化init()</h3><p>3、有两个初始化函数，其中一个是外界调用的带参数的初始化方法，实现主要是将外界传进来的参数赋值给当前的连接对象，并将sockfd添加到epoll监听列表中</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//初始化连接，外部调用初始化套接字地址</span>
<span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span><span class="token keyword">const</span> sockaddr_in<span class="token operator">&amp;</span> addr<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> root<span class="token punctuation">,</span><span class="token keyword">int</span> TRIGMode<span class="token punctuation">,</span>
    	<span class="token keyword">int</span> close_log<span class="token punctuation">,</span>string user<span class="token punctuation">,</span>string passwd<span class="token punctuation">,</span>string sql_name<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">this</span><span class="token operator">-></span>m_sockfd<span class="token operator">=</span>sockfd<span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token operator">-></span>m_address<span class="token operator">=</span>addr<span class="token punctuation">;</span>
    

    <span class="token comment">//向epollfd中添加一个sockfd，默认开启EPOLLONESHOT模式</span>
    <span class="token function">add_fd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>sockfd<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">++</span>m_user_count<span class="token punctuation">;</span>
    
    <span class="token comment">//当浏览器出现连接重置时，可能时网站根目录出错或http响应格式出错或者访问的文件中内容完全为空</span>
    doc_root<span class="token operator">=</span>root<span class="token punctuation">;</span>
    m_TRIGMode<span class="token operator">=</span>TRIGMode<span class="token punctuation">;</span>
    m_close_log<span class="token operator">=</span>close_log<span class="token punctuation">;</span>

    <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>sql_user<span class="token punctuation">,</span>user<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>sql_passwd<span class="token punctuation">,</span>passwd<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>sql_name<span class="token punctuation">,</span>sql_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>另外一个则是在上面带参数init初始化完成后，再调用无参的init()，需要注意的是这个无参init是私有成员（private）函数</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//私有init函数，初始化新接受的连接</span>
<span class="token comment">//check_state默认为分析请求状态</span>
<span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">this</span><span class="token operator">-></span>mysql<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
	bytes_have_send<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	bytes_to_send<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	m_check_state<span class="token operator">=</span>CHECK_STATE<span class="token operator">::</span>REQUESTLINE<span class="token punctuation">;</span>
	m_linger<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//是否长连接</span>
	m_method<span class="token operator">=</span>METHOD<span class="token operator">::</span>GET<span class="token punctuation">;</span>
	m_url<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
	m_version<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
	m_content_length<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	m_host<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
	m_start_line<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	m_checked_idx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	m_read_idx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	m_write_idx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	cgi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	m_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">//?下面两个是什么？</span>
	timer_flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	improv<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>m_read_buf<span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">,</span>READ_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>m_write_buf<span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">,</span>WRITE_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">,</span>FILENAME_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="从数据库中导入账户密码到哈希表中"><a href="#从数据库中导入账户密码到哈希表中" class="headerlink" title="从数据库中导入账户密码到哈希表中"></a>从数据库中导入账户密码到哈希表中</h3><p><code>void http_conn::initMysql_result(connection_pool* connPool)</code>这个函数是用于将数据库中的账户密码加载在内存的unordered_map中，思路则是从MySQL连接池中取出一个空闲连接，进行查询语句后将结果集中每一行结果往哈希表变量<code>unordered_map&lt;string,string&gt; m_users</code>中写数据，键为用户名，值为密码（！可改进地方为对密码进行加密处理）</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//将数据库中的用户名和密码载入到服务器中的map中</span>
<span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">initMysql_result</span><span class="token punctuation">(</span>connection_pool<span class="token operator">*</span> connPool<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//先从连接池中取一个连接</span>
    MYSQL <span class="token operator">*</span>mysql <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql<span class="token punctuation">,</span> connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    
    <span class="token comment">//在user表中检索username，passwd数据，浏览器端输入</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span> <span class="token string">"SELECT username,passwd FROM user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"SELECT error:%s\n"</span><span class="token punctuation">,</span> <span class="token function">mysql_error</span><span class="token punctuation">(</span>mysql<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    

    <span class="token comment">//从表中检索完整的结果集</span>
    MYSQL_RES <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token function">mysql_store_result</span><span class="token punctuation">(</span>mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//返回结果集中的列数</span>
    <span class="token keyword">int</span> num_fields <span class="token operator">=</span> <span class="token function">mysql_num_fields</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//返回所有字段结构的数组</span>
    MYSQL_FIELD <span class="token operator">*</span>fields <span class="token operator">=</span> <span class="token function">mysql_fetch_fields</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//从结果集中获取下一行，将对应的用户名和密码，存入map中</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>MYSQL_ROW row <span class="token operator">=</span> <span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        string <span class="token function">temp1</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        string <span class="token function">temp2</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_users<span class="token punctuation">[</span>temp1<span class="token punctuation">]</span> <span class="token operator">=</span> temp2<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="read-once-函数"><a href="#read-once-函数" class="headerlink" title="read_once()函数"></a>read_once()函数</h3><p>在WebServer中的<code>deal_with_thread()</code>给调用，用于epoll检测到连接有新的请求进来时，提供proactor模式读取请求</p>
<p>read_once()函数中又提供了ET和LT读取，在ET读取用的是个while</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//循环读取客户数据，直到无数据可读或对方关闭连接</span>
<span class="token comment">//在非阻塞ET工作模式下，需要一次性将数据读完</span>
<span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_read_idx<span class="token operator">>=</span>READ_BUFFER_SIZE<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> bytes_read<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">//*LT读取数据</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_TRIGMode<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//recv是接收数据函数，返回的是实际copy到缓冲区的数据字节数</span>
        bytes_read<span class="token operator">=</span><span class="token function">recv</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span>m_read_buf<span class="token operator">+</span>m_read_idx<span class="token punctuation">,</span>READ_BUFFER_SIZE<span class="token operator">-</span>m_read_idx<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_read_idx<span class="token operator">+=</span>bytes_read<span class="token punctuation">;</span>

        <span class="token comment">//error</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_read<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//*ET读取数据，需要一次性将数据读完，所以有个while</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            bytes_read<span class="token operator">=</span><span class="token function">recv</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span>m_read_buf<span class="token operator">+</span>m_read_idx<span class="token punctuation">,</span>READ_BUFFER_SIZE<span class="token operator">-</span>m_read_idx<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">//error</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_read<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token comment">//下面两个错误码在大多数系统下是指同一个东西，指在非阻塞对象下执行了一个阻塞操作</span>
                <span class="token comment">//详细可见下面网址：</span>
                <span class="token comment">//https://www.dyxmq.cn/program/code/c-cpp/how-to-handle-eagin-and-ewouldblock-error-in-linux-c.html</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>errno<span class="token operator">==</span>EAGAIN<span class="token operator">||</span>errno<span class="token operator">==</span>EWOULDBLOCK<span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_read<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            
            m_read_idx<span class="token operator">+=</span>bytes_read<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token comment">//end while</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="warning-处理http报文请求与报文响应—-gt-process"><a href="#warning-处理http报文请求与报文响应—-gt-process" class="headerlink" title=":warning:处理http报文请求与报文响应—&gt;process()"></a>:warning:处理http报文请求与报文响应—&gt;process()</h3><p>这个函数是对<strong>报文读取</strong>以及<strong>报文响应</strong>两个大功能，同时也是<strong>线程池中要给调用的process()<strong>，这里在读取请求报文后会将socket在epoll中的事件修改成</strong>EPOLLOUT</strong>事件以便下次WebServer主循环中发送报文</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//子线程从任务队列抽出任务进行处理的函数</span>
<span class="token comment">//从而完成报文解析工作和报文响应</span>
<span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    HTTP_CODE read_ret<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span><span class="token function">process_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从缓冲区读取报文，解析</span>

    <span class="token comment">//NO_REQUEST，表示请求报文不完整，需要继续接收请求数据</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>read_ret<span class="token operator">==</span>HTTP_CODE<span class="token operator">::</span>NO_REQUEST<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//注册并监听读事件</span>
        <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_sockfd<span class="token punctuation">,</span>EPOLLIN<span class="token punctuation">,</span>m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//调用process_write完成报文的响应工作</span>
    <span class="token keyword">bool</span> write_ret<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span><span class="token function">process_write</span><span class="token punctuation">(</span>read_ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>write_ret<span class="token punctuation">)</span>
        <span class="token function">close_conn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//注册并监听写事件</span>
    <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_sockfd<span class="token punctuation">,</span>EPOLLOUT<span class="token punctuation">,</span>m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="主状态机—process-read-以及解析头部、解析请求行、解析消息体"><a href="#主状态机—process-read-以及解析头部、解析请求行、解析消息体" class="headerlink" title="主状态机—process_read()以及解析头部、解析请求行、解析消息体"></a>主状态机—process_read()以及解析头部、解析请求行、解析消息体</h3><p>在主状态机中，每次while循环都会先调用从状态机读取并解析<code>parse_line()</code>当前一行的数据，从解析的结果<code>CHECK_STATE</code>判断是<strong>请求头</strong>、<strong>请求行</strong>和<strong>请求消息体</strong>三个中的哪一个，再进行进一步解析。直到遇到一个空行，表明得到了一个正确的http请求。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//有限状态机处理请求报文</span>
http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">process_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token comment">//初始化从状态机状态，HTTP请求解析结果</span>
    LINE_STATUS line_statue<span class="token operator">=</span>LINE_STATUS<span class="token operator">::</span>LINE_OK<span class="token punctuation">;</span>
    HTTP_CODE ret<span class="token operator">=</span>HTTP_CODE<span class="token operator">::</span>NO_REQUEST<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> text<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    <span class="token comment">//?这里的两个判断条件为什么这么写，具体在主状态机逻辑中会讲到</span>

    <span class="token comment">//parse_line为从状态机的具体实现</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m_check_state<span class="token operator">==</span>CHECK_STATE<span class="token operator">::</span>CONTENT<span class="token operator">&amp;&amp;</span>line_statue<span class="token operator">==</span>LINE_STATUS<span class="token operator">::</span>LINE_OK<span class="token punctuation">)</span><span class="token operator">||</span>
            <span class="token punctuation">(</span>line_statue<span class="token operator">=</span><span class="token function">parse_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span>LINE_STATUS<span class="token operator">::</span>LINE_OK<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"get line is ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        text<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span><span class="token function">get_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//m_start_line是每一个数据行在m_read_buf中的起始位置</span>
        <span class="token comment">//m_checked_idx表示从状态机在m_read_buf中的读取位置</span>
        m_start_line<span class="token operator">=</span>m_checked_idx<span class="token punctuation">;</span>

        <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出调试信息</span>

        <span class="token comment">//主状态机三种状态转移逻辑实现</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>m_check_state<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        
        <span class="token keyword">case</span> CHECK_STATE<span class="token operator">::</span>REQUESTLINE<span class="token operator">:</span>
            <span class="token comment">//解析请求行</span>
            ret<span class="token operator">=</span><span class="token function">parse_request_line</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span>HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">)</span>
                <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>
            <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"parse_request_line is ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> CHECK_STATE<span class="token operator">::</span>HEADER<span class="token operator">:</span>
            <span class="token comment">//解析请求头</span>
            ret<span class="token operator">=</span><span class="token function">parse_headers</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span>HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">)</span>
                <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span>HTTP_CODE<span class="token operator">::</span>GET_REQUEST<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token comment">//完整的解析GET请求后，跳转到报文响应函数</span>
                <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"parse_headers is ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">do_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> CHECK_STATE<span class="token operator">::</span>CONTENT<span class="token operator">:</span>
            <span class="token comment">//解析消息体</span>
            ret<span class="token operator">=</span><span class="token function">parse_content</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//完整解析POST请求后，跳转到报文响应函数</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span>HTTP_CODE<span class="token operator">::</span>GET_REQUEST<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"parse_content is ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">do_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//解析完消息体即完成报文解析，避免再次进入循环，更新line_status</span>
            line_statue<span class="token operator">=</span>LINE_STATUS<span class="token operator">::</span>LINE_OPEN<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>INTERNAL_ERROR<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token comment">//end switch</span>
    <span class="token punctuation">&#125;</span><span class="token comment">//end while</span>

    <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>NO_REQUEST<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//解析http请求行，获得请求方法、目标url、以及http版本号等</span>
http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">parse_request_line</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> text<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//在http报文中，请求行用来说明请求类型、要访问的资源以及所使用的http版本</span>
    <span class="token comment">//其中各个部分之间通过\t或空格来分隔</span>
    
    <span class="token comment">//   为了方便以后的阅读了解运作原理，这里举一个请求行用例</span>
    <span class="token comment">//   GET /562f25980001b1b106000338.jpg HTTP/1.1</span>


    <span class="token comment">//请求行中最先含有空格和\t任意一个字符的位置并返回</span>
    <span class="token comment">//*strpbrk -> 依次检验字符串 str1 中的字符，当被检验字符在字符串 str2 中也包含时，则停止检验，并返回该字符位置</span>
    m_url<span class="token operator">=</span><span class="token function">strpbrk</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span><span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//如果没有空格或\t，则报文格式有误</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_url<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//将该位置改为\0，用于将前面的数据取出</span>
    <span class="token operator">*</span>m_url<span class="token operator">++</span> <span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>

    <span class="token comment">//取出数据，并通过与GET和POST比较判断是哪种请求类型</span>
    <span class="token keyword">char</span><span class="token operator">*</span> method<span class="token operator">=</span>text<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span><span class="token string">"GET"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        m_method<span class="token operator">=</span>METHOD<span class="token operator">::</span>GET<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span><span class="token string">"POST"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        m_method<span class="token operator">=</span>METHOD<span class="token operator">::</span>POST<span class="token punctuation">;</span>
        cgi<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token comment">//错误情况</span>
        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>
    

    <span class="token comment">//m_url此时跳过了第一个空格或\t字符，但不知道之后是否还有</span>
    <span class="token comment">//将m_url向后偏移，通过查找以继续跳过空格或\t字符，从而指向请求资源的第一个字符</span>
    <span class="token comment">//*strcspn -> 检索字符串 str1 中第一个不在字符串 str2 中出现的字符下标</span>
    m_url<span class="token operator">+=</span><span class="token function">strspn</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//使用与判断请求方式相同的逻辑，判断http版本号</span>
    m_version<span class="token operator">=</span><span class="token function">strpbrk</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_version<span class="token punctuation">)</span>
        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>
    <span class="token operator">*</span>m_version<span class="token operator">++</span> <span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
    m_version<span class="token operator">+=</span><span class="token function">strspn</span><span class="token punctuation">(</span>m_version<span class="token punctuation">,</span><span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 仅支持HTTP/1.1</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>m_version<span class="token punctuation">,</span><span class="token string">"HTTP/1.1"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>

    <span class="token comment">//对请求资源前7个字符进行判断</span>
    <span class="token comment">//这里只要是有些报文的请求资源中会带有"http://"，这里需要对这种情况单独处理</span>
    <span class="token comment">//*strchr -> 在参数 str 所指向的字符串中搜索第一次出现字符 c（一个无符号字符）的位置。</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">"http://"</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        m_url<span class="token operator">+=</span><span class="token number">7</span><span class="token punctuation">;</span>
        m_url<span class="token operator">=</span><span class="token function">strchr</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//同样增加https情况</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">"https://"</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        m_url<span class="token operator">+=</span><span class="token number">8</span><span class="token punctuation">;</span>
        m_url<span class="token operator">=</span><span class="token function">strchr</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//一般的不会带有上述两种符号，直接是单独的/或/后面带访问资源</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_url<span class="token operator">||</span>m_url<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'/'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>


    <span class="token comment">//当url为/时，显示欢迎界面</span>
    <span class="token comment">//*strcat -> 把 src 所指向的字符串追加到 dest 所指向的字符串的结尾</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">strcat</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">"judge.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//请求行处理完毕后，将主机状态转移处理请求头</span>
    m_check_state<span class="token operator">=</span>CHECK_STATE<span class="token operator">::</span>HEADER<span class="token punctuation">;</span>
    <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>NO_REQUEST<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//解析http请求的一个头部信息</span>
http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">parse_headers</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//判断是空行还是请求头</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\0'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">//判断是GET还是POST请求</span>
        <span class="token comment">//!0 is POST</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_content_length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">//POST需要跳转到消息体处理状态</span>
            m_check_state <span class="token operator">=</span> CHECK_STATE_CONTENT<span class="token punctuation">;</span>
            <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//==0 is GET</span>
        <span class="token keyword">return</span> GET_REQUEST<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//解析请求头部connection字段</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"Connection:"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        text <span class="token operator">+=</span> <span class="token number">11</span><span class="token punctuation">;</span>

        <span class="token comment">//跳过空格和\t字符</span>
        text <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"keep-alive"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">//如果是长连接，则将linger标志设置为true</span>
            m_linger <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//解析请求头部Content-length字段</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"Content-length:"</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        text <span class="token operator">+=</span> <span class="token number">15</span><span class="token punctuation">;</span>
        text <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_content_length <span class="token operator">=</span> <span class="token function">atol</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//解析请求头部Host字段</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"Host:"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        text <span class="token operator">+=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        text <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_host <span class="token operator">=</span> text<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"oop!unknow header: %s"</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//解析消息体</span>
http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">parse_content</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> text<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//判断buffer中是否读取了消息体</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_read_idx<span class="token operator">>=</span><span class="token punctuation">(</span>m_content_length<span class="token operator">+</span>m_checked_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        text<span class="token punctuation">[</span>m_content_length<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>

        <span class="token comment">//POST请求中最后为输入的用户名和密码</span>
        m_string<span class="token operator">=</span>text<span class="token punctuation">;</span>
        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>GET_REQUEST<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>NO_REQUEST<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="从状态机—parse-line"><a href="#从状态机—parse-line" class="headerlink" title="从状态机—parse_line()"></a>从状态机—parse_line()</h3><p>从状态机用于分析报文中一行的内容</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//从状态机，用于分析出一行内容</span>
<span class="token comment">//返回值为行的读取状态，有LINE_OK,LINE_BAD,LINE_OPEN</span>
http_conn<span class="token operator">::</span>LINE_STATUS http_conn<span class="token operator">::</span><span class="token function">parse_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> temp<span class="token punctuation">;</span>

    <span class="token comment">//m_read_idx指向缓冲区m_read_buf的数据末尾的下一个字节</span>
    <span class="token comment">//m_checked_idx指向从状态机当前正在分析的字节</span>
    <span class="token comment">//!报文以'\r\n'结尾的，这里是要判断该数据行是否完整状态</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>m_checked_idx<span class="token operator">&lt;</span>m_read_idx<span class="token punctuation">;</span><span class="token operator">++</span>m_checked_idx<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        temp<span class="token operator">=</span>m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//当前要分析的字节</span>
        
        <span class="token comment">//如果为'\r'字符，则可能读到完整行</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">==</span><span class="token string">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

            <span class="token comment">//下一个字符到达了buffer结尾，则接收不完整</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m_checked_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span>m_read_idx<span class="token punctuation">)</span>
                <span class="token keyword">return</span> LINE_STATUS<span class="token operator">::</span>LINE_OPEN<span class="token punctuation">;</span>
            <span class="token comment">//下一个字符为\n则将\r\n改为\0\0</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
                m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> LINE_STATUS<span class="token operator">::</span>LINE_OK<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> LINE_STATUS<span class="token operator">::</span>LINE_BAD<span class="token punctuation">;</span><span class="token comment">//都不符合则返回语法错误</span>

            <span class="token comment">//如果是\n也可能读取得到完整行</span>
            <span class="token comment">//一般会出现上一次读取到了\r就到了buf末尾了，这种是没有接收完整的情况</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">==</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//前一个字符是\r则接收完整</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>m_checked_idx<span class="token operator">></span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
                m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> LINE_STATUS<span class="token operator">::</span>LINE_OK<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> LINE_STATUS<span class="token operator">::</span>LINE_BAD<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token comment">//end for</span>

    <span class="token comment">//没有找到\r\n代表接收不完整，要继续接收</span>
    <span class="token keyword">return</span> LINE_STATUS<span class="token operator">::</span>LINE_OPEN<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="do-request-函数"><a href="#do-request-函数" class="headerlink" title="do_request()函数"></a>do_request()函数</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">do_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
    <span class="token comment">//将初始化的m_real_file赋值为网站根目录</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span>doc_root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token operator">=</span><span class="token function">strlen</span><span class="token punctuation">(</span>doc_root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"m_url:%s\n"</span><span class="token punctuation">,</span> m_url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//找到m_url中/的位置</span>
    <span class="token comment">//* strrchr -> 在参数 str 所指向的字符串中搜索最后一次出现字符 c（一个无符号字符）的位置</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> p<span class="token operator">=</span><span class="token function">strrchr</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    

    <span class="token comment">//处理cgi</span>
    <span class="token comment">//实现登录和注册校验（在POST请求报文中，这里定义/2为登录，/3为注册）</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>cgi<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'2'</span><span class="token operator">||</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//根据标志判断是登录检测还是注册检测</span>
        <span class="token keyword">char</span> flag<span class="token operator">=</span>m_url<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"the flag is:%c\n"</span><span class="token punctuation">,</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> m_url_real<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcat</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span>m_url<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url_real<span class="token punctuation">,</span>FILENAME_LEN<span class="token operator">-</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> m_url_real<span class="token punctuation">;</span>

        <span class="token comment">//将用户名和密码提取出来</span>
        <span class="token comment">//user=123&amp;&amp;passwd=123</span>
        <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span>password<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'&amp;'</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
            name<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span>m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        name<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">;</span>m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">,</span><span class="token operator">++</span>j<span class="token punctuation">)</span>
            password<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span>m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        password<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//注册</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"用户打开注册界面\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果是注册，先检测数据库中是否有重名的</span>
            <span class="token comment">//没有重名的，进行增加数据</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>sql_insert <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"INSERT INTO user(username, passwd) VALUES("</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"', '"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//没有重名的，则加进</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>m_users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span>m_users<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                m_lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token function">mysql_query</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span>sql_insert<span class="token punctuation">)</span><span class="token punctuation">;</span>
                m_users<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>std<span class="token operator">::</span>pair<span class="token operator">&lt;</span>string<span class="token punctuation">,</span>string<span class="token operator">></span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                m_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span>
                    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">"/log.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/registerError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">&#125;</span><span class="token comment">//有重名</span>
            <span class="token keyword">else</span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">"/registerError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span><span class="token comment">//如果是登录，直接判断</span>
        <span class="token comment">//若浏览器端输入的用户名和密码表可以查找到，返回1，否则返回0</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>m_users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">!=</span>m_users<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>m_users<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token operator">==</span>password<span class="token punctuation">)</span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">"/welcome.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">"/logError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//同步线程登录校验</span>

        <span class="token comment">//CGI多进程登录校验</span>

    <span class="token punctuation">&#125;</span><span class="token comment">//end 登录注册校验</span>


    <span class="token comment">//如果请求资源为/0，表示跳转注册界面</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> m_url_real<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span><span class="token string">"/register.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//将网站目录和/register.html进行拼接，更新到m_real_file中</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url_real<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> m_url_real<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token comment">//如果请求资源为/1，表示跳转登录界面</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> m_url_real<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span><span class="token string">"/log.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//将网站目录和log.html进行拼接，更新到m_real_file中</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url_real<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> m_url_real<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token comment">//如果请求资源为/5，表示跳转到图片请求界面</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'5'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> m_url_real<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span><span class="token string">"/picture.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url_real<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> m_url_real<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token comment">//如果请求资源/6，表示视频请求界面</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'6'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> m_url_real<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span><span class="token string">"/video.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url_real<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> m_url_real<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token comment">//如果请求资源为/7，表示跳转关注界面</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'7'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> m_url_real<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span><span class="token string">"/fans.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url_real<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> m_url_real<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token comment">//如果以上均不符合，则直接将url与网站目录拼接</span>
    <span class="token comment">//这里情况是welcome界面，请求服务器上的一个图片</span>
    <span class="token keyword">else</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url<span class="token punctuation">,</span>FILENAME_LEN<span class="token operator">-</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//通过stat获取请求资源文件信息，成功则将信息更新到m_file_stat结构体</span>
    <span class="token comment">//失败返回NO_RESOURCE状态，表示资源不存在</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span><span class="token operator">&amp;</span>m_file_stat<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>NO_RESOURCE<span class="token punctuation">;</span>

    <span class="token comment">//判断文件权限，是否可读，不可读则返回FORBIDDEN_REQUEST状态</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_mode<span class="token operator">&amp;</span>S_IROTH<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>FORBIDDEN_REQUEST<span class="token punctuation">;</span>
    
    <span class="token comment">//判断文件类型，如果是目录，则返回BAD_REQUEST，表示请求报文有误</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">S_ISDIR</span><span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>


    <span class="token comment">//以只读方式获取文件描述符，通过mmap将该文件映射到内存中</span>
    <span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_file_address<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span>PROT_READ<span class="token punctuation">,</span>MAP_PRIVATE<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//避免文件描述符的浪费和占用</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//表示请求文件存在，且可以访问</span>
    <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>FILE_REQUEST<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token comment">//取消mmap映射</span>
<span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_file_address<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">munmap</span><span class="token punctuation">(</span>m_file_address<span class="token punctuation">,</span>m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用系统函数</span>
        m_file_address<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="生成响应报文—用了IO向量机制"><a href="#生成响应报文—用了IO向量机制" class="headerlink" title="生成响应报文—用了IO向量机制"></a>生成响应报文—用了IO向量机制</h3><p>前面解析完成一个请求报文后，会调用do_request()函数，根据请求报文的解析结果，判断请求资源是否存在、请求动作是否正确等，将相关文件映射到内存，以便后续直接从内存中读取，填充到响应报文返回给浏览器，浏览器解析响应报文后，就生成了我们所看到的网页界面。<br>这里使用了IO向量机制，IO向量即struct iovec，iovec结构体中可以存放多个buffer，使用对应的readv和writev读写文件，可以按顺序读到多个buffer中，以及将多个buffer的内容写到文件描述符。<br>此处m_iv[0]指向m_write_buf（存放响应报文头部内容），m_iv[1]指向m_file_address（使用mmap将请求资源映射到的内存），然后可以使用writev按顺序将其写到socket中。</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="添加响应报文函数"><a href="#添加响应报文函数" class="headerlink" title="添加响应报文函数"></a>添加响应报文函数</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//添加响应报文的公共函数</span>
<span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_response</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//如果写入内容超出m_write_buf大小则报错</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_write_idx <span class="token operator">>=</span> WRITE_BUFFER_SIZE<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">//定义可变参数列表</span>
    va_list arg_list<span class="token punctuation">;</span>
    <span class="token comment">//将变量arg_list初始化为传入参数</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>arg_list<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将数据format从可变参数列表写入缓冲区写，返回写入数据的长度</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">vsnprintf</span><span class="token punctuation">(</span>m_write_buf <span class="token operator">+</span> m_write_idx<span class="token punctuation">,</span> WRITE_BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> m_write_idx<span class="token punctuation">,</span> format<span class="token punctuation">,</span> arg_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果写入的数据长度超过缓冲区剩余空间，则报错</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">>=</span> <span class="token punctuation">(</span>WRITE_BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> m_write_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">va_end</span><span class="token punctuation">(</span>arg_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//更新m_write_idx位置</span>
    m_write_idx <span class="token operator">+=</span> len<span class="token punctuation">;</span>
    <span class="token comment">//清空可变参列表</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>arg_list<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"request:%s"</span><span class="token punctuation">,</span> m_write_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//添加状态行</span>
<span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>title<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"%s %d %s\r\n"</span><span class="token punctuation">,</span> <span class="token string">"HTTP/1.1"</span><span class="token punctuation">,</span> status<span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//添加消息报头，具体的添加文本长度、连接状态和空行</span>
<span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token keyword">int</span> content_len<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">add_content_length</span><span class="token punctuation">(</span>content_len<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">add_linger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
           <span class="token function">add_blank_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//添加Content-Length，表示响应报文的长度</span>
<span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_content_length</span><span class="token punctuation">(</span><span class="token keyword">int</span> content_len<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"Content-Length:%d\r\n"</span><span class="token punctuation">,</span> content_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//添加文本类型，这里是html</span>
<span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_content_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"Content-Type:%s\r\n"</span><span class="token punctuation">,</span> <span class="token string">"text/html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//添加连接状态，通知浏览器端是保持连接还是关闭</span>
<span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_linger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"Connection:%s\r\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>m_linger <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"keep-alive"</span> <span class="token operator">:</span> <span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//添加空行</span>
<span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_blank_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//添加文本content</span>
<span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_content</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>content<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>




<span class="token comment">//向m_write_buf准备好响应报文</span>
<span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">process_write</span><span class="token punctuation">(</span>HTTP_CODE ret<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//内部错误，500</span>
    <span class="token keyword">case</span> HTTP_CODE<span class="token operator">::</span>INTERNAL_ERROR<span class="token operator">:</span>
        <span class="token comment">//状态行</span>
        <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span>error_500_title<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息报头</span>
        <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>error_500_form<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>error_500_form<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token comment">//报文语法有误，404</span>
    <span class="token keyword">case</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token operator">:</span>
        <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span>error_404_title<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>error_404_form<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>error_404_form<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    
    <span class="token comment">//资源没有访问权限，403</span>
    <span class="token keyword">case</span> HTTP_CODE<span class="token operator">::</span>FORBIDDEN_REQUEST<span class="token operator">:</span>
        <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span>error_403_title<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>error_403_form<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>error_403_form<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token comment">//文件存在，200</span>
    <span class="token keyword">case</span> HTTP_CODE<span class="token operator">::</span>FILE_REQUEST<span class="token operator">:</span>
        <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span>ok_200_title<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果请求的资源存在</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_size<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token function">add_headers</span><span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//第一个iovec指针指向响应报文缓冲区，长度指向m_write_idx</span>
            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base<span class="token operator">=</span>m_write_buf<span class="token punctuation">;</span>
            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token operator">=</span>m_write_idx<span class="token punctuation">;</span>
            <span class="token comment">//第二个iovec指针指向mmap返回的文件指针，长度指向文件的大小</span>
            m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base<span class="token operator">=</span>m_file_address<span class="token punctuation">;</span>
            m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token operator">=</span>m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>
            m_iv_count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>

            <span class="token comment">//发送的全部数据为响应报文头部信息和文件大小</span>
            bytes_to_send<span class="token operator">=</span>m_write_idx<span class="token operator">+</span>m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//如果请求资源大小为0，则返回空白html文件</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ok_string<span class="token operator">=</span><span class="token string">"&lt;html>&lt;body>&lt;/body>&lt;/html>"</span><span class="token punctuation">;</span>
            <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>ok_string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>ok_string<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">//?return true;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//除了FILE——REQUEST状态外，其余状态只申请一个iovec，指向响应报文缓冲区</span>
    m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base<span class="token operator">=</span>m_write_buf<span class="token punctuation">;</span>
    m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token operator">=</span>m_write_idx<span class="token punctuation">;</span>
    m_iv_count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    bytes_to_send <span class="token operator">=</span> m_write_idx<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="发送响应报文—http-conn-write"><a href="#发送响应报文—http-conn-write" class="headerlink" title="发送响应报文—http_conn::write()"></a>发送响应报文—http_conn::write()</h3><p>在生成响应报文后，epoll事件就会在线程池的<code>process()</code>方法最后修改成EPOLLOUT，随后也是通过WebServer主循环检测，通过<code>deal_with_write()</code>来调用http_conn::write()进行报文发送，由此整个传输过程完毕</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">
<span class="token comment">/**
 * 服务器调用process_write完成响应报文，随后注册epollout事件，服务器主线程检测写事件，
 * 同时调用http_conn::write()函数将响应报文发送给浏览器端
 * 
 * 在生成响应报文时初始化byte_to_send，包括头部信息和文件数据大小。
 * 通过writev()函数循环发送响应报文数据
 * 根据返回值更新byte_have_send和iovec结构体的指针和长度，并判断响应报文整体是否发送成功
 */</span>
<span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">//若要发送的数据长度为0，表示响应报文为空，一般不会出现这种情况</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_to_send<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_sockfd<span class="token punctuation">,</span>EPOLLIN<span class="token punctuation">,</span>m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//将响应报文的状态行、消息头、空行和响应正文发送给浏览器端</span>
        temp<span class="token operator">=</span><span class="token function">writev</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span>m_iv<span class="token punctuation">,</span>m_iv_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>errno<span class="token operator">==</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token comment">//判断写缓冲区是否满了</span>
                <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_sockfd<span class="token punctuation">,</span>EPOLLOUT<span class="token punctuation">,</span>m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//如果不是缓冲区问题，则取消映射，断开连接</span>
            <span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//更新发送字节的长度</span>
        bytes_have_send<span class="token operator">+=</span>temp<span class="token punctuation">;</span>
        bytes_to_send<span class="token operator">-=</span>temp<span class="token punctuation">;</span>

        <span class="token comment">//如果第一个iovec头部信息发送完成，发送第二个iovec数据</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_have_send<span class="token operator">>=</span>m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base<span class="token operator">=</span>m_file_address<span class="token operator">+</span><span class="token punctuation">(</span>bytes_have_send<span class="token operator">-</span>m_write_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token operator">=</span>bytes_to_send<span class="token punctuation">;</span>
            
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//否则继续发送第一个iovec头部信息数据</span>
            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base<span class="token operator">=</span>m_write_buf<span class="token operator">+</span>bytes_have_send<span class="token punctuation">;</span>
            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token operator">=</span>m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token operator">-</span>bytes_have_send<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//剩余发送字节为0时（数据全部发送完毕）</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_to_send<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//在epoll树上重置EPOLLONESHOT事件</span>
            <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_sockfd<span class="token punctuation">,</span>EPOLLIN<span class="token punctuation">,</span>m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//判断浏览器请求是否为长连接</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>m_linger<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token comment">//重新初始化HTTP对象</span>
                <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">//?默认返回false</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="有待查询的问题"><a href="#有待查询的问题" class="headerlink" title="有待查询的问题"></a>有待查询的问题</h1><ol>
<li>条件变量和信号量的区别以及各自的使用环境</li>
<li>如何改进对数据库的账户和密码加密</li>
<li>如果收到资源超时信号，其实还是要循环定时器链表，找到超时的连接删掉，有点消耗性能，如何改进？</li>
</ol>
<h1 id="自己的问题"><a href="#自己的问题" class="headerlink" title="自己的问题"></a>自己的问题</h1><p>这里的问题是自己在复习过程中发现的问题，记录下来方便自己梳理</p>
<h2 id="谁把请求放入了线程池中"><a href="#谁把请求放入了线程池中" class="headerlink" title="谁把请求放入了线程池中"></a>谁把请求放入了线程池中</h2><p>在WebServer.cpp中主循环中描述了，如果epoll收到请求读事件，则会跳转到<code>deal_with_thread()</code>函数，其中会判断actor模式而用不同的添加请求到请求队列方式（reactor用m_pool-&gt;append()；proactor用m_pool-&gt;append_p()）</p>
<p><strong>注意：append进去的参数类型是http_conn*类型</strong></p>
<h2 id="谁调用了worker"><a href="#谁调用了worker" class="headerlink" title="谁调用了worker()"></a>谁调用了worker()</h2><p>当然是在线程池初始化时创建的线程啦</p>
<p>这些线程被创建后用pthread_detach实现线程分离，则会运行<code>worker()</code>，而<code>worker()</code>里面又调用着<code>threadpool&lt;&gt;::run()</code>，此时如果请求队列里面有请求则线程会因为信号量响应从而处理请求，否则的话线程会阻塞等待</p>
<h2 id="为什么又要有client-data数组users-timer，又要有http-conn数组users，它们各自作用是啥"><a href="#为什么又要有client-data数组users-timer，又要有http-conn数组users，它们各自作用是啥" class="headerlink" title="为什么又要有client_data数组users_timer，又要有http_conn数组users，它们各自作用是啥"></a>为什么又要有client_data数组users_timer，又要有http_conn数组users，它们各自作用是啥</h2><p>先来解释下这个问题，当时在分析WebServer.cpp代码时候发现有两个下标都是通过fd来访问的数组</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_FD<span class="token operator">=</span><span class="token number">65536</span><span class="token punctuation">;</span><span class="token comment">//最大文件描述符</span>
client_data<span class="token operator">*</span> users_timer<span class="token operator">=</span><span class="token keyword">new</span> client_data<span class="token punctuation">[</span>MAX_FD<span class="token punctuation">]</span><span class="token punctuation">;</span>
http_conn<span class="token operator">*</span> users<span class="token operator">=</span><span class="token keyword">new</span> http_conn<span class="token punctuation">[</span>MAX_FD<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>而问题就是为什么要有这两个东西，换个意思是他们各自的作用是啥呢？</p>
<p>首先对于http_conn来说，它是描述每个客户端fd的连接对象，每个对象又包括当前客户端请求状态（如请求报文数据，读还是写等），因此需要开个http_conn类型的数组来存储多个连接对象</p>
<p>再看到client_data数组，它本身是一个结构体，结构如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//连接资源</span>
<span class="token keyword">struct</span> <span class="token class-name">client_data</span><span class="token punctuation">&#123;</span>
    
    <span class="token comment">//客户端socket地址</span>
    sockaddr_in addreess<span class="token punctuation">;</span>

    <span class="token comment">//socket文件描述符</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>

    <span class="token comment">//定时器</span>
    util_timer<span class="token operator">*</span> timer<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>每个连接资源可以记录一个定时器，所以这个client_data数组就是记录给连接进来的客户端附加一个定时器的作用</p>
<h2 id="接受到请求时怎么知道用户访问网页的哪个界面"><a href="#接受到请求时怎么知道用户访问网页的哪个界面" class="headerlink" title="接受到请求时怎么知道用户访问网页的哪个界面"></a>接受到请求时怎么知道用户访问网页的哪个界面</h2><p>在http_conn.cpp中的<code>do_request()</code>就有判断，是通过判断浏览器发送过来的报文中<code>&lt;form action=0&gt;</code>这个action值来确定的，在这个服务器中3是注册操作，2是登录操作、0是注册界面、1是登录界面、5、6、7分别是图片、视频、关注界面</p>
<p>下面拿注册界面为例：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//如果请求资源为/0，表示跳转注册界面</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> m_url_real<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span><span class="token string">"/register.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//将网站目录和/register.html进行拼接，更新到m_real_file中</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url_real<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> m_url_real<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="服务器是怎么将静态资源文件传输给客户端的"><a href="#服务器是怎么将静态资源文件传输给客户端的" class="headerlink" title="服务器是怎么将静态资源文件传输给客户端的"></a>服务器是怎么将静态资源文件传输给客户端的</h2><p>其实访问静态资源也是和上面访问网页那样，如果识别的标志action都不是服务器中给定的标志，那就是访问静态资源请求，也是通过io向量然后writev()给客户端实现静态资源传输</p>
<p>需要注意：必须将静态资源文件属性中的<code>其它</code>设为：<code>只读</code>或<code>读写</code>权限，否则客户端时访问不了的</p>
<h2 id="项目中的Reactor和Proactor模式如何体现"><a href="#项目中的Reactor和Proactor模式如何体现" class="headerlink" title="项目中的Reactor和Proactor模式如何体现"></a>项目中的Reactor和Proactor模式如何体现</h2><p>Reactor：epoll检测到读和写事件时候都会把请求添加到请求队列，让工作线程来完成读写数据、接受新连接等操作</p>
<p>Proactor：主线程从当异步线程，处理好读写事件后再添加到请求队列让工作线程发送数据</p>
<p>下面是知乎上大神给出的答案</p>
<blockquote>
<p>以Proactor模式为例的工作流程即是：主线程充当异步线程，负责监听所有socket上的事件</p>
<p>若有新请求到来，主线程接收之以得到新的连接socket，然后往epoll内核事件表中注册该socket上的读写事件</p>
<p>如果连接socket上有读写事件发生，主线程从socket上接收数据，并将数据封装成请求对象插入到请求队列中</p>
<p>所有工作线程睡眠在请求队列上，当有任务到来时，通过竞争（如互斥锁）获得任务的接管权</p>
<p><strong>Reactor、Proactor模型的区别？</strong></p>
<p><strong>Reactor模式</strong>：要求主线程（I/O处理单元）只负责监听文件描述符上是否有事件发生（可读、可写），若有，则立即通知工作线程，将socket可读可写事件放入请求队列，<strong>读写数据、接受新连接及处理客户请求均在工作线程中完成。(需要区别读和写事件)</strong></p>
<p><strong>Proactor模式</strong>：主线程和内核负责处理读写数据、接受新连接等<strong>I/O操作</strong>，<strong>工作线程仅负责业务逻辑（给予相应的返回URL）</strong>，如处理客户请求。</p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Sakura.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/">http://sakura-pub.top/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%9D%A2%E8%AF%95/">面试</a><a class="post-meta__tags" href="/tags/WebServer/">WebServer</a><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a></div><div class="post_share"><div class="social-share" data-image="https://pic.rmb.bdstatic.com/bjh/39c69a365c6f2c263d521ff2b80a1efd.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/%E9%9D%A2%E8%AF%95/%E8%B7%B3%E8%A1%A8%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/"><img class="prev-cover" src="https://pic.rmb.bdstatic.com/bjh/adbd1980ce8a7eeaf880b7bbdf574dfb.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">跳表项目总结</div></div></a></div><div class="next-post pull-right"><a href="/%E9%9D%A2%E8%AF%95/C++%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/"><img class="next-cover" src="https://img30.360buyimg.com/pop/jfs/t1/143950/1/26833/298507/61ea0bf4E4b3dfa6e/cba671ea7f81ef12.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">C++知识点总结</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/面试/SakuraServer项目/" title="SakuraServer项目"><img class="cover" src="https://p6-tt.byteimg.com/origin/pgc-image/85a708e60c5d4418b51f9c64f6bf058a.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-07</div><div class="title">SakuraServer项目</div></div></a></div><div><a href="/面试/C++集群聊天服务器（正式内容篇）/" title="C++集群聊天服务器（正式内容篇）"><img class="cover" src="https://pic.rmb.bdstatic.com/bjh/5c2c84703a1bba59b28ba5819bf00b1e.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-17</div><div class="title">C++集群聊天服务器（正式内容篇）</div></div></a></div><div><a href="/面试/进程间通信/" title="进程间通信"><img class="cover" src="https://pic.rmb.bdstatic.com/bjh/ffd91bf2df53f05f2a1335acb23ae44f.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-14</div><div class="title">进程间通信</div></div></a></div><div><a href="/面试/暑假冲刺秋招项目-C++集群聊天服务器（预备知识篇）/" title="暑假冲刺秋招项目--C++集群聊天服务器（预备知识篇）"><img class="cover" src="https://pic.rmb.bdstatic.com/bjh/d488e66d13da478d5eab285e068bdcd3.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-16</div><div class="title">暑假冲刺秋招项目--C++集群聊天服务器（预备知识篇）</div></div></a></div><div><a href="/面试/C++-集群聊天服务器（优化篇）/" title="C++集群聊天服务器（优化篇）"><img class="cover" src="https://pic.rmb.bdstatic.com/bjh/f4a9fb349489af60d0af1b1ccfca71fe.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-24</div><div class="title">C++集群聊天服务器（优化篇）</div></div></a></div><div><a href="/面试/C++-集群聊天服务器（细节问题篇）/" title="C++集群聊天服务器（细节问题篇）"><img class="cover" src="https://p.qlogo.cn/hy_personal/3e28f14aa0516842cca4bda79cde803eb27dc704e582549a4cc8c5dea1360098/0.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-02</div><div class="title">C++集群聊天服务器（细节问题篇）</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://i.loli.net/2021/11/01/ilJyOSYrF7m4M3X.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Sakura.</div><div class="author-info__description">升起的烟花,从下面看?还是从侧面看?</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">47</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">8</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">7</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/KiritoZz6"><i class="fab fa-github"></i><span>关注我</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/KiritoZz6" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/sakura_zz@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">欢迎来到我的个人博客！如果对文章有问题或者发现错误可以发邮件给我，Email：sakura_zz@163.com</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#WebServer%E6%80%BB%E4%BD%93%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">WebServer总体概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WebServer%E5%A4%A7%E6%A6%82%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">WebServer大概的工作流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%8D%8A%E5%8F%8D%E5%BA%94%E5%A0%86%EF%BC%88%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%8D%8A%E5%BC%82%E6%AD%A5%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">半同步半反应堆（半同步半异步）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.2.</span> <span class="toc-text">多进程模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.3.</span> <span class="toc-text">多线程模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proactor%E6%A8%A1%E5%BC%8F%E5%92%8CReactor%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.4.</span> <span class="toc-text">Proactor模式和Reactor模式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%A7%E7%AB%AF%E5%BA%8F%E5%B0%8F%E7%AB%AF%E5%BA%8F"><span class="toc-number">4.</span> <span class="toc-text">大端序小端序</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTP%E7%9B%B8%E5%85%B3"><span class="toc-number">5.</span> <span class="toc-text">HTTP相关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E6%AC%A1HTTP%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">5.1.</span> <span class="toc-text">一次HTTP请求响应的流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP%E6%96%B9%E6%B3%95"><span class="toc-number">5.2.</span> <span class="toc-text">HTTP方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GET%E3%80%81POST%E5%8C%BA%E5%88%AB"><span class="toc-number">5.3.</span> <span class="toc-text">GET、POST区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E7%A0%81"><span class="toc-number">5.4.</span> <span class="toc-text">状态码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTPS"><span class="toc-number">5.5.</span> <span class="toc-text">HTTPS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E4%B8%8E-HTTPS-%E6%9C%89%E5%93%AA%E4%BA%9B%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">5.5.1.</span> <span class="toc-text">HTTP 与 HTTPS 有哪些区别？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTPS-%E9%87%87%E2%BD%A4%E7%9A%84%E6%98%AF%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E5%92%8C%E2%BE%AE%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E7%BB%93%E5%90%88%E7%9A%84%E3%80%8C%E6%B7%B7%E5%90%88%E5%8A%A0%E5%AF%86%E3%80%8D%E2%BD%85%E5%BC%8F%EF%BC%9A"><span class="toc-number">5.5.2.</span> <span class="toc-text">HTTPS 采⽤的是对称加密和⾮对称加密结合的「混合加密」⽅式：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8BHTTP-1-HTTP-2-HTTP-3%E7%9A%84%E5%8F%91%E5%B1%95%E5%90%A7"><span class="toc-number">5.5.3.</span> <span class="toc-text">介绍一下HTTP&#x2F;1 HTTP&#x2F;2 HTTP&#x2F;3的发展吧</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%B7%B1%E5%AF%B9%E9%A1%B9%E7%9B%AE%E7%9A%84%E8%A7%A3%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">自己对项目的解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#main-cpp"><span class="toc-number">6.1.</span> <span class="toc-text">main.cpp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WebServer%E7%B1%BB"><span class="toc-number">6.2.</span> <span class="toc-text">WebServer类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WebServer-h"><span class="toc-number">6.2.1.</span> <span class="toc-text">WebServer.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebServer-cpp"><span class="toc-number">6.2.2.</span> <span class="toc-text">WebServer.cpp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E7%B1%BB"><span class="toc-number">6.3.</span> <span class="toc-text">日志类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#log-h"><span class="toc-number">6.3.1.</span> <span class="toc-text">log.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#log-cpp"><span class="toc-number">6.3.2.</span> <span class="toc-text">log.cpp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#block-queue-h"><span class="toc-number">6.3.3.</span> <span class="toc-text">block_queue.h</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">6.4.</span> <span class="toc-text">数据库连接池</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sql-connection-pool-h"><span class="toc-number">6.4.1.</span> <span class="toc-text">sql_connection_pool.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sql-connection-pool-cpp"><span class="toc-number">6.4.2.</span> <span class="toc-text">sql_connection_pool.cpp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">6.5.</span> <span class="toc-text">线程池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-number">6.6.</span> <span class="toc-text">定时器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E8%B5%84%E6%BA%90%E2%80%94%E7%BB%93%E6%9E%84%E4%BD%93client-date"><span class="toc-number">6.6.1.</span> <span class="toc-text">连接资源—结构体client_date</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%99%A8%E7%B1%BB%E2%80%94util-timer"><span class="toc-number">6.6.2.</span> <span class="toc-text">定时器类—util_timer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%99%A8%E5%AE%B9%E5%99%A8%E7%B1%BB%E2%80%94sort-timer-lst"><span class="toc-number">6.6.3.</span> <span class="toc-text">定时器容器类—sort_timer_lst</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E7%B1%BBUtils"><span class="toc-number">6.6.4.</span> <span class="toc-text">工具类Utils</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http-conn%E7%B1%BB"><span class="toc-number">6.7.</span> <span class="toc-text">http_conn类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E4%B8%AA%E4%B8%8D%E5%B1%9E%E4%BA%8E%E7%B1%BB%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0"><span class="toc-number">6.7.1.</span> <span class="toc-text">四个不属于类成员函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%A4%E4%B8%AA%E5%88%9D%E5%A7%8B%E5%8C%96init"><span class="toc-number">6.7.2.</span> <span class="toc-text">两个初始化init()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E5%AF%BC%E5%85%A5%E8%B4%A6%E6%88%B7%E5%AF%86%E7%A0%81%E5%88%B0%E5%93%88%E5%B8%8C%E8%A1%A8%E4%B8%AD"><span class="toc-number">6.7.3.</span> <span class="toc-text">从数据库中导入账户密码到哈希表中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#read-once-%E5%87%BD%E6%95%B0"><span class="toc-number">6.7.4.</span> <span class="toc-text">read_once()函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#warning-%E5%A4%84%E7%90%86http%E6%8A%A5%E6%96%87%E8%AF%B7%E6%B1%82%E4%B8%8E%E6%8A%A5%E6%96%87%E5%93%8D%E5%BA%94%E2%80%94-gt-process"><span class="toc-number">6.7.5.</span> <span class="toc-text">:warning:处理http报文请求与报文响应—&gt;process()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E7%8A%B6%E6%80%81%E6%9C%BA%E2%80%94process-read-%E4%BB%A5%E5%8F%8A%E8%A7%A3%E6%9E%90%E5%A4%B4%E9%83%A8%E3%80%81%E8%A7%A3%E6%9E%90%E8%AF%B7%E6%B1%82%E8%A1%8C%E3%80%81%E8%A7%A3%E6%9E%90%E6%B6%88%E6%81%AF%E4%BD%93"><span class="toc-number">6.7.6.</span> <span class="toc-text">主状态机—process_read()以及解析头部、解析请求行、解析消息体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E7%8A%B6%E6%80%81%E6%9C%BA%E2%80%94parse-line"><span class="toc-number">6.7.7.</span> <span class="toc-text">从状态机—parse_line()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#do-request-%E5%87%BD%E6%95%B0"><span class="toc-number">6.7.8.</span> <span class="toc-text">do_request()函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%93%8D%E5%BA%94%E6%8A%A5%E6%96%87%E2%80%94%E7%94%A8%E4%BA%86IO%E5%90%91%E9%87%8F%E6%9C%BA%E5%88%B6"><span class="toc-number">6.7.9.</span> <span class="toc-text">生成响应报文—用了IO向量机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-number">6.7.9.1.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%93%8D%E5%BA%94%E6%8A%A5%E6%96%87%E5%87%BD%E6%95%B0"><span class="toc-number">6.7.9.2.</span> <span class="toc-text">添加响应报文函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E5%93%8D%E5%BA%94%E6%8A%A5%E6%96%87%E2%80%94http-conn-write"><span class="toc-number">6.7.10.</span> <span class="toc-text">发送响应报文—http_conn::write()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%89%E5%BE%85%E6%9F%A5%E8%AF%A2%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">7.</span> <span class="toc-text">有待查询的问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%B7%B1%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">8.</span> <span class="toc-text">自己的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%81%E6%8A%8A%E8%AF%B7%E6%B1%82%E6%94%BE%E5%85%A5%E4%BA%86%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%AD"><span class="toc-number">8.1.</span> <span class="toc-text">谁把请求放入了线程池中</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%81%E8%B0%83%E7%94%A8%E4%BA%86worker"><span class="toc-number">8.2.</span> <span class="toc-text">谁调用了worker()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%88%E8%A6%81%E6%9C%89client-data%E6%95%B0%E7%BB%84users-timer%EF%BC%8C%E5%8F%88%E8%A6%81%E6%9C%89http-conn%E6%95%B0%E7%BB%84users%EF%BC%8C%E5%AE%83%E4%BB%AC%E5%90%84%E8%87%AA%E4%BD%9C%E7%94%A8%E6%98%AF%E5%95%A5"><span class="toc-number">8.3.</span> <span class="toc-text">为什么又要有client_data数组users_timer，又要有http_conn数组users，它们各自作用是啥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%97%E5%88%B0%E8%AF%B7%E6%B1%82%E6%97%B6%E6%80%8E%E4%B9%88%E7%9F%A5%E9%81%93%E7%94%A8%E6%88%B7%E8%AE%BF%E9%97%AE%E7%BD%91%E9%A1%B5%E7%9A%84%E5%93%AA%E4%B8%AA%E7%95%8C%E9%9D%A2"><span class="toc-number">8.4.</span> <span class="toc-text">接受到请求时怎么知道用户访问网页的哪个界面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%B0%86%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84"><span class="toc-number">8.5.</span> <span class="toc-text">服务器是怎么将静态资源文件传输给客户端的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84Reactor%E5%92%8CProactor%E6%A8%A1%E5%BC%8F%E5%A6%82%E4%BD%95%E4%BD%93%E7%8E%B0"><span class="toc-number">8.6.</span> <span class="toc-text">项目中的Reactor和Proactor模式如何体现</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/%E9%9D%A2%E8%AF%95/SakuraServer%E9%A1%B9%E7%9B%AE/" title="SakuraServer项目"><img src="https://p6-tt.byteimg.com/origin/pgc-image/85a708e60c5d4418b51f9c64f6bf058a.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SakuraServer项目"/></a><div class="content"><a class="title" href="/%E9%9D%A2%E8%AF%95/SakuraServer%E9%A1%B9%E7%9B%AE/" title="SakuraServer项目">SakuraServer项目</a><time datetime="2022-09-07T14:09:31.000Z" title="Created 2022-09-07 22:09:31">2022-09-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E9%9D%A2%E8%AF%95/C++-%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E7%BB%86%E8%8A%82%E9%97%AE%E9%A2%98%E7%AF%87%EF%BC%89/" title="C++集群聊天服务器（细节问题篇）"><img src="https://p.qlogo.cn/hy_personal/3e28f14aa0516842cca4bda79cde803eb27dc704e582549a4cc8c5dea1360098/0.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++集群聊天服务器（细节问题篇）"/></a><div class="content"><a class="title" href="/%E9%9D%A2%E8%AF%95/C++-%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E7%BB%86%E8%8A%82%E9%97%AE%E9%A2%98%E7%AF%87%EF%BC%89/" title="C++集群聊天服务器（细节问题篇）">C++集群聊天服务器（细节问题篇）</a><time datetime="2022-09-02T02:41:04.000Z" title="Created 2022-09-02 10:41:04">2022-09-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E9%9D%A2%E8%AF%95/C++-%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E4%BC%98%E5%8C%96%E7%AF%87%EF%BC%89/" title="C++集群聊天服务器（优化篇）"><img src="https://pic.rmb.bdstatic.com/bjh/f4a9fb349489af60d0af1b1ccfca71fe.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++集群聊天服务器（优化篇）"/></a><div class="content"><a class="title" href="/%E9%9D%A2%E8%AF%95/C++-%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E4%BC%98%E5%8C%96%E7%AF%87%EF%BC%89/" title="C++集群聊天服务器（优化篇）">C++集群聊天服务器（优化篇）</a><time datetime="2022-07-24T15:10:26.000Z" title="Created 2022-07-24 23:10:26">2022-07-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E9%9D%A2%E8%AF%95/C++%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E6%AD%A3%E5%BC%8F%E5%86%85%E5%AE%B9%E7%AF%87%EF%BC%89/" title="C++集群聊天服务器（正式内容篇）"><img src="https://pic.rmb.bdstatic.com/bjh/5c2c84703a1bba59b28ba5819bf00b1e.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++集群聊天服务器（正式内容篇）"/></a><div class="content"><a class="title" href="/%E9%9D%A2%E8%AF%95/C++%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E6%AD%A3%E5%BC%8F%E5%86%85%E5%AE%B9%E7%AF%87%EF%BC%89/" title="C++集群聊天服务器（正式内容篇）">C++集群聊天服务器（正式内容篇）</a><time datetime="2022-07-17T03:56:18.000Z" title="Created 2022-07-17 11:56:18">2022-07-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E9%9D%A2%E8%AF%95/%E6%9A%91%E5%81%87%E5%86%B2%E5%88%BA%E7%A7%8B%E6%8B%9B%E9%A1%B9%E7%9B%AE-C++%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86%E7%AF%87%EF%BC%89/" title="暑假冲刺秋招项目--C++集群聊天服务器（预备知识篇）"><img src="https://pic.rmb.bdstatic.com/bjh/d488e66d13da478d5eab285e068bdcd3.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="暑假冲刺秋招项目--C++集群聊天服务器（预备知识篇）"/></a><div class="content"><a class="title" href="/%E9%9D%A2%E8%AF%95/%E6%9A%91%E5%81%87%E5%86%B2%E5%88%BA%E7%A7%8B%E6%8B%9B%E9%A1%B9%E7%9B%AE-C++%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86%E7%AF%87%EF%BC%89/" title="暑假冲刺秋招项目--C++集群聊天服务器（预备知识篇）">暑假冲刺秋招项目--C++集群聊天服务器（预备知识篇）</a><time datetime="2022-07-16T06:38:33.000Z" title="Created 2022-07-16 14:38:33">2022-07-16</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Sakura.</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'uoCtAtvANzWpqnPNGCNRPK7g-gzGzoHsz',
      appKey: 'NIjj8lYmojE9cbwXtTlGUh6F',
      placeholder: '记得留下你的昵称和邮箱....可以快速收到回复',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer src="/live2d-widget/autoload.js"></script><script src="/cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>