<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>WebServer项目解析 | 🌸樱花酒吧🍻</title><meta name="keywords" content="面试,WebServer,项目"><meta name="author" content="Sakura."><meta name="copyright" content="Sakura."><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="这篇文章是用来记录并复习之前写过的一个TinyWebServer项目，希望可以梳理一下思路，更进一步吸收里面的知识点，前面几个部分是网上找的知识点总结，后面也有自己对项目的分析 WebServer总体概述 epoll 的 ET和LT模式 MySQL数据库 数据库连接池 线程池 日志系统 定时器 Reactor模式（设计模式：反应堆模式） HTTP 大端序和小端序的互转 读写缓冲区  WebServ">
<meta property="og:type" content="article">
<meta property="og:title" content="WebServer项目解析">
<meta property="og:url" content="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name" content="🌸樱花酒吧🍻">
<meta property="og:description" content="这篇文章是用来记录并复习之前写过的一个TinyWebServer项目，希望可以梳理一下思路，更进一步吸收里面的知识点，前面几个部分是网上找的知识点总结，后面也有自己对项目的分析 WebServer总体概述 epoll 的 ET和LT模式 MySQL数据库 数据库连接池 线程池 日志系统 定时器 Reactor模式（设计模式：反应堆模式） HTTP 大端序和小端序的互转 读写缓冲区  WebServ">
<meta property="og:locale">
<meta property="og:image" content="https://pic.rmb.bdstatic.com/bjh/39c69a365c6f2c263d521ff2b80a1efd.png">
<meta property="article:published_time" content="2022-06-15T05:43:43.000Z">
<meta property="article:modified_time" content="2022-06-27T12:13:22.289Z">
<meta property="article:author" content="Sakura.">
<meta property="article:tag" content="面试">
<meta property="article:tag" content="WebServer">
<meta property="article:tag" content="项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.rmb.bdstatic.com/bjh/39c69a365c6f2c263d521ff2b80a1efd.png"><link rel="shortcut icon" href="/img/0.png"><link rel="canonical" href="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'WebServer项目解析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-06-27 20:13:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="https://sakura-pub.ltd/css/Sakura.css"><link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="🌸樱花酒吧🍻" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://i.loli.net/2021/11/01/ilJyOSYrF7m4M3X.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">40</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 目录</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类目录</span></a></li><li><a class="site-page child" href="/LeetCode/LeetCode%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%9C%9F/"><i class="fa-fw fas-archive"></i><span> LeetCode刷题笔记</span></a></li><li><a class="site-page child" href="/categories/%E8%AE%B0%E4%BA%8B/"><span> 记事</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/%E8%AE%B0%E4%BA%8B/%E5%85%B3%E4%BA%8E%E6%88%91/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pic.rmb.bdstatic.com/bjh/39c69a365c6f2c263d521ff2b80a1efd.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">🌸樱花酒吧🍻</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 目录</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类目录</span></a></li><li><a class="site-page child" href="/LeetCode/LeetCode%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%9C%9F/"><i class="fa-fw fas-archive"></i><span> LeetCode刷题笔记</span></a></li><li><a class="site-page child" href="/categories/%E8%AE%B0%E4%BA%8B/"><span> 记事</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/%E8%AE%B0%E4%BA%8B/%E5%85%B3%E4%BA%8E%E6%88%91/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">WebServer项目解析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-06-15T05:43:43.000Z" title="Created 2022-06-15 13:43:43">2022-06-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-06-27T12:13:22.289Z" title="Updated 2022-06-27 20:13:22">2022-06-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%A2%E8%AF%95/%E9%A1%B9%E7%9B%AE/">项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="WebServer项目解析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>这篇文章是用来记录并复习之前写过的一个TinyWebServer项目，希望可以梳理一下思路，更进一步吸收里面的知识点，前面几个部分是网上找的知识点总结，后面也有自己对项目的分析</p>
<h1 id="WebServer总体概述"><a href="#WebServer总体概述" class="headerlink" title="WebServer总体概述"></a>WebServer总体概述</h1><ul>
<li>epoll 的 <code>ET</code>和<code>LT</code>模式</li>
<li>MySQL数据库</li>
<li>数据库连接池</li>
<li>线程池</li>
<li>日志系统</li>
<li>定时器</li>
<li>Reactor模式（设计模式：反应堆模式）</li>
<li>HTTP</li>
<li>大端序和小端序的互转</li>
<li>读写缓冲区</li>
</ul>
<h1 id="WebServer大概的工作流程"><a href="#WebServer大概的工作流程" class="headerlink" title="WebServer大概的工作流程"></a>WebServer大概的工作流程</h1><p>这里有张图可以概括整个Server的工作流程</p>
<p><img src="https://pic.rmb.bdstatic.com/bjh/0af1379f52f5a695800cfb33599035fa.jpeg" alt="v2-c16b9b3c7c2e279227204a88fc95d1bb_r.jpg"></p>
<p>分点来说如下：</p>
<ol>
<li>主线程监听连接</li>
<li>主线程让一个epoll监听活跃的文件描述符</li>
<li>处理完连接进来的文件描述符之后开工作线程</li>
<li>工作线程处理任务（读和写任务是分开的，不一定是同一个线程共同操作）</li>
<li>http_conn是一个负责HTTP请求的响应和处理的类，一个用户一个实例；同时在解析请求报文时有主从状态机，从状态机是负责读取报文的一行，主状态机是负责对该行数据进行解析</li>
</ol>
<h1 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h1><p>对于服务器的效率，这里有几个方面可以来优化</p>
<h2 id="半同步半反应堆（半同步半异步）"><a href="#半同步半反应堆（半同步半异步）" class="headerlink" title="半同步半反应堆（半同步半异步）"></a>半同步半反应堆（半同步半异步）</h2><ul>
<li>半同步半反应堆是其中一种高效的并发模式实现方式，另一种并发模式为领导者/追随者模式</li>
<li>并发模式指的是I/O处理单元和多个逻辑单元之间协调完成任务的方法</li>
<li>半同步/半反应堆的内容：<ul>
<li>异步线程只有一个，由主线程充当。负责监听所有socket上的事件。如果有新连接请求，主线程接受得到新的连接socket，往epoll内核事件表中注册socket上的读写事件。如果连接上有读写事件，主线程将该连接socket插入请求队列。所有工作线程（同步线程）睡眠在请求队列上，当有任务到来，通过竞争的方式获得任务管理权。</li>
<li>上面的方式采用的事件处理模式为<strong>Reactor模式</strong>。要求工作线程自己从socket上读取客户请求和往socket上写入服务器应答。</li>
<li>也可以采用模拟的<strong>Proactor事件</strong>处理模式。要求主线程完成数据的读写，主线程将应用程序数据、任务类型等信息封装成一个任务对象，然后插入请求队列；工作线程从请求队列中取得任务对象后，直接处理即可，不需要读写操作。</li>
</ul>
</li>
<li>半同步/半反应堆的缺点：<ul>
<li>主线程和工作线程共享请求队列。主线程添加任务、工作线程取出任务，都需要对请求队列进行加锁保护，从而耗费cpu时间。</li>
<li>每个工作线程同一个时间只能处理一个客户请求</li>
</ul>
</li>
</ul>
<h2 id="多进程模型"><a href="#多进程模型" class="headerlink" title="多进程模型"></a>多进程模型</h2><ul>
<li>为每个客户端分配一个进程来处理请求。</li>
<li>服务器的主进程负责监听客户的连接，一旦与客户端连接完成，accept() 函数就会返回一个「已连接 Socket」，这时就通过 <code>fork()</code> 函数创建一个子进程，实际上就把父进程所有相关的东西都<strong>复制</strong>一份，包括文件描述符、内存地址空间、程序计数器、执行的代码等。<ul>
<li>根据返回值来区分是父进程还是子进程，如果返回值是 0，则是子进程；如果返回值是其他的整数，就是父进程。    <ul>
<li>因为子进程会<strong>复制父进程的文件描述符</strong>，于是就可以直接使用「已连接 Socket 」和客户端通信了。 </li>
<li>子进程不需要关心「监听 Socket」，只需要关心「已连接 Socket」；父进程则相反，将客户服务交给子进程来处理，因此父进程不需要关心「已连接 Socket」，只需要关心「监听 Socket」。 </li>
</ul>
</li>
</ul>
</li>
<li>可能出现的问题：<ul>
<li>当「子进程」退出时，实际上内核里还会保留该进程的一些信息，也是会占用内存的，如果不做好“回收”工作，就会变成僵尸进程，随着僵尸进程越多，会慢慢耗尽我们的系统资源。    <ul>
<li>父进程要“善后”好自己的孩子，怎么善后呢？那么有两种方式可以在子进程退出后回收资源，分别是调用 <code>wait()</code> 和 <code>waitpid()</code> 函数。 </li>
<li>进程的上下文切换不仅包含了虚拟内存、栈、全局变量等用户空间的资源，还包括了内核堆栈、寄存器等内核空间的资源。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="多线程模型"><a href="#多线程模型" class="headerlink" title="多线程模型"></a>多线程模型</h2><ul>
<li>线程是运行在进程中的一个“逻辑流”，单进程中可以运行多个线程，同进程里的线程可以共享进程的部分资源的，比如<strong>文件描述符列表、进程空间、代码、全局数据、堆、共享库等，这些共享资源</strong>在上下文切换时是不需要切换，而只需要切换线程的<strong>私有数据、寄存器等不共享的数据</strong>，因此同一个进程下的线程上下文切换的开销要比进程小得多。 </li>
<li>当服务器与客户端 TCP 完成连接后，通过 <code>pthread_create()</code> 函数创建线程，然后将「已连接 Socket」的文件描述符传递给线程函数，接着在线程里和客户端进行通信，从而达到并发处理的目的。 </li>
<li>注意事项 ： <ul>
<li>父进程accept后会把socket放入一个队列。然后线程从这个队列中取socket做操作 </li>
<li>这个队列是全局的，每个线程都会操作，为了避免多线程竞争，线程在操作这个队列前要加锁。</li>
</ul>
</li>
</ul>
<h2 id="Proactor模式和Reactor模式"><a href="#Proactor模式和Reactor模式" class="headerlink" title="Proactor模式和Reactor模式"></a>Proactor模式和Reactor模式</h2><p>服务器程序通常需要处理三类事件：I/O事件，信号及定时事件。有两种事件处理模式即<strong>Proactor模式</strong>和<strong>Reactor模式</strong>：</p>
<ul>
<li>Reactor模式：要求主线程（I/O处理单元）只负责监听文件描述符上是否有事件发生（可读、可写），若有，则立即通知工作线程（逻辑单元），将socket可读可写事件放入请求队列，交给工作线程处理。</li>
<li>Proactor模式：将所有的I/O操作都交给主线程和内核来处理（进行读、写），工作线程仅负责处理逻辑，如主线程读完成后<code>users[sockfd].read()</code>，选择一个工作线程来处理客户请求<code>pool-&gt;append(users + sockfd)</code>。</li>
</ul>
<p>有关更详细的介绍，可以点<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/26943938">这里</a></p>
<p>下面为项目中运用了两个模式的代码：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">deal_with_thread</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    util_timer<span class="token operator">*</span> timer<span class="token operator">=</span>users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>

    <span class="token comment">//reactor模式</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_actormodel<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
            <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//若监测到读事件，将该事件放入请求队列</span>
        m_pool<span class="token operator">-></span><span class="token function">append</span><span class="token punctuation">(</span>users<span class="token operator">+</span>sockfd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token comment">//while</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//proactor</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"deal with the client(%s)"</span><span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//若监测到读事件，将该事件放入请求队列</span>
            m_pool<span class="token operator">-></span><span class="token function">append_p</span><span class="token punctuation">(</span>users<span class="token operator">+</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
                <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
            <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="大端序小端序"><a href="#大端序小端序" class="headerlink" title="大端序小端序"></a>大端序小端序</h1><p><strong>网络序是大端字节序</strong></p>
<p><strong>大端字节序</strong>是看着一样的，数据低位存在内存大位(高位)</p>
<p>小端字节序看着是反过来的，数据低位存在内存小位(低位)</p>
<p>字节序的单位应该是字节，所以string(char为组织结构)是没有大小端之分的。</p>
<p>但是看int和short是能看出来是大端字节序还是小端字节序，借助union。</p>
<p>有现成的转换函数。BSD Socket提供了封装好的转换接口，方便程序员使用。包括从主机字节序到网络字节序的转换函数： htons、htonl；从网络字节序到主机字节序的转换函数：ntohs、ntohl。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/**
* h   - host 主机，主机字节序
* to  - 转换成什么
* n   - network  网络字节序
* s   - short  unsigned short 
* l   - long  unsigned int
**/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="HTTP相关"><a href="#HTTP相关" class="headerlink" title="HTTP相关"></a>HTTP相关</h1><h2 id="一次HTTP请求响应的流程"><a href="#一次HTTP请求响应的流程" class="headerlink" title="一次HTTP请求响应的流程"></a>一次HTTP请求响应的流程</h2><ul>
<li>域名解析 </li>
<li>发起TCP的3次握手 </li>
<li>建立TCP连接后发起http请求 </li>
<li>服务器响应http请求，浏览器得到html代码 </li>
<li>浏览器解析html代码，并请求html代码中的资源（如js、css、图片等） </li>
<li>浏览器对页面进行渲染呈现给用户 </li>
</ul>
<h2 id="HTTP方法"><a href="#HTTP方法" class="headerlink" title="HTTP方法"></a>HTTP方法</h2><ul>
<li>GET：用于请求访问已经被URI（统一资源标识符）识别的资源，可以通过URL传参给服务器 </li>
<li>POST：用于传输信息给服务器，主要功能与GET方法类似，但一般推荐使用POST方式。 </li>
<li>PUT：传输文件，报文主体中包含文件内容，保存到对应URI位置。 </li>
<li>HEAD：获得豹纹不，与GET类似，只是不返回报文主体，一般用于验证URI是否有效。 </li>
<li>DELETE：删除文件，与PUT相反，删除对应URI位置文件。 </li>
<li>OPTIONS：查询相应URI支持的HTTP方法。 </li>
</ul>
<h2 id="GET、POST区别"><a href="#GET、POST区别" class="headerlink" title="GET、POST区别"></a>GET、POST区别</h2><ul>
<li><p>get重点在从服务器上获取资源；</p>
</li>
<li><p>post重点在向服务器发送数据；</p>
</li>
<li><p>get传输数据是通过URL请求，以field（字段）= value的形式，置于URL后，并用”?”连接，多个请求数据间用”&amp;”连接，如<code>http://127.0.0.1/Test/login.action?name=admin&amp;password=admin</code>，这个过程用户是可见的； </p>
</li>
<li><p>post传输数据通过Http的post机制，将字段与对应值封存在请求实体中发送给服务器，这个过程对用户是不可见的； </p>
</li>
<li><p>Get传输的数据量小，因为受URL长度限制，但效率较高； </p>
</li>
<li><p>Post可以传输大量数据，所以上传文件时只能用Post方式； </p>
</li>
<li><p>get是不安全的，因为URL是可见的，可能会泄露私密信息，如密码等； </p>
</li>
<li><p>post较get安全性较高； </p>
</li>
<li><p>get方式只能支持ASCII字符，向服务器传的中文字符可能会乱码。 </p>
</li>
<li><p>post支持标准字符集，可以正确传递中文字符。 </p>
</li>
</ul>
<h2 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h2><ul>
<li><p>1xx：指示信息–表示请求已接收，继续处理 </p>
</li>
<li><p>2xx：成功–表示请求已被成功接收、理解、接受   </p>
<ul>
<li><strong>200</strong>：请求被正常处理 </li>
<li>204：请求被受理但没有资源可以返回 </li>
<li>206：客户端只是请求资源的一部分，服务器只对请求的部分资源执行GET方法，相应报文中通过Content-Range指定范围的资源。 </li>
</ul>
</li>
<li><p>3xx：重定向–要完成请求必须进行更进一步的操作   </p>
<ul>
<li><strong>301</strong>：永久性重定向 </li>
<li><strong>302</strong>：临时重定向 </li>
<li>303：与302状态码有相似功能，只是它希望客户端在请求一个URI的时候，能通过GET方法重定向到另一个URI上 </li>
<li>304：发送附带条件的请求时，条件不满足时返回，与重定向无关 </li>
<li>307：临时重定向，与302类似，只是强制要求使用POST方法 </li>
</ul>
</li>
<li><p>4xx：客户端错误–请求有语法错误或请求无法实现   </p>
<ul>
<li><strong>400：</strong>请求报文语法有误，服务器无法识别 </li>
<li>401：请求需要认证 </li>
<li><strong>403</strong>：请求的对应资源禁止被访问 </li>
<li><strong>404</strong>：服务器无法找到对应资源 </li>
</ul>
</li>
<li><p>5xx：服务器端错误–服务器未能实现合法的请求  </p>
<ul>
<li><strong>500：</strong>服务器内部错误 </li>
<li><strong>503：</strong>服务器正忙 </li>
</ul>
</li>
</ul>
<h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><h3 id="HTTP-与-HTTPS-有哪些区别？"><a href="#HTTP-与-HTTPS-有哪些区别？" class="headerlink" title="HTTP 与 HTTPS 有哪些区别？"></a>HTTP 与 HTTPS 有哪些区别？</h3><ol>
<li>HTTP 是超⽂本传输协议，信息是明⽂传输，存在安全⻛险的问题。HTTPS 则解决 HTTP 不安全的缺陷，在 TCP 和 HTTP ⽹络层之间加⼊了 SSL/TLS 安全协议，使得报⽂能够加密传输。 </li>
<li>HTTP 连接建⽴相对简单， TCP 三次握⼿之后便可进⾏ HTTP 的报⽂传输。⽽ HTTPS 在 TCP 三次握⼿之后，还需进⾏ SSL/TLS 的握⼿过程，才可进⼊加密报⽂传输。 </li>
<li>HTTP 的端⼝号是 80，HTTPS 的端⼝号是 443。 </li>
<li>HTTPS 协议需要向 CA（证书权威机构）申请数字证书，来保证服务器的身份是可信的。 </li>
</ol>
<h3 id="HTTPS-采⽤的是对称加密和⾮对称加密结合的「混合加密」⽅式："><a href="#HTTPS-采⽤的是对称加密和⾮对称加密结合的「混合加密」⽅式：" class="headerlink" title="HTTPS 采⽤的是对称加密和⾮对称加密结合的「混合加密」⽅式："></a>HTTPS 采⽤的是对称加密和⾮对称加密结合的「混合加密」⽅式：</h3><ul>
<li>在通信建⽴前采⽤⾮对称加密的⽅式交换「会话秘钥」，后续就不再使⽤⾮对称加密。 </li>
<li>在通信过程中全部使⽤对称加密的「会话秘钥」的⽅式加密明⽂数据。 </li>
</ul>
<p>采⽤「混合加密」的⽅式的原因：</p>
<ul>
<li>对称加密只使⽤⼀个密钥，运算速度快，密钥必须保密，⽆法做到安全的密钥交换。 </li>
<li>⾮对称加密使⽤两个密钥：公钥和私钥，公钥可以任意分发⽽私钥保密，解决了密钥交换问题但速度慢。 </li>
</ul>
<h3 id="介绍一下HTTP-1-HTTP-2-HTTP-3的发展吧"><a href="#介绍一下HTTP-1-HTTP-2-HTTP-3的发展吧" class="headerlink" title="介绍一下HTTP/1 HTTP/2 HTTP/3的发展吧"></a>介绍一下HTTP/1 HTTP/2 HTTP/3的发展吧</h3><ul>
<li><p>技术的发展都是为了解决某些问题 </p>
</li>
<li><p>HTTP/1的问题是<strong>短链接每次都需要三握四挥</strong>、<strong>不安全</strong>（HTTPs）、无状态（Cookie）、<strong>服务端不能主动发送</strong>。(核心，1.0短连接 1.1可以长连接 不安全) </p>
</li>
<li><p>HTTP/2默认了长连接（Keep-Alive）、<strong>引入TLS/SSL</strong>、Cookie、服务端主动发送、头部压缩、多路复用。但是还有<strong>队头阻塞</strong>的问题（因为虽然进行了长连接，但是还有一种情况会出现队头阻塞，那就是 丢失重传）。(核心 队头阻塞 ssl cookie) </p>
</li>
<li><p>HTTP/3使用<strong>UDP解决了丢失重传导致的队头阻塞</strong>，并且使用了TLS/SSL1.3减少了建立HTTPs连接的时间到1.5-2个RTT（往返时间），还引入了二进制编码，其他细节忘记了。 </p>
</li>
<li><p>提前将资源推送到浏览器 </p>
</li>
<li><p>推送可以基于已发送的请求，例如客户端请求 <code>html</code>，服务端可以主动推送 <code>js</code>、<code>css</code> 文件</p>
</li>
</ul>
<h1 id="自己对项目的解析"><a href="#自己对项目的解析" class="headerlink" title="自己对项目的解析"></a>自己对项目的解析</h1><p>这里是自己再次对项目的解析，也当做一个复习作用。按照模块来解析</p>
<h2 id="main-cpp"><a href="#main-cpp" class="headerlink" title="main.cpp"></a>main.cpp</h2><p>在主函数中，先是解析启动服务器时附加的参数，并将参数行解析，接着在创建服务器对象以及服务器初始化，启动各个模块</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"config.h"</span></span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">"runed."</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
    <span class="token comment">//Log::get_instance()->write_log(1,"%s","server is running");</span>
    <span class="token comment">//需要修改的数据库信息,登录名,密码,库名</span>
    string user <span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">;</span>
    string passwd <span class="token operator">=</span> <span class="token string">"61053208"</span><span class="token punctuation">;</span>
    string databasename <span class="token operator">=</span> <span class="token string">"yourdb"</span><span class="token punctuation">;</span>

    <span class="token comment">//命令行解析</span>
    Config config<span class="token punctuation">;</span>
    config<span class="token punctuation">.</span><span class="token function">parse_arg</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    WebServer server<span class="token punctuation">;</span>

    <span class="token comment">//初始化</span>
    server<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>PORT<span class="token punctuation">,</span> user<span class="token punctuation">,</span> passwd<span class="token punctuation">,</span> databasename<span class="token punctuation">,</span> config<span class="token punctuation">.</span>LOGWrite<span class="token punctuation">,</span> 
                config<span class="token punctuation">.</span>OPT_LINGER<span class="token punctuation">,</span> config<span class="token punctuation">.</span>TRIGMode<span class="token punctuation">,</span>  config<span class="token punctuation">.</span>sql_num<span class="token punctuation">,</span>  config<span class="token punctuation">.</span>thread_num<span class="token punctuation">,</span> 
                config<span class="token punctuation">.</span>close_log<span class="token punctuation">,</span> config<span class="token punctuation">.</span>actor_model<span class="token punctuation">)</span><span class="token punctuation">;</span>
cout<span class="token operator">&lt;&lt;</span><span class="token string">"init\n"</span><span class="token punctuation">;</span>

    <span class="token comment">//日志</span>
    server<span class="token punctuation">.</span><span class="token function">log_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cout<span class="token operator">&lt;&lt;</span><span class="token string">"log_write\n"</span><span class="token punctuation">;</span>
    <span class="token comment">//数据库</span>
    server<span class="token punctuation">.</span><span class="token function">sql_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cout<span class="token operator">&lt;&lt;</span><span class="token string">"sql_pool\n"</span><span class="token punctuation">;</span>
    <span class="token comment">//线程池</span>
    server<span class="token punctuation">.</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cout<span class="token operator">&lt;&lt;</span><span class="token string">"thread_pool\n"</span><span class="token punctuation">;</span>
    <span class="token comment">//触发模式</span>
    server<span class="token punctuation">.</span><span class="token function">trig_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cout<span class="token operator">&lt;&lt;</span><span class="token string">"trig_mode\n"</span><span class="token punctuation">;</span>
    <span class="token comment">//监听</span>
    server<span class="token punctuation">.</span><span class="token function">eventListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cout<span class="token operator">&lt;&lt;</span><span class="token string">"eventlisten\n"</span><span class="token punctuation">;</span>
    <span class="token comment">//运行</span>
    server<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>    
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="WebServer类"><a href="#WebServer类" class="headerlink" title="WebServer类"></a>WebServer类</h2><p>一个webserver对象包含着</p>
<ol>
<li>数据库连接池指针、数据库名称、登录数据库的账号密码等信息，数据库连接数量</li>
<li>线程池指针<code>thread&lt;http_conn&gt;* m_pool</code>，线程数量</li>
<li><code>epoll_event</code>数组，数组大小为<code>MAX_EVENT_NUMBER</code>、套接字fd<code>m_listenfd</code>以及一些模式设置的参数</li>
<li>定时器相关的<code>client_data*</code>指针，这是连接资源的结构体，定时器在这个结构体里面；还有一个应该是操作类<code>Utils</code></li>
<li>基础数据中则包含<code>http_conn* users</code>连接数组、管道、epollfd、端口号、root文件目录地址、日志开关、actor模式记录等数据</li>
</ol>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">WebServer</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">WebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">WebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//服务器初始化函数</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span>string user<span class="token punctuation">,</span>string passWord<span class="token punctuation">,</span>string databaseName<span class="token punctuation">,</span>
            <span class="token keyword">int</span> log_write<span class="token punctuation">,</span><span class="token keyword">int</span> opt_linger<span class="token punctuation">,</span><span class="token keyword">int</span> trigmode<span class="token punctuation">,</span><span class="token keyword">int</span> sql_num<span class="token punctuation">,</span>
            <span class="token keyword">int</span> thread_num<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">,</span><span class="token keyword">int</span> actor_model<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">sql_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">log_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">trig_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">eventListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调整定时器</span>
    <span class="token keyword">void</span> <span class="token function">deal_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">,</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理定时器</span>
    <span class="token keyword">bool</span> <span class="token function">deal_clinet_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理客户端数据</span>
    <span class="token keyword">bool</span> <span class="token function">deal_with_signal</span><span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token operator">&amp;</span> timeout<span class="token punctuation">,</span><span class="token keyword">bool</span><span class="token operator">&amp;</span> stop_server<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理信号</span>
    <span class="token keyword">void</span> <span class="token function">deal_with_thread</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理线程</span>
    <span class="token keyword">void</span> <span class="token function">deal_with_write</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">//基础数据</span>

    <span class="token keyword">int</span> m_port<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> m_root<span class="token punctuation">;</span><span class="token comment">//记录root文件目录</span>
    <span class="token keyword">int</span> m_log_write<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_close_log<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_actormodel<span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> m_pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_epollfd<span class="token punctuation">;</span>
    http_conn<span class="token operator">*</span> users<span class="token punctuation">;</span>


    <span class="token comment">//数据库相关</span>

    connection_pool<span class="token operator">*</span> m_connPool<span class="token punctuation">;</span><span class="token comment">//数据库连接池</span>
    string m_user<span class="token punctuation">;</span><span class="token comment">//登录数据库账号</span>
    string m_passWord<span class="token punctuation">;</span><span class="token comment">//登录数据库密码</span>
    string m_databaseName<span class="token punctuation">;</span><span class="token comment">//数据库名称</span>
    <span class="token keyword">int</span> m_sql_num<span class="token punctuation">;</span>

    <span class="token comment">//线程池相关</span>

    threadpool<span class="token operator">&lt;</span>http_conn<span class="token operator">></span><span class="token operator">*</span> m_pool<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_thread_num<span class="token punctuation">;</span>

    <span class="token comment">//epoll_event相关</span>

    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> m_listenfd<span class="token punctuation">;</span><span class="token comment">//套接字fd</span>
    <span class="token keyword">int</span> m_OPT_LINGER<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_TRIGMode<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_LISTENTrigmode<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_CONNTrigmode<span class="token punctuation">;</span>

    <span class="token comment">//定时器相关</span>

    client_data<span class="token operator">*</span> users_timer<span class="token punctuation">;</span>
    Utils utils<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">//class WebServer</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="日志类"><a href="#日志类" class="headerlink" title="日志类"></a>日志类</h2><p>日志里面依赖一个容器，这个容器是循环数组实现的阻塞队列，最后在输出时则会判断是否异步操作（通过变量<code>m_is_async</code>来记录），如果是异步操作，则将日志体打入阻塞队列中；若不是异步则直接输出<code>fputs()</code>，阻塞队列采用FIFO原则；有条件变量，有锁用到</p>
<ol>
<li>如果设置了<code>max_queue_size</code>，即<code>max_queue_size&gt;0</code>则为异步，循环数组作为缓冲区队列，通过<code>push</code>存放日志消息体（实际类型为<code>string</code>）</li>
<li>阻塞队列的<code>pop</code>是出队，并返回最前面的消息体，若队列为空，则条件变量会进行阻塞等待唤醒</li>
<li>有个专门的异步写日志方法==&gt;<code>void* async_write_log()</code>；这个方法实现在 log.h 头文件中，它不断循环并pop出阻塞队列，提取一个string类型的消息体并打印输出，直到阻塞队列为空</li>
</ol>
<p>代码如下：</p>
<h3 id="log-h"><a href="#log-h" class="headerlink" title="log.h"></a>log.h</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/**
 * log.h头文件
 *
 * !同步/异步日志系统头文件
===============

同步/异步日志系统主要涉及了两个模块，一个是日志模块，一个是阻塞队列模块,
其中加入阻塞队列模块主要是解决异步写入日志做准备.
阻塞队列见：block_queue.h

> * 自定义阻塞队列
> * 单例模式创建日志
> * 同步日志
> * 异步日志
> * 实现按天、超行分类
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LOG_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOG_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../log/block_queue.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">Log</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">/**获取单例
     * 
     * 由于C++11及以后的版本中要求编译器保证内部静态变量的线程安全性
     * 故这里使用的局部变量懒汉模式是线程安全的，并且不用加锁
     */</span>
    <span class="token keyword">static</span> Log<span class="token operator">*</span> <span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">static</span> Log instance<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>instance<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//异步写日志公有方法，调用私有方法async_write_log</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">flush_log_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">async_write_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//可选择的参数有日志文件、日志缓冲区大小、最大行数以及日志最长日志条队列</span>
    <span class="token keyword">bool</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file_name<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">,</span> <span class="token keyword">int</span> log_buf_size <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">,</span> <span class="token keyword">int</span> split_lines <span class="token operator">=</span> <span class="token number">5000000</span><span class="token punctuation">,</span> <span class="token keyword">int</span> max_queue_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//将输出内容按照标准格式整理</span>
    <span class="token keyword">void</span> <span class="token function">write_log</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//强制刷新缓冲区</span>
    <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//异步写日志方法</span>
    <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">async_write_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        std<span class="token operator">::</span>string single_log<span class="token punctuation">;</span>
        <span class="token comment">//从阻塞队列中取出一个日志string，写入文件</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>m_log_queue<span class="token operator">-></span><span class="token function">pop</span><span class="token punctuation">(</span>single_log<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fputs</span><span class="token punctuation">(</span>single_log<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">char</span> dir_name<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//路径名</span>
    <span class="token keyword">char</span> log_name<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//log文件名</span>
    <span class="token keyword">int</span> m_split_lines<span class="token punctuation">;</span><span class="token comment">//日志最大行数</span>
    <span class="token keyword">int</span> m_log_buf_size<span class="token punctuation">;</span><span class="token comment">//日志缓冲区大小</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> m_count<span class="token punctuation">;</span><span class="token comment">//日志行数记录</span>
    <span class="token keyword">int</span> m_today<span class="token punctuation">;</span><span class="token comment">//由于日志是按天分类的，这个就记录当前时间是哪一天</span>
    FILE <span class="token operator">*</span>m_fp<span class="token punctuation">;</span><span class="token comment">//打开log文件的文件指针</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>m_buf<span class="token punctuation">;</span><span class="token comment">//当前指向log内容的字符指针，即要输出的内容</span>
    block_queue<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">></span> <span class="token operator">*</span>m_log_queue<span class="token punctuation">;</span><span class="token comment">//阻塞队列</span>
    <span class="token keyword">bool</span> m_is_async<span class="token punctuation">;</span><span class="token comment">//记录是否同步标志</span>
    locker m_mutex<span class="token punctuation">;</span><span class="token comment">//同步类</span>
    <span class="token keyword">int</span> m_close_log<span class="token punctuation">;</span> <span class="token comment">//是否关闭日志</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 

<span class="token comment">//调试信息相关</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_DEBUG</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_INFO</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_WARN</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_ERROR</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//LOG_H</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="log-cpp"><a href="#log-cpp" class="headerlink" title="log.cpp"></a>log.cpp</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//log.cpp</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ctime></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdarg></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../log/log.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>

<span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_is_async<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">Log</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_fp<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//异步需要设置阻塞队列的长度，同步不需要</span>
<span class="token keyword">bool</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file_name<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">,</span> <span class="token keyword">int</span> log_buf_size <span class="token punctuation">,</span> <span class="token keyword">int</span> split_lines <span class="token punctuation">,</span> <span class="token keyword">int</span> max_queue_size <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//如果设置了max_queue_size，则设为异步</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>max_queue_size<span class="token operator">>=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//设置写入方式flag</span>
        m_is_async<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token comment">//创建并设置阻塞队列</span>
        m_log_queue <span class="token operator">=</span> <span class="token keyword">new</span> block_queue<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">></span><span class="token punctuation">(</span>max_queue_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        pthread_t tid<span class="token punctuation">;</span>

        <span class="token comment">//flush_log_thread为回调函数，表示创建线程异步写日志</span>
        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>flush_log_thread<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//输出内容长度</span>
    m_close_log<span class="token operator">=</span>close_log<span class="token punctuation">;</span>
    m_log_buf_size<span class="token operator">=</span>log_buf_size<span class="token punctuation">;</span>
    m_buf<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>m_log_buf_size<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>m_buf<span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">,</span>m_log_buf_size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化缓冲区</span>
    m_split_lines<span class="token operator">=</span>split_lines<span class="token punctuation">;</span><span class="token comment">//日志的最大行数</span>

    <span class="token comment">//初始化时间相关变量</span>
    time_t t<span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span><span class="token operator">*</span> sys_tm<span class="token operator">=</span><span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span> my_tm<span class="token operator">=</span><span class="token operator">*</span>sys_tm<span class="token punctuation">;</span>

    <span class="token comment">//从后往前找第一个‘/‘的位置</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> p<span class="token operator">=</span><span class="token function">strrchr</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//该函数返回 str 中最后一次出现字符 c 的位置。如果未找到该值，则函数返回一个空指针。</span>
    <span class="token keyword">char</span> log_full_name<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    
    <span class="token comment">//相当于自定义日志名</span>
    <span class="token comment">//若输入的文件名没有‘/’，则直接将事件+文件名作为日志名</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//* %02d中的0为填空元素，即如果不满2个字符则用'0'填上剩余的</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>log_full_name<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token string">"%d_%02d_%02d_%s"</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//? 将‘/’的位置向后移动一个位置，然后复制到logname中</span>
        <span class="token comment">//? p-file_name+1时文件所在路径文件夹的长度</span>
        <span class="token comment">//* dir_name相当于‘./’</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>log_name<span class="token punctuation">,</span> p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>dir_name<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> p <span class="token operator">-</span> file_name <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">snprintf</span><span class="token punctuation">(</span>log_full_name<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token string">"%s%d_%02d_%02d_%s"</span><span class="token punctuation">,</span> dir_name<span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">,</span> log_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    

    <span class="token keyword">this</span><span class="token operator">-></span>m_today<span class="token operator">=</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">;</span>

    <span class="token comment">//*打开文件，以附加的方式打开只写文件。若文件不存在，则会创建该文件；如果文件存在，则写入的数据会被加到文件尾后，即文件原先的内容会被保留（EOF 符保留）</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span>log_full_name<span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * 写入日志函数：
 * 日志写入前会判断当前day是否为创建日志的时间，行数是否超过最大行限制
 *      *若为创建日志时间，写入日志，否则按当前时间创建新log，更新创建时间和行数
 *      *若行数超过最大行限制，在当前日志的末尾加count/max_lines为后缀创建新的log
 */</span>
<span class="token keyword">void</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> now<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取当天是几号 </span>
    time_t t<span class="token operator">=</span>now<span class="token punctuation">.</span>tv_sec<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span><span class="token operator">*</span> sys_tm<span class="token operator">=</span><span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span> my_tm<span class="token operator">=</span><span class="token operator">*</span>sys_tm<span class="token punctuation">;</span>
    <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    

    <span class="token comment">/**
     * 日志分级处理：
     *      *Debug，调试代码时输出
     *      *Warn，调试时发出警告
     *      *Info，报告系统当前的状态，当前执行的流程或接受到的信息等
     *      *Error和Fatal，输出系统的错误信息
     */</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[debug]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[info]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[warn]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[error]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[info]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">//写一个log，对m_count++，m_split_lines最大行数</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//更新现有行数</span>
    
    <span class="token comment">//日志不是今天或写入的行数时最大行的倍数</span>
    <span class="token comment">//m_split_lines 是最大行数</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_today<span class="token operator">!=</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token operator">||</span><span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">%</span><span class="token keyword">this</span><span class="token operator">-></span>m_split_lines<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span> new_log<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> tail<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        
        <span class="token comment">//格式化日志名中的部分</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>tail<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"%d_%02d_%02d_"</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_year<span class="token operator">+</span><span class="token number">1900</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_mon<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果时间不是今天，则创建当天的日志，并更新m_today和m_count</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>m_today<span class="token operator">!=</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token function">snprintf</span><span class="token punctuation">(</span>new_log<span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token string">"%s%s%s"</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>dir_name<span class="token punctuation">,</span>tail<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>log_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>m_today<span class="token operator">=</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//超过了最大行，在之前的日志名基础上加上后缀count/max_lines</span>
            <span class="token function">snprintf</span><span class="token punctuation">(</span>new_log<span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token string">"%s%s%s.%lld"</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>dir_name<span class="token punctuation">,</span>tail<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>log_name<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">/</span><span class="token keyword">this</span><span class="token operator">-></span>m_split_lines<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span>new_log<span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token comment">//end if</span>
    
    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//VA_LIST 是在C语言中解决变参问题的一组宏，所在头文件：#include &lt;stdarg.h>，用于获取不确定个数的参数。</span>
    va_list valst<span class="token punctuation">;</span>
    <span class="token comment">//将传入的format参数赋值给alst，便于格式化输出</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>valst<span class="token punctuation">,</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    std<span class="token operator">::</span>string log_str<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//写入内容格式：时间+内容</span>
    <span class="token comment">//时间格式化，snprintf()成功返回写字符的总数，其中不包括结尾的null字符</span>
    <span class="token keyword">int</span> n<span class="token operator">=</span><span class="token function">snprintf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token string">"%d-%02d-%02d %02d:%02d:%02d.%06ld %s "</span><span class="token punctuation">,</span>
                    my_tm<span class="token punctuation">.</span>tm_year<span class="token operator">+</span><span class="token number">1900</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_mon<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">,</span>
                    my_tm<span class="token punctuation">.</span>tm_hour<span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_min<span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_sec<span class="token punctuation">,</span>now<span class="token punctuation">.</span>tv_usec<span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//内容格式化，用于字符串打印数据、数据格式用户自定义，返回写入到字符数组中的字符个数（不包含终止符）</span>
    <span class="token keyword">int</span> m<span class="token operator">=</span><span class="token function">vsnprintf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token operator">+</span>n<span class="token punctuation">,</span>m_log_buf_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>format<span class="token punctuation">,</span>valst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token punctuation">[</span>n<span class="token operator">+</span>m<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\n'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token punctuation">[</span>n<span class="token operator">+</span>m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>

    log_str<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//* 同步异步检测</span>
    <span class="token comment">//如果m_is_async为true表示为异步，否则默认为同步</span>
    <span class="token comment">//若为异步，则将日志信息加入到阻塞队列，同步则加锁向文件中写</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_is_async <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-></span>m_log_queue<span class="token operator">-></span><span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//异步且队列不为空</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_log_queue<span class="token operator">-></span><span class="token function">push</span><span class="token punctuation">(</span>log_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fputs</span><span class="token punctuation">(</span>log_str<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">va_end</span><span class="token punctuation">(</span>valst<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="block-queue-h"><a href="#block-queue-h" class="headerlink" title="block_queue.h"></a>block_queue.h</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*************************************************************
*循环数组实现的阻塞队列，m_back = (m_back + 1) % m_max_size;  
*线程安全，每个操作前都要先加互斥锁，操作完后，再解锁
**************************************************************/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">BLOCK_QUEUE_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BLOCK_QUEUE_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../lock/locker.h"</span></span>

<span class="token comment">/**用循环数组实现的阻塞队列封装类 */</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">block_queue</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">block_queue</span><span class="token punctuation">(</span><span class="token keyword">int</span> max_size<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>max_size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//处理异常值</span>
			<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"阻塞队列初始大小参数小于等于0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		m_array <span class="token operator">=</span> <span class="token keyword">new</span> T<span class="token punctuation">[</span>max_size<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//动态分配数组</span>

		<span class="token comment">//私有属性初始化</span>
		m_max_size <span class="token operator">=</span> max_size<span class="token punctuation">;</span>
		m_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		m_front <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		m_back <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//?清除队内元素</span>
	<span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上锁</span>

		m_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		m_front <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		m_back <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解锁</span>
	<span class="token punctuation">&#125;</span>

	<span class="token operator">~</span><span class="token function">block_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//销毁数组</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>m_array<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
			<span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m_array<span class="token punctuation">;</span>

		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//判断队列是否满了</span>
	<span class="token keyword">bool</span> <span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">>=</span><span class="token keyword">this</span><span class="token operator">-></span>m_max_size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//判断队列是否为空</span>
	<span class="token keyword">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/**获取队列内的队首元素：
	 * 接受一个引用参数value
	 * 如果获取队首元素成功，则返回true，并且value会被修改为队首元素
	 * 否则返回false
	 */</span>
	<span class="token keyword">bool</span> <span class="token function">front</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//队列为空，false</span>
			m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		value <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_front<span class="token punctuation">]</span><span class="token punctuation">;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/**获取队列内的队尾元素：
	 * 接受一个引用参数value
	 * 如果获取队尾元素成功，则返回true，并且value会被修改为队尾元素
	 * 否则返回false
	 */</span>
	<span class="token keyword">bool</span> <span class="token function">back</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		value <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_back<span class="token punctuation">]</span><span class="token punctuation">;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//返回队列现有元素个数</span>
	<span class="token keyword">int</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		temp <span class="token operator">=</span> m_size<span class="token punctuation">;</span>

		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> temp<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">int</span> <span class="token function">max_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		temp <span class="token operator">=</span> m_max_size<span class="token punctuation">;</span>

		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> temp<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/**往队列添加元素，需要将所有使用队列的线程先唤醒
	 * 当有元素push进队列时，相当于生产者生产了一个元素
	 * 若当前没有线程等待条件变量，则唤醒无意义
	 */</span>
	<span class="token keyword">bool</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">const</span> T<span class="token operator">&amp;</span> item<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//?作用还是有些不懂</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">>=</span>m_max_size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			m_cond<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		m_back <span class="token operator">=</span> <span class="token punctuation">(</span>m_back <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> m_max_size<span class="token punctuation">;</span><span class="token comment">//队尾元素往后移动</span>
		m_array<span class="token punctuation">[</span>m_back<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>

		m_size<span class="token operator">++</span><span class="token punctuation">;</span>

		m_cond<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//pop时，如果当前队列没有元素，则进入等待条件变量</span>
    <span class="token comment">//同时遵循队列的FIFO原则，出来的是队头元素，并会把该元素赋值给引用参数item</span>
	<span class="token keyword">bool</span> <span class="token function">pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> item<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>m_size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//队列元素为空</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_cond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>m_mutex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
				m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>

		m_front <span class="token operator">=</span> <span class="token punctuation">(</span>m_front <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> m_max_size<span class="token punctuation">;</span>
		item <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_front<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token operator">--</span>m_size<span class="token punctuation">;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//重载pop，增加了超时处理</span>
	<span class="token comment">//第二个参数输入最长等待毫秒</span>
	<span class="token keyword">bool</span> <span class="token function">pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> item<span class="token punctuation">,</span><span class="token keyword">int</span> ms_timeout<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">struct</span> <span class="token class-name">timespec</span> t <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">timeval</span> now <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			t<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> now<span class="token punctuation">.</span>tv_sec <span class="token operator">+</span> ms_timeout <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span><span class="token comment">//秒</span>
			t<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> <span class="token punctuation">(</span>ms_timeout <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span><span class="token comment">//微秒</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_cond<span class="token punctuation">.</span><span class="token function">timewait</span><span class="token punctuation">(</span>m_mutex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
				m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		m_front <span class="token operator">=</span> <span class="token punctuation">(</span>m_front <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> m_max_size<span class="token punctuation">;</span>
		item <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_front<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token operator">--</span>m_size<span class="token punctuation">;</span>
		
		m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	locker m_mutex<span class="token punctuation">;</span><span class="token comment">//互斥锁</span>
	cond m_cond<span class="token punctuation">;</span><span class="token comment">//条件变量</span>

	T <span class="token operator">*</span>m_array<span class="token punctuation">;</span><span class="token comment">//队列</span>
	<span class="token keyword">int</span> m_size<span class="token punctuation">;</span><span class="token comment">//当前队列元素个数</span>
	<span class="token keyword">int</span> m_max_size<span class="token punctuation">;</span><span class="token comment">//队列最大容量</span>
	<span class="token keyword">int</span> m_front<span class="token punctuation">;</span><span class="token comment">//队头元素</span>
	<span class="token keyword">int</span> m_back<span class="token punctuation">;</span><span class="token comment">//队尾元素</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//BLOCK_QUEUE_H</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h2 id="数据库连接池"><a href="#数据库连接池" class="headerlink" title="数据库连接池"></a>数据库连接池</h2><p>数据库连接池采用了单例模式，整个连接池也是遵循FIFO原则</p>
<ol>
<li>数据库连接池可以在程序初始化的时候，集中创建多个数据库连接<code>MYSQL*</code>，并放入连接池当中集中管理</li>
<li>数据库连接池的操作优化了一般访问数据库的操作（频繁创建连接==&gt;操作数据库==&gt;断开连接）</li>
<li>连接池的容器类为：标准库中的链表<code>list</code>，其声明为<code>list&lt;MYSQL*&gt; connList;</code></li>
<li>有个信号量<code>sem reserve</code>在连接池初始化完毕时会将自身的值设置为最大连接数：this-&gt;reserve=sem(this-&gt;m_FreeConn);</li>
<li>初始化时，会创建自定义数目的<strong>MYSQL*</strong>在链表中，并逐个MYSQL*进行初始化连接，即：<code>con=mysql_init(con);</code>和<code>con=mysql_real_connect(con,url.c_str(),User.c_str(),PassWord.c_str(),DatabaseName.c_str(),Port,NULL,0);</code></li>
<li>取出连接操作<code>MYSQL* GetConnection(); //获取数据库连接</code>：实际是对链表进行<code>pop_front()</code>，同时该函数会返回一个MYSQL*；若连接池无空闲连接，则会因为信号量代码reserve.wait()而等待阻塞，等待有空闲连接时再唤醒</li>
<li>释放之前取出的连接<code>bool ReleaseConnection(MYSQL* con); //释放连接</code>：会要求<strong>把前面获取连接得到的MYSQ*作为参数传入</strong>该函数中，并进行再次push添加到链表尾部（连接重复利用）</li>
<li>亮点之一：运用了RAII类机制，在构造RAII类对象时会自动获取数据库连接，在析构RAII类对象时会自动将连接归还，代码如下👇</li>
</ol>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">connectionRAII<span class="token operator">::</span><span class="token function">connectionRAII</span><span class="token punctuation">(</span>MYSQL<span class="token operator">*</span><span class="token operator">*</span> SQL<span class="token punctuation">,</span>connection_pool<span class="token operator">*</span> connPool<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>SQL<span class="token operator">=</span>connPool<span class="token operator">-></span><span class="token function">GetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token operator">-></span>conRAII<span class="token operator">=</span><span class="token operator">*</span>SQL<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>poolRAII<span class="token operator">=</span>connPool<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">connectionRAII</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">connectionRAII</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>poolRAII<span class="token operator">-></span><span class="token function">ReleaseConnection</span><span class="token punctuation">(</span>conRAII<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>详细代码如下：</p>
<h3 id="sql-connection-pool-h"><a href="#sql-connection-pool-h" class="headerlink" title="sql_connection_pool.h"></a>sql_connection_pool.h</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_CONNECTION_POOL_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_CONNECTION_POOL_</span></span>

<span class="token comment">//*该头文件是数据库连接池的头文件</span>
<span class="token comment">//!头文件完成但还未检查</span>

<span class="token comment">//?👇数据库连接池是什么？👇</span>
<span class="token comment">//?数据库连接池可以在程序初始化的时候，集中创建多个数据库连接，并把他们集中管理，供程序使用</span>
<span class="token comment">//?优化了一般访问数据库的（频繁创建连接--操作数据库--断开连接）模式</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mysql/mysql.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;error.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../lock/locker.h"</span> <span class="token comment">//互斥锁</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../log/log.h"</span> <span class="token comment">//日志</span></span>

<span class="token keyword">using</span> std<span class="token operator">::</span>string<span class="token punctuation">;</span>

<span class="token comment">//数据库连接池</span>
<span class="token keyword">class</span> <span class="token class-name">connection_pool</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>string url<span class="token punctuation">,</span>string User<span class="token punctuation">,</span>string PassWord<span class="token punctuation">,</span>string DataBaseName<span class="token punctuation">,</span><span class="token keyword">int</span> Port<span class="token punctuation">,</span><span class="token keyword">int</span> MaxConn<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">)</span><span class="token punctuation">;</span>
    MYSQL<span class="token operator">*</span> <span class="token function">GetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取数据库连接</span>
    <span class="token keyword">bool</span> <span class="token function">ReleaseConnection</span><span class="token punctuation">(</span>MYSQL<span class="token operator">*</span> con<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//释放连接</span>
    <span class="token keyword">int</span> <span class="token function">GetFreeConn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取连接</span>
    <span class="token keyword">void</span> <span class="token function">DestroyPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//销毁所有连接</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">//单例模式</span>
    <span class="token keyword">static</span> connection_pool<span class="token operator">*</span> <span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> m_MaxConn<span class="token punctuation">;</span> <span class="token comment">//最大连接数</span>
    <span class="token keyword">int</span> m_CurConn<span class="token punctuation">;</span> <span class="token comment">//当前已使用的连接数</span>
    <span class="token keyword">int</span> m_FreeConn<span class="token punctuation">;</span> <span class="token comment">//当前空闲的连接数</span>
    locker lock<span class="token punctuation">;</span>
    std<span class="token operator">::</span>list<span class="token operator">&lt;</span>MYSQL<span class="token operator">*</span><span class="token operator">></span> connList<span class="token punctuation">;</span>
    sem reserve<span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    string m_url<span class="token punctuation">;</span> <span class="token comment">//主机地址</span>
    string m_Port<span class="token punctuation">;</span> <span class="token comment">//数据库端口号</span>
    string m_User<span class="token punctuation">;</span> <span class="token comment">//登录数据库的用户名</span>
    string m_PassWord<span class="token punctuation">;</span> <span class="token comment">//登录数据库的密码</span>
    string m_DatabaseName<span class="token punctuation">;</span> <span class="token comment">//使用的数据库名</span>
    <span class="token keyword">int</span> m_close_log<span class="token punctuation">;</span> <span class="token comment">//日志开关</span>
    
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">//class connection_pool</span>

<span class="token comment">//*RAII机制类</span>
<span class="token keyword">class</span> <span class="token class-name">connectionRAII</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">connectionRAII</span><span class="token punctuation">(</span>MYSQL<span class="token operator">*</span><span class="token operator">*</span> con<span class="token punctuation">,</span>connection_pool<span class="token operator">*</span> connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">connectionRAII</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    MYSQL<span class="token operator">*</span> conRAII<span class="token punctuation">;</span>
    connection_pool<span class="token operator">*</span> poolRAII<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//_CONNECTION_POOL_</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="sql-connection-pool-cpp"><a href="#sql-connection-pool-cpp" class="headerlink" title="sql_connection_pool.cpp"></a>sql_connection_pool.cpp</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mysql/mysql.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../CGImysql/sql_connection_pool.h"</span></span>

<span class="token keyword">using</span> std<span class="token operator">::</span>string<span class="token punctuation">;</span>


connection_pool<span class="token operator">::</span><span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_CurConn<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">connection_pool</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">DestroyPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

connection_pool<span class="token operator">*</span> connection_pool<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//* 单例模式</span>
    <span class="token keyword">static</span> connection_pool connPool<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>connPool<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//构造初始化</span>
<span class="token keyword">void</span> connection_pool<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>string url<span class="token punctuation">,</span>string User<span class="token punctuation">,</span>string PassWord<span class="token punctuation">,</span>string DatabaseName<span class="token punctuation">,</span><span class="token keyword">int</span> Port<span class="token punctuation">,</span><span class="token keyword">int</span> MaxConn<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//初始化信息</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_url<span class="token operator">=</span>url<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_Port<span class="token operator">=</span>Port<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_User<span class="token operator">=</span>User<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_PassWord<span class="token operator">=</span>PassWord<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_DatabaseName<span class="token operator">=</span>DatabaseName<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_close_log<span class="token operator">=</span>close_log<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_MaxConn<span class="token operator">=</span>MaxConn<span class="token punctuation">;</span>

    
    <span class="token comment">//创建m_MaxConn条数据库连接</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>m_MaxConn<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        
        MYSQL<span class="token operator">*</span> con<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        con<span class="token operator">=</span><span class="token function">mysql_init</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span>con<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            std<span class="token operator">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"Error:"</span><span class="token operator">&lt;&lt;</span><span class="token function">mysql_error</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">'\n'</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        con<span class="token operator">=</span><span class="token function">mysql_real_connect</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span>url<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>User<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>PassWord<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>DatabaseName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>con<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            std<span class="token operator">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"Error:"</span><span class="token operator">&lt;&lt;</span><span class="token function">mysql_error</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">'\n'</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//更新连接池和空闲连接数</span>
        <span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">;</span>
        
    <span class="token punctuation">&#125;</span>

    
    <span class="token comment">//将信号量初始化为最大连接次数</span>
    <span class="token keyword">this</span><span class="token operator">-></span>reserve<span class="token operator">=</span><span class="token function">sem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token operator">-></span>m_MaxConn<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//获取空闲连接的数据库</span>
<span class="token comment">//* 当有请求时，从数据库连接池中返回一个可用的连接，更新和使用空闲连接数</span>
MYSQL<span class="token operator">*</span> connection_pool<span class="token operator">::</span><span class="token function">GetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    MYSQL<span class="token operator">*</span> con<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    

    <span class="token comment">//取出连接，信号量原子减1，为0则等待</span>
    reserve<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token operator">-></span>lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 上锁</span>
    con<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token operator">--</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">;</span>
    <span class="token operator">++</span><span class="token keyword">this</span><span class="token operator">-></span>m_CurConn<span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token operator">-></span>lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 开锁</span>
    <span class="token keyword">return</span> con<span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>

<span class="token comment">//释放当前使用的连接</span>
<span class="token keyword">bool</span> connection_pool<span class="token operator">::</span><span class="token function">ReleaseConnection</span><span class="token punctuation">(</span>MYSQL<span class="token operator">*</span> con<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>con<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">++</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">;</span>
    <span class="token operator">--</span><span class="token keyword">this</span><span class="token operator">-></span>m_CurConn<span class="token punctuation">;</span>

    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//释放连接原子加1</span>
    reserve<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//销毁数据库连接池</span>
<span class="token keyword">void</span> connection_pool<span class="token operator">::</span><span class="token function">DestroyPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//通过迭代器遍历，关闭数据库连接</span>
        std<span class="token operator">::</span>list<span class="token operator">&lt;</span>MYSQL<span class="token operator">*</span><span class="token operator">></span><span class="token operator">::</span>iterator it<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>it<span class="token operator">=</span>connList<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token operator">!=</span>connList<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>it<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            MYSQL<span class="token operator">*</span> con<span class="token operator">=</span><span class="token operator">*</span>it<span class="token punctuation">;</span>
            <span class="token function">mysql_close</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_CurConn<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>


        <span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
connectionRAII::connectionRAII(MYSQL** SQL,connection_pool* connPool)&#123;
    *SQL=connPool->GetConnection();
    
    this->conRAII=*SQL;
    this->poolRAII=connPool;
&#125;

connectionRAII::~connectionRAII()&#123;
    this->poolRAII->ReleaseConnection(conRAII);
&#125;
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><p>❗❗❗线程池中有存放线程的数组，数组中的线程是用来处理请求队列中的请求任务❗❗❗</p>
<ol>
<li><p>成员变量包含了：数据库连接池指针<code>connection_pool* m_connPool;</code>、描述线程池的数组<code>pthread_t* m_threads</code>、请求队列<code>std::list&lt;T*&gt; m_workqueue;（存放http_conn*）</code></p>
</li>
<li><p>初始化时，线程指针会构建数组==&gt;<code>m_threads=new pthread_t[m_thread_number];</code>，再进入for循环中逐个对数组成员用<code>pthread_create(pthread_t *tidp,const pthread_attr_t *attr,void *(*start_rtn)(void*),void *arg);</code>初始化，每个线程的运行函数都是<code>worker()</code>函数，传入参数<code>arg</code>为该线程池类对象指针<strong>this</strong></p>
</li>
<li><p>每个<code>pthread_create()</code>完毕后，又会将这个线程进行分离，即<code>pthread_detach()</code>，使得不用单独对工作线程进行回收</p>
</li>
<li><p>worker()函数内部则是将传入参数<code>void* arg</code>进行类型转换回<code>threadpool*</code>（线程池指针），接着调用指针的<code>run()</code>函数，所以<code>threadpool::run()</code>才是真正的<strong>执行任务函数</strong>👇</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//线程处理函数</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token comment">//将参数强制转换为线程池类，调用函数方法</span>
    threadpool<span class="token operator">*</span> pool<span class="token operator">=</span><span class="token punctuation">(</span>threadpool<span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
    pool<span class="token operator">-></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pool<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>run函数会判断<strong>actor模式</strong>，判断<strong>m_state</strong>以及判断**read_once()**，这几个都是在http_conn类里面，那么就可以推断出线程池的链表存放的数据是http_conn连接对象</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//run()</span>
<span class="token comment">//run执行任务</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">void</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-></span>m_stop<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//信号量等待</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_queuestat<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//被唤醒后先加上互斥锁</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_workqueue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//从请求队列中取出第一个任务</span>
        <span class="token comment">//将任务i从请求队列中删除</span>
        T<span class="token operator">*</span> request<span class="token operator">=</span>m_workqueue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_workqueue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>m_actor_model<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//判断actor模式，</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span>m_state<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//0为读，1为写</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                    connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token operator">-></span>mysql<span class="token punctuation">,</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    request<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                    request<span class="token operator">-></span>timer_flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                    request<span class="token operator">-></span>timer_flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token comment">//m_actor_model!=1</span>
            connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token operator">-></span>mysql<span class="token punctuation">,</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token comment">//actor_model</span>

    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<p>详细代码如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">THREADPOOL_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THREADPOOL_H</span></span>

<span class="token comment">//!该类是线程池类</span>
<span class="token comment">/**
 * !模板类的成员函数实现应该放在头文件中
 * !因为模板类本质上不是类，只有实例化之后才会编译生成.o文件
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;exception></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../lock/locker.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../CGImysql/sql_connection_pool.h"</span></span>

<span class="token comment">//!该线程池头文件已完成，但还没有检查</span>

<span class="token comment">//*线程池类</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">threadpool</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">/**
     * connPool是数据库连接池指针
     * max_requests是请求队列中最多允许的、等待处理的请求数量
     * thread_number是线程池中线程的数量
     */</span>
    <span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token keyword">int</span> actor_model<span class="token punctuation">,</span>connection_pool<span class="token operator">*</span> connPool<span class="token punctuation">,</span><span class="token keyword">int</span> thread_number<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token keyword">int</span> max_request<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//向请求队列中插入任务请求</span>
    <span class="token keyword">bool</span> <span class="token function">append_p</span><span class="token punctuation">(</span>T<span class="token operator">*</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">append</span><span class="token punctuation">(</span>T<span class="token operator">*</span> request<span class="token punctuation">,</span><span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">//工作线程运行函数</span>
    <span class="token comment">//它不断从工作队列中取出任务并执行</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token keyword">private</span><span class="token operator">:</span>

    <span class="token comment">//模型切换</span>
    <span class="token keyword">int</span> m_actor_model<span class="token punctuation">;</span>

    <span class="token comment">//线程池中的线程数</span>
    <span class="token keyword">int</span> m_thread_number<span class="token punctuation">;</span>

    <span class="token comment">//请求队列中允许的最大请求数</span>
    <span class="token keyword">int</span> m_max_requests<span class="token punctuation">;</span>

    <span class="token comment">//描述线程池的数组，大小为 m_thread_number</span>
    pthread_t<span class="token operator">*</span> m_threads<span class="token punctuation">;</span>

    <span class="token comment">//请求队列</span>
    std<span class="token operator">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">></span> m_workqueue<span class="token punctuation">;</span>

    <span class="token comment">//保护请求队列的互斥锁</span>
    locker m_queuelocker<span class="token punctuation">;</span>

    <span class="token comment">//是否有任务需要处理</span>
    sem m_queuestat<span class="token punctuation">;</span>

    <span class="token comment">//是否结束线程</span>
    <span class="token keyword">bool</span> m_stop<span class="token punctuation">;</span>

    <span class="token comment">//数据库连接池</span>
    connection_pool<span class="token operator">*</span> m_connPool<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token keyword">int</span> actor_model<span class="token punctuation">,</span>connection_pool<span class="token operator">*</span> connPool<span class="token punctuation">,</span><span class="token keyword">int</span> thread_number<span class="token punctuation">,</span><span class="token keyword">int</span> max_request<span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token function">m_thread_number</span><span class="token punctuation">(</span>thread_number<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_max_requests</span><span class="token punctuation">(</span>max_request<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_stop</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_connPool</span><span class="token punctuation">(</span>connPool<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_actor_model</span><span class="token punctuation">(</span>actor_model<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
    <span class="token comment">//传入参数异常处理</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>thread_number<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token operator">||</span>max_request<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//线程id初始化</span>
    <span class="token keyword">this</span><span class="token operator">-></span>m_threads<span class="token operator">=</span><span class="token keyword">new</span> pthread_t<span class="token punctuation">[</span>m_thread_number<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_threads<span class="token punctuation">)</span>

        <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>thread_number<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//循环创建线程，并将工作线程按照要求进行</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span>m_threads<span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>worker<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m_threads<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//将线程进行分离后，不用单独对工作线程进行回收</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">pthread_detach</span><span class="token punctuation">(</span>m_threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m_threads<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
threadpool<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">this</span><span class="token operator">-></span>m_threads<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//向请求队列中添加任务</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">bool</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">append_p</span><span class="token punctuation">(</span>T<span class="token operator">*</span> request<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//根据硬件，预先设置请求队列的最大值</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m_workqueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span>m_max_requests<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//添加任务</span>
    m_workqueue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//信号量提醒有任务要处理</span>
    m_queuestat<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">bool</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">append</span><span class="token punctuation">(</span>T <span class="token operator">*</span>request<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_workqueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> m_max_requests<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    request<span class="token operator">-></span>m_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    m_workqueue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_queuestat<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//线程处理函数</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token comment">//将参数强制转换为线程池类，调用函数方法</span>
    threadpool<span class="token operator">*</span> pool<span class="token operator">=</span><span class="token punctuation">(</span>threadpool<span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
    pool<span class="token operator">-></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pool<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">//run执行任务</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">void</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-></span>m_stop<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//信号量等待</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_queuestat<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//被唤醒后先加上互斥锁</span>
        <span class="token keyword">this</span><span class="token operator">-></span>m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_workqueue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//从请求队列中取出第一个任务</span>
        <span class="token comment">//将任务i从请求队列中删除</span>
        T<span class="token operator">*</span> request<span class="token operator">=</span>m_workqueue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_workqueue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>m_actor_model<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span>m_state<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//读为0，写为1</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                    connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token operator">-></span>mysql<span class="token punctuation">,</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    request<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                    request<span class="token operator">-></span>timer_flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                    request<span class="token operator">-></span>timer_flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token comment">//m_actor_model!=1</span>
            connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token operator">-></span>mysql<span class="token punctuation">,</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token comment">//actor_model</span>


        <span class="token comment">/* 
        *上面是使用了RAII机制来实现下面代码，作用效果是一样的
        
        //从连接池中取出一个数据库连接
        request->mysql=m_connPool->GetConnection();

        //process(模板类中的方法，这里是http类)进行处理
        request->process();

        //将数据库连接放回连接池
        m_connPool->ReleaseConnection(request->mysql); 
        */</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//THREADPOOL_H</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="HTTP类"><a href="#HTTP类" class="headerlink" title="HTTP类"></a>HTTP类</h2><h1 id="有待查询的问题"><a href="#有待查询的问题" class="headerlink" title="有待查询的问题"></a>有待查询的问题</h1><ol>
<li>条件变量和信号量的区别以及各自的使用环境</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Sakura.</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/">http://sakura-pub.top/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%9D%A2%E8%AF%95/">面试</a><a class="post-meta__tags" href="/tags/WebServer/">WebServer</a><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a></div><div class="post_share"><div class="social-share" data-image="https://pic.rmb.bdstatic.com/bjh/39c69a365c6f2c263d521ff2b80a1efd.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/%E9%9D%A2%E8%AF%95/C++%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/"><img class="next-cover" src="https://img30.360buyimg.com/pop/jfs/t1/143950/1/26833/298507/61ea0bf4E4b3dfa6e/cba671ea7f81ef12.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">C++知识点总结</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/WebServer/WebServer项目代码/" title="WebServer项目代码"><img class="cover" src="https://i.loli.net/2021/11/02/2mXfAg3HezRCG5h.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-02</div><div class="title">WebServer项目代码</div></div></a></div><div><a href="/面试/C++知识点总结/" title="C++知识点总结"><img class="cover" src="https://img30.360buyimg.com/pop/jfs/t1/143950/1/26833/298507/61ea0bf4E4b3dfa6e/cba671ea7f81ef12.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-11</div><div class="title">C++知识点总结</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://i.loli.net/2021/11/01/ilJyOSYrF7m4M3X.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Sakura.</div><div class="author-info__description">升起的烟花,从下面看?还是从侧面看?</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">40</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/KiritoZz6"><i class="fab fa-github"></i><span>关注我</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/KiritoZz6" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/sakura_zz@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">欢迎来到我的个人博客！如果对文章有问题或者发现错误可以发邮件给我，Email：sakura_zz@163.com</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#WebServer%E6%80%BB%E4%BD%93%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">WebServer总体概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WebServer%E5%A4%A7%E6%A6%82%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">WebServer大概的工作流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%8D%8A%E5%8F%8D%E5%BA%94%E5%A0%86%EF%BC%88%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%8D%8A%E5%BC%82%E6%AD%A5%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">半同步半反应堆（半同步半异步）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.2.</span> <span class="toc-text">多进程模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.3.</span> <span class="toc-text">多线程模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proactor%E6%A8%A1%E5%BC%8F%E5%92%8CReactor%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.4.</span> <span class="toc-text">Proactor模式和Reactor模式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%A7%E7%AB%AF%E5%BA%8F%E5%B0%8F%E7%AB%AF%E5%BA%8F"><span class="toc-number">4.</span> <span class="toc-text">大端序小端序</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTP%E7%9B%B8%E5%85%B3"><span class="toc-number">5.</span> <span class="toc-text">HTTP相关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E6%AC%A1HTTP%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">5.1.</span> <span class="toc-text">一次HTTP请求响应的流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP%E6%96%B9%E6%B3%95"><span class="toc-number">5.2.</span> <span class="toc-text">HTTP方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GET%E3%80%81POST%E5%8C%BA%E5%88%AB"><span class="toc-number">5.3.</span> <span class="toc-text">GET、POST区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E7%A0%81"><span class="toc-number">5.4.</span> <span class="toc-text">状态码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTPS"><span class="toc-number">5.5.</span> <span class="toc-text">HTTPS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E4%B8%8E-HTTPS-%E6%9C%89%E5%93%AA%E4%BA%9B%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">5.5.1.</span> <span class="toc-text">HTTP 与 HTTPS 有哪些区别？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTPS-%E9%87%87%E2%BD%A4%E7%9A%84%E6%98%AF%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E5%92%8C%E2%BE%AE%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E7%BB%93%E5%90%88%E7%9A%84%E3%80%8C%E6%B7%B7%E5%90%88%E5%8A%A0%E5%AF%86%E3%80%8D%E2%BD%85%E5%BC%8F%EF%BC%9A"><span class="toc-number">5.5.2.</span> <span class="toc-text">HTTPS 采⽤的是对称加密和⾮对称加密结合的「混合加密」⽅式：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8BHTTP-1-HTTP-2-HTTP-3%E7%9A%84%E5%8F%91%E5%B1%95%E5%90%A7"><span class="toc-number">5.5.3.</span> <span class="toc-text">介绍一下HTTP&#x2F;1 HTTP&#x2F;2 HTTP&#x2F;3的发展吧</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%B7%B1%E5%AF%B9%E9%A1%B9%E7%9B%AE%E7%9A%84%E8%A7%A3%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">自己对项目的解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#main-cpp"><span class="toc-number">6.1.</span> <span class="toc-text">main.cpp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WebServer%E7%B1%BB"><span class="toc-number">6.2.</span> <span class="toc-text">WebServer类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E7%B1%BB"><span class="toc-number">6.3.</span> <span class="toc-text">日志类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#log-h"><span class="toc-number">6.3.1.</span> <span class="toc-text">log.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#log-cpp"><span class="toc-number">6.3.2.</span> <span class="toc-text">log.cpp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#block-queue-h"><span class="toc-number">6.3.3.</span> <span class="toc-text">block_queue.h</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">6.4.</span> <span class="toc-text">数据库连接池</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sql-connection-pool-h"><span class="toc-number">6.4.1.</span> <span class="toc-text">sql_connection_pool.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sql-connection-pool-cpp"><span class="toc-number">6.4.2.</span> <span class="toc-text">sql_connection_pool.cpp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">6.5.</span> <span class="toc-text">线程池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP%E7%B1%BB"><span class="toc-number">6.6.</span> <span class="toc-text">HTTP类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%89%E5%BE%85%E6%9F%A5%E8%AF%A2%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">7.</span> <span class="toc-text">有待查询的问题</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/" title="WebServer项目解析"><img src="https://pic.rmb.bdstatic.com/bjh/39c69a365c6f2c263d521ff2b80a1efd.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WebServer项目解析"/></a><div class="content"><a class="title" href="/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/" title="WebServer项目解析">WebServer项目解析</a><time datetime="2022-06-15T05:43:43.000Z" title="Created 2022-06-15 13:43:43">2022-06-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E9%9D%A2%E8%AF%95/C++%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/" title="C++知识点总结"><img src="https://img30.360buyimg.com/pop/jfs/t1/143950/1/26833/298507/61ea0bf4E4b3dfa6e/cba671ea7f81ef12.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++知识点总结"/></a><div class="content"><a class="title" href="/%E9%9D%A2%E8%AF%95/C++%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/" title="C++知识点总结">C++知识点总结</a><time datetime="2022-01-11T01:22:33.000Z" title="Created 2022-01-11 09:22:33">2022-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B268%E5%9C%BA/" title="LeetCode周赛268场"><img src="https://i.loli.net/2021/11/26/tpOuz34lBm9SdUc.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LeetCode周赛268场"/></a><div class="content"><a class="title" href="/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B268%E5%9C%BA/" title="LeetCode周赛268场">LeetCode周赛268场</a><time datetime="2021-11-26T05:49:01.000Z" title="Created 2021-11-26 13:49:01">2021-11-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B266%E5%9C%BA/" title="LeetCode周赛266场"><img src="https://i.loli.net/2021/11/09/LtsuZxD8SFMwrGT.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LeetCode周赛266场"/></a><div class="content"><a class="title" href="/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B266%E5%9C%BA/" title="LeetCode周赛266场">LeetCode周赛266场</a><time datetime="2021-11-09T05:10:50.000Z" title="Created 2021-11-09 13:10:50">2021-11-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/WebServer/WebServer%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81/" title="WebServer项目代码"><img src="https://i.loli.net/2021/11/02/2mXfAg3HezRCG5h.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WebServer项目代码"/></a><div class="content"><a class="title" href="/WebServer/WebServer%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81/" title="WebServer项目代码">WebServer项目代码</a><time datetime="2021-11-02T11:21:52.000Z" title="Created 2021-11-02 19:21:52">2021-11-02</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Sakura.</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'uoCtAtvANzWpqnPNGCNRPK7g-gzGzoHsz',
      appKey: 'NIjj8lYmojE9cbwXtTlGUh6F',
      placeholder: '记得留下你的昵称和邮箱....可以快速收到回复',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer src="/live2d-widget/autoload.js"></script><script src="/cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>