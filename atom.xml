<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ğŸŒ¸æ¨±èŠ±é…’å§ğŸ»</title>
  
  <subtitle>ğŸŒ¸Sakura-PubğŸ»</subtitle>
  <link href="http://sakura-pub.top/atom.xml" rel="self"/>
  
  <link href="http://sakura-pub.top/"/>
  <updated>2022-07-17T09:38:55.843Z</updated>
  <id>http://sakura-pub.top/</id>
  
  <author>
    <name>Sakura.</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>C++é›†ç¾¤èŠå¤©æœåŠ¡å™¨ï¼ˆæ­£å¼å†…å®¹ç¯‡ï¼‰</title>
    <link href="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/C++%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E6%AD%A3%E5%BC%8F%E5%86%85%E5%AE%B9%E7%AF%87%EF%BC%89/"/>
    <id>http://sakura-pub.top/%E9%9D%A2%E8%AF%95/C++%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E6%AD%A3%E5%BC%8F%E5%86%85%E5%AE%B9%E7%AF%87%EF%BC%89/</id>
    <published>2022-07-17T03:56:18.000Z</published>
    <updated>2022-07-17T09:38:55.843Z</updated>
    
    <content type="html"><![CDATA[<p> æœ‰äº†ä¸Šä¸€ç¯‡æ‰€æåˆ°çš„é¢„å¤‡çŸ¥è¯†åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ç€æ‰‹å¼€å‘é›†ç¾¤èŠå¤©å®¤é¡¹ç›®äº†</p><h1 id="æ„å»ºé¡¹ç›®ç›®å½•"><a href="#æ„å»ºé¡¹ç›®ç›®å½•" class="headerlink" title="æ„å»ºé¡¹ç›®ç›®å½•"></a>æ„å»ºé¡¹ç›®ç›®å½•</h1><p>é¦–å…ˆæˆ‘ä»¬æŠŠé¡¹ç›®çš„ç›®å½•æ„å»ºå¥½å…ˆï¼Œè¿™é‡Œæ‰“ç®—å°†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ”¾åœ¨åŒä¸€ä¸ªé¡¹ç›®å¤§æ–‡ä»¶å¤¹ä¸‹</p><p>ä¸‹é¢å±•ç¤ºä¸‹æˆ‘åˆ›å»ºæ–‡ä»¶ç›®å½•ï¼š</p><p><img src="https://pic.rmb.bdstatic.com/bjh/ede58589e573549c56768514209192bd.png" alt="æ–‡ä»¶ç›®å½•å±•ç¤º.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt; æœ‰äº†ä¸Šä¸€ç¯‡æ‰€æåˆ°çš„é¢„å¤‡çŸ¥è¯†åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ç€æ‰‹å¼€å‘é›†ç¾¤èŠå¤©å®¤é¡¹ç›®äº†&lt;/p&gt;
&lt;h1 id=&quot;æ„å»ºé¡¹ç›®ç›®å½•&quot;&gt;&lt;a href=&quot;#æ„å»ºé¡¹ç›®ç›®å½•&quot; class=&quot;headerlink&quot; title=&quot;æ„å»ºé¡¹ç›®ç›®å½•&quot;&gt;&lt;/a&gt;æ„å»ºé¡¹ç›®ç›®å½•&lt;/h1&gt;&lt;p&gt;é¦–å…ˆæˆ‘ä»¬æŠŠé¡¹ç›®çš„ç›®å½•æ„</summary>
      
    
    
    
    <category term="é¢è¯•" scheme="http://sakura-pub.top/categories/%E9%9D%A2%E8%AF%95/"/>
    
    <category term="é¡¹ç›®" scheme="http://sakura-pub.top/categories/%E9%9D%A2%E8%AF%95/%E9%A1%B9%E7%9B%AE/"/>
    
    <category term="é›†ç¾¤èŠå¤©æœåŠ¡å™¨" scheme="http://sakura-pub.top/categories/%E9%9D%A2%E8%AF%95/%E9%A1%B9%E7%9B%AE/%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
    
    <category term="é¢è¯•" scheme="http://sakura-pub.top/tags/%E9%9D%A2%E8%AF%95/"/>
    
    <category term="é¡¹ç›®" scheme="http://sakura-pub.top/tags/%E9%A1%B9%E7%9B%AE/"/>
    
    <category term="é›†ç¾¤èŠå¤©æœåŠ¡å™¨" scheme="http://sakura-pub.top/tags/%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>æš‘å‡å†²åˆºç§‹æ‹›é¡¹ç›®--C++é›†ç¾¤èŠå¤©æœåŠ¡å™¨ï¼ˆé¢„å¤‡çŸ¥è¯†ç¯‡ï¼‰</title>
    <link href="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/%E6%9A%91%E5%81%87%E5%86%B2%E5%88%BA%E7%A7%8B%E6%8B%9B%E9%A1%B9%E7%9B%AE-C++%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86%E7%AF%87%EF%BC%89/"/>
    <id>http://sakura-pub.top/%E9%9D%A2%E8%AF%95/%E6%9A%91%E5%81%87%E5%86%B2%E5%88%BA%E7%A7%8B%E6%8B%9B%E9%A1%B9%E7%9B%AE-C++%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86%E7%AF%87%EF%BC%89/</id>
    <published>2022-07-16T06:38:33.000Z</published>
    <updated>2022-07-17T08:56:35.105Z</updated>
    
    <content type="html"><![CDATA[<p> æœ¬C++é›†ç¾¤èŠå¤©æœåŠ¡å™¨é¡¹ç›®äº2022/7/16å¼€å§‹å¼€å‘ï¼Œä¸ºä¸€ä¸ªæš‘æœŸé¡¹ç›®</p><p>ç›¸æ¯”äºä¹‹å‰çš„WebServerï¼Œæœ¬é¡¹ç›®ç”¨åˆ°äº†<strong>JSON</strong>ã€<strong>muduo</strong>ã€<strong>nginxè´Ÿè½½å‡è¡¡</strong>ã€<strong>CMake</strong>ç­‰æ–°åŠŸèƒ½</p><p>å¦å¤–ï¼Œæœ¬é¡¹ç›®æ˜¯åœ¨Windowsç¯å¢ƒä¸­é€šè¿‡VSCodeçš„SSHè¿æ¥è‡³è™šæ‹ŸæœºLinuxå¼€å‘çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æœ¬è´¨ä¸Šè¿˜æ˜¯åŸºäºLinuxç¯å¢ƒ</p><p>ä¸‹é¢æ¥ä»‹ç»ä¸€äº›é¢„å¤‡çŸ¥è¯†å’Œåšä¸€äº›å‡†å¤‡å·¥ä½œ</p><h1 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h1><p>JSONä¸å¿…å¤šè¯´ï¼Œå·²ç»ç®—æŒºç†Ÿæ‚‰çš„ï¼Œå®ƒå¯ä»¥é€šè¿‡åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ¥ä¼ è¾“æˆ–è§£æä¸€ä¸ªæ•°æ®é›†ï¼Œç™¾åº¦ç™¾ç§‘å¯¹äºJSONè§£é‡Šå¦‚ä¸‹</p><blockquote><p>JSONï¼ˆJavaScript Object Notation, JSå¯¹è±¡ç®€è°±ï¼‰æ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢æ ¼å¼ã€‚</p><p>å®ƒåŸºäº ECMAScriptï¼ˆEuropean Computer Manufacturers Association, æ¬§æ´²è®¡ç®—æœºåä¼šåˆ¶å®šçš„jsè§„èŒƒï¼‰çš„ä¸€ä¸ªå­é›†ï¼Œé‡‡ç”¨å®Œå…¨ç‹¬ç«‹äºç¼–ç¨‹è¯­è¨€çš„æ–‡æœ¬æ ¼å¼æ¥å­˜å‚¨å’Œè¡¨ç¤ºæ•°æ®ã€‚</p><p>ç®€æ´å’Œæ¸…æ™°çš„å±‚æ¬¡ç»“æ„ä½¿å¾— JSON æˆä¸ºç†æƒ³çš„æ•°æ®äº¤æ¢è¯­è¨€ã€‚ æ˜“äºäººé˜…è¯»å’Œç¼–å†™ï¼ŒåŒæ—¶ä¹Ÿæ˜“äºæœºå™¨è§£æå’Œç”Ÿæˆï¼Œå¹¶æœ‰æ•ˆåœ°æå‡ç½‘ç»œä¼ è¾“æ•ˆç‡ã€‚</p></blockquote><p>å›åˆ°æ¥é¡¹ç›®ä¸­ï¼Œè¿™é‡ŒJSONç”¨çš„æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œåªç”¨å¼•å…¥ä¸€ä¸ª<code>json.hpp</code>å¤´æ–‡ä»¶å°±å¯ä»¥ä½¿ç”¨äº†ï¼Œéå¸¸è½»é‡æ–¹ä¾¿</p><p>å¦å¤–ï¼Œè¿™ä¸ªjsoné™¤äº†å¯ä»¥å¯¹æ™®é€šæ•°æ®ç±»å‹<code>æ•°ç»„</code>ã€<code>int</code>ã€<code>string</code>ç­‰è¿›è¡Œåºåˆ—åŒ–å¤–ï¼Œè¿˜å¯ä»¥å¯¹STLä¸­çš„<code>vector&lt;T&gt;</code>å’Œ<code>map&lt;K,V&gt;</code>è¿›è¡Œåºåˆ—åŒ–</p><p><strong>æ™®é€šæ•°æ®ç±»å‹ï¼š</strong></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">json js<span class="token punctuation">;</span><span class="token comment">// æ·»åŠ æ•°ç»„</span>js<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// æ·»åŠ key-value</span>js<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"zhang san"</span><span class="token punctuation">;</span><span class="token comment">// æ·»åŠ å¯¹è±¡</span>js<span class="token punctuation">[</span><span class="token string">"msg"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"zhang san"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>js<span class="token punctuation">[</span><span class="token string">"msg"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"liu shuo"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hello china"</span><span class="token punctuation">;</span><span class="token comment">// ä¸Šé¢ç­‰åŒäºä¸‹é¢è¿™å¥ä¸€æ¬¡æ€§æ·»åŠ æ•°ç»„å¯¹è±¡</span>js<span class="token punctuation">[</span><span class="token string">"msg"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token string">"zhang san"</span><span class="token punctuation">,</span> <span class="token string">"hello world"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"liu shuo"</span><span class="token punctuation">,</span> <span class="token string">"hello china"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> js <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//è¾“å‡ºç»“æœä¸ºï¼š&#123;"id":[1,2,3,4,5],msg":&#123;"liu shuo":"hello china","zhang san":"hello world"&#125;,"name":"zhangsan"&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>STLç±»å‹ï¼š</strong></p><p>é™¤äº†vectorå’Œmapï¼Œè¯¥jsonåº“è¿˜èƒ½å­˜å‚¨<code>std::array, std::vector, std::deque, std::forward_list, std::list, std::set, std::multiset, std::unordered_set, std::unordered_multiset</code>ç­‰å®¹å™¨</p><p>å¦å¤–åƒ<code>std::map, std::multimap, std::unordered_map, std::unordered_multimap</code>ï¼Œnlohmannä¹Ÿæ˜¯æ”¯æŒçš„ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯å…¶ä¸­çš„Keyè¢«æ„é€ ä¸ºstd::stringä¿å­˜ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">json js<span class="token punctuation">;</span><span class="token comment">// ç›´æ¥åºåˆ—åŒ–ä¸€ä¸ªvectorå®¹å™¨</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> vec<span class="token punctuation">;</span>vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>js<span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">]</span> <span class="token operator">=</span> vec<span class="token punctuation">;</span><span class="token comment">// ç›´æ¥åºåˆ—åŒ–ä¸€ä¸ªmapå®¹å™¨</span>map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> string<span class="token operator">></span> m<span class="token punctuation">;</span>m<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"é»„å±±"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>m<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"åå±±"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>m<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"æ³°å±±"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>js<span class="token punctuation">[</span><span class="token string">"path"</span><span class="token punctuation">]</span> <span class="token operator">=</span> m<span class="token punctuation">;</span>cout<span class="token operator">&lt;&lt;</span>js<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span><span class="token comment">//è¾“å‡ºç»“æœä¸ºï¼š&#123;"list":[1,2,5],"path":[[1,"é»„å±±"],[2,"åå±±"],[3,"æ³°å±±"]]&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦å¤–ï¼Œé™¤äº†ç›´æ¥cout&lt;&lt;è¾“å‡ºjsonåºåˆ—åŒ–ç»“æœå¤–ï¼Œè¿˜å¯ä»¥å°†å…¶<strong>è½¬ä¸ºstringç±»å‹å†è¾“å‡º</strong></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">string jstr<span class="token operator">=</span>js<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//dump()è¿”å›JSONå¯¹è±¡ä¸­å­˜å‚¨çš„åŸå§‹stringå€¼ã€‚</span>cout<span class="token operator">&lt;&lt;</span>jstr<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>è§£æjsonï¼ˆååºåˆ—åŒ–ï¼‰</strong>åŠŸèƒ½æ“ä½œå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// æ¨¡æ‹Ÿä»ç½‘ç»œæ¥æ”¶åˆ°jsonå­—ç¬¦ä¸²ï¼Œé€šè¿‡json::parseå‡½æ•°æŠŠjsonå­—ç¬¦ä¸²ä¸“ç¨‹jsonå¯¹è±¡</span>json js2 <span class="token operator">=</span> json<span class="token operator">::</span><span class="token function">parse</span><span class="token punctuation">(</span>jsonstr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¿™é‡Œåªæ˜¯å±•ç¤ºäº†è¯¥JSONåº“çš„ä¸€å°éƒ¨åˆ†åŠŸèƒ½ï¼Œæ›´å¤šçš„å¯ä»¥ä¸Šç½‘æœç´¢ï¼šnlohmann json</p><h1 id="muduo"><a href="#muduo" class="headerlink" title="muduo"></a>muduo</h1><p>muduoæ˜¯é™ˆç¡•å¤§ç¥ä¸ªäººå¼€å‘çš„C++çš„TCPç½‘ç»œç¼–ç¨‹åº“ã€‚muduoåŸºäºReactoræ¨¡å¼å®ç°ã€‚</p><p><strong>ä½¿ç”¨muduoå‰è¿˜éœ€è¦å®‰è£…Booståº“ï¼Œè¿™æ˜¯ç”±äºmuduoä¾èµ–äºBooståº“</strong></p><p>muduoç½‘ç»œåº“ç»™ç”¨æˆ·æä¾›äº†ä¸¤ä¸ªä¸»è¦çš„ç±»</p><ul><li>TcpServerï¼šç”¨äºç¼–å†™æœåŠ¡å™¨ç¨‹åºçš„</li><li>TcpClientï¼šç”¨äºç¼–å†™å®¢æˆ·ç«¯ç¨‹åºçš„</li></ul><p>muduoæœ‰ä¸ªå¥½å¤„å°±æ˜¯å®ƒæŠŠç½‘ç»œI/Oå’Œä¸šåŠ¡ä»£ç åŒºåˆ†å¼€æ¥äº†ï¼š</p><p>ä½¿ç”¨æ—¶æˆ‘ä»¬åªç”¨å…³å¿ƒ<strong>ç”¨æˆ·è¿æ¥å’Œæ–­å¼€äº‹ä»¶</strong>ä»¥åŠ<strong>ç”¨æˆ·çš„å¯è¯»å¯å†™äº‹ä»¶</strong>å°±å¯ä»¥äº†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªç”¨ç¼–å†™è¿™ä¸¤ç§äº‹ä»¶çš„æ¥å£ä»£ç å³å¯ï¼Œå…¶å®ƒå¦‚ä½•è¿æ¥ã€epollã€çº¿ç¨‹æ± ç­‰äº‹é¡¹muduoå¸®æˆ‘ä»¬å®Œæˆäº†</p><p>ä½¿ç”¨muduoç¼–å†™æœåŠ¡ç«¯æ—¶å€™ä»£ç æ¨¡å¼æ¯”è¾ƒå›ºå®šï¼ŒåŸºæœ¬ä¸Šåªç”¨ä¿®æ”¹<strong>ç”¨æˆ·è¿æ¥äº‹ä»¶å›è°ƒå‡½æ•°</strong>ã€<strong>ç”¨æˆ·å¯è¯»å†™äº‹ä»¶å›è°ƒå‡½æ•°</strong>ä»¥åŠ<strong>æœåŠ¡ç«¯åç§°</strong>å°±è¡Œäº†</p><p>åœ¨ç¼–å†™å®Œäº‹ä»¶å›è°ƒå‡½æ•°åï¼Œéœ€è¦åšçš„å°±æ˜¯åœ¨æœåŠ¡ç«¯å¯¹è±¡çš„æ„é€ å‡½æ•°ä¸­è¿›è¡Œå›è°ƒå‡½æ•°ç»‘å®šï¼Œç”±äºæˆå‘˜å‡½æ•°çš„å‚æ•°æœ‰ä¸ªéšå¼å‚æ•°<code>this</code>çš„åŸå› ï¼Œå›ºä¸èƒ½ç›´æ¥åœ¨è°ƒç”¨<code>setConnectionCallback()</code>æ—¶å°†æˆå‘˜å‡½æ•°æ–¹æ³•å†™è¿›å»é‡Œè¾¹</p><p>è¿™é‡Œå°±è¦ç”¨åˆ°<code>&lt;functional&gt;</code>å¤´æ–‡ä»¶ä¸­çš„<code>std::bind()</code>ç»‘å®šäº†ï¼ŒåŒæ—¶ä¹Ÿç”¨åˆ°äº†<code>std::placeholders::_1</code>å‚æ•°å ä½ç¬¦</p><p><strong>æ³¨æ„ï¼š</strong>ç”±äºå›è°ƒå‡½æ•°æ˜¯ç±»çš„æˆå‘˜å‡½æ•°ï¼Œæˆå‘˜å‡½æ•°æœ‰ä¸ªéšå¼å‚æ•°<code>this</code>ï¼Œå› æ­¤è¿™é‡Œä¹Ÿè¦è¡¥ä¸Š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">_server<span class="token punctuation">.</span><span class="token function">setConnectionCallback</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ChatServer<span class="token operator">::</span>onConnection<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">,</span>std<span class="token operator">::</span>placeholders<span class="token operator">::</span>_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä½¿ç”¨muduoç½‘ç»œåº“æœåŠ¡ç«¯æ¨¡æ¿ä¾‹å­ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//åŸºäºmuduoç½‘ç»œåº“å¼€å‘çš„æœåŠ¡å™¨ç¨‹åºå®ä¾‹</span><span class="token comment">//muduo_server.cpp</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;muduo/net/TcpServer.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;muduo/net/EventLoop.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">using</span> <span class="token keyword">namespace</span> muduo<span class="token operator">::</span>net<span class="token punctuation">;</span><span class="token keyword">using</span> <span class="token keyword">namespace</span> muduo<span class="token punctuation">;</span><span class="token comment">/** * 1.ç»„åˆTcpServerå¯¹è±¡ * 2.åˆ›å»ºEventLoopäº‹ä»¶å¾ªç¯å¯¹è±¡æŒ‡é’ˆ * 3.æ˜ç¡®TcpServeræ„é€ å‡½æ•°éœ€è¦ä»€ä¹ˆå‚æ•°ï¼ˆæœ‰ä¸‰ä¸ªå¿…è¦çš„ï¼‰ï¼Œè¾“å‡ºChatServerçš„æ„é€ å‡½æ•° * 4.åœ¨å½“å‰æœåŠ¡å™¨ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œæ³¨å†Œå¤„ç†è¿æ¥çš„å›è°ƒå‡½æ•°å’Œå¤„ç†è¯»å†™äº‹ä»¶å›è°ƒå‡½æ•° * 5.è®¾ç½®åˆé€‚çš„æœåŠ¡ç«¯çº¿ç¨‹æ•°é‡ï¼Œmuduoåº“ä¼šè‡ªå·±åˆ†é…I/Oçº¿ç¨‹å’Œå·¥ä½œçº¿ç¨‹ */</span><span class="token keyword">class</span> <span class="token class-name">ChatServer</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">ChatServer</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> loop<span class="token punctuation">,</span> <span class="token comment">//äº‹ä»¶å¾ªç¯</span>                <span class="token keyword">const</span> InetAddress<span class="token operator">&amp;</span> listenAddr<span class="token punctuation">,</span>  <span class="token comment">//IP+Portï¼ˆç«¯å£ï¼‰</span>                <span class="token keyword">const</span> string<span class="token operator">&amp;</span> nameArg<span class="token punctuation">)</span>  <span class="token comment">//æœåŠ¡å™¨åå­—</span>        <span class="token operator">:</span><span class="token function">_server</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span>listenAddr<span class="token punctuation">,</span>nameArg<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_loop</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">//ç»™æœåŠ¡å™¨æ³¨å†Œç”¨æˆ·è¿æ¥çš„åˆ›å»ºå’Œæ–­å¼€å›è°ƒ</span>        <span class="token comment">//å› ä¸ºå›è°ƒå‡½æ•°onConnectionæ˜¯æˆå‘˜å‡½æ•°ï¼Œæœ‰ä¸ªéšå¼thisæŒ‡é’ˆ</span>        <span class="token comment">//è¿™å°±å¯¼è‡´å’ŒåŸæœ¬setConnectionCallbackè¦æ±‚çš„å›è°ƒå‡½æ•°æ ¼å¼ä¸ä¸€è‡´</span>        <span class="token comment">//å› æ­¤è¿™é‡Œå°±è¦ç”¨åˆ°std::bind()ç»‘å®šå‡½æ•°</span>        <span class="token comment">//_1ä¸ºå‚æ•°å ä½ç¬¦</span>        _server<span class="token punctuation">.</span><span class="token function">setConnectionCallback</span><span class="token punctuation">(</span>            std<span class="token operator">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ChatServer<span class="token operator">::</span>onConnection<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">,</span>std<span class="token operator">::</span>placeholders<span class="token operator">::</span>_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//ç»™æœåŠ¡å™¨æ³¨å†Œç”¨æˆ·è¯»å†™äº‹ä»¶å›è°ƒ</span>        _server<span class="token punctuation">.</span><span class="token function">setMessageCallback</span><span class="token punctuation">(</span>            std<span class="token operator">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>onMessage<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">,</span>_1<span class="token punctuation">,</span>_2<span class="token punctuation">,</span>_3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è®¾ç½®æœåŠ¡ç«¯çš„çº¿ç¨‹æ•°é‡ï¼ˆå½“>=2æ—¶ä¼šè‡ªåŠ¨æŠŠå…¶ä¸­ä¸€ä¸ªä½œä¸ºI/Oçº¿ç¨‹ï¼Œå…¶å®ƒä¸ºå·¥ä½œçº¿ç¨‹ï¼‰</span>        <span class="token comment">//è¿™é‡Œçš„4åˆ™è¡¨ç¤º 1ä¸ªI/O 3ä¸ªå·¥ä½œçº¿ç¨‹</span>        _server<span class="token punctuation">.</span><span class="token function">setThreadNum</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å¼€å¯äº‹ä»¶å¾ªç¯</span>    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        _server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">private</span><span class="token operator">:</span>    muduo<span class="token operator">::</span>net<span class="token operator">::</span>TcpServer _server<span class="token punctuation">;</span>  <span class="token comment">// #1.å®šä¹‰ä¸ªæœåŠ¡å™¨å¯¹è±¡</span>    muduo<span class="token operator">::</span>net<span class="token operator">::</span>EventLoop<span class="token operator">*</span> _loop<span class="token punctuation">;</span>   <span class="token comment">// #2.äº‹ä»¶å¾ªç¯æŒ‡é’ˆ</span>    <span class="token comment">//ä¸“é—¨å¤„ç†ç”¨æˆ·çš„è¿æ¥å’Œæ–­å¼€ å›è°ƒå‡½æ•°</span>    <span class="token keyword">void</span> <span class="token function">onConnection</span><span class="token punctuation">(</span><span class="token keyword">const</span> TcpConnectionPtr<span class="token operator">&amp;</span> conn<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//æ‰“å°è¿æ¥æˆ–æ–­å¼€çš„å®¢æˆ·ç«¯ipå’Œport</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>conn<span class="token operator">-></span><span class="token function">connected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//peerAddresså¯¹ç«¯ä¿¡æ¯</span>            cout<span class="token operator">&lt;&lt;</span>conn<span class="token operator">-></span><span class="token function">peerAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toIpPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">" -> "</span><span class="token operator">&lt;&lt;</span>                conn<span class="token operator">-></span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toIpPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">" state: online ."</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            cout<span class="token operator">&lt;&lt;</span>conn<span class="token operator">-></span><span class="token function">peerAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toIpPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">" -> "</span><span class="token operator">&lt;&lt;</span>                conn<span class="token operator">-></span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toIpPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">" state: offline ."</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>                        conn<span class="token operator">-></span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç›¸å½“äºclose(fd)ï¼Œæ³¨æ„æ˜¯å¯¹ç«¯çš„fd</span>            <span class="token comment">//_loop->quit(); //å…³é—­æœåŠ¡ç«¯</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//ä¸“é—¨å¤„ç†ç”¨æˆ·è¯»å†™äº‹ä»¶çš„å›è°ƒå‡½æ•°</span>    <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token keyword">const</span> TcpConnectionPtr<span class="token operator">&amp;</span> conn<span class="token punctuation">,</span>    <span class="token comment">//è¿æ¥</span>                    Buffer<span class="token operator">*</span> buffer<span class="token punctuation">,</span>    <span class="token comment">//ç¼“å†²åŒº</span>                    Timestamp time<span class="token punctuation">)</span> <span class="token comment">//æ¥æ”¶åˆ°æ•°æ®çš„æ—¶é—´ä¿¡æ¯</span>    <span class="token punctuation">&#123;</span>        string buf<span class="token operator">=</span>buffer<span class="token operator">-></span><span class="token function">retrieveAllAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŠŠæ¥æ”¶çš„æ•°æ®å…¨éƒ¨è½¬ä¸ºstring</span>        cout<span class="token operator">&lt;&lt;</span><span class="token string">"recv data: "</span><span class="token operator">&lt;&lt;</span>buf<span class="token operator">&lt;&lt;</span><span class="token string">"\ntime: "</span><span class="token operator">&lt;&lt;</span>time<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>        <span class="token comment">//åŸå°ä¸åŠ¨è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯</span>        conn<span class="token operator">-></span><span class="token function">send</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    EventLoop loop<span class="token punctuation">;</span> <span class="token comment">//ç›¸å½“äºåˆ›å»ºäº†epoll</span>    InetAddress <span class="token function">addr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ChatServer <span class="token function">server</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token punctuation">,</span>addr<span class="token punctuation">,</span><span class="token string">"ChatServer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºæœåŠ¡ç«¯å¯¹è±¡</span>    server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ç›¸å½“äºlistenfd == epoll_ctl() ==> epoll</span>    loop<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ç›¸å½“äºä»¥é˜»å¡è°ƒç”¨epoll_waitï¼Œç­‰å¾…è¿æ¥äº‹ä»¶æˆ–è¯»å†™äº‹ä»¶</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¼–è¯‘æŒ‡ä»¤ä¸ºï¼š</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># æ³¨æ„ -lmuduo_net è¦åœ¨ -lmuduo_base å‰é¢g++ muduo_server.cpp -o server -lmuduo_net -lmuduo_base -lpthread<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="CMake"><a href="#CMake" class="headerlink" title="CMake"></a>CMake</h1><p>CMakeæ˜¯ä¸€ä¸ªè·¨å¹³å°çš„å®‰è£…ï¼ˆ<a href="https://baike.baidu.com/item/%E7%BC%96%E8%AF%91/1258343">ç¼–è¯‘</a>ï¼‰å·¥å…·ï¼Œå¯ä»¥ç”¨ç®€å•çš„è¯­å¥æ¥æè¿°æ‰€æœ‰å¹³å°çš„å®‰è£…(ç¼–è¯‘è¿‡ç¨‹)</p><p>CMakeä½¿ç”¨ç®€å•æ–¹ä¾¿ï¼Œå¯ä»¥è·¨å¹³å°ï¼Œæ„å»ºé¡¹ç›®ç¼–è¯‘ç¯å¢ƒã€‚å°¤å…¶æ¯”ç›´æ¥å†™Makefileç®€å•ï¼ˆåœ¨æ„å»ºå¤§å‹å·¥ç¨‹ç¼–è¯‘<br>æ—¶ï¼Œéœ€è¦å†™å¤§é‡çš„æ–‡ä»¶ä¾èµ–å…³ç³»ï¼‰ï¼Œå¯ä»¥é€šè¿‡ç®€å•çš„CMakeç”Ÿæˆè´Ÿè´£çš„Makefileæ–‡ä»¶ã€‚  </p><p>è¿™é‡Œä»¥ç¼–è¯‘<code>testMuduo</code>é¡¹ç›®ä¸ºä¾‹æ¥ç¼–å†™CMakeå®ä¾‹ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªCMakeLists.txtæ–‡ä»¶ï¼Œæˆ‘ä»¬çš„CMakeä»£ç å°±åœ¨é‡Œé¢ç¼–å†™ï¼š</p><pre class="line-numbers language-cmake" data-language="cmake"><code class="language-cmake"><span class="token comment"># CMakeLists.txt</span><span class="token keyword">cmake_minimum_required</span><span class="token punctuation">(</span><span class="token property">VERSION</span> <span class="token number">3.0</span><span class="token punctuation">)</span>    <span class="token comment">#è¦æ±‚ç³»ç»ŸCMakeæœ€å°çš„ç‰ˆæœ¬</span><span class="token keyword">project</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>   <span class="token comment">#å·¥ç¨‹åå­—</span><span class="token comment"># é…ç½®ç¼–è¯‘é€‰é¡¹ï¼Œè¿™é‡Œæ˜¯åœ¨CMAKE_CXX_FLAGSåŸºç¡€ä¸Šåé¢å†åŠ ä¸ª -g</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_CXX_FLAGS</span> <span class="token punctuation">$&#123;</span><span class="token variable">CMAKE_CXX_FLAGS</span><span class="token punctuation">&#125;</span> -g<span class="token punctuation">)</span><span class="token comment"># é…ç½®å¤´æ–‡ä»¶æœç´¢è·¯å¾„</span><span class="token comment">#ã€€include_directories()</span><span class="token comment"># é…ç½®åº“æ–‡ä»¶æœç´¢è·¯å¾„</span><span class="token comment"># link_directories()</span><span class="token comment"># è®¾ç½®éœ€è¦ç¼–è¯‘çš„æºæ–‡ä»¶åˆ—è¡¨</span><span class="token keyword">set</span> <span class="token punctuation">(</span>SRC_LIST muduo_server.cpp<span class="token punctuation">)</span><span class="token comment"># æŠŠæŒ‡å®šè·¯å¾„ï¼ˆè¿™é‡Œ.æŒ‡å½“å‰ç›®å½•ï¼‰ä¸‹çš„æ‰€æœ‰æºæ–‡ä»¶åå­—åŠ å…¥åˆ°å˜é‡SRC_LISTä¸­</span><span class="token comment"># aux_source_directory(. SRC_LIST)</span><span class="token comment"># è¡¨ç¤ºç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶serverï¼Œç”±å˜é‡SRC_LISTæºæ–‡ä»¶ç¼–è¯‘è€Œæ¥</span><span class="token keyword">add_executable</span><span class="token punctuation">(</span>server <span class="token punctuation">$&#123;</span>SRC_LIST<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment"># é“¾æ¥åº“ï¼Œè¡¨ç¤ºserverç¨‹åºç”±åé¢å‡ ä¸ªåº“é“¾æ¥ï¼ˆç›¸æ¯”ç›´æ¥g++å‘½ä»¤ä¸ç”¨åŠ -lï¼‰</span><span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span>server muduo_net muduo_base pthread<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å†™å¥½ååœ¨å½“å‰ç›®å½•ä¸‹è¿è¡ŒæŒ‡ä»¤å³å¯æ„å»ºé¡¹ç›®ï¼š</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cmake .<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸Šé¢è¿™ç§æ–¹å¼ä¼šç”Ÿæˆå‡ºæ¥ä¸€å¤§å †ä¸œè¥¿ï¼Œå…¶ä¸­å°±åŒ…æ‹¬Makefileï¼Œä¹‹åæˆ‘ä»¬é€šè¿‡<code>make</code>æŒ‡ä»¤æ‰§è¡Œç”Ÿæˆå‘½ä»¤å°±å¥½äº†</p><p>æˆ‘ä»¬è¿˜å¯ä»¥æ”¹å–„ä¸€ä¸‹ï¼Œé»˜è®¤æ‰§è¡Œ<code>cmake .</code>æŒ‡ä»¤åï¼ŒCMakeç”Ÿæˆäº†ä¸€å¤§å †ä¸œè¥¿ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶åˆ†ç±»æ”¾å¥½ï¼Œæ¯”å¦‚æŒ‡å®šç”Ÿæˆçš„ç¨‹åºæ”¾åœ¨å“ªä¸ªæ–‡ä»¶å¤¹ç­‰ç­‰</p><p>åœ¨ä¸Šé¢<code>CMakeLists.txt</code>æ·»åŠ ä¸€è¡Œä»£ç å³å¯ï¼š</p><pre class="line-numbers language-cmake" data-language="cmake"><code class="language-cmake"><span class="token comment"># è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶æœ€ç»ˆçš„å­˜å‚¨ç›®å½•åœ¨ å½“å‰ç›®å½•/bin ä¸‹</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">EXECUTABLE_OUTPUT_PATH</span> <span class="token punctuation">$&#123;</span><span class="token variable">PROJECT_SOURCE_DIR</span><span class="token punctuation">&#125;</span>/bin<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>åŒæ—¶åˆ«å¿˜äº†è¦åˆ›å»ºä¸€ä¸ª<code>bin</code>ç›®å½•</p><p>å¼„å¥½è¿™ä¸¤ä¸ªäº‹æƒ…åï¼Œ<code>make</code>æ‰€ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶å°±ä¼šåœ¨<code>./bin</code>ç›®å½•ä¸‹äº†</p><h2 id="ä»¥å°è§å¤§-â€”-ä¸€ä¸ªé¡¹ç›®åˆé€‚çš„ç›®å½•ï¼š"><a href="#ä»¥å°è§å¤§-â€”-ä¸€ä¸ªé¡¹ç›®åˆé€‚çš„ç›®å½•ï¼š" class="headerlink" title="ä»¥å°è§å¤§ â€” ä¸€ä¸ªé¡¹ç›®åˆé€‚çš„ç›®å½•ï¼š"></a>ä»¥å°è§å¤§ â€” ä¸€ä¸ªé¡¹ç›®åˆé€‚çš„ç›®å½•ï¼š</h2><p>é€šå¸¸åœ¨githubä¸Šçœ‹åˆ°åˆ«äººçš„é¡¹ç›®æ˜¯æœ‰å¾ˆå¤šä¸ªæ–‡ä»¶å¤¹åˆ†å¥½ç±»çš„ï¼Œé€šå¸¸ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆ</p><ul><li>binï¼šæ”¾å¯æ‰§è¡Œæ–‡ä»¶</li><li>libï¼šæ”¾ç¨‹åºç”Ÿæˆçš„é“¾æ¥åº“</li><li>includeï¼šæ”¾é¡¹ç›®çš„å¤´æ–‡ä»¶</li><li>srcï¼šæ”¾é¡¹ç›®çš„æºä»£ç æ–‡ä»¶</li><li>buildï¼šæ”¾ç¼–è¯‘çš„ä¸­é—´æ–‡ä»¶</li><li>exampleï¼šæ”¾é¡¹ç›®çš„å®ä¾‹æ–‡ä»¶</li><li>thirdpartyï¼šæ”¾ç¬¬ä¸‰æ–¹åº“ï¼Œæ¯”å¦‚JSONåº“<code>json.hpp</code></li><li>CMakeLists.txt</li><li>autobuild.shï¼šè‡ªå·±ç¼–å†™çš„è‡ªåŠ¨ç”Ÿæˆé¡¹ç›®çš„shellè„šæœ¬</li></ul><h1 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h1><p>è¯¥é¡¹ç›®ä¹Ÿéœ€è¦ç”¨åˆ°æ•°æ®åº“ï¼Œè¿™é‡Œé€‰æ‹©çš„ä¾ç„¶æ˜¯MySQLï¼Œè¦åˆ›å»ºæ€»å…±5ä¸ªè¡¨ï¼Œä»£ç å¦‚ä¸‹</p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql"># ä¸“é—¨ç»™èŠå¤©å®¤çš„æ•°æ®åº“chatcreate database if not exists chat;use chat;# ç”¨æˆ·è¡¨# drop table if exists &#96;user&#96;;create table if not exists &#96;user&#96;(&#96;id&#96; int auto_increment comment &#39;ç”¨æˆ·id&#39;,    &#96;name&#96; varchar(50) not null unique comment &#39;ç”¨æˆ·å&#39;,    &#96;password&#96; varchar(50) not null comment &#39;ç”¨æˆ·å¯†ç &#39;,    &#96;state&#96; enum(&#39;online&#39;,&#39;offline&#39;) default &#39;offline&#39; comment &#39;å½“å‰ç™»å½•çŠ¶æ€&#39;,    primary key(&#96;id&#96;))engine&#x3D;InnoDB default charset&#x3D;gbk;desc &#96;user&#96;;# å¥½å‹è¡¨# drop table if exists &#96;friend&#96;;create table if not exists &#96;friend&#96;(&#96;userid&#96; int not null comment &#39;ç”¨æˆ·id&#39;,    &#96;friendid&#96; int not null comment &#39;å¥½å‹id&#39;,    primary key(&#96;userid&#96;,&#96;friendid&#96;))engine&#x3D;InnoDB default charset&#x3D;gbk;desc &#96;friend&#96;;# ç¾¤ç»„è¡¨create table if not exists &#96;allgroup&#96;(&#96;id&#96; int auto_increment comment &#39;ç¾¤ç»„id&#39;,    &#96;groupname&#96; varchar(50) not null unique comment &#39;ç¾¤ç»„åç§°&#39;,    &#96;groupdesc&#96; varchar(200) default &#39;&#39; comment &#39;ç¾¤ç»„åŠŸèƒ½æè¿°&#39;,    primary key(&#96;id&#96;))engine&#x3D;InnoDB default charset&#x3D;gbk;desc &#96;allgroup&#96;;# ç¾¤ç»„æˆå‘˜è¡¨create table if not exists &#96;groupuser&#96;(&#96;groupid&#96; int not null comment &#39;ç¾¤ç»„id&#39;,    &#96;userid&#96; int not null comment &#39;ç»„å‘˜id&#39;,    &#96;grouprole&#96; enum(&#39;creator&#39;,&#39;normal&#39;) default &#39;normal&#39; comment &#39;ç»„å†…è§’è‰²&#39;,    primary key(&#96;groupid&#96;,&#96;userid&#96;))engine&#x3D;InnoDB default charset&#x3D;gbk;desc &#96;groupuser&#96;;# ç¦»çº¿ä¿¡æ¯è¡¨create table if not exists &#96;offlinemessage&#96;(&#96;userid&#96; int not null comment &#39;ç”¨æˆ·id&#39;,    &#96;message&#96; varchar(500) not null comment &#39;ç¦»çº¿ä¿¡æ¯ï¼ˆå­˜å‚¨Jsonå­—ç¬¦ä¸²ï¼‰&#39;)engine&#x3D;InnoDB default charset&#x3D;gbk;desc &#96;offlinemessage&#96;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt; æœ¬C++é›†ç¾¤èŠå¤©æœåŠ¡å™¨é¡¹ç›®äº2022/7/16å¼€å§‹å¼€å‘ï¼Œä¸ºä¸€ä¸ªæš‘æœŸé¡¹ç›®&lt;/p&gt;
&lt;p&gt;ç›¸æ¯”äºä¹‹å‰çš„WebServerï¼Œæœ¬é¡¹ç›®ç”¨åˆ°äº†&lt;strong&gt;JSON&lt;/strong&gt;ã€&lt;strong&gt;muduo&lt;/strong&gt;ã€&lt;strong&gt;nginxè´Ÿè½½å‡è¡¡&lt;/strong&gt;</summary>
      
    
    
    
    <category term="é¢è¯•" scheme="http://sakura-pub.top/categories/%E9%9D%A2%E8%AF%95/"/>
    
    <category term="é¡¹ç›®" scheme="http://sakura-pub.top/categories/%E9%9D%A2%E8%AF%95/%E9%A1%B9%E7%9B%AE/"/>
    
    <category term="é›†ç¾¤èŠå¤©æœåŠ¡å™¨" scheme="http://sakura-pub.top/categories/%E9%9D%A2%E8%AF%95/%E9%A1%B9%E7%9B%AE/%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
    
    <category term="é¢è¯•" scheme="http://sakura-pub.top/tags/%E9%9D%A2%E8%AF%95/"/>
    
    <category term="é¡¹ç›®" scheme="http://sakura-pub.top/tags/%E9%A1%B9%E7%9B%AE/"/>
    
    <category term="é›†ç¾¤èŠå¤©æœåŠ¡å™¨" scheme="http://sakura-pub.top/tags/%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>è¿›ç¨‹é—´é€šä¿¡</title>
    <link href="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/"/>
    <id>http://sakura-pub.top/%E9%9D%A2%E8%AF%95/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/</id>
    <published>2022-07-13T16:15:46.000Z</published>
    <updated>2022-07-17T09:41:05.827Z</updated>
    
    <content type="html"><![CDATA[<h1 id="è¿›ç¨‹é—´é€šä¿¡ç§ç±»"><a href="#è¿›ç¨‹é—´é€šä¿¡ç§ç±»" class="headerlink" title="è¿›ç¨‹é—´é€šä¿¡ç§ç±»"></a>è¿›ç¨‹é—´é€šä¿¡ç§ç±»</h1><p>è¿›ç¨‹é—´é€šä¿¡æ–¹å¼é€šå¸¸æœ‰6ç§ï¼š</p><ol><li>ç®¡é“</li><li>æ¶ˆæ¯é˜Ÿåˆ—</li><li>å…±äº«å†…å­˜</li><li>ä¿¡å·é‡</li><li>ä¿¡å·</li><li>Socket</li></ol><p>è¿™äº›éƒ½éœ€è¦ç‰¢ç‰¢è®°ä½ï¼Œå¹¶ä¸”çŸ¥é“ä»–ä»¬å„è‡ªçš„ä¼˜ç¼ºç‚¹ä»¥åŠä½¿ç”¨åœºæ™¯</p><h1 id="ç®¡é“"><a href="#ç®¡é“" class="headerlink" title="ç®¡é“"></a>ç®¡é“</h1><p>ç®¡é“åˆ†ä¸ºåŒ¿åç®¡é“å’Œæœ‰åç®¡é“</p><p>åŒ¿åç®¡é“ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//è¿›ç¨‹é—´é€šä¿¡ä¹‹ --- ç®¡é“</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> pipe_arr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token function">pipe</span><span class="token punctuation">(</span>pipe_arr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"create pipe error!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    pid_t pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//å­è¿›ç¨‹</span>                <span class="token function">close</span><span class="token punctuation">(</span>pipe_arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> message<span class="token operator">=</span><span class="token string">"hello father , this is child!"</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipe_arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>message<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipe_arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//çˆ¶è¿›ç¨‹</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fork ok! pid is %d\n"</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipe_arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> len<span class="token operator">=</span><span class="token function">read</span><span class="token punctuation">(</span>pipe_arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>buff<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"this is Father, I read: %s\n"</span><span class="token punctuation">,</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">memset</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"father read over!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"father read error!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipe_arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="å…±äº«å†…å­˜"><a href="#å…±äº«å†…å­˜" class="headerlink" title="å…±äº«å†…å­˜"></a>å…±äº«å†…å­˜</h1><p>å…±äº«å†…å­˜åˆæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ä¸ªæ˜¯mmapï¼Œä¸€ä¸ªæ˜¯shmï¼Œè¿™é‡Œå…ˆæ”¾shmçš„å…ˆ</p><h2 id="shm"><a href="#shm" class="headerlink" title="shm"></a>shm</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//è¿›ç¨‹é—´é€šä¿¡ä¹‹ --- å…±äº«å†…å­˜</span><span class="token comment">//å…±äº«å†…å­˜æœ‰ä¸¤ç§æ–¹å¼ï¼šmmapã€shm</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FILE_NAME</span> <span class="token string">"./shm.txt"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROJ_ID</span> <span class="token expression"><span class="token number">6</span></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    key_t key<span class="token operator">=</span><span class="token function">ftok</span><span class="token punctuation">(</span>FILE_NAME<span class="token punctuation">,</span>PROJ_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ftok error: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    cout<span class="token operator">&lt;&lt;</span><span class="token string">"key: "</span><span class="token operator">&lt;&lt;</span>key<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>    <span class="token keyword">int</span> shm_id<span class="token operator">=</span><span class="token function">shmget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">,</span>IPC_CREAT <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¾—åˆ°ä¸€ä¸ªå…±äº«å†…å­˜æ ‡è¯†ç¬¦æˆ–åˆ›å»ºä¸€ä¸ªå…±äº«å†…å­˜å¯¹è±¡å¹¶è¿”å›å…±äº«å†…å­˜æ ‡è¯†ç¬¦</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>shm_id<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"shm_id error: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    cout<span class="token operator">&lt;&lt;</span><span class="token string">"shm_id: "</span><span class="token operator">&lt;&lt;</span>shm_id<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> buff<span class="token punctuation">;</span>    <span class="token keyword">int</span> pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//å­è¿›ç¨‹</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>k<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>k<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            buff <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shm_id<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//æ˜ å°„å…±äº«å†…å­˜ï¼Œå¾—åˆ°è™šæ‹Ÿåœ°å€</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[Message%d]: %s"</span><span class="token punctuation">,</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">shmdt</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//è§£é™¤å…±äº«å†…å­˜</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//çˆ¶è¿›ç¨‹</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            buff<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shm_id<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span><span class="token string">"hello son, this is father!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcat</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span><span class="token function">to_string</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">shmdt</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£é™¤å…±äº«å†…å­˜</span>        <span class="token punctuation">&#125;</span>                        <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token function">shmctl</span><span class="token punctuation">(</span>shm_id<span class="token punctuation">,</span>IPC_RMID<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ é™¤è¿™ç‰‡å…±äº«å†…å­˜</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//è¿›ç¨‹é—´é€šä¿¡ä¹‹ --- å…±äº«å†…å­˜ï¼ˆmmapï¼‰</span><span class="token comment">//å…±äº«å†…å­˜æœ‰ä¸¤ç§æ–¹å¼ï¼šmmapã€shm</span><span class="token comment">//å‡½æ•°åŸå‹</span><span class="token comment">//void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);</span><span class="token comment">/** å‚æ•°ï¼š*  addr: æŒ‡å®šæ˜ å°„åŒºçš„é¦–åœ°å€ã€‚é€šå¸¸ä¼ NULLï¼Œè®©å†…æ ¸è‡ªåŠ¨åˆ†é…*  length: æ˜ å°„åŒºçš„é•¿åº¦ï¼Œå°äºç­‰äºæ–‡ä»¶å®é™…é•¿åº¦*  port: å…±äº«æ˜ å°„åŒºçš„è¯»å†™å±æ€§ã€‚PORT_READ(åªè¯»)ã€PORT_WRITE (åªå†™)ã€PORT_READ | PORT_WRITEï¼ˆè¯»å†™ï¼‰*  flags: å…±äº«å†…å­˜çš„å…±äº«å±æ€§ã€‚MAP_SHAREDã€MAP_PRIVATEã€MAP_ANONYMOUS (MAP_ANON)*  fd: ç”¨äºåˆ›å»ºå…±äº«æ˜ å°„åŒºæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦*  offes: åç§»ä½ç½®ï¼Œ4Kçš„æ•´æ•°å€** è¿”å›å€¼ï¼š* æˆåŠŸï¼Œè¿”å›æ˜ å°„åŒºçš„é¦–åœ°å€*  å¤±è´¥ï¼šMAP_FILED, è¿™ä¸ªå®å±•å¼€åæ˜¯ï¼š(void *)(-1) ï¼ŒåŒæ—¶è®¾ç½®errno*/</span><span class="token comment">//int munmap(void *addr, size_t length);   //é‡Šæ”¾å…±äº«å†…å­˜æ˜ å°„åŒº</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FILE_NAME</span> <span class="token string">"./mmap.txt"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFSIZE</span> <span class="token expression"><span class="token number">512</span></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"mmap.txt"</span><span class="token punctuation">,</span>O_RDWR <span class="token operator">|</span> O_CREAT <span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open() error: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open ok!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> buff<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>BUFFSIZE<span class="token punctuation">,</span>PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span>MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å»ºç«‹mmap</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>buff<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap error: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å…³é—­fdä¸å½±å“å†…å­˜æ˜ å°„</span>    <span class="token comment">//æµ‹è¯•ç”¨ä¾‹ï¼Œå­è¿›ç¨‹å†™ï¼Œçˆ¶è¿›ç¨‹è¯»</span>    <span class="token keyword">int</span> pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//å­è¿›ç¨‹</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            string <span class="token function">message</span><span class="token punctuation">(</span><span class="token string">"[Message"</span><span class="token operator">+</span><span class="token function">to_string</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"]: this is son, hello father!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span>message<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"NO.%d Message push.\n"</span><span class="token punctuation">,</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//çˆ¶è¿›ç¨‹</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>buff<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork error: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">munmap</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span>BUFFSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="æ¶ˆæ¯é˜Ÿåˆ—"><a href="#æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—"></a>æ¶ˆæ¯é˜Ÿåˆ—</h1><p>æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿæœ‰åˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªæ˜¯System Vçš„æ¶ˆæ¯é˜Ÿåˆ—msgï¼ˆéœ€è¦å¤´æ–‡ä»¶&lt;sys/msg.h&gt;ï¼‰ï¼Œå¦ä¸ªæ˜¯POSIXçš„mqï¼ˆéœ€è¦å¤´æ–‡ä»¶&lt;mqueue.h&gt;ï¼‰</p><p>è¿™é‡Œåªå±•ç¤ºmsgï¼Œéœ€è¦æ³¨æ„çš„æ˜¯msgä¸€å®šè¦æœ‰ä¸ªæ¶ˆæ¯ç»“æ„ä½“ï¼ˆä¸‹é¢ä»£ç ä¸º<code>struct msg</code>ï¼‰ï¼Œè¯¥ç»“æ„ä½“è¿˜å¿…é¡»æœ‰ä¸ªlongç±»å‹æˆå‘˜ï¼Œè¡¨ç¤ºä¼ è¾“ç±»å‹</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//è¿›ç¨‹é—´é€šä¿¡ä¹‹ --- æ¶ˆæ¯é˜Ÿåˆ—</span><span class="token comment">//è¿™é‡Œç”¨çš„æ˜¯ System Vçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿˜æœ‰POSIXçš„æ¶ˆæ¯é˜Ÿåˆ—éœ€è¦å¤´æ–‡ä»¶ &lt;mqueue.h></span><span class="token comment">/** * int msgget(key_t key, int msgflg);//åˆ›å»ºæˆ–æ‰“å¼€msgget() * int msgctl(int msqid, int cmd, struct msqid_ds *buf);//æ§åˆ¶(åˆ é™¤)msgctl() *  * *å‘é€æ¶ˆæ¯ * int msgsnd(int msqid, const void *msgp, size_t msgsz, int msgflg); *  * *æ¥æ”¶ * ssize_t msgrcv(int msqid, void *msgp, size_t msgsz, long msgtyp, */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FILE_NAME</span> <span class="token string">"./msg.txt"</span></span><span class="token keyword">struct</span> <span class="token class-name">msg</span><span class="token punctuation">&#123;</span>    <span class="token keyword">long</span> type<span class="token punctuation">;</span>    <span class="token keyword">char</span> message<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//å®šä¹‰key</span>    key_t key<span class="token operator">=</span><span class="token function">ftok</span><span class="token punctuation">(</span>FILE_NAME<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> msgid<span class="token operator">=</span><span class="token function">msgget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>IPC_CREAT<span class="token operator">|</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>msgid<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"msgget error: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">struct</span> <span class="token class-name">msg</span> msgs<span class="token punctuation">;</span>    <span class="token comment">//æµ‹è¯•ç”¨ä¾‹ï¼Œçˆ¶è¿›ç¨‹è¯»å–æ¶ˆæ¯ï¼Œå­è¿›ç¨‹å‘é€æ¶ˆæ¯</span>    <span class="token keyword">int</span> pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//å­è¿›ç¨‹</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            msgs<span class="token punctuation">.</span>type<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>            string <span class="token function">message</span><span class="token punctuation">(</span><span class="token string">"NO."</span><span class="token operator">+</span><span class="token function">to_string</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" this is son , hello father!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span>message<span class="token punctuation">,</span>message<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> ret_value <span class="token operator">=</span> <span class="token function">msgsnd</span><span class="token punctuation">(</span>msgid<span class="token punctuation">,</span><span class="token operator">&amp;</span>msgs<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">msg</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å­è¿›ç¨‹å‘é€æ¶ˆæ¯</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret_value<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"son send error: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">memset</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span>message<span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//å‘é€overè®©çˆ¶è¿›ç¨‹ç»“æŸå¾ªç¯</span>        msgs<span class="token punctuation">.</span>type<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span>message<span class="token punctuation">,</span><span class="token string">"over"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> ret_value<span class="token operator">=</span><span class="token function">msgsnd</span><span class="token punctuation">(</span>msgid<span class="token punctuation">,</span><span class="token operator">&amp;</span>msgs<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">msg</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret_value<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"son send over error: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//çˆ¶è¿›ç¨‹</span>        <span class="token keyword">int</span> ret_value<span class="token punctuation">;</span>        <span class="token keyword">int</span> count<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span><span class="token comment">//ä¿åº•è®¡æ•°å™¨ï¼Œé˜²æ­¢æ­»å¾ªç¯</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                        <span class="token comment">/*æ¥æ”¶æ¶ˆæ¯é˜Ÿåˆ— msgrcv(int msqid, void *msgp, size_t msgsz, long msgtyp, int msgflg);            * msgtypï¼šä»æ¶ˆæ¯é˜Ÿåˆ—å†…è¯»å–çš„æ¶ˆæ¯å½¢æ€ã€‚å¦‚æœå€¼ä¸ºé›¶ï¼Œ            * åˆ™è¡¨ç¤ºæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šè¢«è¯»å–            * msgflg : 0 è¡¨ç¤ºé˜»å¡ç­‰å¾…ï¼ŒIPC_NOWAITä¸ç­‰å¾…            */</span>              ret_value<span class="token operator">=</span><span class="token function">msgrcv</span><span class="token punctuation">(</span>msgid<span class="token punctuation">,</span><span class="token operator">&amp;</span>msgs<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">msg</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret_value<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"father msgrcv error: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"father read[ret:%d type:%ld]: %s\n"</span><span class="token punctuation">,</span>ret_value<span class="token punctuation">,</span>msgs<span class="token punctuation">.</span>type<span class="token punctuation">,</span>msgs<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span>message<span class="token punctuation">,</span><span class="token string">"over"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>count<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token operator">--</span>count<span class="token punctuation">;</span>            <span class="token comment">//sleep(1);</span>        <span class="token punctuation">&#125;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"father break loop!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">msgctl</span><span class="token punctuation">(</span>msgid<span class="token punctuation">,</span>IPC_RMID<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ä¿¡å·é‡"><a href="#ä¿¡å·é‡" class="headerlink" title="ä¿¡å·é‡"></a>ä¿¡å·é‡</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;è¿›ç¨‹é—´é€šä¿¡ç§ç±»&quot;&gt;&lt;a href=&quot;#è¿›ç¨‹é—´é€šä¿¡ç§ç±»&quot; class=&quot;headerlink&quot; title=&quot;è¿›ç¨‹é—´é€šä¿¡ç§ç±»&quot;&gt;&lt;/a&gt;è¿›ç¨‹é—´é€šä¿¡ç§ç±»&lt;/h1&gt;&lt;p&gt;è¿›ç¨‹é—´é€šä¿¡æ–¹å¼é€šå¸¸æœ‰6ç§ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ç®¡é“&lt;/li&gt;
&lt;li&gt;æ¶ˆæ¯é˜Ÿåˆ—&lt;/li&gt;
&lt;</summary>
      
    
    
    
    <category term="é¢è¯•" scheme="http://sakura-pub.top/categories/%E9%9D%A2%E8%AF%95/"/>
    
    <category term="é¡¹ç›®" scheme="http://sakura-pub.top/categories/%E9%9D%A2%E8%AF%95/%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="é¢è¯•" scheme="http://sakura-pub.top/tags/%E9%9D%A2%E8%AF%95/"/>
    
    <category term="é¡¹ç›®" scheme="http://sakura-pub.top/tags/%E9%A1%B9%E7%9B%AE/"/>
    
  </entry>
  
  <entry>
    <title>è·³è¡¨é¡¹ç›®æ€»ç»“</title>
    <link href="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/%E8%B7%B3%E8%A1%A8%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/"/>
    <id>http://sakura-pub.top/%E9%9D%A2%E8%AF%95/%E8%B7%B3%E8%A1%A8%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/</id>
    <published>2022-07-01T13:54:40.000Z</published>
    <updated>2022-07-01T16:53:28.587Z</updated>
    
    <content type="html"><![CDATA[<p> è·³è¡¨é¡¹ç›®ç›¸å¯¹äºWebServeræ¯”è¾ƒç®€å•ï¼Œå®é™…ä¸Šå°±æ˜¯å®ç°äº†è·³è¡¨è¿™ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹å­˜æ”¾çš„æ•°æ®æ˜¯ä¸€ä¸ª<code>Node&lt;K,V&gt;</code>çš„ç»“æ„ï¼Œå’Œå“ˆå¸Œè¡¨æœ‰ç‚¹ç±»ä¼¼</p><h1 id="åŠŸèƒ½"><a href="#åŠŸèƒ½" class="headerlink" title="åŠŸèƒ½"></a>åŠŸèƒ½</h1><p>è¯¥è·³è¡¨ä¸»è¦åŠŸèƒ½æœ‰ï¼š</p><ul><li>æ’å…¥å…ƒç´ </li><li>åˆ é™¤å…ƒç´ </li><li>æ˜¾ç¤ºåˆ—è¡¨</li><li>å°†æ•°æ®å­˜æ”¾ä¸ºæ–‡ä»¶ç±»å‹</li><li>åŠ è½½æ–‡ä»¶æ•°æ®åˆ°å†…å­˜ä¸­</li></ul><h1 id="æ’å…¥æ•°æ®"><a href="#æ’å…¥æ•°æ®" class="headerlink" title="æ’å…¥æ•°æ®"></a>æ’å…¥æ•°æ®</h1><p>è·³è¡¨æ’å…¥æ•°æ®æ˜¯å…ˆä»ç¬¬ä¸€åˆ—æ•°ç»„æœ€ä¸Šæ–¹å¼€å§‹ï¼Œå³å·¦ä¸Šè§’ä½ç½®å¼€å§‹å¯»æ‰¾æ’å…¥ä½ç½®ï¼Œè¿™ä¸ªä½ç½®çš„å±‚ä¹Ÿæ˜¯è·³è¡¨çš„å½“å‰æœ€é«˜å±‚</p><p>å‡è®¾ç›®å‰è·³è¡¨å±‚æ•°ä¸ºhï¼Œå¦‚æœé‡åˆ°å½“å‰å±‚<code>h</code>æ²¡æœ‰åˆé€‚ä½ç½®æ’å…¥ï¼Œåˆ™éœ€è¦å¾€ä¸‹ä¸€å±‚<code>h-1</code>æŸ¥æ‰¾ï¼Œé€æ¸æŸ¥æ‰¾åˆ°ç¬¬<code>0</code>å±‚çš„ä½ç½®ä¾¿æ˜¯æ’å…¥ä½ç½®</p><p>è€Œåœ¨æ¯æ¬¡ä»å½“å‰å±‚å¾€ä¸‹å±‚è½¬æ¢æ—¶ï¼Œéƒ½ä¼šæœ‰ä¸ª<code>Node&lt;K,V&gt;* update[_max_level+1]</code>èŠ‚ç‚¹æ•°ç»„æ¥è®°å½•å½“å‰å±‚çš„è½¬æ¢ä½ç½®ï¼Œä¾‹å¦‚åœ¨ä¸‹åˆ—å›¾ç¤ºä¸­ï¼Œæˆ‘ä»¬è¦æ’å…¥50çš„å€¼ï¼Œè€Œ<code>update</code>æ•°ç»„åˆ™ä¼šè®°å½•ï¼šç¬¬å››å±‚çš„1ã€ç¬¬ä¸‰å±‚çš„10ã€ç¬¬äºŒå±‚å’Œç¬¬ä¸€å±‚çš„30</p><p>è¿™æ˜¯ä¸ºäº†åœ¨æœ€åº•å±‚æ’å…¥50åï¼Œéšæœºåˆ¤æ–­ä¸Šé¢çš„å±‚æ˜¯å¦è¦æ·»åŠ 50è¿™ä¸ªæ•°ï¼ˆæé«˜æŸ¥æ‰¾æ•ˆç‡ï¼‰ï¼Œè€Œè¿™ä¸ªéšæœºåˆ¤æ–­æ³•æ¦‚ç‡ä¸º1/2</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/** *                            +------------+*                            |  insert 50 |*                            +------------+* level 4     +-->1+                                                      100*                  |*                  |                      insert +----+* level 3         1+-------->10+---------------> | 50 |          70       100*                                                |    |*                                                |    |* level 2         1          10         30       | 50 |          70       100*                                                |    |*                                                |    |* level 1         1    4     10         30       | 50 |          70       100*                                                |    |*                                                |    |* level 0         1    4   9 10         30   40  | 50 |  60      70       100*                                                +----+**/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éšæœºåˆ¤æ–­æ³•åœ¨ä»£ç ä¸­å‡½æ•°åä¸º<code>int SkipList&lt;K,V&gt;::get_random_level()</code></p><p>ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//è·å–éšæœºå±‚æ•°</span><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">K</span><span class="token punctuation">,</span><span class="token keyword">typename</span> <span class="token class-name">V</span><span class="token operator">></span><span class="token keyword">int</span> <span class="token class-name">SkipList</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token operator">::</span><span class="token function">get_random_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token operator">++</span>k<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    k<span class="token operator">=</span><span class="token punctuation">(</span>k<span class="token operator">&lt;</span>_max_level<span class="token punctuation">)</span><span class="token operator">?</span>k<span class="token operator">:</span>_max_level<span class="token punctuation">;</span>    <span class="token keyword">return</span> k<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="å‹åŠ›æµ‹è¯•"><a href="#å‹åŠ›æµ‹è¯•" class="headerlink" title="å‹åŠ›æµ‹è¯•"></a>å‹åŠ›æµ‹è¯•</h1><h2 id="æ’å…¥æ•°æ®-1"><a href="#æ’å…¥æ•°æ®-1" class="headerlink" title="æ’å…¥æ•°æ®"></a>æ’å…¥æ•°æ®</h2><p>æ³¨æ„ï¼šé¡ºåºæ’å…¥ä¸ºforå¾ªç¯ä»0å¼€å§‹åˆ°æ•°æ®æ€»æ•°é€ä¸ªæ•°æ’å…¥ï¼ˆ for(0 ~insertNum) ï¼‰</p><p>éšæœºæ’å…¥åˆ™æ˜¯åœ¨æ’å…¥æ•°æ®æ€»æ•°èŒƒå›´é—´å–éšæœºæ•°ï¼ˆ rand()%insertNum ï¼‰</p><p>åœ¨è®¾å®šè·³è¡¨æœ€é«˜å±‚ä¸º<strong>10å±‚</strong>æ—¶ï¼š</p><p>é¡ºåºæ’å…¥<strong>åä¸‡æ¡</strong>æ•°æ®å¹³å‡è€—æ—¶ï¼š210æ¯«ç§’ï¼›éšæœºæ’å…¥<strong>åä¸‡æ¡</strong>æ•°æ®å¹³å‡è€—æ—¶ï¼š92æ¯«ç§’</p><p>é¡ºåºæ’å…¥<strong>äº”åä¸‡æ¡</strong>æ•°æ®å¹³å‡è€—æ—¶ï¼š3850æ¯«ç§’ï¼›éšæœºæ’å…¥<strong>äº”åä¸‡æ¡</strong>æ•°æ®å¹³å‡è€—æ—¶ï¼š380æ¯«ç§’</p><p>é¡ºåºæ’å…¥<strong>ç™¾ä¸‡æ¡</strong>æ•°æ®å¹³å‡è€—æ—¶ï¼š21473æ¯«ç§’ï¼›éšæœºæ’å…¥<strong>ç™¾ä¸‡æ¡</strong>æ•°æ®å¹³å‡è€—æ—¶ï¼š744æ¯«ç§’</p><p>è€Œåœ¨è®¾å®šè·³è¡¨æœ€é«˜å±‚ä¸º<strong>20å±‚</strong>æ—¶ï¼š</p><p>é¡ºåºæ’å…¥<strong>åä¸‡æ¡</strong>æ•°æ®å¹³å‡è€—æ—¶ï¼š132æ¯«ç§’ï¼›éšæœºæ’å…¥<strong>åä¸‡æ¡</strong>æ•°æ®å¹³å‡è€—æ—¶ï¼š92æ¯«ç§’</p><p>é¡ºåºæ’å…¥<strong>äº”åä¸‡æ¡</strong>æ•°æ®å¹³å‡è€—æ—¶ï¼š683æ¯«ç§’ï¼›éšæœºæ’å…¥<strong>äº”åä¸‡æ¡</strong>æ•°æ®å¹³å‡è€—æ—¶ï¼š305æ¯«ç§’</p><p>é¡ºåºæ’å…¥<strong>ç™¾ä¸‡æ¡</strong>æ•°æ®å¹³å‡è€—æ—¶ï¼š1443æ¯«ç§’ï¼›éšæœºæ’å…¥<strong>ç™¾ä¸‡æ¡</strong>æ•°æ®å¹³å‡è€—æ—¶ï¼š600æ¯«ç§’</p><h2 id="æŸ¥æ‰¾æ•°æ®ï¼ˆè¿˜æœªå®Œæˆï¼‰"><a href="#æŸ¥æ‰¾æ•°æ®ï¼ˆè¿˜æœªå®Œæˆï¼‰" class="headerlink" title="æŸ¥æ‰¾æ•°æ®ï¼ˆè¿˜æœªå®Œæˆï¼‰"></a>æŸ¥æ‰¾æ•°æ®ï¼ˆè¿˜æœªå®Œæˆï¼‰</h2><p>åœ¨è®¾å®šè·³è¡¨æœ€é«˜å±‚ä¸º10å±‚æ—¶ï¼ˆæ•°æ®ä¸ºéšæœºç”Ÿæˆï¼‰ï¼š</p><p>åä¸‡æ¡æ•°æ®ä¸­æŸ¥æ‰¾åæ¡æ•°æ®å¹³å‡è€—æ—¶</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt; è·³è¡¨é¡¹ç›®ç›¸å¯¹äºWebServeræ¯”è¾ƒç®€å•ï¼Œå®é™…ä¸Šå°±æ˜¯å®ç°äº†è·³è¡¨è¿™ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹å­˜æ”¾çš„æ•°æ®æ˜¯ä¸€ä¸ª&lt;code&gt;Node&amp;lt;K,V&amp;gt;&lt;/code&gt;çš„ç»“æ„ï¼Œå’Œå“ˆå¸Œè¡¨æœ‰ç‚¹ç±»ä¼¼&lt;/p&gt;
&lt;h1 id=&quot;åŠŸèƒ½&quot;&gt;&lt;a href=&quot;#åŠŸèƒ½&quot; class=&quot;heade</summary>
      
    
    
    
    <category term="é¢è¯•" scheme="http://sakura-pub.top/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="é¢è¯•" scheme="http://sakura-pub.top/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>WebServeré¡¹ç›®è§£æ</title>
    <link href="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/"/>
    <id>http://sakura-pub.top/%E9%9D%A2%E8%AF%95/WebServer%E9%A1%B9%E7%9B%AE%E8%A7%A3%E6%9E%90/</id>
    <published>2022-06-15T05:43:43.000Z</published>
    <updated>2022-07-13T16:16:36.237Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« æ˜¯ç”¨æ¥è®°å½•å¹¶å¤ä¹ ä¹‹å‰å†™è¿‡çš„ä¸€ä¸ªTinyWebServeré¡¹ç›®ï¼Œå¸Œæœ›å¯ä»¥æ¢³ç†ä¸€ä¸‹æ€è·¯ï¼Œæ›´è¿›ä¸€æ­¥å¸æ”¶é‡Œé¢çš„çŸ¥è¯†ç‚¹ï¼Œå‰é¢å‡ ä¸ªéƒ¨åˆ†æ˜¯ç½‘ä¸Šæ‰¾çš„çŸ¥è¯†ç‚¹æ€»ç»“ï¼Œåé¢ä¹Ÿæœ‰è‡ªå·±å¯¹é¡¹ç›®çš„åˆ†æ</p><h1 id="WebServeræ€»ä½“æ¦‚è¿°"><a href="#WebServeræ€»ä½“æ¦‚è¿°" class="headerlink" title="WebServeræ€»ä½“æ¦‚è¿°"></a>WebServeræ€»ä½“æ¦‚è¿°</h1><ul><li>epoll çš„ <code>ET</code>å’Œ<code>LT</code>æ¨¡å¼</li><li>MySQLæ•°æ®åº“</li><li>æ•°æ®åº“è¿æ¥æ± </li><li>çº¿ç¨‹æ± </li><li>æ—¥å¿—ç³»ç»Ÿ</li><li>å®šæ—¶å™¨</li><li>Reactoræ¨¡å¼ï¼ˆè®¾è®¡æ¨¡å¼ï¼šååº”å †æ¨¡å¼ï¼‰</li><li>HTTP</li><li>å¤§ç«¯åºå’Œå°ç«¯åºçš„äº’è½¬</li><li>è¯»å†™ç¼“å†²åŒº</li></ul><h1 id="WebServerå¤§æ¦‚çš„å·¥ä½œæµç¨‹"><a href="#WebServerå¤§æ¦‚çš„å·¥ä½œæµç¨‹" class="headerlink" title="WebServerå¤§æ¦‚çš„å·¥ä½œæµç¨‹"></a>WebServerå¤§æ¦‚çš„å·¥ä½œæµç¨‹</h1><p>è¿™é‡Œæœ‰å¼ å›¾å¯ä»¥æ¦‚æ‹¬æ•´ä¸ªServerçš„å·¥ä½œæµç¨‹</p><p><img src="https://pic.rmb.bdstatic.com/bjh/0af1379f52f5a695800cfb33599035fa.jpeg" alt="v2-c16b9b3c7c2e279227204a88fc95d1bb_r.jpg"></p><p>åˆ†ç‚¹æ¥è¯´å¦‚ä¸‹ï¼š</p><ol><li>ä¸»çº¿ç¨‹ç›‘å¬è¿æ¥</li><li>ä¸»çº¿ç¨‹è®©ä¸€ä¸ªepollç›‘å¬æ´»è·ƒçš„æ–‡ä»¶æè¿°ç¬¦</li><li>å¤„ç†å®Œè¿æ¥è¿›æ¥çš„æ–‡ä»¶æè¿°ç¬¦ä¹‹åå¼€å·¥ä½œçº¿ç¨‹</li><li>å·¥ä½œçº¿ç¨‹å¤„ç†ä»»åŠ¡ï¼ˆè¯»å’Œå†™ä»»åŠ¡æ˜¯åˆ†å¼€çš„ï¼Œä¸ä¸€å®šæ˜¯åŒä¸€ä¸ªçº¿ç¨‹å…±åŒæ“ä½œï¼‰</li><li>http_connæ˜¯ä¸€ä¸ªè´Ÿè´£HTTPè¯·æ±‚çš„å“åº”å’Œå¤„ç†çš„ç±»ï¼Œä¸€ä¸ªç”¨æˆ·ä¸€ä¸ªå®ä¾‹ï¼›åŒæ—¶åœ¨è§£æè¯·æ±‚æŠ¥æ–‡æ—¶æœ‰ä¸»ä»çŠ¶æ€æœºï¼Œä»çŠ¶æ€æœºæ˜¯è´Ÿè´£è¯»å–æŠ¥æ–‡çš„ä¸€è¡Œï¼Œä¸»çŠ¶æ€æœºæ˜¯è´Ÿè´£å¯¹è¯¥è¡Œæ•°æ®è¿›è¡Œè§£æ</li></ol><h1 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h1><p>å¯¹äºæœåŠ¡å™¨çš„æ•ˆç‡ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªæ–¹é¢å¯ä»¥æ¥ä¼˜åŒ–</p><h2 id="åŠåŒæ­¥åŠååº”å †ï¼ˆåŠåŒæ­¥åŠå¼‚æ­¥ï¼‰"><a href="#åŠåŒæ­¥åŠååº”å †ï¼ˆåŠåŒæ­¥åŠå¼‚æ­¥ï¼‰" class="headerlink" title="åŠåŒæ­¥åŠååº”å †ï¼ˆåŠåŒæ­¥åŠå¼‚æ­¥ï¼‰"></a>åŠåŒæ­¥åŠååº”å †ï¼ˆåŠåŒæ­¥åŠå¼‚æ­¥ï¼‰</h2><ul><li>åŠåŒæ­¥åŠååº”å †æ˜¯å…¶ä¸­ä¸€ç§é«˜æ•ˆçš„å¹¶å‘æ¨¡å¼å®ç°æ–¹å¼ï¼Œå¦ä¸€ç§å¹¶å‘æ¨¡å¼ä¸ºé¢†å¯¼è€…/è¿½éšè€…æ¨¡å¼</li><li>å¹¶å‘æ¨¡å¼æŒ‡çš„æ˜¯I/Oå¤„ç†å•å…ƒå’Œå¤šä¸ªé€»è¾‘å•å…ƒä¹‹é—´åè°ƒå®Œæˆä»»åŠ¡çš„æ–¹æ³•</li><li>åŠåŒæ­¥/åŠååº”å †çš„å†…å®¹ï¼š<ul><li>å¼‚æ­¥çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œç”±ä¸»çº¿ç¨‹å……å½“ã€‚è´Ÿè´£ç›‘å¬æ‰€æœ‰socketä¸Šçš„äº‹ä»¶ã€‚å¦‚æœæœ‰æ–°è¿æ¥è¯·æ±‚ï¼Œä¸»çº¿ç¨‹æ¥å—å¾—åˆ°æ–°çš„è¿æ¥socketï¼Œå¾€epollå†…æ ¸äº‹ä»¶è¡¨ä¸­æ³¨å†Œsocketä¸Šçš„è¯»å†™äº‹ä»¶ã€‚å¦‚æœè¿æ¥ä¸Šæœ‰è¯»å†™äº‹ä»¶ï¼Œä¸»çº¿ç¨‹å°†è¯¥è¿æ¥socketæ’å…¥è¯·æ±‚é˜Ÿåˆ—ã€‚æ‰€æœ‰å·¥ä½œçº¿ç¨‹ï¼ˆåŒæ­¥çº¿ç¨‹ï¼‰ç¡çœ åœ¨è¯·æ±‚é˜Ÿåˆ—ä¸Šï¼Œå½“æœ‰ä»»åŠ¡åˆ°æ¥ï¼Œé€šè¿‡ç«äº‰çš„æ–¹å¼è·å¾—ä»»åŠ¡ç®¡ç†æƒã€‚</li><li>ä¸Šé¢çš„æ–¹å¼é‡‡ç”¨çš„äº‹ä»¶å¤„ç†æ¨¡å¼ä¸º<strong>Reactoræ¨¡å¼</strong>ã€‚è¦æ±‚å·¥ä½œçº¿ç¨‹è‡ªå·±ä»socketä¸Šè¯»å–å®¢æˆ·è¯·æ±‚å’Œå¾€socketä¸Šå†™å…¥æœåŠ¡å™¨åº”ç­”ã€‚</li><li>ä¹Ÿå¯ä»¥é‡‡ç”¨æ¨¡æ‹Ÿçš„<strong>Proactoräº‹ä»¶</strong>å¤„ç†æ¨¡å¼ã€‚è¦æ±‚ä¸»çº¿ç¨‹å®Œæˆæ•°æ®çš„è¯»å†™ï¼Œä¸»çº¿ç¨‹å°†åº”ç”¨ç¨‹åºæ•°æ®ã€ä»»åŠ¡ç±»å‹ç­‰ä¿¡æ¯å°è£…æˆä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œç„¶åæ’å…¥è¯·æ±‚é˜Ÿåˆ—ï¼›å·¥ä½œçº¿ç¨‹ä»è¯·æ±‚é˜Ÿåˆ—ä¸­å–å¾—ä»»åŠ¡å¯¹è±¡åï¼Œç›´æ¥å¤„ç†å³å¯ï¼Œä¸éœ€è¦è¯»å†™æ“ä½œã€‚</li></ul></li><li>åŠåŒæ­¥/åŠååº”å †çš„ç¼ºç‚¹ï¼š<ul><li>ä¸»çº¿ç¨‹å’Œå·¥ä½œçº¿ç¨‹å…±äº«è¯·æ±‚é˜Ÿåˆ—ã€‚ä¸»çº¿ç¨‹æ·»åŠ ä»»åŠ¡ã€å·¥ä½œçº¿ç¨‹å–å‡ºä»»åŠ¡ï¼Œéƒ½éœ€è¦å¯¹è¯·æ±‚é˜Ÿåˆ—è¿›è¡ŒåŠ é”ä¿æŠ¤ï¼Œä»è€Œè€—è´¹cpuæ—¶é—´ã€‚</li><li>æ¯ä¸ªå·¥ä½œçº¿ç¨‹åŒä¸€ä¸ªæ—¶é—´åªèƒ½å¤„ç†ä¸€ä¸ªå®¢æˆ·è¯·æ±‚</li></ul></li></ul><h2 id="å¤šè¿›ç¨‹æ¨¡å‹"><a href="#å¤šè¿›ç¨‹æ¨¡å‹" class="headerlink" title="å¤šè¿›ç¨‹æ¨¡å‹"></a>å¤šè¿›ç¨‹æ¨¡å‹</h2><ul><li>ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ†é…ä¸€ä¸ªè¿›ç¨‹æ¥å¤„ç†è¯·æ±‚ã€‚</li><li>æœåŠ¡å™¨çš„ä¸»è¿›ç¨‹è´Ÿè´£ç›‘å¬å®¢æˆ·çš„è¿æ¥ï¼Œä¸€æ—¦ä¸å®¢æˆ·ç«¯è¿æ¥å®Œæˆï¼Œaccept() å‡½æ•°å°±ä¼šè¿”å›ä¸€ä¸ªã€Œå·²è¿æ¥ Socketã€ï¼Œè¿™æ—¶å°±é€šè¿‡ <code>fork()</code> å‡½æ•°åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå®é™…ä¸Šå°±æŠŠçˆ¶è¿›ç¨‹æ‰€æœ‰ç›¸å…³çš„ä¸œè¥¿éƒ½<strong>å¤åˆ¶</strong>ä¸€ä»½ï¼ŒåŒ…æ‹¬æ–‡ä»¶æè¿°ç¬¦ã€å†…å­˜åœ°å€ç©ºé—´ã€ç¨‹åºè®¡æ•°å™¨ã€æ‰§è¡Œçš„ä»£ç ç­‰ã€‚<ul><li>æ ¹æ®è¿”å›å€¼æ¥åŒºåˆ†æ˜¯çˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹ï¼Œå¦‚æœè¿”å›å€¼æ˜¯ 0ï¼Œåˆ™æ˜¯å­è¿›ç¨‹ï¼›å¦‚æœè¿”å›å€¼æ˜¯å…¶ä»–çš„æ•´æ•°ï¼Œå°±æ˜¯çˆ¶è¿›ç¨‹ã€‚    <ul><li>å› ä¸ºå­è¿›ç¨‹ä¼š<strong>å¤åˆ¶çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦</strong>ï¼Œäºæ˜¯å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€Œå·²è¿æ¥ Socket ã€å’Œå®¢æˆ·ç«¯é€šä¿¡äº†ã€‚ </li><li>å­è¿›ç¨‹ä¸éœ€è¦å…³å¿ƒã€Œç›‘å¬ Socketã€ï¼Œåªéœ€è¦å…³å¿ƒã€Œå·²è¿æ¥ Socketã€ï¼›çˆ¶è¿›ç¨‹åˆ™ç›¸åï¼Œå°†å®¢æˆ·æœåŠ¡äº¤ç»™å­è¿›ç¨‹æ¥å¤„ç†ï¼Œå› æ­¤çˆ¶è¿›ç¨‹ä¸éœ€è¦å…³å¿ƒã€Œå·²è¿æ¥ Socketã€ï¼Œåªéœ€è¦å…³å¿ƒã€Œç›‘å¬ Socketã€ã€‚ </li></ul></li></ul></li><li>å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼š<ul><li>å½“ã€Œå­è¿›ç¨‹ã€é€€å‡ºæ—¶ï¼Œå®é™…ä¸Šå†…æ ¸é‡Œè¿˜ä¼šä¿ç•™è¯¥è¿›ç¨‹çš„ä¸€äº›ä¿¡æ¯ï¼Œä¹Ÿæ˜¯ä¼šå ç”¨å†…å­˜çš„ï¼Œå¦‚æœä¸åšå¥½â€œå›æ”¶â€å·¥ä½œï¼Œå°±ä¼šå˜æˆåƒµå°¸è¿›ç¨‹ï¼Œéšç€åƒµå°¸è¿›ç¨‹è¶Šå¤šï¼Œä¼šæ…¢æ…¢è€—å°½æˆ‘ä»¬çš„ç³»ç»Ÿèµ„æºã€‚    <ul><li>çˆ¶è¿›ç¨‹è¦â€œå–„åâ€å¥½è‡ªå·±çš„å­©å­ï¼Œæ€ä¹ˆå–„åå‘¢ï¼Ÿé‚£ä¹ˆæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥åœ¨å­è¿›ç¨‹é€€å‡ºåå›æ”¶èµ„æºï¼Œåˆ†åˆ«æ˜¯è°ƒç”¨ <code>wait()</code> å’Œ <code>waitpid()</code> å‡½æ•°ã€‚ </li><li>è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸ä»…åŒ…å«äº†è™šæ‹Ÿå†…å­˜ã€æ ˆã€å…¨å±€å˜é‡ç­‰ç”¨æˆ·ç©ºé—´çš„èµ„æºï¼Œè¿˜åŒ…æ‹¬äº†å†…æ ¸å †æ ˆã€å¯„å­˜å™¨ç­‰å†…æ ¸ç©ºé—´çš„èµ„æºã€‚</li></ul></li></ul></li></ul><h2 id="å¤šçº¿ç¨‹æ¨¡å‹"><a href="#å¤šçº¿ç¨‹æ¨¡å‹" class="headerlink" title="å¤šçº¿ç¨‹æ¨¡å‹"></a>å¤šçº¿ç¨‹æ¨¡å‹</h2><ul><li>çº¿ç¨‹æ˜¯è¿è¡Œåœ¨è¿›ç¨‹ä¸­çš„ä¸€ä¸ªâ€œé€»è¾‘æµâ€ï¼Œå•è¿›ç¨‹ä¸­å¯ä»¥è¿è¡Œå¤šä¸ªçº¿ç¨‹ï¼ŒåŒè¿›ç¨‹é‡Œçš„çº¿ç¨‹å¯ä»¥å…±äº«è¿›ç¨‹çš„éƒ¨åˆ†èµ„æºçš„ï¼Œæ¯”å¦‚<strong>æ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨ã€è¿›ç¨‹ç©ºé—´ã€ä»£ç ã€å…¨å±€æ•°æ®ã€å †ã€å…±äº«åº“ç­‰ï¼Œè¿™äº›å…±äº«èµ„æº</strong>åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶æ˜¯ä¸éœ€è¦åˆ‡æ¢ï¼Œè€Œåªéœ€è¦åˆ‡æ¢çº¿ç¨‹çš„<strong>ç§æœ‰æ•°æ®ã€å¯„å­˜å™¨ç­‰ä¸å…±äº«çš„æ•°æ®</strong>ï¼Œå› æ­¤åŒä¸€ä¸ªè¿›ç¨‹ä¸‹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€è¦æ¯”è¿›ç¨‹å°å¾—å¤šã€‚ </li><li>å½“æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ TCP å®Œæˆè¿æ¥åï¼Œé€šè¿‡ <code>pthread_create()</code> å‡½æ•°åˆ›å»ºçº¿ç¨‹ï¼Œç„¶åå°†ã€Œå·²è¿æ¥ Socketã€çš„æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™çº¿ç¨‹å‡½æ•°ï¼Œæ¥ç€åœ¨çº¿ç¨‹é‡Œå’Œå®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ï¼Œä»è€Œè¾¾åˆ°å¹¶å‘å¤„ç†çš„ç›®çš„ã€‚ </li><li>æ³¨æ„äº‹é¡¹ ï¼š <ul><li>çˆ¶è¿›ç¨‹acceptåä¼šæŠŠsocketæ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ã€‚ç„¶åçº¿ç¨‹ä»è¿™ä¸ªé˜Ÿåˆ—ä¸­å–socketåšæ“ä½œ </li><li>è¿™ä¸ªé˜Ÿåˆ—æ˜¯å…¨å±€çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæ“ä½œï¼Œä¸ºäº†é¿å…å¤šçº¿ç¨‹ç«äº‰ï¼Œçº¿ç¨‹åœ¨æ“ä½œè¿™ä¸ªé˜Ÿåˆ—å‰è¦åŠ é”ã€‚</li></ul></li></ul><h2 id="Proactoræ¨¡å¼å’ŒReactoræ¨¡å¼"><a href="#Proactoræ¨¡å¼å’ŒReactoræ¨¡å¼" class="headerlink" title="Proactoræ¨¡å¼å’ŒReactoræ¨¡å¼"></a>Proactoræ¨¡å¼å’ŒReactoræ¨¡å¼</h2><p>æœåŠ¡å™¨ç¨‹åºé€šå¸¸éœ€è¦å¤„ç†ä¸‰ç±»äº‹ä»¶ï¼šI/Oäº‹ä»¶ï¼Œä¿¡å·åŠå®šæ—¶äº‹ä»¶ã€‚æœ‰ä¸¤ç§äº‹ä»¶å¤„ç†æ¨¡å¼å³<strong>Proactoræ¨¡å¼</strong>å’Œ<strong>Reactoræ¨¡å¼</strong>ï¼š</p><ul><li>Reactoræ¨¡å¼ï¼šè¦æ±‚ä¸»çº¿ç¨‹ï¼ˆI/Oå¤„ç†å•å…ƒï¼‰åªè´Ÿè´£ç›‘å¬æ–‡ä»¶æè¿°ç¬¦ä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼ˆå¯è¯»ã€å¯å†™ï¼‰ï¼Œè‹¥æœ‰ï¼Œåˆ™ç«‹å³é€šçŸ¥å·¥ä½œçº¿ç¨‹ï¼ˆé€»è¾‘å•å…ƒï¼‰ï¼Œå°†socketå¯è¯»å¯å†™äº‹ä»¶æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—ï¼Œäº¤ç»™å·¥ä½œçº¿ç¨‹å¤„ç†ã€‚</li><li>Proactoræ¨¡å¼ï¼šå°†æ‰€æœ‰çš„I/Oæ“ä½œéƒ½äº¤ç»™ä¸»çº¿ç¨‹å’Œå†…æ ¸æ¥å¤„ç†ï¼ˆè¿›è¡Œè¯»ã€å†™ï¼‰ï¼Œå·¥ä½œçº¿ç¨‹ä»…è´Ÿè´£å¤„ç†é€»è¾‘ï¼Œå¦‚ä¸»çº¿ç¨‹è¯»å®Œæˆå<code>users[sockfd].read()</code>ï¼Œé€‰æ‹©ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ¥å¤„ç†å®¢æˆ·è¯·æ±‚<code>pool-&gt;append(users + sockfd)</code>ã€‚</li></ul><p>æœ‰å…³æ›´è¯¦ç»†çš„ä»‹ç»ï¼Œå¯ä»¥ç‚¹<a href="https://www.zhihu.com/question/26943938">è¿™é‡Œ</a></p><p>ä¸‹é¢ä¸ºé¡¹ç›®ä¸­è¿ç”¨äº†ä¸¤ä¸ªæ¨¡å¼çš„ä»£ç ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">deal_with_thread</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    util_timer<span class="token operator">*</span> timer<span class="token operator">=</span>users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>    <span class="token comment">//reactoræ¨¡å¼</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>m_actormodel<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>            <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//è‹¥ç›‘æµ‹åˆ°è¯»äº‹ä»¶ï¼Œå°†è¯¥äº‹ä»¶æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—</span>        m_pool<span class="token operator">-></span><span class="token function">append</span><span class="token punctuation">(</span>users<span class="token operator">+</span>sockfd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>                    users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token comment">//while</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token comment">//proactor</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"deal with the client(%s)"</span><span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//è‹¥ç›‘æµ‹åˆ°è¯»äº‹ä»¶ï¼Œå°†è¯¥äº‹ä»¶æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—</span>            m_pool<span class="token operator">-></span><span class="token function">append_p</span><span class="token punctuation">(</span>users<span class="token operator">+</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>                <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span>            <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="å¤§ç«¯åºå°ç«¯åº"><a href="#å¤§ç«¯åºå°ç«¯åº" class="headerlink" title="å¤§ç«¯åºå°ç«¯åº"></a>å¤§ç«¯åºå°ç«¯åº</h1><p><strong>ç½‘ç»œåºæ˜¯å¤§ç«¯å­—èŠ‚åº</strong></p><p><strong>å¤§ç«¯å­—èŠ‚åº</strong>æ˜¯çœ‹ç€ä¸€æ ·çš„ï¼Œæ•°æ®ä½ä½å­˜åœ¨å†…å­˜å¤§ä½(é«˜ä½)</p><p>å°ç«¯å­—èŠ‚åºçœ‹ç€æ˜¯åè¿‡æ¥çš„ï¼Œæ•°æ®ä½ä½å­˜åœ¨å†…å­˜å°ä½(ä½ä½)</p><p>å­—èŠ‚åºçš„å•ä½åº”è¯¥æ˜¯å­—èŠ‚ï¼Œæ‰€ä»¥string(charä¸ºç»„ç»‡ç»“æ„)æ˜¯æ²¡æœ‰å¤§å°ç«¯ä¹‹åˆ†çš„ã€‚</p><p>ä½†æ˜¯çœ‹intå’Œshortæ˜¯èƒ½çœ‹å‡ºæ¥æ˜¯å¤§ç«¯å­—èŠ‚åºè¿˜æ˜¯å°ç«¯å­—èŠ‚åºï¼Œå€ŸåŠ©unionã€‚</p><p>æœ‰ç°æˆçš„è½¬æ¢å‡½æ•°ã€‚BSD Socketæä¾›äº†å°è£…å¥½çš„è½¬æ¢æ¥å£ï¼Œæ–¹ä¾¿ç¨‹åºå‘˜ä½¿ç”¨ã€‚åŒ…æ‹¬ä»ä¸»æœºå­—èŠ‚åºåˆ°ç½‘ç»œå­—èŠ‚åºçš„è½¬æ¢å‡½æ•°ï¼š htonsã€htonlï¼›ä»ç½‘ç»œå­—èŠ‚åºåˆ°ä¸»æœºå­—èŠ‚åºçš„è½¬æ¢å‡½æ•°ï¼šntohsã€ntohlã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*** h   - host ä¸»æœºï¼Œä¸»æœºå­—èŠ‚åº* to  - è½¬æ¢æˆä»€ä¹ˆ* n   - network  ç½‘ç»œå­—èŠ‚åº* s   - short  unsigned short * l   - long  unsigned int**/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="HTTPç›¸å…³"><a href="#HTTPç›¸å…³" class="headerlink" title="HTTPç›¸å…³"></a>HTTPç›¸å…³</h1><h2 id="ä¸€æ¬¡HTTPè¯·æ±‚å“åº”çš„æµç¨‹"><a href="#ä¸€æ¬¡HTTPè¯·æ±‚å“åº”çš„æµç¨‹" class="headerlink" title="ä¸€æ¬¡HTTPè¯·æ±‚å“åº”çš„æµç¨‹"></a>ä¸€æ¬¡HTTPè¯·æ±‚å“åº”çš„æµç¨‹</h2><ul><li>åŸŸåè§£æ </li><li>å‘èµ·TCPçš„3æ¬¡æ¡æ‰‹ </li><li>å»ºç«‹TCPè¿æ¥åå‘èµ·httpè¯·æ±‚ </li><li>æœåŠ¡å™¨å“åº”httpè¯·æ±‚ï¼Œæµè§ˆå™¨å¾—åˆ°htmlä»£ç  </li><li>æµè§ˆå™¨è§£æhtmlä»£ç ï¼Œå¹¶è¯·æ±‚htmlä»£ç ä¸­çš„èµ„æºï¼ˆå¦‚jsã€cssã€å›¾ç‰‡ç­‰ï¼‰ </li><li>æµè§ˆå™¨å¯¹é¡µé¢è¿›è¡Œæ¸²æŸ“å‘ˆç°ç»™ç”¨æˆ· </li></ul><h2 id="HTTPæ–¹æ³•"><a href="#HTTPæ–¹æ³•" class="headerlink" title="HTTPæ–¹æ³•"></a>HTTPæ–¹æ³•</h2><ul><li>GETï¼šç”¨äºè¯·æ±‚è®¿é—®å·²ç»è¢«URIï¼ˆç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦ï¼‰è¯†åˆ«çš„èµ„æºï¼Œå¯ä»¥é€šè¿‡URLä¼ å‚ç»™æœåŠ¡å™¨ </li><li>POSTï¼šç”¨äºä¼ è¾“ä¿¡æ¯ç»™æœåŠ¡å™¨ï¼Œä¸»è¦åŠŸèƒ½ä¸GETæ–¹æ³•ç±»ä¼¼ï¼Œä½†ä¸€èˆ¬æ¨èä½¿ç”¨POSTæ–¹å¼ã€‚ </li><li>PUTï¼šä¼ è¾“æ–‡ä»¶ï¼ŒæŠ¥æ–‡ä¸»ä½“ä¸­åŒ…å«æ–‡ä»¶å†…å®¹ï¼Œä¿å­˜åˆ°å¯¹åº”URIä½ç½®ã€‚ </li><li>HEADï¼šè·å¾—è±¹çº¹ä¸ï¼Œä¸GETç±»ä¼¼ï¼Œåªæ˜¯ä¸è¿”å›æŠ¥æ–‡ä¸»ä½“ï¼Œä¸€èˆ¬ç”¨äºéªŒè¯URIæ˜¯å¦æœ‰æ•ˆã€‚ </li><li>DELETEï¼šåˆ é™¤æ–‡ä»¶ï¼Œä¸PUTç›¸åï¼Œåˆ é™¤å¯¹åº”URIä½ç½®æ–‡ä»¶ã€‚ </li><li>OPTIONSï¼šæŸ¥è¯¢ç›¸åº”URIæ”¯æŒçš„HTTPæ–¹æ³•ã€‚ </li></ul><h2 id="GETã€POSTåŒºåˆ«"><a href="#GETã€POSTåŒºåˆ«" class="headerlink" title="GETã€POSTåŒºåˆ«"></a>GETã€POSTåŒºåˆ«</h2><ul><li><p>geté‡ç‚¹åœ¨ä»æœåŠ¡å™¨ä¸Šè·å–èµ„æºï¼›</p></li><li><p>posté‡ç‚¹åœ¨å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼›</p></li><li><p>getä¼ è¾“æ•°æ®æ˜¯é€šè¿‡URLè¯·æ±‚ï¼Œä»¥fieldï¼ˆå­—æ®µï¼‰= valueçš„å½¢å¼ï¼Œç½®äºURLåï¼Œå¹¶ç”¨â€?â€è¿æ¥ï¼Œå¤šä¸ªè¯·æ±‚æ•°æ®é—´ç”¨â€&amp;â€è¿æ¥ï¼Œå¦‚<code>http://127.0.0.1/Test/login.action?name=admin&amp;password=admin</code>ï¼Œè¿™ä¸ªè¿‡ç¨‹ç”¨æˆ·æ˜¯å¯è§çš„ï¼› </p></li><li><p>postä¼ è¾“æ•°æ®é€šè¿‡Httpçš„postæœºåˆ¶ï¼Œå°†å­—æ®µä¸å¯¹åº”å€¼å°å­˜åœ¨è¯·æ±‚å®ä½“ä¸­å‘é€ç»™æœåŠ¡å™¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯¹ç”¨æˆ·æ˜¯ä¸å¯è§çš„ï¼› </p></li><li><p>Getä¼ è¾“çš„æ•°æ®é‡å°ï¼Œå› ä¸ºå—URLé•¿åº¦é™åˆ¶ï¼Œä½†æ•ˆç‡è¾ƒé«˜ï¼› </p></li><li><p>Postå¯ä»¥ä¼ è¾“å¤§é‡æ•°æ®ï¼Œæ‰€ä»¥ä¸Šä¼ æ–‡ä»¶æ—¶åªèƒ½ç”¨Postæ–¹å¼ï¼› </p></li><li><p>getæ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºURLæ˜¯å¯è§çš„ï¼Œå¯èƒ½ä¼šæ³„éœ²ç§å¯†ä¿¡æ¯ï¼Œå¦‚å¯†ç ç­‰ï¼› </p></li><li><p>postè¾ƒgetå®‰å…¨æ€§è¾ƒé«˜ï¼› </p></li><li><p>getæ–¹å¼åªèƒ½æ”¯æŒASCIIå­—ç¬¦ï¼Œå‘æœåŠ¡å™¨ä¼ çš„ä¸­æ–‡å­—ç¬¦å¯èƒ½ä¼šä¹±ç ã€‚ </p></li><li><p>postæ”¯æŒæ ‡å‡†å­—ç¬¦é›†ï¼Œå¯ä»¥æ­£ç¡®ä¼ é€’ä¸­æ–‡å­—ç¬¦ã€‚ </p></li></ul><h2 id="çŠ¶æ€ç "><a href="#çŠ¶æ€ç " class="headerlink" title="çŠ¶æ€ç "></a>çŠ¶æ€ç </h2><ul><li><p>1xxï¼šæŒ‡ç¤ºä¿¡æ¯â€“è¡¨ç¤ºè¯·æ±‚å·²æ¥æ”¶ï¼Œç»§ç»­å¤„ç† </p></li><li><p>2xxï¼šæˆåŠŸâ€“è¡¨ç¤ºè¯·æ±‚å·²è¢«æˆåŠŸæ¥æ”¶ã€ç†è§£ã€æ¥å—   </p><ul><li><strong>200</strong>ï¼šè¯·æ±‚è¢«æ­£å¸¸å¤„ç† </li><li>204ï¼šè¯·æ±‚è¢«å—ç†ä½†æ²¡æœ‰èµ„æºå¯ä»¥è¿”å› </li><li>206ï¼šå®¢æˆ·ç«¯åªæ˜¯è¯·æ±‚èµ„æºçš„ä¸€éƒ¨åˆ†ï¼ŒæœåŠ¡å™¨åªå¯¹è¯·æ±‚çš„éƒ¨åˆ†èµ„æºæ‰§è¡ŒGETæ–¹æ³•ï¼Œç›¸åº”æŠ¥æ–‡ä¸­é€šè¿‡Content-RangeæŒ‡å®šèŒƒå›´çš„èµ„æºã€‚ </li></ul></li><li><p>3xxï¼šé‡å®šå‘â€“è¦å®Œæˆè¯·æ±‚å¿…é¡»è¿›è¡Œæ›´è¿›ä¸€æ­¥çš„æ“ä½œ   </p><ul><li><strong>301</strong>ï¼šæ°¸ä¹…æ€§é‡å®šå‘ </li><li><strong>302</strong>ï¼šä¸´æ—¶é‡å®šå‘ </li><li>303ï¼šä¸302çŠ¶æ€ç æœ‰ç›¸ä¼¼åŠŸèƒ½ï¼Œåªæ˜¯å®ƒå¸Œæœ›å®¢æˆ·ç«¯åœ¨è¯·æ±‚ä¸€ä¸ªURIçš„æ—¶å€™ï¼Œèƒ½é€šè¿‡GETæ–¹æ³•é‡å®šå‘åˆ°å¦ä¸€ä¸ªURIä¸Š </li><li>304ï¼šå‘é€é™„å¸¦æ¡ä»¶çš„è¯·æ±‚æ—¶ï¼Œæ¡ä»¶ä¸æ»¡è¶³æ—¶è¿”å›ï¼Œä¸é‡å®šå‘æ— å…³ </li><li>307ï¼šä¸´æ—¶é‡å®šå‘ï¼Œä¸302ç±»ä¼¼ï¼Œåªæ˜¯å¼ºåˆ¶è¦æ±‚ä½¿ç”¨POSTæ–¹æ³• </li></ul></li><li><p>4xxï¼šå®¢æˆ·ç«¯é”™è¯¯â€“è¯·æ±‚æœ‰è¯­æ³•é”™è¯¯æˆ–è¯·æ±‚æ— æ³•å®ç°   </p><ul><li><strong>400ï¼š</strong>è¯·æ±‚æŠ¥æ–‡è¯­æ³•æœ‰è¯¯ï¼ŒæœåŠ¡å™¨æ— æ³•è¯†åˆ« </li><li>401ï¼šè¯·æ±‚éœ€è¦è®¤è¯ </li><li><strong>403</strong>ï¼šè¯·æ±‚çš„å¯¹åº”èµ„æºç¦æ­¢è¢«è®¿é—® </li><li><strong>404</strong>ï¼šæœåŠ¡å™¨æ— æ³•æ‰¾åˆ°å¯¹åº”èµ„æº </li></ul></li><li><p>5xxï¼šæœåŠ¡å™¨ç«¯é”™è¯¯â€“æœåŠ¡å™¨æœªèƒ½å®ç°åˆæ³•çš„è¯·æ±‚  </p><ul><li><strong>500ï¼š</strong>æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ </li><li><strong>503ï¼š</strong>æœåŠ¡å™¨æ­£å¿™ </li></ul></li></ul><h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><h3 id="HTTP-ä¸-HTTPS-æœ‰å“ªäº›åŒºåˆ«ï¼Ÿ"><a href="#HTTP-ä¸-HTTPS-æœ‰å“ªäº›åŒºåˆ«ï¼Ÿ" class="headerlink" title="HTTP ä¸ HTTPS æœ‰å“ªäº›åŒºåˆ«ï¼Ÿ"></a>HTTP ä¸ HTTPS æœ‰å“ªäº›åŒºåˆ«ï¼Ÿ</h3><ol><li>HTTP æ˜¯è¶…â½‚æœ¬ä¼ è¾“åè®®ï¼Œä¿¡æ¯æ˜¯æ˜â½‚ä¼ è¾“ï¼Œå­˜åœ¨å®‰å…¨â»›é™©çš„é—®é¢˜ã€‚HTTPS åˆ™è§£å†³ HTTP ä¸å®‰å…¨çš„ç¼ºé™·ï¼Œåœ¨ TCP å’Œ HTTP â½¹ç»œå±‚ä¹‹é—´åŠ â¼Šäº† SSL/TLS å®‰å…¨åè®®ï¼Œä½¿å¾—æŠ¥â½‚èƒ½å¤ŸåŠ å¯†ä¼ è¾“ã€‚ </li><li>HTTP è¿æ¥å»ºâ½´ç›¸å¯¹ç®€å•ï¼Œ TCP ä¸‰æ¬¡æ¡â¼¿ä¹‹åä¾¿å¯è¿›â¾ HTTP çš„æŠ¥â½‚ä¼ è¾“ã€‚â½½ HTTPS åœ¨ TCP ä¸‰æ¬¡æ¡â¼¿ä¹‹åï¼Œè¿˜éœ€è¿›â¾ SSL/TLS çš„æ¡â¼¿è¿‡ç¨‹ï¼Œæ‰å¯è¿›â¼ŠåŠ å¯†æŠ¥â½‚ä¼ è¾“ã€‚ </li><li>HTTP çš„ç«¯â¼å·æ˜¯ 80ï¼ŒHTTPS çš„ç«¯â¼å·æ˜¯ 443ã€‚ </li><li>HTTPS åè®®éœ€è¦å‘ CAï¼ˆè¯ä¹¦æƒå¨æœºæ„ï¼‰ç”³è¯·æ•°å­—è¯ä¹¦ï¼Œæ¥ä¿è¯æœåŠ¡å™¨çš„èº«ä»½æ˜¯å¯ä¿¡çš„ã€‚ </li></ol><h3 id="HTTPS-é‡‡â½¤çš„æ˜¯å¯¹ç§°åŠ å¯†å’Œâ¾®å¯¹ç§°åŠ å¯†ç»“åˆçš„ã€Œæ··åˆåŠ å¯†ã€â½…å¼ï¼š"><a href="#HTTPS-é‡‡â½¤çš„æ˜¯å¯¹ç§°åŠ å¯†å’Œâ¾®å¯¹ç§°åŠ å¯†ç»“åˆçš„ã€Œæ··åˆåŠ å¯†ã€â½…å¼ï¼š" class="headerlink" title="HTTPS é‡‡â½¤çš„æ˜¯å¯¹ç§°åŠ å¯†å’Œâ¾®å¯¹ç§°åŠ å¯†ç»“åˆçš„ã€Œæ··åˆåŠ å¯†ã€â½…å¼ï¼š"></a>HTTPS é‡‡â½¤çš„æ˜¯å¯¹ç§°åŠ å¯†å’Œâ¾®å¯¹ç§°åŠ å¯†ç»“åˆçš„ã€Œæ··åˆåŠ å¯†ã€â½…å¼ï¼š</h3><ul><li>åœ¨é€šä¿¡å»ºâ½´å‰é‡‡â½¤â¾®å¯¹ç§°åŠ å¯†çš„â½…å¼äº¤æ¢ã€Œä¼šè¯ç§˜é’¥ã€ï¼Œåç»­å°±ä¸å†ä½¿â½¤â¾®å¯¹ç§°åŠ å¯†ã€‚ </li><li>åœ¨é€šä¿¡è¿‡ç¨‹ä¸­å…¨éƒ¨ä½¿â½¤å¯¹ç§°åŠ å¯†çš„ã€Œä¼šè¯ç§˜é’¥ã€çš„â½…å¼åŠ å¯†æ˜â½‚æ•°æ®ã€‚ </li></ul><p>é‡‡â½¤ã€Œæ··åˆåŠ å¯†ã€çš„â½…å¼çš„åŸå› ï¼š</p><ul><li>å¯¹ç§°åŠ å¯†åªä½¿â½¤â¼€ä¸ªå¯†é’¥ï¼Œè¿ç®—é€Ÿåº¦å¿«ï¼Œå¯†é’¥å¿…é¡»ä¿å¯†ï¼Œâ½†æ³•åšåˆ°å®‰å…¨çš„å¯†é’¥äº¤æ¢ã€‚ </li><li>â¾®å¯¹ç§°åŠ å¯†ä½¿â½¤ä¸¤ä¸ªå¯†é’¥ï¼šå…¬é’¥å’Œç§é’¥ï¼Œå…¬é’¥å¯ä»¥ä»»æ„åˆ†å‘â½½ç§é’¥ä¿å¯†ï¼Œè§£å†³äº†å¯†é’¥äº¤æ¢é—®é¢˜ä½†é€Ÿåº¦æ…¢ã€‚ </li></ul><h3 id="ä»‹ç»ä¸€ä¸‹HTTP-1-HTTP-2-HTTP-3çš„å‘å±•å§"><a href="#ä»‹ç»ä¸€ä¸‹HTTP-1-HTTP-2-HTTP-3çš„å‘å±•å§" class="headerlink" title="ä»‹ç»ä¸€ä¸‹HTTP/1 HTTP/2 HTTP/3çš„å‘å±•å§"></a>ä»‹ç»ä¸€ä¸‹HTTP/1 HTTP/2 HTTP/3çš„å‘å±•å§</h3><ul><li><p>æŠ€æœ¯çš„å‘å±•éƒ½æ˜¯ä¸ºäº†è§£å†³æŸäº›é—®é¢˜ </p></li><li><p>HTTP/1çš„é—®é¢˜æ˜¯<strong>çŸ­é“¾æ¥æ¯æ¬¡éƒ½éœ€è¦ä¸‰æ¡å››æŒ¥</strong>ã€<strong>ä¸å®‰å…¨</strong>ï¼ˆHTTPsï¼‰ã€æ— çŠ¶æ€ï¼ˆCookieï¼‰ã€<strong>æœåŠ¡ç«¯ä¸èƒ½ä¸»åŠ¨å‘é€</strong>ã€‚(æ ¸å¿ƒï¼Œ1.0çŸ­è¿æ¥ 1.1å¯ä»¥é•¿è¿æ¥ ä¸å®‰å…¨) </p></li><li><p>HTTP/2é»˜è®¤äº†é•¿è¿æ¥ï¼ˆKeep-Aliveï¼‰ã€<strong>å¼•å…¥TLS/SSL</strong>ã€Cookieã€æœåŠ¡ç«¯ä¸»åŠ¨å‘é€ã€å¤´éƒ¨å‹ç¼©ã€å¤šè·¯å¤ç”¨ã€‚ä½†æ˜¯è¿˜æœ‰<strong>é˜Ÿå¤´é˜»å¡</strong>çš„é—®é¢˜ï¼ˆå› ä¸ºè™½ç„¶è¿›è¡Œäº†é•¿è¿æ¥ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ç§æƒ…å†µä¼šå‡ºç°é˜Ÿå¤´é˜»å¡ï¼Œé‚£å°±æ˜¯ ä¸¢å¤±é‡ä¼ ï¼‰ã€‚(æ ¸å¿ƒ é˜Ÿå¤´é˜»å¡ ssl cookie) </p></li><li><p>HTTP/3ä½¿ç”¨<strong>UDPè§£å†³äº†ä¸¢å¤±é‡ä¼ å¯¼è‡´çš„é˜Ÿå¤´é˜»å¡</strong>ï¼Œå¹¶ä¸”ä½¿ç”¨äº†TLS/SSL1.3å‡å°‘äº†å»ºç«‹HTTPsè¿æ¥çš„æ—¶é—´åˆ°1.5-2ä¸ªRTTï¼ˆå¾€è¿”æ—¶é—´ï¼‰ï¼Œè¿˜å¼•å…¥äº†äºŒè¿›åˆ¶ç¼–ç ï¼Œå…¶ä»–ç»†èŠ‚å¿˜è®°äº†ã€‚ </p></li><li><p>æå‰å°†èµ„æºæ¨é€åˆ°æµè§ˆå™¨ </p></li><li><p>æ¨é€å¯ä»¥åŸºäºå·²å‘é€çš„è¯·æ±‚ï¼Œä¾‹å¦‚å®¢æˆ·ç«¯è¯·æ±‚ <code>html</code>ï¼ŒæœåŠ¡ç«¯å¯ä»¥ä¸»åŠ¨æ¨é€ <code>js</code>ã€<code>css</code> æ–‡ä»¶</p></li></ul><h1 id="è‡ªå·±å¯¹é¡¹ç›®çš„è§£æ"><a href="#è‡ªå·±å¯¹é¡¹ç›®çš„è§£æ" class="headerlink" title="è‡ªå·±å¯¹é¡¹ç›®çš„è§£æ"></a>è‡ªå·±å¯¹é¡¹ç›®çš„è§£æ</h1><p>è¿™é‡Œæ˜¯è‡ªå·±å†æ¬¡å¯¹é¡¹ç›®çš„è§£æï¼Œä¹Ÿå½“åšä¸€ä¸ªå¤ä¹ ä½œç”¨ã€‚æŒ‰ç…§æ¨¡å—æ¥è§£æ</p><h2 id="main-cpp"><a href="#main-cpp" class="headerlink" title="main.cpp"></a>main.cpp</h2><p>åœ¨ä¸»å‡½æ•°ä¸­ï¼Œå…ˆæ˜¯è§£æå¯åŠ¨æœåŠ¡å™¨æ—¶é™„åŠ çš„å‚æ•°ï¼Œå¹¶å°†å‚æ•°è¡Œè§£æï¼Œæ¥ç€åœ¨åˆ›å»ºæœåŠ¡å™¨å¯¹è±¡ä»¥åŠæœåŠ¡å™¨åˆå§‹åŒ–ï¼Œå¯åŠ¨å„ä¸ªæ¨¡å—</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"config.h"</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    cout<span class="token operator">&lt;&lt;</span><span class="token string">"runed."</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>    <span class="token comment">//Log::get_instance()->write_log(1,"%s","server is running");</span>    <span class="token comment">//éœ€è¦ä¿®æ”¹çš„æ•°æ®åº“ä¿¡æ¯,ç™»å½•å,å¯†ç ,åº“å</span>    string user <span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">;</span>    string passwd <span class="token operator">=</span> <span class="token string">"61053208"</span><span class="token punctuation">;</span>    string databasename <span class="token operator">=</span> <span class="token string">"yourdb"</span><span class="token punctuation">;</span>    <span class="token comment">//å‘½ä»¤è¡Œè§£æ</span>    Config config<span class="token punctuation">;</span>    config<span class="token punctuation">.</span><span class="token function">parse_arg</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>    WebServer server<span class="token punctuation">;</span>    <span class="token comment">//åˆå§‹åŒ–</span>    server<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>PORT<span class="token punctuation">,</span> user<span class="token punctuation">,</span> passwd<span class="token punctuation">,</span> databasename<span class="token punctuation">,</span> config<span class="token punctuation">.</span>LOGWrite<span class="token punctuation">,</span>                 config<span class="token punctuation">.</span>OPT_LINGER<span class="token punctuation">,</span> config<span class="token punctuation">.</span>TRIGMode<span class="token punctuation">,</span>  config<span class="token punctuation">.</span>sql_num<span class="token punctuation">,</span>  config<span class="token punctuation">.</span>thread_num<span class="token punctuation">,</span>                 config<span class="token punctuation">.</span>close_log<span class="token punctuation">,</span> config<span class="token punctuation">.</span>actor_model<span class="token punctuation">)</span><span class="token punctuation">;</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"init\n"</span><span class="token punctuation">;</span>    <span class="token comment">//æ—¥å¿—</span>    server<span class="token punctuation">.</span><span class="token function">log_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"log_write\n"</span><span class="token punctuation">;</span>    <span class="token comment">//æ•°æ®åº“</span>    server<span class="token punctuation">.</span><span class="token function">sql_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"sql_pool\n"</span><span class="token punctuation">;</span>    <span class="token comment">//çº¿ç¨‹æ± </span>    server<span class="token punctuation">.</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"thread_pool\n"</span><span class="token punctuation">;</span>    <span class="token comment">//è§¦å‘æ¨¡å¼</span>    server<span class="token punctuation">.</span><span class="token function">trig_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"trig_mode\n"</span><span class="token punctuation">;</span>    <span class="token comment">//ç›‘å¬</span>    server<span class="token punctuation">.</span><span class="token function">eventListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"eventlisten\n"</span><span class="token punctuation">;</span>    <span class="token comment">//è¿è¡Œ</span>    server<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="WebServerç±»"><a href="#WebServerç±»" class="headerlink" title="WebServerç±»"></a>WebServerç±»</h2><p>ä¸€ä¸ªwebserverå¯¹è±¡åŒ…å«ç€</p><ol><li>æ•°æ®åº“è¿æ¥æ± æŒ‡é’ˆã€æ•°æ®åº“åç§°ã€ç™»å½•æ•°æ®åº“çš„è´¦å·å¯†ç ç­‰ä¿¡æ¯ï¼Œæ•°æ®åº“è¿æ¥æ•°é‡</li><li>çº¿ç¨‹æ± æŒ‡é’ˆ<code>threadpool&lt;http_conn&gt;* m_pool</code>ï¼Œçº¿ç¨‹æ•°é‡</li><li><code>epoll_event</code>æ•°ç»„ï¼Œæ•°ç»„å¤§å°ä¸º<code>MAX_EVENT_NUMBER</code>ã€å¥—æ¥å­—fd<code>m_listenfd</code>ä»¥åŠä¸€äº›æ¨¡å¼è®¾ç½®çš„å‚æ•°</li><li>å®šæ—¶å™¨ç›¸å…³çš„<code>client_data*</code>æŒ‡é’ˆï¼Œè¿™æ˜¯è¿æ¥èµ„æºçš„ç»“æ„ä½“ï¼Œå®šæ—¶å™¨åœ¨è¿™ä¸ªç»“æ„ä½“é‡Œé¢ï¼›è¿˜æœ‰ä¸€ä¸ªåº”è¯¥æ˜¯æ“ä½œç±»<code>Utils</code></li><li>åŸºç¡€æ•°æ®ä¸­åˆ™åŒ…å«<code>http_conn* users</code>è¿æ¥æ•°ç»„ã€ç®¡é“ã€epollfdã€ç«¯å£å·ã€rootæ–‡ä»¶ç›®å½•åœ°å€ã€æ—¥å¿—å¼€å…³ã€actoræ¨¡å¼è®°å½•ç­‰æ•°æ®</li></ol><p>å·¥ä½œæµç¨‹ï¼š</p><ol><li>åˆå§‹åŒ–</li><li>å¼€å¯æ—¥å¿—</li><li>å¼€å¯æ•°æ®åº“è¿æ¥æ± </li><li>å¼€å¯çº¿ç¨‹æ± </li><li>è®¾ç½®è§¦å‘æ¨¡å¼</li><li>ä¼ ç»Ÿç½‘ç»œç¼–ç¨‹æ­¥éª¤åˆ›å»ºç›‘å¬epollï¼ševentListen()ï¼Œå…¶ä¸­åŒ…å«äº†è®¾ç½®ä¿¡å·æ­¥éª¤</li><li>ä¸»å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯åˆ¤æ–­æ˜¯æ–°ç”¨æˆ·åŠ å…¥äº‹ä»¶ã€å®¢æˆ·ç«¯æ–­å¼€è¿æ¥äº‹ä»¶ã€å®šæ—¶å™¨äº‹ä»¶ã€å®¢æˆ·è¯·æ±‚æŠ¥æ–‡äº‹ä»¶ä»¥åŠå‘é€æŠ¥æ–‡äº‹ä»¶ä¸­çš„å“ªä¸€ä¸ª</li></ol><h3 id="WebServer-h"><a href="#WebServer-h" class="headerlink" title="WebServer.h"></a>WebServer.h</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">WebServer</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">WebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">~</span><span class="token function">WebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æœåŠ¡å™¨åˆå§‹åŒ–å‡½æ•°</span>    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span>string user<span class="token punctuation">,</span>string passWord<span class="token punctuation">,</span>string databaseName<span class="token punctuation">,</span>            <span class="token keyword">int</span> log_write<span class="token punctuation">,</span><span class="token keyword">int</span> opt_linger<span class="token punctuation">,</span><span class="token keyword">int</span> trigmode<span class="token punctuation">,</span><span class="token keyword">int</span> sql_num<span class="token punctuation">,</span>            <span class="token keyword">int</span> thread_num<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">,</span><span class="token keyword">int</span> actor_model<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">sql_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">log_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">trig_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">eventListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è°ƒæ•´å®šæ—¶å™¨</span>    <span class="token keyword">void</span> <span class="token function">deal_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">,</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¤„ç†å®šæ—¶å™¨</span>    <span class="token keyword">bool</span> <span class="token function">deal_clinet_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¤„ç†å®¢æˆ·ç«¯æ•°æ®</span>    <span class="token keyword">bool</span> <span class="token function">deal_with_signal</span><span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token operator">&amp;</span> timeout<span class="token punctuation">,</span><span class="token keyword">bool</span><span class="token operator">&amp;</span> stop_server<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¤„ç†ä¿¡å·</span>    <span class="token keyword">void</span> <span class="token function">deal_with_thread</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¤„ç†çº¿ç¨‹</span>    <span class="token keyword">void</span> <span class="token function">deal_with_write</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token comment">//åŸºç¡€æ•°æ®</span>    <span class="token keyword">int</span> m_port<span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> m_root<span class="token punctuation">;</span><span class="token comment">//è®°å½•rootæ–‡ä»¶ç›®å½•</span>    <span class="token keyword">int</span> m_log_write<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_close_log<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_actormodel<span class="token punctuation">;</span>        <span class="token keyword">int</span> m_pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> m_epollfd<span class="token punctuation">;</span>    http_conn<span class="token operator">*</span> users<span class="token punctuation">;</span>    <span class="token comment">//æ•°æ®åº“ç›¸å…³</span>    connection_pool<span class="token operator">*</span> m_connPool<span class="token punctuation">;</span><span class="token comment">//æ•°æ®åº“è¿æ¥æ± </span>    string m_user<span class="token punctuation">;</span><span class="token comment">//ç™»å½•æ•°æ®åº“è´¦å·</span>    string m_passWord<span class="token punctuation">;</span><span class="token comment">//ç™»å½•æ•°æ®åº“å¯†ç </span>    string m_databaseName<span class="token punctuation">;</span><span class="token comment">//æ•°æ®åº“åç§°</span>    <span class="token keyword">int</span> m_sql_num<span class="token punctuation">;</span>    <span class="token comment">//çº¿ç¨‹æ± ç›¸å…³</span>    threadpool<span class="token operator">&lt;</span>http_conn<span class="token operator">></span><span class="token operator">*</span> m_pool<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_thread_num<span class="token punctuation">;</span>    <span class="token comment">//epoll_eventç›¸å…³</span>    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> m_listenfd<span class="token punctuation">;</span><span class="token comment">//å¥—æ¥å­—fd</span>    <span class="token keyword">int</span> m_OPT_LINGER<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_TRIGMode<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_LISTENTrigmode<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_CONNTrigmode<span class="token punctuation">;</span>    <span class="token comment">//å®šæ—¶å™¨ç›¸å…³</span>    client_data<span class="token operator">*</span> users_timer<span class="token punctuation">;</span>    Utils utils<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">//class WebServer</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="WebServer-cpp"><a href="#WebServer-cpp" class="headerlink" title="WebServer.cpp"></a>WebServer.cpp</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"webserver.h"</span></span><span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">WebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//http_connç±»å¯¹è±¡</span>    users<span class="token operator">=</span><span class="token keyword">new</span> http_conn<span class="token punctuation">[</span>MAX_FD<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">//rootæ–‡ä»¶å¤¹è·¯å¾„</span>    <span class="token keyword">char</span> server_path<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">//* getcwd() -> è·å–å½“å‰å·¥ä½œç›®å½•</span>    <span class="token function">getcwd</span><span class="token punctuation">(</span>server_path<span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> root<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"/root"</span><span class="token punctuation">;</span>    m_root<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>server_path<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">strlen</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">//è®°å½•rootæ–‡ä»¶å¤¹è·¯å¾„åˆ°m_root</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_root<span class="token punctuation">,</span>server_path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcat</span><span class="token punctuation">(</span>m_root<span class="token punctuation">,</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å®šæ—¶å™¨</span>    users_timer<span class="token operator">=</span><span class="token keyword">new</span> client_data<span class="token punctuation">[</span>MAX_FD<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">WebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">close</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> users<span class="token punctuation">;</span>    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> users_timer<span class="token punctuation">;</span>    <span class="token keyword">delete</span> m_pool<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span>string user<span class="token punctuation">,</span>string passWord<span class="token punctuation">,</span>string databaseName<span class="token punctuation">,</span>            <span class="token keyword">int</span> log_write<span class="token punctuation">,</span><span class="token keyword">int</span> opt_linger<span class="token punctuation">,</span><span class="token keyword">int</span> trigmode<span class="token punctuation">,</span><span class="token keyword">int</span> sql_num<span class="token punctuation">,</span>            <span class="token keyword">int</span> thread_num<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">,</span><span class="token keyword">int</span> actor_model<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        m_port<span class="token operator">=</span>port<span class="token punctuation">;</span>    m_user<span class="token operator">=</span>user<span class="token punctuation">;</span>    m_passWord<span class="token operator">=</span>passWord<span class="token punctuation">;</span>    m_databaseName<span class="token operator">=</span>databaseName<span class="token punctuation">;</span>    m_log_write<span class="token operator">=</span>log_write<span class="token punctuation">;</span>    m_OPT_LINGER<span class="token operator">=</span>opt_linger<span class="token punctuation">;</span>    m_TRIGMode<span class="token operator">=</span>trigmode<span class="token punctuation">;</span>    m_sql_num<span class="token operator">=</span>sql_num<span class="token punctuation">;</span>    m_thread_num<span class="token operator">=</span>thread_num<span class="token punctuation">;</span>    m_close_log<span class="token operator">=</span>close_log<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">trig_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//LT+LT</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>m_TRIGMode<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        m_LISTENTrigmode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        m_CONNTrigmode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//LT+ET</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>m_TRIGMode<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        m_LISTENTrigmode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        m_CONNTrigmode<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//ET+LT</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>m_TRIGMode<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        m_LISTENTrigmode<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        m_CONNTrigmode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//ET+ET</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>m_TRIGMode<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        m_LISTENTrigmode<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        m_CONNTrigmode<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">log_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>m_close_log<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//æ—¥å¿—å¼€å¯</span>        <span class="token comment">//åˆå§‹åŒ–æ—¥å¿—</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>m_log_write<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token string">"./ServerLog"</span><span class="token punctuation">,</span>m_close_log<span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">,</span><span class="token number">800000</span><span class="token punctuation">,</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span>            <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token string">"./ServerLog"</span><span class="token punctuation">,</span>m_close_log<span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">,</span><span class="token number">800000</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">sql_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//åˆå§‹åŒ–æ•°æ®åº“è¿æ¥æ± </span>    m_connPool<span class="token operator">=</span>connection_pool<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    m_connPool<span class="token operator">-></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span>m_user<span class="token punctuation">,</span>m_passWord<span class="token punctuation">,</span>m_databaseName<span class="token punctuation">,</span><span class="token number">3306</span><span class="token punctuation">,</span>m_sql_num<span class="token punctuation">,</span>m_close_log<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//åˆå§‹åŒ–æ•°æ®åº“è¯»å–è¡¨ï¼Œå³å°†æ•°æ®åº“ä¸­åŸæœ‰çš„è´¦å·å¯†ç å¯¼å…¥åˆ°æœåŠ¡å™¨å†…å­˜çš„mapä¸­</span>    users<span class="token operator">-></span><span class="token function">initMysql_result</span><span class="token punctuation">(</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//çº¿ç¨‹æ± </span>    m_pool<span class="token operator">=</span><span class="token keyword">new</span> threadpool<span class="token operator">&lt;</span>http_conn<span class="token operator">></span><span class="token punctuation">(</span>m_actormodel<span class="token punctuation">,</span>m_connPool<span class="token punctuation">,</span>m_thread_num<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//?ç›‘å¬äº‹ä»¶è¿™ä¸ªå‡½æ•°é‡Œé¢å®ç°éœ€è¦ç»“åˆå…¶å®ƒä»£ç æ¥ç ”ç©¶</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">eventListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//ç½‘ç»œç¼–ç¨‹åŸºç¡€æ­¥éª¤</span>    m_listenfd<span class="token operator">=</span><span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assert</span><span class="token punctuation">(</span>m_listenfd<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ä¼˜é›…å…³é—­è¿æ¥</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>m_OPT_LINGER<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">struct</span> <span class="token class-name">linger</span> tmp<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token function">setsockopt</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_LINGER<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>m_OPT_LINGER<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">struct</span> <span class="token class-name">linger</span> tmp<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token function">setsockopt</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_LINGER<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> address<span class="token punctuation">;</span>    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    address<span class="token punctuation">.</span>sin_family<span class="token operator">=</span>AF_INET<span class="token punctuation">;</span>    address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token operator">=</span><span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>    address<span class="token punctuation">.</span>sin_port<span class="token operator">=</span><span class="token function">htons</span><span class="token punctuation">(</span>m_port<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">setsockopt</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token operator">&amp;</span>flag<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ret<span class="token operator">=</span><span class="token function">bind</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç»‘å®šipåœ°å€å’Œç«¯å£</span>    <span class="token function">assert</span><span class="token punctuation">(</span>ret<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ret<span class="token operator">=</span><span class="token function">listen</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å…è®¸æœ€å¤šäº”ä¸ªå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨åŒæ—¶ä¿å­˜è¿æ¥</span>    <span class="token function">assert</span><span class="token punctuation">(</span>ret<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    utils<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ç”¨äºå­˜å‚¨epolläº‹ä»¶è¡¨ä¸­å°±ç»ªäº‹ä»¶çš„eventæ•°ç»„</span>    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">//åˆ›å»ºepoll</span>    m_epollfd<span class="token operator">=</span><span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assert</span><span class="token punctuation">(</span>m_epollfd<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å¾€epollå†…æ ¸äº‹ä»¶ä¸­æ³¨å†Œç›‘å¬socketäº‹ä»¶ï¼Œå½“listenåˆ°æ–°çš„å®¢æˆ·è¿æ¥æ—¶ï¼Œlistenfdå˜ä¸ºå°±ç»ªçŠ¶æ€</span>    utils<span class="token punctuation">.</span><span class="token function">addfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_listenfd<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span>m_LISTENTrigmode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ·»åŠ epollç›‘å¬äº‹ä»¶</span>    http_conn<span class="token operator">::</span>m_epollfd<span class="token operator">=</span>m_epollfd<span class="token punctuation">;</span>        <span class="token comment">//*socketpair() -> ç”¨äºåˆ›å»ºä¸€å¯¹æ— åçš„ã€ç›¸äº’è¿æ¥çš„å¥—æ¥å­—ï¼Œå¯ä»¥å®ç°è¿›ç¨‹é—´çš„åŒå‘é€šä¿¡ï¼Œä¹Ÿå¯ä»¥ç”¨äºç½‘ç»œé€šä¿¡</span>    ret<span class="token operator">=</span><span class="token function">socketpair</span><span class="token punctuation">(</span>PF_UNIX<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>m_pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assert</span><span class="token punctuation">(</span>ret<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    utils<span class="token punctuation">.</span><span class="token function">setnonblocking</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®éé˜»å¡</span>    utils<span class="token punctuation">.</span><span class="token function">addfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        utils<span class="token punctuation">.</span><span class="token function">addsig</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>    utils<span class="token punctuation">.</span><span class="token function">addsig</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span>utils<span class="token punctuation">.</span>sig_handler<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    utils<span class="token punctuation">.</span><span class="token function">addsig</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>utils<span class="token punctuation">.</span>sig_handler<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å·¥å…·ç±»ï¼Œä¿¡å·å’Œæè¿°ç¬¦çš„åŸºç¡€æ“ä½œ</span>    Utils<span class="token operator">::</span>u_pipefd<span class="token operator">=</span>m_pipefd<span class="token punctuation">;</span>    Utils<span class="token operator">::</span>u_epollfd<span class="token operator">=</span>m_epollfd<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//åˆ›å»ºå®šæ—¶å™¨</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span>client_address<span class="token punctuation">,</span>m_root<span class="token punctuation">,</span>m_CONNTrigmode<span class="token punctuation">,</span>m_close_log<span class="token punctuation">,</span>m_user<span class="token punctuation">,</span>m_passWord<span class="token punctuation">,</span>m_databaseName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åˆå§‹åŒ–client_dataæ•°æ®</span>    <span class="token comment">//åˆ›å»ºå®šæ—¶å™¨ï¼Œè®¾ç½®å›è°ƒå‡½æ•°å’Œè¶…æ—¶æ—¶é—´ï¼Œç»‘å®šç”¨æˆ·æ•°æ®ï¼Œå°†å®šæ—¶å™¨æ·»åŠ åˆ°é“¾è¡¨å½“ä¸­</span>    users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>addreess<span class="token operator">=</span>client_address<span class="token punctuation">;</span>    users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>sockfd<span class="token operator">=</span>connfd<span class="token punctuation">;</span>    util_timer<span class="token operator">*</span> timer<span class="token operator">=</span><span class="token keyword">new</span> util_timer<span class="token punctuation">;</span>    timer<span class="token operator">-></span>user_data<span class="token operator">=</span><span class="token operator">&amp;</span>users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">;</span>    timer<span class="token operator">-></span>cb_func<span class="token operator">=</span>cb_func<span class="token punctuation">;</span>    time_t cur<span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    timer<span class="token operator">-></span>expire<span class="token operator">=</span>cur<span class="token operator">+</span><span class="token number">3</span><span class="token operator">*</span>TIMESLOT<span class="token punctuation">;</span>    users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token operator">=</span>timer<span class="token punctuation">;</span>    utils<span class="token punctuation">.</span>m_timer_lst<span class="token punctuation">.</span><span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è‹¥æœ‰æ•°æ®ä¼ è¾“ï¼Œåˆ™å°†å®šæ—¶å™¨å¾€åå»¶è¿Ÿ3ä¸ªå•ä½</span><span class="token comment">//å¹¶å¯¹æ–°çš„å®šæ—¶å™¨åœ¨é“¾è¡¨ä¸Šçš„ä½ç½®è¿›è¡Œè°ƒæ•´</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    time_t cur<span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    timer<span class="token operator">-></span>expire<span class="token operator">=</span>cur<span class="token operator">+</span><span class="token number">3</span><span class="token operator">*</span>TIMESLOT<span class="token punctuation">;</span>    utils<span class="token punctuation">.</span>m_timer_lst<span class="token punctuation">.</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"adjust timer once"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//åˆ é™¤å®šæ—¶å™¨ä»¥åŠåœ¨epollä¸­ç§»é™¤sockfd</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">deal_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">,</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    timer<span class="token operator">-></span><span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>        utils<span class="token punctuation">.</span>m_timer_lst<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"close fd %d"</span><span class="token punctuation">,</span>users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//æœ‰æ–°è¿æ¥è¿›æ¥</span><span class="token keyword">bool</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">deal_clinet_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">;</span>    socklen_t client_addrlength<span class="token operator">=</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>m_LISTENTrigmode<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//LT</span>        <span class="token comment">//* accept() -> è¿”å›å€¼æ˜¯ä¸€ä¸ªæ–°çš„å¥—æ¥å­—æè¿°ç¬¦ï¼Œå®ƒä»£è¡¨çš„æ˜¯å’Œå®¢æˆ·ç«¯çš„æ–°çš„è¿æ¥ï¼Œ</span>        <span class="token comment">//*             å¯ä»¥æŠŠå®ƒç†è§£æˆæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„socket,è¿™ä¸ªsocketåŒ…å«çš„æ˜¯å®¢æˆ·ç«¯çš„ipå’Œportä¿¡æ¯ </span>        <span class="token comment">//*             å¹¶ä¸”ç”¨client_addressæ¥æ¥æ”¶å®¢æˆ·ç«¯å®é™…çš„åœ°å€</span>        <span class="token keyword">int</span> connfd<span class="token operator">=</span><span class="token function">accept</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span><span class="token operator">&amp;</span>client_addrlength<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>connfd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s:errno is:%s"</span><span class="token punctuation">,</span><span class="token string">"accept error"</span><span class="token punctuation">,</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//å¦‚æœåˆ°è¾¾æœ€å¤§å¯å…è®¸çš„fdæ•°</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>http_conn<span class="token operator">::</span>m_user_count<span class="token operator">>=</span>MAX_FD<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            utils<span class="token punctuation">.</span><span class="token function">show_error</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span><span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//åˆ›å»ºå®šæ—¶å™¨</span>        <span class="token function">timer</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token comment">//ET</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> connfd<span class="token operator">=</span><span class="token function">accept</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span><span class="token operator">&amp;</span>client_addrlength<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>connfd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s:errno is:%d"</span><span class="token punctuation">,</span><span class="token string">"accept error"</span><span class="token punctuation">,</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>http_conn<span class="token operator">::</span>m_user_count<span class="token operator">>=</span>MAX_FD<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                utils<span class="token punctuation">.</span><span class="token function">show_error</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span><span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">timer</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">bool</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">deal_with_signal</span><span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token operator">&amp;</span> timeout<span class="token punctuation">,</span><span class="token keyword">bool</span><span class="token operator">&amp;</span> stop_server<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> sig<span class="token punctuation">;</span>    <span class="token keyword">char</span> signals<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    ret<span class="token operator">=</span><span class="token function">recv</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>signals<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>signals<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä»pipefdè¯»å–æ•°æ®ï¼Œè¿”å›retä¸ºè¯»åˆ°æ•°æ®é•¿åº¦</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>ret<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">switch</span><span class="token punctuation">(</span>signals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                        <span class="token keyword">case</span> SIGALRM<span class="token operator">:</span>                timeout<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> SIGTERM<span class="token operator">:</span>                stop_server<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token comment">//switch</span>        <span class="token punctuation">&#125;</span><span class="token comment">//for</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">deal_with_thread</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    util_timer<span class="token operator">*</span> timer<span class="token operator">=</span>users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>    <span class="token comment">//reactoræ¨¡å¼</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>m_actormodel<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>            <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//è‹¥ç›‘æµ‹åˆ°è¯»äº‹ä»¶ï¼Œå°†è¯¥äº‹ä»¶æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—</span>        m_pool<span class="token operator">-></span><span class="token function">append</span><span class="token punctuation">(</span>users<span class="token operator">+</span>sockfd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>                    users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token comment">//while</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token comment">//proactor</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"deal with the client(%s)"</span><span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//è‹¥ç›‘æµ‹åˆ°è¯»äº‹ä»¶ï¼Œå°†è¯¥äº‹ä»¶æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—</span>            m_pool<span class="token operator">-></span><span class="token function">append_p</span><span class="token punctuation">(</span>users<span class="token operator">+</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>                <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span>            <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">deal_with_write</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>    <span class="token comment">//reactor</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> m_actormodel<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        m_pool<span class="token operator">-></span><span class="token function">append</span><span class="token punctuation">(</span>users <span class="token operator">+</span> sockfd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token punctuation">)</span>                <span class="token punctuation">&#123;</span>                    <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>                    users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">//proactor</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"send data to the client(%s)"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span>        <span class="token punctuation">&#123;</span>            <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">bool</span> timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> stop_server <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_server<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"epoll failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>            <span class="token comment">//å¤„ç†æ–°åˆ°çš„å®¢æˆ·è¿æ¥</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> m_listenfd<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token function">deal_clinet_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> flag<span class="token punctuation">)</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> <span class="token punctuation">(</span>EPOLLRDHUP <span class="token operator">|</span> EPOLLHUP <span class="token operator">|</span> EPOLLERR<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token comment">//æœåŠ¡å™¨ç«¯å…³é—­è¿æ¥ï¼Œç§»é™¤å¯¹åº”çš„å®šæ—¶å™¨</span>                util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>                <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//å¤„ç†ä¿¡å·</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">==</span> m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token function">deal_with_signal</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> stop_server<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> flag<span class="token punctuation">)</span>                    <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"dealclientdata failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//å¤„ç†å®¢æˆ·è¿æ¥ä¸Šæ¥æ”¶åˆ°çš„æ•°æ®</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token function">deal_with_thread</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token function">deal_with_write</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            utils<span class="token punctuation">.</span><span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"timer tick"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ—¥å¿—ç±»"><a href="#æ—¥å¿—ç±»" class="headerlink" title="æ—¥å¿—ç±»"></a>æ—¥å¿—ç±»</h2><p>æ—¥å¿—é‡Œé¢ä¾èµ–ä¸€ä¸ªå®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨æ˜¯å¾ªç¯æ•°ç»„å®ç°çš„é˜»å¡é˜Ÿåˆ—ï¼Œæœ€ååœ¨è¾“å‡ºæ—¶åˆ™ä¼šåˆ¤æ–­æ˜¯å¦å¼‚æ­¥æ“ä½œï¼ˆé€šè¿‡å˜é‡<code>m_is_async</code>æ¥è®°å½•ï¼‰ï¼Œå¦‚æœæ˜¯å¼‚æ­¥æ“ä½œï¼Œåˆ™å°†æ—¥å¿—ä½“æ‰“å…¥é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œç”±ä¸€ä¸ªçº¿ç¨‹å¼‚æ­¥è¾“å‡ºæ—¥å¿—ï¼›è‹¥ä¸æ˜¯å¼‚æ­¥åˆ™ç›´æ¥è¾“å‡º<code>fputs()</code>ï¼Œé˜»å¡é˜Ÿåˆ—é‡‡ç”¨FIFOåŸåˆ™ï¼›æœ‰æ¡ä»¶å˜é‡ï¼Œæœ‰é”ç”¨åˆ°</p><ol><li>å¦‚æœè®¾ç½®äº†<code>max_queue_size</code>ï¼Œå³<code>max_queue_size&gt;0</code>åˆ™ä¸ºå¼‚æ­¥ï¼Œå¾ªç¯æ•°ç»„ä½œä¸ºç¼“å†²åŒºé˜Ÿåˆ—ï¼Œé€šè¿‡<code>push</code>å­˜æ”¾æ—¥å¿—æ¶ˆæ¯ä½“ï¼ˆå®é™…ç±»å‹ä¸º<code>string</code>ï¼‰</li><li>é˜»å¡é˜Ÿåˆ—çš„<code>pop</code>æ˜¯å‡ºé˜Ÿï¼Œå¹¶è¿”å›æœ€å‰é¢çš„æ¶ˆæ¯ä½“ï¼Œè‹¥é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™æ¡ä»¶å˜é‡ä¼šè¿›è¡Œé˜»å¡ç­‰å¾…å”¤é†’</li><li>æœ‰ä¸ªä¸“é—¨çš„å¼‚æ­¥å†™æ—¥å¿—æ–¹æ³•==&gt;<code>void* async_write_log()</code>ï¼›è¿™ä¸ªæ–¹æ³•å®ç°åœ¨ log.h å¤´æ–‡ä»¶ä¸­ï¼Œå®ƒä¸æ–­å¾ªç¯å¹¶popå‡ºé˜»å¡é˜Ÿåˆ—ï¼Œæå–ä¸€ä¸ªstringç±»å‹çš„æ¶ˆæ¯ä½“å¹¶æ‰“å°è¾“å‡ºï¼Œç›´åˆ°é˜»å¡é˜Ÿåˆ—ä¸ºç©º</li></ol><p>ä»£ç å¦‚ä¸‹ï¼š</p><h3 id="log-h"><a href="#log-h" class="headerlink" title="log.h"></a>log.h</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/** * log.hå¤´æ–‡ä»¶ * * !åŒæ­¥/å¼‚æ­¥æ—¥å¿—ç³»ç»Ÿå¤´æ–‡ä»¶===============åŒæ­¥/å¼‚æ­¥æ—¥å¿—ç³»ç»Ÿä¸»è¦æ¶‰åŠäº†ä¸¤ä¸ªæ¨¡å—ï¼Œä¸€ä¸ªæ˜¯æ—¥å¿—æ¨¡å—ï¼Œä¸€ä¸ªæ˜¯é˜»å¡é˜Ÿåˆ—æ¨¡å—,å…¶ä¸­åŠ å…¥é˜»å¡é˜Ÿåˆ—æ¨¡å—ä¸»è¦æ˜¯è§£å†³å¼‚æ­¥å†™å…¥æ—¥å¿—åšå‡†å¤‡.é˜»å¡é˜Ÿåˆ—è§ï¼šblock_queue.h> * è‡ªå®šä¹‰é˜»å¡é˜Ÿåˆ—> * å•ä¾‹æ¨¡å¼åˆ›å»ºæ—¥å¿—> * åŒæ­¥æ—¥å¿—> * å¼‚æ­¥æ—¥å¿—> * å®ç°æŒ‰å¤©ã€è¶…è¡Œåˆ†ç±» */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LOG_H</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOG_H</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../log/block_queue.h"</span></span><span class="token keyword">class</span> <span class="token class-name">Log</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token comment">/**è·å–å•ä¾‹     *      * ç”±äºC++11åŠä»¥åçš„ç‰ˆæœ¬ä¸­è¦æ±‚ç¼–è¯‘å™¨ä¿è¯å†…éƒ¨é™æ€å˜é‡çš„çº¿ç¨‹å®‰å…¨æ€§     * æ•…è¿™é‡Œä½¿ç”¨çš„å±€éƒ¨å˜é‡æ‡’æ±‰æ¨¡å¼æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¹¶ä¸”ä¸ç”¨åŠ é”     */</span>    <span class="token keyword">static</span> Log<span class="token operator">*</span> <span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">static</span> Log instance<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>instance<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å¼‚æ­¥å†™æ—¥å¿—å…¬æœ‰æ–¹æ³•ï¼Œè°ƒç”¨ç§æœ‰æ–¹æ³•async_write_log</span>    <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">flush_log_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">async_write_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å¯é€‰æ‹©çš„å‚æ•°æœ‰æ—¥å¿—æ–‡ä»¶ã€æ—¥å¿—ç¼“å†²åŒºå¤§å°ã€æœ€å¤§è¡Œæ•°ä»¥åŠæ—¥å¿—æœ€é•¿æ—¥å¿—æ¡é˜Ÿåˆ—</span>    <span class="token keyword">bool</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file_name<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">,</span> <span class="token keyword">int</span> log_buf_size <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">,</span> <span class="token keyword">int</span> split_lines <span class="token operator">=</span> <span class="token number">5000000</span><span class="token punctuation">,</span> <span class="token keyword">int</span> max_queue_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å°†è¾“å‡ºå†…å®¹æŒ‰ç…§æ ‡å‡†æ ¼å¼æ•´ç†</span>    <span class="token keyword">void</span> <span class="token function">write_log</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¼ºåˆ¶åˆ·æ–°ç¼“å†²åŒº</span>    <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¼‚æ­¥å†™æ—¥å¿—æ–¹æ³•</span>    <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">async_write_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        std<span class="token operator">::</span>string single_log<span class="token punctuation">;</span>        <span class="token comment">//ä»é˜»å¡é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªæ—¥å¿—stringï¼Œå†™å…¥æ–‡ä»¶</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>m_log_queue<span class="token operator">-></span><span class="token function">pop</span><span class="token punctuation">(</span>single_log<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">fputs</span><span class="token punctuation">(</span>single_log<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>            m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">char</span> dir_name<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//è·¯å¾„å</span>    <span class="token keyword">char</span> log_name<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//logæ–‡ä»¶å</span>    <span class="token keyword">int</span> m_split_lines<span class="token punctuation">;</span><span class="token comment">//æ—¥å¿—æœ€å¤§è¡Œæ•°</span>    <span class="token keyword">int</span> m_log_buf_size<span class="token punctuation">;</span><span class="token comment">//æ—¥å¿—ç¼“å†²åŒºå¤§å°</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> m_count<span class="token punctuation">;</span><span class="token comment">//æ—¥å¿—è¡Œæ•°è®°å½•</span>    <span class="token keyword">int</span> m_today<span class="token punctuation">;</span><span class="token comment">//ç”±äºæ—¥å¿—æ˜¯æŒ‰å¤©åˆ†ç±»çš„ï¼Œè¿™ä¸ªå°±è®°å½•å½“å‰æ—¶é—´æ˜¯å“ªä¸€å¤©</span>    FILE <span class="token operator">*</span>m_fp<span class="token punctuation">;</span><span class="token comment">//æ‰“å¼€logæ–‡ä»¶çš„æ–‡ä»¶æŒ‡é’ˆ</span>    <span class="token keyword">char</span> <span class="token operator">*</span>m_buf<span class="token punctuation">;</span><span class="token comment">//å½“å‰æŒ‡å‘logå†…å®¹çš„å­—ç¬¦æŒ‡é’ˆï¼Œå³è¦è¾“å‡ºçš„å†…å®¹</span>    block_queue<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">></span> <span class="token operator">*</span>m_log_queue<span class="token punctuation">;</span><span class="token comment">//é˜»å¡é˜Ÿåˆ—</span>    <span class="token keyword">bool</span> m_is_async<span class="token punctuation">;</span><span class="token comment">//è®°å½•æ˜¯å¦åŒæ­¥æ ‡å¿—</span>    locker m_mutex<span class="token punctuation">;</span><span class="token comment">//åŒæ­¥ç±»</span>    <span class="token keyword">int</span> m_close_log<span class="token punctuation">;</span> <span class="token comment">//æ˜¯å¦å…³é—­æ—¥å¿—</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">//è°ƒè¯•ä¿¡æ¯ç›¸å…³</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_DEBUG</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_INFO</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_WARN</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_ERROR</span><span class="token expression"><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//LOG_H</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="log-cpp"><a href="#log-cpp" class="headerlink" title="log.cpp"></a>log.cpp</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//log.cpp</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ctime></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdarg></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../log/log.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_is_async<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Log</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>m_fp<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">fclose</span><span class="token punctuation">(</span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//å¼‚æ­¥éœ€è¦è®¾ç½®é˜»å¡é˜Ÿåˆ—çš„é•¿åº¦ï¼ŒåŒæ­¥ä¸éœ€è¦</span><span class="token keyword">bool</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file_name<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">,</span> <span class="token keyword">int</span> log_buf_size <span class="token punctuation">,</span> <span class="token keyword">int</span> split_lines <span class="token punctuation">,</span> <span class="token keyword">int</span> max_queue_size <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//å¦‚æœè®¾ç½®äº†max_queue_sizeï¼Œåˆ™è®¾ä¸ºå¼‚æ­¥</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>max_queue_size<span class="token operator">>=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//è®¾ç½®å†™å…¥æ–¹å¼flag</span>        m_is_async<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token comment">//åˆ›å»ºå¹¶è®¾ç½®é˜»å¡é˜Ÿåˆ—</span>        m_log_queue <span class="token operator">=</span> <span class="token keyword">new</span> block_queue<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">></span><span class="token punctuation">(</span>max_queue_size<span class="token punctuation">)</span><span class="token punctuation">;</span>                pthread_t tid<span class="token punctuation">;</span>        <span class="token comment">//flush_log_threadä¸ºå›è°ƒå‡½æ•°ï¼Œè¡¨ç¤ºåˆ›å»ºçº¿ç¨‹å¼‚æ­¥å†™æ—¥å¿—</span>        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>flush_log_thread<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//è¾“å‡ºå†…å®¹é•¿åº¦</span>    m_close_log<span class="token operator">=</span>close_log<span class="token punctuation">;</span>    m_log_buf_size<span class="token operator">=</span>log_buf_size<span class="token punctuation">;</span>    m_buf<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>m_log_buf_size<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>m_buf<span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">,</span>m_log_buf_size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–ç¼“å†²åŒº</span>    m_split_lines<span class="token operator">=</span>split_lines<span class="token punctuation">;</span><span class="token comment">//æ—¥å¿—çš„æœ€å¤§è¡Œæ•°</span>    <span class="token comment">//åˆå§‹åŒ–æ—¶é—´ç›¸å…³å˜é‡</span>    time_t t<span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">tm</span><span class="token operator">*</span> sys_tm<span class="token operator">=</span><span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">tm</span> my_tm<span class="token operator">=</span><span class="token operator">*</span>sys_tm<span class="token punctuation">;</span>    <span class="token comment">//ä»åå¾€å‰æ‰¾ç¬¬ä¸€ä¸ªâ€˜/â€˜çš„ä½ç½®</span>    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> p<span class="token operator">=</span><span class="token function">strrchr</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¯¥å‡½æ•°è¿”å› str ä¸­æœ€åä¸€æ¬¡å‡ºç°å­—ç¬¦ c çš„ä½ç½®ã€‚å¦‚æœæœªæ‰¾åˆ°è¯¥å€¼ï¼Œåˆ™å‡½æ•°è¿”å›ä¸€ä¸ªç©ºæŒ‡é’ˆã€‚</span>    <span class="token keyword">char</span> log_full_name<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token comment">//ç›¸å½“äºè‡ªå®šä¹‰æ—¥å¿—å</span>    <span class="token comment">//è‹¥è¾“å…¥çš„æ–‡ä»¶åæ²¡æœ‰â€˜/â€™ï¼Œåˆ™ç›´æ¥å°†äº‹ä»¶+æ–‡ä»¶åä½œä¸ºæ—¥å¿—å</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//* %02dä¸­çš„0ä¸ºå¡«ç©ºå…ƒç´ ï¼Œå³å¦‚æœä¸æ»¡2ä¸ªå­—ç¬¦åˆ™ç”¨'0'å¡«ä¸Šå‰©ä½™çš„</span>        <span class="token function">snprintf</span><span class="token punctuation">(</span>log_full_name<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token string">"%d_%02d_%02d_%s"</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token comment">//? å°†â€˜/â€™çš„ä½ç½®å‘åç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼Œç„¶åå¤åˆ¶åˆ°lognameä¸­</span>        <span class="token comment">//? p-file_name+1æ—¶æ–‡ä»¶æ‰€åœ¨è·¯å¾„æ–‡ä»¶å¤¹çš„é•¿åº¦</span>        <span class="token comment">//* dir_nameç›¸å½“äºâ€˜./â€™</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>log_name<span class="token punctuation">,</span> p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>dir_name<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> p <span class="token operator">-</span> file_name <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">snprintf</span><span class="token punctuation">(</span>log_full_name<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token string">"%s%d_%02d_%02d_%s"</span><span class="token punctuation">,</span> dir_name<span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">,</span> log_name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_today<span class="token operator">=</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">;</span>    <span class="token comment">//*æ‰“å¼€æ–‡ä»¶ï¼Œä»¥é™„åŠ çš„æ–¹å¼æ‰“å¼€åªå†™æ–‡ä»¶ã€‚è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºè¯¥æ–‡ä»¶ï¼›å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œåˆ™å†™å…¥çš„æ•°æ®ä¼šè¢«åŠ åˆ°æ–‡ä»¶å°¾åï¼Œå³æ–‡ä»¶åŸå…ˆçš„å†…å®¹ä¼šè¢«ä¿ç•™ï¼ˆEOF ç¬¦ä¿ç•™ï¼‰</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span>log_full_name<span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/** * å†™å…¥æ—¥å¿—å‡½æ•°ï¼š * æ—¥å¿—å†™å…¥å‰ä¼šåˆ¤æ–­å½“å‰dayæ˜¯å¦ä¸ºåˆ›å»ºæ—¥å¿—çš„æ—¶é—´ï¼Œè¡Œæ•°æ˜¯å¦è¶…è¿‡æœ€å¤§è¡Œé™åˆ¶ *      *è‹¥ä¸ºåˆ›å»ºæ—¥å¿—æ—¶é—´ï¼Œå†™å…¥æ—¥å¿—ï¼Œå¦åˆ™æŒ‰å½“å‰æ—¶é—´åˆ›å»ºæ–°logï¼Œæ›´æ–°åˆ›å»ºæ—¶é—´å’Œè¡Œæ•° *      *è‹¥è¡Œæ•°è¶…è¿‡æœ€å¤§è¡Œé™åˆ¶ï¼Œåœ¨å½“å‰æ—¥å¿—çš„æœ«å°¾åŠ count/max_linesä¸ºåç¼€åˆ›å»ºæ–°çš„log */</span><span class="token keyword">void</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">write_log</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> now<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–å½“å¤©æ˜¯å‡ å· </span>    time_t t<span class="token operator">=</span>now<span class="token punctuation">.</span>tv_sec<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">tm</span><span class="token operator">*</span> sys_tm<span class="token operator">=</span><span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">tm</span> my_tm<span class="token operator">=</span><span class="token operator">*</span>sys_tm<span class="token punctuation">;</span>    <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token comment">/**     * æ—¥å¿—åˆ†çº§å¤„ç†ï¼š     *      *Debugï¼Œè°ƒè¯•ä»£ç æ—¶è¾“å‡º     *      *Warnï¼Œè°ƒè¯•æ—¶å‘å‡ºè­¦å‘Š     *      *Infoï¼ŒæŠ¥å‘Šç³»ç»Ÿå½“å‰çš„çŠ¶æ€ï¼Œå½“å‰æ‰§è¡Œçš„æµç¨‹æˆ–æ¥å—åˆ°çš„ä¿¡æ¯ç­‰     *      *Errorå’ŒFatalï¼Œè¾“å‡ºç³»ç»Ÿçš„é”™è¯¯ä¿¡æ¯     */</span>    <span class="token keyword">switch</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[debug]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[info]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[warn]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[error]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"[info]:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token comment">//å†™ä¸€ä¸ªlogï¼Œå¯¹m_count++ï¼Œm_split_linesæœ€å¤§è¡Œæ•°</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//æ›´æ–°ç°æœ‰è¡Œæ•°</span>        <span class="token comment">//æ—¥å¿—ä¸æ˜¯ä»Šå¤©æˆ–å†™å…¥çš„è¡Œæ•°æ—¶æœ€å¤§è¡Œçš„å€æ•°</span>    <span class="token comment">//m_split_lines æ˜¯æœ€å¤§è¡Œæ•°</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_today<span class="token operator">!=</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token operator">||</span><span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">%</span><span class="token keyword">this</span><span class="token operator">-></span>m_split_lines<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">char</span> new_log<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> tail<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>                <span class="token comment">//æ ¼å¼åŒ–æ—¥å¿—åä¸­çš„éƒ¨åˆ†</span>        <span class="token function">snprintf</span><span class="token punctuation">(</span>tail<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"%d_%02d_%02d_"</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_year<span class="token operator">+</span><span class="token number">1900</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_mon<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å¦‚æœæ—¶é—´ä¸æ˜¯ä»Šå¤©ï¼Œåˆ™åˆ›å»ºå½“å¤©çš„æ—¥å¿—ï¼Œå¹¶æ›´æ–°m_todayå’Œm_count</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>m_today<span class="token operator">!=</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">snprintf</span><span class="token punctuation">(</span>new_log<span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token string">"%s%s%s"</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>dir_name<span class="token punctuation">,</span>tail<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>log_name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token operator">-></span>m_today<span class="token operator">=</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token comment">//è¶…è¿‡äº†æœ€å¤§è¡Œï¼Œåœ¨ä¹‹å‰çš„æ—¥å¿—ååŸºç¡€ä¸ŠåŠ ä¸Šåç¼€count/max_lines</span>            <span class="token function">snprintf</span><span class="token punctuation">(</span>new_log<span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token string">"%s%s%s.%lld"</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>dir_name<span class="token punctuation">,</span>tail<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>log_name<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>m_count<span class="token operator">/</span><span class="token keyword">this</span><span class="token operator">-></span>m_split_lines<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span>new_log<span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//end if</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//VA_LIST æ˜¯åœ¨Cè¯­è¨€ä¸­è§£å†³å˜å‚é—®é¢˜çš„ä¸€ç»„å®ï¼Œæ‰€åœ¨å¤´æ–‡ä»¶ï¼š#include &lt;stdarg.h>ï¼Œç”¨äºè·å–ä¸ç¡®å®šä¸ªæ•°çš„å‚æ•°ã€‚</span>    va_list valst<span class="token punctuation">;</span>    <span class="token comment">//å°†ä¼ å…¥çš„formatå‚æ•°èµ‹å€¼ç»™alstï¼Œä¾¿äºæ ¼å¼åŒ–è¾“å‡º</span>    <span class="token function">va_start</span><span class="token punctuation">(</span>valst<span class="token punctuation">,</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>        std<span class="token operator">::</span>string log_str<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å†™å…¥å†…å®¹æ ¼å¼ï¼šæ—¶é—´+å†…å®¹</span>    <span class="token comment">//æ—¶é—´æ ¼å¼åŒ–ï¼Œsnprintf()æˆåŠŸè¿”å›å†™å­—ç¬¦çš„æ€»æ•°ï¼Œå…¶ä¸­ä¸åŒ…æ‹¬ç»“å°¾çš„nullå­—ç¬¦</span>    <span class="token keyword">int</span> n<span class="token operator">=</span><span class="token function">snprintf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token string">"%d-%02d-%02d %02d:%02d:%02d.%06ld %s "</span><span class="token punctuation">,</span>                    my_tm<span class="token punctuation">.</span>tm_year<span class="token operator">+</span><span class="token number">1900</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_mon<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_mday<span class="token punctuation">,</span>                    my_tm<span class="token punctuation">.</span>tm_hour<span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_min<span class="token punctuation">,</span>my_tm<span class="token punctuation">.</span>tm_sec<span class="token punctuation">,</span>now<span class="token punctuation">.</span>tv_usec<span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å†…å®¹æ ¼å¼åŒ–ï¼Œç”¨äºå­—ç¬¦ä¸²æ‰“å°æ•°æ®ã€æ•°æ®æ ¼å¼ç”¨æˆ·è‡ªå®šä¹‰ï¼Œè¿”å›å†™å…¥åˆ°å­—ç¬¦æ•°ç»„ä¸­çš„å­—ç¬¦ä¸ªæ•°ï¼ˆä¸åŒ…å«ç»ˆæ­¢ç¬¦ï¼‰</span>    <span class="token keyword">int</span> m<span class="token operator">=</span><span class="token function">vsnprintf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token operator">+</span>n<span class="token punctuation">,</span>m_log_buf_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>format<span class="token punctuation">,</span>valst<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token punctuation">[</span>n<span class="token operator">+</span>m<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\n'</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token punctuation">[</span>n<span class="token operator">+</span>m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>    log_str<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span>m_buf<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//* åŒæ­¥å¼‚æ­¥æ£€æµ‹</span>    <span class="token comment">//å¦‚æœm_is_asyncä¸ºtrueè¡¨ç¤ºä¸ºå¼‚æ­¥ï¼Œå¦åˆ™é»˜è®¤ä¸ºåŒæ­¥</span>    <span class="token comment">//è‹¥ä¸ºå¼‚æ­¥ï¼Œåˆ™å°†æ—¥å¿—ä¿¡æ¯åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼ŒåŒæ­¥åˆ™åŠ é”å‘æ–‡ä»¶ä¸­å†™</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_is_async <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-></span>m_log_queue<span class="token operator">-></span><span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//å¼‚æ­¥ä¸”é˜Ÿåˆ—ä¸ä¸ºç©º</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_log_queue<span class="token operator">-></span><span class="token function">push</span><span class="token punctuation">(</span>log_str<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">fputs</span><span class="token punctuation">(</span>log_str<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">va_end</span><span class="token punctuation">(</span>valst<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_fp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="block-queue-h"><a href="#block-queue-h" class="headerlink" title="block_queue.h"></a>block_queue.h</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/**************************************************************å¾ªç¯æ•°ç»„å®ç°çš„é˜»å¡é˜Ÿåˆ—ï¼Œm_back = (m_back + 1) % m_max_size;  *çº¿ç¨‹å®‰å…¨ï¼Œæ¯ä¸ªæ“ä½œå‰éƒ½è¦å…ˆåŠ äº’æ–¥é”ï¼Œæ“ä½œå®Œåï¼Œå†è§£é”**************************************************************/</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">BLOCK_QUEUE_H</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BLOCK_QUEUE_H</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../lock/locker.h"</span></span><span class="token comment">/**ç”¨å¾ªç¯æ•°ç»„å®ç°çš„é˜»å¡é˜Ÿåˆ—å°è£…ç±» */</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">class</span> <span class="token class-name">block_queue</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span><span class="token function">block_queue</span><span class="token punctuation">(</span><span class="token keyword">int</span> max_size<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span>max_size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//å¤„ç†å¼‚å¸¸å€¼</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"é˜»å¡é˜Ÿåˆ—åˆå§‹å¤§å°å‚æ•°å°äºç­‰äº0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>m_array <span class="token operator">=</span> <span class="token keyword">new</span> T<span class="token punctuation">[</span>max_size<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//åŠ¨æ€åˆ†é…æ•°ç»„</span><span class="token comment">//ç§æœ‰å±æ€§åˆå§‹åŒ–</span>m_max_size <span class="token operator">=</span> max_size<span class="token punctuation">;</span>m_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>m_front <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>m_back <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//?æ¸…é™¤é˜Ÿå†…å…ƒç´ </span><span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸Šé”</span>m_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>m_front <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>m_back <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£é”</span><span class="token punctuation">&#125;</span><span class="token operator">~</span><span class="token function">block_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é”€æ¯æ•°ç»„</span><span class="token keyword">if</span><span class="token punctuation">(</span>m_array<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m_array<span class="token punctuation">;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æ»¡äº†</span><span class="token keyword">bool</span> <span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">>=</span><span class="token keyword">this</span><span class="token operator">-></span>m_max_size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</span><span class="token keyword">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/**è·å–é˜Ÿåˆ—å†…çš„é˜Ÿé¦–å…ƒç´ ï¼š * æ¥å—ä¸€ä¸ªå¼•ç”¨å‚æ•°value * å¦‚æœè·å–é˜Ÿé¦–å…ƒç´ æˆåŠŸï¼Œåˆ™è¿”å›trueï¼Œå¹¶ä¸”valueä¼šè¢«ä¿®æ”¹ä¸ºé˜Ÿé¦–å…ƒç´  * å¦åˆ™è¿”å›false */</span><span class="token keyword">bool</span> <span class="token function">front</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//é˜Ÿåˆ—ä¸ºç©ºï¼Œfalse</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>value <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_front<span class="token punctuation">]</span><span class="token punctuation">;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/**è·å–é˜Ÿåˆ—å†…çš„é˜Ÿå°¾å…ƒç´ ï¼š * æ¥å—ä¸€ä¸ªå¼•ç”¨å‚æ•°value * å¦‚æœè·å–é˜Ÿå°¾å…ƒç´ æˆåŠŸï¼Œåˆ™è¿”å›trueï¼Œå¹¶ä¸”valueä¼šè¢«ä¿®æ”¹ä¸ºé˜Ÿå°¾å…ƒç´  * å¦åˆ™è¿”å›false */</span><span class="token keyword">bool</span> <span class="token function">back</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>value <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_back<span class="token punctuation">]</span><span class="token punctuation">;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è¿”å›é˜Ÿåˆ—ç°æœ‰å…ƒç´ ä¸ªæ•°</span><span class="token keyword">int</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>temp <span class="token operator">=</span> m_size<span class="token punctuation">;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> temp<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">max_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>temp <span class="token operator">=</span> m_max_size<span class="token punctuation">;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> temp<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/**å¾€é˜Ÿåˆ—æ·»åŠ å…ƒç´ ï¼Œéœ€è¦å°†æ‰€æœ‰ä½¿ç”¨é˜Ÿåˆ—çš„çº¿ç¨‹å…ˆå”¤é†’ * å½“æœ‰å…ƒç´ pushè¿›é˜Ÿåˆ—æ—¶ï¼Œç›¸å½“äºç”Ÿäº§è€…ç”Ÿäº§äº†ä¸€ä¸ªå…ƒç´  * è‹¥å½“å‰æ²¡æœ‰çº¿ç¨‹ç­‰å¾…æ¡ä»¶å˜é‡ï¼Œåˆ™å”¤é†’æ— æ„ä¹‰ */</span><span class="token keyword">bool</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">const</span> T<span class="token operator">&amp;</span> item<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//?ä½œç”¨è¿˜æ˜¯æœ‰äº›ä¸æ‡‚</span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">>=</span>m_max_size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m_cond<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>m_back <span class="token operator">=</span> <span class="token punctuation">(</span>m_back <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> m_max_size<span class="token punctuation">;</span><span class="token comment">//é˜Ÿå°¾å…ƒç´ å¾€åç§»åŠ¨</span>m_array<span class="token punctuation">[</span>m_back<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>m_size<span class="token operator">++</span><span class="token punctuation">;</span>m_cond<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//popæ—¶ï¼Œå¦‚æœå½“å‰é˜Ÿåˆ—æ²¡æœ‰å…ƒç´ ï¼Œåˆ™è¿›å…¥ç­‰å¾…æ¡ä»¶å˜é‡</span>    <span class="token comment">//åŒæ—¶éµå¾ªé˜Ÿåˆ—çš„FIFOåŸåˆ™ï¼Œå‡ºæ¥çš„æ˜¯é˜Ÿå¤´å…ƒç´ ï¼Œå¹¶ä¼šæŠŠè¯¥å…ƒç´ èµ‹å€¼ç»™å¼•ç”¨å‚æ•°item</span><span class="token keyword">bool</span> <span class="token function">pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> item<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>m_size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//é˜Ÿåˆ—å…ƒç´ ä¸ºç©º</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_cond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>m_mutex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>m_front <span class="token operator">=</span> <span class="token punctuation">(</span>m_front <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> m_max_size<span class="token punctuation">;</span>item <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_front<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token operator">--</span>m_size<span class="token punctuation">;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//é‡è½½popï¼Œå¢åŠ äº†è¶…æ—¶å¤„ç†</span><span class="token comment">//ç¬¬äºŒä¸ªå‚æ•°è¾“å…¥æœ€é•¿ç­‰å¾…æ¯«ç§’</span><span class="token keyword">bool</span> <span class="token function">pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> item<span class="token punctuation">,</span><span class="token keyword">int</span> ms_timeout<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">timespec</span> t <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">timeval</span> now <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>t<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> now<span class="token punctuation">.</span>tv_sec <span class="token operator">+</span> ms_timeout <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span><span class="token comment">//ç§’</span>t<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> <span class="token punctuation">(</span>ms_timeout <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span><span class="token comment">//å¾®ç§’</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_cond<span class="token punctuation">.</span><span class="token function">timewait</span><span class="token punctuation">(</span>m_mutex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>m_size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>m_front <span class="token operator">=</span> <span class="token punctuation">(</span>m_front <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> m_max_size<span class="token punctuation">;</span>item <span class="token operator">=</span> m_array<span class="token punctuation">[</span>m_front<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token operator">--</span>m_size<span class="token punctuation">;</span>m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">private</span><span class="token operator">:</span>locker m_mutex<span class="token punctuation">;</span><span class="token comment">//äº’æ–¥é”</span>cond m_cond<span class="token punctuation">;</span><span class="token comment">//æ¡ä»¶å˜é‡</span>T <span class="token operator">*</span>m_array<span class="token punctuation">;</span><span class="token comment">//é˜Ÿåˆ—</span><span class="token keyword">int</span> m_size<span class="token punctuation">;</span><span class="token comment">//å½“å‰é˜Ÿåˆ—å…ƒç´ ä¸ªæ•°</span><span class="token keyword">int</span> m_max_size<span class="token punctuation">;</span><span class="token comment">//é˜Ÿåˆ—æœ€å¤§å®¹é‡</span><span class="token keyword">int</span> m_front<span class="token punctuation">;</span><span class="token comment">//é˜Ÿå¤´å…ƒç´ </span><span class="token keyword">int</span> m_back<span class="token punctuation">;</span><span class="token comment">//é˜Ÿå°¾å…ƒç´ </span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//BLOCK_QUEUE_H</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ•°æ®åº“è¿æ¥æ± "><a href="#æ•°æ®åº“è¿æ¥æ± " class="headerlink" title="æ•°æ®åº“è¿æ¥æ± "></a>æ•°æ®åº“è¿æ¥æ± </h2><p>æ•°æ®åº“è¿æ¥æ± é‡‡ç”¨äº†å•ä¾‹æ¨¡å¼ï¼Œæ•´ä¸ªè¿æ¥æ± ä¹Ÿæ˜¯éµå¾ªFIFOåŸåˆ™</p><ol><li>æ•°æ®åº“è¿æ¥æ± å¯ä»¥åœ¨ç¨‹åºåˆå§‹åŒ–çš„æ—¶å€™ï¼Œé›†ä¸­åˆ›å»ºå¤šä¸ªæ•°æ®åº“è¿æ¥<code>MYSQL*</code>ï¼Œå¹¶æ”¾å…¥è¿æ¥æ± å½“ä¸­é›†ä¸­ç®¡ç†</li><li>æ•°æ®åº“è¿æ¥æ± çš„æ“ä½œä¼˜åŒ–äº†ä¸€èˆ¬è®¿é—®æ•°æ®åº“çš„æ“ä½œï¼ˆé¢‘ç¹åˆ›å»ºè¿æ¥==&gt;æ“ä½œæ•°æ®åº“==&gt;æ–­å¼€è¿æ¥ï¼‰</li><li>è¿æ¥æ± çš„å®¹å™¨ç±»ä¸ºï¼šæ ‡å‡†åº“ä¸­çš„é“¾è¡¨<code>list</code>ï¼Œå…¶å£°æ˜ä¸º<code>list&lt;MYSQL*&gt; connList;</code></li><li>æœ‰ä¸ªä¿¡å·é‡<code>sem reserve</code>åœ¨è¿æ¥æ± åˆå§‹åŒ–å®Œæ¯•æ—¶ä¼šå°†è‡ªèº«çš„å€¼è®¾ç½®ä¸ºæœ€å¤§è¿æ¥æ•°ï¼šthis-&gt;reserve=sem(this-&gt;m_FreeConn);</li><li>åˆå§‹åŒ–æ—¶ï¼Œä¼šåˆ›å»ºè‡ªå®šä¹‰æ•°ç›®çš„<strong>MYSQL*</strong>åœ¨é“¾è¡¨ä¸­ï¼Œå¹¶é€ä¸ªMYSQL*è¿›è¡Œåˆå§‹åŒ–è¿æ¥ï¼Œå³ï¼š<code>con=mysql_init(con);</code>å’Œ<code>con=mysql_real_connect(con,url.c_str(),User.c_str(),PassWord.c_str(),DatabaseName.c_str(),Port,NULL,0);</code></li><li>å–å‡ºè¿æ¥æ“ä½œ<code>MYSQL* GetConnection(); //è·å–æ•°æ®åº“è¿æ¥</code>ï¼šå®é™…æ˜¯å¯¹é“¾è¡¨è¿›è¡Œ<code>pop_front()</code>ï¼ŒåŒæ—¶è¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªMYSQL*ï¼›è‹¥è¿æ¥æ± æ— ç©ºé—²è¿æ¥ï¼Œåˆ™ä¼šå› ä¸ºä¿¡å·é‡ä»£ç reserve.wait()è€Œç­‰å¾…é˜»å¡ï¼Œç­‰å¾…æœ‰ç©ºé—²è¿æ¥æ—¶å†å”¤é†’</li><li>é‡Šæ”¾ä¹‹å‰å–å‡ºçš„è¿æ¥<code>bool ReleaseConnection(MYSQL* con); //é‡Šæ”¾è¿æ¥</code>ï¼šä¼šè¦æ±‚<strong>æŠŠå‰é¢è·å–è¿æ¥å¾—åˆ°çš„MYSQ*ä½œä¸ºå‚æ•°ä¼ å…¥</strong>è¯¥å‡½æ•°ä¸­ï¼Œå¹¶è¿›è¡Œå†æ¬¡pushæ·»åŠ åˆ°é“¾è¡¨å°¾éƒ¨ï¼ˆè¿æ¥é‡å¤åˆ©ç”¨ï¼‰</li><li>äº®ç‚¹ä¹‹ä¸€ï¼šè¿ç”¨äº†RAIIç±»æœºåˆ¶ï¼Œåœ¨æ„é€ RAIIç±»å¯¹è±¡æ—¶ä¼šè‡ªåŠ¨è·å–æ•°æ®åº“è¿æ¥ï¼Œåœ¨ææ„RAIIç±»å¯¹è±¡æ—¶ä¼šè‡ªåŠ¨å°†è¿æ¥å½’è¿˜ï¼Œä»£ç å¦‚ä¸‹ğŸ‘‡</li></ol><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">connectionRAII<span class="token operator">::</span><span class="token function">connectionRAII</span><span class="token punctuation">(</span>MYSQL<span class="token operator">*</span><span class="token operator">*</span> SQL<span class="token punctuation">,</span>connection_pool<span class="token operator">*</span> connPool<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token operator">*</span>SQL<span class="token operator">=</span>connPool<span class="token operator">-></span><span class="token function">GetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token operator">-></span>conRAII<span class="token operator">=</span><span class="token operator">*</span>SQL<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>poolRAII<span class="token operator">=</span>connPool<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">connectionRAII</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">connectionRAII</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token operator">-></span>poolRAII<span class="token operator">-></span><span class="token function">ReleaseConnection</span><span class="token punctuation">(</span>conRAII<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯¦ç»†ä»£ç å¦‚ä¸‹ï¼š</p><h3 id="sql-connection-pool-h"><a href="#sql-connection-pool-h" class="headerlink" title="sql_connection_pool.h"></a>sql_connection_pool.h</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_CONNECTION_POOL_</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_CONNECTION_POOL_</span></span><span class="token comment">//*è¯¥å¤´æ–‡ä»¶æ˜¯æ•°æ®åº“è¿æ¥æ± çš„å¤´æ–‡ä»¶</span><span class="token comment">//!å¤´æ–‡ä»¶å®Œæˆä½†è¿˜æœªæ£€æŸ¥</span><span class="token comment">//?ğŸ‘‡æ•°æ®åº“è¿æ¥æ± æ˜¯ä»€ä¹ˆï¼ŸğŸ‘‡</span><span class="token comment">//?æ•°æ®åº“è¿æ¥æ± å¯ä»¥åœ¨ç¨‹åºåˆå§‹åŒ–çš„æ—¶å€™ï¼Œé›†ä¸­åˆ›å»ºå¤šä¸ªæ•°æ®åº“è¿æ¥ï¼Œå¹¶æŠŠä»–ä»¬é›†ä¸­ç®¡ç†ï¼Œä¾›ç¨‹åºä½¿ç”¨</span><span class="token comment">//?ä¼˜åŒ–äº†ä¸€èˆ¬è®¿é—®æ•°æ®åº“çš„ï¼ˆé¢‘ç¹åˆ›å»ºè¿æ¥--æ“ä½œæ•°æ®åº“--æ–­å¼€è¿æ¥ï¼‰æ¨¡å¼</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mysql/mysql.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;error.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../lock/locker.h"</span> <span class="token comment">//äº’æ–¥é”</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../log/log.h"</span> <span class="token comment">//æ—¥å¿—</span></span><span class="token keyword">using</span> std<span class="token operator">::</span>string<span class="token punctuation">;</span><span class="token comment">//æ•°æ®åº“è¿æ¥æ± </span><span class="token keyword">class</span> <span class="token class-name">connection_pool</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>string url<span class="token punctuation">,</span>string User<span class="token punctuation">,</span>string PassWord<span class="token punctuation">,</span>string DataBaseName<span class="token punctuation">,</span><span class="token keyword">int</span> Port<span class="token punctuation">,</span><span class="token keyword">int</span> MaxConn<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">)</span><span class="token punctuation">;</span>    MYSQL<span class="token operator">*</span> <span class="token function">GetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//è·å–æ•°æ®åº“è¿æ¥</span>    <span class="token keyword">bool</span> <span class="token function">ReleaseConnection</span><span class="token punctuation">(</span>MYSQL<span class="token operator">*</span> con<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//é‡Šæ”¾è¿æ¥</span>    <span class="token keyword">int</span> <span class="token function">GetFreeConn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//è·å–è¿æ¥</span>    <span class="token keyword">void</span> <span class="token function">DestroyPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//é”€æ¯æ‰€æœ‰è¿æ¥</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token comment">//å•ä¾‹æ¨¡å¼</span>    <span class="token keyword">static</span> connection_pool<span class="token operator">*</span> <span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">~</span><span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> m_MaxConn<span class="token punctuation">;</span> <span class="token comment">//æœ€å¤§è¿æ¥æ•°</span>    <span class="token keyword">int</span> m_CurConn<span class="token punctuation">;</span> <span class="token comment">//å½“å‰å·²ä½¿ç”¨çš„è¿æ¥æ•°</span>    <span class="token keyword">int</span> m_FreeConn<span class="token punctuation">;</span> <span class="token comment">//å½“å‰ç©ºé—²çš„è¿æ¥æ•°</span>    locker lock<span class="token punctuation">;</span>    std<span class="token operator">::</span>list<span class="token operator">&lt;</span>MYSQL<span class="token operator">*</span><span class="token operator">></span> connList<span class="token punctuation">;</span>    sem reserve<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    string m_url<span class="token punctuation">;</span> <span class="token comment">//ä¸»æœºåœ°å€</span>    string m_Port<span class="token punctuation">;</span> <span class="token comment">//æ•°æ®åº“ç«¯å£å·</span>    string m_User<span class="token punctuation">;</span> <span class="token comment">//ç™»å½•æ•°æ®åº“çš„ç”¨æˆ·å</span>    string m_PassWord<span class="token punctuation">;</span> <span class="token comment">//ç™»å½•æ•°æ®åº“çš„å¯†ç </span>    string m_DatabaseName<span class="token punctuation">;</span> <span class="token comment">//ä½¿ç”¨çš„æ•°æ®åº“å</span>    <span class="token keyword">int</span> m_close_log<span class="token punctuation">;</span> <span class="token comment">//æ—¥å¿—å¼€å…³</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">//class connection_pool</span><span class="token comment">//*RAIIæœºåˆ¶ç±»</span><span class="token keyword">class</span> <span class="token class-name">connectionRAII</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">connectionRAII</span><span class="token punctuation">(</span>MYSQL<span class="token operator">*</span><span class="token operator">*</span> con<span class="token punctuation">,</span>connection_pool<span class="token operator">*</span> connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">~</span><span class="token function">connectionRAII</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    MYSQL<span class="token operator">*</span> conRAII<span class="token punctuation">;</span>    connection_pool<span class="token operator">*</span> poolRAII<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//_CONNECTION_POOL_</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="sql-connection-pool-cpp"><a href="#sql-connection-pool-cpp" class="headerlink" title="sql_connection_pool.cpp"></a>sql_connection_pool.cpp</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mysql/mysql.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../CGImysql/sql_connection_pool.h"</span></span><span class="token keyword">using</span> std<span class="token operator">::</span>string<span class="token punctuation">;</span>connection_pool<span class="token operator">::</span><span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_CurConn<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">connection_pool</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">connection_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">DestroyPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>connection_pool<span class="token operator">*</span> connection_pool<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//* å•ä¾‹æ¨¡å¼</span>    <span class="token keyword">static</span> connection_pool connPool<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>connPool<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ„é€ åˆå§‹åŒ–</span><span class="token keyword">void</span> connection_pool<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>string url<span class="token punctuation">,</span>string User<span class="token punctuation">,</span>string PassWord<span class="token punctuation">,</span>string DatabaseName<span class="token punctuation">,</span><span class="token keyword">int</span> Port<span class="token punctuation">,</span><span class="token keyword">int</span> MaxConn<span class="token punctuation">,</span><span class="token keyword">int</span> close_log<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//åˆå§‹åŒ–ä¿¡æ¯</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_url<span class="token operator">=</span>url<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_Port<span class="token operator">=</span>Port<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_User<span class="token operator">=</span>User<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_PassWord<span class="token operator">=</span>PassWord<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_DatabaseName<span class="token operator">=</span>DatabaseName<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_close_log<span class="token operator">=</span>close_log<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_MaxConn<span class="token operator">=</span>MaxConn<span class="token punctuation">;</span>        <span class="token comment">//åˆ›å»ºm_MaxConnæ¡æ•°æ®åº“è¿æ¥</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>m_MaxConn<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                MYSQL<span class="token operator">*</span> con<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>        con<span class="token operator">=</span><span class="token function">mysql_init</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>con<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            std<span class="token operator">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"Error:"</span><span class="token operator">&lt;&lt;</span><span class="token function">mysql_error</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">'\n'</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        con<span class="token operator">=</span><span class="token function">mysql_real_connect</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span>url<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>User<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>PassWord<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>DatabaseName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Port<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>con<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            std<span class="token operator">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"Error:"</span><span class="token operator">&lt;&lt;</span><span class="token function">mysql_error</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">'\n'</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//æ›´æ–°è¿æ¥æ± å’Œç©ºé—²è¿æ¥æ•°</span>        <span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">++</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token comment">//å°†ä¿¡å·é‡åˆå§‹åŒ–ä¸ºæœ€å¤§è¿æ¥æ¬¡æ•°</span>    <span class="token keyword">this</span><span class="token operator">-></span>reserve<span class="token operator">=</span><span class="token function">sem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_MaxConn<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è·å–ç©ºé—²è¿æ¥çš„æ•°æ®åº“</span><span class="token comment">//* å½“æœ‰è¯·æ±‚æ—¶ï¼Œä»æ•°æ®åº“è¿æ¥æ± ä¸­è¿”å›ä¸€ä¸ªå¯ç”¨çš„è¿æ¥ï¼Œæ›´æ–°å’Œä½¿ç”¨ç©ºé—²è¿æ¥æ•°</span>MYSQL<span class="token operator">*</span> connection_pool<span class="token operator">::</span><span class="token function">GetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    MYSQL<span class="token operator">*</span> con<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>        <span class="token comment">//å–å‡ºè¿æ¥ï¼Œä¿¡å·é‡åŸå­å‡1ï¼Œä¸º0åˆ™ç­‰å¾…</span>    reserve<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ä¸Šé”</span>    con<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">--</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">;</span>    <span class="token operator">++</span><span class="token keyword">this</span><span class="token operator">-></span>m_CurConn<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å¼€é”</span>    <span class="token keyword">return</span> con<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token comment">//é‡Šæ”¾å½“å‰ä½¿ç”¨çš„è¿æ¥</span><span class="token keyword">bool</span> connection_pool<span class="token operator">::</span><span class="token function">ReleaseConnection</span><span class="token punctuation">(</span>MYSQL<span class="token operator">*</span> con<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>con<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">++</span><span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token punctuation">;</span>    <span class="token operator">--</span><span class="token keyword">this</span><span class="token operator">-></span>m_CurConn<span class="token punctuation">;</span>    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//é‡Šæ”¾è¿æ¥åŸå­åŠ 1</span>    reserve<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//é”€æ¯æ•°æ®åº“è¿æ¥æ± </span><span class="token keyword">void</span> connection_pool<span class="token operator">::</span><span class="token function">DestroyPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//é€šè¿‡è¿­ä»£å™¨éå†ï¼Œå…³é—­æ•°æ®åº“è¿æ¥</span>        std<span class="token operator">::</span>list<span class="token operator">&lt;</span>MYSQL<span class="token operator">*</span><span class="token operator">></span><span class="token operator">::</span>iterator it<span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>it<span class="token operator">=</span>connList<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token operator">!=</span>connList<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>it<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            MYSQL<span class="token operator">*</span> con<span class="token operator">=</span><span class="token operator">*</span>it<span class="token punctuation">;</span>            <span class="token function">mysql_close</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_CurConn<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_FreeConn<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token operator">-></span>connList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/*connectionRAII::connectionRAII(MYSQL** SQL,connection_pool* connPool)&#123;    *SQL=connPool->GetConnection();        this->conRAII=*SQL;    this->poolRAII=connPool;&#125;connectionRAII::~connectionRAII()&#123;    this->poolRAII->ReleaseConnection(conRAII);&#125;*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="çº¿ç¨‹æ± "><a href="#çº¿ç¨‹æ± " class="headerlink" title="çº¿ç¨‹æ± "></a>çº¿ç¨‹æ± </h2><p>â—â—â—çº¿ç¨‹æ± ä¸­æœ‰å­˜æ”¾çº¿ç¨‹çš„æ•°ç»„ï¼Œæ•°ç»„ä¸­çš„çº¿ç¨‹æ˜¯ç”¨æ¥å¤„ç†è¯·æ±‚é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ä»»åŠ¡â—â—â—</p><ol><li><p>æˆå‘˜å˜é‡åŒ…å«äº†ï¼šæ•°æ®åº“è¿æ¥æ± æŒ‡é’ˆ<code>connection_pool* m_connPool;</code>ã€æè¿°çº¿ç¨‹æ± çš„æ•°ç»„<code>pthread_t* m_threads</code>ã€è¯·æ±‚é˜Ÿåˆ—<code>std::list&lt;T*&gt; m_workqueue;ï¼ˆå­˜æ”¾http_conn*ï¼‰</code></p></li><li><p>åˆå§‹åŒ–æ—¶ï¼Œçº¿ç¨‹æŒ‡é’ˆä¼šæ„å»ºæ•°ç»„==&gt;<code>m_threads=new pthread_t[m_thread_number];</code>ï¼Œå†è¿›å…¥forå¾ªç¯ä¸­é€ä¸ªå¯¹æ•°ç»„æˆå‘˜ç”¨<code>pthread_create(pthread_t *tidp,const pthread_attr_t *attr,void *(*start_rtn)(void*),void *arg);</code>åˆå§‹åŒ–ï¼Œæ¯ä¸ªçº¿ç¨‹çš„è¿è¡Œå‡½æ•°éƒ½æ˜¯<code>worker()</code>å‡½æ•°ï¼Œä¼ å…¥å‚æ•°<code>arg</code>ä¸ºè¯¥çº¿ç¨‹æ± ç±»å¯¹è±¡æŒ‡é’ˆ<strong>this</strong></p></li><li><p>æ¯ä¸ª<code>pthread_create()</code>å®Œæ¯•åï¼Œåˆä¼šå°†è¿™ä¸ªçº¿ç¨‹è¿›è¡Œåˆ†ç¦»ï¼Œå³<code>pthread_detach()</code>ï¼Œä½¿å¾—ä¸ç”¨å•ç‹¬å¯¹å·¥ä½œçº¿ç¨‹è¿›è¡Œå›æ”¶</p></li><li><p>worker()å‡½æ•°å†…éƒ¨åˆ™æ˜¯å°†ä¼ å…¥å‚æ•°<code>void* arg</code>è¿›è¡Œç±»å‹è½¬æ¢å›<code>threadpool*</code>ï¼ˆçº¿ç¨‹æ± æŒ‡é’ˆï¼‰ï¼Œæ¥ç€è°ƒç”¨æŒ‡é’ˆçš„<code>run()</code>å‡½æ•°ï¼Œæ‰€ä»¥<code>threadpool::run()</code>æ‰æ˜¯çœŸæ­£çš„<strong>æ‰§è¡Œä»»åŠ¡å‡½æ•°</strong>ğŸ‘‡</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//çº¿ç¨‹å¤„ç†å‡½æ•°</span><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">void</span><span class="token operator">*</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//å°†å‚æ•°å¼ºåˆ¶è½¬æ¢ä¸ºçº¿ç¨‹æ± ç±»ï¼Œè°ƒç”¨å‡½æ•°æ–¹æ³•</span>    threadpool<span class="token operator">*</span> pool<span class="token operator">=</span><span class="token punctuation">(</span>threadpool<span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>    pool<span class="token operator">-></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> pool<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>runå‡½æ•°ä¼šåˆ¤æ–­<strong>actoræ¨¡å¼</strong>ï¼Œåˆ¤æ–­<strong>m_state</strong>ä»¥åŠåˆ¤æ–­**read_once()**ï¼Œè¿™å‡ ä¸ªéƒ½æ˜¯åœ¨http_connç±»é‡Œé¢ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ¨æ–­å‡ºçº¿ç¨‹æ± çš„é“¾è¡¨å­˜æ”¾çš„æ•°æ®æ˜¯http_connè¿æ¥å¯¹è±¡</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//run()</span><span class="token comment">//runæ‰§è¡Œä»»åŠ¡</span><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">void</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-></span>m_stop<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//ä¿¡å·é‡ç­‰å¾…</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_queuestat<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è¢«å”¤é†’åå…ˆåŠ ä¸Šäº’æ–¥é”</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_workqueue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//ä»è¯·æ±‚é˜Ÿåˆ—ä¸­å–å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡</span>        <span class="token comment">//å°†ä»»åŠ¡iä»è¯·æ±‚é˜Ÿåˆ—ä¸­åˆ é™¤</span>        T<span class="token operator">*</span> request<span class="token operator">=</span>m_workqueue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m_workqueue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">)</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>m_actor_model<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//åˆ¤æ–­actoræ¨¡å¼ï¼Œ</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span>m_state<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//0ä¸ºè¯»ï¼Œ1ä¸ºå†™</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                    connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token operator">-></span>mysql<span class="token punctuation">,</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>                    request<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                    request<span class="token operator">-></span>timer_flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token keyword">else</span><span class="token punctuation">&#123;</span>                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                    request<span class="token operator">-></span>timer_flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token comment">//m_actor_model!=1</span>            connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token operator">-></span>mysql<span class="token punctuation">,</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>            request<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token comment">//actor_model</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>è¯¦ç»†ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">THREADPOOL_H</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THREADPOOL_H</span></span><span class="token comment">//!è¯¥ç±»æ˜¯çº¿ç¨‹æ± ç±»</span><span class="token comment">/** * !æ¨¡æ¿ç±»çš„æˆå‘˜å‡½æ•°å®ç°åº”è¯¥æ”¾åœ¨å¤´æ–‡ä»¶ä¸­ * !å› ä¸ºæ¨¡æ¿ç±»æœ¬è´¨ä¸Šä¸æ˜¯ç±»ï¼Œåªæœ‰å®ä¾‹åŒ–ä¹‹åæ‰ä¼šç¼–è¯‘ç”Ÿæˆ.oæ–‡ä»¶ */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;exception></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../lock/locker.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../CGImysql/sql_connection_pool.h"</span></span><span class="token comment">//!è¯¥çº¿ç¨‹æ± å¤´æ–‡ä»¶å·²å®Œæˆï¼Œä½†è¿˜æ²¡æœ‰æ£€æŸ¥</span><span class="token comment">//*çº¿ç¨‹æ± ç±»</span><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">class</span> <span class="token class-name">threadpool</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token comment">/**     * connPoolæ˜¯æ•°æ®åº“è¿æ¥æ± æŒ‡é’ˆ     * max_requestsæ˜¯è¯·æ±‚é˜Ÿåˆ—ä¸­æœ€å¤šå…è®¸çš„ã€ç­‰å¾…å¤„ç†çš„è¯·æ±‚æ•°é‡     * thread_numberæ˜¯çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°é‡     */</span>    <span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token keyword">int</span> actor_model<span class="token punctuation">,</span>connection_pool<span class="token operator">*</span> connPool<span class="token punctuation">,</span><span class="token keyword">int</span> thread_number<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token keyword">int</span> max_request<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">~</span><span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å‘è¯·æ±‚é˜Ÿåˆ—ä¸­æ’å…¥ä»»åŠ¡è¯·æ±‚</span>    <span class="token keyword">bool</span> <span class="token function">append_p</span><span class="token punctuation">(</span>T<span class="token operator">*</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">append</span><span class="token punctuation">(</span>T<span class="token operator">*</span> request<span class="token punctuation">,</span><span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token comment">//å·¥ä½œçº¿ç¨‹è¿è¡Œå‡½æ•°</span>    <span class="token comment">//å®ƒä¸æ–­ä»å·¥ä½œé˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œ</span>    <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span><span class="token operator">:</span>    <span class="token comment">//æ¨¡å‹åˆ‡æ¢</span>    <span class="token keyword">int</span> m_actor_model<span class="token punctuation">;</span>    <span class="token comment">//çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°</span>    <span class="token keyword">int</span> m_thread_number<span class="token punctuation">;</span>    <span class="token comment">//è¯·æ±‚é˜Ÿåˆ—ä¸­å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°</span>    <span class="token keyword">int</span> m_max_requests<span class="token punctuation">;</span>    <span class="token comment">//æè¿°çº¿ç¨‹æ± çš„æ•°ç»„ï¼Œå¤§å°ä¸º m_thread_number</span>    pthread_t<span class="token operator">*</span> m_threads<span class="token punctuation">;</span>    <span class="token comment">//è¯·æ±‚é˜Ÿåˆ—</span>    std<span class="token operator">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">></span> m_workqueue<span class="token punctuation">;</span>    <span class="token comment">//ä¿æŠ¤è¯·æ±‚é˜Ÿåˆ—çš„äº’æ–¥é”</span>    locker m_queuelocker<span class="token punctuation">;</span>    <span class="token comment">//æ˜¯å¦æœ‰ä»»åŠ¡éœ€è¦å¤„ç†</span>    sem m_queuestat<span class="token punctuation">;</span>    <span class="token comment">//æ˜¯å¦ç»“æŸçº¿ç¨‹</span>    <span class="token keyword">bool</span> m_stop<span class="token punctuation">;</span>    <span class="token comment">//æ•°æ®åº“è¿æ¥æ± </span>    connection_pool<span class="token operator">*</span> m_connPool<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token keyword">int</span> actor_model<span class="token punctuation">,</span>connection_pool<span class="token operator">*</span> connPool<span class="token punctuation">,</span><span class="token keyword">int</span> thread_number<span class="token punctuation">,</span><span class="token keyword">int</span> max_request<span class="token punctuation">)</span><span class="token operator">:</span>    <span class="token function">m_thread_number</span><span class="token punctuation">(</span>thread_number<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_max_requests</span><span class="token punctuation">(</span>max_request<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_stop</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_connPool</span><span class="token punctuation">(</span>connPool<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_actor_model</span><span class="token punctuation">(</span>actor_model<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//ä¼ å…¥å‚æ•°å¼‚å¸¸å¤„ç†</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>thread_number<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token operator">||</span>max_request<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//çº¿ç¨‹idåˆå§‹åŒ–</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_threads<span class="token operator">=</span><span class="token keyword">new</span> pthread_t<span class="token punctuation">[</span>m_thread_number<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_threads<span class="token punctuation">)</span>        <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>thread_number<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//å¾ªç¯åˆ›å»ºçº¿ç¨‹ï¼Œå¹¶å°†å·¥ä½œçº¿ç¨‹æŒ‰ç…§è¦æ±‚è¿›è¡Œ</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span>m_threads<span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>worker<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m_threads<span class="token punctuation">;</span>            <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//å°†çº¿ç¨‹è¿›è¡Œåˆ†ç¦»åï¼Œä¸ç”¨å•ç‹¬å¯¹å·¥ä½œçº¿ç¨‹è¿›è¡Œå›æ”¶</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">pthread_detach</span><span class="token punctuation">(</span>m_threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m_threads<span class="token punctuation">;</span>            <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>threadpool<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">threadpool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">this</span><span class="token operator">-></span>m_threads<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å‘è¯·æ±‚é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡</span><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">bool</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">append_p</span><span class="token punctuation">(</span>T<span class="token operator">*</span> request<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ ¹æ®ç¡¬ä»¶ï¼Œé¢„å…ˆè®¾ç½®è¯·æ±‚é˜Ÿåˆ—çš„æœ€å¤§å€¼</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>m_workqueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span>m_max_requests<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//æ·»åŠ ä»»åŠ¡</span>    m_workqueue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ä¿¡å·é‡æé†’æœ‰ä»»åŠ¡è¦å¤„ç†</span>    m_queuestat<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">bool</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">append</span><span class="token punctuation">(</span>T <span class="token operator">*</span>request<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_workqueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> m_max_requests<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    request<span class="token operator">-></span>m_state <span class="token operator">=</span> state<span class="token punctuation">;</span>    m_workqueue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    m_queuestat<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//çº¿ç¨‹å¤„ç†å‡½æ•°</span><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">void</span><span class="token operator">*</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//å°†å‚æ•°å¼ºåˆ¶è½¬æ¢ä¸ºçº¿ç¨‹æ± ç±»ï¼Œè°ƒç”¨å‡½æ•°æ–¹æ³•</span>    threadpool<span class="token operator">*</span> pool<span class="token operator">=</span><span class="token punctuation">(</span>threadpool<span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>    pool<span class="token operator">-></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> pool<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//runæ‰§è¡Œä»»åŠ¡</span><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">void</span> <span class="token class-name">threadpool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-></span>m_stop<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//ä¿¡å·é‡ç­‰å¾…</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_queuestat<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è¢«å”¤é†’åå…ˆåŠ ä¸Šäº’æ–¥é”</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_queuelocker<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_workqueue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//ä»è¯·æ±‚é˜Ÿåˆ—ä¸­å–å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡</span>        <span class="token comment">//å°†ä»»åŠ¡iä»è¯·æ±‚é˜Ÿåˆ—ä¸­åˆ é™¤</span>        T<span class="token operator">*</span> request<span class="token operator">=</span>m_workqueue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m_workqueue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m_queuelocker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">)</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>m_actor_model<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span>m_state<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//è¯»ä¸º0ï¼Œå†™ä¸º1</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                    connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token operator">-></span>mysql<span class="token punctuation">,</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>                    request<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                    request<span class="token operator">-></span>timer_flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">-></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token keyword">else</span><span class="token punctuation">&#123;</span>                    request<span class="token operator">-></span>improv<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                    request<span class="token operator">-></span>timer_flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token comment">//m_actor_model!=1</span>            connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token operator">-></span>mysql<span class="token punctuation">,</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>            request<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token comment">//actor_model</span>        <span class="token comment">/*         *ä¸Šé¢æ˜¯ä½¿ç”¨äº†RAIIæœºåˆ¶æ¥å®ç°ä¸‹é¢ä»£ç ï¼Œä½œç”¨æ•ˆæœæ˜¯ä¸€æ ·çš„                //ä»è¿æ¥æ± ä¸­å–å‡ºä¸€ä¸ªæ•°æ®åº“è¿æ¥        request->mysql=m_connPool->GetConnection();        //process(æ¨¡æ¿ç±»ä¸­çš„æ–¹æ³•ï¼Œè¿™é‡Œæ˜¯httpç±»)è¿›è¡Œå¤„ç†        request->process();        //å°†æ•°æ®åº“è¿æ¥æ”¾å›è¿æ¥æ±         m_connPool->ReleaseConnection(request->mysql);         */</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//THREADPOOL_H</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å®šæ—¶å™¨"><a href="#å®šæ—¶å™¨" class="headerlink" title="å®šæ—¶å™¨"></a>å®šæ—¶å™¨</h2><p>å®šæ—¶å™¨<code>lst_timer.h</code>å¤´æ–‡ä»¶ä¸­åŒ…å«äº†å››ä¸ªä¸œè¥¿ï¼Œåˆ†åˆ«æ˜¯ï¼šè¿æ¥èµ„æº<code> struct client_data</code>ã€å®šæ—¶å™¨å®¹å™¨ç±»<code>sort_timer_lst</code>ã€å®šæ—¶å™¨ç±»<code>util_timer</code>ä»¥åŠå·¥å…·ç±»<code>Utils</code></p><p>å®šæ—¶å™¨çš„è°ƒç”¨ä»£ç åœ¨WebServerç±»çš„ä¸€äº›æ–¹æ³•ä¸­ï¼Œå…·ä½“å·¥ä½œæµç¨‹åœ¨ç½‘ä¸Šçœ‹åˆ°äº†è§£é‡Š:point_down:</p><blockquote><p>ï¼ˆ1ï¼‰ é¦–å…ˆä½¿ç”¨socketpairåˆ›å»ºç®¡é“â€“&gt;m_pipefd[2]<br>ï¼ˆ2ï¼‰ è®¾ç½®å†™ç«¯ä¸ºéé˜»å¡ï¼Œæ˜¯ä¸ºäº†å‡å°‘ä¿¡å·å¤„ç†çš„æ—¶é—´ï¼Œå³ä½¿å®šæ—¶äº‹ä»¶å¤±æ•ˆä¹Ÿæ²¡å…³ç³»ï¼Œå¹¶ä¸ä¸¥æ ¼ã€‚<br>ï¼ˆ3ï¼‰ è®¾ç½®è¯»ç«¯ä¸ºETéé˜»å¡ï¼Œå‘epollæ ‘ä¸ŠæŒ‚è¯»ç®¡é“äº‹ä»¶ã€‚<br>ï¼ˆ4ï¼‰ æ‰§è¡Œä¿¡å·å‡½æ•°addsigï¼ŒæŠŠä¿¡å·æ·»åŠ åˆ°ä¿¡å·é›†å½“ä¸­ï¼Œå¹¶æŠŠä¿¡å·é»˜è®¤å¤„ç†æ–¹å¼æ”¹æˆsig_handlerå‡½æ•°(å‡½æ•°å†…å®¹æ˜¯å‘ç®¡é“å†™å…¥ä¿¡å·å€¼)<br>ï¼ˆ5ï¼‰ è®¾ç½®boolå€¼timeoutå’Œstop_serverï¼Œåé¢éœ€è¦ä½¿ç”¨ä»–ä»¬åˆ¤æ–­æ˜¯å¦æ‰§è¡Œä¿¡å·å¯¹åº”çš„å¤„ç†é€»è¾‘ã€‚<br>ï¼ˆ6ï¼‰ å¼€å§‹alarmå‡½æ•°ï¼Œè®¾å®šæ—¶é—´ã€‚<br>ï¼ˆ7ï¼‰ ç›‘å¬æ–‡ä»¶æè¿°ç¬¦epoll_waitã€‚<br>ï¼ˆ8ï¼‰ ç›‘å¬åˆ°ä»¥åè¯»å‡ºä¿¡å·ã€‚<br>ï¼ˆ9ï¼‰ æ‰§è¡Œå¤„ç†é€»è¾‘ï¼Œå¦‚æœä¿¡å·æ˜¯SIGALRMï¼Œtimeout=true;å¦‚æœæ˜¯SIGTERMï¼ˆctrl+cï¼‰stop_server=true;<br>ï¼ˆ10ï¼‰ åœ¨server.eventloop()ï¼ˆå°±æ˜¯epollæ ‘ä¸Šç›‘å¬åˆ°äº‹ä»¶åçš„å¤„ç†å‡½æ•°ï¼‰ä¸­å¦‚æœtimeout==true,æ‰§è¡Œtime_handlerå‡½æ•°ã€‚<br>ï¼ˆ11ï¼‰ time_handlerå‡½æ•°(Utilç±»ä¸­çš„)ï¼Œé¦–å…ˆæ‰§è¡Œtick()å‡½æ•°ï¼ˆå®šæ—¶å™¨é“¾è¡¨ç±»ä¸­çš„ï¼‰ï¼Œç„¶åå†æ¬¡æ‰§è¡Œalarm()ï¼Œç›¸å½“äºå†æ¬¡å¼€å§‹å®šæ—¶ï¼Œä¸€ä¸ªalarmå‡½æ•°åªèƒ½è§¦å‘ä¸€æ¬¡ä¿¡å·;<br>ï¼ˆ12ï¼‰ tick()å‡½æ•°é¦–å…ˆéå†å®šæ—¶å™¨é“¾è¡¨ï¼Œæ‰¾åˆ°åˆ°æœŸçš„å®šæ—¶å™¨ï¼ˆåˆ¤æ–­ç°åœ¨æ—¶é—´æ˜¯å¦&gt;expireï¼Œexpireæ˜¯å®šæ—¶å™¨èŠ‚ç‚¹ç±»ä¸­è®¾å®šçš„è¶…æ—¶æ—¶é—´ï¼‰ï¼Œå°±æ˜¯æ¯è¿‡ä¸€æ®µæ—¶é—´æ£€æŸ¥æ˜¯å¦è¶…æ—¶ã€‚å³åˆ©ç”¨alarmå‡½æ•°å‘¨æœŸæ€§åœ°è§¦å‘SIGALRMä¿¡å·,è¯¥ä¿¡å·çš„ä¿¡å·å¤„ç†å‡½æ•°åˆ©ç”¨ç®¡é“é€šçŸ¥ä¸»å¾ªç¯æ‰§è¡Œå®šæ—¶å™¨é“¾è¡¨ä¸Šçš„å®šæ—¶ä»»åŠ¡.<br>ï¼ˆ13ï¼‰ å¦‚æœè¶…æ—¶äº†å°±æ‰§è¡Œcb_funcå‡½æ•°ï¼Œåˆ é™¤epollæ ‘ä¸Šå¯¹åº”çš„é€šä¿¡fdï¼Œå…³é—­é€šä¿¡fd,http_connè¿æ¥æ•°-1ï¼›<br>ï¼ˆ14ï¼‰ é¡¹ç›®ä¸­TIMESLOTå€¼ä¸º5ï¼Œexpireåˆå§‹å€¼è®¾ç½®ä¸º ç°æœ‰æ—¶é—´+3*TIMESLOTï¼Œæ¯æœ‰è¯»å†™äº‹ä»¶å‘ç”Ÿï¼Œè¯¥é€šä¿¡fdå¯¹åº”çš„expireå°±åŠ 3ä¸ªTIMESLOTï¼ŒåŒæ—¶è°ƒæ•´å®šæ—¶å™¨é“¾è¡¨ç±»ä¸­è¯¥èŠ‚ç‚¹çš„ä½ç½®ï¼Œé€šè¿‡utilç±»å¯¹è±¡ä½¿ç”¨adjust_timerå‡½æ•°ã€‚</p></blockquote><p>ç®¡é“å°±æ˜¯WebServeré‡Œé¢çš„m_pipefd[2]ï¼Œå†™ç«¯å°±æ˜¯m_pipefd[1]ï¼Œè¯»ç«¯ä¸ºm_pipefd[0]</p><p>å…¶å®å°±æ˜¯åœ¨webserverçš„å¾ªç¯ä¸­ï¼Œå¦‚æœæ”¶åˆ°äº†æ¥è‡ªm_pipefd[0]çš„æ–‡ä»¶æè¿°ç¬¦æ´»è·ƒä¿¡æ¯ï¼Œå°±æ˜¯ä»£è¡¨æ”¶åˆ°äº†ä¿¡å·ï¼Œæ­¤æ—¶å°±è¦å»å¤„ç†è¯¥ä¿¡å·ï¼Œæ˜¯è¿æ¥èµ„æºè¶…æ—¶äº†è¿˜æ˜¯æ”¶åˆ°äº†æœåŠ¡å™¨çš„å…³é—­æŒ‡ä»¤ï¼Œå†åˆ†åˆ«è¿›è¡Œæ“ä½œ</p><p>è¿™é‡Œå¦‚æœæ”¶åˆ°èµ„æºè¶…æ—¶ä¿¡å·ï¼Œå…¶å®è¿˜æ˜¯è¦å¾ªç¯å®šæ—¶å™¨é“¾è¡¨ï¼Œæ‰¾åˆ°è¶…æ—¶çš„è¿æ¥åˆ æ‰ï¼Œæœ‰ç‚¹æ¶ˆè€—æ€§èƒ½</p><h3 id="è¿æ¥èµ„æºâ€”ç»“æ„ä½“client-date"><a href="#è¿æ¥èµ„æºâ€”ç»“æ„ä½“client-date" class="headerlink" title="è¿æ¥èµ„æºâ€”ç»“æ„ä½“client_date"></a>è¿æ¥èµ„æºâ€”ç»“æ„ä½“client_date</h3><p>è¿æ¥èµ„æºåŒ…å«äº†å®¢æˆ·ç«¯socketåœ°å€ã€socketæè¿°ç¬¦ç„¶åé™„å¸¦ä¸€ä¸ªå®šæ—¶å™¨å¯¹è±¡</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//è¿æ¥èµ„æº</span><span class="token keyword">struct</span> <span class="token class-name">client_data</span><span class="token punctuation">&#123;</span>        <span class="token comment">//å®¢æˆ·ç«¯socketåœ°å€</span>    sockaddr_in addreess<span class="token punctuation">;</span>    <span class="token comment">//socketæ–‡ä»¶æè¿°ç¬¦</span>    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>    <span class="token comment">//å®šæ—¶å™¨</span>    util_timer<span class="token operator">*</span> timer<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®šæ—¶å™¨ç±»â€”util-timer"><a href="#å®šæ—¶å™¨ç±»â€”util-timer" class="headerlink" title="å®šæ—¶å™¨ç±»â€”util_timer"></a>å®šæ—¶å™¨ç±»â€”util_timer</h3><p>è™½ç„¶ç”¨çš„æ˜¯ç±»ï¼Œä½†å…¶å®æ›´åƒä¸€ä¸ªç»“æ„ä½“ï¼Œä¸€ä¸ªå®šæ—¶å™¨åŒ…å«äº†è¿æ¥èµ„æºæŒ‡é’ˆ<code>client_data*</code>ã€å‰ä¸€ä¸ªå®šæ—¶å™¨<code>util_timer* prev</code>ã€åä¸€ä¸ªå®šæ—¶å™¨<code>util_timer* next</code>ã€è¶…æ—¶æ—¶é—´<code>time_t expire</code>å’Œä¸€ä¸ªå›è°ƒå‡½æ•°<code>void (*cb_func)(client_data*);</code></p><p>å›è°ƒå‡½æ•°ä¸»è¦ä½œç”¨å°±æ˜¯å°†å·²ç»åˆ°è¾¾è¶…æ—¶æ—¶é—´çš„è¿æ¥èµ„æºæ–­å¼€è¿æ¥ï¼Œå¹¶ä»epollä¸­åˆ é™¤ï¼Œå›è°ƒå‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">cb_func</span><span class="token punctuation">(</span>client_data<span class="token operator">*</span> user_data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>Utils<span class="token operator">::</span>u_epollfd<span class="token punctuation">,</span>EPOLL_CTL_DEL<span class="token punctuation">,</span>              user_data<span class="token operator">-></span>sockfd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä»epfdå¼•ç”¨çš„epollå®ä¾‹ä¸­åˆ é™¤ï¼ˆæ³¨é”€ï¼‰ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦fd</span>    <span class="token function">assert</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>user_data<span class="token operator">-></span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>    http_conn<span class="token operator">::</span>m_user_count<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®šæ—¶å™¨å®¹å™¨ç±»â€”sort-timer-lst"><a href="#å®šæ—¶å™¨å®¹å™¨ç±»â€”sort-timer-lst" class="headerlink" title="å®šæ—¶å™¨å®¹å™¨ç±»â€”sort_timer_lst"></a>å®šæ—¶å™¨å®¹å™¨ç±»â€”sort_timer_lst</h3><p>å…¶å®è¯´æ˜¯å®šæ—¶å™¨å®¹å™¨ç±»ï¼Œä½†æœ¬è´¨ä¸Šå®šæ—¶å™¨ç±»æœ¬èº«å°±åŒ…å«äº†æŒ‡å‘ä¸Šä¸ªå…ƒç´ å’Œä¸‹ä¸ªå…ƒç´ çš„æŒ‡é’ˆï¼Œå› æ­¤å®šæ—¶å™¨å®¹å™¨ç±»åªæ˜¯æä¾›äº†æ–¹æ³•æ¥æ–¹ä¾¿æ„å»ºåˆ é™¤å®šæ—¶å™¨ç­‰ç»´æŠ¤æ“ä½œ</p><p>é™¤äº†æ·»åŠ ã€åˆ é™¤ã€è°ƒæ•´å®šæ—¶å™¨çš„æ“ä½œä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡å¤„ç†å‡½æ•°<code>tick()</code>ï¼Œè¿™ä¸ªå‡½æ•°ä½œç”¨æ˜¯éå†å®šæ—¶å™¨é“¾è¡¨ï¼Œæ‰¾åˆ°è¶…æ—¶çš„å®šæ—¶å™¨ï¼Œè°ƒç”¨å›è°ƒå‡½æ•°ä»å†…æ ¸äº‹ä»¶è¡¨åˆ é™¤äº‹ä»¶ï¼Œå…³é—­æ–‡ä»¶æè¿°ç¬¦ï¼Œé‡Šæ”¾è¿æ¥èµ„æº</p><p>éšåå†å°†è¯¥å®šæ—¶å™¨ä»é“¾è¡¨å®¹å™¨ä¸­åˆ é™¤ï¼Œé‡ç½®å¤´ç»“ç‚¹ï¼Œè€Œtickæ˜¯ç”±Utils::timer_handler()æ¥è°ƒç”¨çš„</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//ææ„å‡½æ•°</span><span class="token class-name">sort_timer_lst</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    util_timer<span class="token operator">*</span> tmp<span class="token operator">=</span>head<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        head<span class="token operator">=</span>tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>        tmp<span class="token operator">=</span>head<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ·»åŠ å®šæ—¶å™¨ï¼Œå†…éƒ¨è°ƒç”¨ç§æœ‰æˆå‘˜å‡½æ•°add_timer</span><span class="token keyword">void</span> sort_timer_lst<span class="token operator">::</span><span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>head<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        head<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span>tail<span class="token operator">=</span>timer<span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å¦‚æœæ–°çš„å®šæ—¶å™¨è¶…æ—¶é—´å°äºå½“å‰å¤´éƒ¨ç»“ç‚¹</span>    <span class="token comment">//ç›´æ¥å°†å½“å‰å®šæ—¶å™¨èŠ‚ç‚¹ä½œä¸ºå¤´éƒ¨ç»“ç‚¹</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">-></span>expire<span class="token operator">&lt;</span>head<span class="token operator">-></span>expire<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        timer<span class="token operator">-></span>next<span class="token operator">=</span>head<span class="token punctuation">;</span>        head<span class="token operator">-></span>prev<span class="token operator">=</span>timer<span class="token punctuation">;</span>        head<span class="token operator">=</span>timer<span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å¦åˆ™è°ƒç”¨ç§æœ‰æˆå‘˜å‡½æ•°ï¼Œè°ƒæ•´å†…éƒ¨ç»“ç‚¹</span>    <span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//ç§æœ‰æˆå‘˜å‡½æ•°çš„add_timerï¼Œç”¨äºä¸€èˆ¬æƒ…å†µæ·»åŠ è°ƒæ•´ç»“ç‚¹</span><span class="token keyword">void</span> sort_timer_lst<span class="token operator">::</span><span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">,</span>util_timer<span class="token operator">*</span> lst_head<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    util_timer<span class="token operator">*</span> prev<span class="token operator">=</span>lst_head<span class="token punctuation">;</span>    util_timer<span class="token operator">*</span> tmp<span class="token operator">=</span>prev<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token comment">//éå†å½“å‰ç»“ç‚¹ä¹‹åçš„é“¾è¡¨ï¼ŒæŒ‰ç…§è¶…æ—¶é—´æ‰¾åˆ°ç›®æ ‡å®šæ—¶å™¨å¯¹åº”çš„ä½ç½®ï¼Œå¸¸è§„åŒå‘é“¾è¡¨çš„æ’å…¥</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>tmp<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">-></span>expire<span class="token operator">&lt;</span>tmp<span class="token operator">-></span>expire<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            prev<span class="token operator">-></span>next<span class="token operator">=</span>timer<span class="token punctuation">;</span>            timer<span class="token operator">-></span>next<span class="token operator">=</span>tmp<span class="token punctuation">;</span>            tmp<span class="token operator">-></span>prev<span class="token operator">=</span>timer<span class="token punctuation">;</span>            timer<span class="token operator">-></span>prev<span class="token operator">=</span>prev<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        prev<span class="token operator">=</span>tmp<span class="token punctuation">;</span>        tmp<span class="token operator">=</span>tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//éå†å®Œå‘ç°ï¼Œç›®æ ‡å®šæ—¶å™¨éœ€è¦æ”¾åˆ°ç»“å°¾ç»“ç‚¹å¤„</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>tmp<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        prev<span class="token operator">-></span>next<span class="token operator">=</span>timer<span class="token punctuation">;</span>        timer<span class="token operator">-></span>prev<span class="token operator">=</span>prev<span class="token punctuation">;</span>        timer<span class="token operator">-></span>next<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token operator">-></span>tail<span class="token operator">=</span>timer<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> sort_timer_lst<span class="token operator">::</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    util_timer<span class="token operator">*</span> tmp<span class="token operator">=</span>timer<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token comment">//è¢«è°ƒæ•´çš„å®šæ—¶å™¨åœ¨é“¾è¡¨å°¾éƒ¨</span>    <span class="token comment">//å®šæ—¶å™¨è¶…æ—¶å€¼ä»ç„¶å°äºä¸‹ä¸€ä¸ªå®šæ—¶å™¨çš„è¶…æ—¶å€¼ï¼Œä¸ç”¨ä½œå‡ºè°ƒæ•´</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>tmp<span class="token operator">||</span>timer<span class="token operator">-></span>expire<span class="token operator">&lt;</span>tmp<span class="token operator">-></span>expire<span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token comment">//è¢«è°ƒæ•´å®šæ—¶å™¨æ—¶é“¾è¡¨å¤´éƒ¨èŠ‚ç‚¹ï¼Œå°†å®šæ—¶å™¨å–å‡ºï¼Œé‡æ–°æ’å…¥</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">==</span><span class="token keyword">this</span><span class="token operator">-></span>head<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        head<span class="token operator">=</span>head<span class="token operator">-></span>next<span class="token punctuation">;</span>        head<span class="token operator">-></span>prev<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>        timer<span class="token operator">-></span>next<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token comment">//è¢«è°ƒæ•´çš„å®šæ—¶å™¨åœ¨å†…éƒ¨ï¼Œå°†å®šæ—¶å™¨å–å‡ºï¼Œé‡æ–°æ’å…¥</span>        timer<span class="token operator">-></span>prev<span class="token operator">-></span>next<span class="token operator">=</span>timer<span class="token operator">-></span>next<span class="token punctuation">;</span>        timer<span class="token operator">-></span>next<span class="token operator">-></span>prev<span class="token operator">=</span>timer<span class="token operator">-></span>prev<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span>timer<span class="token operator">-></span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//åˆ é™¤å®šæ—¶å™¨</span><span class="token keyword">void</span> sort_timer_lst<span class="token operator">::</span><span class="token function">del_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token comment">//é“¾è¡¨ä¸­åªæœ‰ä¸€ä¸ªå®šæ—¶å™¨ï¼Œåˆ é™¤çš„åˆšå¥½æ˜¯è¿™ä¸ª</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">==</span><span class="token keyword">this</span><span class="token operator">-></span>head<span class="token operator">&amp;&amp;</span>timer<span class="token operator">==</span><span class="token keyword">this</span><span class="token operator">-></span>tail<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>        head<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>        tail<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//è¢«åˆ é™¤çš„å®šæ—¶å™¨ä¸ºç»“ç‚¹</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">==</span><span class="token keyword">this</span><span class="token operator">-></span>head<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        head<span class="token operator">=</span>head<span class="token operator">-></span>next<span class="token punctuation">;</span>        head<span class="token operator">-></span>prev<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>        <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//è¢«åˆ é™¤çš„å®šæ—¶å™¨ä¸ºå°¾ç»“ç‚¹</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>timer<span class="token operator">==</span><span class="token keyword">this</span><span class="token operator">-></span>tail<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        tail<span class="token operator">=</span>tail<span class="token operator">-></span>prev<span class="token punctuation">;</span>        tail<span class="token operator">-></span>next<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>        <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//è¢«åˆ é™¤çš„é“¾è¡¨å†…éƒ¨ï¼Œå¸¸è§„é“¾è¡¨åˆ é™¤ç»“ç‚¹</span>    timer<span class="token operator">-></span>prev<span class="token operator">-></span>next<span class="token operator">=</span>timer<span class="token operator">-></span>next<span class="token punctuation">;</span>    timer<span class="token operator">-></span>next<span class="token operator">-></span>prev<span class="token operator">=</span>timer<span class="token operator">-></span>prev<span class="token punctuation">;</span>    <span class="token keyword">delete</span> timer<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å®šæ—¶ä»»åŠ¡å¤„ç†å‡½æ•°</span><span class="token keyword">void</span> sort_timer_lst<span class="token operator">::</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>head<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token comment">//è·å–å½“å‰æ—¶é—´</span>    time_t cur<span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    util_timer<span class="token operator">*</span> tmp<span class="token operator">=</span>head<span class="token punctuation">;</span>    <span class="token comment">//éå†å®šæ—¶å™¨é“¾è¡¨</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>tmp<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//é“¾è¡¨å®¹å™¨ä¸ºå‡åºæ’åˆ—</span>        <span class="token comment">//å½“å‰æ—¶é—´å°äºå®šæ—¶å™¨çš„è¶…æ—¶æ—¶é—´ï¼Œåé¢å®šæ—¶å™¨ä¹Ÿæ²¡æœ‰åˆ°æœŸ</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>cur<span class="token operator">&lt;</span>tmp<span class="token operator">-></span>expire<span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token comment">//å½“å‰å®šæ—¶å™¨åˆ°æœŸï¼Œåˆ™è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œæ‰§è¡Œå®šæ—¶äº‹ä»¶</span>        <span class="token comment">//*å›è°ƒå‡½æ•°ä¼ å…¥çš„å‚æ•°ç±»å‹ä¸º (client_data*)</span>        <span class="token function">cb_func</span><span class="token punctuation">(</span>tmp<span class="token operator">-></span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å°†å¤„ç†åçš„å®šæ—¶å™¨ä»é“¾è¡¨å®¹å™¨ä¸­åˆ é™¤ï¼Œå¹¶é‡ç½®å¤´ç»“ç‚¹</span>        <span class="token keyword">this</span><span class="token operator">-></span>head<span class="token operator">=</span>tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>head<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>            head<span class="token operator">-></span>prev<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>        <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>        tmp<span class="token operator">=</span>head<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">// end while</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å·¥å…·ç±»Utils"><a href="#å·¥å…·ç±»Utils" class="headerlink" title="å·¥å…·ç±»Utils"></a>å·¥å…·ç±»Utils</h3><p>Utilsæ˜¯ç»™å¤–éƒ¨ä½¿ç”¨çš„åŠŸèƒ½çš„ç±»ï¼ˆå…·ä½“ä¹Ÿæ˜¯åœ¨WebServerç±»ä¸­è°ƒç”¨ï¼Œåˆ©ç”¨ç®¡é“é€šçŸ¥ä¸»å¾ªç¯æ‰§è¡Œå®šæ—¶å™¨é“¾è¡¨ä¸Šçš„å®šæ—¶ä»»åŠ¡ï¼‰ï¼Œè¿™ä¸ªç±»å¯ä»¥ç”¨æ¥å¯¹å®šæ—¶å™¨è¿›è¡Œè®¾ç½®</p><p>é€»è¾‘é¡ºåºï¼Œè®¾ç½®ä¿¡å·åï¼Œè§¦å‘æ—¶è°ƒç”¨ä¿¡å·å¤„ç†å‡½æ•°ï¼Œä¿¡å·å¤„ç†å‡½æ•°é€šè¿‡ç®¡é“å°†sigå‘é€åˆ°ä¸»å¾ªç¯<br>ä¸»å¾ªç¯é€šè¿‡ç®¡é“æ¥æ”¶sigï¼Œå¾—çŸ¥æœ‰å®šæ—¶å™¨è¶…æ—¶ï¼Œå†è°ƒç”¨å®šæ—¶å™¨å¤„ç†ä»»åŠ¡å‡½æ•°timer_handler()å¤„ç†ï¼Œå¹¶ä¸”å†æ­¤è®¾å®šALARMä¿¡å·è§¦å‘ï¼Œå½¢æˆå¾ªç¯</p><p>è¯¦ç»†ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span><span class="token operator">*</span> Utils<span class="token operator">::</span>u_pipefd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> Utils<span class="token operator">::</span>u_epollfd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//å®šæ—¶å¤„ç†ä»»åŠ¡ï¼Œé‡æ–°å®šæ—¶ä»¥ä¸æ–­è§¦å‘SIGALRM</span><span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token operator">::</span><span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_timer_lst<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">alarm</span><span class="token punctuation">(</span>m_TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//m_TIMESLOTåˆå§‹åŒ–</span><span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeslot<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token operator">-></span>m_TIMESLOT<span class="token operator">=</span>timeslot<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/** * EPOLLIN - å½“å…³è”çš„æ–‡ä»¶å¯ä»¥æ‰§è¡Œ read ()æ“ä½œæ—¶ã€‚ * EPOLLOUT - å½“å…³è”çš„æ–‡ä»¶å¯ä»¥æ‰§è¡Œ write ()æ“ä½œæ—¶ã€‚ *? EPOLLRDHUP - ä»£è¡¨å¯¹ç«¯æ–­å¼€è¿æ¥ ?ä¸æ‡‚çš„äº‹ä»¶ * EPOLLET - è®¾ç½®æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æ¨¡å¼ä¸ºè¾¹ç¼˜è§¦å‘ï¼Œé»˜è®¤çš„æ¨¡å¼æ˜¯æ°´å¹³è§¦å‘ã€‚ */</span><span class="token comment">//å°†å†…æ ¸äº‹ä»¶è¡¨æ³¨å†Œè¯»äº‹ä»¶ï¼ŒETæ¨¡å¼ï¼Œé€‰æ‹©å¼€å¯EPOLLONESHOTï¼Œå¼€å¯ååŒä¸€æ—¶é—´åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å¤„ç†åŒä¸€ä¸ªsocket</span><span class="token comment">//LTï¼ˆlevel triggeræ°´å¹³æ¨¡å¼ï¼‰  ETï¼ˆedge triggerè¾¹ç¼˜æ¨¡å¼ï¼‰</span><span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token operator">::</span><span class="token function">addfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span><span class="token keyword">bool</span> one_shot<span class="token punctuation">,</span><span class="token keyword">int</span> TRIGMode<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    epoll_event event<span class="token punctuation">;</span>    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token operator">=</span>fd<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>TRIGMode<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>        event<span class="token punctuation">.</span>events<span class="token operator">=</span>EPOLLIN<span class="token operator">|</span>EPOLLET<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">;</span>    <span class="token keyword">else</span>        event<span class="token punctuation">.</span>events<span class="token operator">=</span>EPOLLIN<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>one_shot<span class="token punctuation">)</span>        event<span class="token punctuation">.</span>events<span class="token operator">|=</span>EPOLLONESHOT<span class="token punctuation">;</span>    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span>EPOLL_CTL_ADD<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">setnonblocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å¯¹æ–‡ä»¶æè¿°ç¬¦è®¾ç½®éé˜»å¡ï¼Œè¿”å›fdåŸæ¥çš„è®¾ç½®</span><span class="token keyword">int</span> <span class="token class-name">Utils</span><span class="token operator">::</span><span class="token function">setnonblocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> old_option<span class="token operator">=</span><span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–fdåŸæ¥çš„è®¾ç½®</span>    <span class="token keyword">int</span> new_option<span class="token operator">=</span>old_option<span class="token operator">|</span>O_NONBLOCK<span class="token punctuation">;</span><span class="token comment">//æ·»åŠ éé˜»å¡è®¾ç½®</span>    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>F_SETFL<span class="token punctuation">,</span>new_option<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸ºfdåº”ç”¨æ–°è®¾ç½®</span>    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//ä¿¡å·å¤„ç†å‡½æ•°</span><span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token operator">::</span><span class="token function">sig_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//ä¸ºä¿è¯å‡½æ•°çš„å¯é‡å…¥æ€§ï¼Œä¿ç•™åŸæ¥çš„errno</span>    <span class="token comment">//å¯é‡å…¥æ€§è¡¨ç¤ºä¸­æ–­åå†æ¬¡è¿›å…¥è¯¥å‡½æ•°ï¼Œç¯å¢ƒå˜é‡ä¸ä¹‹å‰ç›¸åŒï¼Œä¸ä¼šä¸¢å¤±æ•°æ®</span>    <span class="token keyword">int</span> save_errno<span class="token operator">=</span>errno<span class="token punctuation">;</span>    <span class="token keyword">int</span> msg<span class="token operator">=</span>sig<span class="token punctuation">;</span>    <span class="token comment">//å°†ä¿¡å·ä»ç®¡é“å†™ç«¯å†™å…¥ï¼Œä¼ è¾“å­—ç¬¦ç±»å‹ï¼Œè€Œéæ•´å‹</span>    <span class="token function">send</span><span class="token punctuation">(</span>u_pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    errno<span class="token operator">=</span>save_errno<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è®¾ç½®ä¿¡å·å‡½æ•°</span><span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token operator">::</span><span class="token function">addsig</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">bool</span> restart<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//åˆ›å»ºsigactionç»“æ„ä½“å˜é‡</span>    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sa<span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–</span>    <span class="token comment">//ä¿¡å·å¤„ç†å‡½æ•°ä¸­ä»…ä»…å‘é€ä¿¡å·å€¼ï¼Œä¸åšå¯¹åº”é€»è¾‘å¤„ç†</span>    sa<span class="token punctuation">.</span>sa_handler<span class="token operator">=</span>handler<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>restart<span class="token punctuation">)</span>        sa<span class="token punctuation">.</span>sa_flags<span class="token operator">|=</span>SA_RESTART<span class="token punctuation">;</span>    <span class="token comment">//å°†æ‰€æœ‰ä¿¡å·æ·»åŠ åˆ°ä¿¡å·é›†ä¸­</span>    <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ‰§è¡Œsigactionå‡½æ•°</span>    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">Utils</span><span class="token operator">::</span><span class="token function">show_error</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> info<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">send</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span>info<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="http-connç±»"><a href="#http-connç±»" class="headerlink" title="http_connç±»"></a>http_connç±»</h2><p>http_connç±»ä¸»è¦åŠŸèƒ½å°±æ˜¯å¤„ç†æŠ¥æ–‡çš„è¯»å–å’Œå‘é€ï¼ŒåŒæ—¶è¿™é‡Œè¿˜æ¶‰åŠåˆ°äº†ä¸»ä»çŠ¶æ€æœºï¼Œä»çŠ¶æ€æœºè´Ÿè´£è¯»å–æŠ¥æ–‡çš„ä¸€è¡Œï¼Œä¸»çŠ¶æ€æœºè´Ÿè´£å¯¹è¯¥è¡Œæ•°æ®è¿›è¡Œè§£æï¼ˆä¸»çŠ¶æ€æœºå†…éƒ¨è°ƒç”¨äº†ä»çŠ¶æ€æœºï¼‰ï¼Œç”±äºè¿™ä¸ªç±»æ¯”è¾ƒå¤§ï¼Œè¿™é‡Œåˆ†ç±»æ¥è®°å½•</p><p>http_connçš„è°ƒç”¨æ˜¯åœ¨WebServerç±»ä¸­çš„ï¼Œåœ¨WebServerç±»æœ‰ä¸ªæˆå‘˜å˜é‡http_conn* æŒ‡é’ˆï¼Œä»£è¡¨http_connæ•°ç»„ã€‚åœ¨WebServerç±»æ„é€ å‡½æ•°ä¸­ï¼Œè¿™ä¸ªæŒ‡é’ˆä¼šè¿›è¡Œnewï¼š<code>users=new http_conn[MAX_FD];//http_connç±»å¯¹è±¡ï¼ŒMAX_FD=65536</code>ï¼Œ</p><p>é—®é¢˜ï¼šè¿™é‡Œæœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ä¸çŸ¥é“æ˜¯ä»€ä¹ˆ<code>int timer_flag;</code>å’Œ<code>int improv;</code>ã€‚è¿˜æœ‰ä¸¤ä¸ªç»“æ„ä½“ä¹Ÿä¸çŸ¥é“æ˜¯å•¥<code>struct stat m_file_stat;</code>å’Œ<code>struct iovec m_iv[2];//ioå‘é‡æœºåˆ¶iovec</code></p><p>1ã€åœ¨http_conn.hå¤´æ–‡ä»¶ä¸­ï¼Œæˆå‘˜å˜é‡æœ‰ä¸¤ä¸ªç¼“å†²åŒºï¼Œåˆ†åˆ«æ˜¯è¯»ç¼“å†²åŒº<code>char m_read_buf[READ_BUFFER_SIZE];</code>ï¼Œä»–æ˜¯ç”¨æ¥å­˜å‚¨è¯»å–çš„è¯·æ±‚æŠ¥æ–‡çš„æ•°æ®ï¼›å¦å¤–ä¸€ä¸ªæ˜¯å†™ç¼“å†²åŒº<code>char m_write_buf[WRITE_BUFFER_SIZE];</code>ä»–æ˜¯ç”¨æ¥å­˜å‚¨å³å°†è¦å‘å‡ºçš„å“åº”æŠ¥æ–‡çš„æ•°æ®</p><h3 id="å››ä¸ªä¸å±äºç±»æˆå‘˜å‡½æ•°"><a href="#å››ä¸ªä¸å±äºç±»æˆå‘˜å‡½æ•°" class="headerlink" title="å››ä¸ªä¸å±äºç±»æˆå‘˜å‡½æ•°"></a>å››ä¸ªä¸å±äºç±»æˆå‘˜å‡½æ•°</h3><p>2ã€åœ¨http_conn.cppä»£ç æ–‡ä»¶ä¸­æœ‰å››ä¸ªä¸æ˜¯å±äºç±»æˆå‘˜çš„å‡½æ•°ï¼Œè¿™å››ä¸ªå‡½æ•°æ˜¯å¯¹epollç›¸å…³è®¾ç½®çš„å°è£…ï¼Œä½œä¸ºåŠŸèƒ½æ€§å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//å°†æ–‡ä»¶æè¿°ç¬¦è®¾ç½®ä¸ºéé˜»å¡</span><span class="token keyword">int</span> <span class="token function">set_no_blocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> old_option<span class="token operator">=</span><span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> new_option<span class="token operator">=</span>old_option<span class="token operator">|</span>O_NONBLOCK<span class="token punctuation">;</span>    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>F_SETFL<span class="token punctuation">,</span>new_option<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å°†å†…æ ¸äº‹ä»¶æ³¨å†Œè¯»äº‹ä»¶ï¼ŒETæ¨¡å¼ï¼Œé€‰æ‹©å¼€å¯EPOLLONESHOT</span><span class="token keyword">void</span> <span class="token function">add_fd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span><span class="token keyword">bool</span> one_shot<span class="token punctuation">,</span><span class="token keyword">int</span> TRIGMode<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    epoll_event event<span class="token punctuation">;</span>    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token operator">=</span>fd<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>TRIGMode<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>        event<span class="token punctuation">.</span>events<span class="token operator">=</span>EPOLLIN<span class="token operator">|</span>EPOLLET<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">;</span>    <span class="token keyword">else</span>        event<span class="token punctuation">.</span>events<span class="token operator">=</span>EPOLLIN<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>one_shot<span class="token punctuation">)</span>        event<span class="token punctuation">.</span>events<span class="token operator">|=</span>EPOLLONESHOT<span class="token punctuation">;</span>        <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span>EPOLL_CTL_ADD<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">set_no_blocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å°†fdè®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼</span><span class="token punctuation">&#125;</span><span class="token comment">//ä»å†…æ ¸äº‹ä»¶è¡¨ä¸­åˆ é™¤æè¿°ç¬¦ï¼Œä¾‹å¦‚ï¼šå–æ¶ˆå¯¹æŸä¸ªå®¢æˆ·ç«¯çš„ç›‘å¬</span><span class="token keyword">void</span> <span class="token function">remove_fd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span>EPOLL_CTL_DEL<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å°†äº‹ä»¶é‡ç½®ä¸ºEPOLLONESHOT</span><span class="token keyword">void</span> <span class="token function">modfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span><span class="token keyword">int</span> ev<span class="token punctuation">,</span><span class="token keyword">int</span> TRIGMode<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    epoll_event event<span class="token punctuation">;</span>    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token operator">=</span>fd<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>TRIGMode<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>        event<span class="token punctuation">.</span>events<span class="token operator">=</span>ev<span class="token operator">|</span>EPOLLET<span class="token operator">|</span>EPOLLONESHOT<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">;</span>    <span class="token keyword">else</span>        event<span class="token punctuation">.</span>events<span class="token operator">=</span>ev<span class="token operator">|</span>EPOLLONESHOT<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">;</span>    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span>EPOLL_CTL_MOD<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¸¤ä¸ªåˆå§‹åŒ–init"><a href="#ä¸¤ä¸ªåˆå§‹åŒ–init" class="headerlink" title="ä¸¤ä¸ªåˆå§‹åŒ–init()"></a>ä¸¤ä¸ªåˆå§‹åŒ–init()</h3><p>3ã€æœ‰ä¸¤ä¸ªåˆå§‹åŒ–å‡½æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯å¤–ç•Œè°ƒç”¨çš„å¸¦å‚æ•°çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œå®ç°ä¸»è¦æ˜¯å°†å¤–ç•Œä¼ è¿›æ¥çš„å‚æ•°èµ‹å€¼ç»™å½“å‰çš„è¿æ¥å¯¹è±¡ï¼Œå¹¶å°†sockfdæ·»åŠ åˆ°epollç›‘å¬åˆ—è¡¨ä¸­</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//åˆå§‹åŒ–è¿æ¥ï¼Œå¤–éƒ¨è°ƒç”¨åˆå§‹åŒ–å¥—æ¥å­—åœ°å€</span><span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span><span class="token keyword">const</span> sockaddr_in<span class="token operator">&amp;</span> addr<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> root<span class="token punctuation">,</span><span class="token keyword">int</span> TRIGMode<span class="token punctuation">,</span>    <span class="token keyword">int</span> close_log<span class="token punctuation">,</span>string user<span class="token punctuation">,</span>string passwd<span class="token punctuation">,</span>string sql_name<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token operator">-></span>m_sockfd<span class="token operator">=</span>sockfd<span class="token punctuation">;</span><span class="token keyword">this</span><span class="token operator">-></span>m_address<span class="token operator">=</span>addr<span class="token punctuation">;</span>        <span class="token comment">//å‘epollfdä¸­æ·»åŠ ä¸€ä¸ªsockfdï¼Œé»˜è®¤å¼€å¯EPOLLONESHOTæ¨¡å¼</span>    <span class="token function">add_fd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>sockfd<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">++</span>m_user_count<span class="token punctuation">;</span>        <span class="token comment">//å½“æµè§ˆå™¨å‡ºç°è¿æ¥é‡ç½®æ—¶ï¼Œå¯èƒ½æ—¶ç½‘ç«™æ ¹ç›®å½•å‡ºé”™æˆ–httpå“åº”æ ¼å¼å‡ºé”™æˆ–è€…è®¿é—®çš„æ–‡ä»¶ä¸­å†…å®¹å®Œå…¨ä¸ºç©º</span>    doc_root<span class="token operator">=</span>root<span class="token punctuation">;</span>    m_TRIGMode<span class="token operator">=</span>TRIGMode<span class="token punctuation">;</span>    m_close_log<span class="token operator">=</span>close_log<span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>sql_user<span class="token punctuation">,</span>user<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>sql_passwd<span class="token punctuation">,</span>passwd<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>sql_name<span class="token punctuation">,</span>sql_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦å¤–ä¸€ä¸ªåˆ™æ˜¯åœ¨ä¸Šé¢å¸¦å‚æ•°initåˆå§‹åŒ–å®Œæˆåï¼Œå†è°ƒç”¨æ— å‚çš„init()ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªæ— å‚initæ˜¯ç§æœ‰æˆå‘˜ï¼ˆprivateï¼‰å‡½æ•°</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//ç§æœ‰initå‡½æ•°ï¼Œåˆå§‹åŒ–æ–°æ¥å—çš„è¿æ¥</span><span class="token comment">//check_stateé»˜è®¤ä¸ºåˆ†æè¯·æ±‚çŠ¶æ€</span><span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token operator">-></span>mysql<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>bytes_have_send<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>bytes_to_send<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>m_check_state<span class="token operator">=</span>CHECK_STATE<span class="token operator">::</span>REQUESTLINE<span class="token punctuation">;</span>m_linger<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//æ˜¯å¦é•¿è¿æ¥</span>m_method<span class="token operator">=</span>METHOD<span class="token operator">::</span>GET<span class="token punctuation">;</span>m_url<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>m_version<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>m_content_length<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>m_host<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>m_start_line<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>m_checked_idx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>m_read_idx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>m_write_idx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>cgi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>m_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//?ä¸‹é¢ä¸¤ä¸ªæ˜¯ä»€ä¹ˆï¼Ÿ</span>timer_flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>improv<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>m_read_buf<span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">,</span>READ_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>m_write_buf<span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">,</span>WRITE_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">,</span>FILENAME_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä»æ•°æ®åº“ä¸­å¯¼å…¥è´¦æˆ·å¯†ç åˆ°å“ˆå¸Œè¡¨ä¸­"><a href="#ä»æ•°æ®åº“ä¸­å¯¼å…¥è´¦æˆ·å¯†ç åˆ°å“ˆå¸Œè¡¨ä¸­" class="headerlink" title="ä»æ•°æ®åº“ä¸­å¯¼å…¥è´¦æˆ·å¯†ç åˆ°å“ˆå¸Œè¡¨ä¸­"></a>ä»æ•°æ®åº“ä¸­å¯¼å…¥è´¦æˆ·å¯†ç åˆ°å“ˆå¸Œè¡¨ä¸­</h3><p><code>void http_conn::initMysql_result(connection_pool* connPool)</code>è¿™ä¸ªå‡½æ•°æ˜¯ç”¨äºå°†æ•°æ®åº“ä¸­çš„è´¦æˆ·å¯†ç åŠ è½½åœ¨å†…å­˜çš„unordered_mapä¸­ï¼Œæ€è·¯åˆ™æ˜¯ä»MySQLè¿æ¥æ± ä¸­å–å‡ºä¸€ä¸ªç©ºé—²è¿æ¥ï¼Œè¿›è¡ŒæŸ¥è¯¢è¯­å¥åå°†ç»“æœé›†ä¸­æ¯ä¸€è¡Œç»“æœå¾€å“ˆå¸Œè¡¨å˜é‡<code>unordered_map&lt;string,string&gt; m_users</code>ä¸­å†™æ•°æ®ï¼Œé”®ä¸ºç”¨æˆ·åï¼Œå€¼ä¸ºå¯†ç ï¼ˆï¼å¯æ”¹è¿›åœ°æ–¹ä¸ºå¯¹å¯†ç è¿›è¡ŒåŠ å¯†å¤„ç†ï¼‰</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//å°†æ•°æ®åº“ä¸­çš„ç”¨æˆ·åå’Œå¯†ç è½½å…¥åˆ°æœåŠ¡å™¨ä¸­çš„mapä¸­</span><span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">initMysql_result</span><span class="token punctuation">(</span>connection_pool<span class="token operator">*</span> connPool<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//å…ˆä»è¿æ¥æ± ä¸­å–ä¸€ä¸ªè¿æ¥</span>    MYSQL <span class="token operator">*</span>mysql <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql<span class="token punctuation">,</span> connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//åœ¨userè¡¨ä¸­æ£€ç´¢usernameï¼Œpasswdæ•°æ®ï¼Œæµè§ˆå™¨ç«¯è¾“å…¥</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span> <span class="token string">"SELECT username,passwd FROM user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"SELECT error:%s\n"</span><span class="token punctuation">,</span> <span class="token function">mysql_error</span><span class="token punctuation">(</span>mysql<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token comment">//ä»è¡¨ä¸­æ£€ç´¢å®Œæ•´çš„ç»“æœé›†</span>    MYSQL_RES <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token function">mysql_store_result</span><span class="token punctuation">(</span>mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è¿”å›ç»“æœé›†ä¸­çš„åˆ—æ•°</span>    <span class="token keyword">int</span> num_fields <span class="token operator">=</span> <span class="token function">mysql_num_fields</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è¿”å›æ‰€æœ‰å­—æ®µç»“æ„çš„æ•°ç»„</span>    MYSQL_FIELD <span class="token operator">*</span>fields <span class="token operator">=</span> <span class="token function">mysql_fetch_fields</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ä»ç»“æœé›†ä¸­è·å–ä¸‹ä¸€è¡Œï¼Œå°†å¯¹åº”çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå­˜å…¥mapä¸­</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>MYSQL_ROW row <span class="token operator">=</span> <span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        string <span class="token function">temp1</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        string <span class="token function">temp2</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m_users<span class="token punctuation">[</span>temp1<span class="token punctuation">]</span> <span class="token operator">=</span> temp2<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="read-once-å‡½æ•°"><a href="#read-once-å‡½æ•°" class="headerlink" title="read_once()å‡½æ•°"></a>read_once()å‡½æ•°</h3><p>åœ¨WebServerä¸­çš„<code>deal_with_thread()</code>ç»™è°ƒç”¨ï¼Œç”¨äºepollæ£€æµ‹åˆ°è¿æ¥æœ‰æ–°çš„è¯·æ±‚è¿›æ¥æ—¶ï¼Œæä¾›proactoræ¨¡å¼è¯»å–è¯·æ±‚</p><p>read_once()å‡½æ•°ä¸­åˆæä¾›äº†ETå’ŒLTè¯»å–ï¼Œåœ¨ETè¯»å–ç”¨çš„æ˜¯ä¸ªwhile</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//å¾ªç¯è¯»å–å®¢æˆ·æ•°æ®ï¼Œç›´åˆ°æ— æ•°æ®å¯è¯»æˆ–å¯¹æ–¹å…³é—­è¿æ¥</span><span class="token comment">//åœ¨éé˜»å¡ETå·¥ä½œæ¨¡å¼ä¸‹ï¼Œéœ€è¦ä¸€æ¬¡æ€§å°†æ•°æ®è¯»å®Œ</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_read_idx<span class="token operator">>=</span>READ_BUFFER_SIZE<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> bytes_read<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//*LTè¯»å–æ•°æ®</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>m_TRIGMode<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//recvæ˜¯æ¥æ”¶æ•°æ®å‡½æ•°ï¼Œè¿”å›çš„æ˜¯å®é™…copyåˆ°ç¼“å†²åŒºçš„æ•°æ®å­—èŠ‚æ•°</span>        bytes_read<span class="token operator">=</span><span class="token function">recv</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span>m_read_buf<span class="token operator">+</span>m_read_idx<span class="token punctuation">,</span>READ_BUFFER_SIZE<span class="token operator">-</span>m_read_idx<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m_read_idx<span class="token operator">+=</span>bytes_read<span class="token punctuation">;</span>        <span class="token comment">//error</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_read<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>    <span class="token comment">//*ETè¯»å–æ•°æ®ï¼Œéœ€è¦ä¸€æ¬¡æ€§å°†æ•°æ®è¯»å®Œï¼Œæ‰€ä»¥æœ‰ä¸ªwhile</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            bytes_read<span class="token operator">=</span><span class="token function">recv</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span>m_read_buf<span class="token operator">+</span>m_read_idx<span class="token punctuation">,</span>READ_BUFFER_SIZE<span class="token operator">-</span>m_read_idx<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">//error</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_read<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token comment">//ä¸‹é¢ä¸¤ä¸ªé”™è¯¯ç åœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸‹æ˜¯æŒ‡åŒä¸€ä¸ªä¸œè¥¿ï¼ŒæŒ‡åœ¨éé˜»å¡å¯¹è±¡ä¸‹æ‰§è¡Œäº†ä¸€ä¸ªé˜»å¡æ“ä½œ</span>                <span class="token comment">//è¯¦ç»†å¯è§ä¸‹é¢ç½‘å€ï¼š</span>                <span class="token comment">//https://www.dyxmq.cn/program/code/c-cpp/how-to-handle-eagin-and-ewouldblock-error-in-linux-c.html</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>errno<span class="token operator">==</span>EAGAIN<span class="token operator">||</span>errno<span class="token operator">==</span>EWOULDBLOCK<span class="token punctuation">)</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_read<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                        m_read_idx<span class="token operator">+=</span>bytes_read<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token comment">//end while</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="warning-å¤„ç†httpæŠ¥æ–‡è¯·æ±‚ä¸æŠ¥æ–‡å“åº”â€”-gt-process"><a href="#warning-å¤„ç†httpæŠ¥æ–‡è¯·æ±‚ä¸æŠ¥æ–‡å“åº”â€”-gt-process" class="headerlink" title=":warning:å¤„ç†httpæŠ¥æ–‡è¯·æ±‚ä¸æŠ¥æ–‡å“åº”â€”&gt;process()"></a>:warning:å¤„ç†httpæŠ¥æ–‡è¯·æ±‚ä¸æŠ¥æ–‡å“åº”â€”&gt;process()</h3><p>è¿™ä¸ªå‡½æ•°æ˜¯å¯¹<strong>æŠ¥æ–‡è¯»å–</strong>ä»¥åŠ<strong>æŠ¥æ–‡å“åº”</strong>ä¸¤ä¸ªå¤§åŠŸèƒ½ï¼ŒåŒæ—¶ä¹Ÿæ˜¯<strong>çº¿ç¨‹æ± ä¸­è¦ç»™è°ƒç”¨çš„process()<strong>ï¼Œè¿™é‡Œåœ¨è¯»å–è¯·æ±‚æŠ¥æ–‡åä¼šå°†socketåœ¨epollä¸­çš„äº‹ä»¶ä¿®æ”¹æˆ</strong>EPOLLOUT</strong>äº‹ä»¶ä»¥ä¾¿ä¸‹æ¬¡WebServerä¸»å¾ªç¯ä¸­å‘é€æŠ¥æ–‡</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//å­çº¿ç¨‹ä»ä»»åŠ¡é˜Ÿåˆ—æŠ½å‡ºä»»åŠ¡è¿›è¡Œå¤„ç†çš„å‡½æ•°</span><span class="token comment">//ä»è€Œå®ŒæˆæŠ¥æ–‡è§£æå·¥ä½œå’ŒæŠ¥æ–‡å“åº”</span><span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    HTTP_CODE read_ret<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span><span class="token function">process_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä»ç¼“å†²åŒºè¯»å–æŠ¥æ–‡ï¼Œè§£æ</span>    <span class="token comment">//NO_REQUESTï¼Œè¡¨ç¤ºè¯·æ±‚æŠ¥æ–‡ä¸å®Œæ•´ï¼Œéœ€è¦ç»§ç»­æ¥æ”¶è¯·æ±‚æ•°æ®</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>read_ret<span class="token operator">==</span>HTTP_CODE<span class="token operator">::</span>NO_REQUEST<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//æ³¨å†Œå¹¶ç›‘å¬è¯»äº‹ä»¶</span>        <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_sockfd<span class="token punctuation">,</span>EPOLLIN<span class="token punctuation">,</span>m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//è°ƒç”¨process_writeå®ŒæˆæŠ¥æ–‡çš„å“åº”å·¥ä½œ</span>    <span class="token keyword">bool</span> write_ret<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span><span class="token function">process_write</span><span class="token punctuation">(</span>read_ret<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>write_ret<span class="token punctuation">)</span>        <span class="token function">close_conn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ³¨å†Œå¹¶ç›‘å¬å†™äº‹ä»¶</span>    <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_sockfd<span class="token punctuation">,</span>EPOLLOUT<span class="token punctuation">,</span>m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¸»çŠ¶æ€æœºâ€”process-read-ä»¥åŠè§£æå¤´éƒ¨ã€è§£æè¯·æ±‚è¡Œã€è§£ææ¶ˆæ¯ä½“"><a href="#ä¸»çŠ¶æ€æœºâ€”process-read-ä»¥åŠè§£æå¤´éƒ¨ã€è§£æè¯·æ±‚è¡Œã€è§£ææ¶ˆæ¯ä½“" class="headerlink" title="ä¸»çŠ¶æ€æœºâ€”process_read()ä»¥åŠè§£æå¤´éƒ¨ã€è§£æè¯·æ±‚è¡Œã€è§£ææ¶ˆæ¯ä½“"></a>ä¸»çŠ¶æ€æœºâ€”process_read()ä»¥åŠè§£æå¤´éƒ¨ã€è§£æè¯·æ±‚è¡Œã€è§£ææ¶ˆæ¯ä½“</h3><p>åœ¨ä¸»çŠ¶æ€æœºä¸­ï¼Œæ¯æ¬¡whileå¾ªç¯éƒ½ä¼šå…ˆè°ƒç”¨ä»çŠ¶æ€æœºè¯»å–å¹¶è§£æ<code>parse_line()</code>å½“å‰ä¸€è¡Œçš„æ•°æ®ï¼Œä»è§£æçš„ç»“æœ<code>CHECK_STATE</code>åˆ¤æ–­æ˜¯<strong>è¯·æ±‚å¤´</strong>ã€<strong>è¯·æ±‚è¡Œ</strong>å’Œ<strong>è¯·æ±‚æ¶ˆæ¯ä½“</strong>ä¸‰ä¸ªä¸­çš„å“ªä¸€ä¸ªï¼Œå†è¿›è¡Œè¿›ä¸€æ­¥è§£æã€‚ç›´åˆ°é‡åˆ°ä¸€ä¸ªç©ºè¡Œï¼Œè¡¨æ˜å¾—åˆ°äº†ä¸€ä¸ªæ­£ç¡®çš„httpè¯·æ±‚ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//æœ‰é™çŠ¶æ€æœºå¤„ç†è¯·æ±‚æŠ¥æ–‡</span>http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">process_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//åˆå§‹åŒ–ä»çŠ¶æ€æœºçŠ¶æ€ï¼ŒHTTPè¯·æ±‚è§£æç»“æœ</span>    LINE_STATUS line_statue<span class="token operator">=</span>LINE_STATUS<span class="token operator">::</span>LINE_OK<span class="token punctuation">;</span>    HTTP_CODE ret<span class="token operator">=</span>HTTP_CODE<span class="token operator">::</span>NO_REQUEST<span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> text<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>    <span class="token comment">//?è¿™é‡Œçš„ä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™ï¼Œå…·ä½“åœ¨ä¸»çŠ¶æ€æœºé€»è¾‘ä¸­ä¼šè®²åˆ°</span>    <span class="token comment">//parse_lineä¸ºä»çŠ¶æ€æœºçš„å…·ä½“å®ç°</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m_check_state<span class="token operator">==</span>CHECK_STATE<span class="token operator">::</span>CONTENT<span class="token operator">&amp;&amp;</span>line_statue<span class="token operator">==</span>LINE_STATUS<span class="token operator">::</span>LINE_OK<span class="token punctuation">)</span><span class="token operator">||</span>            <span class="token punctuation">(</span>line_statue<span class="token operator">=</span><span class="token function">parse_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span>LINE_STATUS<span class="token operator">::</span>LINE_OK<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"get line is ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        text<span class="token operator">=</span><span class="token keyword">this</span><span class="token operator">-></span><span class="token function">get_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//m_start_lineæ˜¯æ¯ä¸€ä¸ªæ•°æ®è¡Œåœ¨m_read_bufä¸­çš„èµ·å§‹ä½ç½®</span>        <span class="token comment">//m_checked_idxè¡¨ç¤ºä»çŠ¶æ€æœºåœ¨m_read_bufä¸­çš„è¯»å–ä½ç½®</span>        m_start_line<span class="token operator">=</span>m_checked_idx<span class="token punctuation">;</span>        <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¾“å‡ºè°ƒè¯•ä¿¡æ¯</span>        <span class="token comment">//ä¸»çŠ¶æ€æœºä¸‰ç§çŠ¶æ€è½¬ç§»é€»è¾‘å®ç°</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>m_check_state<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">case</span> CHECK_STATE<span class="token operator">::</span>REQUESTLINE<span class="token operator">:</span>            <span class="token comment">//è§£æè¯·æ±‚è¡Œ</span>            ret<span class="token operator">=</span><span class="token function">parse_request_line</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span>HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">)</span>                <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>            <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"parse_request_line is ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> CHECK_STATE<span class="token operator">::</span>HEADER<span class="token operator">:</span>            <span class="token comment">//è§£æè¯·æ±‚å¤´</span>            ret<span class="token operator">=</span><span class="token function">parse_headers</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span>HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">)</span>                <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span>HTTP_CODE<span class="token operator">::</span>GET_REQUEST<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token comment">//å®Œæ•´çš„è§£æGETè¯·æ±‚åï¼Œè·³è½¬åˆ°æŠ¥æ–‡å“åº”å‡½æ•°</span>                <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"parse_headers is ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token function">do_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> CHECK_STATE<span class="token operator">::</span>CONTENT<span class="token operator">:</span>            <span class="token comment">//è§£ææ¶ˆæ¯ä½“</span>            ret<span class="token operator">=</span><span class="token function">parse_content</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å®Œæ•´è§£æPOSTè¯·æ±‚åï¼Œè·³è½¬åˆ°æŠ¥æ–‡å“åº”å‡½æ•°</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span>HTTP_CODE<span class="token operator">::</span>GET_REQUEST<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"parse_content is ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token function">do_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//è§£æå®Œæ¶ˆæ¯ä½“å³å®ŒæˆæŠ¥æ–‡è§£æï¼Œé¿å…å†æ¬¡è¿›å…¥å¾ªç¯ï¼Œæ›´æ–°line_status</span>            line_statue<span class="token operator">=</span>LINE_STATUS<span class="token operator">::</span>LINE_OPEN<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">default</span><span class="token operator">:</span>            <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>INTERNAL_ERROR<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token comment">//end switch</span>    <span class="token punctuation">&#125;</span><span class="token comment">//end while</span>    <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>NO_REQUEST<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è§£æhttpè¯·æ±‚è¡Œï¼Œè·å¾—è¯·æ±‚æ–¹æ³•ã€ç›®æ ‡urlã€ä»¥åŠhttpç‰ˆæœ¬å·ç­‰</span>http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">parse_request_line</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> text<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//åœ¨httpæŠ¥æ–‡ä¸­ï¼Œè¯·æ±‚è¡Œç”¨æ¥è¯´æ˜è¯·æ±‚ç±»å‹ã€è¦è®¿é—®çš„èµ„æºä»¥åŠæ‰€ä½¿ç”¨çš„httpç‰ˆæœ¬</span>    <span class="token comment">//å…¶ä¸­å„ä¸ªéƒ¨åˆ†ä¹‹é—´é€šè¿‡\tæˆ–ç©ºæ ¼æ¥åˆ†éš”</span>        <span class="token comment">//   ä¸ºäº†æ–¹ä¾¿ä»¥åçš„é˜…è¯»äº†è§£è¿ä½œåŸç†ï¼Œè¿™é‡Œä¸¾ä¸€ä¸ªè¯·æ±‚è¡Œç”¨ä¾‹</span>    <span class="token comment">//   GET /562f25980001b1b106000338.jpg HTTP/1.1</span>    <span class="token comment">//è¯·æ±‚è¡Œä¸­æœ€å…ˆå«æœ‰ç©ºæ ¼å’Œ\tä»»æ„ä¸€ä¸ªå­—ç¬¦çš„ä½ç½®å¹¶è¿”å›</span>    <span class="token comment">//*strpbrk -> ä¾æ¬¡æ£€éªŒå­—ç¬¦ä¸² str1 ä¸­çš„å­—ç¬¦ï¼Œå½“è¢«æ£€éªŒå­—ç¬¦åœ¨å­—ç¬¦ä¸² str2 ä¸­ä¹ŸåŒ…å«æ—¶ï¼Œåˆ™åœæ­¢æ£€éªŒï¼Œå¹¶è¿”å›è¯¥å­—ç¬¦ä½ç½®</span>    m_url<span class="token operator">=</span><span class="token function">strpbrk</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span><span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¦‚æœæ²¡æœ‰ç©ºæ ¼æˆ–\tï¼Œåˆ™æŠ¥æ–‡æ ¼å¼æœ‰è¯¯</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_url<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å°†è¯¥ä½ç½®æ”¹ä¸º\0ï¼Œç”¨äºå°†å‰é¢çš„æ•°æ®å–å‡º</span>    <span class="token operator">*</span>m_url<span class="token operator">++</span> <span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>    <span class="token comment">//å–å‡ºæ•°æ®ï¼Œå¹¶é€šè¿‡ä¸GETå’ŒPOSTæ¯”è¾ƒåˆ¤æ–­æ˜¯å“ªç§è¯·æ±‚ç±»å‹</span>    <span class="token keyword">char</span><span class="token operator">*</span> method<span class="token operator">=</span>text<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span><span class="token string">"GET"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>        m_method<span class="token operator">=</span>METHOD<span class="token operator">::</span>GET<span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span><span class="token string">"POST"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        m_method<span class="token operator">=</span>METHOD<span class="token operator">::</span>POST<span class="token punctuation">;</span>        cgi<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token comment">//é”™è¯¯æƒ…å†µ</span>        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>        <span class="token comment">//m_urlæ­¤æ—¶è·³è¿‡äº†ç¬¬ä¸€ä¸ªç©ºæ ¼æˆ–\tå­—ç¬¦ï¼Œä½†ä¸çŸ¥é“ä¹‹åæ˜¯å¦è¿˜æœ‰</span>    <span class="token comment">//å°†m_urlå‘ååç§»ï¼Œé€šè¿‡æŸ¥æ‰¾ä»¥ç»§ç»­è·³è¿‡ç©ºæ ¼æˆ–\tå­—ç¬¦ï¼Œä»è€ŒæŒ‡å‘è¯·æ±‚èµ„æºçš„ç¬¬ä¸€ä¸ªå­—ç¬¦</span>    <span class="token comment">//*strcspn -> æ£€ç´¢å­—ç¬¦ä¸² str1 ä¸­ç¬¬ä¸€ä¸ªä¸åœ¨å­—ç¬¦ä¸² str2 ä¸­å‡ºç°çš„å­—ç¬¦ä¸‹æ ‡</span>    m_url<span class="token operator">+=</span><span class="token function">strspn</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ä½¿ç”¨ä¸åˆ¤æ–­è¯·æ±‚æ–¹å¼ç›¸åŒçš„é€»è¾‘ï¼Œåˆ¤æ–­httpç‰ˆæœ¬å·</span>    m_version<span class="token operator">=</span><span class="token function">strpbrk</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_version<span class="token punctuation">)</span>        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>    <span class="token operator">*</span>m_version<span class="token operator">++</span> <span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>    m_version<span class="token operator">+=</span><span class="token function">strspn</span><span class="token punctuation">(</span>m_version<span class="token punctuation">,</span><span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ä»…æ”¯æŒHTTP/1.1</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>m_version<span class="token punctuation">,</span><span class="token string">"HTTP/1.1"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>    <span class="token comment">//å¯¹è¯·æ±‚èµ„æºå‰7ä¸ªå­—ç¬¦è¿›è¡Œåˆ¤æ–­</span>    <span class="token comment">//è¿™é‡Œåªè¦æ˜¯æœ‰äº›æŠ¥æ–‡çš„è¯·æ±‚èµ„æºä¸­ä¼šå¸¦æœ‰"http://"ï¼Œè¿™é‡Œéœ€è¦å¯¹è¿™ç§æƒ…å†µå•ç‹¬å¤„ç†</span>    <span class="token comment">//*strchr -> åœ¨å‚æ•° str æ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²ä¸­æœç´¢ç¬¬ä¸€æ¬¡å‡ºç°å­—ç¬¦ cï¼ˆä¸€ä¸ªæ— ç¬¦å·å­—ç¬¦ï¼‰çš„ä½ç½®ã€‚</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">"http://"</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        m_url<span class="token operator">+=</span><span class="token number">7</span><span class="token punctuation">;</span>        m_url<span class="token operator">=</span><span class="token function">strchr</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//åŒæ ·å¢åŠ httpsæƒ…å†µ</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">"https://"</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        m_url<span class="token operator">+=</span><span class="token number">8</span><span class="token punctuation">;</span>        m_url<span class="token operator">=</span><span class="token function">strchr</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//ä¸€èˆ¬çš„ä¸ä¼šå¸¦æœ‰ä¸Šè¿°ä¸¤ç§ç¬¦å·ï¼Œç›´æ¥æ˜¯å•ç‹¬çš„/æˆ–/åé¢å¸¦è®¿é—®èµ„æº</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>m_url<span class="token operator">||</span>m_url<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'/'</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>    <span class="token comment">//å½“urlä¸º/æ—¶ï¼Œæ˜¾ç¤ºæ¬¢è¿ç•Œé¢</span>    <span class="token comment">//*strcat -> æŠŠ src æ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²è¿½åŠ åˆ° dest æ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²çš„ç»“å°¾</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token function">strcat</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">"judge.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è¯·æ±‚è¡Œå¤„ç†å®Œæ¯•åï¼Œå°†ä¸»æœºçŠ¶æ€è½¬ç§»å¤„ç†è¯·æ±‚å¤´</span>    m_check_state<span class="token operator">=</span>CHECK_STATE<span class="token operator">::</span>HEADER<span class="token punctuation">;</span>    <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>NO_REQUEST<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è§£æhttpè¯·æ±‚çš„ä¸€ä¸ªå¤´éƒ¨ä¿¡æ¯</span>http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">parse_headers</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//åˆ¤æ–­æ˜¯ç©ºè¡Œè¿˜æ˜¯è¯·æ±‚å¤´</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\0'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">//åˆ¤æ–­æ˜¯GETè¿˜æ˜¯POSTè¯·æ±‚</span>        <span class="token comment">//!0 is POST</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_content_length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token comment">//POSTéœ€è¦è·³è½¬åˆ°æ¶ˆæ¯ä½“å¤„ç†çŠ¶æ€</span>            m_check_state <span class="token operator">=</span> CHECK_STATE_CONTENT<span class="token punctuation">;</span>            <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//==0 is GET</span>        <span class="token keyword">return</span> GET_REQUEST<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//è§£æè¯·æ±‚å¤´éƒ¨connectionå­—æ®µ</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"Connection:"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        text <span class="token operator">+=</span> <span class="token number">11</span><span class="token punctuation">;</span>        <span class="token comment">//è·³è¿‡ç©ºæ ¼å’Œ\tå­—ç¬¦</span>        text <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"keep-alive"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token comment">//å¦‚æœæ˜¯é•¿è¿æ¥ï¼Œåˆ™å°†lingeræ ‡å¿—è®¾ç½®ä¸ºtrue</span>            m_linger <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//è§£æè¯·æ±‚å¤´éƒ¨Content-lengthå­—æ®µ</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"Content-length:"</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        text <span class="token operator">+=</span> <span class="token number">15</span><span class="token punctuation">;</span>        text <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m_content_length <span class="token operator">=</span> <span class="token function">atol</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//è§£æè¯·æ±‚å¤´éƒ¨Hostå­—æ®µ</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"Host:"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        text <span class="token operator">+=</span> <span class="token number">5</span><span class="token punctuation">;</span>        text <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m_host <span class="token operator">=</span> text<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>        <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"oop!unknow header: %s"</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è§£ææ¶ˆæ¯ä½“</span>http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">parse_content</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> text<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//åˆ¤æ–­bufferä¸­æ˜¯å¦è¯»å–äº†æ¶ˆæ¯ä½“</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>m_read_idx<span class="token operator">>=</span><span class="token punctuation">(</span>m_content_length<span class="token operator">+</span>m_checked_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        text<span class="token punctuation">[</span>m_content_length<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>        <span class="token comment">//POSTè¯·æ±‚ä¸­æœ€åä¸ºè¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç </span>        m_string<span class="token operator">=</span>text<span class="token punctuation">;</span>        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>GET_REQUEST<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>NO_REQUEST<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä»çŠ¶æ€æœºâ€”parse-line"><a href="#ä»çŠ¶æ€æœºâ€”parse-line" class="headerlink" title="ä»çŠ¶æ€æœºâ€”parse_line()"></a>ä»çŠ¶æ€æœºâ€”parse_line()</h3><p>ä»çŠ¶æ€æœºç”¨äºåˆ†ææŠ¥æ–‡ä¸­ä¸€è¡Œçš„å†…å®¹</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//ä»çŠ¶æ€æœºï¼Œç”¨äºåˆ†æå‡ºä¸€è¡Œå†…å®¹</span><span class="token comment">//è¿”å›å€¼ä¸ºè¡Œçš„è¯»å–çŠ¶æ€ï¼Œæœ‰LINE_OK,LINE_BAD,LINE_OPEN</span>http_conn<span class="token operator">::</span>LINE_STATUS http_conn<span class="token operator">::</span><span class="token function">parse_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> temp<span class="token punctuation">;</span>    <span class="token comment">//m_read_idxæŒ‡å‘ç¼“å†²åŒºm_read_bufçš„æ•°æ®æœ«å°¾çš„ä¸‹ä¸€ä¸ªå­—èŠ‚</span>    <span class="token comment">//m_checked_idxæŒ‡å‘ä»çŠ¶æ€æœºå½“å‰æ­£åœ¨åˆ†æçš„å­—èŠ‚</span>    <span class="token comment">//!æŠ¥æ–‡ä»¥'\r\n'ç»“å°¾çš„ï¼Œè¿™é‡Œæ˜¯è¦åˆ¤æ–­è¯¥æ•°æ®è¡Œæ˜¯å¦å®Œæ•´çŠ¶æ€</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>m_checked_idx<span class="token operator">&lt;</span>m_read_idx<span class="token punctuation">;</span><span class="token operator">++</span>m_checked_idx<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        temp<span class="token operator">=</span>m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//å½“å‰è¦åˆ†æçš„å­—èŠ‚</span>                <span class="token comment">//å¦‚æœä¸º'\r'å­—ç¬¦ï¼Œåˆ™å¯èƒ½è¯»åˆ°å®Œæ•´è¡Œ</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">==</span><span class="token string">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//ä¸‹ä¸€ä¸ªå­—ç¬¦åˆ°è¾¾äº†bufferç»“å°¾ï¼Œåˆ™æ¥æ”¶ä¸å®Œæ•´</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m_checked_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span>m_read_idx<span class="token punctuation">)</span>                <span class="token keyword">return</span> LINE_STATUS<span class="token operator">::</span>LINE_OPEN<span class="token punctuation">;</span>            <span class="token comment">//ä¸‹ä¸€ä¸ªå­—ç¬¦ä¸º\nåˆ™å°†\r\næ”¹ä¸º\0\0</span>            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>                m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> LINE_STATUS<span class="token operator">::</span>LINE_OK<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">return</span> LINE_STATUS<span class="token operator">::</span>LINE_BAD<span class="token punctuation">;</span><span class="token comment">//éƒ½ä¸ç¬¦åˆåˆ™è¿”å›è¯­æ³•é”™è¯¯</span>            <span class="token comment">//å¦‚æœæ˜¯\nä¹Ÿå¯èƒ½è¯»å–å¾—åˆ°å®Œæ•´è¡Œ</span>            <span class="token comment">//ä¸€èˆ¬ä¼šå‡ºç°ä¸Šä¸€æ¬¡è¯»å–åˆ°äº†\rå°±åˆ°äº†bufæœ«å°¾äº†ï¼Œè¿™ç§æ˜¯æ²¡æœ‰æ¥æ”¶å®Œæ•´çš„æƒ…å†µ</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">==</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//å‰ä¸€ä¸ªå­—ç¬¦æ˜¯\råˆ™æ¥æ”¶å®Œæ•´</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>m_checked_idx<span class="token operator">></span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>                m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> LINE_STATUS<span class="token operator">::</span>LINE_OK<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">return</span> LINE_STATUS<span class="token operator">::</span>LINE_BAD<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//end for</span>    <span class="token comment">//æ²¡æœ‰æ‰¾åˆ°\r\nä»£è¡¨æ¥æ”¶ä¸å®Œæ•´ï¼Œè¦ç»§ç»­æ¥æ”¶</span>    <span class="token keyword">return</span> LINE_STATUS<span class="token operator">::</span>LINE_OPEN<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="do-request-å‡½æ•°"><a href="#do-request-å‡½æ•°" class="headerlink" title="do_request()å‡½æ•°"></a>do_request()å‡½æ•°</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">do_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//å°†åˆå§‹åŒ–çš„m_real_fileèµ‹å€¼ä¸ºç½‘ç«™æ ¹ç›®å½•</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span>doc_root<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token operator">=</span><span class="token function">strlen</span><span class="token punctuation">(</span>doc_root<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"m_url:%s\n"</span><span class="token punctuation">,</span> m_url<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//æ‰¾åˆ°m_urlä¸­/çš„ä½ç½®</span>    <span class="token comment">//* strrchr -> åœ¨å‚æ•° str æ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²ä¸­æœç´¢æœ€åä¸€æ¬¡å‡ºç°å­—ç¬¦ cï¼ˆä¸€ä¸ªæ— ç¬¦å·å­—ç¬¦ï¼‰çš„ä½ç½®</span>    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> p<span class="token operator">=</span><span class="token function">strrchr</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å¤„ç†cgi</span>    <span class="token comment">//å®ç°ç™»å½•å’Œæ³¨å†Œæ ¡éªŒï¼ˆåœ¨POSTè¯·æ±‚æŠ¥æ–‡ä¸­ï¼Œè¿™é‡Œå®šä¹‰/2ä¸ºç™»å½•ï¼Œ/3ä¸ºæ³¨å†Œï¼‰</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cgi<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'2'</span><span class="token operator">||</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//æ ¹æ®æ ‡å¿—åˆ¤æ–­æ˜¯ç™»å½•æ£€æµ‹è¿˜æ˜¯æ³¨å†Œæ£€æµ‹</span>        <span class="token keyword">char</span> flag<span class="token operator">=</span>m_url<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"the flag is:%c\n"</span><span class="token punctuation">,</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span><span class="token operator">*</span> m_url_real<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strcat</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span>m_url<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url_real<span class="token punctuation">,</span>FILENAME_LEN<span class="token operator">-</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">delete</span> m_url_real<span class="token punctuation">;</span>        <span class="token comment">//å°†ç”¨æˆ·åå’Œå¯†ç æå–å‡ºæ¥</span>        <span class="token comment">//user=123&amp;&amp;passwd=123</span>        <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span>password<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> i<span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'&amp;'</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>            name<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span>m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        name<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">;</span>m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">,</span><span class="token operator">++</span>j<span class="token punctuation">)</span>            password<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span>m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        password<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//æ³¨å†Œ</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ç”¨æˆ·æ‰“å¼€æ³¨å†Œç•Œé¢\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å¦‚æœæ˜¯æ³¨å†Œï¼Œå…ˆæ£€æµ‹æ•°æ®åº“ä¸­æ˜¯å¦æœ‰é‡åçš„</span>            <span class="token comment">//æ²¡æœ‰é‡åçš„ï¼Œè¿›è¡Œå¢åŠ æ•°æ®</span>            <span class="token keyword">char</span> <span class="token operator">*</span>sql_insert <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"INSERT INTO user(username, passwd) VALUES("</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"', '"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//æ²¡æœ‰é‡åçš„ï¼Œåˆ™åŠ è¿›</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>m_users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">==</span>m_users<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                m_lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token function">mysql_query</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span>sql_insert<span class="token punctuation">)</span><span class="token punctuation">;</span>                m_users<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>std<span class="token operator">::</span>pair<span class="token operator">&lt;</span>string<span class="token punctuation">,</span>string<span class="token operator">></span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                m_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span>                    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">"/log.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">else</span>                    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/registerError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token comment">//æœ‰é‡å</span>            <span class="token keyword">else</span>                <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">"/registerError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token comment">//å¦‚æœæ˜¯ç™»å½•ï¼Œç›´æ¥åˆ¤æ–­</span>        <span class="token comment">//è‹¥æµè§ˆå™¨ç«¯è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç è¡¨å¯ä»¥æŸ¥æ‰¾åˆ°ï¼Œè¿”å›1ï¼Œå¦åˆ™è¿”å›0</span>        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>m_users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">!=</span>m_users<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>m_users<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token operator">==</span>password<span class="token punctuation">)</span>                <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">"/welcome.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span>                <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span><span class="token string">"/logError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//åŒæ­¥çº¿ç¨‹ç™»å½•æ ¡éªŒ</span>        <span class="token comment">//CGIå¤šè¿›ç¨‹ç™»å½•æ ¡éªŒ</span>    <span class="token punctuation">&#125;</span><span class="token comment">//end ç™»å½•æ³¨å†Œæ ¡éªŒ</span>    <span class="token comment">//å¦‚æœè¯·æ±‚èµ„æºä¸º/0ï¼Œè¡¨ç¤ºè·³è½¬æ³¨å†Œç•Œé¢</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">char</span><span class="token operator">*</span> m_url_real<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span><span class="token string">"/register.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å°†ç½‘ç«™ç›®å½•å’Œ/register.htmlè¿›è¡Œæ‹¼æ¥ï¼Œæ›´æ–°åˆ°m_real_fileä¸­</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url_real<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">delete</span> m_url_real<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//å¦‚æœè¯·æ±‚èµ„æºä¸º/1ï¼Œè¡¨ç¤ºè·³è½¬ç™»å½•ç•Œé¢</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">char</span><span class="token operator">*</span> m_url_real<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span><span class="token string">"/log.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å°†ç½‘ç«™ç›®å½•å’Œlog.htmlè¿›è¡Œæ‹¼æ¥ï¼Œæ›´æ–°åˆ°m_real_fileä¸­</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url_real<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">delete</span> m_url_real<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//å¦‚æœè¯·æ±‚èµ„æºä¸º/5ï¼Œè¡¨ç¤ºè·³è½¬åˆ°å›¾ç‰‡è¯·æ±‚ç•Œé¢</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'5'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">char</span><span class="token operator">*</span> m_url_real<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span><span class="token string">"/picture.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url_real<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">delete</span> m_url_real<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//å¦‚æœè¯·æ±‚èµ„æº/6ï¼Œè¡¨ç¤ºè§†é¢‘è¯·æ±‚ç•Œé¢</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'6'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">char</span><span class="token operator">*</span> m_url_real<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span><span class="token string">"/video.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url_real<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">delete</span> m_url_real<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//å¦‚æœè¯·æ±‚èµ„æºä¸º/7ï¼Œè¡¨ç¤ºè·³è½¬å…³æ³¨ç•Œé¢</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'7'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">char</span><span class="token operator">*</span> m_url_real<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span><span class="token string">"/fans.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url_real<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">delete</span> m_url_real<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//å¦‚æœä»¥ä¸Šå‡ä¸ç¬¦åˆï¼Œåˆ™ç›´æ¥å°†urlä¸ç½‘ç«™ç›®å½•æ‹¼æ¥</span>    <span class="token comment">//è¿™é‡Œæƒ…å†µæ˜¯welcomeç•Œé¢ï¼Œè¯·æ±‚æœåŠ¡å™¨ä¸Šçš„ä¸€ä¸ªå›¾ç‰‡</span>    <span class="token keyword">else</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url<span class="token punctuation">,</span>FILENAME_LEN<span class="token operator">-</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//é€šè¿‡statè·å–è¯·æ±‚èµ„æºæ–‡ä»¶ä¿¡æ¯ï¼ŒæˆåŠŸåˆ™å°†ä¿¡æ¯æ›´æ–°åˆ°m_file_statç»“æ„ä½“</span>    <span class="token comment">//å¤±è´¥è¿”å›NO_RESOURCEçŠ¶æ€ï¼Œè¡¨ç¤ºèµ„æºä¸å­˜åœ¨</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span><span class="token operator">&amp;</span>m_file_stat<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>NO_RESOURCE<span class="token punctuation">;</span>    <span class="token comment">//åˆ¤æ–­æ–‡ä»¶æƒé™ï¼Œæ˜¯å¦å¯è¯»ï¼Œä¸å¯è¯»åˆ™è¿”å›FORBIDDEN_REQUESTçŠ¶æ€</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_mode<span class="token operator">&amp;</span>S_IROTH<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>FORBIDDEN_REQUEST<span class="token punctuation">;</span>        <span class="token comment">//åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼Œå¦‚æœæ˜¯ç›®å½•ï¼Œåˆ™è¿”å›BAD_REQUESTï¼Œè¡¨ç¤ºè¯·æ±‚æŠ¥æ–‡æœ‰è¯¯</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">S_ISDIR</span><span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token punctuation">;</span>    <span class="token comment">//ä»¥åªè¯»æ–¹å¼è·å–æ–‡ä»¶æè¿°ç¬¦ï¼Œé€šè¿‡mmapå°†è¯¥æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­</span>    <span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    m_file_address<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span>PROT_READ<span class="token punctuation">,</span>MAP_PRIVATE<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//é¿å…æ–‡ä»¶æè¿°ç¬¦çš„æµªè´¹å’Œå ç”¨</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è¡¨ç¤ºè¯·æ±‚æ–‡ä»¶å­˜åœ¨ï¼Œä¸”å¯ä»¥è®¿é—®</span>    <span class="token keyword">return</span> HTTP_CODE<span class="token operator">::</span>FILE_REQUEST<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å–æ¶ˆmmapæ˜ å°„</span><span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_file_address<span class="token operator">!=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">munmap</span><span class="token punctuation">(</span>m_file_address<span class="token punctuation">,</span>m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è°ƒç”¨ç³»ç»Ÿå‡½æ•°</span>        m_file_address<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ç”Ÿæˆå“åº”æŠ¥æ–‡â€”ç”¨äº†IOå‘é‡æœºåˆ¶"><a href="#ç”Ÿæˆå“åº”æŠ¥æ–‡â€”ç”¨äº†IOå‘é‡æœºåˆ¶" class="headerlink" title="ç”Ÿæˆå“åº”æŠ¥æ–‡â€”ç”¨äº†IOå‘é‡æœºåˆ¶"></a>ç”Ÿæˆå“åº”æŠ¥æ–‡â€”ç”¨äº†IOå‘é‡æœºåˆ¶</h3><p>å‰é¢è§£æå®Œæˆä¸€ä¸ªè¯·æ±‚æŠ¥æ–‡åï¼Œä¼šè°ƒç”¨do_request()å‡½æ•°ï¼Œæ ¹æ®è¯·æ±‚æŠ¥æ–‡çš„è§£æç»“æœï¼Œåˆ¤æ–­è¯·æ±‚èµ„æºæ˜¯å¦å­˜åœ¨ã€è¯·æ±‚åŠ¨ä½œæ˜¯å¦æ­£ç¡®ç­‰ï¼Œå°†ç›¸å…³æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ï¼Œä»¥ä¾¿åç»­ç›´æ¥ä»å†…å­˜ä¸­è¯»å–ï¼Œå¡«å……åˆ°å“åº”æŠ¥æ–‡è¿”å›ç»™æµè§ˆå™¨ï¼Œæµè§ˆå™¨è§£æå“åº”æŠ¥æ–‡åï¼Œå°±ç”Ÿæˆäº†æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ç½‘é¡µç•Œé¢ã€‚<br>è¿™é‡Œä½¿ç”¨äº†IOå‘é‡æœºåˆ¶ï¼ŒIOå‘é‡å³struct iovecï¼Œiovecç»“æ„ä½“ä¸­å¯ä»¥å­˜æ”¾å¤šä¸ªbufferï¼Œä½¿ç”¨å¯¹åº”çš„readvå’Œwritevè¯»å†™æ–‡ä»¶ï¼Œå¯ä»¥æŒ‰é¡ºåºè¯»åˆ°å¤šä¸ªbufferä¸­ï¼Œä»¥åŠå°†å¤šä¸ªbufferçš„å†…å®¹å†™åˆ°æ–‡ä»¶æè¿°ç¬¦ã€‚<br>æ­¤å¤„m_iv[0]æŒ‡å‘m_write_bufï¼ˆå­˜æ”¾å“åº”æŠ¥æ–‡å¤´éƒ¨å†…å®¹ï¼‰ï¼Œm_iv[1]æŒ‡å‘m_file_addressï¼ˆä½¿ç”¨mmapå°†è¯·æ±‚èµ„æºæ˜ å°„åˆ°çš„å†…å­˜ï¼‰ï¼Œç„¶åå¯ä»¥ä½¿ç”¨writevæŒ‰é¡ºåºå°†å…¶å†™åˆ°socketä¸­ã€‚</p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="æ·»åŠ å“åº”æŠ¥æ–‡å‡½æ•°"><a href="#æ·»åŠ å“åº”æŠ¥æ–‡å‡½æ•°" class="headerlink" title="æ·»åŠ å“åº”æŠ¥æ–‡å‡½æ•°"></a>æ·»åŠ å“åº”æŠ¥æ–‡å‡½æ•°</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//æ·»åŠ å“åº”æŠ¥æ–‡çš„å…¬å…±å‡½æ•°</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_response</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//å¦‚æœå†™å…¥å†…å®¹è¶…å‡ºm_write_bufå¤§å°åˆ™æŠ¥é”™</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_write_idx <span class="token operator">>=</span> WRITE_BUFFER_SIZE<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment">//å®šä¹‰å¯å˜å‚æ•°åˆ—è¡¨</span>    va_list arg_list<span class="token punctuation">;</span>    <span class="token comment">//å°†å˜é‡arg_liståˆå§‹åŒ–ä¸ºä¼ å…¥å‚æ•°</span>    <span class="token function">va_start</span><span class="token punctuation">(</span>arg_list<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å°†æ•°æ®formatä»å¯å˜å‚æ•°åˆ—è¡¨å†™å…¥ç¼“å†²åŒºå†™ï¼Œè¿”å›å†™å…¥æ•°æ®çš„é•¿åº¦</span>    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">vsnprintf</span><span class="token punctuation">(</span>m_write_buf <span class="token operator">+</span> m_write_idx<span class="token punctuation">,</span> WRITE_BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> m_write_idx<span class="token punctuation">,</span> format<span class="token punctuation">,</span> arg_list<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¦‚æœå†™å…¥çš„æ•°æ®é•¿åº¦è¶…è¿‡ç¼“å†²åŒºå‰©ä½™ç©ºé—´ï¼Œåˆ™æŠ¥é”™</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">>=</span> <span class="token punctuation">(</span>WRITE_BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> m_write_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">va_end</span><span class="token punctuation">(</span>arg_list<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//æ›´æ–°m_write_idxä½ç½®</span>    m_write_idx <span class="token operator">+=</span> len<span class="token punctuation">;</span>    <span class="token comment">//æ¸…ç©ºå¯å˜å‚åˆ—è¡¨</span>    <span class="token function">va_end</span><span class="token punctuation">(</span>arg_list<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"request:%s"</span><span class="token punctuation">,</span> m_write_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ·»åŠ çŠ¶æ€è¡Œ</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>title<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"%s %d %s\r\n"</span><span class="token punctuation">,</span> <span class="token string">"HTTP/1.1"</span><span class="token punctuation">,</span> status<span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ·»åŠ æ¶ˆæ¯æŠ¥å¤´ï¼Œå…·ä½“çš„æ·»åŠ æ–‡æœ¬é•¿åº¦ã€è¿æ¥çŠ¶æ€å’Œç©ºè¡Œ</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token keyword">int</span> content_len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">add_content_length</span><span class="token punctuation">(</span>content_len<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">add_linger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>           <span class="token function">add_blank_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ·»åŠ Content-Lengthï¼Œè¡¨ç¤ºå“åº”æŠ¥æ–‡çš„é•¿åº¦</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_content_length</span><span class="token punctuation">(</span><span class="token keyword">int</span> content_len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"Content-Length:%d\r\n"</span><span class="token punctuation">,</span> content_len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ·»åŠ æ–‡æœ¬ç±»å‹ï¼Œè¿™é‡Œæ˜¯html</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_content_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"Content-Type:%s\r\n"</span><span class="token punctuation">,</span> <span class="token string">"text/html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ·»åŠ è¿æ¥çŠ¶æ€ï¼Œé€šçŸ¥æµè§ˆå™¨ç«¯æ˜¯ä¿æŒè¿æ¥è¿˜æ˜¯å…³é—­</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_linger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"Connection:%s\r\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>m_linger <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"keep-alive"</span> <span class="token operator">:</span> <span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ·»åŠ ç©ºè¡Œ</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_blank_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ·»åŠ æ–‡æœ¬content</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_content</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>content<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å‘m_write_bufå‡†å¤‡å¥½å“åº”æŠ¥æ–‡</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">process_write</span><span class="token punctuation">(</span>HTTP_CODE ret<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">switch</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//å†…éƒ¨é”™è¯¯ï¼Œ500</span>    <span class="token keyword">case</span> HTTP_CODE<span class="token operator">::</span>INTERNAL_ERROR<span class="token operator">:</span>        <span class="token comment">//çŠ¶æ€è¡Œ</span>        <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span>error_500_title<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//æ¶ˆæ¯æŠ¥å¤´</span>        <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>error_500_form<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>error_500_form<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token comment">//æŠ¥æ–‡è¯­æ³•æœ‰è¯¯ï¼Œ404</span>    <span class="token keyword">case</span> HTTP_CODE<span class="token operator">::</span>BAD_REQUEST<span class="token operator">:</span>        <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span>error_404_title<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>error_404_form<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>error_404_form<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token comment">//èµ„æºæ²¡æœ‰è®¿é—®æƒé™ï¼Œ403</span>    <span class="token keyword">case</span> HTTP_CODE<span class="token operator">::</span>FORBIDDEN_REQUEST<span class="token operator">:</span>        <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span>error_403_title<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>error_403_form<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>error_403_form<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token comment">//æ–‡ä»¶å­˜åœ¨ï¼Œ200</span>    <span class="token keyword">case</span> HTTP_CODE<span class="token operator">::</span>FILE_REQUEST<span class="token operator">:</span>        <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span>ok_200_title<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å¦‚æœè¯·æ±‚çš„èµ„æºå­˜åœ¨</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_size<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">add_headers</span><span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//ç¬¬ä¸€ä¸ªiovecæŒ‡é’ˆæŒ‡å‘å“åº”æŠ¥æ–‡ç¼“å†²åŒºï¼Œé•¿åº¦æŒ‡å‘m_write_idx</span>            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base<span class="token operator">=</span>m_write_buf<span class="token punctuation">;</span>            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token operator">=</span>m_write_idx<span class="token punctuation">;</span>            <span class="token comment">//ç¬¬äºŒä¸ªiovecæŒ‡é’ˆæŒ‡å‘mmapè¿”å›çš„æ–‡ä»¶æŒ‡é’ˆï¼Œé•¿åº¦æŒ‡å‘æ–‡ä»¶çš„å¤§å°</span>            m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base<span class="token operator">=</span>m_file_address<span class="token punctuation">;</span>            m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token operator">=</span>m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>            m_iv_count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>            <span class="token comment">//å‘é€çš„å…¨éƒ¨æ•°æ®ä¸ºå“åº”æŠ¥æ–‡å¤´éƒ¨ä¿¡æ¯å’Œæ–‡ä»¶å¤§å°</span>            bytes_to_send<span class="token operator">=</span>m_write_idx<span class="token operator">+</span>m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token comment">//å¦‚æœè¯·æ±‚èµ„æºå¤§å°ä¸º0ï¼Œåˆ™è¿”å›ç©ºç™½htmlæ–‡ä»¶</span>            <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ok_string<span class="token operator">=</span><span class="token string">"&lt;html>&lt;body>&lt;/body>&lt;/html>"</span><span class="token punctuation">;</span>            <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>ok_string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>ok_string<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token comment">//?return true;</span>        <span class="token punctuation">&#125;</span>    <span class="token keyword">default</span><span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//é™¤äº†FILEâ€”â€”REQUESTçŠ¶æ€å¤–ï¼Œå…¶ä½™çŠ¶æ€åªç”³è¯·ä¸€ä¸ªiovecï¼ŒæŒ‡å‘å“åº”æŠ¥æ–‡ç¼“å†²åŒº</span>    m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base<span class="token operator">=</span>m_write_buf<span class="token punctuation">;</span>    m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token operator">=</span>m_write_idx<span class="token punctuation">;</span>    m_iv_count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    bytes_to_send <span class="token operator">=</span> m_write_idx<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å‘é€å“åº”æŠ¥æ–‡â€”http-conn-write"><a href="#å‘é€å“åº”æŠ¥æ–‡â€”http-conn-write" class="headerlink" title="å‘é€å“åº”æŠ¥æ–‡â€”http_conn::write()"></a>å‘é€å“åº”æŠ¥æ–‡â€”http_conn::write()</h3><p>åœ¨ç”Ÿæˆå“åº”æŠ¥æ–‡åï¼Œepolläº‹ä»¶å°±ä¼šåœ¨çº¿ç¨‹æ± çš„<code>process()</code>æ–¹æ³•æœ€åä¿®æ”¹æˆEPOLLOUTï¼Œéšåä¹Ÿæ˜¯é€šè¿‡WebServerä¸»å¾ªç¯æ£€æµ‹ï¼Œé€šè¿‡<code>deal_with_write()</code>æ¥è°ƒç”¨http_conn::write()è¿›è¡ŒæŠ¥æ–‡å‘é€ï¼Œç”±æ­¤æ•´ä¸ªä¼ è¾“è¿‡ç¨‹å®Œæ¯•</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/** * æœåŠ¡å™¨è°ƒç”¨process_writeå®Œæˆå“åº”æŠ¥æ–‡ï¼Œéšåæ³¨å†Œepolloutäº‹ä»¶ï¼ŒæœåŠ¡å™¨ä¸»çº¿ç¨‹æ£€æµ‹å†™äº‹ä»¶ï¼Œ * åŒæ—¶è°ƒç”¨http_conn::write()å‡½æ•°å°†å“åº”æŠ¥æ–‡å‘é€ç»™æµè§ˆå™¨ç«¯ *  * åœ¨ç”Ÿæˆå“åº”æŠ¥æ–‡æ—¶åˆå§‹åŒ–byte_to_sendï¼ŒåŒ…æ‹¬å¤´éƒ¨ä¿¡æ¯å’Œæ–‡ä»¶æ•°æ®å¤§å°ã€‚ * é€šè¿‡writev()å‡½æ•°å¾ªç¯å‘é€å“åº”æŠ¥æ–‡æ•°æ® * æ ¹æ®è¿”å›å€¼æ›´æ–°byte_have_sendå’Œiovecç»“æ„ä½“çš„æŒ‡é’ˆå’Œé•¿åº¦ï¼Œå¹¶åˆ¤æ–­å“åº”æŠ¥æ–‡æ•´ä½“æ˜¯å¦å‘é€æˆåŠŸ */</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//è‹¥è¦å‘é€çš„æ•°æ®é•¿åº¦ä¸º0ï¼Œè¡¨ç¤ºå“åº”æŠ¥æ–‡ä¸ºç©ºï¼Œä¸€èˆ¬ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µ</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_to_send<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_sockfd<span class="token punctuation">,</span>EPOLLIN<span class="token punctuation">,</span>m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//å°†å“åº”æŠ¥æ–‡çš„çŠ¶æ€è¡Œã€æ¶ˆæ¯å¤´ã€ç©ºè¡Œå’Œå“åº”æ­£æ–‡å‘é€ç»™æµè§ˆå™¨ç«¯</span>        temp<span class="token operator">=</span><span class="token function">writev</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span>m_iv<span class="token punctuation">,</span>m_iv_count<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>errno<span class="token operator">==</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token comment">//åˆ¤æ–­å†™ç¼“å†²åŒºæ˜¯å¦æ»¡äº†</span>                <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_sockfd<span class="token punctuation">,</span>EPOLLOUT<span class="token punctuation">,</span>m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//å¦‚æœä¸æ˜¯ç¼“å†²åŒºé—®é¢˜ï¼Œåˆ™å–æ¶ˆæ˜ å°„ï¼Œæ–­å¼€è¿æ¥</span>            <span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//æ›´æ–°å‘é€å­—èŠ‚çš„é•¿åº¦</span>        bytes_have_send<span class="token operator">+=</span>temp<span class="token punctuation">;</span>        bytes_to_send<span class="token operator">-=</span>temp<span class="token punctuation">;</span>        <span class="token comment">//å¦‚æœç¬¬ä¸€ä¸ªiovecå¤´éƒ¨ä¿¡æ¯å‘é€å®Œæˆï¼Œå‘é€ç¬¬äºŒä¸ªiovecæ•°æ®</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_have_send<span class="token operator">>=</span>m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>            m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base<span class="token operator">=</span>m_file_address<span class="token operator">+</span><span class="token punctuation">(</span>bytes_have_send<span class="token operator">-</span>m_write_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>            m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token operator">=</span>bytes_to_send<span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token comment">//å¦åˆ™ç»§ç»­å‘é€ç¬¬ä¸€ä¸ªiovecå¤´éƒ¨ä¿¡æ¯æ•°æ®</span>            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base<span class="token operator">=</span>m_write_buf<span class="token operator">+</span>bytes_have_send<span class="token punctuation">;</span>            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token operator">=</span>m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token operator">-</span>bytes_have_send<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//å‰©ä½™å‘é€å­—èŠ‚ä¸º0æ—¶ï¼ˆæ•°æ®å…¨éƒ¨å‘é€å®Œæ¯•ï¼‰</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_to_send<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//åœ¨epollæ ‘ä¸Šé‡ç½®EPOLLONESHOTäº‹ä»¶</span>            <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span>m_sockfd<span class="token punctuation">,</span>EPOLLIN<span class="token punctuation">,</span>m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//åˆ¤æ–­æµè§ˆå™¨è¯·æ±‚æ˜¯å¦ä¸ºé•¿è¿æ¥</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>m_linger<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token comment">//é‡æ–°åˆå§‹åŒ–HTTPå¯¹è±¡</span>                <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//?é»˜è®¤è¿”å›false</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="æœ‰å¾…æŸ¥è¯¢çš„é—®é¢˜"><a href="#æœ‰å¾…æŸ¥è¯¢çš„é—®é¢˜" class="headerlink" title="æœ‰å¾…æŸ¥è¯¢çš„é—®é¢˜"></a>æœ‰å¾…æŸ¥è¯¢çš„é—®é¢˜</h1><ol><li>æ¡ä»¶å˜é‡å’Œä¿¡å·é‡çš„åŒºåˆ«ä»¥åŠå„è‡ªçš„ä½¿ç”¨ç¯å¢ƒ</li><li>å¦‚ä½•æ”¹è¿›å¯¹æ•°æ®åº“çš„è´¦æˆ·å’Œå¯†ç åŠ å¯†</li><li>å¦‚æœæ”¶åˆ°èµ„æºè¶…æ—¶ä¿¡å·ï¼Œå…¶å®è¿˜æ˜¯è¦å¾ªç¯å®šæ—¶å™¨é“¾è¡¨ï¼Œæ‰¾åˆ°è¶…æ—¶çš„è¿æ¥åˆ æ‰ï¼Œæœ‰ç‚¹æ¶ˆè€—æ€§èƒ½ï¼Œå¦‚ä½•æ”¹è¿›ï¼Ÿ</li></ol><h1 id="è‡ªå·±çš„é—®é¢˜"><a href="#è‡ªå·±çš„é—®é¢˜" class="headerlink" title="è‡ªå·±çš„é—®é¢˜"></a>è‡ªå·±çš„é—®é¢˜</h1><p>è¿™é‡Œçš„é—®é¢˜æ˜¯è‡ªå·±åœ¨å¤ä¹ è¿‡ç¨‹ä¸­å‘ç°çš„é—®é¢˜ï¼Œè®°å½•ä¸‹æ¥æ–¹ä¾¿è‡ªå·±æ¢³ç†</p><h2 id="è°æŠŠè¯·æ±‚æ”¾å…¥äº†çº¿ç¨‹æ± ä¸­"><a href="#è°æŠŠè¯·æ±‚æ”¾å…¥äº†çº¿ç¨‹æ± ä¸­" class="headerlink" title="è°æŠŠè¯·æ±‚æ”¾å…¥äº†çº¿ç¨‹æ± ä¸­"></a>è°æŠŠè¯·æ±‚æ”¾å…¥äº†çº¿ç¨‹æ± ä¸­</h2><p>åœ¨WebServer.cppä¸­ä¸»å¾ªç¯ä¸­æè¿°äº†ï¼Œå¦‚æœepollæ”¶åˆ°è¯·æ±‚è¯»äº‹ä»¶ï¼Œåˆ™ä¼šè·³è½¬åˆ°<code>deal_with_thread()</code>å‡½æ•°ï¼Œå…¶ä¸­ä¼šåˆ¤æ–­actoræ¨¡å¼è€Œç”¨ä¸åŒçš„æ·»åŠ è¯·æ±‚åˆ°è¯·æ±‚é˜Ÿåˆ—æ–¹å¼ï¼ˆreactorç”¨m_pool-&gt;append()ï¼›proactorç”¨m_pool-&gt;append_p()ï¼‰</p><p><strong>æ³¨æ„ï¼šappendè¿›å»çš„å‚æ•°ç±»å‹æ˜¯http_conn*ç±»å‹</strong></p><h2 id="è°è°ƒç”¨äº†worker"><a href="#è°è°ƒç”¨äº†worker" class="headerlink" title="è°è°ƒç”¨äº†worker()"></a>è°è°ƒç”¨äº†worker()</h2><p>å½“ç„¶æ˜¯åœ¨çº¿ç¨‹æ± åˆå§‹åŒ–æ—¶åˆ›å»ºçš„çº¿ç¨‹å•¦</p><p>è¿™äº›çº¿ç¨‹è¢«åˆ›å»ºåç”¨pthread_detachå®ç°çº¿ç¨‹åˆ†ç¦»ï¼Œåˆ™ä¼šè¿è¡Œ<code>worker()</code>ï¼Œè€Œ<code>worker()</code>é‡Œé¢åˆè°ƒç”¨ç€<code>threadpool&lt;&gt;::run()</code>ï¼Œæ­¤æ—¶å¦‚æœè¯·æ±‚é˜Ÿåˆ—é‡Œé¢æœ‰è¯·æ±‚åˆ™çº¿ç¨‹ä¼šå› ä¸ºä¿¡å·é‡å“åº”ä»è€Œå¤„ç†è¯·æ±‚ï¼Œå¦åˆ™çš„è¯çº¿ç¨‹ä¼šé˜»å¡ç­‰å¾…</p><h2 id="ä¸ºä»€ä¹ˆåˆè¦æœ‰client-dataæ•°ç»„users-timerï¼Œåˆè¦æœ‰http-connæ•°ç»„usersï¼Œå®ƒä»¬å„è‡ªä½œç”¨æ˜¯å•¥"><a href="#ä¸ºä»€ä¹ˆåˆè¦æœ‰client-dataæ•°ç»„users-timerï¼Œåˆè¦æœ‰http-connæ•°ç»„usersï¼Œå®ƒä»¬å„è‡ªä½œç”¨æ˜¯å•¥" class="headerlink" title="ä¸ºä»€ä¹ˆåˆè¦æœ‰client_dataæ•°ç»„users_timerï¼Œåˆè¦æœ‰http_connæ•°ç»„usersï¼Œå®ƒä»¬å„è‡ªä½œç”¨æ˜¯å•¥"></a>ä¸ºä»€ä¹ˆåˆè¦æœ‰client_dataæ•°ç»„users_timerï¼Œåˆè¦æœ‰http_connæ•°ç»„usersï¼Œå®ƒä»¬å„è‡ªä½œç”¨æ˜¯å•¥</h2><p>å…ˆæ¥è§£é‡Šä¸‹è¿™ä¸ªé—®é¢˜ï¼Œå½“æ—¶åœ¨åˆ†æWebServer.cppä»£ç æ—¶å€™å‘ç°æœ‰ä¸¤ä¸ªä¸‹æ ‡éƒ½æ˜¯é€šè¿‡fdæ¥è®¿é—®çš„æ•°ç»„</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_FD<span class="token operator">=</span><span class="token number">65536</span><span class="token punctuation">;</span><span class="token comment">//æœ€å¤§æ–‡ä»¶æè¿°ç¬¦</span>client_data<span class="token operator">*</span> users_timer<span class="token operator">=</span><span class="token keyword">new</span> client_data<span class="token punctuation">[</span>MAX_FD<span class="token punctuation">]</span><span class="token punctuation">;</span>http_conn<span class="token operator">*</span> users<span class="token operator">=</span><span class="token keyword">new</span> http_conn<span class="token punctuation">[</span>MAX_FD<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è€Œé—®é¢˜å°±æ˜¯ä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¸¤ä¸ªä¸œè¥¿ï¼Œæ¢ä¸ªæ„æ€æ˜¯ä»–ä»¬å„è‡ªçš„ä½œç”¨æ˜¯å•¥å‘¢ï¼Ÿ</p><p>é¦–å…ˆå¯¹äºhttp_connæ¥è¯´ï¼Œå®ƒæ˜¯æè¿°æ¯ä¸ªå®¢æˆ·ç«¯fdçš„è¿æ¥å¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡åˆåŒ…æ‹¬å½“å‰å®¢æˆ·ç«¯è¯·æ±‚çŠ¶æ€ï¼ˆå¦‚è¯·æ±‚æŠ¥æ–‡æ•°æ®ï¼Œè¯»è¿˜æ˜¯å†™ç­‰ï¼‰ï¼Œå› æ­¤éœ€è¦å¼€ä¸ªhttp_connç±»å‹çš„æ•°ç»„æ¥å­˜å‚¨å¤šä¸ªè¿æ¥å¯¹è±¡</p><p>å†çœ‹åˆ°client_dataæ•°ç»„ï¼Œå®ƒæœ¬èº«æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//è¿æ¥èµ„æº</span><span class="token keyword">struct</span> <span class="token class-name">client_data</span><span class="token punctuation">&#123;</span>        <span class="token comment">//å®¢æˆ·ç«¯socketåœ°å€</span>    sockaddr_in addreess<span class="token punctuation">;</span>    <span class="token comment">//socketæ–‡ä»¶æè¿°ç¬¦</span>    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>    <span class="token comment">//å®šæ—¶å™¨</span>    util_timer<span class="token operator">*</span> timer<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¯ä¸ªè¿æ¥èµ„æºå¯ä»¥è®°å½•ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ‰€ä»¥è¿™ä¸ªclient_dataæ•°ç»„å°±æ˜¯è®°å½•ç»™è¿æ¥è¿›æ¥çš„å®¢æˆ·ç«¯é™„åŠ ä¸€ä¸ªå®šæ—¶å™¨çš„ä½œç”¨</p><h2 id="æ¥å—åˆ°è¯·æ±‚æ—¶æ€ä¹ˆçŸ¥é“ç”¨æˆ·è®¿é—®ç½‘é¡µçš„å“ªä¸ªç•Œé¢"><a href="#æ¥å—åˆ°è¯·æ±‚æ—¶æ€ä¹ˆçŸ¥é“ç”¨æˆ·è®¿é—®ç½‘é¡µçš„å“ªä¸ªç•Œé¢" class="headerlink" title="æ¥å—åˆ°è¯·æ±‚æ—¶æ€ä¹ˆçŸ¥é“ç”¨æˆ·è®¿é—®ç½‘é¡µçš„å“ªä¸ªç•Œé¢"></a>æ¥å—åˆ°è¯·æ±‚æ—¶æ€ä¹ˆçŸ¥é“ç”¨æˆ·è®¿é—®ç½‘é¡µçš„å“ªä¸ªç•Œé¢</h2><p>åœ¨http_conn.cppä¸­çš„<code>do_request()</code>å°±æœ‰åˆ¤æ–­ï¼Œæ˜¯é€šè¿‡åˆ¤æ–­æµè§ˆå™¨å‘é€è¿‡æ¥çš„æŠ¥æ–‡ä¸­<code>&lt;form action=0&gt;</code>è¿™ä¸ªactionå€¼æ¥ç¡®å®šçš„ï¼Œåœ¨è¿™ä¸ªæœåŠ¡å™¨ä¸­3æ˜¯æ³¨å†Œæ“ä½œï¼Œ2æ˜¯ç™»å½•æ“ä½œã€0æ˜¯æ³¨å†Œç•Œé¢ã€1æ˜¯ç™»å½•ç•Œé¢ã€5ã€6ã€7åˆ†åˆ«æ˜¯å›¾ç‰‡ã€è§†é¢‘ã€å…³æ³¨ç•Œé¢</p><p>ä¸‹é¢æ‹¿æ³¨å†Œç•Œé¢ä¸ºä¾‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//å¦‚æœè¯·æ±‚èµ„æºä¸º/0ï¼Œè¡¨ç¤ºè·³è½¬æ³¨å†Œç•Œé¢</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">char</span><span class="token operator">*</span> m_url_real<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span><span class="token string">"/register.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å°†ç½‘ç«™ç›®å½•å’Œ/register.htmlè¿›è¡Œæ‹¼æ¥ï¼Œæ›´æ–°åˆ°m_real_fileä¸­</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file<span class="token operator">+</span>len<span class="token punctuation">,</span>m_url_real<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">delete</span> m_url_real<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æœåŠ¡å™¨æ˜¯æ€ä¹ˆå°†é™æ€èµ„æºæ–‡ä»¶ä¼ è¾“ç»™å®¢æˆ·ç«¯çš„"><a href="#æœåŠ¡å™¨æ˜¯æ€ä¹ˆå°†é™æ€èµ„æºæ–‡ä»¶ä¼ è¾“ç»™å®¢æˆ·ç«¯çš„" class="headerlink" title="æœåŠ¡å™¨æ˜¯æ€ä¹ˆå°†é™æ€èµ„æºæ–‡ä»¶ä¼ è¾“ç»™å®¢æˆ·ç«¯çš„"></a>æœåŠ¡å™¨æ˜¯æ€ä¹ˆå°†é™æ€èµ„æºæ–‡ä»¶ä¼ è¾“ç»™å®¢æˆ·ç«¯çš„</h2><p>å…¶å®è®¿é—®é™æ€èµ„æºä¹Ÿæ˜¯å’Œä¸Šé¢è®¿é—®ç½‘é¡µé‚£æ ·ï¼Œå¦‚æœè¯†åˆ«çš„æ ‡å¿—actionéƒ½ä¸æ˜¯æœåŠ¡å™¨ä¸­ç»™å®šçš„æ ‡å¿—ï¼Œé‚£å°±æ˜¯è®¿é—®é™æ€èµ„æºè¯·æ±‚ï¼Œä¹Ÿæ˜¯é€šè¿‡ioå‘é‡ç„¶åwritev()ç»™å®¢æˆ·ç«¯å®ç°é™æ€èµ„æºä¼ è¾“</p><p>éœ€è¦æ³¨æ„ï¼šå¿…é¡»å°†é™æ€èµ„æºæ–‡ä»¶å±æ€§ä¸­çš„<code>å…¶å®ƒ</code>è®¾ä¸ºï¼š<code>åªè¯»</code>æˆ–<code>è¯»å†™</code>æƒé™ï¼Œå¦åˆ™å®¢æˆ·ç«¯æ—¶è®¿é—®ä¸äº†çš„</p><h2 id="é¡¹ç›®ä¸­çš„Reactorå’ŒProactoræ¨¡å¼å¦‚ä½•ä½“ç°"><a href="#é¡¹ç›®ä¸­çš„Reactorå’ŒProactoræ¨¡å¼å¦‚ä½•ä½“ç°" class="headerlink" title="é¡¹ç›®ä¸­çš„Reactorå’ŒProactoræ¨¡å¼å¦‚ä½•ä½“ç°"></a>é¡¹ç›®ä¸­çš„Reactorå’ŒProactoræ¨¡å¼å¦‚ä½•ä½“ç°</h2><p>Reactorï¼šepollæ£€æµ‹åˆ°è¯»å’Œå†™äº‹ä»¶æ—¶å€™éƒ½ä¼šæŠŠè¯·æ±‚æ·»åŠ åˆ°è¯·æ±‚é˜Ÿåˆ—ï¼Œè®©å·¥ä½œçº¿ç¨‹æ¥å®Œæˆè¯»å†™æ•°æ®ã€æ¥å—æ–°è¿æ¥ç­‰æ“ä½œ</p><p>Proactorï¼šä¸»çº¿ç¨‹ä»å½“å¼‚æ­¥çº¿ç¨‹ï¼Œå¤„ç†å¥½è¯»å†™äº‹ä»¶åå†æ·»åŠ åˆ°è¯·æ±‚é˜Ÿåˆ—è®©å·¥ä½œçº¿ç¨‹å‘é€æ•°æ®</p><p>ä¸‹é¢æ˜¯çŸ¥ä¹ä¸Šå¤§ç¥ç»™å‡ºçš„ç­”æ¡ˆ</p><blockquote><p>ä»¥Proactoræ¨¡å¼ä¸ºä¾‹çš„å·¥ä½œæµç¨‹å³æ˜¯ï¼šä¸»çº¿ç¨‹å……å½“å¼‚æ­¥çº¿ç¨‹ï¼Œè´Ÿè´£ç›‘å¬æ‰€æœ‰socketä¸Šçš„äº‹ä»¶</p><p>è‹¥æœ‰æ–°è¯·æ±‚åˆ°æ¥ï¼Œä¸»çº¿ç¨‹æ¥æ”¶ä¹‹ä»¥å¾—åˆ°æ–°çš„è¿æ¥socketï¼Œç„¶åå¾€epollå†…æ ¸äº‹ä»¶è¡¨ä¸­æ³¨å†Œè¯¥socketä¸Šçš„è¯»å†™äº‹ä»¶</p><p>å¦‚æœè¿æ¥socketä¸Šæœ‰è¯»å†™äº‹ä»¶å‘ç”Ÿï¼Œä¸»çº¿ç¨‹ä»socketä¸Šæ¥æ”¶æ•°æ®ï¼Œå¹¶å°†æ•°æ®å°è£…æˆè¯·æ±‚å¯¹è±¡æ’å…¥åˆ°è¯·æ±‚é˜Ÿåˆ—ä¸­</p><p>æ‰€æœ‰å·¥ä½œçº¿ç¨‹ç¡çœ åœ¨è¯·æ±‚é˜Ÿåˆ—ä¸Šï¼Œå½“æœ‰ä»»åŠ¡åˆ°æ¥æ—¶ï¼Œé€šè¿‡ç«äº‰ï¼ˆå¦‚äº’æ–¥é”ï¼‰è·å¾—ä»»åŠ¡çš„æ¥ç®¡æƒ</p><p><strong>Reactorã€Proactoræ¨¡å‹çš„åŒºåˆ«ï¼Ÿ</strong></p><p><strong>Reactoræ¨¡å¼</strong>ï¼šè¦æ±‚ä¸»çº¿ç¨‹ï¼ˆI/Oå¤„ç†å•å…ƒï¼‰åªè´Ÿè´£ç›‘å¬æ–‡ä»¶æè¿°ç¬¦ä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼ˆå¯è¯»ã€å¯å†™ï¼‰ï¼Œè‹¥æœ‰ï¼Œåˆ™ç«‹å³é€šçŸ¥å·¥ä½œçº¿ç¨‹ï¼Œå°†socketå¯è¯»å¯å†™äº‹ä»¶æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—ï¼Œ<strong>è¯»å†™æ•°æ®ã€æ¥å—æ–°è¿æ¥åŠå¤„ç†å®¢æˆ·è¯·æ±‚å‡åœ¨å·¥ä½œçº¿ç¨‹ä¸­å®Œæˆã€‚(éœ€è¦åŒºåˆ«è¯»å’Œå†™äº‹ä»¶)</strong></p><p><strong>Proactoræ¨¡å¼</strong>ï¼šä¸»çº¿ç¨‹å’Œå†…æ ¸è´Ÿè´£å¤„ç†è¯»å†™æ•°æ®ã€æ¥å—æ–°è¿æ¥ç­‰<strong>I/Oæ“ä½œ</strong>ï¼Œ<strong>å·¥ä½œçº¿ç¨‹ä»…è´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼ˆç»™äºˆç›¸åº”çš„è¿”å›URLï¼‰</strong>ï¼Œå¦‚å¤„ç†å®¢æˆ·è¯·æ±‚ã€‚</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ç¯‡æ–‡ç« æ˜¯ç”¨æ¥è®°å½•å¹¶å¤ä¹ ä¹‹å‰å†™è¿‡çš„ä¸€ä¸ªTinyWebServeré¡¹ç›®ï¼Œå¸Œæœ›å¯ä»¥æ¢³ç†ä¸€ä¸‹æ€è·¯ï¼Œæ›´è¿›ä¸€æ­¥å¸æ”¶é‡Œé¢çš„çŸ¥è¯†ç‚¹ï¼Œå‰é¢å‡ ä¸ªéƒ¨åˆ†æ˜¯ç½‘ä¸Šæ‰¾çš„çŸ¥è¯†ç‚¹æ€»ç»“ï¼Œåé¢ä¹Ÿæœ‰è‡ªå·±å¯¹é¡¹ç›®çš„åˆ†æ&lt;/p&gt;
&lt;h1 id=&quot;WebServeræ€»ä½“æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#WebServeræ€»ä½“</summary>
      
    
    
    
    <category term="é¢è¯•" scheme="http://sakura-pub.top/categories/%E9%9D%A2%E8%AF%95/"/>
    
    <category term="é¡¹ç›®" scheme="http://sakura-pub.top/categories/%E9%9D%A2%E8%AF%95/%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="é¢è¯•" scheme="http://sakura-pub.top/tags/%E9%9D%A2%E8%AF%95/"/>
    
    <category term="WebServer" scheme="http://sakura-pub.top/tags/WebServer/"/>
    
    <category term="é¡¹ç›®" scheme="http://sakura-pub.top/tags/%E9%A1%B9%E7%9B%AE/"/>
    
  </entry>
  
  <entry>
    <title>C++çŸ¥è¯†ç‚¹æ€»ç»“</title>
    <link href="http://sakura-pub.top/%E9%9D%A2%E8%AF%95/C++%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/"/>
    <id>http://sakura-pub.top/%E9%9D%A2%E8%AF%95/C++%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/</id>
    <published>2022-01-11T01:22:33.000Z</published>
    <updated>2022-06-23T05:26:13.488Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p> åœ¨å†™è¿™ä¸ªæ–‡ç« çš„æ—¶å€™å·²ç»æ˜¯å¤§ä¸‰çš„å¯’å‡äº†ï¼Œå› æ­¤ä¹Ÿè¦å¼€å§‹ä¸ºå®ä¹ çš„å·¥ä½œåšå‡†å¤‡äº†ï¼Œè¿™é‡Œå°±ä¸“é—¨å¼€äº†ä¸ªæ–‡ç« æ¥è®°å½•æˆ‘åœ¨ç½‘ä¸Šæ‰¾åˆ°çš„ä¸€äº›<strong>C++é¢ç»</strong>ï¼Œæ–‡ç« ä¹Ÿæ˜¯ä¸æ–­è¿›è¡Œæ›´æ–°çš„ï¼Œå¸Œæœ›åˆ°æ—¶å€™èƒ½å¤Ÿæ‰¾åˆ°ä¸€ä¸ªæ»¡æ„çš„OfferğŸ“</p><h1 id="C-è¯­è¨€é—®ç­”é¢˜"><a href="#C-è¯­è¨€é—®ç­”é¢˜" class="headerlink" title="C++è¯­è¨€é—®ç­”é¢˜"></a>C++è¯­è¨€é—®ç­”é¢˜</h1><p>é¦–å…ˆæ˜¯C++çš„è¯­è¨€ç‰¹æ€§é—®é¢˜ï¼Œæœ‰è®¸å¤šé—®é¢˜éƒ½æ˜¯ç»å¸¸é—®åˆ°çš„ï¼Œè¿™é‡Œé€ä¸ªè®°å½•ä¸‹æ¥</p><h2 id="strcpy-å‡½æ•°æœ‰ä»€ä¹ˆç¼ºé™·ï¼Œå¦‚ä½•ä¼˜åŒ–"><a href="#strcpy-å‡½æ•°æœ‰ä»€ä¹ˆç¼ºé™·ï¼Œå¦‚ä½•ä¼˜åŒ–" class="headerlink" title="strcpy å‡½æ•°æœ‰ä»€ä¹ˆç¼ºé™·ï¼Œå¦‚ä½•ä¼˜åŒ–"></a>strcpy å‡½æ•°æœ‰ä»€ä¹ˆç¼ºé™·ï¼Œå¦‚ä½•ä¼˜åŒ–</h2><p><code>strcpy</code>æ˜¯cè¯­è¨€å¤´æ–‡ä»¶ä¸­çš„<code>&lt;string.h&gt;</code>çš„åº“å‡½æ•°ï¼Œæ˜¯ç”¨æ¥å¤åˆ¶å­—ç¬¦ä¸²ï¼Œå®ƒçš„å‡½æ•°åŸå‹ä¸º<code>char * strcpy( char * dst, const char * src )</code>ï¼Œè¿™ä¸ªå‡½æ•°æŠŠå­—ç¬¦ä¸²srcå¤åˆ¶åˆ°ä¸€åˆ†é…å¥½çš„å­—ç¬¦ä¸²ç©ºé—´dstä¸­ï¼Œå¤åˆ¶çš„æ—¶å€™åŒ…æ‹¬æ ‡å¿—å­—ç¬¦ä¸²ç»“å°¾çš„ç©ºå­—ç¬¦ä¸€èµ·å¤åˆ¶ã€‚æ“ä½œæˆåŠŸï¼Œè¿”å›dstï¼Œå¦åˆ™è¿”å›NULL</p><p>å®ƒçš„<strong>ç¼ºé™·</strong>åˆ™æ˜¯æ²¡æœ‰å­—ç¬¦ä¸²é•¿åº¦çš„åˆ¤æ–­ï¼Œå½“å¤åˆ¶è¿›å»çš„å­—ç¬¦ä¸²<code>src</code>é•¿åº¦å¤§äºäº†åŸæ¥åˆ†é…å¥½ç©ºé—´çš„å­—ç¬¦ä¸²<code>dst</code>é•¿åº¦æ—¶ï¼Œå‡½æ•°ä¼šæŠŠå­—ç¬¦ä¸²åé¢çš„ç©ºé—´ä¹Ÿè¦†ç›–æ‰ï¼Œé€ æˆ<strong>ç¼“å†²æº¢å‡º</strong>æƒ…å†µ</p><p>æƒ³è¦ä¼˜åŒ–è¿™ä¸ªç¼ºé™·å…¶å®å¾ˆç®€å•ï¼Œåªéœ€è¦è‡ªå·±åŠ ä¸€ä¸ªåˆ¤æ–­é•¿åº¦è¯­å¥å°±è¡Œäº†</p><h2 id="æŒ‡é’ˆå’Œå¼•ç”¨åŒºåˆ«"><a href="#æŒ‡é’ˆå’Œå¼•ç”¨åŒºåˆ«" class="headerlink" title="æŒ‡é’ˆå’Œå¼•ç”¨åŒºåˆ«"></a>æŒ‡é’ˆå’Œå¼•ç”¨åŒºåˆ«</h2><p>è¿™é‡ŒæŒ‡é’ˆå’Œå¼•ç”¨åŒºåˆ«æœ‰å››ä¸ªç‚¹</p><ol><li>æŒ‡é’ˆæ‰€æŒ‡å‘çš„å†…å­˜å¯ä»¥åœ¨ç¨‹åºè¿è¡ŒæœŸé—´æ”¹å˜ï¼Œè€Œå¼•ç”¨æ‰€ç»‘å®šçš„å¯¹è±¡ä¸€æ—¦ç»‘å®šä¹‹åä¸å…è®¸æ”¹å˜ï¼ˆæ˜¯å¦å¯å˜ï¼‰</li><li>æŒ‡é’ˆæœ¬èº«åœ¨å†…å­˜ä¸­æ˜¯å ç©ºé—´çš„ï¼ˆ32ä½ç³»ç»ŸæŒ‡é’ˆå 4å­—èŠ‚ï¼Œ64ä½ç³»ç»ŸæŒ‡é’ˆå 8å­—èŠ‚ï¼‰ï¼Œå¼•ç”¨ç›¸å½“äºå˜é‡åˆ«åï¼Œåœ¨å†…å­˜ä¸­ä¸å ç©ºé—´ï¼ˆæ˜¯å¦å ç©ºé—´ï¼‰</li><li>æŒ‡é’ˆå¯ä»¥ä¸ºç©ºï¼Œå¼•ç”¨åˆ™å¿…é¡»ç»‘å®šå¯¹è±¡ï¼ˆæ˜¯å¦å¯ä¸ºç©ºï¼‰</li><li>æŒ‡é’ˆå¯ä»¥æœ‰å¤šçº§ï¼Œå¼•ç”¨åªèƒ½æœ‰ä¸€çº§ï¼ˆæ˜¯å¦èƒ½ä¸ºå¤šçº§ï¼‰</li></ol><h2 id="å †å’Œæ ˆçš„åŒºåˆ«"><a href="#å †å’Œæ ˆçš„åŒºåˆ«" class="headerlink" title="å †å’Œæ ˆçš„åŒºåˆ«"></a>å †å’Œæ ˆçš„åŒºåˆ«</h2><p>è¿™é‡Œçš„å †å’Œæ ˆæ˜¯æŒ‡å†…å­˜ä¸­çš„å †æ ˆï¼Œå †æ ˆæ˜¯ä¸€ä¸ªç‰¹å®šçš„å­˜å‚¨åŒºæˆ–å¯„å­˜å™¨</p><ol><li>ç”³è¯·æ–¹å¼ï¼šæ ˆæ˜¯ç³»ç»Ÿè‡ªåŠ¨åˆ†é…çš„ï¼Œè€Œå †åˆ™æ˜¯ç¨‹åºå‘˜ä¸»åŠ¨ç”³è¯·çš„</li><li>ç”³è¯·åç³»ç»Ÿçš„å“åº”æ–¹å¼ï¼šåˆ†é…æ ˆç©ºé—´ï¼Œå¦‚æœå‰©ä½™ç©ºé—´å¤§äºç”³è¯·ç©ºé—´ï¼Œåˆ™åˆ†é…æˆåŠŸï¼Œå¦åˆ™åˆ†é…å¤±è´¥æ ˆæº¢å‡ºï¼›åˆ†é…å †ç©ºé—´ï¼Œå †åœ¨å†…å­˜ä¸­å‘ˆç°çš„æ–¹å¼ç±»ä¼¼äºé“¾è¡¨ï¼ˆæ¯ä¸ªèŠ‚ç‚¹è®°å½•ç€ç©ºé—²çš„ç©ºé—´ï¼‰ï¼Œåœ¨é“¾è¡¨ä¸­å¯»æ±‚ç¬¬ä¸€ä¸ªå¤§äºç”³è¯·ç©ºé—´çš„èŠ‚ç‚¹åˆ†é…ç»™ç¨‹åºï¼Œå¹¶å°†è¯¥èŠ‚ç‚¹åˆ é™¤ï¼›å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¤§å¤šæ•°ç³»ç»Ÿä¸­è¯¥å—ç©ºé—´çš„é¦–åœ°å€å­˜æ”¾çš„æ˜¯æœ¬æ¬¡çš„æ˜¯æœ¬æ¬¡åˆ†é…ç©ºé—´çš„å¤§å°ï¼Œä¾¿äºé‡Šæ”¾æ—¶å°†è¯¥å—ç©ºé—´é‡æ–°æ·»åŠ åˆ°é“¾è¡¨ä¸Šã€‚</li><li>æ ˆåœ¨å†…å­˜ä¸­æ˜¯ä¸€å—è¿ç»­çš„ç©ºé—´ï¼ˆå‘ä½åœ°å€æ‰©å±•ï¼‰ï¼Œæœ€å¤§çš„å®¹é‡æ˜¯ç³»ç»Ÿé¢„å®šå¥½çš„ï¼›å †æ˜¯ä¸è¿ç»­çš„ç©ºé—´ï¼ˆå‘é«˜åœ°å€æ‰©å±•ï¼‰</li><li>ç”³è¯·æ•ˆç‡ï¼šæ ˆæ˜¯ç³»ç»Ÿè‡ªåŠ¨åˆ†é…çš„ï¼Œç”³è¯·æ•ˆç‡é«˜ï¼Œä½†æ˜¯ç¨‹åºå‘˜æ— æ³•æ§åˆ¶ï¼›å †æ˜¯ç”±ç¨‹åºå‘˜è‡ªä¸»ç”³è¯·åˆ†é…çš„ï¼Œæ•ˆç‡è¾ƒä½ï¼Œå¹¶ä¸”å®¹æ˜“äº§ç”Ÿç¢ç‰‡ç©ºé—´</li><li>å­˜æ”¾çš„å†…å®¹ï¼šæ ˆä¸­å­˜æ”¾çš„æ˜¯å±€éƒ¨å˜é‡ï¼Œå‡½æ•°çš„å‚æ•°ï¼›å †å­˜æ”¾çš„å†…å®¹ç”±ç¨‹åºå‘˜æ§åˆ¶</li></ol><h2 id="newå’Œdeleteæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œnewå’Œmallocæœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#newå’Œdeleteæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œnewå’Œmallocæœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="newå’Œdeleteæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œnewå’Œmallocæœ‰ä»€ä¹ˆåŒºåˆ«"></a>newå’Œdeleteæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œnewå’Œmallocæœ‰ä»€ä¹ˆåŒºåˆ«</h2><p>new/deleteå’Œmalloc/freeéƒ½æ˜¯å¾ˆç†Ÿæ‚‰çš„ï¼Œç»å¸¸è¦ç”¨åˆ°</p><ol><li>å±æ€§ï¼šmallocå’Œfreeæ˜¯åº“å‡½æ•°ï¼Œéœ€è¦å¤´æ–‡ä»¶çš„æ”¯æŒï¼›newå’Œdeleteæ˜¯å…³é”®å­—ï¼Œè¦ç¼–è¯‘å™¨çš„æ”¯æŒ</li><li>å‚æ•°ï¼šä½¿ç”¨newåˆ†é…ç©ºé—´æ—¶ï¼Œæ— éœ€æŒ‡å®šåˆ†é…ç©ºé—´çš„å¤§å°ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®æ•°æ®ç±»å‹è‡ªåŠ¨è®¡ç®—ï¼›è€Œä½¿ç”¨mallocç”³è¯·åˆ†é…ç©ºé—´æ—¶ï¼Œåˆ™éœ€ç¡®å®šæ‰€è¦åˆ†é…ç©ºé—´çš„å¤§å°</li><li>è¿”å›å€¼ï¼šnewæ‰€åˆ†é…åè¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹åº”æ•°æ®ç±»å‹çš„æŒ‡é’ˆï¼Œæ— éœ€å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œç¬¦åˆç±»å‹å®‰å…¨çš„æ“ä½œç¬¦ï¼›è€Œmallocç”³è¯·ç©ºé—´æ—¶ï¼Œè¿”å›çš„æ˜¯void*ç±»å‹çš„æŒ‡é’ˆï¼Œéœ€è¦è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œè½¬æ¢ä¸ºå¯¹è±¡ç±»å‹æŒ‡é’ˆ</li><li>åˆ†é…å¤±è´¥æƒ…å†µï¼šnewåˆ†é…å¤±è´¥ä¼šæŠ›å‡º<code>bad_alloc</code>å¼‚å¸¸ï¼Œmallocåˆ†é…å¤±è´¥åˆ™è¿”å›ç©ºæŒ‡é’ˆ</li><li>é‡è½½ï¼šnew/deleteå‡å¯è¿›è¡Œé‡è½½ï¼Œè€Œmalloc/freeä¸èƒ½</li><li>è‡ªå®šä¹‰ç±»å‹å®ç°ï¼šnew é¦–å…ˆè°ƒç”¨ operator new() å‡½æ•°ç”³è¯·ç©ºé—´ï¼ˆåº•å±‚é€šè¿‡ malloc å®ç°ï¼‰ï¼Œç„¶åè°ƒç”¨æ„é€ å‡½æ•°è¿›è¡Œåˆå§‹åŒ–ï¼Œæœ€åè¿”å›è‡ªå®šä¹‰ç±»å‹çš„æŒ‡é’ˆï¼›delete é¦–å…ˆè°ƒç”¨ææ„å‡½æ•°ï¼Œç„¶åè°ƒç”¨ operator delete() é‡Šæ”¾ç©ºé—´ï¼ˆåº•å±‚é€šè¿‡ free å®ç°ï¼‰ã€‚malloc/free æ— æ³•è¿›è¡Œè‡ªå®šä¹‰ç±»å‹çš„å¯¹è±¡çš„æ„é€ å’Œææ„</li><li>å†…å­˜åŒºåŸŸï¼šnewæ“ä½œç¬¦ä»<strong>è‡ªç”±å­˜å‚¨åŒº</strong>ä¸Šä¸ºå¯¹è±¡åˆ†é…ç©ºé—´ï¼Œè€Œmallocåˆ™æ˜¯åœ¨<strong>å †</strong>ä¸Šåˆ†é…ç©ºé—´ã€‚ï¼ˆ<strong>è‡ªç”±å­˜å‚¨åŒºä¸ç­‰äºå †</strong>ï¼‰</li></ol><h2 id="Cå’ŒC-çš„åŒºåˆ«"><a href="#Cå’ŒC-çš„åŒºåˆ«" class="headerlink" title="Cå’ŒC++çš„åŒºåˆ«"></a>Cå’ŒC++çš„åŒºåˆ«</h2><ul><li><p>C æ˜¯é¢å‘è¿‡ç¨‹çš„ç¼–ç¨‹ï¼Œç‰¹ç‚¹æ˜¯å‡½æ•°ï¼›C++ æ˜¯é¢å‘å¯¹è±¡çš„ç¼–ç¨‹ï¼Œç‰¹ç‚¹æ˜¯ç±»ã€‚ï¼ˆç‰¹æ€§ï¼‰</p></li><li><p>C ä¸»è¦ç”¨åœ¨åµŒå…¥å¼å¼€å‘ã€é©±åŠ¨å¼€å‘å’Œç¡¬ä»¶ç›´æ¥æ‰“äº¤é“çš„é¢†åŸŸï¼›C++ å¯ä»¥ç”¨äºåº”ç”¨å±‚çš„å¼€å‘ã€ç”¨æˆ·ç•Œé¢å¼€å‘ç­‰å’Œæ“ä½œç³»ç»Ÿç›´æ¥æ‰“äº¤é“çš„é¢†åŸŸã€‚ï¼ˆåº”ç”¨é¢†åŸŸï¼‰</p></li><li><p>C++ ç»§æ‰¿äº†Cçš„åº•å±‚æ“ä½œç‰¹æ€§ï¼Œå¢åŠ äº†é¢å‘å¯¹è±¡çš„æœºåˆ¶ï¼Œå¢åŠ äº†æ³›å‹ç¼–ç¨‹ã€å¼‚å¸¸å¤„ç†ã€è¿ç®—ç¬¦é‡è½½ï¼Œè¿˜å¢åŠ äº†å‘½åç©ºé—´ï¼Œé¿å…äº†å‘½åå†²çªã€‚ï¼ˆç›¸è¾ƒäº C çš„å‡çº§ï¼‰</p></li></ul><h2 id="C-ã€Java-çš„è”ç³»ä¸åŒºåˆ«ï¼ŒåŒ…æ‹¬è¯­è¨€ç‰¹æ€§ã€åƒåœ¾å›æ”¶ã€åº”ç”¨åœºæ™¯ç­‰ï¼ˆjava-çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼‰"><a href="#C-ã€Java-çš„è”ç³»ä¸åŒºåˆ«ï¼ŒåŒ…æ‹¬è¯­è¨€ç‰¹æ€§ã€åƒåœ¾å›æ”¶ã€åº”ç”¨åœºæ™¯ç­‰ï¼ˆjava-çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼‰" class="headerlink" title="C++ã€Java çš„è”ç³»ä¸åŒºåˆ«ï¼ŒåŒ…æ‹¬è¯­è¨€ç‰¹æ€§ã€åƒåœ¾å›æ”¶ã€åº”ç”¨åœºæ™¯ç­‰ï¼ˆjava çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼‰"></a>C++ã€Java çš„è”ç³»ä¸åŒºåˆ«ï¼ŒåŒ…æ‹¬è¯­è¨€ç‰¹æ€§ã€åƒåœ¾å›æ”¶ã€åº”ç”¨åœºæ™¯ç­‰ï¼ˆjava çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼‰</h2><h3 id="äºŒè€…åœ¨è¯­è¨€ç‰¹æ€§ä¸Šæœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼š"><a href="#äºŒè€…åœ¨è¯­è¨€ç‰¹æ€§ä¸Šæœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼š" class="headerlink" title="äºŒè€…åœ¨è¯­è¨€ç‰¹æ€§ä¸Šæœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼š"></a>äºŒè€…åœ¨è¯­è¨€ç‰¹æ€§ä¸Šæœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼š</h3><ul><li>æŒ‡é’ˆï¼šC++ å¯ä»¥ç›´æ¥æ“ä½œæŒ‡é’ˆï¼Œå®¹æ˜“äº§ç”Ÿå†…å­˜æ³„æ¼ä»¥åŠéæ³•æŒ‡é’ˆå¼•ç”¨çš„é—®é¢˜ï¼›JAVA å¹¶ä¸æ˜¯æ²¡æœ‰æŒ‡é’ˆï¼Œè™šæ‹Ÿæœº(JVM)å†…éƒ¨è¿˜æ˜¯ä½¿ç”¨äº†æŒ‡é’ˆï¼Œåªæ˜¯ç¼–ç¨‹äººå‘˜ä¸èƒ½ç›´æ¥ä½¿ç”¨æŒ‡é’ˆï¼Œä¸èƒ½é€šè¿‡æŒ‡é’ˆæ¥ç›´æ¥è®¿é—®å†…å­˜ï¼Œå¹¶ä¸” JAVA å¢åŠ äº†å†…å­˜ç®¡ç†æœºåˆ¶</li><li>å¤šé‡ç»§æ‰¿ï¼šC++ æ”¯æŒå¤šé‡ç»§æ‰¿ï¼Œå…è®¸å¤šä¸ªçˆ¶ç±»æ´¾ç”Ÿä¸€ä¸ªç±»ï¼Œè™½ç„¶åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨çš„ä¸å½“ä¼šé€ æˆå¾ˆå¤šé—®é¢˜ï¼Œä¾‹å¦‚ï¼šè±å½¢ç»§æ‰¿ï¼›JAVA ä¸æ”¯æŒå¤šé‡ç»§æ‰¿ï¼Œä½†å…è®¸ä¸€ä¸ªç±»å¯ä»¥ç»§æ‰¿å¤šä¸ªæ¥å£ï¼Œå¯ä»¥å®ç° C++ å¤šé‡ç»§æ‰¿çš„åŠŸèƒ½ï¼Œä½†åˆé¿å…äº†å¤šé‡ç»§æ‰¿å¸¦æ¥çš„è®¸å¤šä¸ä¾¿</li><li>æ•°æ®ç±»å‹å’Œç±»ï¼šC++ å¯ä»¥å°†å˜é‡æˆ–å‡½æ•°å®šä¹‰æˆå…¨å±€ï¼Œä½†æ˜¯JAVAæ˜¯å®Œå…¨é¢å‘å¯¹è±¡çš„è¯­è¨€ï¼Œé™¤äº†åŸºæœ¬çš„æ•°æ®ç±»å‹ä¹‹å¤–ï¼Œå…¶ä»–çš„éƒ½ä½œä¸ºç±»çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬æ•°ç»„ã€‚</li></ul><h3 id="åƒåœ¾å›æ”¶ï¼š"><a href="#åƒåœ¾å›æ”¶ï¼š" class="headerlink" title="åƒåœ¾å›æ”¶ï¼š"></a>åƒåœ¾å›æ”¶ï¼š</h3><ul><li>JAVA è¯­è¨€ä¸€ä¸ªæ˜¾è‘—çš„ç‰¹ç‚¹å°±æ˜¯åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œç¼–ç¨‹äººå‘˜æ— éœ€è€ƒè™‘å†…å­˜ç®¡ç†çš„é—®é¢˜ï¼Œå¯ä»¥æœ‰æ•ˆçš„é˜²æ­¢å†…å­˜æ³„æ¼ï¼Œæœ‰æ•ˆçš„ä½¿ç”¨ç©ºé—²çš„å†…å­˜</li><li>JAVA æ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ç”¨ new æ“ä½œç¬¦å»ºç«‹åœ¨å†…å­˜å †æ ˆä¸Šï¼Œç±»ä¼¼äº C++ ä¸­çš„ new æ“ä½œç¬¦ï¼Œä½†æ˜¯å½“è¦é‡Šæ”¾è¯¥ç”³è¯·çš„å†…å­˜ç©ºé—´æ—¶ï¼ŒJAVA è‡ªåŠ¨è¿›è¡Œå†…å­˜å›æ”¶æ“ä½œï¼ŒC++ éœ€è¦ç¨‹åºå‘˜è‡ªå·±é‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œå¹¶ä¸” JAVA ä¸­çš„å†…å­˜å›æ”¶æ˜¯ä»¥çº¿ç¨‹çš„æ–¹å¼åœ¨åå°è¿è¡Œçš„ï¼Œåˆ©ç”¨ç©ºé—²æ—¶é—´ã€‚</li></ul><h3 id="åº”ç”¨åœºæ™¯ï¼š"><a href="#åº”ç”¨åœºæ™¯ï¼š" class="headerlink" title="åº”ç”¨åœºæ™¯ï¼š"></a>åº”ç”¨åœºæ™¯ï¼š</h3><ul><li><p>java è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Šï¼Œå’Œå¼€å‘å¹³å°æ— å…³ï¼ŒC++ ç›´æ¥ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ˜¯å¦è·¨å¹³å°åœ¨äºç”¨åˆ°çš„ç¼–è¯‘å™¨çš„ç‰¹æ€§æ˜¯å¦æœ‰å¤šå¹³å°çš„æ”¯æŒï¼Œ</p></li><li><p>C++ å¯ä»¥ç›´æ¥ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿è¡Œæ•ˆç‡æ¯” JAVA é«˜</p></li><li><p>JAVA ä¸»è¦ç”¨æ¥å¼€å‘ web åº”ç”¨</p></li><li><p>C++ ä¸»è¦ç”¨åœ¨åµŒå…¥å¼å¼€å‘ã€ç½‘ç»œã€å¹¶å‘ç¼–ç¨‹çš„æ–¹é¢</p></li></ul><h2 id="structå’Œclassçš„åŒºåˆ«"><a href="#structå’Œclassçš„åŒºåˆ«" class="headerlink" title="structå’Œclassçš„åŒºåˆ«"></a>structå’Œclassçš„åŒºåˆ«</h2><p>C++ä¸­çš„structæ˜¯å¯¹Cä¸­çš„structè¿›è¡Œäº†æ‰©å……ï¼Œå®ƒå¯ä»¥åŒ…å«æˆå‘˜å‡½æ•°ã€èƒ½å¤Ÿç»§æ‰¿ã€ä¹Ÿèƒ½å¤Ÿå®ç°å¤šæ€ï¼Œè€Œstructä¸classæœ€æœ¬è´¨çš„åŒºåˆ«åœ¨äºé»˜è®¤çš„è®¿é—®æ§åˆ¶ï¼šstructé»˜è®¤ç»§æ‰¿è®¿é—®æƒé™æ˜¯<strong>public</strong>ï¼Œclassçš„é»˜è®¤ç»§æ‰¿è®¿é—®æƒé™æ˜¯<strong>private</strong></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">A</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">A</span></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">//Bæ˜¯classï¼Œæ‰€ä»¥æ˜¯privateç»§æ‰¿</span><span class="token keyword">struct</span> <span class="token class-name">C</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">B</span></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">//Cæ˜¯structï¼Œæ‰€ä»¥æ˜¯publicç»§æ‰¿</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä¸¾ä¾‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">printA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"class A"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">B</span><span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">A</span></span><span class="token punctuation">&#123;</span><span class="token comment">//ç”±äº B æ˜¯ structï¼ŒAçš„ç»§æ‰¿çº§åˆ«ä¸º public(å–å†³äºBçš„é»˜è®¤ç»§æ‰¿çº§åˆ«)</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">printB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"class B"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">C</span><span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">B</span></span><span class="token punctuation">&#123;</span><span class="token comment">//ç”±äº C æ˜¯ classï¼ŒBçš„ç»§æ‰¿çº§åˆ«ä¸º private(å–å†³äºCçš„é»˜è®¤ç»§æ‰¿çº§åˆ«)ï¼Œæ‰€ä»¥æ— æ³•è®¿é—®åŸºç±»Bä¸­çš„printBå‡½æ•°</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    A ex1<span class="token punctuation">;</span>    ex1<span class="token punctuation">.</span><span class="token function">printA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// class A</span>    B ex2<span class="token punctuation">;</span>    ex2<span class="token punctuation">.</span><span class="token function">printA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// class A</span>    ex2<span class="token punctuation">.</span><span class="token function">printB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// class B</span>    C ex3<span class="token punctuation">;</span>    ex3<span class="token punctuation">.</span><span class="token function">printB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// error: 'B' is not an accessible base of 'C'</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŒæ—¶ï¼Œclasså¯ä»¥ä½¿ç”¨æ¨¡æ¿ï¼Œè€Œstructä¸èƒ½</p><h2 id="defineå’Œconstçš„åŒºåˆ«ï¼ˆç¼–è¯‘é˜¶æ®µã€å®‰å…¨æ€§ã€å†…å­˜å ç”¨ç­‰ï¼‰"><a href="#defineå’Œconstçš„åŒºåˆ«ï¼ˆç¼–è¯‘é˜¶æ®µã€å®‰å…¨æ€§ã€å†…å­˜å ç”¨ç­‰ï¼‰" class="headerlink" title="defineå’Œconstçš„åŒºåˆ«ï¼ˆç¼–è¯‘é˜¶æ®µã€å®‰å…¨æ€§ã€å†…å­˜å ç”¨ç­‰ï¼‰"></a>defineå’Œconstçš„åŒºåˆ«ï¼ˆç¼–è¯‘é˜¶æ®µã€å®‰å…¨æ€§ã€å†…å­˜å ç”¨ç­‰ï¼‰</h2><ul><li>ç¼–è¯‘é˜¶æ®µï¼šdefineæ˜¯åœ¨ç¼–è¯‘é¢„å¤„ç†é˜¶æ®µèµ·ä½œç”¨ï¼Œconstæ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå’Œç¨‹åºè¿è¡Œé˜¶æ®µèµ·ä½œç”¨</li><li>å®‰å…¨æ€§ï¼šdefineå®šä¹‰çš„å®å¸¸é‡æ²¡æœ‰æ•°æ®ç±»å‹ï¼Œåªæ˜¯è¿›è¡Œç®€å•çš„æ›¿æ¢ï¼Œä¸ä¼šè¿›è¡Œç±»å‹å®‰å…¨çš„æ£€æµ‹ï¼›constå®šä¹‰çš„åªè¯»å˜é‡æ˜¯æœ‰ç±»å‹çš„ï¼Œä¼šè¿›è¡Œåˆ¤æ–­ï¼Œå¯ä»¥é¿å…ä½çº§é”™è¯¯</li><li>å†…å­˜å ç”¨ï¼šdefineæ‰€å®šä¹‰çš„å¸¸é‡ï¼Œåœ¨ç¨‹åºä¸­ä½¿ç”¨å¤šå°‘æ¬¡å°±ä¼šæ›¿æ¢å¤šå°‘æ¬¡ï¼Œå†…å­˜ä¸­æœ‰å¤šä¸ªå¤‡ä»½ï¼›constå®šä¹‰çš„åªè¯»å˜é‡åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­åªæœ‰ä¸€ä»½</li><li>è°ƒè¯•ï¼šdefineå®šä¹‰çš„å¸¸é‡ä¸èƒ½è¿›è¡Œè°ƒè¯•ï¼Œå› ä¸ºåœ¨é¢„ç¼–è¯‘é˜¶æ®µå°±å·²ç»æ›¿æ¢äº†ï¼›constå®šä¹‰çš„åªè¯»å˜é‡å¯ä»¥è¿›è¡Œè°ƒè¯•</li></ul><p>constçš„ä¼˜ç‚¹ï¼š</p><ul><li>æœ‰æ•°æ®ç±»å‹ï¼Œåœ¨å®šä¹‰å¼å¯è¿›è¡Œå®‰å…¨æ€§æ£€æŸ¥</li><li>å¯è°ƒå¼</li><li>å ç”¨è¾ƒå°‘çš„ç©ºé—´</li></ul><h2 id="C-ä¸­çš„static"><a href="#C-ä¸­çš„static" class="headerlink" title="C++ä¸­çš„static"></a>C++ä¸­çš„static</h2><p><strong>static</strong> å­˜å‚¨ç±»æŒ‡ç¤ºç¼–è¯‘å™¨åœ¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸå†…ä¿æŒå±€éƒ¨å˜é‡çš„å­˜åœ¨ï¼Œè€Œä¸éœ€è¦åœ¨æ¯æ¬¡å®ƒè¿›å…¥å’Œç¦»å¼€ä½œç”¨åŸŸæ—¶è¿›è¡Œåˆ›å»ºå’Œé”€æ¯ã€‚å› æ­¤ï¼Œä½¿ç”¨ static ä¿®é¥°å±€éƒ¨å˜é‡å¯ä»¥åœ¨å‡½æ•°è°ƒç”¨ä¹‹é—´ä¿æŒå±€éƒ¨å˜é‡çš„å€¼ã€‚</p><p>static ä¿®é¥°ç¬¦ä¹Ÿå¯ä»¥åº”ç”¨äºå…¨å±€å˜é‡ã€‚å½“ static ä¿®é¥°å…¨å±€å˜é‡æ—¶ï¼Œä¼šä½¿å˜é‡çš„ä½œç”¨åŸŸé™åˆ¶åœ¨å£°æ˜å®ƒçš„æ–‡ä»¶å†…ã€‚</p><p>é™æ€å˜é‡å­˜å‚¨åœ¨<strong>é™æ€å­˜å‚¨åŒº</strong>ï¼ˆå­˜å‚¨åœ¨é™æ€å­˜å‚¨åŒºçš„å˜é‡ï¼Œå¦‚æœä¸æ˜¾å¼åœ°å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼Œç³»ç»Ÿä¼šå°†å…¶åˆå§‹åŒ–ä¸º0ï¼‰ï¼Œåœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´ï¼Œ<strong>å¯¹åº”çš„å­˜å‚¨ç©ºé—´ä¸ä¼šé‡Šæ”¾</strong>ï¼Œä¸€ç›´åˆ°ç¨‹åºç»“æŸæ‰ä¼šé‡Šæ”¾ã€‚</p><p> å¯¹å…¨å±€å˜é‡è€Œè¨€ï¼Œå­˜å‚¨æ–¹å¼æ²¡æœ‰ä»€ä¹ˆæ”¹å˜ï¼Œå› ä¸º<strong>å…¨å±€å˜é‡å’Œå…¨å±€é™æ€å˜é‡éƒ½å­˜å‚¨åœ¨é™æ€å­˜å‚¨åŒº</strong>ã€‚</p><p>åœ¨ C++ ä¸­ï¼Œå½“ static ç”¨åœ¨ç±»æ•°æ®æˆå‘˜ä¸Šæ—¶ï¼Œä¼šå¯¼è‡´ä»…æœ‰ä¸€ä¸ªè¯¥æˆå‘˜çš„å‰¯æœ¬è¢«ç±»çš„æ‰€æœ‰å¯¹è±¡å…±äº«ã€‚    </p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span> <span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">/* å…¨å±€å˜é‡ */</span> <span class="token comment">// å‡½æ•°å®šä¹‰</span><span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// å±€éƒ¨é™æ€å˜é‡</span>    i<span class="token operator">++</span><span class="token punctuation">;</span>    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"å˜é‡ i ä¸º "</span> <span class="token operator">&lt;&lt;</span> i <span class="token punctuation">;</span>    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">" , å˜é‡ count ä¸º "</span> <span class="token operator">&lt;&lt;</span> count <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//staticåœ¨ç±»é‡Œé¢</span><span class="token keyword">class</span> <span class="token class-name">staticTest</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> num<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">int</span> staticTest<span class="token operator">::</span>num<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//å¿…é¡»åœ¨mainå‰é¢å…ˆåˆå§‹åŒ–staicå˜é‡</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>count<span class="token operator">--</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>       <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    staticTest<span class="token operator">::</span>num<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"num=%d\n"</span><span class="token punctuation">,</span>staticTest<span class="token operator">::</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//num=6</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å·¦å€¼å’Œå³å€¼ã€å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨"><a href="#å·¦å€¼å’Œå³å€¼ã€å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨" class="headerlink" title="å·¦å€¼å’Œå³å€¼ã€å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨"></a>å·¦å€¼å’Œå³å€¼ã€å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨</h2><h2 id="å·¦å€¼å’Œå³å€¼"><a href="#å·¦å€¼å’Œå³å€¼" class="headerlink" title="å·¦å€¼å’Œå³å€¼"></a>å·¦å€¼å’Œå³å€¼</h2><p>å·¦å€¼æ˜¯å­˜å‚¨å•å…ƒå†…çš„å€¼ï¼Œå³æ˜¯æœ‰å®é™…å­˜å‚¨åœ°å€çš„ï¼›</p><p>å³å€¼åˆ™ä¸æ˜¯å­˜å‚¨å•å…ƒå†…çš„å€¼ï¼Œæ¯”å¦‚å®ƒå¯èƒ½æ˜¯å¯„å­˜å™¨å†…çš„å€¼ä¹Ÿå¯èƒ½æ˜¯<a href="https://www.zhihu.com/search?q=%E7%AB%8B%E5%8D%B3%E6%95%B0&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:102830868%7D">ç«‹å³æ•°</a>ã€‚</p><p>ä¾‹å¦‚<code>int i=1</code>ä»£ç ä¸­ï¼Œ<code>i</code>æ˜¯å·¦å€¼ï¼Œ<code>1</code>æ˜¯å³å€¼</p><h2 id="å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨"><a href="#å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨" class="headerlink" title="å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨"></a>å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨</h2><h3 id="å·¦å€¼å¼•ç”¨"><a href="#å·¦å€¼å¼•ç”¨" class="headerlink" title="å·¦å€¼å¼•ç”¨"></a>å·¦å€¼å¼•ç”¨</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token operator">&amp;</span>b <span class="token operator">=</span> a<span class="token punctuation">;</span>  <span class="token comment">// å®šä¹‰ä¸€ä¸ªå·¦å€¼å¼•ç”¨å˜é‡</span>b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>      <span class="token comment">// é€šè¿‡å·¦å€¼å¼•ç”¨ä¿®æ”¹å¼•ç”¨å†…å­˜çš„å€¼</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><em>å·¦å€¼å¼•ç”¨åœ¨æ±‡ç¼–å±‚é¢å…¶å®å’Œæ™®é€šçš„æŒ‡é’ˆæ˜¯ä¸€æ ·çš„ï¼›</em>å®šä¹‰å¼•ç”¨å˜é‡å¿…é¡»åˆå§‹åŒ–ï¼Œå› ä¸ºå¼•ç”¨å…¶å®å°±æ˜¯ä¸€ä¸ªåˆ«åï¼Œéœ€è¦å‘Šè¯‰ç¼–è¯‘å™¨å®šä¹‰çš„æ˜¯è°çš„å¼•ç”¨ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token operator">&amp;</span>var <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸Šè¿°ä»£ç æ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡çš„ï¼Œå› ä¸º10æ— æ³•è¿›è¡Œå–åœ°å€æ“ä½œï¼Œæ— æ³•å¯¹ä¸€ä¸ªç«‹å³æ•°å–åœ°å€ï¼Œå› ä¸ºç«‹å³æ•°å¹¶æ²¡æœ‰åœ¨å†…å­˜ä¸­å­˜å‚¨ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨å¯„å­˜å™¨ä¸­ï¼Œå¯ä»¥é€šè¿‡ä¸‹è¿°æ–¹æ³•è§£å†³ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>var <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä½¿ç”¨å¸¸å¼•ç”¨æ¥å¼•ç”¨å¸¸é‡æ•°å­—10ï¼Œå› ä¸ºæ­¤åˆ»å†…å­˜ä¸Šäº§ç”Ÿäº†ä¸´æ—¶å˜é‡ä¿å­˜äº†10ï¼Œè¿™ä¸ªä¸´æ—¶å˜é‡æ˜¯å¯ä»¥è¿›è¡Œå–åœ°å€æ“ä½œçš„ï¼Œå› æ­¤varå¼•ç”¨çš„å…¶å®æ˜¯è¿™ä¸ªä¸´æ—¶å˜é‡ï¼Œç›¸å½“äºä¸‹é¢çš„æ“ä½œï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>var <span class="token operator">=</span> temp<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ ¹æ®ä¸Šè¿°åˆ†æï¼Œå¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š</p><ul><li>å·¦å€¼å¼•ç”¨è¦æ±‚å³è¾¹çš„å€¼å¿…é¡»èƒ½å¤Ÿå–åœ°å€ï¼Œå¦‚æœæ— æ³•å–åœ°å€ï¼Œå¯ä»¥ç”¨å¸¸å¼•ç”¨ï¼›<br>ä½†ä½¿ç”¨å¸¸å¼•ç”¨åï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡å¼•ç”¨æ¥è¯»å–æ•°æ®ï¼Œæ— æ³•å»ä¿®æ”¹æ•°æ®ï¼Œå› ä¸ºå…¶è¢«constä¿®é¥°æˆå¸¸é‡å¼•ç”¨äº†ã€‚</li></ul><h3 id="å³å€¼å¼•ç”¨"><a href="#å³å€¼å¼•ç”¨" class="headerlink" title="å³å€¼å¼•ç”¨"></a>å³å€¼å¼•ç”¨</h3><p>C++11 å¼•å…¥äº†å³å€¼å¼•ç”¨çš„æ¦‚å¿µï¼Œå¯ä»¥å¾ˆå¥½è§£å†³å¼•ç”¨ä¸€ä¸ªå¸¸æ•°çš„é—®é¢˜ï¼Œå…·ä½“ä½¿ç”¨ä¾‹å­å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token operator">&amp;&amp;</span>ref_a_right <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// ok</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token operator">&amp;&amp;</span>ref_a_left <span class="token operator">=</span> a<span class="token punctuation">;</span> <span class="token comment">// ç¼–è¯‘ä¸è¿‡ï¼Œå³å€¼å¼•ç”¨ä¸å¯ä»¥æŒ‡å‘å·¦å€¼</span> ref_a_right <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">// å³å€¼å¼•ç”¨çš„ç”¨é€”ï¼šå¯ä»¥ä¿®æ”¹å³å€¼</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‚£ä¹ˆå³å€¼å¼•ç”¨å¯ä»¥æŒ‡å‘å·¦å€¼å—ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œåªè¦ä½¿ç”¨<code>std::move()</code>å°±å¯ä»¥äº†</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// aæ˜¯ä¸ªå·¦å€¼</span><span class="token keyword">int</span> <span class="token operator">&amp;</span>ref_a_left <span class="token operator">=</span> a<span class="token punctuation">;</span> <span class="token comment">// å·¦å€¼å¼•ç”¨æŒ‡å‘å·¦å€¼</span><span class="token keyword">int</span> <span class="token operator">&amp;&amp;</span>ref_a_right <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é€šè¿‡std::moveå°†å·¦å€¼è½¬åŒ–ä¸ºå³å€¼ï¼Œå¯ä»¥è¢«å³å€¼å¼•ç”¨æŒ‡å‘</span> cout <span class="token operator">&lt;&lt;</span> a<span class="token punctuation">;</span> <span class="token comment">// æ‰“å°ç»“æœï¼š5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ä¸Šè¾¹çš„ä»£ç é‡Œï¼Œçœ‹ä¸Šå»æ˜¯å·¦å€¼aé€šè¿‡std::moveç§»åŠ¨åˆ°äº†å³å€¼ref_a_rightä¸­ï¼Œé‚£æ˜¯ä¸æ˜¯aé‡Œè¾¹å°±æ²¡æœ‰å€¼äº†ï¼Ÿå¹¶ä¸æ˜¯ï¼Œæ‰“å°å‡ºaçš„å€¼ä»ç„¶æ˜¯5ã€‚</p><p><code>std::move</code>æ˜¯ä¸€ä¸ªéå¸¸æœ‰è¿·æƒ‘æ€§çš„å‡½æ•°ï¼Œä¸ç†è§£å·¦å³å€¼æ¦‚å¿µçš„äººä»¬å¾€å¾€ä»¥ä¸ºå®ƒèƒ½æŠŠä¸€ä¸ªå˜é‡é‡Œçš„å†…å®¹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªå˜é‡ï¼Œ<strong>ä½†äº‹å®ä¸Šstd::moveç§»åŠ¨ä¸äº†ä»€ä¹ˆï¼Œå”¯ä¸€çš„åŠŸèƒ½æ˜¯æŠŠå·¦å€¼å¼ºåˆ¶è½¬åŒ–ä¸ºå³å€¼</strong>ï¼Œè®©å³å€¼å¼•ç”¨å¯ä»¥æŒ‡å‘å·¦å€¼ã€‚å…¶å®ç°ç­‰åŒäºä¸€ä¸ªç±»å‹è½¬æ¢ï¼š<code>static_cast&lt;T&amp;&amp;&gt;(lvalue)</code>ã€‚ æ‰€ä»¥ï¼Œ<strong>å•çº¯çš„std::move(xxx)ä¸ä¼šæœ‰æ€§èƒ½æå‡</strong>ï¼Œstd::moveçš„ä½¿ç”¨åœºæ™¯åœ¨ç¬¬ä¸‰ç« ä¼šè®²ã€‚</p><p>åŒæ ·çš„ï¼Œå³å€¼å¼•ç”¨èƒ½æŒ‡å‘å³å€¼ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯æŠŠå³å€¼æå‡ä¸ºä¸€ä¸ªå·¦å€¼ï¼Œå¹¶å®šä¹‰ä¸€ä¸ªå³å€¼å¼•ç”¨é€šè¿‡std::moveæŒ‡å‘è¯¥å·¦å€¼ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token operator">&amp;&amp;</span>ref_a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>ref_a <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>  <span class="token comment">//ç­‰åŒäºä»¥ä¸‹ä»£ç ï¼š</span> <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token operator">&amp;&amp;</span>ref_a <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>ref_a <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="C-å¤šæ€"><a href="#C-å¤šæ€" class="headerlink" title="C++å¤šæ€"></a>C++å¤šæ€</h2><h2 id="æ™ºèƒ½æŒ‡é’ˆ"><a href="#æ™ºèƒ½æŒ‡é’ˆ" class="headerlink" title="æ™ºèƒ½æŒ‡é’ˆ"></a>æ™ºèƒ½æŒ‡é’ˆ</h2><hr><h1 id="æ“ä½œç³»ç»ŸçŸ¥è¯†"><a href="#æ“ä½œç³»ç»ŸçŸ¥è¯†" class="headerlink" title="æ“ä½œç³»ç»ŸçŸ¥è¯†"></a>æ“ä½œç³»ç»ŸçŸ¥è¯†</h1><h2 id="çº¿ç¨‹çš„åŒæ­¥å’Œäº’æ–¥"><a href="#çº¿ç¨‹çš„åŒæ­¥å’Œäº’æ–¥" class="headerlink" title="çº¿ç¨‹çš„åŒæ­¥å’Œäº’æ–¥"></a>çº¿ç¨‹çš„åŒæ­¥å’Œäº’æ–¥</h2><p>çº¿ç¨‹çš„åŒæ­¥ï¼šæŒ‡å¤šçº¿ç¨‹é€šè¿‡ç‰¹å®šçš„æ‰‹æ®µï¼ˆå¦‚äº’æ–¥é‡ï¼‰æ¥æ§åˆ¶çº¿ç¨‹ä¹‹é—´çš„æ‰§è¡Œé¡ºåºã€‚</p><p>çº¿ç¨‹çš„äº’æ–¥ï¼šå®æŒ‡å¯¹å…±äº«èµ„æºçš„çº¦æŸè®¿é—®ã€‚å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼ŒæŸäº›èµ„æºåªå…è®¸ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œè¿™ç±»èµ„æºæˆä¸ºä¸´ç•Œèµ„æºï¼Œçº¿ç¨‹ä¹‹é—´çš„å…³ç³»å°±è¡¨ç°ä¸ºäº’æ–¥çš„ã€‚</p><p>çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥å’Œäº’æ–¥æ˜¯é€šè¿‡æ“ä½œç³»ç»Ÿçš„ä¿¡å·é‡å’Œ PV æ“ä½œåŸè¯­æ¥å®ç°çš„ã€‚</p><h3 id="ä¿¡å·é‡"><a href="#ä¿¡å·é‡" class="headerlink" title="ä¿¡å·é‡"></a>ä¿¡å·é‡</h3><p>POSIXä¿¡å·é‡æ˜¯æ“ä½œç³»ç»Ÿä¸­æ‰€ç”¨åˆ°çš„PVåŸå­æ“ä½œï¼Œå®ƒå¹¿æ³›ç”¨äºè¿›ç¨‹æˆ–çº¿ç¨‹é—´çš„åŒæ­¥ä¸äº’æ–¥ã€‚<br> ä¿¡å·é‡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªéè´Ÿçš„æ•´æ•°è®¡æ•°å™¨ï¼Œå®ƒè¢«ç”¨æ¥æ§åˆ¶å¯¹å…¬å…±èµ„æºçš„è®¿é—®ã€‚</p><ul><li>PVåŸå­æ“ä½œæ˜¯å¯¹éè´Ÿæ•´æ•°ä¿¡å·é‡semçš„æ“ä½œ<ul><li>Pæ“ä½œ<br> åˆ¤æ–­semæ˜¯å¦å¤§äº0<br> å¦‚æœæ˜¯å°±æ‰§è¡Œsem=sem-1;è®¿é—®èµ„æº<br> å¦åˆ™å°±é˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°semå¤§äº0ä¸ºæ­¢</li><li>Væ“ä½œ<br> åˆ¤æ–­åœ¨è¯¥ä¿¡å·é‡é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰è¢«é˜»å¡çš„çº¿ç¨‹<br> å¦‚æœæœ‰å°±å”¤é†’æ’åœ¨ç¬¬ä¸€çš„é˜»å¡çº¿ç¨‹ï¼Œsem=sem+1<br> å¦åˆ™å°±åªæ‰§è¡Œsem=sem+1;</li></ul></li></ul><p><strong>ä¿¡å·é‡</strong>å…·ä½“å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//ç”¨äºåˆ›å»ºä¸€ä¸ªä¿¡å·é‡ï¼Œå¹¶åˆå§‹åŒ–å®ƒçš„å€¼ã€‚</span><span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//å’Œsem_trywait()éƒ½ç›¸å½“äºPæ“ä½œï¼Œåœ¨ä¿¡å·é‡å¤§äºé›¶æ—¶å®ƒä»¬éƒ½èƒ½å°†ä¿¡å·é‡çš„å€¼å‡ä¸€ï¼Œä¸¤è€…çš„åŒºåˆ«åœ¨äºè‹¥ä¿¡å·é‡ç­‰äºé›¶æ—¶sem_wait()å°†ä¼šé˜»å¡è¿›ç¨‹ï¼Œè€Œsem_trywait()//åˆ™ä¼šç«‹å³è¿”å›ã€‚</span><span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//ç›¸å½“äºVæ“ä½œï¼Œå®ƒå°†ä¿¡å·é‡çš„å€¼åŠ ä¸€åŒæ—¶å‘å‡ºä¿¡å·æ¥å”¤é†’ç­‰å¾…çš„è¿›ç¨‹ã€‚</span><span class="token function">sem_getvalue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//ç”¨äºå¾—åˆ°ä¿¡å·é‡çš„å€¼ã€‚</span><span class="token function">sem_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//ç”¨äºåˆ é™¤ä¿¡å·é‡ã€‚ </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://pic.rmb.bdstatic.com/bjh/651f351873bdca8bc50b4125d52868a0.png" alt="24464153-930a226a5fb88edb.png"></p><p><img src="https://pic.rmb.bdstatic.com/bjh/757c00d008d7423d50835a92a917d68a.png" alt="24464153-6443a6caaa02bce4.png"></p><h3 id="äº’æ–¥é”"><a href="#äº’æ–¥é”" class="headerlink" title="äº’æ–¥é”"></a>äº’æ–¥é”</h3><ul><li>äº’æ–¥é”æ˜¯ç”¨ä¸€ç§ç®€å•çš„åŠ é”æ–¹æ³•æ¥æ§åˆ¶å¯¹å…±äº«èµ„æºçš„åŸå­æ“ä½œã€‚</li><li>äº’æ–¥é”åªæœ‰ä¸¤ç§çŠ¶æ€ï¼šä¸Šé”å’Œè§£é”ã€‚</li><li>åœ¨åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæ¡æŸä¸ªäº’æ–¥é”ï¼Œæ‹¥æœ‰ä¸Šé”çŠ¶æ€çš„çº¿ç¨‹èƒ½å¤Ÿå¯¹å…±äº«èµ„æºè¿›è¡Œæ“ä½œã€‚è‹¥å…¶ä»–çº¿ç¨‹å¸Œæœ›ä¸Šé”ä¸€ä¸ªå·²ç»è¢«ä¸Šé”çš„äº’æ–¥é”ï¼Œåˆ™è¯¥çº¿ç¨‹å°±ä¼šæŒ‚èµ·ï¼Œç›´åˆ°ä¸Šé”çš„çº¿ç¨‹é‡Šæ”¾æ‰äº’æ–¥é”ä¸ºæ­¢ã€‚</li><li>è¿™æŠŠäº’æ–¥é”ä¿è¯è®©æ¯ä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºæŒ‰é¡ºåºè¿›è¡ŒåŸå­æ“ä½œã€‚</li><li>äº’æ–¥é”æœºåˆ¶ä¸»è¦åŒ…æ‹¬ä¸‹é¢çš„åŸºæœ¬å‡½æ•°ã€‚</li></ul><p>äº’æ–¥é”å…·ä½“çš„å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><p><img src="https://i0.hdslb.com/bfs/album/f5497ff37325869457dc0afc87b33ff881021a37.png"></p><p><img src="https://i0.hdslb.com/bfs/album/377e0f4fd75656ce169dc8661d8b08753834d5d3.png"></p><p>å‡½æ•°<code>pthread_mutex_trylock</code>æ˜¯<code>pthread_mutex_lock</code>çš„éé˜»å¡ç‰ˆæœ¬ï¼Œè¡¨ç¤ºå°è¯•åŠ é”ï¼Œå¦‚æœè¯¥äº’æ–¥é”å·²ç»é”å®šï¼Œåˆ™è¿”å›ä¸€ä¸ªä¸ä¸º0çš„é”™è¯¯å€¼ï¼Œå¦‚æœè¯¥äº’æ–¥é”æ²¡æœ‰é”å®šï¼Œåˆ™è¿”å›0ï¼Œè¡¨ç¤ºå°è¯•åŠ é”æˆåŠŸ</p><ul><li>äº’æ–¥é”å¯ä»¥åˆ†ä¸ºå¿«é€Ÿäº’æ–¥é”ã€é€’å½’äº’æ–¥é”å’Œæ£€é”™äº’æ–¥é”ã€‚<br> 1.å¿«é€Ÿé”æ˜¯æŒ‡è°ƒç”¨çº¿ç¨‹ä¼šé˜»å¡ç›´è‡³æ‹¥æœ‰äº’æ–¥é”çš„çº¿ç¨‹è§£é”ä¸ºæ­¢ã€‚<br> 2.é€’å½’äº’æ–¥é”èƒ½å¤ŸæˆåŠŸåœ°è¿”å›ï¼Œå¹¶ä¸”å¢åŠ è°ƒç”¨çº¿ç¨‹åœ¨äº’æ–¥ä¸ŠåŠ é”çš„æ¬¡æ•°ã€‚<br> 3.æ£€é”™äº’æ–¥é”åˆ™ä¸ºå¿«é€Ÿäº’æ–¥é”çš„éé˜»å¡ç‰ˆæœ¬ï¼Œå®ƒä¼šç«‹å³è¿”å›å¹¶è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯ã€‚<br> é»˜è®¤å±æ€§ä¸ºå¿«é€Ÿäº’æ–¥é”ã€‚</li><li>è¿™ä¸‰ç§é”çš„åŒºåˆ«ä¸»è¦åœ¨äºå…¶ä»–æœªå æœ‰äº’æ–¥é”çš„çº¿ç¨‹åœ¨å¸Œæœ›å¾—åˆ°äº’æ–¥é”æ—¶æ˜¯å¦éœ€è¦é˜»å¡ç­‰å¾…ã€‚</li></ul><h3 id="æ¡ä»¶å˜é‡"><a href="#æ¡ä»¶å˜é‡" class="headerlink" title="æ¡ä»¶å˜é‡"></a>æ¡ä»¶å˜é‡</h3><p>ä»€ä¹ˆæ˜¯æ¡ä»¶å˜é‡ï¼Ÿ</p><p>å½“ä¸€ä¸ªçº¿ç¨‹äº’æ–¥åœ°è®¿é—®æŸä¸ªå˜é‡æ—¶ï¼Œå®ƒå¯èƒ½å‘ç°åœ¨å…¶å®ƒçº¿ç¨‹æ”¹å˜çŠ¶æ€ä¹‹å‰ï¼Œå®ƒä»€ä¹ˆä¹Ÿåšä¸äº†ã€‚æ­¤æ—¶è‹¥è¯¥çº¿ç¨‹éé˜»å¡è½®è¯¢æ£€æµ‹æ¡ä»¶æ˜¯å¦æ»¡è¶³ä¸åˆç†ï¼Œå¼•å…¥æ¡ä»¶å˜é‡ï¼Œå¯ä»¥åœ¨æ¡ä»¶æ»¡è¶³å”¤é†’è¯¥çº¿ç¨‹ã€‚</p><p>æ¡ä»¶å˜é‡æ˜¯å®ç°åŒæ­¥çš„å·¥å…·</p><p>åŸç”Ÿçº¿ç¨‹åº“æä¾›æè¿°ä¸´ç•Œèµ„æºçŠ¶æ€çš„ä¸€ä¸ªå¯¹è±¡ã€‚ä¹‹å‰åœ¨ä¸æ–­ç”³è¯·é”ï¼Œæ£€æµ‹é”ï¼Œæ­£æ˜¯å› ä¸ºä¸çŸ¥é“ä¸´ç•Œèµ„æºçš„çŠ¶æ€ï¼Œè¿™æ˜¯ä¸€ç§è½®è¯¢çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯ååˆ†æ¶ˆè€—cpuèµ„æºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡æŸç§æ‰‹æ®µç›´åˆ°ä¸´ç•Œèµ„æºçš„çŠ¶æ€â€“æ¡ä»¶å˜é‡ã€‚</p><p>å³é€šè¿‡ä¸€ç§æœºåˆ¶æé†’åœ¨æ¡ä»¶å˜é‡ä¸‹ç­‰çš„æ˜¯å¦æœ‰èµ„æºäº†ã€‚æœ‰èµ„æºå°±å°†åœ¨æ¡ä»¶å˜é‡ä¸‹çš„çº¿ç¨‹å”¤é†’å³å¯ã€‚ç›¸å½“äºä¸€ä¸ªé“ƒé“›ã€‚</p><p>æ¡ä»¶å˜é‡ä¸ºä½•è¦æ­é…äº’æ–¥é‡ä½¿ç”¨ï¼Ÿ</p><ul><li>æ¡ä»¶ç­‰å¾…æ˜¯çº¿ç¨‹é—´åŒæ­¥çš„ä¸€ç§æ‰‹æ®µï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¡ä»¶ä¸æ»¡è¶³ï¼Œä¸€ç›´ç­‰ä¸‹å»éƒ½ä¸ä¼šæ»¡è¶³ï¼Œæ‰€ä»¥å¿…é¡»è¦æœ‰ä¸€ä¸ªçº¿ç¨‹é€šè¿‡æŸäº›æ“ä½œï¼Œæ”¹å˜å…±äº«å˜é‡ï¼Œä½¿åŸå…ˆä¸æ»¡è¶³çš„æ¡ä»¶å˜å¾—æ»¡è¶³ï¼Œå¹¶ä¸”å‹å¥½çš„é€šçŸ¥ç­‰å¾…åœ¨æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹ã€‚</li><li>æ¡ä»¶ä¸ä¼šæ— ç¼˜æ— æ•…çš„çªç„¶å˜å¾—æ»¡è¶³äº†ï¼Œå¿…ç„¶ä¼šç‰µæ‰¯åˆ°å…±äº«æ•°æ®çš„å˜åŒ–ã€‚æ‰€ä»¥ä¸€å®šè¦ç”¨äº’æ–¥é”æ¥ä¿æŠ¤ã€‚æ²¡æœ‰äº’æ–¥é”å°±æ— æ³•å®‰å…¨çš„è·å–å’Œä¿®æ”¹å…±äº«æ•°æ®ã€‚</li><li>pthread_cond_waitè¿›å…¥è¯¥å‡½æ•°åï¼Œä¼šå»çœ‹æ¡ä»¶å˜é‡ç­‰äº0ä¸ï¼Ÿç­‰äºï¼Œå°±æŠŠäº’æ–¥é‡å˜æˆ1ï¼Œç›´åˆ°cond_ waitè¿”å›ï¼ŒæŠŠæ¡ä»¶é‡æ”¹æˆ1ï¼ŒæŠŠäº’æ–¥é‡æ¢å¤æˆåŸæ ·ã€‚è¯´ç™½å°±æ˜¯æ¡ä»¶ä¸æ»¡è¶³ä¼šä¸»åŠ¨é‡Šæ”¾é”ï¼Œåœ¨æ¡ä»¶å˜é‡ä¸‹ç­‰å¾…ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³å¹¶ä¸”é‡æ–°è·å–é”ï¼ï¼</li></ul><p>æ¡ä»¶å˜é‡çš„å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// åˆå§‹åŒ–ä¸€ä¸ªæ¡ä»¶å˜é‡</span><span class="token keyword">int</span> <span class="token function">pthread_cond_init</span><span class="token punctuation">(</span>pthread_cond_t <span class="token operator">*</span>restrict cond<span class="token punctuation">,</span>    <span class="token keyword">const</span> pthread_condattr_t <span class="token operator">*</span>restrict attr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// é‡Šæ”¾ä¸€ä¸ªæ¡ä»¶å˜é‡</span><span class="token keyword">int</span> <span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span>pthread_cond_t <span class="token operator">*</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ç­‰å¾…æ¡ä»¶æ»¡è¶³</span><span class="token keyword">int</span> <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span>pthread_cond_t <span class="token operator">*</span>restrict cond<span class="token punctuation">,</span>    pthread_mutex_t <span class="token operator">*</span>restrict mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å”¤é†’è‡³å°‘ä¸€ä¸ªç­‰å¾…æ¡ä»¶çš„çº¿ç¨‹</span><span class="token keyword">int</span> <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span>pthread_cond_t <span class="token operator">*</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å”¤é†’æ‰€æœ‰ç­‰å¾…æ¡ä»¶çš„çº¿ç¨‹</span><span class="token keyword">int</span> <span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span>pthread_cond_t <span class="token operator">*</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼ˆä½¿ç”¨äº†äº’æ–¥é”å’Œæ¡ä»¶å˜é‡æ¥å®Œæˆï¼‰"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼ˆä½¿ç”¨äº†äº’æ–¥é”å’Œæ¡ä»¶å˜é‡æ¥å®Œæˆï¼‰" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼ˆä½¿ç”¨äº†äº’æ–¥é”å’Œæ¡ä»¶å˜é‡æ¥å®Œæˆï¼‰"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼ˆä½¿ç”¨äº†äº’æ–¥é”å’Œæ¡ä»¶å˜é‡æ¥å®Œæˆï¼‰</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token comment">// æ¶ˆæ¯ç»“æ„</span><span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>    <span class="token keyword">int</span> data<span class="token punctuation">;</span>       <span class="token comment">// æ¶ˆæ¯æ•°æ®</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token operator">*</span>queue<span class="token punctuation">;</span>  <span class="token comment">// æ¶ˆæ¯é˜Ÿåˆ—</span>pthread_cond_t qcond <span class="token operator">=</span> PTHREAD_COND_INITIALIZER<span class="token punctuation">;</span>    <span class="token comment">// ç®€åŒ–åˆå§‹åŒ–æ¡ä»¶å˜é‡å’Œäº’æ–¥ä½“</span>pthread_mutex_t qlock <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span><span class="token comment">// éšæœºæ•°èŒƒå›´[mi, ma]</span><span class="token keyword">int</span> <span class="token function">randint</span><span class="token punctuation">(</span><span class="token keyword">int</span> mi<span class="token punctuation">,</span> <span class="token keyword">int</span> ma<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">double</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>RAND_MAX <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">*=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ma <span class="token operator">-</span> mi<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>r <span class="token operator">+</span> mi<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ‰“å°æ¶ˆæ¯</span><span class="token keyword">void</span> <span class="token function">print_msg</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token operator">*</span>m<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">">>>>msg: %d\n"</span><span class="token punctuation">,</span> m<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å‹å…¥æ¶ˆæ¯</span><span class="token keyword">void</span> <span class="token function">push_msg</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token operator">*</span>m<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>qlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    m<span class="token operator">-></span>next <span class="token operator">=</span> queue<span class="token punctuation">;</span>    queue <span class="token operator">=</span> m<span class="token punctuation">;</span>    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>qlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// é€šçŸ¥æ¡ä»¶æ»¡è¶³</span>    <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>qcond<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// ç”Ÿäº§è€…çº¿ç¨‹ï¼š</span><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">product</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token function">randint</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token operator">*</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token operator">*</span>m <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">memset</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token function">randint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">push_msg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¼¹å‡ºæ¶ˆæ¯</span><span class="token keyword">struct</span> <span class="token class-name">msg</span><span class="token operator">*</span> <span class="token function">pop_msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token operator">*</span>m<span class="token punctuation">;</span>    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>qlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ç­‰å¾…æ¡ä»¶æ»¡è¶³</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>queue <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>qcond<span class="token punctuation">,</span> <span class="token operator">&amp;</span>qlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    m <span class="token operator">=</span> queue<span class="token punctuation">;</span>    queue <span class="token operator">=</span> m<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>qlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> m<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ¶ˆè´¹è€…çº¿ç¨‹</span><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">consum</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">whlie</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token operator">*</span>m <span class="token operator">=</span> <span class="token function">pop_msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">print_msg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">free</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PRO_NUM</span> <span class="token expression"><span class="token number">3</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CON_NUM</span> <span class="token expression"><span class="token number">3</span></span></span>    pthread_t tid_p<span class="token punctuation">[</span>PRO_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>    pthread_t tid_c<span class="token punctuation">[</span>CON_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> PRO_NUM<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid_p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> product<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> CON_NUM<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid_c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> consum<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> PRO_NUM<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid_p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> CON_NUM<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid_c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h1 id="è®¾è®¡æ¨¡å¼é—®é¢˜"><a href="#è®¾è®¡æ¨¡å¼é—®é¢˜" class="headerlink" title="è®¾è®¡æ¨¡å¼é—®é¢˜"></a>è®¾è®¡æ¨¡å¼é—®é¢˜</h1><h2 id="è§‚å¯Ÿè€…æ¨¡å¼"><a href="#è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h2><p>å½“å¯¹è±¡é—´å­˜åœ¨ä¸€å¯¹å¤šå…³ç³»æ—¶ï¼Œåˆ™ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰ã€‚æ¯”å¦‚ï¼Œå½“ä¸€ä¸ªå¯¹è±¡è¢«ä¿®æ”¹æ—¶ï¼Œåˆ™ä¼šè‡ªåŠ¨é€šçŸ¥ä¾èµ–å®ƒçš„å¯¹è±¡ã€‚è§‚å¯Ÿè€…æ¨¡å¼å±äºè¡Œä¸ºå‹æ¨¡å¼ã€‚</p><p><strong>æ„å›¾ï¼š</strong>å®šä¹‰å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è¢«è‡ªåŠ¨æ›´æ–°ã€‚</p><p><strong>ä¸»è¦è§£å†³ï¼š</strong>ä¸€ä¸ªå¯¹è±¡çŠ¶æ€æ”¹å˜ç»™å…¶ä»–å¯¹è±¡é€šçŸ¥çš„é—®é¢˜ï¼Œè€Œä¸”è¦è€ƒè™‘åˆ°æ˜“ç”¨å’Œä½è€¦åˆï¼Œä¿è¯é«˜åº¦çš„åä½œã€‚</p><p><strong>ä½•æ—¶ä½¿ç”¨ï¼š</strong>ä¸€ä¸ªå¯¹è±¡ï¼ˆç›®æ ‡å¯¹è±¡ï¼‰çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œæ‰€æœ‰çš„ä¾èµ–å¯¹è±¡ï¼ˆè§‚å¯Ÿè€…å¯¹è±¡ï¼‰éƒ½å°†å¾—åˆ°é€šçŸ¥ï¼Œè¿›è¡Œå¹¿æ’­é€šçŸ¥ã€‚</p><p><strong>å¦‚ä½•è§£å†³ï¼š</strong>ä½¿ç”¨é¢å‘å¯¹è±¡æŠ€æœ¯ï¼Œå¯ä»¥å°†è¿™ç§ä¾èµ–å…³ç³»å¼±åŒ–ã€‚</p><p><strong>åº”ç”¨å®ä¾‹ï¼š</strong> 1ã€æ‹å–çš„æ—¶å€™ï¼Œæ‹å–å¸ˆè§‚å¯Ÿæœ€é«˜æ ‡ä»·ï¼Œç„¶åé€šçŸ¥ç»™å…¶ä»–ç«ä»·è€…ç«ä»·ã€‚ 2ã€è¥¿æ¸¸è®°é‡Œé¢æ‚Ÿç©ºè¯·æ±‚è©è¨é™æœçº¢å­©å„¿ï¼Œè©è¨æ´’äº†ä¸€åœ°æ°´æ‹›æ¥ä¸€ä¸ªè€ä¹Œé¾Ÿï¼Œè¿™ä¸ªä¹Œé¾Ÿå°±æ˜¯è§‚å¯Ÿè€…ï¼Œä»–è§‚å¯Ÿè©è¨æ´’æ°´è¿™ä¸ªåŠ¨ä½œã€‚</p><p><strong>ä¼˜ç‚¹ï¼š</strong> 1ã€è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…æ˜¯æŠ½è±¡è€¦åˆçš„ã€‚ 2ã€å»ºç«‹ä¸€å¥—è§¦å‘æœºåˆ¶ã€‚</p><p><strong>ç¼ºç‚¹ï¼š</strong> 1ã€å¦‚æœä¸€ä¸ªè¢«è§‚å¯Ÿè€…å¯¹è±¡æœ‰å¾ˆå¤šçš„ç›´æ¥å’Œé—´æ¥çš„è§‚å¯Ÿè€…çš„è¯ï¼Œå°†æ‰€æœ‰çš„è§‚å¯Ÿè€…éƒ½é€šçŸ¥åˆ°ä¼šèŠ±è´¹å¾ˆå¤šæ—¶é—´ã€‚ 2ã€å¦‚æœåœ¨è§‚å¯Ÿè€…å’Œè§‚å¯Ÿç›®æ ‡ä¹‹é—´æœ‰å¾ªç¯ä¾èµ–çš„è¯ï¼Œè§‚å¯Ÿç›®æ ‡ä¼šè§¦å‘å®ƒä»¬ä¹‹é—´è¿›è¡Œå¾ªç¯è°ƒç”¨ï¼Œå¯èƒ½å¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚ 3ã€è§‚å¯Ÿè€…æ¨¡å¼æ²¡æœ‰ç›¸åº”çš„æœºåˆ¶è®©è§‚å¯Ÿè€…çŸ¥é“æ‰€è§‚å¯Ÿçš„ç›®æ ‡å¯¹è±¡æ˜¯æ€ä¹ˆå‘ç”Ÿå˜åŒ–çš„ï¼Œè€Œä»…ä»…åªæ˜¯çŸ¥é“è§‚å¯Ÿç›®æ ‡å‘ç”Ÿäº†å˜åŒ–ã€‚</p><p><strong>ä½¿ç”¨åœºæ™¯ï¼š</strong></p><ul><li>ä¸€ä¸ªæŠ½è±¡æ¨¡å‹æœ‰ä¸¤ä¸ªæ–¹é¢ï¼Œå…¶ä¸­ä¸€ä¸ªæ–¹é¢ä¾èµ–äºå¦ä¸€ä¸ªæ–¹é¢ã€‚å°†è¿™äº›æ–¹é¢å°è£…åœ¨ç‹¬ç«‹çš„å¯¹è±¡ä¸­ä½¿å®ƒä»¬å¯ä»¥å„è‡ªç‹¬ç«‹åœ°æ”¹å˜å’Œå¤ç”¨ã€‚</li><li>ä¸€ä¸ªå¯¹è±¡çš„æ”¹å˜å°†å¯¼è‡´å…¶ä»–ä¸€ä¸ªæˆ–å¤šä¸ªå¯¹è±¡ä¹Ÿå‘ç”Ÿæ”¹å˜ï¼Œè€Œä¸çŸ¥é“å…·ä½“æœ‰å¤šå°‘å¯¹è±¡å°†å‘ç”Ÿæ”¹å˜ï¼Œå¯ä»¥é™ä½å¯¹è±¡ä¹‹é—´çš„è€¦åˆåº¦ã€‚</li><li>ä¸€ä¸ªå¯¹è±¡å¿…é¡»é€šçŸ¥å…¶ä»–å¯¹è±¡ï¼Œè€Œå¹¶ä¸çŸ¥é“è¿™äº›å¯¹è±¡æ˜¯è°ã€‚</li><li>éœ€è¦åœ¨ç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªè§¦å‘é“¾ï¼ŒAå¯¹è±¡çš„è¡Œä¸ºå°†å½±å“Bå¯¹è±¡ï¼ŒBå¯¹è±¡çš„è¡Œä¸ºå°†å½±å“Cå¯¹è±¡â€¦â€¦ï¼Œå¯ä»¥ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼åˆ›å»ºä¸€ç§é“¾å¼è§¦å‘æœºåˆ¶ã€‚</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//è§‚å¯Ÿè€…æ¨¡å¼</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Observer</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Subject</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Attach</span><span class="token punctuation">(</span>Observer<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Detach</span><span class="token punctuation">(</span>Observer<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">newSubject</span><span class="token operator">:</span><span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Subject</span></span><span class="token punctuation">&#123;</span><span class="token keyword">private</span><span class="token operator">:</span>    list<span class="token operator">&lt;</span>Observer<span class="token operator">*</span><span class="token operator">></span> ObserverList<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_state<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">newSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">m_state</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">Attach</span><span class="token punctuation">(</span>Observer<span class="token operator">*</span> obs<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        ObserverList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>obs<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">Detach</span><span class="token punctuation">(</span>Observer<span class="token operator">*</span> obs<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        ObserverList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>obs<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">Notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span> iter<span class="token operator">:</span>ObserverList<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            iter<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>m_state<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"å‘é€é€šçŸ¥å®Œæˆï¼ï¼ˆ%dï¼‰\n"</span><span class="token punctuation">,</span>m_state<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">SetState</span><span class="token punctuation">(</span><span class="token keyword">int</span> newState<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_state<span class="token operator">=</span>newState<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">newObserver</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Observer</span></span><span class="token punctuation">&#123;</span><span class="token keyword">private</span><span class="token operator">:</span>    string m_name<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_state<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">newObserver</span><span class="token punctuation">(</span>string name<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">m_name</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_state</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token operator">-></span>m_state<span class="token operator">=</span>state<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>m_state<span class="token operator">==</span><span class="token number">200</span><span class="token punctuation">)</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%sï¼šæ”¶åˆ°äº†é€šçŸ¥ï¼ï¼ˆ%dï¼‰\n"</span><span class="token punctuation">,</span>m_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>m_state<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    newObserver<span class="token operator">*</span> zhangsan<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">newObserver</span><span class="token punctuation">(</span><span class="token string">"å¼ ä¸‰"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    newObserver<span class="token operator">*</span> lisi<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">newObserver</span><span class="token punctuation">(</span><span class="token string">"æå››"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    newObserver<span class="token operator">*</span> wangwu<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">newObserver</span><span class="token punctuation">(</span><span class="token string">"ç‹äº”"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    newObserver<span class="token operator">*</span> zhaoliu<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">newObserver</span><span class="token punctuation">(</span><span class="token string">"èµµå…­"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    newSubject<span class="token operator">*</span> Alibaba<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">newSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Alibaba<span class="token operator">-></span><span class="token function">Attach</span><span class="token punctuation">(</span>zhangsan<span class="token punctuation">)</span><span class="token punctuation">;</span>    Alibaba<span class="token operator">-></span><span class="token function">Attach</span><span class="token punctuation">(</span>lisi<span class="token punctuation">)</span><span class="token punctuation">;</span>    Alibaba<span class="token operator">-></span><span class="token function">Attach</span><span class="token punctuation">(</span>wangwu<span class="token punctuation">)</span><span class="token punctuation">;</span>    Alibaba<span class="token operator">-></span><span class="token function">Attach</span><span class="token punctuation">(</span>zhaoliu<span class="token punctuation">)</span><span class="token punctuation">;</span>    Alibaba<span class="token operator">-></span><span class="token function">SetState</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Alibaba<span class="token operator">-></span><span class="token function">Notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Alibaba<span class="token operator">-></span><span class="token function">SetState</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Alibaba<span class="token operator">-></span><span class="token function">Notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">delete</span> zhangsan<span class="token punctuation">;</span>    <span class="token keyword">delete</span> lisi<span class="token punctuation">;</span>    <span class="token keyword">delete</span> wangwu<span class="token punctuation">;</span>    <span class="token keyword">delete</span> zhaoliu<span class="token punctuation">;</span>    <span class="token keyword">delete</span> Alibaba<span class="token punctuation">;</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h2><p>å•ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰æ˜¯æœ€ç®€å•çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ã€‚è¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºåˆ›å»ºå‹æ¨¡å¼ï¼Œå®ƒæä¾›äº†ä¸€ç§åˆ›å»ºå¯¹è±¡çš„æœ€ä½³æ–¹å¼ã€‚</p><p>è¿™ç§æ¨¡å¼æ¶‰åŠåˆ°ä¸€ä¸ªå•ä¸€çš„ç±»ï¼Œè¯¥ç±»è´Ÿè´£åˆ›å»ºè‡ªå·±çš„å¯¹è±¡ï¼ŒåŒæ—¶ç¡®ä¿åªæœ‰å•ä¸ªå¯¹è±¡è¢«åˆ›å»ºã€‚è¿™ä¸ªç±»æä¾›äº†ä¸€ç§è®¿é—®å…¶å”¯ä¸€çš„å¯¹è±¡çš„æ–¹å¼ï¼Œå¯ä»¥ç›´æ¥è®¿é—®ï¼Œä¸éœ€è¦å®ä¾‹åŒ–è¯¥ç±»çš„å¯¹è±¡ã€‚</p><p><strong>æ³¨æ„ï¼š</strong></p><ul><li>1ã€å•ä¾‹ç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ã€‚</li><li>2ã€å•ä¾‹ç±»å¿…é¡»è‡ªå·±åˆ›å»ºè‡ªå·±çš„å”¯ä¸€å®ä¾‹ã€‚</li><li>3ã€å•ä¾‹ç±»å¿…é¡»ç»™æ‰€æœ‰å…¶ä»–å¯¹è±¡æä¾›è¿™ä¸€å®ä¾‹ã€‚</li></ul><p><strong>æ„å›¾ï¼š</strong>ä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹ã€‚</p><p><strong>ä¸»è¦è§£å†³ï¼š</strong>ä¸€ä¸ªå…¨å±€ä½¿ç”¨çš„ç±»é¢‘ç¹åœ°åˆ›å»ºä¸é”€æ¯ã€‚</p><p><strong>ä½•æ—¶ä½¿ç”¨ï¼š</strong>å½“æ‚¨æƒ³æ§åˆ¶å®ä¾‹æ•°ç›®ï¼ŒèŠ‚çœç³»ç»Ÿèµ„æºçš„æ—¶å€™ã€‚</p><p><strong>å¦‚ä½•è§£å†³ï¼š</strong>åˆ¤æ–­ç³»ç»Ÿæ˜¯å¦å·²ç»æœ‰è¿™ä¸ªå•ä¾‹ï¼Œå¦‚æœæœ‰åˆ™è¿”å›ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºã€‚</p><p><strong>å…³é”®ä»£ç ï¼š</strong>æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ã€‚</p><p><strong>åº”ç”¨å®ä¾‹ï¼š</strong></p><ul><li>1ã€ä¸€ä¸ªç­çº§åªæœ‰ä¸€ä¸ªç­ä¸»ä»»ã€‚</li><li>2ã€Windows æ˜¯å¤šè¿›ç¨‹å¤šçº¿ç¨‹çš„ï¼Œåœ¨æ“ä½œä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œå°±ä¸å¯é¿å…åœ°å‡ºç°å¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ªæ–‡ä»¶çš„ç°è±¡ï¼Œæ‰€ä»¥æ‰€æœ‰æ–‡ä»¶çš„å¤„ç†å¿…é¡»é€šè¿‡å”¯ä¸€çš„å®ä¾‹æ¥è¿›è¡Œã€‚</li><li>3ã€ä¸€äº›è®¾å¤‡ç®¡ç†å™¨å¸¸å¸¸è®¾è®¡ä¸ºå•ä¾‹æ¨¡å¼ï¼Œæ¯”å¦‚ä¸€ä¸ªç”µè„‘æœ‰ä¸¤å°æ‰“å°æœºï¼Œåœ¨è¾“å‡ºçš„æ—¶å€™å°±è¦å¤„ç†ä¸èƒ½ä¸¤å°æ‰“å°æœºæ‰“å°åŒä¸€ä¸ªæ–‡ä»¶ã€‚</li></ul><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>1ã€åœ¨å†…å­˜é‡Œåªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå‡å°‘äº†å†…å­˜çš„å¼€é”€ï¼Œå°¤å…¶æ˜¯é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯å®ä¾‹ï¼ˆæ¯”å¦‚ç®¡ç†å­¦é™¢é¦–é¡µé¡µé¢ç¼“å­˜ï¼‰ã€‚</li><li>2ã€é¿å…å¯¹èµ„æºçš„å¤šé‡å ç”¨ï¼ˆæ¯”å¦‚å†™æ–‡ä»¶æ“ä½œï¼‰ã€‚</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong>æ²¡æœ‰æ¥å£ï¼Œä¸èƒ½ç»§æ‰¿ï¼Œä¸å•ä¸€èŒè´£åŸåˆ™å†²çªï¼Œä¸€ä¸ªç±»åº”è¯¥åªå…³å¿ƒå†…éƒ¨é€»è¾‘ï¼Œè€Œä¸å…³å¿ƒå¤–é¢æ€ä¹ˆæ ·æ¥å®ä¾‹åŒ–ã€‚</p><p>å•ä¾‹æ¨¡å¼ä¸€èˆ¬å¸¸ç”¨çš„æœ‰ä¸¤ç§æ–¹å¼æ¥å®ç°ï¼Œåˆ†åˆ«æ˜¯<strong>æ‡’æ±‰æ¨¡å¼</strong>å’Œ<strong>é¥¿æ±‰æ¨¡å¼</strong></p><ul><li>æ‡’æ±‰æ¨¡å¼ï¼šåœ¨çœŸæ­£ä½¿ç”¨å¯¹è±¡æ—¶æ‰å°†å¯¹è±¡è¿›è¡Œåˆå§‹åŒ–ï¼Œ<strong>éçº¿ç¨‹å®‰å…¨</strong></li><li>é¥¿æ±‰æ¨¡å¼ï¼šæŒ‡åœ¨ç±»åŠ è½½æ—¶å°±å·²ç»åˆ›å»ºå¥½äº†è¯¥å•ä¾‹å¯¹è±¡ï¼Œç­‰å¾…è¢«ç¨‹åºä½¿ç”¨ï¼Œæ˜¯<strong>çº¿ç¨‹å®‰å…¨</strong>çš„</li></ul><h3 id="é¥¿æ±‰æ¨¡å¼ä»£ç "><a href="#é¥¿æ±‰æ¨¡å¼ä»£ç " class="headerlink" title="é¥¿æ±‰æ¨¡å¼ä»£ç "></a>é¥¿æ±‰æ¨¡å¼ä»£ç </h3><p>é¥¿æ±‰æ¨¡å¼çš„å®ç°æ¯”èµ·æ‡’æ±‰æ¨¡å¼å®ç°ç®€å•å¾ˆå¤š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token comment">//å•ä¾‹æ¨¡å¼--é¥¿æ±‰æ¨¡å¼</span><span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">;</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">delete</span><span class="token punctuation">;</span><span class="token comment">//ç¦æ­¢æ‹·è´</span>    Singleton<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">delete</span><span class="token punctuation">;</span><span class="token comment">//ç¦æ­¢èµ‹å€¼</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">*</span> m_instance<span class="token punctuation">;</span><span class="token comment">//å•ä¾‹å¯¹è±¡</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">*</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> m_instance<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>Singleton<span class="token operator">*</span> Singleton<span class="token operator">::</span>m_instance<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    Singleton<span class="token operator">*</span> object<span class="token operator">=</span><span class="token class-name">Singleton</span><span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–å®ä¾‹</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ‡’æ±‰æ¨¡å¼ä»£ç "><a href="#æ‡’æ±‰æ¨¡å¼ä»£ç " class="headerlink" title="æ‡’æ±‰æ¨¡å¼ä»£ç "></a>æ‡’æ±‰æ¨¡å¼ä»£ç </h3><p>æ‡’æ±‰æ¨¡å¼çš„ä»£ç éœ€è¦æ³¨æ„çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ï¼Œè¿™é‡Œæ€»å…±æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼Œéœ€è¦å±‚å±‚é€’è¿›å¼çš„ä¿®æ”¹</p><p><strong>ç‰ˆæœ¬ä¸€ï¼š</strong></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token comment">//é¥¿æ±‰æ¨¡å¼</span><span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">;</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">delete</span><span class="token punctuation">;</span><span class="token comment">//ç¦æ­¢æ‹·è´</span>    Singleton<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">delete</span><span class="token punctuation">;</span><span class="token comment">//ç¦æ­¢èµ‹å€¼</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">*</span> m_instance<span class="token punctuation">;</span><span class="token comment">//å•ä¾‹å¯¹è±¡</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">*</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//æœ‰ç¼ºé™·</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>m_instance<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>            m_instance<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¯èƒ½å¤šä¸ªçº¿ç¨‹åŒæ—¶new</span>                <span class="token keyword">return</span> m_instance<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    Singleton<span class="token operator">*</span> object<span class="token operator">=</span><span class="token class-name">Singleton</span><span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–å®ä¾‹</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šè¿°ä»£ç ç¼ºé™·åœ¨äºå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶åˆ¤æ–­<code>m_instance</code>ä¸ºç©ºï¼Œå°±ä¼šå¯¼è‡´ç”³è¯·äº†å¤šä¸ªå®ä¾‹ï¼Œå¯¹äºè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ é”æ¥è§£å†³ï¼Œè¿™æ ·å°±æœ‰äº†ç‰ˆæœ¬äºŒ</p><p><strong>ç‰ˆæœ¬äºŒï¼š</strong></p><p>ä¸‹é¢ä»£ç æ”¹è¿›åœ°æ–¹åœ¨åŠ äº†ä¸ªé”ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹éƒ½åˆ›å»ºäº†å¯¹è±¡å®ä¾‹ï¼Œä½†æ˜¯ä»ç„¶æœ‰æ”¹è¿›åœ°æ–¹</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token comment">//é¥¿æ±‰æ¨¡å¼</span><span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">;</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">delete</span><span class="token punctuation">;</span><span class="token comment">//ç¦æ­¢æ‹·è´</span>    Singleton<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">delete</span><span class="token punctuation">;</span><span class="token comment">//ç¦æ­¢èµ‹å€¼</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">*</span> m_instance<span class="token punctuation">;</span><span class="token comment">//å•ä¾‹å¯¹è±¡</span>    <span class="token keyword">static</span> mutex m_mutex<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">*</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//å•å•åªåŠ é”è¿˜æ˜¯ä¼šæœ‰ç¼ºé™·</span>        m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸Šé”</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>m_instance<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>            m_instance<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£é”</span>        <span class="token keyword">return</span> m_instance<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    Singleton<span class="token operator">*</span> object<span class="token operator">=</span><span class="token class-name">Singleton</span><span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–å®ä¾‹</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ã€€<strong>ç‰ˆæœ¬ä¸‰ï¼š</strong></p><p>è¿™é‡Œæ”¹è¿›çš„åœ°æ–¹æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯åŠ äº†åŒé‡<code>if</code>æ£€æµ‹é˜²æ­¢å¤šä¸ªçº¿ç¨‹é˜»å¡åœ¨æŠ¢å¤ºé”ï¼Œè€—è´¹ç³»ç»Ÿèµ„æºï¼›</p><p>å¦ä¸€ä¸ªæ”¹è¿›åœ°æ–¹æ˜¯ä½¿ç”¨äº†ä¸´æ—¶å˜é‡tempï¼Œé˜²æ­¢çº¿ç¨‹Aåœ¨å®ä¾‹åŒ–newè¿‡ç¨‹ä½†è¿˜æ²¡ç»“æŸæ—¶ï¼Œçº¿ç¨‹Bé€šè¿‡å¤–å±‚ifåˆ¤æ–­ï¼Œç›´æ¥è¿”å›äº†è¿˜æœªå®ä¾‹åŒ–å®Œæˆçš„å•ä¾‹å¯¹è±¡ï¼Œç”±æ­¤å¯¼è‡´æˆå‘˜å˜é‡æ•°æ®å¯èƒ½è¿˜æœªèµ‹å€¼å®Œæˆç­‰æƒ…å†µ</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token comment">//é¥¿æ±‰æ¨¡å¼</span><span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">;</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">delete</span><span class="token punctuation">;</span><span class="token comment">//ç¦æ­¢æ‹·è´</span>    Singleton<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">delete</span><span class="token punctuation">;</span><span class="token comment">//ç¦æ­¢èµ‹å€¼</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">*</span> m_instance<span class="token punctuation">;</span><span class="token comment">//å•ä¾‹å¯¹è±¡</span>    <span class="token keyword">static</span> mutex m_mutex<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">*</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//æœ€ç»ˆä¿®æ”¹ç‰ˆï¼ŒåŒé‡æ£€æµ‹+ä¸´æ—¶å˜é‡èµ‹å€¼</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>m_instance<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//åŒé‡æ£€æµ‹</span>            m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸Šé”</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>m_instance<span class="token operator">==</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                Singleton<span class="token operator">*</span> temp<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸´æ—¶å˜é‡é˜²æ­¢çº¿ç¨‹Aåˆšnewå®Œ</span>                m_instance<span class="token operator">=</span>temp<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£é”</span>        <span class="token punctuation">&#125;</span>                <span class="token keyword">return</span> m_instance<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    Singleton<span class="token operator">*</span> object<span class="token operator">=</span><span class="token class-name">Singleton</span><span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–å®ä¾‹</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="RedisçŸ¥è¯†ç‚¹"><a href="#RedisçŸ¥è¯†ç‚¹" class="headerlink" title="RedisçŸ¥è¯†ç‚¹"></a>RedisçŸ¥è¯†ç‚¹</h1><p>Redis æ˜¯å®Œå…¨å¼€æºçš„ï¼Œéµå®ˆ BSD åè®®ï¼Œæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ key-value æ•°æ®åº“ã€‚</p><p>Redis ä¸å…¶ä»– key - value ç¼“å­˜äº§å“æœ‰ä»¥ä¸‹ä¸‰ä¸ªç‰¹ç‚¹ï¼š</p><ul><li>Redisæ”¯æŒæ•°æ®çš„æŒä¹…åŒ–ï¼Œå¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®ä¿å­˜åœ¨ç£ç›˜ä¸­ï¼Œé‡å¯çš„æ—¶å€™å¯ä»¥å†æ¬¡åŠ è½½è¿›è¡Œä½¿ç”¨ã€‚</li><li>Redisä¸ä»…ä»…æ”¯æŒç®€å•çš„key-valueç±»å‹çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜æä¾›listï¼Œsetï¼Œzsetï¼Œhashç­‰æ•°æ®ç»“æ„çš„å­˜å‚¨ã€‚</li><li>Redisæ”¯æŒæ•°æ®çš„å¤‡ä»½ï¼Œå³master-slaveæ¨¡å¼çš„æ•°æ®å¤‡ä»½ã€‚</li></ul><p><strong>Redis ä¼˜åŠ¿</strong></p><ul><li>æ€§èƒ½æé«˜ â€“ Redisèƒ½è¯»çš„é€Ÿåº¦æ˜¯110000æ¬¡/s,å†™çš„é€Ÿåº¦æ˜¯81000æ¬¡/s ã€‚</li><li>ä¸°å¯Œçš„æ•°æ®ç±»å‹ â€“ Redisæ”¯æŒäºŒè¿›åˆ¶æ¡ˆä¾‹çš„ Strings, Lists, Hashes, Sets åŠ Ordered Sets æ•°æ®ç±»å‹æ“ä½œã€‚</li><li>åŸå­ â€“ Redisçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼Œæ„æ€å°±æ˜¯è¦ä¹ˆæˆåŠŸæ‰§è¡Œè¦ä¹ˆå¤±è´¥å®Œå…¨ä¸æ‰§è¡Œã€‚å•ä¸ªæ“ä½œæ˜¯åŸå­æ€§çš„ã€‚å¤šä¸ªæ“ä½œä¹Ÿæ”¯æŒäº‹åŠ¡ï¼Œå³åŸå­æ€§ï¼Œé€šè¿‡MULTIå’ŒEXECæŒ‡ä»¤åŒ…èµ·æ¥ã€‚</li><li>ä¸°å¯Œçš„ç‰¹æ€§ â€“ Redisè¿˜æ”¯æŒ publish/subscribe, é€šçŸ¥, key è¿‡æœŸç­‰ç­‰ç‰¹æ€§ã€‚</li></ul><h2 id="åœ¨çº¿Redisä»£ç ç¯å¢ƒ"><a href="#åœ¨çº¿Redisä»£ç ç¯å¢ƒ" class="headerlink" title="åœ¨çº¿Redisä»£ç ç¯å¢ƒ"></a>åœ¨çº¿Redisä»£ç ç¯å¢ƒ</h2><p>å¯ä»¥é€šè¿‡è¯¥ç½‘å€æ¥ç»ƒä¹ Redisæ“ä½œï¼š<a href="https://try.redis.io/">https://try.redis.io/</a></p><h2 id="æ•°æ®ç±»å‹"><a href="#æ•°æ®ç±»å‹" class="headerlink" title="æ•°æ®ç±»å‹"></a>æ•°æ®ç±»å‹</h2><p>Rediså¸¸ç”¨çš„æ•°æ®ç±»å‹æœ‰äº”ç§ï¼š<strong>Stringï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼ŒHashï¼ˆå“ˆå¸Œï¼‰ï¼ŒListï¼ˆåˆ—è¡¨ï¼‰ï¼ŒSetï¼ˆé›†åˆï¼‰ã€Zsetï¼ˆæœ‰åºé›†åˆï¼‰</strong>ã€‚</p><p>éšç€ Redis ç‰ˆæœ¬çš„æ›´æ–°ï¼Œåé¢åˆæ”¯æŒäº†å››ç§æ•°æ®ç±»å‹ï¼š <strong>BitMapï¼ˆ2.2 ç‰ˆæ–°å¢ï¼‰ã€HyperLogLogï¼ˆ2.8 ç‰ˆæ–°å¢ï¼‰ã€GEOï¼ˆ3.2 ç‰ˆæ–°å¢ï¼‰ã€Streamï¼ˆ5.0 ç‰ˆæ–°å¢ï¼‰</strong>ã€‚</p><h2 id="AOFå’ŒRDBæŒä¹…åŒ–"><a href="#AOFå’ŒRDBæŒä¹…åŒ–" class="headerlink" title="AOFå’ŒRDBæŒä¹…åŒ–"></a>AOFå’ŒRDBæŒä¹…åŒ–</h2><h2 id="ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ã€å‡»ç©¿ã€ç©¿é€ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ã€å‡»ç©¿ã€ç©¿é€ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ã€å‡»ç©¿ã€ç©¿é€ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ã€å‡»ç©¿ã€ç©¿é€ï¼Ÿ</h2><hr><h1 id="æ•°æ®ç»“æ„é—®é¢˜"><a href="#æ•°æ®ç»“æ„é—®é¢˜" class="headerlink" title="æ•°æ®ç»“æ„é—®é¢˜"></a>æ•°æ®ç»“æ„é—®é¢˜</h1><h2 id="æ’åºç®—æ³•"><a href="#æ’åºç®—æ³•" class="headerlink" title="æ’åºç®—æ³•"></a>æ’åºç®—æ³•</h2><p>å¸¸è§çš„æ’åºç®—æ³•å¦‚é€‰æ‹©ã€æ’å…¥ã€å†’æ³¡ã€å¿«é€Ÿã€å½’å¹¶ç­‰éƒ½æ˜¯é¢è¯•ç»å¸¸é—®çš„é—®é¢˜ï¼Œè¿™é‡Œä¹Ÿå°†å®ƒä»¬ä»£ç å†™ä¸€ä¸‹</p><h3 id="é€‰æ‹©æ’åº"><a href="#é€‰æ‹©æ’åº" class="headerlink" title="é€‰æ‹©æ’åº"></a>é€‰æ‹©æ’åº</h3><p>é€‰æ‹©æ’åº<strong>O(n^2)ã€ä¸ç¨³å®š</strong></p><p>é€‰æ‹©æ’åºæ˜¯ç»™æ¯ä¸ªä½ç½®é€‰æ‹©å½“å‰å…ƒç´ æœ€å°çš„ï¼Œæ¯”å¦‚ç»™ç¬¬ä¸€ä¸ªä½ç½®é€‰æ‹©æœ€å°çš„ï¼Œåœ¨å‰©ä½™å…ƒç´ é‡Œé¢ç»™ç¬¬äºŒä¸ªå…ƒç´ é€‰æ‹©ç¬¬äºŒå°çš„ï¼Œä»¥æ­¤ç±»æ¨</p><p>ä¸ç¨³å®šåŸå› ï¼šå¦‚æœå½“å‰å…ƒç´ æ¯”ä¸€ä¸ªå…ƒç´ å°ï¼Œè€Œè¯¥å°çš„å…ƒç´ åˆå‡ºç°åœ¨ä¸€ä¸ªå’Œå½“å‰å…ƒç´ ç›¸ç­‰çš„å…ƒç´ åé¢ï¼Œé‚£ä¹ˆ äº¤æ¢åç¨³å®šæ€§å°±è¢«ç ´åäº†ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œåºåˆ—5 8 5 2 9ï¼Œ æˆ‘ä»¬çŸ¥é“ç¬¬ä¸€éé€‰æ‹©ç¬¬1ä¸ªå…ƒç´ 5ä¼šå’Œ2äº¤æ¢ï¼Œé‚£ä¹ˆåŸåºåˆ—ä¸­2ä¸ª5çš„ç›¸å¯¹å‰åé¡ºåºå°±è¢«ç ´åäº†ï¼Œæ‰€ä»¥é€‰æ‹©æ’åºä¸æ˜¯ä¸€ä¸ªç¨³å®šçš„æ’åºç®—æ³•ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//é€‰æ‹©æ’åº</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">selectionSort</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> arr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> alen<span class="token operator">=</span>arr<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>alen<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> minIndex<span class="token operator">=</span>i<span class="token punctuation">;</span><span class="token comment">//è®°å½•æœ¬è½®ä¸­æœ€å°æ•°çš„ä¸‹æ ‡</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>alen<span class="token punctuation">;</span><span class="token operator">++</span>j<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">&lt;</span>arr<span class="token punctuation">[</span>minIndex<span class="token punctuation">]</span><span class="token punctuation">)</span>                minIndex<span class="token operator">=</span>j<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>minIndex<span class="token operator">!=</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœæœ€å°æ•°ä¸æ˜¯æ ‡å…µæ•°æœ¬èº«</span>            <span class="token function">swap</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>minIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> arr<span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">selectionSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">:</span>arr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="æ’å…¥æ’åº"><a href="#æ’å…¥æ’åº" class="headerlink" title="æ’å…¥æ’åº"></a>æ’å…¥æ’åº</h3><p>æ’å…¥æ’åº(InsertionSort)ï¼Œä¸€èˆ¬ä¹Ÿè¢«ç§°ä¸ºç›´æ¥æ’å…¥æ’åºã€‚æ—¶é—´å¤æ‚åº¦ä¸ºï¼š<strong>O(N^2)</strong></p><p>å¯¹äºå°‘é‡å…ƒç´ çš„æ’åºï¼Œå®ƒæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ç®—æ³•ã€‚æ’å…¥æ’åºæ˜¯ä¸€ç§æœ€ç®€å•çš„æ’åºæ–¹æ³•ï¼Œå®ƒçš„åŸºæœ¬æ€æƒ³æ˜¯å°†ä¸€ä¸ªè®°å½•æ’å…¥åˆ°å·²ç»æ’å¥½åºçš„æœ‰åºè¡¨ä¸­ï¼Œä»è€Œä¸€ä¸ªæ–°çš„ã€è®°å½•æ•°å¢ 1 çš„æœ‰åºè¡¨</p><p><img src="https://www.runoob.com/wp-content/uploads/2020/09/InsertSort-03.png" alt="img"></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">insertionSort</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> arr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> len<span class="token operator">=</span>arr<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&lt;=</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> insertValue<span class="token operator">=</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> j<span class="token operator">=</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">(</span>j<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>insertValue<span class="token operator">&lt;</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">--</span>j<span class="token punctuation">)</span>            arr<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>                arr<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>insertValue<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> array<span class="token punctuation">&#123;</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">insertionSort</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">&amp;</span> i<span class="token operator">:</span>array<span class="token punctuation">)</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="å½’å¹¶æ’åº"><a href="#å½’å¹¶æ’åº" class="headerlink" title="å½’å¹¶æ’åº"></a>å½’å¹¶æ’åº</h3><p>å½’å¹¶æ’åºï¼ˆMerge sortï¼‰æ˜¯å»ºç«‹åœ¨å½’å¹¶æ“ä½œä¸Šçš„ä¸€ç§æœ‰æ•ˆã€<strong>ç¨³å®š</strong>çš„æ’åºç®—æ³•ï¼Œè¯¥ç®—æ³•æ˜¯é‡‡ç”¨åˆ†æ²»æ³•(Divide and Conquerï¼‰çš„ä¸€ä¸ªéå¸¸å…¸å‹çš„åº”ç”¨ã€‚å°†å·²æœ‰åºçš„å­åºåˆ—åˆå¹¶ï¼Œå¾—åˆ°å®Œå…¨æœ‰åºçš„åºåˆ—ï¼›å³å…ˆä½¿æ¯ä¸ªå­åºåˆ—æœ‰åºï¼Œå†ä½¿å­åºåˆ—æ®µé—´æœ‰åºã€‚è‹¥å°†ä¸¤ä¸ªæœ‰åºè¡¨åˆå¹¶æˆä¸€ä¸ªæœ‰åºè¡¨ï¼Œç§°ä¸ºäºŒè·¯å½’å¹¶ã€‚</p><p>æ—¶é—´å¤æ‚åº¦ä¸º <strong>O(nlogn)</strong></p><p><img src="https://www.runoob.com/wp-content/uploads/2020/09/MergeSort-01.png" alt="img"></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">merge</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> arr<span class="token punctuation">,</span><span class="token keyword">int</span> start<span class="token punctuation">,</span><span class="token keyword">int</span> mid<span class="token punctuation">,</span><span class="token keyword">int</span> end<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">temp</span><span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> p1<span class="token operator">=</span>start<span class="token punctuation">;</span>    <span class="token keyword">int</span> p2<span class="token operator">=</span>mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> p<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p1<span class="token operator">&lt;=</span>mid<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>p2<span class="token operator">&lt;=</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>p1<span class="token punctuation">]</span><span class="token operator">&lt;=</span>arr<span class="token punctuation">[</span>p2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            temp<span class="token punctuation">[</span>p<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>arr<span class="token punctuation">[</span>p1<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            temp<span class="token punctuation">[</span>p<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>arr<span class="token punctuation">[</span>p2<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p1<span class="token operator">&lt;=</span>mid<span class="token punctuation">)</span>        temp<span class="token punctuation">[</span>p<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>arr<span class="token punctuation">[</span>p1<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>p2<span class="token operator">&lt;=</span>end<span class="token punctuation">)</span>        temp<span class="token punctuation">[</span>p<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>arr<span class="token punctuation">[</span>p2<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>temp<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>        arr<span class="token punctuation">[</span>start<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token operator">=</span>temp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">mergeSort</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> arr<span class="token punctuation">,</span><span class="token keyword">int</span> start<span class="token punctuation">,</span><span class="token keyword">int</span> end<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>start<span class="token operator">&lt;</span>end<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> mid<span class="token operator">=</span><span class="token punctuation">(</span>start<span class="token operator">+</span>end<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>        <span class="token function">mergeSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span>start<span class="token punctuation">,</span>mid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">mergeSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span>mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">merge</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span>start<span class="token punctuation">,</span>mid<span class="token punctuation">,</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> array<span class="token punctuation">&#123;</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">mergeSort</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>array<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">&amp;</span> i<span class="token operator">:</span>array<span class="token punctuation">)</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="å¿«é€Ÿæ’åº"><a href="#å¿«é€Ÿæ’åº" class="headerlink" title="å¿«é€Ÿæ’åº"></a>å¿«é€Ÿæ’åº</h3><p>å¿«é€Ÿæ’åºåˆæ˜¯ä¸€ç§åˆ†è€Œæ²»ä¹‹æ€æƒ³åœ¨æ’åºç®—æ³•ä¸Šçš„å…¸å‹åº”ç”¨ã€‚æœ¬è´¨ä¸Šæ¥çœ‹ï¼Œå¿«é€Ÿæ’åºåº”è¯¥ç®—æ˜¯åœ¨å†’æ³¡æ’åºåŸºç¡€ä¸Šçš„é€’å½’åˆ†æ²»æ³•ï¼Œåœ¨å¹³å‡çŠ¶å†µä¸‹ï¼Œæ’åº n ä¸ªé¡¹ç›®è¦ <strong>ÎŸ(nlogn)</strong> æ¬¡æ¯”è¾ƒã€‚åœ¨æœ€åçŠ¶å†µä¸‹åˆ™éœ€è¦ <strong>ÎŸ(n^2)</strong> æ¬¡æ¯”è¾ƒï¼Œä½†è¿™ç§çŠ¶å†µå¹¶ä¸å¸¸è§ã€‚</p><p><em>å¿«é€Ÿæ’åºçš„æœ€åè¿è¡Œæƒ…å†µæ˜¯ O(nÂ²)ï¼Œæ¯”å¦‚è¯´é¡ºåºæ•°åˆ—çš„å¿«æ’ã€‚ä½†å®ƒçš„å¹³æ‘ŠæœŸæœ›æ—¶é—´æ˜¯ O(nlogn)ï¼Œä¸” O(nlogn) è®°å·ä¸­éšå«çš„å¸¸æ•°å› å­å¾ˆå°ï¼Œæ¯”å¤æ‚åº¦ç¨³å®šç­‰äº O(nlogn) çš„å½’å¹¶æ’åºè¦å°å¾ˆå¤šã€‚æ‰€ä»¥ï¼Œå¯¹ç»å¤§å¤šæ•°é¡ºåºæ€§è¾ƒå¼±çš„éšæœºæ•°åˆ—è€Œè¨€ï¼Œå¿«é€Ÿæ’åºæ€»æ˜¯ä¼˜äºå½’å¹¶æ’åº</em></p><p>ç®—æ³•æ­¥éª¤ï¼š</p><ol><li>ä»æ•°åˆ—ä¸­æŒ‘å‡ºä¸€ä¸ªå…ƒç´ ï¼Œç§°ä¸º â€œåŸºå‡†â€ï¼ˆpivotï¼‰;</li><li>é‡æ–°æ’åºæ•°åˆ—ï¼Œæ‰€æœ‰å…ƒç´ æ¯”åŸºå‡†å€¼å°çš„æ‘†æ”¾åœ¨åŸºå‡†å‰é¢ï¼Œæ‰€æœ‰å…ƒç´ æ¯”åŸºå‡†å€¼å¤§çš„æ‘†åœ¨åŸºå‡†çš„åé¢ï¼ˆç›¸åŒçš„æ•°å¯ä»¥åˆ°ä»»ä¸€è¾¹ï¼‰ã€‚åœ¨è¿™ä¸ªåˆ†åŒºé€€å‡ºä¹‹åï¼Œè¯¥åŸºå‡†å°±å¤„äºæ•°åˆ—çš„ä¸­é—´ä½ç½®ã€‚è¿™ä¸ªç§°ä¸ºåˆ†åŒºï¼ˆpartitionï¼‰æ“ä½œï¼›</li><li>é€’å½’åœ°ï¼ˆrecursiveï¼‰æŠŠå°äºåŸºå‡†å€¼å…ƒç´ çš„å­æ•°åˆ—å’Œå¤§äºåŸºå‡†å€¼å…ƒç´ çš„å­æ•°åˆ—æ’åºï¼›</li></ol><p><img src="https://www.runoob.com/wp-content/uploads/2019/03/quickSort.gif" alt="img"></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">QuickSort</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> arr<span class="token punctuation">,</span><span class="token keyword">int</span> begin<span class="token punctuation">,</span><span class="token keyword">int</span> end<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>begin<span class="token operator">>=</span>end<span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> l<span class="token operator">=</span>begin<span class="token punctuation">;</span>    <span class="token keyword">int</span> r<span class="token operator">=</span>end<span class="token punctuation">;</span>    <span class="token keyword">int</span> key<span class="token operator">=</span>arr<span class="token punctuation">[</span>begin<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>l<span class="token operator">&lt;</span>r<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>l<span class="token operator">&lt;</span>r<span class="token operator">&amp;&amp;</span>arr<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token operator">>=</span>key<span class="token punctuation">)</span>            <span class="token operator">--</span>r<span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>l<span class="token operator">&lt;</span>r<span class="token operator">&amp;&amp;</span>arr<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token operator">&lt;=</span>key<span class="token punctuation">)</span>            <span class="token operator">++</span>l<span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>l<span class="token operator">!=</span>r<span class="token punctuation">)</span>            <span class="token function">swap</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">,</span>arr<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>l<span class="token operator">==</span>r<span class="token punctuation">)</span>            <span class="token function">swap</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>begin<span class="token punctuation">]</span><span class="token punctuation">,</span>arr<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">QuickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span>begin<span class="token punctuation">,</span>l<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">QuickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span>l<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> array<span class="token punctuation">&#123;</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">QuickSort</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>array<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">&amp;</span> i<span class="token operator">:</span>array<span class="token punctuation">)</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt; åœ¨å†™è¿™ä¸ªæ–‡ç« çš„æ—¶å€™å·²ç»æ˜¯å¤§ä¸‰çš„å¯’å‡äº†ï¼Œå› æ­¤ä¹Ÿè¦å¼€å§‹ä¸ºå®ä¹ çš„å·¥ä½œåšå‡†å¤‡äº†ï¼Œè¿™é‡Œå°±ä¸“é—¨å¼€äº†ä¸ªæ–‡ç« æ¥è®°å½•æˆ‘åœ¨ç½‘ä¸Šæ‰¾åˆ°çš„ä¸€äº›&lt;strong&gt;C++</summary>
      
    
    
    
    <category term="é¢è¯•" scheme="http://sakura-pub.top/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="é¢è¯•" scheme="http://sakura-pub.top/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>LeetCodeå‘¨èµ›268åœº</title>
    <link href="http://sakura-pub.top/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B268%E5%9C%BA/"/>
    <id>http://sakura-pub.top/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B268%E5%9C%BA/</id>
    <published>2021-11-26T05:49:01.000Z</published>
    <updated>2021-11-26T09:04:20.301Z</updated>
    
    <content type="html"><![CDATA[<h1 id="LeetCodeå‘¨èµ›268åœº"><a href="#LeetCodeå‘¨èµ›268åœº" class="headerlink" title="LeetCodeå‘¨èµ›268åœº"></a>LeetCodeå‘¨èµ›268åœº</h1><p>è¿™å‘¨çš„å‘¨èµ›é¢˜éƒ½æ¯”è¾ƒç®€å•ï¼Œå‰ä¸¤é¢˜å¯ä»¥ç›´æ¥æš´åŠ›å’Œæ¨¡æ‹Ÿï¼Œè€Œç¬¬ä¸‰é¢˜ä¹Ÿæ˜¯å¯ä»¥ç¨å¾®æƒ³ä¸€ä¸‹å°±åšå‡ºæ¥ï¼Œç®€ç›´ä¸è¦å¤ªèˆ’æœ</p><h2 id="2078-ä¸¤æ ‹é¢œè‰²ä¸åŒä¸”è·ç¦»æœ€è¿œçš„æˆ¿å­"><a href="#2078-ä¸¤æ ‹é¢œè‰²ä¸åŒä¸”è·ç¦»æœ€è¿œçš„æˆ¿å­" class="headerlink" title="2078. ä¸¤æ ‹é¢œè‰²ä¸åŒä¸”è·ç¦»æœ€è¿œçš„æˆ¿å­"></a><a href="https://leetcode-cn.com/problems/two-furthest-houses-with-different-colors/">2078. ä¸¤æ ‹é¢œè‰²ä¸åŒä¸”è·ç¦»æœ€è¿œçš„æˆ¿å­</a></h2><img src="https://i.loli.net/2021/11/26/oTdO5KVy9SRCjJA.png" style="zoom:80%;" /><img src="https://i.loli.net/2021/11/26/eSAYdFw7fWrxtKg.png" style="zoom:80%;" /><p>è¿™é¢˜çš„æš´åŠ›è§£æ³•å¯ä»¥ç›´æ¥å†™å‡ºæ¥</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">int</span> <span class="token function">maxDistance</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> colors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> clen<span class="token operator">=</span>colors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>clen<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>clen<span class="token punctuation">;</span><span class="token operator">++</span>j<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span>colors<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token keyword">else</span>                    res<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span>j<span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŒæ—¶è¿˜æœ‰ä¸€ä¸ªç¨å¾®è´ªå¿ƒçš„åšæ³•ï¼Œåˆ†ä¸‰ç§æƒ…å†µ</p><ol><li>å¦‚æœæœ€å·¦è¾¹å’Œæœ€å³è¾¹æˆ¿å­é¢œè‰²ä¸ä¸€æ ·ï¼Œåˆ™ç›´æ¥è¿”å›<code>(n-1)-0</code></li><li>å›ºå®šä¸‹æ ‡ä¸º<code>0</code>ä½ç½®ï¼Œå‘åé¢æ‰¾ä¸å®ƒæœ€å¤§è·ç¦»çš„ä¸åŒé¢œè‰²æˆ¿å­</li><li>å›ºå®šä¸‹æ ‡ä¸º<code>n-1</code>ä½ç½®ï¼Œå‘å‰æ‰¾æœ€å¤§è·ç¦»çš„ä¸åŒé¢œè‰²æˆ¿å­ï¼Œå¹¶ä¸ç¬¬äºŒæ­¥çš„æ•°å€¼ä½œæ¯”è¾ƒï¼Œå¾—å‡ºæœ€å¤§è·ç¦»</li></ol><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">maxDistance</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> colors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> length <span class="token operator">=</span> colors<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token comment">// å¦‚æœé¦–ä½é¢œè‰²ä¸åŒç›´æ¥è¿”å›</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> colors<span class="token punctuation">[</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>                <span class="token comment">// è·å–å·¦è¾¹ç¬¬ä¸€ä¸ªä¸ç›¸åŒçš„ä½ç½®</span>        <span class="token keyword">int</span> left <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>colors<span class="token punctuation">[</span>left<span class="token punctuation">]</span> <span class="token operator">==</span> colors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            left <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// è·å–å³è¾¹ç¬¬ä¸€ä¸ªä¸ç›¸åŒçš„ä½ç½®</span>        <span class="token keyword">int</span> right <span class="token operator">=</span> length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>colors<span class="token punctuation">[</span>right<span class="token punctuation">]</span> <span class="token operator">==</span> colors<span class="token punctuation">[</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            right <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 0ï½right çš„é•¿åº¦ å’Œ leftï½length-1 çš„é•¿åº¦å–æœ€å¤§å€¼</span>        <span class="token comment">// å› ä¸ºè¦æœ€å¤§ï¼Œæ‰€ä»¥ä¸å¯èƒ½åœ¨ä¸­é—´ï¼Œè¦ä¹ˆå°±æ˜¯å·¦è¾¹ï¼Œè¦ä¹ˆå°±æ˜¯å³è¾¹</span>        <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>right<span class="token punctuation">,</span> length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> left<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="2079-ç»™æ¤ç‰©æµ‡æ°´"><a href="#2079-ç»™æ¤ç‰©æµ‡æ°´" class="headerlink" title="2079. ç»™æ¤ç‰©æµ‡æ°´"></a><a href="https://leetcode-cn.com/problems/watering-plants/">2079. ç»™æ¤ç‰©æµ‡æ°´</a></h2><img src="https://i.loli.net/2021/11/26/v8UbFT4hyziVG7P.png" style="zoom:80%;" /><img src="https://i.loli.net/2021/11/26/k9UMTJw5QI7jAx6.png" style="zoom:80%;" /><p>è¿™é“é¢˜æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿé¢˜ï¼Œç›´æ¥æŒ‰ç…§é¢˜æ„åšå°±å¥½äº†</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">int</span> <span class="token function">wateringPlants</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> plants<span class="token punctuation">,</span> <span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> plen<span class="token operator">=</span>plants<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>plen<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> fullWater<span class="token operator">=</span>capacity<span class="token punctuation">;</span><span class="token comment">//æ°´æ± </span>        <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>plen<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>plants<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;=</span>capacity<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token operator">++</span>res<span class="token punctuation">;</span>                capacity<span class="token operator">-=</span>plants<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token comment">//ä¸å¤Ÿæ°´</span>                res<span class="token operator">+=</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                capacity<span class="token operator">=</span>fullWater<span class="token punctuation">;</span>                capacity<span class="token operator">-=</span>plants<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="2080-åŒºé—´å†…æŸ¥è¯¢æ•°å­—çš„é¢‘ç‡"><a href="#2080-åŒºé—´å†…æŸ¥è¯¢æ•°å­—çš„é¢‘ç‡" class="headerlink" title="2080. åŒºé—´å†…æŸ¥è¯¢æ•°å­—çš„é¢‘ç‡"></a><a href="https://leetcode-cn.com/problems/range-frequency-queries/">2080. åŒºé—´å†…æŸ¥è¯¢æ•°å­—çš„é¢‘ç‡</a></h2><img src="https://i.loli.net/2021/11/26/qM9VxosD2Zf7caS.png" style="zoom:80%;" /><img src="https://i.loli.net/2021/11/26/uSXRqy7Mb9lhnYx.png" style="zoom:80%;" /><p>è¿™é“é¢˜éœ€è¦æå‰å¤„ç†ä¸€ä¸‹ï¼Œå­˜æ”¾çš„å®¹å™¨æœ‰ä¸¤ç§æ–¹æ¡ˆ<code>vector</code>å’Œ<code>unordered_map</code></p><p>é¢„å¤„ç†æ˜¯ä¸ºäº†è®°å½•æ¯ä¸ªæ•°åœ¨å“ªäº›ä½ç½®å‡ºç°è¿‡</p><p>ä¸¤ä¸ªç‰ˆæœ¬åœ¨<code>query()</code>å‡½æ•°æŸ¥æ‰¾éƒ½è¿ç”¨äº†C++ç®—æ³•çš„å†…ç½®å‡½æ•°<code>lower_bound()</code>å’Œ<code>upper_bound()</code>ï¼Œè¿™é‡Œå¯ä»¥äº†è§£ä¸€ä¸‹å®ƒä»¬çš„ä½œç”¨ï¼Œå®ƒä»¬éƒ½æ˜¯è¿ç”¨äº†äºŒåˆ†æŸ¥æ‰¾æ–¹æ³•ï¼Œéœ€è¦ç”¨åœ¨æœ‰ç‰¹å®šé¡ºåºçš„å®¹å™¨ä¸­</p><p>è¿™é‡Œä¸¾ä¸ªæ —å­ï¼Œåœ¨æ•°ç»„<code>vector&lt;int&gt; arr=[10 10 10 20 20 20 30 30]</code>ï¼Œç„¶ååˆ†åˆ«è°ƒç”¨ä¸¤ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”ç¬¬ä¸‰ä¸ªå‚æ•°<code>val</code>å¡«å…¥<code>20</code>ï¼Œæœ€åè¾“å‡ºè¿­ä»£å™¨çš„ä½ç½®<code>iter-arr.begin()</code></p><ul><li><code>lower_bound()</code>ï¼šæ‰¾å‡ºå®¹å™¨ä¸­ç¬¬ä¸€ä¸ªå¤§äºç­‰äº<code>val</code>çš„æ•°çš„ä½ç½®ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬è¾“å‡ºè¿­ä»£å™¨çš„ä½ç½®ä¸º<code>3</code></li><li><code>upper_bound()</code>ï¼šæ‰¾å‡ºå®¹å™¨ä¸­ç¬¬ä¸€ä¸ªå¤§äº<code>val</code>çš„æ•°çš„ä½ç½®ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­è¾“å‡ºçš„è¿­ä»£å™¨ä½ç½®ä¸º<code>6</code></li></ul><p><code>unordered_map</code>ç‰ˆæœ¬</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//unordered_map</span><span class="token keyword">class</span> <span class="token class-name">RangeFreqQuery</span> <span class="token punctuation">&#123;</span><span class="token keyword">private</span><span class="token operator">:</span>    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> arr<span class="token punctuation">;</span>    unordered_map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span> map<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">RangeFreqQuery</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> vec<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token operator">-></span>arr<span class="token operator">=</span>vec<span class="token punctuation">;</span>        <span class="token keyword">int</span> alen<span class="token operator">=</span>arr<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>alen<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//é¢„å¤„ç†</span>            <span class="token keyword">int</span> cur<span class="token operator">=</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            map<span class="token punctuation">[</span>cur<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®°å½•æ¯ä¸ªæ•°å­—åˆ†åˆ«å‡ºç°çš„ä½ç½®</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">int</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> curArr<span class="token operator">=</span>map<span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> alen<span class="token operator">=</span>curArr<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>alen<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">auto</span> l<span class="token operator">=</span><span class="token function">lower_bound</span><span class="token punctuation">(</span>curArr<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>curArr<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">auto</span> r<span class="token operator">=</span><span class="token function">upper_bound</span><span class="token punctuation">(</span>curArr<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>curArr<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> r<span class="token operator">-</span>l<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">/** * Your RangeFreqQuery object will be instantiated and called as such: * RangeFreqQuery* obj = new RangeFreqQuery(arr); * int param_1 = obj->query(left,right,value); */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>vector&lt;vector&lt;int&gt;&gt;</code>ç‰ˆæœ¬</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">RangeFreqQuery</span> <span class="token punctuation">&#123;</span>  vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span> data<span class="token punctuation">;</span> <span class="token keyword">public</span><span class="token operator">:</span>  <span class="token function">RangeFreqQuery</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> arr<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      data<span class="token punctuation">[</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">int</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token function">lower_bound</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> left<span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token function">upper_bound</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;LeetCodeå‘¨èµ›268åœº&quot;&gt;&lt;a href=&quot;#LeetCodeå‘¨èµ›268åœº&quot; class=&quot;headerlink&quot; title=&quot;LeetCodeå‘¨èµ›268åœº&quot;&gt;&lt;/a&gt;LeetCodeå‘¨èµ›268åœº&lt;/h1&gt;&lt;p&gt;è¿™å‘¨çš„å‘¨èµ›é¢˜éƒ½æ¯”è¾ƒç®€å•ï¼Œå‰ä¸¤é¢˜å¯ä»¥ç›´æ¥æš´åŠ›å’Œ</summary>
      
    
    
    
    <category term="LeetCodeåˆ·é¢˜ç¬”è®°" scheme="http://sakura-pub.top/categories/LeetCode%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="LeetCode" scheme="http://sakura-pub.top/tags/LeetCode/"/>
    
  </entry>
  
  <entry>
    <title>LeetCodeå‘¨èµ›266åœº</title>
    <link href="http://sakura-pub.top/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B266%E5%9C%BA/"/>
    <id>http://sakura-pub.top/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B266%E5%9C%BA/</id>
    <published>2021-11-09T05:10:50.000Z</published>
    <updated>2021-11-09T10:57:56.339Z</updated>
    
    <content type="html"><![CDATA[<h1 id="LeetCodeå‘¨èµ›266åœº"><a href="#LeetCodeå‘¨èµ›266åœº" class="headerlink" title="LeetCodeå‘¨èµ›266åœº"></a>LeetCodeå‘¨èµ›266åœº</h1><p>æœ¬å‘¨çš„å‘¨èµ›é¢˜ç›®çœ‹ä¸Šå»æŒºéš¾çš„ï¼Œä½†èµ›åçœ‹äº†ä¸€ä¸‹åˆ«äººçš„è§£ç­”å‘ç°å…¶å®ä¹Ÿå¹¶ä¸å¤æ‚ï¼Œç»ˆç©¶è¿˜æ˜¯å¾—å¤šåšé¢˜å¤šæ€è€ƒğŸ’¦</p><h2 id="2062-ç»Ÿè®¡å­—ç¬¦ä¸²ä¸­çš„å…ƒéŸ³å­å­—ç¬¦ä¸²"><a href="#2062-ç»Ÿè®¡å­—ç¬¦ä¸²ä¸­çš„å…ƒéŸ³å­å­—ç¬¦ä¸²" class="headerlink" title="2062. ç»Ÿè®¡å­—ç¬¦ä¸²ä¸­çš„å…ƒéŸ³å­å­—ç¬¦ä¸²"></a><a href="https://leetcode-cn.com/problems/count-vowel-substrings-of-a-string/">2062. ç»Ÿè®¡å­—ç¬¦ä¸²ä¸­çš„å…ƒéŸ³å­å­—ç¬¦ä¸²</a></h2><img src="https://i.loli.net/2021/11/09/ng5oS9MrtU3XKDJ.png" style="zoom:80%;" /><img src="https://i.loli.net/2021/11/09/QAnk9YMCWuNGDc3.png" style="zoom:80%;" /><p>ç¬¬ä¸€é¢˜ç»å…¸å¯ä»¥æš´åŠ›è§£æ³•ï¼Œä½†éœ€è¦æ³¨æ„çœ‹æ¸…é¢˜ç›®ï¼Œæˆ‘åœ¨åšçš„æ—¶å€™ç¬¬ä¸€æ¬¡çœ‹é¢˜è·³ç€çœ‹å¯¼è‡´çœ‹é”™äº†é¢˜æ„ï¼Œæ‰€ä»¥ç®€å•é¢˜æ›´åº”è¯¥å°å¿ƒï¼Œä¸èƒ½å¤ªç€æ€¥</p><p>ä¸‹é¢æ˜¯æˆ‘çš„æš´åŠ›è§£æ³•</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">int</span> <span class="token function">countVowelSubstrings</span><span class="token punctuation">(</span>string word<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> wlen<span class="token operator">=</span>word<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>wlen<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">char</span> w<span class="token operator">=</span>word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>w<span class="token operator">==</span><span class="token string">'a'</span><span class="token operator">||</span>w<span class="token operator">==</span><span class="token string">'e'</span><span class="token operator">||</span>w<span class="token operator">==</span><span class="token string">'i'</span><span class="token operator">||</span>w<span class="token operator">==</span><span class="token string">'o'</span><span class="token operator">||</span>w<span class="token operator">==</span><span class="token string">'u'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">int</span> temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">bool</span> sig<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>i<span class="token punctuation">;</span>j<span class="token operator">&lt;</span>wlen<span class="token punctuation">;</span><span class="token operator">++</span>j<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    w<span class="token operator">=</span>word<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>w<span class="token operator">==</span><span class="token string">'a'</span><span class="token operator">||</span>w<span class="token operator">==</span><span class="token string">'e'</span><span class="token operator">||</span>w<span class="token operator">==</span><span class="token string">'i'</span><span class="token operator">||</span>w<span class="token operator">==</span><span class="token string">'o'</span><span class="token operator">||</span>w<span class="token operator">==</span><span class="token string">'u'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                        <span class="token operator">++</span>temp<span class="token punctuation">;</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span>w<span class="token operator">==</span><span class="token string">'a'</span><span class="token punctuation">)</span>                            sig<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>                        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>w<span class="token operator">==</span><span class="token string">'e'</span><span class="token punctuation">)</span>                            sig<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>                        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>w<span class="token operator">==</span><span class="token string">'i'</span><span class="token punctuation">)</span>                            sig<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>                        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>w<span class="token operator">==</span><span class="token string">'o'</span><span class="token punctuation">)</span>                            sig<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>                        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>w<span class="token operator">==</span><span class="token string">'u'</span><span class="token punctuation">)</span>                            sig<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>                        temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">>=</span><span class="token number">5</span><span class="token punctuation">)</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span>sig<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;&amp;</span>sig<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;&amp;</span>sig<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&amp;&amp;</span>sig<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&amp;&amp;</span>sig<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                            <span class="token operator">++</span>res<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="2063-æ‰€æœ‰å­å­—ç¬¦ä¸²ä¸­çš„å…ƒéŸ³"><a href="#2063-æ‰€æœ‰å­å­—ç¬¦ä¸²ä¸­çš„å…ƒéŸ³" class="headerlink" title="2063. æ‰€æœ‰å­å­—ç¬¦ä¸²ä¸­çš„å…ƒéŸ³"></a><a href="https://leetcode-cn.com/problems/vowels-of-all-substrings/">2063. æ‰€æœ‰å­å­—ç¬¦ä¸²ä¸­çš„å…ƒéŸ³</a></h2><img src="https://i.loli.net/2021/11/09/ojNTOd4J9l2VuFz.png" style="zoom:80%;" /><img src="https://i.loli.net/2021/11/09/GbS93UM7IRAd4Kt.png" style="zoom:80%;" /><p>è¿™é“é¢˜åœ¨ç«èµ›åšçš„æ—¶å€™è§‰å¾—æŒºå¤æ‚æŒºéš¾çš„ï¼Œä½†çœ‹äº†é¢˜è§£ä¹‹åå…¶å®å¹¶ä¸éš¾ï¼Œåªæ˜¯ä¸€é“dpé—®é¢˜ï¼Œåªå¯æƒœå½“æ—¶åšçš„æ—¶å€™æ²¡æœ‰æƒ³åˆ°</p><p>è¿™é‡Œçš„dpè½¬ç§»æ¡ä»¶å¯ä»¥ç›´æ¥å½“æˆè¿”å›æ¡ä»¶ï¼Œå³<code>res</code>ï¼Œä½†æ˜¯è¦æ³¨æ„å®ƒæ˜¯ä¸€ä¸ª<code>long long</code>ç±»å‹çš„</p><p>éšåæ˜¯çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼Œæˆ‘ä»¬åœ¨éå†å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œè®¾å½“å‰éå†åˆ°çš„å­—ç¬¦ä¸º<code>cur</code>ï¼Œå¦‚æœ<code>cur</code>æ˜¯å…ƒéŸ³å­—ç¬¦ï¼Œåˆ™åˆ°æ­¤å­—ç¬¦ä¸ºæ­¢çš„<code>res</code>çŠ¶æ€æ˜¯ç”±å‰ä¸€ä¸ªå­—ç¬¦çš„<code>res</code>çŠ¶æ€å†åŠ ä¸Šå½“å‰åŒ…å«<code>cur</code>çš„å­å­—ç¬¦ä¸²ä¸ªæ•°ï¼Œå³<code>if(cur==å…ƒéŸ³) -&gt; res=res+åŒ…å«curå­ä¸²ä¸ªæ•°</code></p><p>é‚£ä¹ˆç°åœ¨é—®é¢˜æ¥åˆ°äº†æ€ä¹ˆæ±‚åŒ…å«<code>cur</code>å­ä¸²ä¸ªæ•°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>cur</code>åœ¨å­—ç¬¦ä¸²ä¸­ä½ç½®è§†ä¸ºä¸­ç‚¹ï¼Œä¾‹å¦‚å®ƒçš„ä½ç½®ä¸º<code>i</code></p><p>åˆ™åœ¨å®ƒå·¦è¾¹å¯ä»¥é€‰æ‹©ç¬¬<em>0,1,2,3â€¦i-1,i</em>ä¸ªå­—ç¬¦ä¸<code>cur</code>æ„æˆä¸€ä¸ªå­ä¸²ï¼Œè¿™é‡Œä¸€å…±æœ‰<code>i+1</code>ç§æƒ…å†µ</p><p>åœ¨å®ƒå³è¾¹å¯ä»¥é€‰æ‹©<em>i,i+1,i+2â€¦.n-2,n-1</em>ï¼Œä¸€å…±<code>n-i</code>ç§æƒ…å†µ</p><p>æ€»å…±åŠ èµ·æ¥çš„å­å­—ç¬¦ä¸²ä¸ªæ•°å°±æ˜¯<code>(i+1)(n-i)</code>ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦ç”¨ä¹˜æ³•å‘¢ï¼Œæ˜¯å› ä¸ºå­—ç¬¦<code>cur</code>ä¸¤è¾¹å¯ä»¥äº’ç›¸è¿æ¥ï¼Œä¾‹å¦‚åœ¨<em>a b c d e</em>å­—ç¬¦ä¸²ä¸­ï¼Œä»¥<em>b</em>ä¸ºä¸­å¿ƒï¼Œå¯ä»¥æ„æˆä»¥ä¸‹å­ä¸² <em>a b c</em> æˆ–  <em>b c d</em> ç­‰ï¼Œä¸¤è¾¹é€‰æ‹©ä¸€äº›å­—ç¬¦ç„¶åæ„æˆå…¶ä¸­ä¸€ä¸ªå­ä¸²ï¼Œæ‰€ä»¥è¿™æ˜¯æ•°å­¦ä¸­æ’åˆ—ç»„åˆçš„ <strong>ç»„åˆé—®é¢˜</strong></p><p>äº†è§£äº†è¿™äº›å°±å¯ä»¥å¾ˆè½»æ˜“å†™å‡ºä»£ç æ¥äº†</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token function">countVowels</span><span class="token punctuation">(</span>string word<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> wlen<span class="token operator">=</span>word<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> <span class="token keyword">long</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> <span class="token keyword">char</span> vowels<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">,</span><span class="token string">'i'</span><span class="token punctuation">,</span><span class="token string">'o'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>wlen<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">char</span> cur<span class="token operator">=</span>word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token operator">++</span>j<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>vowels<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">==</span>cur<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token comment">//éå†åˆ°çš„å­—æ¯æ˜¯å…ƒéŸ³å­—æ¯</span>                    res<span class="token operator">+=</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>wlen<span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="2064-åˆ†é…ç»™å•†åº—çš„æœ€å¤šå•†å“çš„æœ€å°å€¼"><a href="#2064-åˆ†é…ç»™å•†åº—çš„æœ€å¤šå•†å“çš„æœ€å°å€¼" class="headerlink" title="2064. åˆ†é…ç»™å•†åº—çš„æœ€å¤šå•†å“çš„æœ€å°å€¼"></a><a href="https://leetcode-cn.com/problems/minimized-maximum-of-products-distributed-to-any-store/">2064. åˆ†é…ç»™å•†åº—çš„æœ€å¤šå•†å“çš„æœ€å°å€¼</a></h2><img src="https://i.loli.net/2021/11/09/L8MljnYs4i1cRdp.png" style="zoom:80%;" /><img src="https://i.loli.net/2021/11/09/k3mcabiyPAlSfzv.png" style="zoom:80%;" /><p>è¿™é“é¢˜ä¹Ÿæ˜¯å½“æ—¶åšä¸å‡ºæ¥çš„ï¼Œè§‰å¾—é¢˜ç›®ä¼¼æ‡‚éæ‡‚çš„æ ·å­ï¼Œå¯¼è‡´ä¹Ÿæ²¡æœ‰æ€è·¯</p><p>å…¶å®è¿™é“é¢˜æœ¬è´¨æ˜¯ä¸€ä¸ªäºŒåˆ†é¢˜ï¼Œè¦æ‰¾å‡ºå¯ä»¥æ»¡è¶³åˆ†é…åº—é“ºæƒ…å†µä¸‹ï¼Œæ¯å®¶åº—æœ€å¤§å¯ä»¥åˆ†é…çš„å•†å“æ•°</p><p>æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å¾ªç¯ä¸æ–­å¯»æ‰¾è¿™ä¸ªå€¼ï¼Œè¿™é‡Œè®¾æ¯ä¸€å›åˆåˆ†é…<code>mid</code>ä¸ªå•†å“æ—¶ï¼Œæœ€åéœ€è¦çš„åº—é“ºæ•°ä¸º<code>cnt</code>ï¼Œåœ¨ä¸€è½®åˆ†é…ç»“æŸåï¼Œåˆ¤æ–­<code>cnt</code>ä¸é¢˜ç›®æ‰€ç»™çš„<code>n</code>çš„å…³ç³»</p><p>å¦‚æœï¼š</p><ul><li><code>cnt</code>&gt;<code>n</code>ï¼Œåˆ™ä¸€å®šä¸åˆæ³•ï¼Œå› ä¸ºåº—é“ºæ•°é‡è¿‡å¤šè¯æ˜å•†å“åˆ†é…å¤ªå°‘äº†ï¼Œå¯ä»¥å†è¿›ä¸€æ­¥å‹ç¼©åº—é“ºæ•°</li><li><code>cnt</code>=<code>n</code>ï¼Œåˆšå¥½æ»¡è¶³åˆ†é…åº—é“ºæ•°è¦æ±‚ï¼Œä½†æ˜¯è¦æ³¨æ„å•†å“æ•°ä¸èƒ½æœ‰å‰©ä½™ï¼Œå³<code>mod=0</code></li><li><code>cnt</code>&lt;<code>n</code>ï¼Œè¯´æ˜ä¸èƒ½å¯¹æ¯ä¸ªå•†åº—éƒ½åˆ†é… mid å•†å“ï¼Œä½†å‰©ä½™çš„å•†å“ç§ç±»å¿…é¡»æ»¡è¶³æœªèƒ½åˆ†é…çš„å•†åº— å³ mod &lt;= n - cntã€‚æˆ‘ä»¬å¯ä»¥æŠŠæ‰€æœ‰å‰©ä¸‹çš„å•†å“åˆ†é…åˆ°å‰©ä½™çš„å•†åº—ä¸­ï¼Œè‹¥ä»æœ‰å•†åº—å‰©ä½™å°±ä¸åˆ†é…å•†å“ï¼Œåˆ™æ¯ç§å‰©ä½™çš„å•†å“æ•°é‡ä¸€å®šå°äºmid</li></ul><p>ä¸‹é¢æ˜¯æˆ‘åæ¥è‡ªå·±å†™çš„ä»£ç ï¼Œè¦æ³¨æ„çš„æ˜¯äºŒåˆ†çš„ç•Œé™ï¼Œå¦‚æ¯æ¬¡æ›´æ–°æ—¶çš„æ“ä½œç­‰ï¼Œè¿˜æœ‰å°±æ˜¯æœ€åè¿”å›çš„æ˜¯<code>l</code>ï¼Œæˆ‘ä¹Ÿè¯•è¿‡äº†è‹¥ç›´æ¥è¿”å›<code>mid</code>æ˜¯ä¸è¡Œçš„ï¼ˆâ—è¿™é‡Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼‰</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">int</span> <span class="token function">minimizedMaximum</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> quantities<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> l<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//æ³¨æ„åˆå§‹å€¼æ¡ä»¶</span>        <span class="token keyword">int</span> r<span class="token operator">=</span><span class="token operator">*</span><span class="token function">max_element</span><span class="token punctuation">(</span>quantities<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>quantities<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> mid<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>l<span class="token operator">&lt;</span>r<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            mid<span class="token operator">=</span><span class="token punctuation">(</span>l<span class="token operator">+</span>r<span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>mid<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                l<span class="token operator">=</span>mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>                        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">&amp;</span> i<span class="token operator">:</span>quantities<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">int</span> cur<span class="token operator">=</span>i<span class="token operator">/</span>mid<span class="token punctuation">;</span><span class="token comment">//æ±‚å‡ºå½“å‰å•†å“æŒ‰midä»¶ä¸€å®¶åº—å¯ä»¥åˆ†å¤šå°‘åº—</span>                cnt<span class="token operator">+=</span>cur<span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span>mid<span class="token punctuation">)</span><span class="token comment">//å¦‚æœè¿˜æœ‰å‰©ä½™å•†å“æ²¡æœ‰ç»™åˆ†é…ï¼Œåˆ™åˆ†é…çš„åº—é“ºé‡è¦åŠ ä¸€</span>                    <span class="token operator">++</span>cnt<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>cnt<span class="token operator">></span>n<span class="token punctuation">)</span>                l<span class="token operator">=</span>mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">else</span>                r<span class="token operator">=</span>mid<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> l<span class="token punctuation">;</span><span class="token comment">//è¿”å›æ¡ä»¶è¦æ³¨æ„</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿˜æœ‰ä¸€ä¸ªç®€ç•¥ä¸€ç‚¹çš„ä»£ç ï¼Œåˆ«äººå†™çš„</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">int</span> <span class="token function">minimizedMaximum</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> quantities<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> l <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> r <span class="token operator">=</span> <span class="token operator">*</span><span class="token function">max_element</span><span class="token punctuation">(</span>quantities<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantities<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> mid <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> r<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> q <span class="token operator">:</span> quantities<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                cnt <span class="token operator">+=</span> <span class="token punctuation">(</span>q <span class="token operator">+</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> mid<span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œæ˜¯å‘ä¸Šå–æ•´æ“ä½œï¼Œå³åˆ†é…å‰©ä½™çš„å•†å“å†åŠ ä¸€ä¸ªå•†åº—æ¥æ”¾å®ƒ</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>cnt <span class="token operator">></span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                l <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                r <span class="token operator">=</span> mid<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> l<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;LeetCodeå‘¨èµ›266åœº&quot;&gt;&lt;a href=&quot;#LeetCodeå‘¨èµ›266åœº&quot; class=&quot;headerlink&quot; title=&quot;LeetCodeå‘¨èµ›266åœº&quot;&gt;&lt;/a&gt;LeetCodeå‘¨èµ›266åœº&lt;/h1&gt;&lt;p&gt;æœ¬å‘¨çš„å‘¨èµ›é¢˜ç›®çœ‹ä¸Šå»æŒºéš¾çš„ï¼Œä½†èµ›åçœ‹äº†ä¸€ä¸‹åˆ«</summary>
      
    
    
    
    <category term="LeetCodeåˆ·é¢˜ç¬”è®°" scheme="http://sakura-pub.top/categories/LeetCode%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="LeetCode" scheme="http://sakura-pub.top/tags/LeetCode/"/>
    
  </entry>
  
  <entry>
    <title>WebServeré¡¹ç›®ä»£ç </title>
    <link href="http://sakura-pub.top/WebServer/WebServer%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81/"/>
    <id>http://sakura-pub.top/WebServer/WebServer%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81/</id>
    <published>2021-11-02T11:21:52.000Z</published>
    <updated>2022-01-11T01:11:23.432Z</updated>
    
    <content type="html"><![CDATA[<h1 id="WebServeré¡¹ç›®ä»£ç "><a href="#WebServeré¡¹ç›®ä»£ç " class="headerlink" title="WebServeré¡¹ç›®ä»£ç "></a>WebServeré¡¹ç›®ä»£ç </h1><p>è¿™é‡Œä¸“é—¨æ¥å­˜æ”¾ä¸€ä¸‹æˆ‘æ­£åœ¨åšçš„IOå¤šè·¯å¤ç”¨é«˜å¹¶å‘æœåŠ¡å™¨<code>WebServer</code>çš„ä»£ç ï¼Œæ–¹ä¾¿åœ¨å¹³æ¿ä¸Šçœ‹</p><h1 id="HTTPæ¨¡å—"><a href="#HTTPæ¨¡å—" class="headerlink" title="HTTPæ¨¡å—"></a>HTTPæ¨¡å—</h1><h2 id="http-conn-hğŸ‘‡"><a href="#http-conn-hğŸ‘‡" class="headerlink" title="http_conn.hğŸ‘‡"></a>http_conn.hğŸ‘‡</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HTTPCONNECTION_H</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HTTPCONNECTION_H</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/uio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;map></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../lock/locker.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../CGImysql/sql_connection_pool.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../timer/lst_timer.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../log/log.h"</span></span><span class="token keyword">class</span> <span class="token class-name">http_conn</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> FILENAME_LEN <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> READ_BUFFER_SIZE <span class="token operator">=</span> <span class="token number">2048</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> WRITE_BUFFER_SIZE <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>    <span class="token keyword">enum</span> <span class="token class-name">METHOD</span>    <span class="token punctuation">&#123;</span>        GET <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>        POST<span class="token punctuation">,</span>        HEAD<span class="token punctuation">,</span>        PUT<span class="token punctuation">,</span>        DELETE<span class="token punctuation">,</span>        TRACE<span class="token punctuation">,</span>        OPTIONS<span class="token punctuation">,</span>        CONNECT<span class="token punctuation">,</span>        PATH    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">enum</span> <span class="token class-name">CHECK_STATE</span>    <span class="token punctuation">&#123;</span>        CHECK_STATE_REQUESTLINE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>        CHECK_STATE_HEADER<span class="token punctuation">,</span>        CHECK_STATE_CONTENT    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">enum</span> <span class="token class-name">HTTP_CODE</span>    <span class="token punctuation">&#123;</span>        NO_REQUEST<span class="token punctuation">,</span>        GET_REQUEST<span class="token punctuation">,</span>        BAD_REQUEST<span class="token punctuation">,</span>        NO_RESOURCE<span class="token punctuation">,</span>        FORBIDDEN_REQUEST<span class="token punctuation">,</span>        FILE_REQUEST<span class="token punctuation">,</span>        INTERNAL_ERROR<span class="token punctuation">,</span>        CLOSED_CONNECTION    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">enum</span> <span class="token class-name">LINE_STATUS</span>    <span class="token punctuation">&#123;</span>        LINE_OK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>        LINE_BAD<span class="token punctuation">,</span>        LINE_OPEN    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">http_conn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token operator">~</span><span class="token function">http_conn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> sockaddr_in <span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> string user<span class="token punctuation">,</span> string passwd<span class="token punctuation">,</span> string sqlname<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">close_conn</span><span class="token punctuation">(</span><span class="token keyword">bool</span> real_close <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    sockaddr_in <span class="token operator">*</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>m_address<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">initmysql_result</span><span class="token punctuation">(</span>connection_pool <span class="token operator">*</span>connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> timer_flag<span class="token punctuation">;</span>    <span class="token keyword">int</span> improv<span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    HTTP_CODE <span class="token function">process_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">process_write</span><span class="token punctuation">(</span>HTTP_CODE ret<span class="token punctuation">)</span><span class="token punctuation">;</span>    HTTP_CODE <span class="token function">parse_request_line</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>    HTTP_CODE <span class="token function">parse_headers</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>    HTTP_CODE <span class="token function">parse_content</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>    HTTP_CODE <span class="token function">do_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">get_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> m_read_buf <span class="token operator">+</span> m_start_line<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    LINE_STATUS <span class="token function">parse_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">add_content</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token keyword">int</span> content_length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">add_content_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">add_content_length</span><span class="token punctuation">(</span><span class="token keyword">int</span> content_length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">add_linger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">add_blank_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> m_epollfd<span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> m_user_count<span class="token punctuation">;</span>    MYSQL <span class="token operator">*</span>mysql<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_state<span class="token punctuation">;</span>  <span class="token comment">//è¯»ä¸º0, å†™ä¸º1</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">int</span> m_sockfd<span class="token punctuation">;</span>    sockaddr_in m_address<span class="token punctuation">;</span>    <span class="token keyword">char</span> m_read_buf<span class="token punctuation">[</span>READ_BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> m_read_idx<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_checked_idx<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_start_line<span class="token punctuation">;</span>    <span class="token keyword">char</span> m_write_buf<span class="token punctuation">[</span>WRITE_BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> m_write_idx<span class="token punctuation">;</span>    CHECK_STATE m_check_state<span class="token punctuation">;</span>    METHOD m_method<span class="token punctuation">;</span>    <span class="token keyword">char</span> m_real_file<span class="token punctuation">[</span>FILENAME_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>m_url<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>m_version<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>m_host<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_content_length<span class="token punctuation">;</span>    <span class="token keyword">bool</span> m_linger<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>m_file_address<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">stat</span> m_file_stat<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">iovec</span> m_iv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> m_iv_count<span class="token punctuation">;</span>    <span class="token keyword">int</span> cgi<span class="token punctuation">;</span>        <span class="token comment">//æ˜¯å¦å¯ç”¨çš„POST</span>    <span class="token keyword">char</span> <span class="token operator">*</span>m_string<span class="token punctuation">;</span> <span class="token comment">//å­˜å‚¨è¯·æ±‚å¤´æ•°æ®</span>    <span class="token keyword">int</span> bytes_to_send<span class="token punctuation">;</span>    <span class="token keyword">int</span> bytes_have_send<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>doc_root<span class="token punctuation">;</span>    map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> string<span class="token operator">></span> m_users<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_TRIGMode<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_close_log<span class="token punctuation">;</span>    <span class="token keyword">char</span> sql_user<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> sql_passwd<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> sql_name<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="http-conn-cppğŸ‘‡"><a href="#http-conn-cppğŸ‘‡" class="headerlink" title="http_conn.cppğŸ‘‡"></a>http_conn.cppğŸ‘‡</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"http_conn.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mysql/mysql.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span><span class="token comment">//å®šä¹‰httpå“åº”çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ok_200_title <span class="token operator">=</span> <span class="token string">"OK"</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>error_400_title <span class="token operator">=</span> <span class="token string">"Bad Request"</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>error_400_form <span class="token operator">=</span> <span class="token string">"Your request has bad syntax or is inherently impossible to staisfy.\n"</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>error_403_title <span class="token operator">=</span> <span class="token string">"Forbidden"</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>error_403_form <span class="token operator">=</span> <span class="token string">"You do not have permission to get file form this server.\n"</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>error_404_title <span class="token operator">=</span> <span class="token string">"Not Found"</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>error_404_form <span class="token operator">=</span> <span class="token string">"The requested file was not found on this server.\n"</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>error_500_title <span class="token operator">=</span> <span class="token string">"Internal Error"</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>error_500_form <span class="token operator">=</span> <span class="token string">"There was an unusual problem serving the request file.\n"</span><span class="token punctuation">;</span>locker m_lock<span class="token punctuation">;</span>map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> string<span class="token operator">></span> users<span class="token punctuation">;</span><span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">initmysql_result</span><span class="token punctuation">(</span>connection_pool <span class="token operator">*</span>connPool<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//å…ˆä»è¿æ¥æ± ä¸­å–ä¸€ä¸ªè¿æ¥</span>    MYSQL <span class="token operator">*</span>mysql <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    connectionRAII <span class="token function">mysqlcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql<span class="token punctuation">,</span> connPool<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åœ¨userè¡¨ä¸­æ£€ç´¢usernameï¼Œpasswdæ•°æ®ï¼Œæµè§ˆå™¨ç«¯è¾“å…¥</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span> <span class="token string">"SELECT username,passwd FROM user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"SELECT error:%s\n"</span><span class="token punctuation">,</span> <span class="token function">mysql_error</span><span class="token punctuation">(</span>mysql<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//ä»è¡¨ä¸­æ£€ç´¢å®Œæ•´çš„ç»“æœé›†</span>    MYSQL_RES <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token function">mysql_store_result</span><span class="token punctuation">(</span>mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è¿”å›ç»“æœé›†ä¸­çš„åˆ—æ•°</span>    <span class="token keyword">int</span> num_fields <span class="token operator">=</span> <span class="token function">mysql_num_fields</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è¿”å›æ‰€æœ‰å­—æ®µç»“æ„çš„æ•°ç»„</span>    MYSQL_FIELD <span class="token operator">*</span>fields <span class="token operator">=</span> <span class="token function">mysql_fetch_fields</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ä»ç»“æœé›†ä¸­è·å–ä¸‹ä¸€è¡Œï¼Œå°†å¯¹åº”çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå­˜å…¥mapä¸­</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>MYSQL_ROW row <span class="token operator">=</span> <span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        string <span class="token function">temp1</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        string <span class="token function">temp2</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        users<span class="token punctuation">[</span>temp1<span class="token punctuation">]</span> <span class="token operator">=</span> temp2<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//å¯¹æ–‡ä»¶æè¿°ç¬¦è®¾ç½®éé˜»å¡</span><span class="token keyword">int</span> <span class="token function">setnonblocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> old_option <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> new_option <span class="token operator">=</span> old_option <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">;</span>    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> new_option<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å°†å†…æ ¸äº‹ä»¶è¡¨æ³¨å†Œè¯»äº‹ä»¶ï¼ŒETæ¨¡å¼ï¼Œé€‰æ‹©å¼€å¯EPOLLONESHOT</span><span class="token keyword">void</span> <span class="token function">addfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">bool</span> one_shot<span class="token punctuation">,</span> <span class="token keyword">int</span> TRIGMode<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    epoll_event event<span class="token punctuation">;</span>    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> TRIGMode<span class="token punctuation">)</span>        event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET <span class="token operator">|</span> EPOLLRDHUP<span class="token punctuation">;</span>    <span class="token keyword">else</span>        event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLRDHUP<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>one_shot<span class="token punctuation">)</span>        event<span class="token punctuation">.</span>events <span class="token operator">|=</span> EPOLLONESHOT<span class="token punctuation">;</span>    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//ä»å†…æ ¸æ—¶é—´è¡¨åˆ é™¤æè¿°ç¬¦</span><span class="token keyword">void</span> <span class="token function">removefd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å°†äº‹ä»¶é‡ç½®ä¸ºEPOLLONESHOT</span><span class="token keyword">void</span> <span class="token function">modfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> ev<span class="token punctuation">,</span> <span class="token keyword">int</span> TRIGMode<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    epoll_event event<span class="token punctuation">;</span>    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> TRIGMode<span class="token punctuation">)</span>        event<span class="token punctuation">.</span>events <span class="token operator">=</span> ev <span class="token operator">|</span> EPOLLET <span class="token operator">|</span> EPOLLONESHOT <span class="token operator">|</span> EPOLLRDHUP<span class="token punctuation">;</span>    <span class="token keyword">else</span>        event<span class="token punctuation">.</span>events <span class="token operator">=</span> ev <span class="token operator">|</span> EPOLLONESHOT <span class="token operator">|</span> EPOLLRDHUP<span class="token punctuation">;</span>    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_MOD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> http_conn<span class="token operator">::</span>m_user_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> http_conn<span class="token operator">::</span>m_epollfd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//å…³é—­è¿æ¥ï¼Œå…³é—­ä¸€ä¸ªè¿æ¥ï¼Œå®¢æˆ·æ€»é‡å‡ä¸€</span><span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">close_conn</span><span class="token punctuation">(</span><span class="token keyword">bool</span> real_close<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>real_close <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>m_sockfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"close %d\n"</span><span class="token punctuation">,</span> m_sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">removefd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>        m_sockfd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        m_user_count<span class="token operator">--</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//åˆå§‹åŒ–è¿æ¥,å¤–éƒ¨è°ƒç”¨åˆå§‹åŒ–å¥—æ¥å­—åœ°å€</span><span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> sockaddr_in <span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>root<span class="token punctuation">,</span> <span class="token keyword">int</span> TRIGMode<span class="token punctuation">,</span>                     <span class="token keyword">int</span> close_log<span class="token punctuation">,</span> string user<span class="token punctuation">,</span> string passwd<span class="token punctuation">,</span> string sqlname<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    m_sockfd <span class="token operator">=</span> sockfd<span class="token punctuation">;</span>    m_address <span class="token operator">=</span> addr<span class="token punctuation">;</span>    <span class="token function">addfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> sockfd<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>    m_user_count<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token comment">//å½“æµè§ˆå™¨å‡ºç°è¿æ¥é‡ç½®æ—¶ï¼Œå¯èƒ½æ˜¯ç½‘ç«™æ ¹ç›®å½•å‡ºé”™æˆ–httpå“åº”æ ¼å¼å‡ºé”™æˆ–è€…è®¿é—®çš„æ–‡ä»¶ä¸­å†…å®¹å®Œå…¨ä¸ºç©º</span>    doc_root <span class="token operator">=</span> root<span class="token punctuation">;</span>    m_TRIGMode <span class="token operator">=</span> TRIGMode<span class="token punctuation">;</span>    m_close_log <span class="token operator">=</span> close_log<span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>sql_user<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>sql_passwd<span class="token punctuation">,</span> passwd<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>sql_name<span class="token punctuation">,</span> sqlname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//åˆå§‹åŒ–æ–°æ¥å—çš„è¿æ¥</span><span class="token comment">//check_stateé»˜è®¤ä¸ºåˆ†æè¯·æ±‚è¡ŒçŠ¶æ€</span><span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    mysql <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    bytes_to_send <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    bytes_have_send <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    m_check_state <span class="token operator">=</span> CHECK_STATE_REQUESTLINE<span class="token punctuation">;</span>    m_linger <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    m_method <span class="token operator">=</span> GET<span class="token punctuation">;</span>    m_url <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    m_version <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    m_content_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    m_host <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    m_start_line <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    m_checked_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    m_read_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    m_write_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    cgi <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    m_state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    timer_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    improv <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>m_read_buf<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> READ_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>m_write_buf<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> WRITE_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> FILENAME_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//ä»çŠ¶æ€æœºï¼Œç”¨äºåˆ†æå‡ºä¸€è¡Œå†…å®¹</span><span class="token comment">//è¿”å›å€¼ä¸ºè¡Œçš„è¯»å–çŠ¶æ€ï¼Œæœ‰LINE_OK,LINE_BAD,LINE_OPEN</span>http_conn<span class="token operator">::</span>LINE_STATUS http_conn<span class="token operator">::</span><span class="token function">parse_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> temp<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> m_checked_idx <span class="token operator">&lt;</span> m_read_idx<span class="token punctuation">;</span> <span class="token operator">++</span>m_checked_idx<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        temp <span class="token operator">=</span> m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token string">'\r'</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m_checked_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> m_read_idx<span class="token punctuation">)</span>                <span class="token keyword">return</span> LINE_OPEN<span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m_read_buf<span class="token punctuation">[</span>m_checked_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>                m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> LINE_OK<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">return</span> LINE_BAD<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_checked_idx <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> m_read_buf<span class="token punctuation">[</span>m_checked_idx <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\r'</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                m_read_buf<span class="token punctuation">[</span>m_checked_idx <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>                m_read_buf<span class="token punctuation">[</span>m_checked_idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> LINE_OK<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">return</span> LINE_BAD<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> LINE_OPEN<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å¾ªç¯è¯»å–å®¢æˆ·æ•°æ®ï¼Œç›´åˆ°æ— æ•°æ®å¯è¯»æˆ–å¯¹æ–¹å…³é—­è¿æ¥</span><span class="token comment">//éé˜»å¡ETå·¥ä½œæ¨¡å¼ä¸‹ï¼Œéœ€è¦ä¸€æ¬¡æ€§å°†æ•°æ®è¯»å®Œ</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_read_idx <span class="token operator">>=</span> READ_BUFFER_SIZE<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> bytes_read <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//LTè¯»å–æ•°æ®</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_TRIGMode<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        bytes_read <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span> m_read_buf <span class="token operator">+</span> m_read_idx<span class="token punctuation">,</span> READ_BUFFER_SIZE <span class="token operator">-</span> m_read_idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m_read_idx <span class="token operator">+=</span> bytes_read<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_read <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//ETè¯»æ•°æ®</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            bytes_read <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span> m_read_buf <span class="token operator">+</span> m_read_idx<span class="token punctuation">,</span> READ_BUFFER_SIZE <span class="token operator">-</span> m_read_idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_read <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN <span class="token operator">||</span> errno <span class="token operator">==</span> EWOULDBLOCK<span class="token punctuation">)</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_read <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            m_read_idx <span class="token operator">+=</span> bytes_read<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//è§£æhttpè¯·æ±‚è¡Œï¼Œè·å¾—è¯·æ±‚æ–¹æ³•ï¼Œç›®æ ‡urlåŠhttpç‰ˆæœ¬å·</span>http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">parse_request_line</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    m_url <span class="token operator">=</span> <span class="token function">strpbrk</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_url<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token operator">*</span>m_url<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>method <span class="token operator">=</span> text<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        m_method <span class="token operator">=</span> GET<span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        m_method <span class="token operator">=</span> POST<span class="token punctuation">;</span>        cgi <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>        <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>    m_url <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    m_version <span class="token operator">=</span> <span class="token function">strpbrk</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_version<span class="token punctuation">)</span>        <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>    <span class="token operator">*</span>m_version<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>    m_version <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>m_version<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>m_version<span class="token punctuation">,</span> <span class="token string">"HTTP/1.1"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"http://"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        m_url <span class="token operator">+=</span> <span class="token number">7</span><span class="token punctuation">;</span>        m_url <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"https://"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        m_url <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">;</span>        m_url <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_url <span class="token operator">||</span> m_url<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'/'</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>    <span class="token comment">//å½“urlä¸º/æ—¶ï¼Œæ˜¾ç¤ºåˆ¤æ–­ç•Œé¢</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>m_url<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token function">strcat</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"judge.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    m_check_state <span class="token operator">=</span> CHECK_STATE_HEADER<span class="token punctuation">;</span>    <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è§£æhttpè¯·æ±‚çš„ä¸€ä¸ªå¤´éƒ¨ä¿¡æ¯</span>http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">parse_headers</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\0'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_content_length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            m_check_state <span class="token operator">=</span> CHECK_STATE_CONTENT<span class="token punctuation">;</span>            <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> GET_REQUEST<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"Connection:"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        text <span class="token operator">+=</span> <span class="token number">11</span><span class="token punctuation">;</span>        text <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"keep-alive"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            m_linger <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"Content-length:"</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        text <span class="token operator">+=</span> <span class="token number">15</span><span class="token punctuation">;</span>        text <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m_content_length <span class="token operator">=</span> <span class="token function">atol</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">"Host:"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        text <span class="token operator">+=</span> <span class="token number">5</span><span class="token punctuation">;</span>        text <span class="token operator">+=</span> <span class="token function">strspn</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" \t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m_host <span class="token operator">=</span> text<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>        <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"oop!unknow header: %s"</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//åˆ¤æ–­httpè¯·æ±‚æ˜¯å¦è¢«å®Œæ•´è¯»å…¥</span>http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">parse_content</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>text<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_read_idx <span class="token operator">>=</span> <span class="token punctuation">(</span>m_content_length <span class="token operator">+</span> m_checked_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        text<span class="token punctuation">[</span>m_content_length<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>        <span class="token comment">//POSTè¯·æ±‚ä¸­æœ€åä¸ºè¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç </span>        m_string <span class="token operator">=</span> text<span class="token punctuation">;</span>        <span class="token keyword">return</span> GET_REQUEST<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">process_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    LINE_STATUS line_status <span class="token operator">=</span> LINE_OK<span class="token punctuation">;</span>    HTTP_CODE ret <span class="token operator">=</span> NO_REQUEST<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>text <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m_check_state <span class="token operator">==</span> CHECK_STATE_CONTENT <span class="token operator">&amp;&amp;</span> line_status <span class="token operator">==</span> LINE_OK<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line_status <span class="token operator">=</span> <span class="token function">parse_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> LINE_OK<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        text <span class="token operator">=</span> <span class="token function">get_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m_start_line <span class="token operator">=</span> m_checked_idx<span class="token punctuation">;</span>        <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>m_check_state<span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>        <span class="token keyword">case</span> CHECK_STATE_REQUESTLINE<span class="token operator">:</span>        <span class="token punctuation">&#123;</span>            ret <span class="token operator">=</span> <span class="token function">parse_request_line</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> BAD_REQUEST<span class="token punctuation">)</span>                <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> CHECK_STATE_HEADER<span class="token operator">:</span>        <span class="token punctuation">&#123;</span>            ret <span class="token operator">=</span> <span class="token function">parse_headers</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> BAD_REQUEST<span class="token punctuation">)</span>                <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> GET_REQUEST<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token function">do_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> CHECK_STATE_CONTENT<span class="token operator">:</span>        <span class="token punctuation">&#123;</span>            ret <span class="token operator">=</span> <span class="token function">parse_content</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> GET_REQUEST<span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token function">do_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            line_status <span class="token operator">=</span> LINE_OPEN<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">default</span><span class="token operator">:</span>            <span class="token keyword">return</span> INTERNAL_ERROR<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> NO_REQUEST<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>http_conn<span class="token operator">::</span>HTTP_CODE http_conn<span class="token operator">::</span><span class="token function">do_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span> doc_root<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>doc_root<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//printf("m_url:%s\n", m_url);</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¤„ç†cgi</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cgi <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'2'</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">//æ ¹æ®æ ‡å¿—åˆ¤æ–­æ˜¯ç™»å½•æ£€æµ‹è¿˜æ˜¯æ³¨å†Œæ£€æµ‹</span>        <span class="token keyword">char</span> flag <span class="token operator">=</span> m_url<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strcat</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> m_url <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> FILENAME_LEN <span class="token operator">-</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å°†ç”¨æˆ·åå’Œå¯†ç æå–å‡ºæ¥</span>        <span class="token comment">//user=123&amp;passwd=123</span>        <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span> password<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> i<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'&amp;'</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>            name<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        name<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span> m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">,</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>            password<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> m_string<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        password<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'3'</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token comment">//å¦‚æœæ˜¯æ³¨å†Œï¼Œå…ˆæ£€æµ‹æ•°æ®åº“ä¸­æ˜¯å¦æœ‰é‡åçš„</span>            <span class="token comment">//æ²¡æœ‰é‡åçš„ï¼Œè¿›è¡Œå¢åŠ æ•°æ®</span>            <span class="token keyword">char</span> <span class="token operator">*</span>sql_insert <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"INSERT INTO user(username, passwd) VALUES("</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"', '"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcat</span><span class="token punctuation">(</span>sql_insert<span class="token punctuation">,</span> <span class="token string">"')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> users<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                m_lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span> sql_insert<span class="token punctuation">)</span><span class="token punctuation">;</span>                users<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>pair<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> string<span class="token operator">></span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                m_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span>                    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/log.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">else</span>                    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/registerError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span>                <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/registerError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//å¦‚æœæ˜¯ç™»å½•ï¼Œç›´æ¥åˆ¤æ–­</span>        <span class="token comment">//è‹¥æµè§ˆå™¨ç«¯è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç åœ¨è¡¨ä¸­å¯ä»¥æŸ¥æ‰¾åˆ°ï¼Œè¿”å›1ï¼Œå¦åˆ™è¿”å›0</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">!=</span> users<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> users<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">==</span> password<span class="token punctuation">)</span>                <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/welcome.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span>                <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url<span class="token punctuation">,</span> <span class="token string">"/logError.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'0'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/register.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/log.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'5'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/picture.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'6'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/video.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'7'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>m_url_real <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">,</span> <span class="token string">"/fans.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url_real<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">free</span><span class="token punctuation">(</span>m_url_real<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>        <span class="token function">strncpy</span><span class="token punctuation">(</span>m_real_file <span class="token operator">+</span> len<span class="token punctuation">,</span> m_url<span class="token punctuation">,</span> FILENAME_LEN <span class="token operator">-</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m_file_stat<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> NO_RESOURCE<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> S_IROTH<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> FORBIDDEN_REQUEST<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISDIR</span><span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> BAD_REQUEST<span class="token punctuation">;</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>m_real_file<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    m_file_address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_PRIVATE<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> FILE_REQUEST<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_file_address<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">munmap</span><span class="token punctuation">(</span>m_file_address<span class="token punctuation">,</span> m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>        m_file_address <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_to_send <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_sockfd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">,</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        temp <span class="token operator">=</span> <span class="token function">writev</span><span class="token punctuation">(</span>m_sockfd<span class="token punctuation">,</span> m_iv<span class="token punctuation">,</span> m_iv_count<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_sockfd<span class="token punctuation">,</span> EPOLLOUT<span class="token punctuation">,</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        bytes_have_send <span class="token operator">+=</span> temp<span class="token punctuation">;</span>        bytes_to_send <span class="token operator">-=</span> temp<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_have_send <span class="token operator">>=</span> m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_file_address <span class="token operator">+</span> <span class="token punctuation">(</span>bytes_have_send <span class="token operator">-</span> m_write_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>            m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> bytes_to_send<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span>        <span class="token punctuation">&#123;</span>            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_write_buf <span class="token operator">+</span> bytes_have_send<span class="token punctuation">;</span>            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">-</span> bytes_have_send<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_to_send <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_sockfd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">,</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_linger<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_response</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_write_idx <span class="token operator">>=</span> WRITE_BUFFER_SIZE<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    va_list arg_list<span class="token punctuation">;</span>    <span class="token function">va_start</span><span class="token punctuation">(</span>arg_list<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">vsnprintf</span><span class="token punctuation">(</span>m_write_buf <span class="token operator">+</span> m_write_idx<span class="token punctuation">,</span> WRITE_BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> m_write_idx<span class="token punctuation">,</span> format<span class="token punctuation">,</span> arg_list<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">>=</span> <span class="token punctuation">(</span>WRITE_BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> m_write_idx<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">va_end</span><span class="token punctuation">(</span>arg_list<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    m_write_idx <span class="token operator">+=</span> len<span class="token punctuation">;</span>    <span class="token function">va_end</span><span class="token punctuation">(</span>arg_list<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"request:%s"</span><span class="token punctuation">,</span> m_write_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>title<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"%s %d %s\r\n"</span><span class="token punctuation">,</span> <span class="token string">"HTTP/1.1"</span><span class="token punctuation">,</span> status<span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token keyword">int</span> content_len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">add_content_length</span><span class="token punctuation">(</span>content_len<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">add_linger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>           <span class="token function">add_blank_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_content_length</span><span class="token punctuation">(</span><span class="token keyword">int</span> content_len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"Content-Length:%d\r\n"</span><span class="token punctuation">,</span> content_len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_content_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"Content-Type:%s\r\n"</span><span class="token punctuation">,</span> <span class="token string">"text/html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_linger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"Connection:%s\r\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>m_linger <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"keep-alive"</span> <span class="token operator">:</span> <span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_blank_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">add_content</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>content<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">add_response</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">bool</span> http_conn<span class="token operator">::</span><span class="token function">process_write</span><span class="token punctuation">(</span>HTTP_CODE ret<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> INTERNAL_ERROR<span class="token operator">:</span>    <span class="token punctuation">&#123;</span>        <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> error_500_title<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>error_500_form<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>error_500_form<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">case</span> BAD_REQUEST<span class="token operator">:</span>    <span class="token punctuation">&#123;</span>        <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> error_404_title<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>error_404_form<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>error_404_form<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">case</span> FORBIDDEN_REQUEST<span class="token operator">:</span>    <span class="token punctuation">&#123;</span>        <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> error_403_title<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>error_403_form<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>error_403_form<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">case</span> FILE_REQUEST<span class="token operator">:</span>    <span class="token punctuation">&#123;</span>        <span class="token function">add_status_line</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> ok_200_title<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_size <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">add_headers</span><span class="token punctuation">(</span>m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_write_buf<span class="token punctuation">;</span>            m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> m_write_idx<span class="token punctuation">;</span>            m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_file_address<span class="token punctuation">;</span>            m_iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>            m_iv_count <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>            bytes_to_send <span class="token operator">=</span> m_write_idx <span class="token operator">+</span> m_file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ok_string <span class="token operator">=</span> <span class="token string">"&lt;html>&lt;body>&lt;/body>&lt;/html>"</span><span class="token punctuation">;</span>            <span class="token function">add_headers</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>ok_string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">add_content</span><span class="token punctuation">(</span>ok_string<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">default</span><span class="token operator">:</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_write_buf<span class="token punctuation">;</span>    m_iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> m_write_idx<span class="token punctuation">;</span>    m_iv_count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    bytes_to_send <span class="token operator">=</span> m_write_idx<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> http_conn<span class="token operator">::</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    HTTP_CODE read_ret <span class="token operator">=</span> <span class="token function">process_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>read_ret <span class="token operator">==</span> NO_REQUEST<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_sockfd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">,</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">bool</span> write_ret <span class="token operator">=</span> <span class="token function">process_write</span><span class="token punctuation">(</span>read_ret<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>write_ret<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">close_conn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">modfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_sockfd<span class="token punctuation">,</span> EPOLLOUT<span class="token punctuation">,</span> m_TRIGMode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="WebServer-hå’ŒWebServer-cppğŸ‘‡"><a href="#WebServer-hå’ŒWebServer-cppğŸ‘‡" class="headerlink" title="WebServer.hå’ŒWebServer.cppğŸ‘‡"></a>WebServer.hå’ŒWebServer.cppğŸ‘‡</h1><h2 id="WebServer-h"><a href="#WebServer-h" class="headerlink" title="WebServer.h"></a>WebServer.h</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">WEBSERVER_H</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WEBSERVER_H</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cassert></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./threadpool/threadpool.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./http/http_conn.h"</span></span><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_FD <span class="token operator">=</span> <span class="token number">65536</span><span class="token punctuation">;</span>           <span class="token comment">//æœ€å¤§æ–‡ä»¶æè¿°ç¬¦</span><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_EVENT_NUMBER <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span> <span class="token comment">//æœ€å¤§äº‹ä»¶æ•°</span><span class="token keyword">const</span> <span class="token keyword">int</span> TIMESLOT <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>             <span class="token comment">//æœ€å°è¶…æ—¶å•ä½</span><span class="token keyword">class</span> <span class="token class-name">WebServer</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">WebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">~</span><span class="token function">WebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> port <span class="token punctuation">,</span> string user<span class="token punctuation">,</span> string passWord<span class="token punctuation">,</span> string databaseName<span class="token punctuation">,</span>              <span class="token keyword">int</span> log_write <span class="token punctuation">,</span> <span class="token keyword">int</span> opt_linger<span class="token punctuation">,</span> <span class="token keyword">int</span> trigmode<span class="token punctuation">,</span> <span class="token keyword">int</span> sql_num<span class="token punctuation">,</span>              <span class="token keyword">int</span> thread_num<span class="token punctuation">,</span> <span class="token keyword">int</span> close_log<span class="token punctuation">,</span> <span class="token keyword">int</span> actor_model<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">sql_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">log_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">trig_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">eventListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">deal_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">,</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">dealclinetdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> <span class="token function">dealwithsignal</span><span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token operator">&amp;</span> timeout<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">&amp;</span> stop_server<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">dealwithread</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">dealwithwrite</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token comment">//åŸºç¡€</span>    <span class="token keyword">int</span> m_port<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>m_root<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_log_write<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_close_log<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_actormodel<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> m_epollfd<span class="token punctuation">;</span>    http_conn <span class="token operator">*</span>users<span class="token punctuation">;</span>    <span class="token comment">//æ•°æ®åº“ç›¸å…³</span>    connection_pool <span class="token operator">*</span>m_connPool<span class="token punctuation">;</span>    string m_user<span class="token punctuation">;</span>         <span class="token comment">//ç™»é™†æ•°æ®åº“ç”¨æˆ·å</span>    string m_passWord<span class="token punctuation">;</span>     <span class="token comment">//ç™»é™†æ•°æ®åº“å¯†ç </span>    string m_databaseName<span class="token punctuation">;</span> <span class="token comment">//ä½¿ç”¨æ•°æ®åº“å</span>    <span class="token keyword">int</span> m_sql_num<span class="token punctuation">;</span>    <span class="token comment">//çº¿ç¨‹æ± ç›¸å…³</span>    threadpool<span class="token operator">&lt;</span>http_conn<span class="token operator">></span> <span class="token operator">*</span>m_pool<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_thread_num<span class="token punctuation">;</span>    <span class="token comment">//epoll_eventç›¸å…³</span>    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> m_listenfd<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_OPT_LINGER<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_TRIGMode<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_LISTENTrigmode<span class="token punctuation">;</span>    <span class="token keyword">int</span> m_CONNTrigmode<span class="token punctuation">;</span>    <span class="token comment">//å®šæ—¶å™¨ç›¸å…³</span>    client_data <span class="token operator">*</span>users_timer<span class="token punctuation">;</span>    Utils utils<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="WebServer-cpp"><a href="#WebServer-cpp" class="headerlink" title="WebServer.cpp"></a>WebServer.cpp</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"webserver.h"</span></span><span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">WebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//http_connç±»å¯¹è±¡</span>    users <span class="token operator">=</span> <span class="token keyword">new</span> http_conn<span class="token punctuation">[</span>MAX_FD<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">//rootæ–‡ä»¶å¤¹è·¯å¾„</span>    <span class="token keyword">char</span> server_path<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">getcwd</span><span class="token punctuation">(</span>server_path<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> root<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/root"</span><span class="token punctuation">;</span>    m_root <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>server_path<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>m_root<span class="token punctuation">,</span> server_path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcat</span><span class="token punctuation">(</span>m_root<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å®šæ—¶å™¨</span>    users_timer <span class="token operator">=</span> <span class="token keyword">new</span> client_data<span class="token punctuation">[</span>MAX_FD<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">WebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">close</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> users<span class="token punctuation">;</span>    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> users_timer<span class="token punctuation">;</span>    <span class="token keyword">delete</span> m_pool<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span> string user<span class="token punctuation">,</span> string passWord<span class="token punctuation">,</span> string databaseName<span class="token punctuation">,</span> <span class="token keyword">int</span> log_write<span class="token punctuation">,</span>                      <span class="token keyword">int</span> opt_linger<span class="token punctuation">,</span> <span class="token keyword">int</span> trigmode<span class="token punctuation">,</span> <span class="token keyword">int</span> sql_num<span class="token punctuation">,</span> <span class="token keyword">int</span> thread_num<span class="token punctuation">,</span> <span class="token keyword">int</span> close_log<span class="token punctuation">,</span> <span class="token keyword">int</span> actor_model<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    m_port <span class="token operator">=</span> port<span class="token punctuation">;</span>    m_user <span class="token operator">=</span> user<span class="token punctuation">;</span>    m_passWord <span class="token operator">=</span> passWord<span class="token punctuation">;</span>    m_databaseName <span class="token operator">=</span> databaseName<span class="token punctuation">;</span>    m_sql_num <span class="token operator">=</span> sql_num<span class="token punctuation">;</span>    m_thread_num <span class="token operator">=</span> thread_num<span class="token punctuation">;</span>    m_log_write <span class="token operator">=</span> log_write<span class="token punctuation">;</span>    m_OPT_LINGER <span class="token operator">=</span> opt_linger<span class="token punctuation">;</span>    m_TRIGMode <span class="token operator">=</span> trigmode<span class="token punctuation">;</span>    m_close_log <span class="token operator">=</span> close_log<span class="token punctuation">;</span>    m_actormodel <span class="token operator">=</span> actor_model<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">trig_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//LT + LT</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_TRIGMode<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        m_LISTENTrigmode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        m_CONNTrigmode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//LT + ET</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> m_TRIGMode<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        m_LISTENTrigmode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        m_CONNTrigmode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//ET + LT</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">==</span> m_TRIGMode<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        m_LISTENTrigmode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        m_CONNTrigmode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//ET + ET</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">==</span> m_TRIGMode<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        m_LISTENTrigmode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        m_CONNTrigmode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">log_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_close_log<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">//åˆå§‹åŒ–æ—¥å¿—</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> m_log_write<span class="token punctuation">)</span>            <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token string">"./ServerLog"</span><span class="token punctuation">,</span> m_close_log<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">800000</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span>            <span class="token class-name">Log</span><span class="token operator">::</span><span class="token function">get_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token string">"./ServerLog"</span><span class="token punctuation">,</span> m_close_log<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">800000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">sql_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//åˆå§‹åŒ–æ•°æ®åº“è¿æ¥æ± </span>    m_connPool <span class="token operator">=</span> connection_pool<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    m_connPool<span class="token operator">-></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> m_user<span class="token punctuation">,</span> m_passWord<span class="token punctuation">,</span> m_databaseName<span class="token punctuation">,</span> <span class="token number">3306</span><span class="token punctuation">,</span> m_sql_num<span class="token punctuation">,</span> m_close_log<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åˆå§‹åŒ–æ•°æ®åº“è¯»å–è¡¨</span>    users<span class="token operator">-></span><span class="token function">initmysql_result</span><span class="token punctuation">(</span>m_connPool<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//çº¿ç¨‹æ± </span>    m_pool <span class="token operator">=</span> <span class="token keyword">new</span> threadpool<span class="token operator">&lt;</span>http_conn<span class="token operator">></span><span class="token punctuation">(</span>m_actormodel<span class="token punctuation">,</span> m_connPool<span class="token punctuation">,</span> m_thread_num<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">eventListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//ç½‘ç»œç¼–ç¨‹åŸºç¡€æ­¥éª¤</span>    m_listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assert</span><span class="token punctuation">(</span>m_listenfd <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ä¼˜é›…å…³é—­è¿æ¥</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_OPT_LINGER<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">struct</span> <span class="token class-name">linger</span> tmp <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token function">setsockopt</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_LINGER<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> m_OPT_LINGER<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">struct</span> <span class="token class-name">linger</span> tmp <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token function">setsockopt</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_LINGER<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> address<span class="token punctuation">;</span>    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>    address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>m_port<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">setsockopt</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>flag<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    utils<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//epollåˆ›å»ºå†…æ ¸äº‹ä»¶è¡¨</span>    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>    m_epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assert</span><span class="token punctuation">(</span>m_epollfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    utils<span class="token punctuation">.</span><span class="token function">addfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_listenfd<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> m_LISTENTrigmode<span class="token punctuation">)</span><span class="token punctuation">;</span>    http_conn<span class="token operator">::</span>m_epollfd <span class="token operator">=</span> m_epollfd<span class="token punctuation">;</span>    ret <span class="token operator">=</span> <span class="token function">socketpair</span><span class="token punctuation">(</span>PF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> m_pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    utils<span class="token punctuation">.</span><span class="token function">setnonblocking</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    utils<span class="token punctuation">.</span><span class="token function">addfd</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    utils<span class="token punctuation">.</span><span class="token function">addsig</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>    utils<span class="token punctuation">.</span><span class="token function">addsig</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span> utils<span class="token punctuation">.</span>sig_handler<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    utils<span class="token punctuation">.</span><span class="token function">addsig</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> utils<span class="token punctuation">.</span>sig_handler<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å·¥å…·ç±»,ä¿¡å·å’Œæè¿°ç¬¦åŸºç¡€æ“ä½œ</span>    Utils<span class="token operator">::</span>u_pipefd <span class="token operator">=</span> m_pipefd<span class="token punctuation">;</span>    Utils<span class="token operator">::</span>u_epollfd <span class="token operator">=</span> m_epollfd<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> connfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> client_address<span class="token punctuation">,</span> m_root<span class="token punctuation">,</span> m_CONNTrigmode<span class="token punctuation">,</span> m_close_log<span class="token punctuation">,</span> m_user<span class="token punctuation">,</span> m_passWord<span class="token punctuation">,</span> m_databaseName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åˆå§‹åŒ–client_dataæ•°æ®</span>    <span class="token comment">//åˆ›å»ºå®šæ—¶å™¨ï¼Œè®¾ç½®å›è°ƒå‡½æ•°å’Œè¶…æ—¶æ—¶é—´ï¼Œç»‘å®šç”¨æˆ·æ•°æ®ï¼Œå°†å®šæ—¶å™¨æ·»åŠ åˆ°é“¾è¡¨ä¸­</span>    users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> client_address<span class="token punctuation">;</span>    users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>sockfd <span class="token operator">=</span> connfd<span class="token punctuation">;</span>    util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> <span class="token keyword">new</span> util_timer<span class="token punctuation">;</span>    timer<span class="token operator">-></span>user_data <span class="token operator">=</span> <span class="token operator">&amp;</span>users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">;</span>    timer<span class="token operator">-></span>cb_func <span class="token operator">=</span> cb_func<span class="token punctuation">;</span>    time_t cur <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    timer<span class="token operator">-></span>expire <span class="token operator">=</span> cur <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> TIMESLOT<span class="token punctuation">;</span>    users_timer<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> timer<span class="token punctuation">;</span>    utils<span class="token punctuation">.</span>m_timer_lst<span class="token punctuation">.</span><span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è‹¥æœ‰æ•°æ®ä¼ è¾“ï¼Œåˆ™å°†å®šæ—¶å™¨å¾€åå»¶è¿Ÿ3ä¸ªå•ä½</span><span class="token comment">//å¹¶å¯¹æ–°çš„å®šæ—¶å™¨åœ¨é“¾è¡¨ä¸Šçš„ä½ç½®è¿›è¡Œè°ƒæ•´</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    time_t cur <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    timer<span class="token operator">-></span>expire <span class="token operator">=</span> cur <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> TIMESLOT<span class="token punctuation">;</span>    utils<span class="token punctuation">.</span>m_timer_lst<span class="token punctuation">.</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"adjust timer once"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">deal_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">,</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    timer<span class="token operator">-></span><span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        utils<span class="token punctuation">.</span>m_timer_lst<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"close fd %d"</span><span class="token punctuation">,</span> users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">bool</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">dealclinetdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">;</span>    socklen_t client_addrlength <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m_LISTENTrigmode<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addrlength<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>connfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s:errno is:%d"</span><span class="token punctuation">,</span> <span class="token string">"accept error"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>http_conn<span class="token operator">::</span>m_user_count <span class="token operator">>=</span> MAX_FD<span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            utils<span class="token punctuation">.</span><span class="token function">show_error</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> <span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">timer</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>m_listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addrlength<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>connfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s:errno is:%d"</span><span class="token punctuation">,</span> <span class="token string">"accept error"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>http_conn<span class="token operator">::</span>m_user_count <span class="token operator">>=</span> MAX_FD<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                utils<span class="token punctuation">.</span><span class="token function">show_error</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> <span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"Internal server busy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">timer</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">bool</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">dealwithsignal</span><span class="token punctuation">(</span><span class="token keyword">bool</span> <span class="token operator">&amp;</span>timeout<span class="token punctuation">,</span> <span class="token keyword">bool</span> <span class="token operator">&amp;</span>stop_server<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> sig<span class="token punctuation">;</span>    <span class="token keyword">char</span> signals<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> signals<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>signals<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ret<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span>signals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>            <span class="token keyword">case</span> SIGALRM<span class="token operator">:</span>            <span class="token punctuation">&#123;</span>                timeout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">case</span> SIGTERM<span class="token operator">:</span>            <span class="token punctuation">&#123;</span>                stop_server <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">dealwithread</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>    <span class="token comment">//reactor</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> m_actormodel<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//è‹¥ç›‘æµ‹åˆ°è¯»äº‹ä»¶ï¼Œå°†è¯¥äº‹ä»¶æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—</span>        m_pool<span class="token operator">-></span><span class="token function">append</span><span class="token punctuation">(</span>users <span class="token operator">+</span> sockfd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token punctuation">)</span>                <span class="token punctuation">&#123;</span>                    <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>                    users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">//proactor</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">read_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"deal with the client(%s)"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//è‹¥ç›‘æµ‹åˆ°è¯»äº‹ä»¶ï¼Œå°†è¯¥äº‹ä»¶æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—</span>            m_pool<span class="token operator">-></span><span class="token function">append_p</span><span class="token punctuation">(</span>users <span class="token operator">+</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span>        <span class="token punctuation">&#123;</span>            <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">dealwithwrite</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>    <span class="token comment">//reactor</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> m_actormodel<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        m_pool<span class="token operator">-></span><span class="token function">append</span><span class="token punctuation">(</span>users <span class="token operator">+</span> sockfd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag<span class="token punctuation">)</span>                <span class="token punctuation">&#123;</span>                    <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>                    users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>improv <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">//proactor</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"send data to the client(%s)"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span>        <span class="token punctuation">&#123;</span>            <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">WebServer</span><span class="token operator">::</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">bool</span> timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">bool</span> stop_server <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_server<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>m_epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"epoll failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>            <span class="token comment">//å¤„ç†æ–°åˆ°çš„å®¢æˆ·è¿æ¥</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> m_listenfd<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token function">dealclinetdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> flag<span class="token punctuation">)</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> <span class="token punctuation">(</span>EPOLLRDHUP <span class="token operator">|</span> EPOLLHUP <span class="token operator">|</span> EPOLLERR<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token comment">//æœåŠ¡å™¨ç«¯å…³é—­è¿æ¥ï¼Œç§»é™¤å¯¹åº”çš„å®šæ—¶å™¨</span>                util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> users_timer<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>                <span class="token function">deal_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//å¤„ç†ä¿¡å·</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">==</span> m_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token function">dealwithsignal</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> stop_server<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> flag<span class="token punctuation">)</span>                    <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"dealclientdata failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//å¤„ç†å®¢æˆ·è¿æ¥ä¸Šæ¥æ”¶åˆ°çš„æ•°æ®</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token function">dealwithread</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token function">dealwithwrite</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            utils<span class="token punctuation">.</span><span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"timer tick"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Config-hå’ŒConfig-cppğŸ‘‡"><a href="#Config-hå’ŒConfig-cppğŸ‘‡" class="headerlink" title="Config.hå’ŒConfig.cppğŸ‘‡"></a>Config.hå’ŒConfig.cppğŸ‘‡</h1><h2 id="Config-h"><a href="#Config-h" class="headerlink" title="Config.h"></a>Config.h</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CONFIG_H</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CONFIG_H</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"webserver.h"</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">~</span><span class="token function">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">parse_arg</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ç«¯å£å·</span>    <span class="token keyword">int</span> PORT<span class="token punctuation">;</span>    <span class="token comment">//æ—¥å¿—å†™å…¥æ–¹å¼</span>    <span class="token keyword">int</span> LOGWrite<span class="token punctuation">;</span>    <span class="token comment">//è§¦å‘ç»„åˆæ¨¡å¼</span>    <span class="token keyword">int</span> TRIGMode<span class="token punctuation">;</span>    <span class="token comment">//listenfdè§¦å‘æ¨¡å¼</span>    <span class="token keyword">int</span> LISTENTrigmode<span class="token punctuation">;</span>    <span class="token comment">//connfdè§¦å‘æ¨¡å¼</span>    <span class="token keyword">int</span> CONNTrigmode<span class="token punctuation">;</span>    <span class="token comment">//ä¼˜é›…å…³é—­é“¾æ¥</span>    <span class="token keyword">int</span> OPT_LINGER<span class="token punctuation">;</span>    <span class="token comment">//æ•°æ®åº“è¿æ¥æ± æ•°é‡</span>    <span class="token keyword">int</span> sql_num<span class="token punctuation">;</span>    <span class="token comment">//çº¿ç¨‹æ± å†…çš„çº¿ç¨‹æ•°é‡</span>    <span class="token keyword">int</span> thread_num<span class="token punctuation">;</span>    <span class="token comment">//æ˜¯å¦å…³é—­æ—¥å¿—</span>    <span class="token keyword">int</span> close_log<span class="token punctuation">;</span>    <span class="token comment">//å¹¶å‘æ¨¡å‹é€‰æ‹©</span>    <span class="token keyword">int</span> actor_model<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Config-cpp"><a href="#Config-cpp" class="headerlink" title="Config.cpp"></a>Config.cpp</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"config.h"</span></span><span class="token class-name">Config</span><span class="token operator">::</span><span class="token function">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//ç«¯å£å·,é»˜è®¤9006</span>    PORT <span class="token operator">=</span> <span class="token number">9006</span><span class="token punctuation">;</span>    <span class="token comment">//æ—¥å¿—å†™å…¥æ–¹å¼ï¼Œé»˜è®¤åŒæ­¥</span>    LOGWrite <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//è§¦å‘ç»„åˆæ¨¡å¼,é»˜è®¤listenfd LT + connfd LT</span>    TRIGMode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//listenfdè§¦å‘æ¨¡å¼ï¼Œé»˜è®¤LT</span>    LISTENTrigmode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//connfdè§¦å‘æ¨¡å¼ï¼Œé»˜è®¤LT</span>    CONNTrigmode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//ä¼˜é›…å…³é—­é“¾æ¥ï¼Œé»˜è®¤ä¸ä½¿ç”¨</span>    OPT_LINGER <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//æ•°æ®åº“è¿æ¥æ± æ•°é‡,é»˜è®¤8</span>    sql_num <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>    <span class="token comment">//çº¿ç¨‹æ± å†…çš„çº¿ç¨‹æ•°é‡,é»˜è®¤8</span>    thread_num <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>    <span class="token comment">//å…³é—­æ—¥å¿—,é»˜è®¤ä¸å…³é—­</span>    close_log <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//å¹¶å‘æ¨¡å‹,é»˜è®¤æ˜¯proactor</span>    actor_model <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token class-name">Config</span><span class="token operator">::</span><span class="token function">parse_arg</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> opt<span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"p:l:m:o:s:t:c:a:"</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>opt <span class="token operator">=</span> <span class="token function">getopt</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>opt<span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>        <span class="token keyword">case</span> <span class="token string">'p'</span><span class="token operator">:</span>        <span class="token punctuation">&#123;</span>            PORT <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> <span class="token string">'l'</span><span class="token operator">:</span>        <span class="token punctuation">&#123;</span>            LOGWrite <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> <span class="token string">'m'</span><span class="token operator">:</span>        <span class="token punctuation">&#123;</span>            TRIGMode <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> <span class="token string">'o'</span><span class="token operator">:</span>        <span class="token punctuation">&#123;</span>            OPT_LINGER <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> <span class="token string">'s'</span><span class="token operator">:</span>        <span class="token punctuation">&#123;</span>            sql_num <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> <span class="token string">'t'</span><span class="token operator">:</span>        <span class="token punctuation">&#123;</span>            thread_num <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> <span class="token string">'c'</span><span class="token operator">:</span>        <span class="token punctuation">&#123;</span>            close_log <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> <span class="token string">'a'</span><span class="token operator">:</span>        <span class="token punctuation">&#123;</span>            actor_model <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">default</span><span class="token operator">:</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;WebServeré¡¹ç›®ä»£ç &quot;&gt;&lt;a href=&quot;#WebServeré¡¹ç›®ä»£ç &quot; class=&quot;headerlink&quot; title=&quot;WebServeré¡¹ç›®ä»£ç &quot;&gt;&lt;/a&gt;WebServeré¡¹ç›®ä»£ç &lt;/h1&gt;&lt;p&gt;è¿™é‡Œä¸“é—¨æ¥å­˜æ”¾ä¸€ä¸‹æˆ‘æ­£åœ¨åšçš„IOå¤šè·¯å¤ç”¨é«˜å¹¶å‘æœåŠ¡å™¨</summary>
      
    
    
    
    <category term="é¡¹ç›®" scheme="http://sakura-pub.top/categories/%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="WebServer" scheme="http://sakura-pub.top/tags/WebServer/"/>
    
    <category term="é¡¹ç›®" scheme="http://sakura-pub.top/tags/%E9%A1%B9%E7%9B%AE/"/>
    
  </entry>
  
  <entry>
    <title>LeetCodeå‘¨èµ›265åœº</title>
    <link href="http://sakura-pub.top/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B265%E5%9C%BA/"/>
    <id>http://sakura-pub.top/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B265%E5%9C%BA/</id>
    <published>2021-11-01T12:07:38.000Z</published>
    <updated>2021-11-01T12:56:31.497Z</updated>
    
    <content type="html"><![CDATA[<h1 id="LeetCodeå‘¨èµ›ç¬¬265åœº"><a href="#LeetCodeå‘¨èµ›ç¬¬265åœº" class="headerlink" title="LeetCodeå‘¨èµ›ç¬¬265åœº"></a>LeetCodeå‘¨èµ›ç¬¬265åœº</h1><p>ç»ˆäºæœ‰æ—¶é—´æ¥è®¤è®¤çœŸçœŸå‚åŠ ä¸€æ¬¡å‘¨èµ›äº†ï¼Œå‰å‡ å‘¨éƒ½æ˜¯æ–­æ–­ç»­ç»­åœ°å‚åŠ ï¼Œå¥½å‡ æ¬¡éƒ½æ˜¯æœ‰ä¼šè¦å¼€ç»™å†²çªäº†</p><p>æœ¬å‘¨å‘¨èµ›æ¯”è¾ƒç®€å•ï¼Œç¬¬ä¸€ã€äºŒé¢˜éƒ½æ˜¯é€åˆ†é¢˜ï¼Œåªæ˜¯ç¬¬äºŒé¢˜ç¨å¾®éº»çƒ¦ä¸€äº›ï¼Œç„¶åç¬¬ä¸‰é¢˜éœ€è¦æ€è€ƒä¸€ä¸‹ï¼Œä½†æˆ‘åšçš„æ—¶å€™å¹¶æ²¡æœ‰æ€è·¯ï¼Œæ‰€ä»¥è¿™æ¬¡é‡ç‚¹æ¥çœ‹ç¬¬ä¸‰é¢˜</p><h2 id="2057-å€¼ç›¸ç­‰çš„æœ€å°ç´¢å¼•"><a href="#2057-å€¼ç›¸ç­‰çš„æœ€å°ç´¢å¼•" class="headerlink" title="2057. å€¼ç›¸ç­‰çš„æœ€å°ç´¢å¼•"></a><a href="https://leetcode-cn.com/problems/smallest-index-with-equal-value/">2057. å€¼ç›¸ç­‰çš„æœ€å°ç´¢å¼•</a></h2><p>é¦–å…ˆæ˜¯ç®€å•é¢˜ï¼Œç…§æ ·ä¹Ÿæ˜¯ä¸€é“é€åˆ†é¢˜ï¼Œè€Œä¸”è¿™é“é¢˜ä¸€åˆ†é’Ÿä¹‹å†…å°±å¯ä»¥å†™å®Œï¼Œæ„Ÿè§‰ä¸è¦å¤ªçˆ½</p><img src="https://i.loli.net/2021/11/01/2a7lsy64WCNFXhT.png" style="zoom:80%;" /><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">int</span> <span class="token function">smallestEqual</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>nums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">10</span><span class="token operator">==</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> i<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="2058-æ‰¾å‡ºä¸´ç•Œç‚¹ä¹‹é—´çš„æœ€å°å’Œæœ€å¤§è·ç¦»"><a href="#2058-æ‰¾å‡ºä¸´ç•Œç‚¹ä¹‹é—´çš„æœ€å°å’Œæœ€å¤§è·ç¦»" class="headerlink" title="2058. æ‰¾å‡ºä¸´ç•Œç‚¹ä¹‹é—´çš„æœ€å°å’Œæœ€å¤§è·ç¦»"></a><a href="https://leetcode-cn.com/problems/find-the-minimum-and-maximum-number-of-nodes-between-critical-points/">2058. æ‰¾å‡ºä¸´ç•Œç‚¹ä¹‹é—´çš„æœ€å°å’Œæœ€å¤§è·ç¦»</a></h2><p>è¿™é“é¢˜æˆ‘åœ¨åšçš„æ—¶å€™ä¹Ÿåšå‡ºæ¥äº†ï¼Œæ€è·¯æ¯”è¾ƒå¥½æƒ³ï¼Œå°±æ˜¯ä»£ç æœ‰ç‚¹å¤šï¼Œæ¯”è¾ƒéº»çƒ¦</p><p>åŒæ—¶åœ¨ä¸€å¼€å§‹çœ‹é¢˜ç›®æ˜¯å¿«é€Ÿçœ‹çš„ï¼Œçœ‹é”™äº†è¿”å›æ¡ä»¶ï¼Œå¥½é™©æ˜¯åœ¨æµ‹è¯•ç”¨ä¾‹æ—¶å‘ç°äº†ï¼Œæ‰€ä»¥é¢˜ç›®é•¿çš„æ—¶å€™æ›´åº”è¯¥æ…¢æ…¢çœ‹é¢˜ç›®ï¼Œä¸è¦ç€æ€¥</p><img src="https://i.loli.net/2021/11/01/zK8uh7MiqBbFsYx.png" style="zoom:80%;" /><img src="https://i.loli.net/2021/11/01/ismdITA5bCnE8w9.png" style="zoom:80%;" /><img src="https://i.loli.net/2021/11/01/CEGDgenFLxi8NqM.png" style="zoom:80%;" /><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/** * Definition for singly-linked list. * struct ListNode &#123; *     int val; *     ListNode *next; *     ListNode() : val(0), next(nullptr) &#123;&#125; *     ListNode(int x) : val(x), next(nullptr) &#123;&#125; *     ListNode(int x, ListNode *next) : val(x), next(next) &#123;&#125; * &#125;; */</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">nodesBetweenCriticalPoints</span><span class="token punctuation">(</span>ListNode<span class="token operator">*</span> head<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token operator">||</span><span class="token operator">!</span>head<span class="token operator">-></span>next<span class="token operator">||</span><span class="token operator">!</span>head<span class="token operator">-></span>next<span class="token operator">-></span>next<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        ListNode<span class="token operator">*</span> lst<span class="token operator">=</span>head<span class="token punctuation">;</span>        ListNode<span class="token operator">*</span> cur<span class="token operator">=</span>head<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token keyword">int</span> index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> minIndex<span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>cur<span class="token operator">-></span>next<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>cur<span class="token operator">-></span>val<span class="token operator">&lt;</span>lst<span class="token operator">-></span>val<span class="token operator">&amp;&amp;</span>cur<span class="token operator">-></span>val<span class="token operator">&lt;</span>cur<span class="token operator">-></span>next<span class="token operator">-></span>val<span class="token punctuation">)</span>                minIndex<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cur<span class="token operator">-></span>val<span class="token operator">></span>lst<span class="token operator">-></span>val<span class="token operator">&amp;&amp;</span>cur<span class="token operator">-></span>val<span class="token operator">></span>cur<span class="token operator">-></span>next<span class="token operator">-></span>val<span class="token punctuation">)</span>                minIndex<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>                        lst<span class="token operator">=</span>lst<span class="token operator">-></span>next<span class="token punctuation">;</span>            cur<span class="token operator">=</span>cur<span class="token operator">-></span>next<span class="token punctuation">;</span>            <span class="token operator">++</span>index<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">res</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> alen<span class="token operator">=</span>minIndex<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>alen<span class="token operator">>=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">sort</span><span class="token punctuation">(</span>minIndex<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>minIndex<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>minIndex<span class="token punctuation">[</span>alen<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>minIndex<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                        <span class="token keyword">int</span> m<span class="token operator">=</span>INT_MAX<span class="token punctuation">;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>alen<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">int</span> temp<span class="token operator">=</span>minIndex<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span>minIndex<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                m<span class="token operator">=</span>temp<span class="token operator">&lt;</span>m<span class="token operator">?</span>temp<span class="token operator">:</span>m<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>m<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="2059-è½¬åŒ–æ•°å­—çš„æœ€å°è¿ç®—æ•°"><a href="#2059-è½¬åŒ–æ•°å­—çš„æœ€å°è¿ç®—æ•°" class="headerlink" title="2059. è½¬åŒ–æ•°å­—çš„æœ€å°è¿ç®—æ•°"></a><a href="https://leetcode-cn.com/problems/minimum-operations-to-convert-number/">2059. è½¬åŒ–æ•°å­—çš„æœ€å°è¿ç®—æ•°</a></h2><p>è¿™é“é¢˜åœ¨ç«èµ›æ—¶çœ‹æ‡‚äº†é¢˜ç›®ï¼ˆç»ˆäºçœ‹æ‡‚ç¬¬ä¸‰é¢˜äº†ï¼Œæ³ªç›®ğŸ˜­ï¼‰ï¼Œä½†è¿˜æ˜¯æ²¡æœ‰æ€è·¯ï¼Œæ‰€ä»¥æ‰“ç®—ç«èµ›æ—¶é—´è¿‡åæ¥å¤ä¹ </p><p>èµ›åæˆ‘çœ‹äº†<a href="https://leetcode-cn.com/problems/minimum-operations-to-convert-number/solution/zhuan-hua-shu-zi-de-zui-xiao-yun-suan-sh-kju7/">å®˜æ–¹é¢˜è§£</a>ï¼Œæ€è·¯å…¶å®è¿˜æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œåˆ©ç”¨äº†é˜Ÿåˆ—æ¥å®ç°<strong>å¹¿åº¦ä¼˜å…ˆéå†</strong>ï¼Œé˜Ÿåˆ—ä¸­æ¯ä¸ªå…ƒç´ çš„ç±»å‹æ˜¯ä¸€ä¸ª<code>pair&lt;int,int&gt;</code>ï¼Œè®°å½•çš„åˆ†åˆ«æ˜¯<code>[è®¡ç®—ç»“æœï¼Œå¾—å‡ºè¯¥ç»“æœæ‰€ç”¨çš„æ­¥æ•°]</code></p><p>æ¯ä¸€æ¬¡éå†ä»é˜Ÿåˆ—ä¸­å–å‡ºç¬¬ä¸€ä¸ªå€¼<code>x</code>ï¼Œå¹¶å°†å…¶è¿›è¡Œ<code>+</code>ã€<code>-</code>ã€<code>^</code>ä¸‰ç§è®¡ç®—ï¼Œå¾—å‡ºç»“æœ<code>nx</code>ï¼Œç„¶ååˆ†ä¸ºå››ç§æƒ…å†µï¼š</p><ul><li>å¦‚æœ<code>nx</code>åˆšå¥½ä¸ºæˆ‘ä»¬è¦æ±‚çš„ç›®æ ‡<code>goal</code>ï¼Œç›´æ¥è¿”å›æ­¥æ•°step+1</li><li><code>nx</code>ä¸åœ¨é¢˜ç›®æ‰€ç»™å®šçš„[1,1000]èŒƒå›´å†…ï¼Œç›´æ¥è·³è¿‡ï¼Œä¸è¿›è¡Œæ“ä½œ</li><li><code>nx</code>åœ¨èŒƒå›´å†…ï¼Œä½†æ˜¯å‰é¢è®¡ç®—çš„æ•°ä¸­å·²ç»å‡ºç°è¿‡è¿™ä¸ªç»“æœäº†ï¼Œä¹Ÿæ˜¯ç›´æ¥è·³è¿‡ï¼Œä¸è¿›è¡Œæ“ä½œï¼ˆâ— è¿™é‡Œå°±è¦æ±‚æˆ‘ä»¬é¢å¤–è®°å½•ä¸€ä¸‹ä¹‹å‰å‡ºç°çš„ç»“æœï¼Œæˆ‘ç”¨çš„æ˜¯<code>vector&lt;bool&gt;</code>æ•°ç»„ï¼‰</li><li><code>nx</code>åœ¨èŒƒå›´å†…ï¼Œå‰é¢ä¹Ÿæ²¡æœ‰å‡ºç°è¿‡è¿™ä¸ªæ•°ï¼Œåˆ™å°†å¾—å‡ºçš„<code>nx</code>ä»¥<code>pair</code>çš„æ–¹å¼åŠ åˆ°é˜Ÿåˆ—ä¸­</li></ul><p>â— å¦å¤–ä¸€ä¸ªè¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºé¢˜ç›®è¿˜è¦æ±‚è®¡ç®—çš„æ•°è¦åˆ©ç”¨ç»™å®šæ•°ç»„<code>nums</code>ä¸­çš„æ•°ï¼Œæ‰€ä»¥è¿™é‡Œè¦ä¸¤å±‚éå†ï¼Œä¸€å±‚æ˜¯ä¸‰ä¸ªæ“ä½œç¬¦ï¼Œå¦ä¸€å±‚æ˜¯å’Œ<code>nums</code>ä¸­çš„å„ä¸ªæ•°è®¡ç®—</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">int</span> <span class="token function">minimumOperations</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> goal<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> nums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">auto</span> op1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">int</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">auto</span> op2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">int</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> x <span class="token operator">-</span> y<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">auto</span> op3 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">int</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> x <span class="token operator">^</span> y<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        vector<span class="token operator">&lt;</span>function<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">>></span> ops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>op1<span class="token punctuation">,</span> op2<span class="token punctuation">,</span> op3<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>   <span class="token comment">// è¿ç®—ç¬¦åˆ—è¡¨</span>        vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">vis</span><span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// å¯æ“ä½œèŒƒå›´å†…æ•´æ•°çš„è®¿é—®æƒ…å†µ</span>        queue<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">>></span> q<span class="token punctuation">;</span>        q<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        vis<span class="token punctuation">[</span>start<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">auto</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> step<span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            q<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// æšä¸¾æ•°ç»„ä¸­çš„å…ƒç´ å’Œæ“ä½œç¬¦å¹¶è®¡ç®—æ–°ç”Ÿæˆçš„æ•°å€¼</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> op<span class="token operator">:</span> ops<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token keyword">int</span> nx <span class="token operator">=</span> <span class="token function">op</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// å¦‚æœæ–°ç”Ÿæˆçš„æ•°å€¼ç­‰äºç›®æ ‡å€¼ï¼Œåˆ™è¿”å›å¯¹åº”æ“ä½œæ•°</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>nx <span class="token operator">==</span> goal<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                        <span class="token keyword">return</span> step <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                    <span class="token comment">// å¦‚æœæ–°ç”Ÿæˆçš„æ•°å€¼ä½äºå¯æ“ä½œèŒƒå›´å†…ä¸”æœªè¢«åŠ å…¥é˜Ÿåˆ—ï¼Œåˆ™æ›´æ”¹è®¿é—®æƒ…å†µå¹¶åŠ å…¥é˜Ÿåˆ—</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>nx <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> nx <span class="token operator">&lt;=</span> <span class="token number">1000</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vis<span class="token punctuation">[</span>nx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                        vis<span class="token punctuation">[</span>nx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                        q<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>nx<span class="token punctuation">,</span> step <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// ä¸å­˜åœ¨ä»åˆå§‹å€¼åˆ°ç›®æ ‡å€¼çš„è½¬åŒ–æ–¹æ¡ˆ</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;LeetCodeå‘¨èµ›ç¬¬265åœº&quot;&gt;&lt;a href=&quot;#LeetCodeå‘¨èµ›ç¬¬265åœº&quot; class=&quot;headerlink&quot; title=&quot;LeetCodeå‘¨èµ›ç¬¬265åœº&quot;&gt;&lt;/a&gt;LeetCodeå‘¨èµ›ç¬¬265åœº&lt;/h1&gt;&lt;p&gt;ç»ˆäºæœ‰æ—¶é—´æ¥è®¤è®¤çœŸçœŸå‚åŠ ä¸€æ¬¡å‘¨èµ›äº†ï¼Œ</summary>
      
    
    
    
    <category term="LeetCodeåˆ·é¢˜ç¬”è®°" scheme="http://sakura-pub.top/categories/LeetCode%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="LeetCode" scheme="http://sakura-pub.top/tags/LeetCode/"/>
    
  </entry>
  
  <entry>
    <title>LeetCodeå‘¨èµ›258åœº</title>
    <link href="http://sakura-pub.top/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B258%E5%9C%BA/"/>
    <id>http://sakura-pub.top/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B258%E5%9C%BA/</id>
    <published>2021-09-12T06:12:39.000Z</published>
    <updated>2021-09-12T07:56:17.491Z</updated>
    
    <content type="html"><![CDATA[<h1 id="LeetCodeå‘¨èµ›257åœº"><a href="#LeetCodeå‘¨èµ›257åœº" class="headerlink" title="LeetCodeå‘¨èµ›257åœº"></a>LeetCodeå‘¨èµ›257åœº</h1><p>è¿™å‘¨çš„å‘¨èµ›ç¬¬äºŒé¢˜å¡äº†æŒºä¹…çš„ï¼Œç‰¹åˆ«æ˜¯æœ€åé¢å‡ ä¸ªç”¨ä¾‹</p><p>ç„¶åæ˜¯ç¬¬ä¸‰é¢˜ï¼Œè™½ç„¶æ²¡æœ‰åšä½†æ˜¯çœ‹äº†ä¸€ä¸‹ï¼Œæ„Ÿè§‰ä¹ŸæŒºæœ‰è¶£çš„:ice_cream:</p><h2 id="5867-åè½¬å•è¯å‰ç¼€-â€”ï¼ˆç®€å•ï¼‰"><a href="#5867-åè½¬å•è¯å‰ç¼€-â€”ï¼ˆç®€å•ï¼‰" class="headerlink" title="5867. åè½¬å•è¯å‰ç¼€    â€”ï¼ˆç®€å•ï¼‰"></a><a href="https://leetcode-cn.com/problems/reverse-prefix-of-word/">5867. åè½¬å•è¯å‰ç¼€</a>    â€”ï¼ˆç®€å•ï¼‰</h2><img src="https://i.loli.net/2021/09/12/AXe5iKohCBj9Uw1.png" style="zoom:80%;" /><p>ç¬¬ä¸€é¢˜é€åˆ†é¢˜ï¼Œæ€ä¹ˆèˆ’æœæ€ä¹ˆæ¥</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    string <span class="token function">reversePrefix</span><span class="token punctuation">(</span>string word<span class="token punctuation">,</span> <span class="token keyword">char</span> ch<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> wlen<span class="token operator">=</span>word<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>wlen<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span>ch<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                index<span class="token operator">=</span>i<span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>index<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span>            <span class="token function">reverse</span><span class="token punctuation">(</span>word<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>word<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> word<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="5868-å¯äº’æ¢çŸ©å½¢çš„ç»„æ•°-â€”ï¼ˆä¸­ç­‰ï¼‰"><a href="#5868-å¯äº’æ¢çŸ©å½¢çš„ç»„æ•°-â€”ï¼ˆä¸­ç­‰ï¼‰" class="headerlink" title="5868. å¯äº’æ¢çŸ©å½¢çš„ç»„æ•°    â€”ï¼ˆä¸­ç­‰ï¼‰"></a><a href="https://leetcode-cn.com/problems/number-of-pairs-of-interchangeable-rectangles/">5868. å¯äº’æ¢çŸ©å½¢çš„ç»„æ•°</a>    â€”ï¼ˆä¸­ç­‰ï¼‰</h2><img src="https://i.loli.net/2021/09/12/LQGpVs37gmyHbO4.png" style="zoom:80%;" /><p>æç¤ºï¼š</p><ul><li>n == rectangles.length</li><li>1 &lt;= n &lt;= 105</li><li>rectangles[i].length == 2</li><li>1 &lt;= widthi, heighti &lt;= 105</li></ul><p>è¿™é“é¢˜å‡ºé”™å¥½å¤šæ¬¡ï¼Œå…¨éƒ½æ˜¯ç»†èŠ‚é—®é¢˜ï¼Œåˆšå¼€å§‹æƒ³ç€æš´åŠ›è§£æ³•å’Œè®°å¿†è¡¨è§£æ³•ï¼Œä½†æ˜¯éƒ½è¶…æ—¶äº†:point_down:</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//ï¼ï¼ï¼ä¸‹é¢ä»£ç æ˜¯è¶…æ—¶çš„è§£æ³•ï¼ï¼ï¼</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token function">interchangeableRectangles</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span><span class="token operator">&amp;</span> rectangles<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> rlen<span class="token operator">=</span>rectangles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//çŸ©é˜µä¸ªæ•°</span>        vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> <span class="token function">map</span><span class="token punctuation">(</span>rlen<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>rlen<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>            map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>rectangles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">/</span>rectangles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        std<span class="token operator">::</span><span class="token function">sort</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>map<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>rlen<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>rlen<span class="token punctuation">;</span><span class="token operator">++</span>j<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span>map<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>                    <span class="token operator">++</span>res<span class="token punctuation">;</span>                <span class="token keyword">else</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åé¢˜ç›®æ€»å…±æœ‰46ä¸ªç”¨ä¾‹ï¼Œåé¢ä¸€ç›´å¡åœ¨åé¢å‡ ä¸ªï¼Œç›´æ¥ç—›è‹¦é¢å…·:sweat:</p><p>èµ›åçœ‹äº†ä¸€ä¸‹åˆ«äººçš„è§£æ³•ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼Œéƒ½æ˜¯è¿ç”¨äº†å“ˆå¸Œè¡¨æ¥å®ç°</p><p>æœ‰å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š</p><ol><li>ç²¾åº¦é—®é¢˜ï¼Œx/yæŒ‰doubleæ±‚çš„è¯åº”è¯¥ä¸ä¼šæœ‰é—®é¢˜ï¼Œæœ€å¥½çš„æ–¹æ³•åº”è¯¥æ˜¯å…ˆæ±‚æœ€å¤§å…¬çº¦æ•°ï¼Œç„¶ååŒ–ç®€ï¼›</li><li>ä¿å­˜ç»“æœçš„è¯ï¼Œæ³¨æ„keyä¸º<strong>pairæ—¶é»˜è®¤ä¸æ”¯æŒunordered_map</strong>;ï¼ˆ:warning:è¿™ä¸ªè¦æ³¨æ„ï¼‰</li><li>æ³¨æ„æ•°æ®èŒƒå›´ï¼Œè¯¥ç”¨long longçš„åœ°æ–¹ä¸èƒ½çŠ¹è±«ã€‚</li></ol><p>å…¶ä¸­ä¸€ç§æ™®é€šçš„è§£æ³•å¯èƒ½ä¼šæœ‰ç»™å¡ç²¾åº¦çš„é£é™©ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªç²¾åº¦å·®ä¸å¤šçš„æ•°è€Œå¯¼è‡´<code>res</code>æ”¹å˜ï¼Œä½†æœ¬é¢˜ç›®å¹¶æ²¡æœ‰å¡ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥äº†è§£ä¸€ä¸‹è¯¥è§£æ³•</p><p>ç®€å•æ¥è¯´å°±æ˜¯éå†ä¸€éçŸ©å½¢ï¼Œæ±‚å‡ºå„ä¸ªçŸ©é˜µçš„å®½é«˜æ¯”å¹¶æ‰“å…¥å“ˆå¸Œè¡¨ä¸­ï¼Œå“ˆå¸Œè¡¨è®°å½•çš„æ˜¯æ¯ä¸€ç§å®½é«˜æ¯”çš„æ€»æ•°</p><p>æœ€åå†è¿ç”¨é«˜ä¸­çŸ¥è¯†æ’åˆ—ç»„åˆçš„<code>ç»„åˆå…¬å¼</code>æ¥æ±‚ï¼Œï¼ˆåœ¨ä¸€å †ç›¸åŒçš„å®½é«˜æ¯”ä¸­é€‰å‡ºä¸¤ä¸ªæ¥é…å¯¹ï¼‰</p><img src="https://i.loli.net/2021/09/12/HBOSmRXbVlp2AWe.png" style="zoom:80%;" /><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token function">interchangeableRectangles</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span><span class="token operator">&amp;</span> rectangles<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    unordered_map<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token operator">></span>map<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> arr<span class="token operator">:</span>rectangles<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">double</span> cur<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">/</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token operator">++</span>map<span class="token punctuation">[</span>cur<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span>second<span class="token punctuation">]</span><span class="token operator">:</span>map<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        res<span class="token operator">+=</span><span class="token punctuation">(</span>second<span class="token operator">*</span><span class="token punctuation">(</span>second<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¬¬äºŒç§è§£æ³•åˆšå¼€å§‹æˆ‘æ˜¯ä¸å¤ªæ‡‚çš„ï¼Œå®ƒæ˜¯ç”¨äº†<code>gcd()</code>æ¥æ±‚å®½å’Œé«˜ä¹‹é—´<code>æœ€å¤§å…¬å› æ•°</code>ï¼Œå†åˆ©ç”¨å®ƒæ¥åŒ–ç®€å®½é«˜æ¯”ï¼šå°†(åˆ†å­*BASE+åˆ†æ¯)ä½œä¸ºä¸€ä¸ªkeyå­˜å…¥å“ˆå¸Œè¡¨</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">int</span> <span class="token function">gcd</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span><span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>b<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> a<span class="token punctuation">;</span>        <span class="token keyword">else</span>            <span class="token keyword">return</span> <span class="token function">gcd</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span>a<span class="token operator">%</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token function">interchangeableRectangles</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span><span class="token operator">&amp;</span> rectangles<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        unordered_map<span class="token operator">&lt;</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">,</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token operator">></span>map<span class="token punctuation">;</span>        <span class="token keyword">constexpr</span> <span class="token keyword">long</span> <span class="token keyword">long</span> BASE<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token number">1e8</span><span class="token punctuation">;</span><span class="token comment">//åŸºæ•°ï¼Œå¤§ä¸€ç‚¹çš„æ•°éƒ½å¯ä»¥</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> arr<span class="token operator">:</span>rectangles<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> c<span class="token operator">=</span><span class="token function">gcd</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">long</span> <span class="token keyword">long</span> frac<span class="token operator">=</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">/</span>c<span class="token punctuation">)</span><span class="token operator">*</span>BASE<span class="token operator">+</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">/</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åŒ–ç®€ï¼Œä¹˜ä¸ŠåŸºæ•°ä»¥ä¾¿åœ¨å“ˆå¸Œè¡¨å†…åŒºåˆ†</span>            <span class="token operator">++</span>map<span class="token punctuation">[</span>frac<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">long</span> <span class="token keyword">long</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span>second<span class="token punctuation">]</span><span class="token operator">:</span>map<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            res<span class="token operator">+=</span><span class="token punctuation">(</span>second<span class="token operator">*</span><span class="token punctuation">(</span>second<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="5869-ä¸¤ä¸ªå›æ–‡å­åºåˆ—é•¿åº¦çš„æœ€å¤§ä¹˜ç§¯-â€”ï¼ˆä¸­ç­‰ï¼‰"><a href="#5869-ä¸¤ä¸ªå›æ–‡å­åºåˆ—é•¿åº¦çš„æœ€å¤§ä¹˜ç§¯-â€”ï¼ˆä¸­ç­‰ï¼‰" class="headerlink" title="5869. ä¸¤ä¸ªå›æ–‡å­åºåˆ—é•¿åº¦çš„æœ€å¤§ä¹˜ç§¯    â€”ï¼ˆä¸­ç­‰ï¼‰"></a><a href="https://leetcode-cn.com/problems/maximum-product-of-the-length-of-two-palindromic-subsequences/">5869. ä¸¤ä¸ªå›æ–‡å­åºåˆ—é•¿åº¦çš„æœ€å¤§ä¹˜ç§¯</a>    â€”ï¼ˆä¸­ç­‰ï¼‰</h2><p>ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² s ï¼Œè¯·ä½ æ‰¾åˆ° s ä¸­ä¸¤ä¸ª ä¸ç›¸äº¤å›æ–‡å­åºåˆ— ï¼Œä½¿å¾—å®ƒä»¬é•¿åº¦çš„ ä¹˜ç§¯æœ€å¤§ ã€‚ä¸¤ä¸ªå­åºåˆ—åœ¨åŸå­—ç¬¦ä¸²ä¸­å¦‚æœæ²¡æœ‰ä»»ä½•ç›¸åŒä¸‹æ ‡çš„å­—ç¬¦ï¼Œåˆ™å®ƒä»¬æ˜¯ ä¸ç›¸äº¤ çš„ã€‚</p><p>è¯·ä½ è¿”å›ä¸¤ä¸ªå›æ–‡å­åºåˆ—é•¿åº¦å¯ä»¥è¾¾åˆ°çš„ æœ€å¤§ä¹˜ç§¯ ã€‚</p><p>å­åºåˆ— æŒ‡çš„æ˜¯ä»åŸå­—ç¬¦ä¸²ä¸­åˆ é™¤è‹¥å¹²ä¸ªå­—ç¬¦ï¼ˆå¯ä»¥ä¸€ä¸ªä¹Ÿä¸åˆ é™¤ï¼‰åï¼Œå‰©ä½™å­—ç¬¦ä¸æ”¹å˜é¡ºåºè€Œå¾—åˆ°çš„ç»“æœã€‚å¦‚æœä¸€ä¸ªå­—ç¬¦ä¸²ä»å‰å¾€åè¯»å’Œä»åå¾€å‰è¯»ä¸€æ¨¡ä¸€æ ·ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—ç¬¦ä¸²æ˜¯ä¸€ä¸ª å›æ–‡å­—ç¬¦ä¸² ã€‚</p><p>ç¤ºä¾‹ 1ï¼š</p><img src="https://i.loli.net/2021/09/12/lZzOQqu7myNiCaG.png" style="zoom:80%;" /><blockquote><p>è¾“å…¥ï¼šs = â€œleetcodecomâ€<br>è¾“å‡ºï¼š9<br>è§£é‡Šï¼šæœ€ä¼˜æ–¹æ¡ˆæ˜¯é€‰æ‹© â€œeteâ€ ä½œä¸ºç¬¬ä¸€ä¸ªå­åºåˆ—ï¼Œâ€cdcâ€ ä½œä¸ºç¬¬äºŒä¸ªå­åºåˆ—ã€‚<br>å®ƒä»¬çš„ä¹˜ç§¯ä¸º 3 * 3 = 9 ã€‚</p></blockquote><p>ç¤ºä¾‹ 2ï¼š</p><blockquote><p>è¾“å…¥ï¼šs = â€œbbâ€<br>è¾“å‡ºï¼š1<br>è§£é‡Šï¼šæœ€ä¼˜æ–¹æ¡ˆä¸ºé€‰æ‹© â€œbâ€ ï¼ˆç¬¬ä¸€ä¸ªå­—ç¬¦ï¼‰ä½œä¸ºç¬¬ä¸€ä¸ªå­åºåˆ—ï¼Œâ€bâ€ ï¼ˆç¬¬äºŒä¸ªå­—ç¬¦ï¼‰ä½œä¸ºç¬¬äºŒä¸ªå­åºåˆ—ã€‚<br>å®ƒä»¬çš„ä¹˜ç§¯ä¸º 1 * 1 = 1 ã€‚</p></blockquote><p>ç¤ºä¾‹ 3ï¼š</p><blockquote><p>è¾“å…¥ï¼šs = â€œaccbcaxxcxxâ€<br>è¾“å‡ºï¼š25<br>è§£é‡Šï¼šæœ€ä¼˜æ–¹æ¡ˆä¸ºé€‰æ‹© â€œacccaâ€ ä½œä¸ºç¬¬ä¸€ä¸ªå­åºåˆ—ï¼Œâ€xxcxxâ€ ä½œä¸ºç¬¬äºŒä¸ªå­åºåˆ—ã€‚<br>å®ƒä»¬çš„ä¹˜ç§¯ä¸º 5 * 5 = 25 ã€‚</p></blockquote><p>æç¤ºï¼š</p><ul><li>2 &lt;= s.length &lt;= 12</li><li>s åªå«æœ‰å°å†™è‹±æ–‡å­—æ¯</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;LeetCodeå‘¨èµ›257åœº&quot;&gt;&lt;a href=&quot;#LeetCodeå‘¨èµ›257åœº&quot; class=&quot;headerlink&quot; title=&quot;LeetCodeå‘¨èµ›257åœº&quot;&gt;&lt;/a&gt;LeetCodeå‘¨èµ›257åœº&lt;/h1&gt;&lt;p&gt;è¿™å‘¨çš„å‘¨èµ›ç¬¬äºŒé¢˜å¡äº†æŒºä¹…çš„ï¼Œç‰¹åˆ«æ˜¯æœ€åé¢å‡ ä¸ª</summary>
      
    
    
    
    <category term="LeetCodeåˆ·é¢˜ç¬”è®°" scheme="http://sakura-pub.top/categories/LeetCode%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="LeetCode" scheme="http://sakura-pub.top/tags/LeetCode/"/>
    
  </entry>
  
  <entry>
    <title>LeetCodeå‘¨èµ›257åœº</title>
    <link href="http://sakura-pub.top/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B257%E5%9C%BA/"/>
    <id>http://sakura-pub.top/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B257%E5%9C%BA/</id>
    <published>2021-09-05T05:56:24.000Z</published>
    <updated>2021-09-05T08:21:26.972Z</updated>
    
    <content type="html"><![CDATA[<h1 id="LeetCodeå‘¨èµ›ç¬¬257åœº"><a href="#LeetCodeå‘¨èµ›ç¬¬257åœº" class="headerlink" title="LeetCodeå‘¨èµ›ç¬¬257åœº"></a><a href="https://leetcode-cn.com/contest/weekly-contest-257/">LeetCodeå‘¨èµ›ç¬¬257åœº</a></h1><p>ç”±äºä¸Šä¸€æ¬¡å‘¨èµ›çš„æ—¶å€™LeetCodeæœåŠ¡å™¨å‡ºäº†é—®é¢˜ï¼Œæ‰€ä»¥ä¸Šæ¬¡çš„å‘¨èµ›æ²¡æœ‰å‚åŠ åˆ°</p><p>è€Œæœ¬å‘¨çš„å‘¨èµ›å¼€å§‹å‰æœåŠ¡å™¨ä¹Ÿå‡ºäº†ä¸€äº›é—®é¢˜ï¼Œå¥½åœ¨ä¿®å¤åœ°å¿«è¿›å»äº†</p><img src="C:\Users\ZhaoYJ\AppData\Roaming\Typora\typora-user-images\image-20210905142220496.png" alt="image-20210905142220496" style="zoom:80%;" /><p>è¿™å‘¨çš„å‘¨èµ›åˆè®©æˆ‘ä»ä¸¤é“é€‰æ‰‹é€€åŒ–æˆäº†ä¸€é“é€‰æ‰‹ï¼ˆå‰ä¸¤é“ç›´æ¥å¯„ï¼‰</p><p>å‰ä¸¤é¢˜éƒ½æ˜¯æ•°ç»„é¢˜ï¼Œåé¢ä¸¤é¢˜å°±æ²¡æ€ä¹ˆçœ‹äº†ï¼Œè¿™é‡Œå°±å…ˆè®°å½•å‰ä¸¤é“é¢˜ç›®</p><h2 id="5863-ç»Ÿè®¡ç‰¹æ®Šå››å…ƒç»„"><a href="#5863-ç»Ÿè®¡ç‰¹æ®Šå››å…ƒç»„" class="headerlink" title="5863. ç»Ÿè®¡ç‰¹æ®Šå››å…ƒç»„"></a><a href="https://leetcode-cn.com/problems/count-special-quadruplets/">5863. ç»Ÿè®¡ç‰¹æ®Šå››å…ƒç»„</a></h2><p>ç»™ä½ ä¸€ä¸ª ä¸‹æ ‡ä» 0 å¼€å§‹ çš„æ•´æ•°æ•°ç»„ nums ï¼Œè¿”å›æ»¡è¶³ä¸‹è¿°æ¡ä»¶çš„ ä¸åŒ å››å…ƒç»„ (a, b, c, d) çš„ æ•°ç›® ï¼š</p><ul><li>nums[a] + nums[b] + nums[c] == nums[d] ï¼Œä¸”</li><li>a &lt; b &lt; c &lt; d</li></ul><p>ç¤ºä¾‹ 1ï¼š</p><blockquote><p>è¾“å…¥ï¼šnums = [1,2,3,6]<br>è¾“å‡ºï¼š1<br>è§£é‡Šï¼šæ»¡è¶³è¦æ±‚çš„å”¯ä¸€ä¸€ä¸ªå››å…ƒç»„æ˜¯ (0, 1, 2, 3) å› ä¸º 1 + 2 + 3 == 6 ã€‚</p></blockquote><p>ç¤ºä¾‹ 2ï¼š</p><blockquote><p>è¾“å…¥ï¼šnums = [3,3,6,4,5]<br>è¾“å‡ºï¼š0<br>è§£é‡Šï¼š[3,3,6,4,5] ä¸­ä¸å­˜åœ¨æ»¡è¶³è¦æ±‚çš„å››å…ƒç»„ã€‚</p></blockquote><p>ç¤ºä¾‹ 3ï¼š</p><blockquote><p>è¾“å…¥ï¼šnums = [1,1,1,3,5]<br>è¾“å‡ºï¼š4<br>è§£é‡Šï¼šæ»¡è¶³è¦æ±‚çš„ 4 ä¸ªå››å…ƒç»„å¦‚ä¸‹ï¼š</p></blockquote><ul><li>(0, 1, 2, 3): 1 + 1 + 1 == 3</li><li>(0, 1, 3, 4): 1 + 1 + 3 == 5</li><li>(0, 2, 3, 4): 1 + 1 + 3 == 5</li><li>(1, 2, 3, 4): 1 + 1 + 3 == 5</li></ul><p>ç¬¬ä¸€é“é¢˜å› ä¸ºæ•°ç»„é•¿åº¦æœ€å¤§åˆ°50ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å››é‡å¾ªç¯æš´åŠ›è§£æ³•</p><p>ä½†æ˜¯è¦æ³¨æ„æ˜¯ä¸èƒ½sortï¼Œå› ä¸ºé¢˜ç›®ç»™å®šäº†æ¡ä»¶ï¼Œåˆå§‹ä¸‹æ ‡ä¸­<code>a&lt;b&lt;c&lt;d</code>ï¼Œå¦‚æœæ’åºçš„è¯å°±ä¼šæ‰“ä¹±ä¸‹æ ‡é¡ºåºäº†ï¼Œæˆ‘åœ¨åšé¢˜ä¸­å‡ºé”™äº†ä¸€æ¬¡ä¹Ÿæ˜¯è¿™ä¸ªåŸå› </p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">int</span> <span class="token function">countQuadruplets</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//ä¸èƒ½sort</span>        <span class="token keyword">int</span> nlen<span class="token operator">=</span>nums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>a<span class="token operator">&lt;</span>nlen<span class="token punctuation">;</span><span class="token operator">++</span>a<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> b<span class="token operator">=</span>a<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>b<span class="token operator">&lt;</span>nlen<span class="token punctuation">;</span><span class="token operator">++</span>b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token operator">=</span>b<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>c<span class="token operator">&lt;</span>nlen<span class="token punctuation">;</span><span class="token operator">++</span>c<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> d<span class="token operator">=</span>c<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>d<span class="token operator">&lt;</span>nlen<span class="token punctuation">;</span><span class="token operator">++</span>d<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token operator">+</span>nums<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token operator">+</span>nums<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token operator">==</span>nums<span class="token punctuation">[</span>d<span class="token punctuation">]</span><span class="token punctuation">)</span>                            <span class="token operator">++</span>res<span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ—¶é—´å¤æ‚åº¦ï¼šO(N^4)</p><hr><h2 id="5864-æ¸¸æˆä¸­å¼±è§’è‰²çš„æ•°é‡"><a href="#5864-æ¸¸æˆä¸­å¼±è§’è‰²çš„æ•°é‡" class="headerlink" title="5864. æ¸¸æˆä¸­å¼±è§’è‰²çš„æ•°é‡"></a><a href="https://leetcode-cn.com/problems/the-number-of-weak-characters-in-the-game/">5864. æ¸¸æˆä¸­å¼±è§’è‰²çš„æ•°é‡</a></h2><p>ä½ æ­£åœ¨å‚åŠ ä¸€ä¸ªå¤šè§’è‰²æ¸¸æˆï¼Œæ¯ä¸ªè§’è‰²éƒ½æœ‰ä¸¤ä¸ªä¸»è¦å±æ€§ï¼šæ”»å‡» å’Œ é˜²å¾¡ ã€‚ç»™ä½ ä¸€ä¸ªäºŒç»´æ•´æ•°æ•°ç»„ properties ï¼Œå…¶ä¸­ properties[i] = [attacki, defensei] è¡¨ç¤ºæ¸¸æˆä¸­ç¬¬ i ä¸ªè§’è‰²çš„å±æ€§ã€‚</p><p>å¦‚æœå­˜åœ¨ä¸€ä¸ªå…¶ä»–è§’è‰²çš„æ”»å‡»å’Œé˜²å¾¡ç­‰çº§ éƒ½ä¸¥æ ¼é«˜äº è¯¥è§’è‰²çš„æ”»å‡»å’Œé˜²å¾¡ç­‰çº§ï¼Œåˆ™è®¤ä¸ºè¯¥è§’è‰²ä¸º å¼±è§’è‰² ã€‚æ›´æ­£å¼åœ°ï¼Œå¦‚æœè®¤ä¸ºè§’è‰² i å¼±äº å­˜åœ¨çš„å¦ä¸€ä¸ªè§’è‰² j ï¼Œé‚£ä¹ˆ attackj &gt; attacki ä¸” defensej &gt; defensei ã€‚</p><p>è¿”å› <strong>å¼±è§’è‰²</strong> çš„æ•°é‡ã€‚</p><p>è¿™é“é¢˜å½“åˆåšçš„æ—¶å€™æƒ³åˆ°äº†ä¸€ä¸ªæ€è·¯ä½†æ˜¯æ²¡æœ‰å»å®ç°ï¼Œè§‰å¾—ä¼šè¶…æ—¶ï¼Œåé¢ç»“æŸæ¯”èµ›åå»è¯•äº†ä¸€ä¸‹è¿˜çœŸå¯ä»¥è¿‡ï¼Œä¸‹é¢å°±æ¥è®°å½•ä¸€ä¸‹</p><h3 id="æˆ‘çš„è§£æ³•"><a href="#æˆ‘çš„è§£æ³•" class="headerlink" title="æˆ‘çš„è§£æ³•"></a>æˆ‘çš„è§£æ³•</h3><p>ç®€å•ç‚¹å°±æ˜¯åœ¨äºŒç»´æ•°ç»„ä¸­å…ˆæŒ‰æ”»å‡»åŠ›<strong>ä»å¤§åˆ°å°</strong>æ’å¥½ï¼Œå¦‚æœä¸¤ä¸ªè§’è‰²çš„æ”»å‡»åŠ›ç›¸åŒçš„è¯å°±æŒ‰é˜²å¾¡åŠ›<strong>ä»å°åˆ°å¤§</strong>æ’åºï¼Œä¾‹å¦‚ä¸‹é¢çš„æ’åºç»“æœ</p><pre class="line-numbers language-none"><code class="language-none">6 36 45 25 53 6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæˆ‘ä»¬å†éå†ä¸€éï¼ŒåŒæ—¶è®°å½•é˜²å¾¡åŠ›çš„æœ€å¤§å€¼<code>dmax</code>ï¼Œå¦‚æœå½“å‰éå†åˆ°çš„è§’è‰²é˜²å¾¡åŠ›å°äº<code>dmax</code>åˆ™æ‰¾åˆ°äº†ä¸€ä¸ªå¼±è§’è‰²</p><p>æˆ‘ä»¬ä¸ç”¨æ‹…å¿ƒç›¸åŒæ”»å‡»åŠ›çš„æƒ…å†µï¼Œå› ä¸ºç›¸åŒæ”»å‡»åŠ›æ—¶é˜²å¾¡åŠ›æ˜¯å°çš„åœ¨å‰é¢çš„</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">int</span> <span class="token function">numberOfWeakCharacters</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span><span class="token operator">&amp;</span> properties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">sort</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>properties<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> a<span class="token punctuation">,</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">?</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;</span>b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span>a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">></span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> plen<span class="token operator">=</span>properties<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> dmax<span class="token operator">=</span>INT_MIN<span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> p<span class="token operator">:</span>properties<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//cout&lt;&lt;p[0]&lt;&lt;" "&lt;&lt;p[1]&lt;&lt;"\n";</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;</span>dmax<span class="token punctuation">)</span>                <span class="token operator">++</span>res<span class="token punctuation">;</span>            dmax<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dmax<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ—¶é—´å¤æ‚åº¦ï¼šO(NlogN)</p><h3 id="å…¶å®ƒè§£æ³•"><a href="#å…¶å®ƒè§£æ³•" class="headerlink" title="å…¶å®ƒè§£æ³•"></a>å…¶å®ƒè§£æ³•</h3><p>è¿™é‡Œæœ‰ä¸ªå¤§ä½¬ <a href="https://leetcode-cn.com/u/lucifer1004/">å´è‡ªå</a> çš„<a href="https://cp-wiki.vercel.app/tutorial/leetcode/WC257/#problem-b-%E6%B8%B8%E6%88%8F%E4%B8%AD%E5%BC%B1%E8%A7%92%E8%89%B2%E7%9A%84%E6%95%B0%E9%87%8F">è§£æ³•</a></p><img src="https://i.loli.net/2021/09/05/AEUhl721HGLRXeo.png" style="zoom:80%;" /><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">int</span> <span class="token function">numberOfWeakCharacters</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span><span class="token operator">&amp;</span> properties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sort</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">rbegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties<span class="token punctuation">.</span><span class="token function">rend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> ans <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> bhi <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> last <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> a <span class="token operator">=</span> properties<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b <span class="token operator">=</span> properties<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">&lt;</span> properties<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                bhi <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>bhi<span class="token punctuation">,</span> properties<span class="token punctuation">[</span>last<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                last <span class="token operator">=</span> i<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">&lt;</span> bhi<span class="token punctuation">)</span>                ans<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;LeetCodeå‘¨èµ›ç¬¬257åœº&quot;&gt;&lt;a href=&quot;#LeetCodeå‘¨èµ›ç¬¬257åœº&quot; class=&quot;headerlink&quot; title=&quot;LeetCodeå‘¨èµ›ç¬¬257åœº&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://leetcode-cn.com/contest/</summary>
      
    
    
    
    <category term="LeetCodeåˆ·é¢˜ç¬”è®°" scheme="http://sakura-pub.top/categories/LeetCode%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="LeetCode" scheme="http://sakura-pub.top/tags/LeetCode/"/>
    
  </entry>
  
  <entry>
    <title>LeetCodeå‘¨èµ›254åœº</title>
    <link href="http://sakura-pub.top/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B254%E5%9C%BA/"/>
    <id>http://sakura-pub.top/LeetCode/%E5%91%A8%E8%B5%9B%E7%AC%94%E8%AE%B0/LeetCode%E5%91%A8%E8%B5%9B254%E5%9C%BA/</id>
    <published>2021-08-15T15:51:40.000Z</published>
    <updated>2021-09-05T06:09:43.860Z</updated>
    
    <content type="html"><![CDATA[<h1 id="LeetCodeå‘¨èµ›ç¬¬254åœº"><a href="#LeetCodeå‘¨èµ›ç¬¬254åœº" class="headerlink" title="LeetCodeå‘¨èµ›ç¬¬254åœº"></a>LeetCodeå‘¨èµ›ç¬¬254åœº</h1><p>è¿™åœºå‘¨èµ›å†æ¬¡ç»™è™æƒ¨äº†ï¼Œåšåˆ°ç¬¬äºŒé¢˜å°±å¡ä½äº†æ²¡æœ‰æ€è·¯ï¼Œäº‰å–ä¸‹æ¬¡å‘¨èµ›å¯ä»¥åšåˆ°ç¬¬ä¸‰é¢˜<img src="https://i.loli.net/2021/09/05/85EFy4tfaplSvIi.png"></p><h2 id="5843-ä½œä¸ºå­å­—ç¬¦ä¸²å‡ºç°åœ¨å•è¯ä¸­çš„å­—ç¬¦ä¸²æ•°ç›®-â€”ï¼ˆç®€å•ï¼‰"><a href="#5843-ä½œä¸ºå­å­—ç¬¦ä¸²å‡ºç°åœ¨å•è¯ä¸­çš„å­—ç¬¦ä¸²æ•°ç›®-â€”ï¼ˆç®€å•ï¼‰" class="headerlink" title="5843. ä½œä¸ºå­å­—ç¬¦ä¸²å‡ºç°åœ¨å•è¯ä¸­çš„å­—ç¬¦ä¸²æ•°ç›®  â€”ï¼ˆç®€å•ï¼‰"></a><a href="https://leetcode-cn.com/problems/number-of-strings-that-appear-as-substrings-in-word/">5843. ä½œä¸ºå­å­—ç¬¦ä¸²å‡ºç°åœ¨å•è¯ä¸­çš„å­—ç¬¦ä¸²æ•°ç›®</a>  â€”ï¼ˆç®€å•ï¼‰</h2><p>ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ patterns å’Œä¸€ä¸ªå­—ç¬¦ä¸² word ï¼Œç»Ÿè®¡ patterns ä¸­æœ‰å¤šå°‘ä¸ªå­—ç¬¦ä¸²æ˜¯ word çš„å­å­—ç¬¦ä¸²ã€‚è¿”å›å­—ç¬¦ä¸²æ•°ç›®ã€‚</p><p><strong>å­å­—ç¬¦ä¸²</strong> æ˜¯å­—ç¬¦ä¸²ä¸­çš„ä¸€ä¸ªè¿ç»­å­—ç¬¦åºåˆ—ã€‚</p><p>ç¤ºä¾‹ 1ï¼š</p><blockquote><p>è¾“å…¥ï¼špatterns = [â€œaâ€,â€abcâ€,â€bcâ€,â€dâ€], word = â€œabcâ€<br>è¾“å‡ºï¼š3<br>è§£é‡Šï¼š</p><ul><li>â€œaâ€ æ˜¯ â€œabcâ€ çš„å­å­—ç¬¦ä¸²ã€‚</li><li>â€œabcâ€ æ˜¯ â€œabcâ€ çš„å­å­—ç¬¦ä¸²ã€‚</li><li>â€œbcâ€ æ˜¯ â€œabcâ€ çš„å­å­—ç¬¦ä¸²ã€‚</li><li>â€œdâ€ ä¸æ˜¯ â€œabcâ€ çš„å­å­—ç¬¦ä¸²ã€‚</li></ul><p>patterns ä¸­æœ‰ 3 ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå­å­—ç¬¦ä¸²å‡ºç°åœ¨ word ä¸­ã€‚</p></blockquote><p>ç¤ºä¾‹ 2ï¼š</p><blockquote><p>è¾“å…¥ï¼špatterns = [â€œaâ€,â€bâ€,â€câ€], word = â€œaaaaabbbbbâ€<br>è¾“å‡ºï¼š2<br>è§£é‡Šï¼š</p><ul><li>â€œaâ€ æ˜¯ â€œaaaaabbbbbâ€ çš„å­å­—ç¬¦ä¸²ã€‚</li><li>â€œbâ€ æ˜¯ â€œaaaaabbbbbâ€ çš„å­å­—ç¬¦ä¸²ã€‚</li><li>â€œcâ€ ä¸æ˜¯ â€œaaaaabbbbbâ€ çš„å­—ç¬¦ä¸²ã€‚</li></ul><p>patterns ä¸­æœ‰ 2 ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå­å­—ç¬¦ä¸²å‡ºç°åœ¨ word ä¸­ã€‚</p></blockquote><p>ç¤ºä¾‹ 3ï¼š</p><blockquote><p>è¾“å…¥ï¼špatterns = [â€œaâ€,â€aâ€,â€aâ€], word = â€œabâ€<br>è¾“å‡ºï¼š3<br>è§£é‡Šï¼špatterns ä¸­çš„æ¯ä¸ªå­—ç¬¦ä¸²éƒ½ä½œä¸ºå­å­—ç¬¦ä¸²å‡ºç°åœ¨ word â€œabâ€ ä¸­ã€‚</p></blockquote><p>æç¤ºï¼š</p><ul><li>1 &lt;= patterns.length &lt;= 100</li><li>1 &lt;= patterns[i].length &lt;= 100</li><li>1 &lt;= word.length &lt;= 100</li><li>patterns[i] å’Œ word ç”±å°å†™è‹±æ–‡å­—æ¯ç»„æˆ</li></ul><p>é¢˜ç›®åˆšå¼€å§‹åšçš„æ—¶å€™è„‘å­æ²¡è½¬è¿‡æ¥ï¼Œå¤©çœŸåœ°æƒ³è‡ªå·±å®ç°å¦‚ä½•æŸ¥æ‰¾å­å­—ç¬¦ä¸²ï¼Œåˆ°åé¢é†’æ‚Ÿæ‰æƒ³èµ·å¯ä»¥ç”¨åº“å‡½æ•°ï¼Œç›´æ¥æäº¤ä¸‹ä¸€é¢˜ï¼ˆæäº¤æ—¶è¿˜é”™äº†ä¸€æ¬¡ï¼Œå“­ï¼‰</p><p>æ³¨æ„è¿™é‡Œ<code>string::find()</code>å¯ä»¥ç”¨æ¥æŸ¥æ‰¾å­å­—ç¬¦ä¸²ï¼Œå¦‚æœæ‰¾åˆ°äº†åˆ™ä¼šè¿”å›å­ä¸²ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ä¸‹æ ‡åºå·ï¼Œæ‰¾ä¸åˆ°åˆ™ä¼šè¿”å›<code>string::npos</code>è¯¥å®šå€¼ä¸º<code>string::size_type</code>ç±»å‹ï¼Œå³<code>size_t==usigned int</code></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">int</span> <span class="token function">numOfStrings</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>string<span class="token operator">></span><span class="token operator">&amp;</span> patterns<span class="token punctuation">,</span> string word<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">for</span><span class="token punctuation">(</span>string<span class="token operator">&amp;</span> str<span class="token operator">:</span>patterns<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            string<span class="token operator">::</span>size_type pos<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pos<span class="token operator">=</span>word<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span>string<span class="token operator">::</span>npos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token operator">++</span>res<span class="token punctuation">;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="5832-æ„é€ å…ƒç´ ä¸ç­‰äºä¸¤ç›¸é‚»å…ƒç´ å¹³å‡å€¼çš„æ•°ç»„-â€”ï¼ˆä¸­ç­‰ï¼‰"><a href="#5832-æ„é€ å…ƒç´ ä¸ç­‰äºä¸¤ç›¸é‚»å…ƒç´ å¹³å‡å€¼çš„æ•°ç»„-â€”ï¼ˆä¸­ç­‰ï¼‰" class="headerlink" title="5832. æ„é€ å…ƒç´ ä¸ç­‰äºä¸¤ç›¸é‚»å…ƒç´ å¹³å‡å€¼çš„æ•°ç»„  â€”ï¼ˆä¸­ç­‰ï¼‰"></a><a href="https://leetcode-cn.com/problems/array-with-elements-not-equal-to-average-of-neighbors/">5832. æ„é€ å…ƒç´ ä¸ç­‰äºä¸¤ç›¸é‚»å…ƒç´ å¹³å‡å€¼çš„æ•°ç»„</a>  â€”ï¼ˆä¸­ç­‰ï¼‰</h2><p>ç»™ä½ ä¸€ä¸ª ä¸‹æ ‡ä» 0 å¼€å§‹ çš„æ•°ç»„ nums ï¼Œæ•°ç»„ç”±è‹¥å¹² äº’ä¸ç›¸åŒçš„ æ•´æ•°ç»„æˆã€‚ä½ æ‰“ç®—é‡æ–°æ’åˆ—æ•°ç»„ä¸­çš„å…ƒç´ ä»¥æ»¡è¶³ï¼šé‡æ’åï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ ä¸ç­‰äº å…¶ä¸¤ä¾§ç›¸é‚»å…ƒç´ çš„ å¹³å‡å€¼ ã€‚</p><p>æ›´å…¬å¼åŒ–çš„è¯´æ³•æ˜¯ï¼Œé‡æ–°æ’åˆ—çš„æ•°ç»„åº”å½“æ»¡è¶³è¿™ä¸€å±æ€§ï¼šå¯¹äºèŒƒå›´ 1 &lt;= i &lt; nums.length - 1 ä¸­çš„æ¯ä¸ª i ï¼Œ(nums[i-1] + nums[i+1]) / 2 ä¸ç­‰äº nums[i] å‡æˆç«‹ ã€‚</p><p>è¿”å›æ»¡è¶³é¢˜æ„çš„ä»»ä¸€é‡æ’ç»“æœã€‚</p><p>ç¤ºä¾‹ 1ï¼š</p><blockquote><p>è¾“å…¥ï¼šnums = [1,2,3,4,5]<br>è¾“å‡ºï¼š[1,2,4,5,3]<br>è§£é‡Šï¼š<br>i=1, nums[i] = 2, ä¸¤ç›¸é‚»å…ƒç´ å¹³å‡å€¼ä¸º (1+4) / 2 = 2.5<br>i=2, nums[i] = 4, ä¸¤ç›¸é‚»å…ƒç´ å¹³å‡å€¼ä¸º (2+5) / 2 = 3.5<br>i=3, nums[i] = 5, ä¸¤ç›¸é‚»å…ƒç´ å¹³å‡å€¼ä¸º (4+3) / 2 = 3.5</p></blockquote><p>ç¤ºä¾‹ 2ï¼š</p><blockquote><p>è¾“å…¥ï¼šnums = [6,2,0,9,7]<br>è¾“å‡ºï¼š[9,7,6,2,0]<br>è§£é‡Šï¼š<br>i=1, nums[i] = 7, ä¸¤ç›¸é‚»å…ƒç´ å¹³å‡å€¼ä¸º (9+6) / 2 = 7.5<br>i=2, nums[i] = 6, ä¸¤ç›¸é‚»å…ƒç´ å¹³å‡å€¼ä¸º (7+2) / 2 = 4.5<br>i=3, nums[i] = 2, ä¸¤ç›¸é‚»å…ƒç´ å¹³å‡å€¼ä¸º (6+0) / 2 = 3</p></blockquote><p>æç¤ºï¼š</p><ul><li>3 &lt;= nums.length &lt;= 105</li><li>0 &lt;= nums[i] &lt;= 105</li></ul><p>è¿™ä¸€é“é¢˜åˆšæ‹¿åˆ°å°±å†™ä¸å‡ºæ¥äº†ï¼Œå®Œå…¨æ²¡æœ‰æ€è·¯ï¼Œæ„Ÿè§‰å’Œå¹³æ—¶åšçš„é¢˜å‹ä¸ä¸€æ ·</p><p>åæ¥çœ‹äº†åˆ«äººçš„ä½œç­”ä¹‹åæ‰å‘ç°æ˜¯æŒºç®€å•çš„ä¸€é“é¢˜ï¼Œä¸»è¦è„‘ç­‹è½¬ä¸è¿‡æ¥</p><p>è¿™é‡Œæ‹¿æ•°ç»„<code>nums=[6,2,0,9,7]</code>æ¥ä¸¾ä¾‹ï¼Œç®€å•çš„æ€è·¯å°±æ˜¯ï¼š</p><ol><li>å…ˆæŠŠæ•°ç»„æ’åºï¼Œä»å°åˆ°å¤§æ’å¥½ï¼Œegï¼š<code>nums=[0,2,6,7,9]</code></li><li>æ–°å»ºä¸€ä¸ªç”¨æ¥è¿”å›çš„ç©ºæ•°ç»„<code>res</code>ï¼Œå¹¶æŒ‰é¡ºåºå°†<code>nums</code>æ•°ç»„çš„æ•°å¡«å……å®Œ<code>res</code>æ•°ç»„çš„å¥‡æ•°ä¸‹æ ‡ä½ï¼ˆè¿™é‡Œå¯ä»¥ç”¨ä¸€ä¸ªæŒ‡é’ˆ<code>ans=0</code>æŒ‡å‘numsè¡¨ç¤ºå¡«å……åˆ°å“ªä¸ªæ•°å­—ï¼‰ï¼Œegï¼š<code>res=[0,-1,2,-1,6]</code>å…¶ä¸­<code>-1</code>è¡¨ç¤ºè¿˜æ²¡å¡«å……çš„ä½</li><li>æœ€åå†æŠŠå¶æ•°ä½ä¹Ÿå¡«å……å®Œï¼Œ<code>res=[0,7,2,9,6]</code></li><li>æ­¤æ—¶åœ¨<code>res</code>æ•°ç»„ä¸­ä»»æ„ä¸€ä½æ•°è¦ä¹ˆæ˜¯éƒ½å¤§äºä¸¤è¾¹çš„æ•°ï¼Œè¦ä¹ˆæ˜¯éƒ½å°äºä¸¤è¾¹çš„æ•°ï¼Œå³æ»¡è¶³é¢˜ç›®çš„è¦æ±‚ï¼Œè¯¥æ•°è‚¯å®šä¸ä¼šç­‰äºä¸¤è¾¹æ•°ä¹‹å’Œçš„å¹³å‡æ•°</li></ol><p>çŸ¥é“è¿™ä¸ªæ–¹æ³•ä¹‹åè¿˜æ˜¯è§‰å¾—æŒºç®€å•çš„ï¼Œä¸»è¦å°±æ˜¯æƒ³ä¸åˆ°è¿™ä¸ªæ–¹æ³•</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">rearrangeArray</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> nLen <span class="token operator">=</span> nums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nums<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">int</span> ans <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">res</span><span class="token punctuation">(</span>nLen<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>nLen<span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">2</span><span class="token punctuation">)</span>            res<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>nums<span class="token punctuation">[</span>ans<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>nLen<span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">2</span><span class="token punctuation">)</span>            res<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>nums<span class="token punctuation">[</span>ans<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;LeetCodeå‘¨èµ›ç¬¬254åœº&quot;&gt;&lt;a href=&quot;#LeetCodeå‘¨èµ›ç¬¬254åœº&quot; class=&quot;headerlink&quot; title=&quot;LeetCodeå‘¨èµ›ç¬¬254åœº&quot;&gt;&lt;/a&gt;LeetCodeå‘¨èµ›ç¬¬254åœº&lt;/h1&gt;&lt;p&gt;è¿™åœºå‘¨èµ›å†æ¬¡ç»™è™æƒ¨äº†ï¼Œåšåˆ°ç¬¬äºŒé¢˜å°±å¡</summary>
      
    
    
    
    <category term="LeetCodeåˆ·é¢˜ç¬”è®°" scheme="http://sakura-pub.top/categories/LeetCode%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="LeetCode" scheme="http://sakura-pub.top/tags/LeetCode/"/>
    
  </entry>
  
  <entry>
    <title>Unityç¬”è®°29-åˆ¶ä½œä¸»èœå•ç•Œé¢</title>
    <link href="http://sakura-pub.top/UnityNotes/Unity%E7%AC%94%E8%AE%B029-%E5%88%B6%E4%BD%9C%E4%B8%BB%E8%8F%9C%E5%8D%95%E7%95%8C%E9%9D%A2/"/>
    <id>http://sakura-pub.top/UnityNotes/Unity%E7%AC%94%E8%AE%B029-%E5%88%B6%E4%BD%9C%E4%B8%BB%E8%8F%9C%E5%8D%95%E7%95%8C%E9%9D%A2/</id>
    <published>2021-08-05T01:15:59.000Z</published>
    <updated>2021-08-05T07:07:43.002Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬ç« æˆ‘ä»¬æ¥ä¸ºæ¸¸æˆåˆ¶ä½œä¸€ä¸ªä¸»èœå•ç•Œé¢</p><h1 id="åœ¨æ–°åœºæ™¯ä¸­ç»˜åˆ¶ç”»å¸ƒ"><a href="#åœ¨æ–°åœºæ™¯ä¸­ç»˜åˆ¶ç”»å¸ƒ" class="headerlink" title="åœ¨æ–°åœºæ™¯ä¸­ç»˜åˆ¶ç”»å¸ƒ"></a>åœ¨æ–°åœºæ™¯ä¸­ç»˜åˆ¶ç”»å¸ƒ</h1><p>æˆ‘ä»¬è¦ä¸“é—¨ä¸ºæˆ‘ä»¬çš„èœå•æ–°å»ºä¸€ä¸ªåœºæ™¯ï¼Œè€Œèœå•åˆ™æ˜¯åœ¨è¿™ä¸ªæ–°åœºæ™¯ä¸­ç»˜åˆ¶çš„</p><p>æˆ‘è¿™é‡Œå…ˆæŠŠåœºæ™¯æ­å»ºå¥½äº†ï¼Œæ³¨æ„æˆ‘ä»¬åœ¨æ‘†æ”¾äººç‰©çš„æ—¶å€™å¯ä»¥ç‚¹å‡»å³é”®èœå•è¿›è¡Œ<code>è„±åŒ…</code>å¤„ç†ï¼Œè¿™æ ·æˆ‘ä»¬ç§»é™¤ç»„ä»¶æ—¶å°±ä¸ä¼šå½±å“åˆ°ç´ æé‡Œé¢çš„æ¨¡æ¿äº†</p><img src="https://i.loli.net/2021/08/05/29wfpAg8ZEyLdDG.png" style="zoom:80%;" /><p>ç„¶åæˆ‘ä»¬ä¹ŸæŠŠUIæ‘†æ”¾å¥½</p><img src="https://i.loli.net/2021/08/05/sHZyaWhDmL6qEvK.png" style="zoom:80%;" /><p>åŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»™UIæ·»åŠ ä¸€äº›è§†è§‰æ•ˆæœçš„å¤„ç†</p><h2 id="å°†UIæ·»åŠ ç«‹ä½“æ•ˆæœ"><a href="#å°†UIæ·»åŠ ç«‹ä½“æ•ˆæœ" class="headerlink" title="å°†UIæ·»åŠ ç«‹ä½“æ•ˆæœ"></a>å°†UIæ·»åŠ ç«‹ä½“æ•ˆæœ</h2><p>è¿™é‡Œå¯ä»¥æ·»åŠ ä¸€ç§æ•ˆæœï¼Œæˆ‘æƒ³ç‚¹å‡»new game æ—¶å€™ç›¸æœºä¼šç©¿è¿‡æ ‡é¢˜UIç„¶åé è¿‘ä¼ é€é—¨çš„æ ·å¼ï¼Œä¸‹é¢å°±æ¥å®ç°ä¸€ä¸‹</p><p>æˆ‘ä»¬é€‰ä¸­ç”»å¸ƒï¼Œç„¶åå¦‚ä¸‹å›¾è®¾ç½®ï¼Œå°†<code>Render Mode</code>é€‰æ‹©ä¸º<code>Camera</code>ï¼Œå†æŠŠæ‘„åƒæœºæ‹–åˆ°ä¸‹é¢çš„æ¡†æ¡†é‡Œ</p><img src="https://i.loli.net/2021/08/05/VQnMjOfywAeiNTh.png" style="zoom:80%;" /><p>è¿™æ—¶å€™ç‚¹å‡»è¿è¡Œä¼šå‘ç°æŒ‰é’®ç»™åœºæ™¯é®æŒ¡ä½äº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥è°ƒä¸€ä¸‹<code>Plane Distance</code>ï¼Œæ¯”å¦‚æ”¹æˆ1ï¼ŒæŒ‰é’®å°±åˆå¯ä»¥çœ‹åˆ°äº†</p><p>æœ€åæˆ‘ä»¬å†æŠŠ<code>Render Mode</code>æ”¹ä¸º<code>World Space</code>ï¼Œç„¶åå°è¯•å‘å‰ç§»åŠ¨ç›¸æœºï¼Œå°±å¯ä»¥å‘ç°è¾¾æˆäº†ç›¸æœºç©¿è¶Šæ ‡é¢˜çš„æ•ˆæœäº†ï¼Œä¹‹æ‰€ä»¥è¦ç»è¿‡ä¸Šé¢çš„æ­¥éª¤æ˜¯å› ä¸ºå¯ä»¥è®©Unityè‡ªåŠ¨è°ƒèŠ‚UIçš„åˆé€‚ä½ç½®</p><h1 id="ç¼–å†™ä»£ç "><a href="#ç¼–å†™ä»£ç " class="headerlink" title="ç¼–å†™ä»£ç "></a>ç¼–å†™ä»£ç </h1><p>UIå»ºç«‹å¥½ä¹‹åæˆ‘ä»¬å°±è¦æ¥å®ç°æŒ‰é’®çš„åŠŸèƒ½äº†</p><img src="https://i.loli.net/2021/08/05/uZCjd6oGp7DJqe3.png" style="zoom:80%;" /><p>æŒ‰é’®æœ€ä¸»è¦å°±æ˜¯ç›‘å¬äº‹ä»¶ï¼Œä¸‹é¢å…ˆå•ç‹¬æ¥å†™å„ç§åŠŸèƒ½çš„æ–¹æ³•ï¼Œæœ€åå†é…ä¸Šæ•´ä¸ªä»£ç æ–‡ä»¶</p><h2 id="Exit"><a href="#Exit" class="headerlink" title="Exit"></a>Exit</h2><p>å…¶ä¸­æœ€ç®€å•çš„å°±æ˜¯é€€å‡ºæ¸¸æˆï¼Œä¸€è¡Œæå®š</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">QuitGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//é€€å‡ºæ¸¸æˆåŠŸèƒ½</span>        Application<span class="token punctuation">.</span><span class="token function">Quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="NewGame"><a href="#NewGame" class="headerlink" title="NewGame"></a>NewGame</h2><p>ç„¶åæ˜¯åˆ›å»ºæ–°æ¸¸æˆï¼Œè¿™é‡Œå°±è¦æ¶‰åŠå¤šä¸ªä»£ç æ–‡ä»¶</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//MainMenu.cs</span><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NewGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//æ¸…æ¥šæ‰€æœ‰å­˜æ¡£</span>        PlayerPrefs<span class="token punctuation">.</span><span class="token function">DeleteAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è½¬æ¢åœºæ™¯</span>        <span class="token comment">//ä¼šåœ¨SceneControlleré‡Œé¢å®Œæˆ</span>        SceneController<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">TransitionToFirstLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åŠ è½½ç¬¬ä¸€ä¸ªåœºæ™¯</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//SceneController.cs</span><span class="token comment">//è½¬æ¢åœºæ™¯ï¼Œå¯ç”¨äºåœ¨æ ‡é¢˜ç•Œé¢è¿‡æ¸¡åˆ°ç¬¬ä¸€ä¸ªç•Œé¢ä¸­</span>    <span class="token return-type class-name">IEnumerator</span> <span class="token function">LoadLevel</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> scene<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>scene<span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//ä¼ å…¥å‚æ•°ä¸ä¸ºç©º</span>            <span class="token comment">//åŠ è½½åœºæ™¯</span>            <span class="token keyword">yield</span> <span class="token keyword">return</span> SceneManager<span class="token punctuation">.</span><span class="token function">LoadSceneAsync</span><span class="token punctuation">(</span>scene<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//åŠ è½½äººç‰©ï¼Œåœ¨GMaeManagerä¸­åˆ›å»ºäº†ä¸€ä¸ªç”¨äºè·å¾—åˆå§‹ä½ç½®çš„æ–¹æ³•</span>            <span class="token keyword">yield</span> <span class="token keyword">return</span> player <span class="token operator">=</span> <span class="token function">Instantiate</span><span class="token punctuation">(</span>playerPrefab<span class="token punctuation">,</span>            GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">GetEntrance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>position<span class="token punctuation">,</span>            GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">GetEntrance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//ä¿å­˜æ•°æ®</span>            SaveManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">SavePlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">yield</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//ç»“æŸåç¨‹</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//åŠ è½½ç¬¬ä¸€ä¸ªåœºæ™¯ï¼Œå¯ä»¥å°†è¿™ä¸ªç›´æ¥æ”¾åœ¨æ ‡é¢˜ç•Œé¢çš„åŠŸèƒ½é‡Œ</span>    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TransitionToFirstLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">StartCoroutine</span><span class="token punctuation">(</span><span class="token function">LoadLevel</span><span class="token punctuation">(</span><span class="token string">"3D RPG"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//GmaeManager.cs</span><span class="token comment">//è·å¾—åœºæ™¯åŠ è½½å…¥å£ï¼Œè¿™é‡Œæ˜¯æ ‡é¢˜ç•Œé¢è¿›å…¥ä¸»åœºæ™¯æ—¶ç”¨äºè·å¾—è½åœ°ç‚¹</span>    <span class="token keyword">public</span> <span class="token return-type class-name">Transform</span> <span class="token function">GetEntrance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> item <span class="token keyword">in</span> <span class="token generic-method"><span class="token function">FindObjectsOfType</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TransitionDestination<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>destinationTag<span class="token operator">==</span>TransitionDestination<span class="token punctuation">.</span>DestinationTag<span class="token punctuation">.</span>ENTER<span class="token punctuation">)</span>                <span class="token keyword">return</span> item<span class="token punctuation">.</span>transform<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨æ„è¦æŠŠå‡ ä¸ªManagerå¯¹è±¡å¤åˆ¶åˆ°æ ‡é¢˜åœºæ™¯ä¸­</p><h2 id="Continue"><a href="#Continue" class="headerlink" title="Continue"></a>Continue</h2><p>ç”±äºæˆ‘ä»¬æ¸¸æˆæœ‰å¤šä¸ªåœºæ™¯ï¼Œå› æ­¤åœ¨åŠ è½½åŠŸèƒ½ä¸­æˆ‘ä»¬è¿˜è¦è®°ä½ä¸Šæ¬¡ä¿å­˜ç©å®¶æ˜¯åœç•™åœ¨å“ªä¸€ä¸ªåœºæ™¯ï¼Œä»è€Œåœ¨åŠ è½½å­˜æ¡£æ—¶åˆ¤æ–­è¦åŠ è½½å“ªä¸€ä¸ªåœºæ™¯çš„ç”»é¢</p><p>ä¹Ÿæ˜¯æœ‰å¤šä¸ªä»£ç æ–‡ä»¶éœ€è¦ä¿®æ”¹ï¼Œéœ€è¦æ³¨æ„åŒºåˆ†</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//SaveManager.cs</span><span class="token class-name"><span class="token keyword">string</span></span> sceneName<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span><span class="token comment">//è®°å½•ä¿å­˜åœºæ™¯çš„åå­—</span>    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> SceneName<span class="token punctuation">&#123;</span><span class="token keyword">get</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> PlayerPrefs<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>sceneName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Save</span><span class="token punctuation">(</span><span class="token class-name">UnityEngine<span class="token punctuation">.</span>Object</span> data<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name"><span class="token keyword">var</span></span> jsonData <span class="token operator">=</span> JsonUtility<span class="token punctuation">.</span><span class="token function">ToJson</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è½¬æ¢ä¸ºjson</span>        PlayerPrefs<span class="token punctuation">.</span><span class="token function">SetString</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>jsonData<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å†å»ºç«‹é”®å€¼ä¿å­˜</span>        <span class="token comment">//åœ¨ä¿å­˜æ•°æ®åŒæ—¶ä¿å­˜ç©å®¶åœç•™åœ¨å“ªä¸ªåœºæ™¯</span>        PlayerPrefs<span class="token punctuation">.</span><span class="token function">SetString</span><span class="token punctuation">(</span>sceneName<span class="token punctuation">,</span>SceneManager<span class="token punctuation">.</span><span class="token function">GetActiveScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        PlayerPrefs<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//SceneController.cs</span><span class="token comment">//Continue</span>    <span class="token comment">//ç”¨äºåŠ è½½æ¸¸æˆçš„åŠ è½½æ–¹æ³•</span>    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TransitionToLoadGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name"><span class="token keyword">string</span></span> sceneName <span class="token operator">=</span> SaveManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>SceneName<span class="token punctuation">;</span><span class="token comment">//è·å¾—ä¸Šæ¬¡ä¿å­˜åœºæ™¯åç§°ï¼Œå¯èƒ½ä¸ºç©º</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>sceneName<span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//ä¸ä¸ºç©ºçš„è¯å°±åŠ è½½åœºæ™¯</span>            <span class="token function">StartCoroutine</span><span class="token punctuation">(</span><span class="token function">LoadLevel</span><span class="token punctuation">(</span>sceneName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//PlayerController.cs</span><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//ç´ æå¯ç”¨æ—¶æ³¨å†Œäº‹ä»¶</span>MouseManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>OnMouseClicked<span class="token operator">+=</span>MoveToTarget<span class="token punctuation">;</span>MouseManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>OnEnemyClicked<span class="token operator">+=</span>EventAttact<span class="token punctuation">;</span>GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">RigisterPlayer</span><span class="token punctuation">(</span>charcterStates<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ³¨å†ŒGmaeManager</span><span class="token punctuation">&#125;</span><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//åŠ è½½äººç‰©æ•°æ®</span>SaveManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">LoadPlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//MainMenu.cs</span>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ContinueGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//è½¬æ¢åœºæ™¯ï¼Œè¯»å–è¿›åº¦</span>        SceneController<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">TransitionToLoadGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ¸¸æˆä¸­Escè¿”å›ä¸»èœå•"><a href="#æ¸¸æˆä¸­Escè¿”å›ä¸»èœå•" class="headerlink" title="æ¸¸æˆä¸­Escè¿”å›ä¸»èœå•"></a>æ¸¸æˆä¸­Escè¿”å›ä¸»èœå•</h2><p>æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªåŠŸèƒ½æ˜¯åœ¨æ¸¸æˆå†…å¿…è¦çš„ï¼Œå°±æ˜¯è¿”å›ä¸»èœå•åŠŸèƒ½ï¼Œè¿™é‡Œä¹Ÿæ¥å®ç°ä¸€ä¸‹</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//SaveManager.cs</span><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token keyword">if</span><span class="token punctuation">(</span>Input<span class="token punctuation">.</span><span class="token function">GetKeyDown</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>Escape<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>           <span class="token comment">//æ¸¸æˆä¸­Escå›åˆ°ä¸»èœå•</span>           SceneController<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">TransitionToMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>       <span class="token keyword">if</span><span class="token punctuation">(</span>Input<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>S<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//ä¿å­˜</span>           <span class="token function">SavePlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">if</span><span class="token punctuation">(</span>Input<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>L<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//è¯»å–</span>           <span class="token function">LoadPlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//SceneController.cs</span><span class="token comment">//åŠ è½½æ ‡é¢˜åœºæ™¯åç¨‹</span>    <span class="token return-type class-name">IEnumerator</span> <span class="token function">LoadMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">yield</span> <span class="token keyword">return</span> SceneManager<span class="token punctuation">.</span><span class="token function">LoadSceneAsync</span><span class="token punctuation">(</span><span class="token string">"Main"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">yield</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//åŠ è½½æ ‡é¢˜æ–¹æ³•</span>    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TransitionToMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">StartCoroutine</span><span class="token punctuation">(</span><span class="token function">LoadMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ°è¿™æˆ‘ä»¬å°±æˆåŠŸå®ç°äº†ä¸»èœå•åˆ°æ¸¸æˆå†åˆ°ä¸»èœå•çš„è¿‡æ¸¡æ•ˆæœ</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æœ¬ç« æˆ‘ä»¬æ¥ä¸ºæ¸¸æˆåˆ¶ä½œä¸€ä¸ªä¸»èœå•ç•Œé¢&lt;/p&gt;
&lt;h1 id=&quot;åœ¨æ–°åœºæ™¯ä¸­ç»˜åˆ¶ç”»å¸ƒ&quot;&gt;&lt;a href=&quot;#åœ¨æ–°åœºæ™¯ä¸­ç»˜åˆ¶ç”»å¸ƒ&quot; class=&quot;headerlink&quot; title=&quot;åœ¨æ–°åœºæ™¯ä¸­ç»˜åˆ¶ç”»å¸ƒ&quot;&gt;&lt;/a&gt;åœ¨æ–°åœºæ™¯ä¸­ç»˜åˆ¶ç”»å¸ƒ&lt;/h1&gt;&lt;p&gt;æˆ‘ä»¬è¦ä¸“é—¨ä¸ºæˆ‘ä»¬çš„èœå•æ–°å»ºä¸€ä¸ªåœºæ™¯</summary>
      
    
    
    
    <category term="Unityå­¦ä¹ ç¬”è®°" scheme="http://sakura-pub.top/categories/Unity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Unity" scheme="http://sakura-pub.top/tags/Unity/"/>
    
  </entry>
  
  <entry>
    <title>Unityç¬”è®°28-ä¿å­˜æ•°æ®</title>
    <link href="http://sakura-pub.top/UnityNotes/Unity%E7%AC%94%E8%AE%B028-%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE/"/>
    <id>http://sakura-pub.top/UnityNotes/Unity%E7%AC%94%E8%AE%B028-%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE/</id>
    <published>2021-08-04T01:32:04.000Z</published>
    <updated>2021-08-04T02:53:20.289Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸€ç« æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ å¦‚ä½•ä¿å­˜æ•°æ®ï¼Œç”¨åˆ°çš„æœ‰ä¸¤ä¸ªé‡è¦çš„APIï¼Œæ–‡ç« ä¸­ä¼šæœ‰ä»‹ç»åˆ°</p><h1 id="è®¤è¯†API"><a href="#è®¤è¯†API" class="headerlink" title="è®¤è¯†API"></a>è®¤è¯†API</h1><p>è¿™é‡Œæˆ‘ä»¬ç”¨åˆ°ä¸¤ä¸ªAPIï¼Œä¸€ä¸ªæ˜¯**<a href="https://docs.unity.cn/cn/2020.3/ScriptReference/EditorPrefs.html">PlayerPrefs</a><strong>ç±»ï¼Œè™½ç„¶å®˜æ–¹æ–‡æ¡£å†™çš„æ˜¯EditorPrefsï¼Œä½†æ˜¯ä»–ä»¬çš„æ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼Œå¦å¤–ä¸€ä¸ªè¦ç”¨åˆ°çš„APIæ˜¯</strong><a href="https://docs.unity.cn/cn/2020.3/ScriptReference/JsonUtility.ToJson.html">JsonUtility.ToJson</a>**æ–¹æ³•</p><p>PlayerPrefsï¼šç”¨äºæœ¬åœ°æŒä¹…åŒ–ä¿å­˜ä¸è¯»å–çš„ç±»ï¼ŒPlayerPrefsç±»å·¥ä½œåŸç†éå¸¸ç®€å•ï¼Œä»¥é”®å€¼å¯¹çš„å½¢å¼å°†æ•°æ®ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼Œç„¶åç¨‹åºå¯ä»¥æ ¹æ®è¿™ä¸ªåç§°å–å‡ºä¸Šæ¬¡ä¿å­˜çš„æ•°å€¼</p><p>JsonUtility.ToJsonï¼šç”Ÿæˆå¯¹è±¡çš„å…¬å…±å­—æ®µçš„ JSON è¡¨ç¤ºå½¢å¼ã€‚</p><h1 id="ç¼–å†™ä»£ç "><a href="#ç¼–å†™ä»£ç " class="headerlink" title="ç¼–å†™ä»£ç "></a>ç¼–å†™ä»£ç </h1><p>æˆ‘ä»¬æ–°å»ºä¸€ä¸ª<code>SaveManager.cs</code>ç„¶åæ¥ç¼–å†™ä¸“é—¨ç®¡ç†ä¿å­˜è¯»å–çš„ç±»</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SaveManager</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Singleton<span class="token punctuation">&lt;</span>SaveManager<span class="token punctuation">></span></span></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Awake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">Awake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">DontDestroyOnLoad</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ‡æ¢åœºæ™¯ä¸é”€æ¯</span>    <span class="token punctuation">&#125;</span>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>Input<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>S<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//ä¿å­˜</span>            <span class="token function">SavePlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>Input<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>L<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//è¯»å–</span>            <span class="token function">LoadPlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SavePlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name"><span class="token keyword">var</span></span> PlayerData <span class="token operator">=</span> GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span>characterData<span class="token punctuation">;</span>        <span class="token function">Save</span><span class="token punctuation">(</span>PlayerData<span class="token punctuation">,</span>GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span>characterData<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LoadPlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name"><span class="token keyword">var</span></span> PlayerData <span class="token operator">=</span> GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span>characterData<span class="token punctuation">;</span>        <span class="token function">Load</span><span class="token punctuation">(</span>PlayerData<span class="token punctuation">,</span>GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span>characterData<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Save</span><span class="token punctuation">(</span><span class="token class-name">UnityEngine<span class="token punctuation">.</span>Object</span> data<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name"><span class="token keyword">var</span></span> jsonData <span class="token operator">=</span> JsonUtility<span class="token punctuation">.</span><span class="token function">ToJson</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è½¬æ¢ä¸ºjson</span>        PlayerPrefs<span class="token punctuation">.</span><span class="token function">SetString</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>jsonData<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å†å»ºç«‹é”®å€¼ä¿å­˜</span>        PlayerPrefs<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Load</span><span class="token punctuation">(</span><span class="token class-name">UnityEngine<span class="token punctuation">.</span>Object</span> data<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>PlayerPrefs<span class="token punctuation">.</span><span class="token function">HasKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœé”®å€¼å­˜åœ¨çš„è¯å°±è¯»å–</span>            JsonUtility<span class="token punctuation">.</span><span class="token function">FromJsonOverwrite</span><span class="token punctuation">(</span>PlayerPrefs<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥è¿›æ¸¸æˆä½“éªŒä¸€ä¸‹äº†ï¼ŒæŒ‰<code>S</code>é”®æ˜¯ä¿å­˜ç©å®¶å½“å‰æ•°æ®ï¼ŒæŒ‰<code>L</code>é”®æ˜¯è¯»å–ï¼Œå¹¶ä¸”ä¿å­˜ååœ¨ä¸‹ä¸€æ¬¡æ¸¸æˆå¯åŠ¨æ—¶ä»ç„¶å¯ä»¥è¯»å–æ•°æ®</p><p>Windowsç³»ç»Ÿå¯ä»¥åœ¨æ³¨å†Œè¡¨ä¸Šçœ‹åˆ°ä¿å­˜çš„æ•°æ®</p><img src="https://i.loli.net/2021/08/04/jTPgFrdWL1wH96N.png" style="zoom:80%;" /><h1 id="è·¨åœºæ™¯ä¿å­˜è¯»å–"><a href="#è·¨åœºæ™¯ä¿å­˜è¯»å–" class="headerlink" title="è·¨åœºæ™¯ä¿å­˜è¯»å–"></a>è·¨åœºæ™¯ä¿å­˜è¯»å–</h1><p>æ—¢ç„¶æˆ‘ä»¬åœ¨ä¸‹ä¸€æ¬¡å¼€å¯æ¸¸æˆä¹Ÿå¯ä»¥è¯»å–ç©å®¶æ•°æ®ï¼Œé‚£ä¹ˆè·¨åœºæ™¯ä¹Ÿä¸åœ¨è¯ä¸‹</p><p>å»åˆ°<code>SceneController.cs</code>ä¿®æ”¹ä¸€ä¸‹ä»£ç </p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token return-type class-name">IEnumerator</span> <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> sceneName<span class="token punctuation">,</span><span class="token class-name">TransitionDestination<span class="token punctuation">.</span>DestinationTag</span> destinationTag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//ä¿å­˜æ•°æ®</span>        SaveManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">SavePlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>SceneManager<span class="token punctuation">.</span><span class="token function">GetActiveScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token operator">!=</span>sceneName<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//ä¸åŒåœºæ™¯çš„è¯</span>            <span class="token keyword">yield</span> <span class="token keyword">return</span> SceneManager<span class="token punctuation">.</span><span class="token function">LoadSceneAsync</span><span class="token punctuation">(</span>sceneName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åç¨‹åŠ è½½åœºæ™¯</span>            <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token function">Instantiate</span><span class="token punctuation">(</span>playerPrefab<span class="token punctuation">,</span>                <span class="token function">GetDestination</span><span class="token punctuation">(</span>destinationTag<span class="token punctuation">)</span><span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position<span class="token punctuation">,</span>                <span class="token function">GetDestination</span><span class="token punctuation">(</span>destinationTag<span class="token punctuation">)</span><span class="token punctuation">.</span>transform<span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åŠ è½½ç©å®¶ç´ æå¯¹è±¡</span>                        <span class="token comment">//è¯»å–ç©å®¶æ•°æ®</span>            SaveManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">LoadPlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">yield</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//åŠ è½½å¥½åè·³å‡ºåç¨‹</span>                    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token comment">//ç›¸åŒåœºæ™¯</span>            <span class="token comment">//å…ˆè·å¾—ç©å®¶çš„å¯¹è±¡</span>            player <span class="token operator">=</span> GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span>gameObject<span class="token punctuation">;</span>            <span class="token comment">//è·å¾—ç›®çš„åœ°ä¼ é€é—¨å¯¹è±¡</span>            <span class="token class-name"><span class="token keyword">var</span></span> td <span class="token operator">=</span> <span class="token function">GetDestination</span><span class="token punctuation">(</span>destinationTag<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å…³é—­å¯¼èˆªç§»åŠ¨</span>            player<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>NavMeshAgent<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token comment">//è®¾ç½®å¯¹è±¡çš„åæ ‡å’Œæ—‹è½¬è§’åº¦</span>            player<span class="token punctuation">.</span>transform<span class="token punctuation">.</span><span class="token function">SetPositionAndRotation</span><span class="token punctuation">(</span>td<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position<span class="token punctuation">,</span>td<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//æ¢å¤å¯¼èˆªç§»åŠ¨</span>            player<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>NavMeshAgent<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæˆ‘ä»¬åœ¨åŠ è½½å¦å¤–ä¸€ä¸ªåœºæ™¯å‰ä¼šå…ˆä¿å­˜æ•°æ®ï¼Œåœ¨åŠ è½½åœºæ™¯å®Œåæˆ‘ä»¬å…ˆè¯»å–æ•°æ®å†é€€å‡ºåç¨‹</p><p>è¿™æ ·å°±å®ç°äº†äººç‰©æ•°æ®çš„ä¿å­˜äº†ï¼Œå½“ç„¶è¿™åªæ˜¯ä¿å­˜è¯»å–äº†äººç‰©çš„ç”Ÿå‘½å€¼ã€ç»éªŒå€¼ç­‰æ•°æ®ï¼Œå…¶å®ƒæ•°æ®ä¹Ÿå¯ä»¥è‡ªç”±å‘æŒ¥</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ä¸€ç« æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ å¦‚ä½•ä¿å­˜æ•°æ®ï¼Œç”¨åˆ°çš„æœ‰ä¸¤ä¸ªé‡è¦çš„APIï¼Œæ–‡ç« ä¸­ä¼šæœ‰ä»‹ç»åˆ°&lt;/p&gt;
&lt;h1 id=&quot;è®¤è¯†API&quot;&gt;&lt;a href=&quot;#è®¤è¯†API&quot; class=&quot;headerlink&quot; title=&quot;è®¤è¯†API&quot;&gt;&lt;/a&gt;è®¤è¯†API&lt;/h1&gt;&lt;p&gt;è¿™é‡Œæˆ‘ä»¬ç”¨åˆ°ä¸¤ä¸ªA</summary>
      
    
    
    
    <category term="Unityå­¦ä¹ ç¬”è®°" scheme="http://sakura-pub.top/categories/Unity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Unity" scheme="http://sakura-pub.top/tags/Unity/"/>
    
  </entry>
  
  <entry>
    <title>Unityç¬”è®°27-ä¸åŒåœºæ™¯çš„ä¼ é€</title>
    <link href="http://sakura-pub.top/UnityNotes/Unity%E7%AC%94%E8%AE%B027-%E4%B8%8D%E5%90%8C%E5%9C%BA%E6%99%AF%E7%9A%84%E4%BC%A0%E9%80%81/"/>
    <id>http://sakura-pub.top/UnityNotes/Unity%E7%AC%94%E8%AE%B027-%E4%B8%8D%E5%90%8C%E5%9C%BA%E6%99%AF%E7%9A%84%E4%BC%A0%E9%80%81/</id>
    <published>2021-08-03T01:05:23.000Z</published>
    <updated>2021-08-03T03:25:32.587Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸€ç« æˆ‘ä»¬æ¥å®ç°ä¸åŒåœºæ™¯çš„ä¼ é€</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æŠŠå¦å¤–ä¸€ä¸ªåœºæ™¯æ­å»ºå¥½å…ˆï¼Œéšåæ‰å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥çš„å·¥ä½œï¼Œè¿™é‡Œå°±è‡ªå·±å‘æŒ¥å§</p><p>æ­å»ºå¥½åœºæ™¯åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ­£å¼å¼€å§‹æ¥å®ç°å¦‚ä½•è·¨åœºæ™¯ä¼ é€äº†</p><h1 id="è®¾ç½®å¥½ä¼ é€é—¨å±æ€§"><a href="#è®¾ç½®å¥½ä¼ é€é—¨å±æ€§" class="headerlink" title="è®¾ç½®å¥½ä¼ é€é—¨å±æ€§"></a>è®¾ç½®å¥½ä¼ é€é—¨å±æ€§</h1><p>é¦–å…ˆå°±æ˜¯è¦æŠŠä¸¤ä¸ªä¸åŒåœºæ™¯çš„ä¼ é€é—¨å±æ€§è®¾ç½®å¥½ï¼Œæ³¨æ„è¦é€‰æ‹©ä¸åŒåœºæ™¯ä¼ é€å¹¶æŠŠåå­—å¡«ä¸Š</p><p>ä¸‹é¢æ˜¯ä¸»ä¸–ç•Œçš„ä¼ é€é—¨å±æ€§</p><img src="https://i.loli.net/2021/08/03/qSY69TCAibHz8wP.png" style="zoom:80%;" /><p>ä»¥åŠå¦å¤–ä¸€ä¸ªä¸–ç•Œä¼ é€é—¨çš„å±æ€§</p><img src="https://i.loli.net/2021/08/03/O4ymdIfH3CVZA2L.png" style="zoom:80%;" /><h1 id="ç¼–å†™ä»£ç "><a href="#ç¼–å†™ä»£ç " class="headerlink" title="ç¼–å†™ä»£ç "></a>ç¼–å†™ä»£ç </h1><p>ä¸‹é¢çš„ä»£ç å¯èƒ½æœ‰ç‚¹åˆ†æ•£ï¼Œéœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¯”è¾ƒå¤šï¼Œä¼šæœ‰æ³¨é‡Šå†™å‡ºæ¥åœ¨å“ªä¸ªæ–‡ä»¶</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//SceneController.csï¼Œæ·»åŠ äº†ä¸åŒåœºæ™¯åŠ è½½æ—¶çš„ä»£ç </span><span class="token keyword">public</span> <span class="token class-name">GameObject</span> playerPrefab<span class="token punctuation">;</span><span class="token comment">//ç©å®¶ç´ æå¯¹è±¡ï¼Œç”¨æ¥ä¸åŒåœºæ™¯æ—¶è¿›è¡ŒåŠ è½½</span>    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TransitiToDestination</span><span class="token punctuation">(</span><span class="token class-name">TransitionPoint</span> transitionPoint<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//è€ƒè™‘æ˜¯åŒåœºæ™¯è¿˜æ˜¯ä¸åŒåœºæ™¯çš„ä¼ é€</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>transitionPoint<span class="token punctuation">.</span>transitionType<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">case</span> TransitionPoint<span class="token punctuation">.</span>TransitionType<span class="token punctuation">.</span>SameScene<span class="token punctuation">:</span>                <span class="token comment">//åŒåœºæ™¯å¯ä»¥ä¸ç”¨å¼‚æ­¥ï¼Œç›´æ¥ä¼ é€</span>                <span class="token comment">//è¿™é‡Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è·å¾—å½“å‰æ´»åŠ¨çª—å£çš„åå­—</span>                <span class="token function">StartCoroutine</span><span class="token punctuation">(</span><span class="token function">Transition</span><span class="token punctuation">(</span>SceneManager<span class="token punctuation">.</span><span class="token function">GetActiveScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>transitionPoint<span class="token punctuation">.</span>destinationTag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> TransitionPoint<span class="token punctuation">.</span>TransitionType<span class="token punctuation">.</span>DifferentScene<span class="token punctuation">:</span>                <span class="token comment">//ä¸åŒåœºæ™¯ï¼Œç”¨å¼‚æ­¥åŠ è½½çš„æ–¹å¼</span>                <span class="token function">StartCoroutine</span><span class="token punctuation">(</span><span class="token function">Transition</span><span class="token punctuation">(</span>transitionPoint<span class="token punctuation">.</span>sceneName<span class="token punctuation">,</span>transitionPoint<span class="token punctuation">.</span>destinationTag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token return-type class-name">IEnumerator</span> <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> sceneName<span class="token punctuation">,</span><span class="token class-name">TransitionDestination<span class="token punctuation">.</span>DestinationTag</span> destinationTag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//TODO:ä¿å­˜æ•°æ®</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>SceneManager<span class="token punctuation">.</span><span class="token function">GetActiveScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token operator">!=</span>sceneName<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//ä¸åŒåœºæ™¯çš„è¯</span>            <span class="token keyword">yield</span> <span class="token keyword">return</span> SceneManager<span class="token punctuation">.</span><span class="token function">LoadSceneAsync</span><span class="token punctuation">(</span>sceneName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åç¨‹åŠ è½½åœºæ™¯</span>            <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token function">Instantiate</span><span class="token punctuation">(</span>playerPrefab<span class="token punctuation">,</span>                <span class="token function">GetDestination</span><span class="token punctuation">(</span>destinationTag<span class="token punctuation">)</span><span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position<span class="token punctuation">,</span>                <span class="token function">GetDestination</span><span class="token punctuation">(</span>destinationTag<span class="token punctuation">)</span><span class="token punctuation">.</span>transform<span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åŠ è½½ç©å®¶ç´ æå¯¹è±¡</span>            <span class="token keyword">yield</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//åŠ è½½å¥½åè·³å‡ºåç¨‹</span>                    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token comment">//ç›¸åŒåœºæ™¯</span>            <span class="token comment">//å…ˆè·å¾—ç©å®¶çš„å¯¹è±¡</span>            player <span class="token operator">=</span> GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span>gameObject<span class="token punctuation">;</span>            <span class="token comment">//è·å¾—ç›®çš„åœ°ä¼ é€é—¨å¯¹è±¡</span>            <span class="token class-name"><span class="token keyword">var</span></span> td <span class="token operator">=</span> <span class="token function">GetDestination</span><span class="token punctuation">(</span>destinationTag<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å…³é—­å¯¼èˆªç§»åŠ¨</span>            player<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>NavMeshAgent<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token comment">//è®¾ç½®å¯¹è±¡çš„åæ ‡å’Œæ—‹è½¬è§’åº¦</span>            player<span class="token punctuation">.</span>transform<span class="token punctuation">.</span><span class="token function">SetPositionAndRotation</span><span class="token punctuation">(</span>td<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position<span class="token punctuation">,</span>td<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//æ¢å¤å¯¼èˆªç§»åŠ¨</span>            player<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>NavMeshAgent<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨æ„è¿™é‡Œæˆ‘ä»¬è¦å¤–ç•ŒæŠŠäººç‰©çš„ç´ ææ‹–è¿›å»ä»£ç ä¸­ï¼Œä»¥ä¿è¯ä¼ é€åˆ°å¦å¤–ä¸€ä¸ªåœºæ™¯æ—¶å¯ä»¥åŠ è½½äººç‰©å‡ºæ¥</p><img src="https://i.loli.net/2021/08/03/xDbVRIcpGHqTy4h.png" style="zoom:80%;" /><h1 id="ä¿®å¤é—®é¢˜"><a href="#ä¿®å¤é—®é¢˜" class="headerlink" title="ä¿®å¤é—®é¢˜"></a>ä¿®å¤é—®é¢˜</h1><h2 id="ä¼ é€æŠ¥é”™"><a href="#ä¼ é€æŠ¥é”™" class="headerlink" title="ä¼ é€æŠ¥é”™"></a>ä¼ é€æŠ¥é”™</h2><p>æ­¤æ—¶æˆ‘ä»¬ä¼ é€æ—¶ä¼šæŠ¥é”™ï¼Œæœ‰å¥½å‡ ä¸ªé—®é¢˜æˆ‘ä»¬æ…¢æ…¢æ¥çœ‹</p><p>ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯è¦æŠŠåœºæ™¯æ”¾åœ¨<code>Scene in Build</code>çš„è®¾ç½®å½“ä¸­</p><img src="https://i.loli.net/2021/08/03/dpRCZcfYrDAUx1V.png" style="zoom:80%;" /><p>ç¬¬äºŒä¸ªé—®é¢˜å°±æ˜¯æˆ‘ä»¬ä¼ é€åˆ°æ–°åœºæ™¯åï¼Œé‚£äº›Manageræ–‡ä»¶éƒ½ä¼šä¸å­˜åœ¨ï¼Œå› æ­¤æˆ‘ä»¬è¦æŠŠå®ƒä»¬åŠ å…¥<code>DontDestory</code>çš„æ¸…å•é‡Œ</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//åœ¨GameManager.cs  SceneController.cs  MouseManager.csåŠ ä¸Šè¿™è¡Œä»£ç </span><span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Awake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">Awake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">DontDestroyOnLoad</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é˜²æ­¢æ­¤Manageræ–‡ä»¶åœ¨åˆ‡æ¢åœºæ™¯æ—¶ç»™é”€æ¯</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬è¦åœ¨<code>GameManager.cs</code>  <code>SceneController.cs</code>  <code>MouseManager.cs</code>åŠ ä¸Šä¸Šé¢ä»£ç ï¼Œå¹¶ä¸”æ˜¯è¦<strong>ç»§æ‰¿å•ä¾‹æ¨¡å¼çš„ä»£ç æ–‡ä»¶</strong></p><h2 id="äººç‰©ä¼ é€åæ— æ³•ç§»åŠ¨"><a href="#äººç‰©ä¼ é€åæ— æ³•ç§»åŠ¨" class="headerlink" title="äººç‰©ä¼ é€åæ— æ³•ç§»åŠ¨"></a>äººç‰©ä¼ é€åæ— æ³•ç§»åŠ¨</h2><p>è¿™æ—¶å€™äººç‰©å¯ä»¥ä¼ é€åˆ°å¦å¤–ä¸€ä¸ªåœºæ™¯äº†ï¼Œä½†æ˜¯ä¸èƒ½ç§»åŠ¨ï¼Œå¯èƒ½æœ‰ä¸‹é¢é—®é¢˜</p><p>ç¬¬ä¸€ä¸ªå¯èƒ½å­˜åœ¨çš„é—®é¢˜å°±æ˜¯æˆ‘ä»¬ç¬¬äºŒä¸ªåœºæ™¯çš„åœ°æ¿æ²¡æœ‰è®¾ç½®æˆ<code>Ground</code>æ ‡ç­¾ï¼Œæˆ‘ä»¬è¦è®¾ç½®ä¸€ä¸‹</p><p>ç¬¬äºŒä¸ªé—®é¢˜æ˜¯æˆ‘ä»¬åœ¨<code>PlayerController.cs</code>ä¸­çš„<code>OnMouseClicked</code>äº‹ä»¶æ²¡æœ‰åŠ è½½å‡ºæ¥</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//ç´ æå¯ç”¨æ—¶æ³¨å†Œäº‹ä»¶</span>MouseManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>OnMouseClicked<span class="token operator">+=</span>MoveToTarget<span class="token punctuation">;</span>MouseManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>OnEnemyClicked<span class="token operator">+=</span>EventAttact<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//KeyManager.Instance.OnKeyInputMove+=MoveToTarget;</span>GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">RigisterPlayer</span><span class="token punctuation">(</span>charcterStates<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnDisable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//ç´ æç¦ç”¨æ—¶æ³¨é”€äº‹ä»¶</span>MouseManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>OnMouseClicked<span class="token operator">-=</span>MoveToTarget<span class="token punctuation">;</span>MouseManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>OnEnemyClicked<span class="token operator">-=</span>EventAttact<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="äººç‰©ä¼ é€å›æ¥ç›¸æœºæ²¡æœ‰è·Ÿéš"><a href="#äººç‰©ä¼ é€å›æ¥ç›¸æœºæ²¡æœ‰è·Ÿéš" class="headerlink" title="äººç‰©ä¼ é€å›æ¥ç›¸æœºæ²¡æœ‰è·Ÿéš"></a>äººç‰©ä¼ é€å›æ¥ç›¸æœºæ²¡æœ‰è·Ÿéš</h2><p>æ¥ç€è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯å½“æˆ‘ä»¬ä»å¦å¤–ä¸€ä¸ªåœºæ™¯ä¼ é€å›æ¥æ—¶ï¼Œç›¸æœºçš„è·Ÿéšå°±ä¼šå¤±æ•ˆï¼Œè¿™é‡Œæ¥ä¿®å¤è¿™ä¸ªé—®é¢˜</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//GameManager.cs</span><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">RigisterPlayer</span><span class="token punctuation">(</span><span class="token class-name">CharacterStates</span> player<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//é€šè¿‡å¤–ç•Œæ³¨å†Œçš„æ–¹å¼æ¥è·å¾—å¯¹è±¡çš„playerStates</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>playerStates <span class="token operator">=</span> player<span class="token punctuation">;</span>        <span class="token comment">//å¤–ç•Œäººç‰©å¯¹è±¡æ³¨å†ŒåŒæ—¶è®©ç›¸æœºè¿›è¡Œè·Ÿéš</span>        followCamera <span class="token operator">=</span> <span class="token generic-method"><span class="token function">FindObjectOfType</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CinemachineFreeLook<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åœ¨åœ°å›¾ä¸­æŸ¥æ‰¾ç›¸æœº</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>followCamera<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœæ‰¾åˆ°ç›¸æœºå°±è®©å®ƒè·Ÿéš</span>            followCamera<span class="token punctuation">.</span>Follow <span class="token operator">=</span> playerStates<span class="token punctuation">.</span>transform<span class="token punctuation">;</span>            followCamera<span class="token punctuation">.</span>LookAt <span class="token operator">=</span> playerStates<span class="token punctuation">.</span>transform<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ä¸€ç« æˆ‘ä»¬æ¥å®ç°ä¸åŒåœºæ™¯çš„ä¼ é€&lt;/p&gt;
&lt;p&gt;é¦–å…ˆï¼Œæˆ‘ä»¬è¦æŠŠå¦å¤–ä¸€ä¸ªåœºæ™¯æ­å»ºå¥½å…ˆï¼Œéšåæ‰å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥çš„å·¥ä½œï¼Œè¿™é‡Œå°±è‡ªå·±å‘æŒ¥å§&lt;/p&gt;
&lt;p&gt;æ­å»ºå¥½åœºæ™¯åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ­£å¼å¼€å§‹æ¥å®ç°å¦‚ä½•è·¨åœºæ™¯ä¼ é€äº†&lt;/p&gt;
&lt;h1 id=&quot;è®¾ç½®å¥½ä¼ é€é—¨å±æ€§&quot;&gt;&lt;a href=&quot;#è®¾ç½®å¥½ä¼ é€é—¨</summary>
      
    
    
    
    <category term="Unityå­¦ä¹ ç¬”è®°" scheme="http://sakura-pub.top/categories/Unity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Unity" scheme="http://sakura-pub.top/tags/Unity/"/>
    
  </entry>
  
  <entry>
    <title>Unityç¬”è®°26-å®ç°åŒåœºæ™¯çš„ä¼ é€</title>
    <link href="http://sakura-pub.top/UnityNotes/Unity%E7%AC%94%E8%AE%B026-%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%9C%BA%E6%99%AF%E7%9A%84%E4%BC%A0%E9%80%81/"/>
    <id>http://sakura-pub.top/UnityNotes/Unity%E7%AC%94%E8%AE%B026-%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%9C%BA%E6%99%AF%E7%9A%84%E4%BC%A0%E9%80%81/</id>
    <published>2021-08-02T01:49:40.000Z</published>
    <updated>2021-08-02T04:18:18.335Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™é‡Œæˆ‘ä»¬å®ç°åŒåœºæ™¯çš„ä¼ é€æ•ˆæœ</p><h1 id="è°ƒæ•´ä¼ é€é—¨"><a href="#è°ƒæ•´ä¼ é€é—¨" class="headerlink" title="è°ƒæ•´ä¼ é€é—¨"></a>è°ƒæ•´ä¼ é€é—¨</h1><p>åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬è¦æŠŠä¸åŒçš„ä¼ é€é—¨æ‘†æ”¾å¥½å…ˆ</p><p>å¦å¤–æˆ‘ä»¬å¯èƒ½ä¼šå‘ç°ç‚¹å‡»ä¸äº†ä¼ é€é—¨ï¼Œè¿™æ˜¯å› ä¸ºä¼ é€é—¨çš„box collideræŒ¡ä½äº†æˆ‘ä»¬é¼ æ ‡çš„å°„çº¿ï¼Œè¿™é‡ŒæŠŠå®ƒçš„å¤§å°æ”¹ä¸€ä¸‹å°±è¡Œäº†</p><img src="https://i.loli.net/2021/08/02/LHvS6JN4idPbQOA.png" style="zoom:80%;" /><p>ç»™ä¼ é€é—¨åŠ ä¸Š<code>Portal</code>çš„æ ‡ç­¾ï¼Œç„¶åå†å»<code>MouseManager.cs</code>ä¿®æ”¹ä¸€ä¸‹é¼ æ ‡çš„å›¾æ ·</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetCursorTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token class-name">Ray</span> ray <span class="token operator">=</span> Camera<span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token function">ScreenPointToRay</span><span class="token punctuation">(</span>Input<span class="token punctuation">.</span>mousePosition<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>Physics<span class="token punctuation">.</span><span class="token function">Raycast</span><span class="token punctuation">(</span>ray<span class="token punctuation">,</span><span class="token keyword">out</span> hitInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//TODO:åˆ‡æ¢é¼ æ ‡è´´å›¾</span><span class="token keyword">switch</span><span class="token punctuation">(</span>hitInfo<span class="token punctuation">.</span>collider<span class="token punctuation">.</span>gameObject<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">case</span> <span class="token string">"Ground"</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>åœ°é¢è¡Œèµ°çš„å›¾æ ‡Cursor<span class="token punctuation">.</span><span class="token function">SetCursor</span><span class="token punctuation">(</span>arrow<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector2</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>CursorMode<span class="token punctuation">.</span>Auto<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token string">"Enemy"</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>ç‚¹å‡»æ•Œäººçš„å›¾æ ‡Cursor<span class="token punctuation">.</span><span class="token function">SetCursor</span><span class="token punctuation">(</span>attack<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector2</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>CursorMode<span class="token punctuation">.</span>Auto<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token string">"Portal"</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>ç‚¹å‡»ä¼ é€é—¨å›¾æ ‡Cursor<span class="token punctuation">.</span><span class="token function">SetCursor</span><span class="token punctuation">(</span>doorway<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector2</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>CursorMode<span class="token punctuation">.</span>Auto<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">default</span><span class="token punctuation">:</span>Cursor<span class="token punctuation">.</span><span class="token function">SetCursor</span><span class="token punctuation">(</span>point<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector2</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>CursorMode<span class="token punctuation">.</span>Auto<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//if</span><span class="token punctuation">&#125;</span><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">MouseControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span>Input<span class="token punctuation">.</span><span class="token function">GetMouseButtonDown</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> hitInfo<span class="token punctuation">.</span>collider <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span>hitInfo<span class="token punctuation">.</span>collider<span class="token punctuation">.</span><span class="token function">CompareTag</span><span class="token punctuation">(</span><span class="token string">"Ground"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>OnMouseClicked<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>hitInfo<span class="token punctuation">.</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>hitInfo<span class="token punctuation">.</span>collider<span class="token punctuation">.</span><span class="token function">CompareTag</span><span class="token punctuation">(</span><span class="token string">"Portal"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//ç‚¹å‡»ä¼ é€é—¨</span>OnMouseClicked<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>hitInfo<span class="token punctuation">.</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>hitInfo<span class="token punctuation">.</span>collider<span class="token punctuation">.</span><span class="token function">CompareTag</span><span class="token punctuation">(</span><span class="token string">"Enemy"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>OnEnemyClicked<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>hitInfo<span class="token punctuation">.</span>collider<span class="token punctuation">.</span>gameObject<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç‚¹å‡»æ•Œäººä¼ é€’æ•Œäººçš„gameObject</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>hitInfo<span class="token punctuation">.</span>collider<span class="token punctuation">.</span><span class="token function">CompareTag</span><span class="token punctuation">(</span><span class="token string">"Attackable"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>OnEnemyClicked<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>hitInfo<span class="token punctuation">.</span>collider<span class="token punctuation">.</span>gameObject<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ç¼–å†™ä¼ é€ç®¡ç†ä»£ç "><a href="#ç¼–å†™ä¼ é€ç®¡ç†ä»£ç " class="headerlink" title="ç¼–å†™ä¼ é€ç®¡ç†ä»£ç "></a>ç¼–å†™ä¼ é€ç®¡ç†ä»£ç </h1><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>SceneController.cs</code>ï¼Œä¹‹æ‰€ä»¥ä¸æ˜¯ç”¨Manageræ˜¯å› ä¸ºåœ¨Unityæœ‰ä¸ª<code>SceneManager</code>åŒåçš„æ–‡ä»¶å­˜åœ¨</p><img src="https://i.loli.net/2021/08/02/FLvOK3csbIP45Xz.png" style="zoom:80%;" /><p>æ³¨æ„æ­¤æ–‡ä»¶ç»§æ‰¿çš„æ˜¯<strong>å•ä¾‹æ¨¡å¼</strong>ç±»</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections</span><span class="token punctuation">;</span><span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span><span class="token keyword">using</span> <span class="token namespace">UnityEngine<span class="token punctuation">.</span>SceneManagement</span><span class="token punctuation">;</span><span class="token keyword">using</span> <span class="token namespace">UnityEngine<span class="token punctuation">.</span>AI</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SceneController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Singleton<span class="token punctuation">&lt;</span>SceneController<span class="token punctuation">></span></span></span><span class="token punctuation">&#123;</span>    <span class="token class-name">GameObject</span> player<span class="token punctuation">;</span><span class="token comment">//ç©å®¶</span>    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TransitiToDestination</span><span class="token punctuation">(</span><span class="token class-name">TransitionPoint</span> transitionPoint<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//è€ƒè™‘æ˜¯åŒåœºæ™¯è¿˜æ˜¯ä¸åŒåœºæ™¯çš„ä¼ é€</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>transitionPoint<span class="token punctuation">.</span>transitionType<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">case</span> TransitionPoint<span class="token punctuation">.</span>TransitionType<span class="token punctuation">.</span>SameScene<span class="token punctuation">:</span>            <span class="token comment">//åŒåœºæ™¯å¯ä»¥ä¸ç”¨å¼‚æ­¥ï¼Œç›´æ¥ä¼ é€</span>            <span class="token comment">//è¿™é‡Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è·å¾—å½“å‰æ´»åŠ¨çª—å£çš„åå­—</span>            <span class="token function">StartCoroutine</span><span class="token punctuation">(</span><span class="token function">Transition</span><span class="token punctuation">(</span>SceneManager<span class="token punctuation">.</span><span class="token function">GetActiveScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>transitionPoint<span class="token punctuation">.</span>destinationTag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> TransitionPoint<span class="token punctuation">.</span>TransitionType<span class="token punctuation">.</span>DifferentScene<span class="token punctuation">:</span>            <span class="token comment">//ä¸åŒåœºæ™¯ï¼Œç”¨å¼‚æ­¥åŠ è½½çš„æ–¹å¼</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token return-type class-name">IEnumerator</span> <span class="token function">Transition</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> sceneName<span class="token punctuation">,</span><span class="token class-name">TransitionDestination<span class="token punctuation">.</span>DestinationTag</span> destinationTag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//å…ˆè·å¾—ç©å®¶çš„å¯¹è±¡</span>        player <span class="token operator">=</span> GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span>gameObject<span class="token punctuation">;</span>        <span class="token comment">//è·å¾—ç›®çš„åœ°ä¼ é€é—¨å¯¹è±¡</span>        <span class="token class-name"><span class="token keyword">var</span></span> td <span class="token operator">=</span> <span class="token function">GetDestination</span><span class="token punctuation">(</span>destinationTag<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å…³é—­å¯¼èˆªç§»åŠ¨</span>        player<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>NavMeshAgent<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token comment">//è®¾ç½®å¯¹è±¡çš„åæ ‡å’Œæ—‹è½¬è§’åº¦</span>        player<span class="token punctuation">.</span>transform<span class="token punctuation">.</span><span class="token function">SetPositionAndRotation</span><span class="token punctuation">(</span>td<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position<span class="token punctuation">,</span>td<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//æ¢å¤å¯¼èˆªç§»åŠ¨</span>        player<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>NavMeshAgent<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token return-type class-name">TransitionDestination</span> <span class="token function">GetDestination</span><span class="token punctuation">(</span><span class="token class-name">TransitionDestination<span class="token punctuation">.</span>DestinationTag</span> destinationTag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//é€šè¿‡ä¼ é€é—¨ç›®çš„åœ°çš„æ ‡ç­¾å¯»æ‰¾ç›®çš„åœ°ä¼ é€é—¨æ‰€åœ¨ä½ç½®</span>        <span class="token class-name"><span class="token keyword">var</span></span> entrances <span class="token operator">=</span> <span class="token generic-method"><span class="token function">FindObjectsOfType</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TransitionDestination<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>entrances<span class="token punctuation">.</span>Length<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>entrances<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>destinationTag <span class="token operator">==</span> destinationTag<span class="token punctuation">)</span><span class="token comment">//ç›®çš„åœ°ä¼ é€é—¨æ ‡ç­¾åŒ¹é…çš„è¯</span>                <span class="token keyword">return</span> entrances<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦å¤–å½“æˆ‘ä»¬ç©å®¶åˆ°è¾¾ä¼ é€é—¨ï¼Œæˆ‘å¸Œæœ›å®ƒå¯ä»¥æŒ‰é”®è§¦å‘ä¼ é€çš„ï¼Œæ‰€ä»¥è¿™é‡Œå»åˆ°<code>TransitionPoint.cs</code></p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//è§¦å‘å™¨è®¾ç½®</span><span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">bool</span></span> canTrans<span class="token punctuation">;</span><span class="token comment">//æ˜¯å¦è§¦å‘ä¼ é€</span><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>Input<span class="token punctuation">.</span><span class="token function">GetKeyDown</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>E<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> canTrans<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//æŒ‰é”®è§¦å‘ä¼ é€</span>        SceneController<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">TransitiToDestination</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿˜æœ‰ä¸€ä¸ªå·¥ä½œå°±æ˜¯è¦æŠŠæˆ‘ä»¬çš„<code>TransitionDestination.cs</code>ä½œä¸ºç»„ä»¶æ·»åŠ åœ¨ä¼ é€é—¨å­å¯¹è±¡çš„ç‚¹ä¸Š</p><img src="https://i.loli.net/2021/08/02/3Jm9QXySOEiqdRF.png" style="zoom:80%;" /><img src="https://i.loli.net/2021/08/02/Hen9PBroRJYcFjp.png" style="zoom:80%;" /><p>è¿™ä¸ªç‚¹æ˜¯ç”¨æ¥è®¾ç½®å½“å‰çš„ç‚¹æ˜¯å±äºå“ªä¸€ä¸ªæ ‡ç­¾çš„ï¼Œæˆ‘ä»¬å°±æŠŠä¸€ä¸ªä¼ é€é—¨å½“åšå…¥å£è®¾ä¸º<code>ENTER</code>ï¼Œå¦ä¸€ä¸ªä¼ é€é—¨å½“åšç›®çš„åœ°è®¾ä¸º<code>A</code></p><p>å¦å¤–å»åˆ°ä¼ é€é—¨ä¸­ï¼Œç›®çš„åœ°ä¹Ÿè¦è¿›è¡Œå¯¹åº”çš„è®¾ç½®ï¼Œå…¥å£ä¼ é€é—¨çš„ç›®çš„åœ°æ˜¯<code>A</code>ï¼Œåè¿‡æ¥å¦å¤–ä¸€ä¸ªä¼ é€é—¨æƒ³è¿‡æ¥å°±è¦è®¾ç½®ç›®çš„åœ°ä¸º<code>ENTER</code></p><p><strong>æ³¨æ„</strong>ï¼šæˆ‘ä»¬æœ€å¥½ä¸è¦è®¾ç½®å¤šä¸ªåŒä¸€æ ‡ç­¾çš„ä¼ é€é—¨ï¼Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜</p><p>æœ€åï¼Œå»ºç«‹ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œå¹¶æŠŠ<code>SceneController.cs</code>ä½œä¸ºç»„ä»¶é™„ä¸Šå»</p><img src="https://i.loli.net/2021/08/02/caN1CyLrJU76bnI.png" style="zoom:80%;" /><h1 id="Triggeræ— æ³•è§¦å‘é—®é¢˜"><a href="#Triggeræ— æ³•è§¦å‘é—®é¢˜" class="headerlink" title="Triggeræ— æ³•è§¦å‘é—®é¢˜"></a>Triggeræ— æ³•è§¦å‘é—®é¢˜</h1><p>å¦‚æœå‡½æ•°å†…çš„Triggeräº‹ä»¶æ²¡æœ‰è§¦å‘çš„è¯ï¼Œå¯èƒ½æ˜¯ç©å®¶ä¸Šæ²¡æœ‰æ·»åŠ é’¢ä½“çš„åŸå› ï¼ŒæŠŠé’¢ä½“æ·»åŠ åœ¨ä¸»åŠ¨ç¢°æ’çš„ç‰©ä½“ä¸Šï¼ˆè¿™é‡Œæ˜¯ç©å®¶ï¼‰ï¼Œç„¶åæŠŠä¼ é€é—¨å’Œç©å®¶çš„ç¢°æ’ä½“ç»„ä»¶ä¸­<code>IsTrigger</code>å‹¾é€‰ä¸Šå°±å¯ä»¥äº†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™é‡Œæˆ‘ä»¬å®ç°åŒåœºæ™¯çš„ä¼ é€æ•ˆæœ&lt;/p&gt;
&lt;h1 id=&quot;è°ƒæ•´ä¼ é€é—¨&quot;&gt;&lt;a href=&quot;#è°ƒæ•´ä¼ é€é—¨&quot; class=&quot;headerlink&quot; title=&quot;è°ƒæ•´ä¼ é€é—¨&quot;&gt;&lt;/a&gt;è°ƒæ•´ä¼ é€é—¨&lt;/h1&gt;&lt;p&gt;åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬è¦æŠŠä¸åŒçš„ä¼ é€é—¨æ‘†æ”¾å¥½å…ˆ&lt;/p&gt;
&lt;p&gt;å¦å¤–æˆ‘ä»¬å¯èƒ½ä¼šå‘ç°</summary>
      
    
    
    
    <category term="Unityå­¦ä¹ ç¬”è®°" scheme="http://sakura-pub.top/categories/Unity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Unity" scheme="http://sakura-pub.top/tags/Unity/"/>
    
  </entry>
  
  <entry>
    <title>Unityç¬”è®°25-åˆ¶ä½œä¼ é€é—¨</title>
    <link href="http://sakura-pub.top/UnityNotes/Unity%E7%AC%94%E8%AE%B025-%E5%88%B6%E4%BD%9C%E4%BC%A0%E9%80%81%E9%97%A8/"/>
    <id>http://sakura-pub.top/UnityNotes/Unity%E7%AC%94%E8%AE%B025-%E5%88%B6%E4%BD%9C%E4%BC%A0%E9%80%81%E9%97%A8/</id>
    <published>2021-08-01T01:53:22.000Z</published>
    <updated>2021-08-01T03:53:51.612Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬è¿™ä¸€ç« æ¥åˆ¶ä½œä¸€ä¸ªä¼ é€é—¨ä»¥ä¾›åé¢ç©å®¶åˆ‡æ¢ä¸åŒåœºæ™¯æ—¶ä½¿ç”¨</p><h1 id="åˆ¶ä½œä¼ é€é—¨Shader"><a href="#åˆ¶ä½œä¼ é€é—¨Shader" class="headerlink" title="åˆ¶ä½œä¼ é€é—¨Shader"></a>åˆ¶ä½œä¼ é€é—¨Shader</h1><p>é¦–å…ˆå°±æ˜¯è¦æ¥åˆ¶ä½œä¼ é€é—¨çš„Shaderï¼Œæ–°å»ºä¸€ä¸ª<code>Lit Shader Graph</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰å…‰å½±å“çš„shaderï¼Œèœå•ä¸­è¿˜æœ‰ä¸€ä¸ªå«åšUnlit Shader Graphå°±æ˜¯æ²¡æœ‰å…‰å½±å“çš„</p><p>è¿™é‡Œå»ºå¥½åèµ·åä¸º<code>Portal Shader</code></p><img src="https://i.loli.net/2021/08/01/pd7nMhKZHVBm4ar.png" style="zoom:80%;" /><p>æ³¨æ„é‡Œè¾¹çš„è®¾ç½®ï¼ŒSurfaceé€‰æ‹©<code>Transparent</code>å°±æ˜¯æœ‰é€æ˜é€šé“çš„æ„æ€ï¼Œç„¶åå‹¾é€‰<code>Two Sided</code>æ˜¾ç¤ºä¸¤é¢</p><img src="https://i.loli.net/2021/08/01/k7eZSNDKwTt2Y43.png" style="zoom:80%;" /><p>è¿™é‡Œç›´æ¥ä¸Šåšå¥½çš„å›¾ï¼Œé¢œè‰²çš„å±æ€§é¢æ¿ä¸­æ³¨æ„è¦é€‰æ‹©<code>HDR</code></p><img src="https://i.loli.net/2021/08/01/nwoQLuWKhYSR8lp.png" style="zoom:80%;" /><p>åšå¥½åç‚¹å‡»å·¦ä¸Šè§’<code>Save Asset</code>ä¿å­˜ï¼Œç„¶åå³é”®<code>Shder Graph</code>åˆ›å»ºä¸ºä¸€ä¸ª<code>Materials</code></p><img src="https://i.loli.net/2021/08/01/ecxz9EY5KfGgMOq.png" style="zoom:80%;" /><p>è¿™æ ·ä¸€ä¸ªä¼ é€é—¨çš„Shaderå°±åˆ›å»ºå¥½äº†</p><h1 id="åˆ¶ä½œä¼ é€é—¨"><a href="#åˆ¶ä½œä¼ é€é—¨" class="headerlink" title="åˆ¶ä½œä¼ é€é—¨"></a>åˆ¶ä½œä¼ é€é—¨</h1><p>å›åˆ°åœ°å›¾ä¸Šï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>Quad</code></p><img src="https://i.loli.net/2021/08/01/1ULfhYbuIgzD529.png" style="zoom:80%;" /><p>ç„¶åæŠŠåˆšåˆšçš„ä¼ é€é—¨æè´¨é™„ä¸Šå»ï¼Œç„¶åå°±å¯ä»¥çœ‹åˆ°ä¼ é€é—¨çš„é›å½¢äº†</p><img src="https://i.loli.net/2021/08/01/oGMurVFip1O8sjA.png" style="zoom:80%;" /><p>ä¹‹åå¯ä»¥åˆ›å»ºä¸€ä¸ªå­å¯¹è±¡ï¼Œè¡¨ç¤ºä¼ é€ç‚¹ï¼Œä»¥åå½“ç©å®¶è§¦ç¢°è¿™ä¸ªç‚¹ä¾¿å¯ä»¥è§¦å‘ä¼ é€äº‹ä»¶</p><img src="https://i.loli.net/2021/08/01/z65KBjWylxAvGIo.png" style="zoom:80%;" /><p>å¦‚å›¾æˆ‘è¿˜å°†è¿™ä¸ªç‚¹é™„ä¸Šäº†ä¸€ä¸ªè“è‰²å›¾æ ‡ï¼Œä»£è¡¨è¿™ä¸¤ä¸ªä¼ é€é—¨æ˜¯äº’é€šçš„ï¼Œä¸€å¯¹çš„ï¼Œå¯ä»¥èµ·åˆ°ä¸€ä¸ªæ ‡è®°ä½œç”¨</p><h1 id="ç¼–å†™ä¼ é€é—¨åŸºæœ¬ä»£ç "><a href="#ç¼–å†™ä¼ é€é—¨åŸºæœ¬ä»£ç " class="headerlink" title="ç¼–å†™ä¼ é€é—¨åŸºæœ¬ä»£ç "></a>ç¼–å†™ä¼ é€é—¨åŸºæœ¬ä»£ç </h1><p>è¿™é‡Œç¼–å†™ä¸€ä¸‹åŸºæœ¬çš„ä¼ é€é—¨ä»£ç ï¼Œè¯¦ç»†çš„ä»£ç å®Œå–„ç•™åœ¨ä¸‹ä¸€ç« èŠ‚</p><img src="https://i.loli.net/2021/08/01/aVGXZyRzq36d8pt.png" style="zoom:80%;" /><p>è¿™é‡Œçš„<code>TransitionPoint</code>æŒ‚è½½åœ¨ä¼ é€é—¨ä¸Šï¼Œè€Œ<code>TransitionDestination</code>æŒ‚è½½åœ¨è“è‰²çš„ç‚¹ä¸Š</p><p>æˆ‘ä»¬å…ˆæ¥ç¼–è¾‘TransitionPoint.cs</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//TransitionPoint.cs</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransitionPoint</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MonoBehaviour</span></span><span class="token punctuation">&#123;</span>        <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">TransitionType</span><span class="token punctuation">&#123;</span><span class="token comment">//ä¼ é€çŠ¶æ€</span>        SameScene<span class="token punctuation">,</span>DifferentScene    <span class="token punctuation">&#125;</span>        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Header</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"Transition Infoï¼ˆä¼ é€é—¨è®¾ç½®ï¼‰"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">string</span></span> sceneName<span class="token punctuation">;</span><span class="token comment">//è®°å½•åœºæ™¯åç§°</span>    <span class="token keyword">public</span> <span class="token class-name">TransitionType</span> transitionType<span class="token punctuation">;</span><span class="token comment">//è®°å½•ä¼ é€çŠ¶æ€ï¼ŒåŒåœºæ™¯ä¼ é€å°±å¤–è¾¹é€‰æ‹©ç¬¬ä¸€ä¸ªï¼Œä¸åŒåœºæ™¯å°±é€‰æ‹©ç¬¬äºŒä¸ª</span>    <span class="token keyword">public</span> <span class="token class-name">TransitionDestination<span class="token punctuation">.</span>DestinationTag</span> destinationTag<span class="token punctuation">;</span><span class="token comment">//ä¼ é€ç‚¹ç›®çš„åœ°</span>    <span class="token comment">//è§¦å‘å™¨è®¾ç½®</span>    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">bool</span></span> canTrans<span class="token punctuation">;</span><span class="token comment">//æ˜¯å¦è§¦å‘ä¼ é€</span>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnTriggerStay</span><span class="token punctuation">(</span><span class="token class-name">Collider</span> other<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//ç©å®¶åœ¨ä¼ é€é—¨åŒºåŸŸå†…</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span><span class="token function">CompareTag</span><span class="token punctuation">(</span><span class="token string">"Player"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            canTrans <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnTriggerExit</span><span class="token punctuation">(</span><span class="token class-name">Collider</span> other<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//ç©å®¶ç¦»å¼€äº†ä¼ é€é—¨åŒºåŸŸ</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span><span class="token function">CompareTag</span><span class="token punctuation">(</span><span class="token string">"Player"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            canTrans <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­ä¼ é€ç‚¹ç›®çš„åœ°å¯¹åº”çš„åœ¨TransitionDestination.csä¸­</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">//TransitionDestination.cs</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransitionDestination</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MonoBehaviour</span></span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">DestinationTag</span><span class="token punctuation">&#123;</span><span class="token comment">//ä¼ é€ç‚¹æ ‡ç­¾</span>        ENTER<span class="token punctuation">,</span>A<span class="token punctuation">,</span>B<span class="token punctuation">,</span>C    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">DestinationTag</span> destinationTag<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œçš„A,B,Cå¯ä»¥è‡ªè¡Œä¿®æ”¹ï¼Œè¡¨ç¤ºçš„æ˜¯ä¸åŒä¼ é€é—¨ä¸­çš„ä¸åŒåœ°æ–¹ï¼Œç±»ä¼¼äºä¸€ä¸ªç«™ç‰Œ</p><p>æˆ‘ä»¬è¿˜æ³¨æ„åˆ°åœ¨å‰é¢<code>TransitionPoint.cs</code>ä¸­æœ‰è§¦å‘çš„ä»£ç ï¼Œè¿™é‡Œè¦åˆ°Unityå±æ€§é¢æ¿ä¸­æŠŠè§¦å‘<code>isTrigger</code>é€‰é¡¹å‹¾ä¸Šï¼Œå¦åˆ™ä¸èƒ½è§¦å‘<code>OnTriggerStay()</code>å’Œ<code>OnTriggerExit()</code>æ–¹æ³•</p><img src="https://i.loli.net/2021/08/01/G7DPlvBtNd5Lw9Y.png" style="zoom:80%;" /><p>å½“ç„¶ï¼Œç°åœ¨ç”¨åˆ°çš„æ˜¯<code>Mesh Collider</code>ï¼Œè¿™é‡Œè§¦å‘é¢ç§¯åªæ˜¯ä¸€ä¸ªå¹³é¢ï¼Œæˆ‘ä»¬å¯ä»¥æ¢æˆ<code>Box Collider</code>ï¼Œè®©å®ƒçš„è§¦å‘é¢ç§¯æ›´å¤§ä¸€äº›</p><img src="https://i.loli.net/2021/08/01/mPRClNHWdA6jufi.png" style="zoom:80%;" /><p>å¼„å¥½è¿™äº›åï¼Œè®°å¾—æŠŠä¼ é€é—¨ä¿å­˜ä¸ºä¸€ä¸ªç´ æ</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æˆ‘ä»¬è¿™ä¸€ç« æ¥åˆ¶ä½œä¸€ä¸ªä¼ é€é—¨ä»¥ä¾›åé¢ç©å®¶åˆ‡æ¢ä¸åŒåœºæ™¯æ—¶ä½¿ç”¨&lt;/p&gt;
&lt;h1 id=&quot;åˆ¶ä½œä¼ é€é—¨Shader&quot;&gt;&lt;a href=&quot;#åˆ¶ä½œä¼ é€é—¨Shader&quot; class=&quot;headerlink&quot; title=&quot;åˆ¶ä½œä¼ é€é—¨Shader&quot;&gt;&lt;/a&gt;åˆ¶ä½œä¼ é€é—¨Shader&lt;/h1&gt;&lt;</summary>
      
    
    
    
    <category term="Unityå­¦ä¹ ç¬”è®°" scheme="http://sakura-pub.top/categories/Unity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Unity" scheme="http://sakura-pub.top/tags/Unity/"/>
    
  </entry>
  
  <entry>
    <title>Unityç¬”è®°24-åˆ¶ä½œç©å®¶çŠ¶æ€æ¡</title>
    <link href="http://sakura-pub.top/UnityNotes/Unity%E7%AC%94%E8%AE%B024-%E5%88%B6%E4%BD%9C%E7%8E%A9%E5%AE%B6%E7%8A%B6%E6%80%81%E6%9D%A1/"/>
    <id>http://sakura-pub.top/UnityNotes/Unity%E7%AC%94%E8%AE%B024-%E5%88%B6%E4%BD%9C%E7%8E%A9%E5%AE%B6%E7%8A%B6%E6%80%81%E6%9D%A1/</id>
    <published>2021-07-31T02:35:09.000Z</published>
    <updated>2021-09-05T08:17:41.684Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬ç« æ¥åˆ¶ä½œç©å®¶çš„çŠ¶æ€æ¡ï¼Œå¦‚è¡€é‡æ¡ï¼Œç»éªŒæ¡ç­‰</p><h1 id="ç¼–è¾‘UIå¸ƒå±€"><a href="#ç¼–è¾‘UIå¸ƒå±€" class="headerlink" title="ç¼–è¾‘UIå¸ƒå±€"></a>ç¼–è¾‘UIå¸ƒå±€</h1><p>ç¬¬ä¸€æ­¥ä¹Ÿæ˜¯å»ºç«‹ä¸€ä¸ªç”»å¸ƒï¼Œæ¨¡å¼ä½¿ç”¨é»˜è®¤çš„<code>Screen Space</code>è¦†ç›–å±å¹•</p><p>å€¼å¾—æ³¨æ„æ˜¯ä¸ºäº†ä½¿çŠ¶æ€æ¡å¯ä»¥éšç€å±å¹•çš„åˆ†è¾¨ç‡å¤§å°è€Œåˆ‡æ¢ï¼Œæˆ‘ä»¬çš„<code>UI Scale Mode</code>è¦è®¾ç½®æˆ<code>Scale With Scree</code></p><img src="https://www.hualigs.cn/image/6104bb2a28b1d.jpg" style="zoom:80%;" /><p>ä¹‹ååˆ›å»ºå¥½UIï¼Œå¯ä»¥åœ¨<code>Scene</code>è§†å›¾çš„2Dæ¨¡å¼ä¸‹è°ƒæ•´åˆ°åˆé€‚çš„ä½ç½®ï¼Œç„¶ååœ¨<code>Game</code>è§†å›¾ä¸‹é¢„è§ˆæ•ˆæœï¼Œå¯ä»¥è‡ªè¡Œå¤šå¤šå°è¯•</p><p>æœ€åçš„æ•ˆæœå¦‚ä¸‹</p><img src="https://i.loli.net/2021/07/31/xh2a6d1GFWIAQB3.png" style="zoom:80%;" /><p>æ³¨æ„è¿™é‡Œçš„æ–‡å­—æˆ‘ç”¨äº†è‡ªå®šä¹‰çš„å­—ä½“ï¼Œåœ¨Unityä¸­åªç”¨æŠŠä½ æƒ³è¦ç”¨çš„ç‰©ä½“æ‹–æ‹½è¿›æ¥åˆ†ç±»å¥½ï¼Œå°±å¯ä»¥ç›´æ¥åœ¨æ–‡å­—UIè®¾ç½®é¢æ¿ä¸Šé€‰æ‹©ä½¿ç”¨äº†</p><h1 id="ç¼–å†™ä»£ç "><a href="#ç¼–å†™ä»£ç " class="headerlink" title="ç¼–å†™ä»£ç "></a>ç¼–å†™ä»£ç </h1><p>æ¥ä¸‹æ¥å°±æ˜¯ç¼–å†™ä»£ç æ¥ç®¡ç†æˆ‘ä»¬çš„UIäº†</p><img src="https://i.loli.net/2021/07/31/WEluxrQkRazFKf5.png" style="zoom:80%;" /><p>ç„¶åæŠŠä»£ç ä½œä¸ºç»„ä»¶æ·»åŠ åˆ°ä¸Šé¢åˆ›å»ºçš„ç”»å¸ƒå½“ä¸­ï¼Œæ¥ç€å°±æ˜¯ç¼–å†™ä»£ç äº†</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span><span class="token keyword">using</span> <span class="token namespace">UnityEngine<span class="token punctuation">.</span>UI</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlayerHealthUI</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MonoBehaviour</span></span><span class="token punctuation">&#123;</span>    <span class="token comment">//ç”±äºæˆ‘ä»¬çš„äººç‰©ä¿¡æ¯æ æœ€ç»ˆä¼šä¿å­˜ä¸ºä¸€ä¸ªprefab</span>    <span class="token comment">//å› æ­¤æˆ‘ä»¬å¯ä»¥ä¸ä½¿ç”¨æ‹–æ‹½gameobjectæ–¹å¼æ¥è·å¾—å¯¹è±¡</span>    <span class="token comment">//å¯ä»¥ç›´æ¥ä½¿ç”¨è·å¾—å¯¹è±¡çš„å­å¯¹è±¡æ–¹å¼</span>    <span class="token class-name">Text</span> levelText<span class="token punctuation">;</span><span class="token comment">//è·å¾—textæ–‡æœ¬</span>    <span class="token class-name">Image</span> healthSlider<span class="token punctuation">;</span><span class="token comment">//ç”Ÿå‘½å€¼æ‹–æ‹½æ¡</span>    <span class="token class-name">Image</span> expSlider<span class="token punctuation">;</span><span class="token comment">//ç»éªŒæ‹–æ‹½æ¡</span>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Awake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//æ³¨æ„GetChildå¡«å†™çš„å‚æ•°ç±»ä¼¼äºæ•°ç»„ä¸‹æ ‡ï¼Œç¬¬ä¸€ä¸ªå¯¹è±¡çš„ç´¢å¼•æ˜¯0</span>        levelText <span class="token operator">=</span> transform<span class="token punctuation">.</span><span class="token function">GetChild</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Text<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å¾—æ–‡å­—å¯¹è±¡</span>        healthSlider <span class="token operator">=</span> transform<span class="token punctuation">.</span><span class="token function">GetChild</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetChild</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Image<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å¾—ç”Ÿå‘½æ‹–æ‹½æ¡</span>        expSlider <span class="token operator">=</span> transform<span class="token punctuation">.</span><span class="token function">GetChild</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetChild</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Image<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å¾—ç»éªŒå€¼æ‹–æ‹½æ¡</span>    <span class="token punctuation">&#125;</span>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">UpdateExp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">UpdateHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        levelText<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">"Level  "</span> <span class="token operator">+</span>             GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span>characterData<span class="token punctuation">.</span>currentLevel<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"00"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//00æ˜¯è§„å®šç»™å®ƒçš„ä¸€ä¸ªæ ¼å¼ï¼Œæ¯”å¦‚01 02....</span>    <span class="token punctuation">&#125;</span>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UpdateHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//å¯ä»¥é€šè¿‡GameManagerç±»æ¥è·å¾—playerçš„states</span>        <span class="token class-name"><span class="token keyword">float</span></span> sliderPercent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>            GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span>currentHealth<span class="token operator">/</span>            GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span>MaxHealth<span class="token punctuation">;</span>        <span class="token comment">//æ›´æ–°å›¾ç‰‡å¡«å……</span>        healthSlider<span class="token punctuation">.</span>fillAmount <span class="token operator">=</span> sliderPercent<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UpdateExp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name"><span class="token keyword">float</span></span> sliderPercent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>            GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span>characterData<span class="token punctuation">.</span>currentExp<span class="token operator">/</span>            GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span>characterData<span class="token punctuation">.</span>baseExp<span class="token punctuation">;</span>        <span class="token comment">//æ›´æ–°å›¾ç‰‡å¡«å……</span>        expSlider<span class="token punctuation">.</span>fillAmount <span class="token operator">=</span> sliderPercent<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ˜¯å€ŸåŠ©äº†<code>GameManager.cs</code>ä¸­çš„å•ä¾‹æ¨¡å¼å®ä¾‹åŒ–çš„æ–¹å¼æ¥è·å¾—playerçš„çŠ¶æ€ä¿¡æ¯ï¼Œå› ä¸ºå…ˆå‰æˆ‘ç”¨äº†å¤–ç•Œæ³¨å†Œçš„æ–¹å¼æŠŠç©å®¶çš„ä¿¡æ¯èµ‹äºˆäº†GameManageré‡Œé¢çš„æˆå‘˜å˜é‡</p><p>åˆ°è¿™æˆ‘ä»¬å°±å¤§åŠŸå‘Šæˆäº†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æœ¬ç« æ¥åˆ¶ä½œç©å®¶çš„çŠ¶æ€æ¡ï¼Œå¦‚è¡€é‡æ¡ï¼Œç»éªŒæ¡ç­‰&lt;/p&gt;
&lt;h1 id=&quot;ç¼–è¾‘UIå¸ƒå±€&quot;&gt;&lt;a href=&quot;#ç¼–è¾‘UIå¸ƒå±€&quot; class=&quot;headerlink&quot; title=&quot;ç¼–è¾‘UIå¸ƒå±€&quot;&gt;&lt;/a&gt;ç¼–è¾‘UIå¸ƒå±€&lt;/h1&gt;&lt;p&gt;ç¬¬ä¸€æ­¥ä¹Ÿæ˜¯å»ºç«‹ä¸€ä¸ªç”»å¸ƒï¼Œæ¨¡å¼ä½¿ç”¨é»˜è®¤çš„&lt;code&gt;</summary>
      
    
    
    
    <category term="Unityå­¦ä¹ ç¬”è®°" scheme="http://sakura-pub.top/categories/Unity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Unity" scheme="http://sakura-pub.top/tags/Unity/"/>
    
  </entry>
  
  <entry>
    <title>Unityç¬”è®°23-åˆ¶ä½œç©å®¶çš„å‡çº§</title>
    <link href="http://sakura-pub.top/UnityNotes/Unity%E7%AC%94%E8%AE%B023-%E5%88%B6%E4%BD%9C%E7%8E%A9%E5%AE%B6%E7%9A%84%E5%8D%87%E7%BA%A7/"/>
    <id>http://sakura-pub.top/UnityNotes/Unity%E7%AC%94%E8%AE%B023-%E5%88%B6%E4%BD%9C%E7%8E%A9%E5%AE%B6%E7%9A%84%E5%8D%87%E7%BA%A7/</id>
    <published>2021-07-30T02:05:51.000Z</published>
    <updated>2021-07-31T04:10:05.890Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨æœ¬ç« ä¸­æˆ‘ä»¬æ¥åˆ¶ä½œç©å®¶çš„ç»éªŒç³»ç»Ÿï¼Œå¹¶é™„æœ‰å‡çº§åŠŸèƒ½</p><h1 id="æ‰©å±•CharacterData-SO"><a href="#æ‰©å±•CharacterData-SO" class="headerlink" title="æ‰©å±•CharacterData_SO"></a>æ‰©å±•CharacterData_SO</h1><p>æˆ‘ä»¬é¦–å…ˆæ‰“å¼€<code>CharacterData_SO.cs</code>æ·»åŠ ä¸€äº›é¢å¤–çš„å±æ€§è¿›å»ï¼ŒåŒæ—¶å†™ä¸€ä¸ªå‡çº§æ—¶å¤„ç†çš„æ–¹æ³•</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CreateAssetMenu</span><span class="token attribute-arguments"><span class="token punctuation">(</span>fileName <span class="token operator">=</span> <span class="token string">"New Data"</span><span class="token punctuation">,</span>menuName <span class="token operator">=</span> <span class="token string">"Character States/Data"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CharacterData_SO</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ScriptableObject</span></span><span class="token punctuation">&#123;</span>    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Header</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"States Infoï¼ˆå±æ€§ä¿¡æ¯ï¼‰"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> maxHealth<span class="token punctuation">;</span><span class="token comment">//æœ€å¤§ç”Ÿå‘½å€¼</span>    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> currentHealth<span class="token punctuation">;</span><span class="token comment">//å½“å‰ç”Ÿå‘½å€¼</span>    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> baseDefence<span class="token punctuation">;</span><span class="token comment">//åŸºç¡€é˜²å¾¡å€¼</span>    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> currentDefence<span class="token punctuation">;</span><span class="token comment">//å½“å‰é˜²å¾¡å€¼</span>    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Header</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"Killï¼ˆå‡»æ€ä¿¡æ¯ï¼‰"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> killPoint<span class="token punctuation">;</span><span class="token comment">//å‡»æ€åæ‰è½çš„ç»éªŒå€¼</span>    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Header</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"Levelï¼ˆç­‰çº§ä¿¡æ¯ï¼‰"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> currentLevel<span class="token punctuation">;</span><span class="token comment">//å½“å‰ç­‰çº§</span>    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> maxLevel<span class="token punctuation">;</span><span class="token comment">//æœ€å¤§ç­‰çº§æ•°</span>    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> baseExp<span class="token punctuation">;</span><span class="token comment">//åŸºç¡€ç»éªŒå€¼</span>    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> currentExp<span class="token punctuation">;</span><span class="token comment">//å½“å‰ç»éªŒå€¼</span>    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">float</span></span> levelBuff<span class="token punctuation">;</span><span class="token comment">//æ¯æ¬¡å‡çº§æ•´ä½“å±æ€§æå‡çš„ç™¾åˆ†æ¯”</span>    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">float</span></span> LevelMultiplier<span class="token punctuation">&#123;</span>        <span class="token comment">//å‡çº§æå‡å±æ€§åŠ çš„å€ç‡</span>        <span class="token keyword">get</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>currentLevel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> levelBuff<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UpdateExp</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> point<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        currentExp <span class="token operator">+=</span> point<span class="token punctuation">;</span><span class="token comment">//æŠŠå¤–ç•Œçš„ç»éªŒåŠ è¿›æ¥</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>currentExp <span class="token operator">>=</span> baseExp<span class="token punctuation">)</span>            <span class="token function">LevelUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LevelUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//è¿™ä¸ªæ–¹æ³•ä¸­æ·»åŠ å‡çº§æ—¶æƒ³æå‡çš„æ•°æ®</span>        <span class="token comment">//å°†current+1é™åˆ¶åœ¨[0,maxLevel]é—­åŒºé—´ä¸­</span>        currentLevel <span class="token operator">=</span> Mathf<span class="token punctuation">.</span><span class="token function">Clamp</span><span class="token punctuation">(</span>currentLevel<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>maxLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å°†ç»éªŒå’Œç”Ÿå‘½å€¼æŒ‰ç…§æ¯ä¸€ç­‰çº§ä¸åŒå€ç‡å¢é•¿ï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨å›ºå®šå€¼level buffï¼‰</span>        baseExp <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>baseExp<span class="token operator">*</span>LevelMultiplier<span class="token punctuation">)</span><span class="token punctuation">;</span>        maxHealth <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>maxHealth <span class="token operator">*</span> LevelMultiplier<span class="token punctuation">)</span><span class="token punctuation">;</span>        currentHealth <span class="token operator">=</span> maxHealth<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ç€å†å»åˆ°<code>CharacterStates.cs</code>åšæœ€åçš„ä¿®æ”¹</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TakeDamage</span><span class="token punctuation">(</span><span class="token class-name">CharacterStates</span> attacker<span class="token punctuation">,</span><span class="token class-name">CharacterStates</span> defener<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//è®¡ç®—ä¼¤å®³æ•°å€¼</span>    <span class="token comment">//å½“å‰æ”»å‡»åŠ›å‡å»ç›®æ ‡çš„é˜²å¾¡åŠ›ï¼Œå¦‚æœé˜²å¾¡åŠ›è¿‡é«˜å°±æ˜¯0ä¼¤å®³</span>    <span class="token class-name"><span class="token keyword">int</span></span> damage <span class="token operator">=</span> Mathf<span class="token punctuation">.</span><span class="token function">Max</span><span class="token punctuation">(</span>attacker<span class="token punctuation">.</span><span class="token function">CurrentDamage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>defener<span class="token punctuation">.</span>currentDefence<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    currentHealth <span class="token operator">=</span> Mathf<span class="token punctuation">.</span><span class="token function">Max</span><span class="token punctuation">(</span>currentHealth<span class="token operator">-</span>damage<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¡€é‡ä¹Ÿæ˜¯æœ€å°å€¼é”åœ¨0</span>    Debug<span class="token punctuation">.</span><span class="token function">LogFormat</span><span class="token punctuation">(</span><span class="token string">"&#123;0&#125;æ”»å‡»äº†&#123;1&#125;ï¼Œé€ æˆäº†&#123;2&#125;ç‚¹ä¼¤å®³"</span><span class="token punctuation">,</span>attacker<span class="token punctuation">.</span>gameObject<span class="token punctuation">.</span>name<span class="token punctuation">,</span>defener<span class="token punctuation">.</span>gameObject<span class="token punctuation">.</span>name<span class="token punctuation">,</span>damage<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>attacker<span class="token punctuation">.</span>isCritical<span class="token punctuation">)</span><span class="token comment">//åˆ¤æ–­è¢«æ‰“è€…æ˜¯å¦å—åˆ°æš´å‡»å¹¶ä¸”æ’­æ”¾å—ä¼¤åŠ¨ç”»</span>        defener<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Animator<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetTrigger</span><span class="token punctuation">(</span><span class="token string">"Hit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å°†æ¥è¦åšçš„äº‹æƒ…</span>    <span class="token comment">//è¡€é‡æ¡UI</span>    UpdateHealthBarOnAttack<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>currentHealth<span class="token punctuation">,</span>MaxHealth<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœäº‹ä»¶ä¸ä¸ºç©ºåˆ™è°ƒç”¨</span>    <span class="token comment">//æ‰“æ­»æ€ªååŠ ç»éªŒ</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>defener<span class="token punctuation">.</span>currentHealth <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>        attacker<span class="token punctuation">.</span>characterData<span class="token punctuation">.</span><span class="token function">UpdateExp</span><span class="token punctuation">(</span>defener<span class="token punctuation">.</span>characterData<span class="token punctuation">.</span>killPoint<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TakeDamage</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> damage<span class="token punctuation">,</span><span class="token class-name">CharacterStates</span> defener<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//çŸ³å¤´åå‡»çŸ³å¤´äººçš„æ”»å‡»æ–¹å¼</span>    <span class="token class-name"><span class="token keyword">int</span></span> dam <span class="token operator">=</span> Mathf<span class="token punctuation">.</span><span class="token function">Max</span><span class="token punctuation">(</span>damage <span class="token operator">-</span> defener<span class="token punctuation">.</span>currentDefence<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    defener<span class="token punctuation">.</span>currentHealth <span class="token operator">=</span> Mathf<span class="token punctuation">.</span><span class="token function">Max</span><span class="token punctuation">(</span>defener<span class="token punctuation">.</span>currentHealth <span class="token operator">-</span> dam<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è¡€æ¡äº‹ä»¶</span>    UpdateHealthBarOnAttack<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>currentHealth<span class="token punctuation">,</span>MaxHealth<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœäº‹ä»¶ä¸ä¸ºç©ºåˆ™è°ƒç”¨</span>    <span class="token comment">//TODO:åŠ ç»éªŒ</span>    <span class="token comment">//å¯ä»¥é€šè¿‡GameManageræ¥è®¿é—®ç©å®¶çš„å±æ€§</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>defener<span class="token punctuation">.</span>currentHealth <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>    GameManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span>characterData<span class="token punctuation">.</span><span class="token function">UpdateExp</span><span class="token punctuation">(</span>defener<span class="token punctuation">.</span>characterData<span class="token punctuation">.</span>killPoint<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åæˆ‘ä»¬å»åˆ°äººç‰©çš„<code>PlayerData</code>è¿˜æœ‰æ¯ä¸ªæ•Œäººçš„<code>Data</code>æ·»åŠ å±æ€§å°±å¯ä»¥äº†</p><img src="https://p6-tt.byteimg.com/origin/pgc-image/bc33680758884eb88e5bfed71402eaa5.png" alt="1.png" style="zoom:80%;" />]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨æœ¬ç« ä¸­æˆ‘ä»¬æ¥åˆ¶ä½œç©å®¶çš„ç»éªŒç³»ç»Ÿï¼Œå¹¶é™„æœ‰å‡çº§åŠŸèƒ½&lt;/p&gt;
&lt;h1 id=&quot;æ‰©å±•CharacterData-SO&quot;&gt;&lt;a href=&quot;#æ‰©å±•CharacterData-SO&quot; class=&quot;headerlink&quot; title=&quot;æ‰©å±•CharacterData_SO&quot;&gt;&lt;/a&gt;</summary>
      
    
    
    
    <category term="Unityå­¦ä¹ ç¬”è®°" scheme="http://sakura-pub.top/categories/Unity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Unity" scheme="http://sakura-pub.top/tags/Unity/"/>
    
  </entry>
  
</feed>
